"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const s3 = require("../../aws-s3");
const cdk = require("../../core");
const cxapi = require("../../cx-api");
const apigw = require("../lib");
describe('api definition', () => {
    describe('apigateway.ApiDefinition.fromJson', () => {
        test('happy case', () => {
            const stack = new cdk.Stack();
            const definition = {
                key1: 'val1',
            };
            const config = apigw.ApiDefinition.fromInline(definition).bind(stack);
            expect(config.inlineDefinition).toEqual(definition);
            expect(config.s3Location).toBeUndefined();
        });
        test('fails if Json definition is empty', () => {
            expect(() => defineRestApi(apigw.ApiDefinition.fromInline({})))
                .toThrow(/cannot be empty/);
        });
        test('fails if definition is not an object', () => {
            expect(() => defineRestApi(apigw.ApiDefinition.fromInline('not-json')))
                .toThrow(/should be of type object/);
        });
    });
    describe('apigateway.ApiDefinition.fromAsset', () => {
        test('happy case', () => {
            const app = new cdk.App({ context: { [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false } });
            const stack = new cdk.Stack(app);
            const config = apigw.ApiDefinition.fromAsset(path.join(__dirname, 'sample-definition.yaml')).bind(stack);
            expect(config.inlineDefinition).toBeUndefined();
            expect(config.s3Location).toBeDefined();
            expect(stack.resolve(config.s3Location.bucket)).toEqual({
                Ref: 'AssetParameters68497ac876de4e963fc8f7b5f1b28844c18ecc95e3f7c6e9e0bf250e03c037fbS3Bucket42039E29',
            });
        });
        test('fails if a directory is given for an asset', () => {
            // GIVEN
            const fileAsset = apigw.ApiDefinition.fromAsset(path.join(__dirname, 'authorizers'));
            // THEN
            expect(() => defineRestApi(fileAsset)).toThrow(/Asset cannot be a \.zip file or a directory/);
        });
        test('only one Asset object gets created even if multiple functions use the same AssetApiDefinition', () => {
            // GIVEN
            const app = new cdk.App({ context: { [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false } });
            const stack = new cdk.Stack(app, 'MyStack');
            const directoryAsset = apigw.ApiDefinition.fromAsset(path.join(__dirname, 'sample-definition.yaml'));
            // WHEN
            new apigw.SpecRestApi(stack, 'API1', {
                apiDefinition: directoryAsset,
            });
            new apigw.SpecRestApi(stack, 'API2', {
                apiDefinition: directoryAsset,
            });
            // THEN
            const assembly = app.synth();
            const synthesized = assembly.stacks[0];
            // API1 has an asset, API2 does not
            expect(synthesized.assets.length).toEqual(1);
        });
        test('asset metadata added to RestApi resource that contains Asset Api Definition', () => {
            const stack = new cdk.Stack();
            stack.node.setContext(cxapi.ASSET_RESOURCE_METADATA_ENABLED_CONTEXT, true);
            const assetApiDefinition = apigw.ApiDefinition.fromAsset(path.join(__dirname, 'sample-definition.yaml'));
            new apigw.SpecRestApi(stack, 'API', {
                apiDefinition: assetApiDefinition,
            });
            assertions_1.Template.fromStack(stack).hasResource('AWS::ApiGateway::RestApi', {
                Metadata: {
                    'aws:asset:path': 'asset.68497ac876de4e963fc8f7b5f1b28844c18ecc95e3f7c6e9e0bf250e03c037fb.yaml',
                    'aws:asset:property': 'BodyS3Location',
                },
            });
        });
    });
    describe('apigateway.ApiDefinition.fromBucket', () => {
        test('happy case', () => {
            const stack = new cdk.Stack();
            const bucket = new s3.Bucket(stack, 'my-bucket');
            const config = apigw.ApiDefinition.fromBucket(bucket, 'my-key', 'my-version').bind(stack);
            expect(config.inlineDefinition).toBeUndefined();
            expect(config.s3Location).toBeDefined();
            expect(stack.resolve(config.s3Location.bucket)).toEqual({
                Ref: 'mybucket15D133BF',
            });
            expect(config.s3Location.key).toEqual('my-key');
        });
    });
});
function defineRestApi(definition) {
    const stack = new cdk.Stack();
    return new apigw.SpecRestApi(stack, 'API', {
        apiDefinition: definition,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLWRlZmluaXRpb24udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwaS1kZWZpbml0aW9uLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsaURBQTRDO0FBQzVDLG1DQUFtQztBQUNuQyxrQ0FBa0M7QUFDbEMsc0NBQXNDO0FBQ3RDLGdDQUFnQztBQUVoQyxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLFFBQVEsQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7UUFDakQsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7WUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUIsTUFBTSxVQUFVLEdBQUc7Z0JBQ2pCLElBQUksRUFBRSxNQUFNO2FBQ2IsQ0FBQztZQUNGLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0RSxNQUFNLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1lBQzdDLE1BQU0sQ0FDSixHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDdkQsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDaEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQ2hELE1BQU0sQ0FDSixHQUFHLEVBQUUsQ0FB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YUFBYSxFQUFFLENBQUM7WUFDaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN4QyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO2dCQUN2RCxHQUFHLEVBQUUsa0JBQWtCO2FBQ3hCLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUVuRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLGFBQWEsQ0FBQyxVQUErQjtJQUNwRCxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM5QixPQUFPLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFO1FBQ3pDLGFBQWEsRUFBRSxVQUFVO0tBQzFCLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJy4uLy4uL2F3cy1zMyc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBjeGFwaSBmcm9tICcuLi8uLi9jeC1hcGknO1xuaW1wb3J0ICogYXMgYXBpZ3cgZnJvbSAnLi4vbGliJztcblxuZGVzY3JpYmUoJ2FwaSBkZWZpbml0aW9uJywgKCkgPT4ge1xuICBkZXNjcmliZSgnYXBpZ2F0ZXdheS5BcGlEZWZpbml0aW9uLmZyb21Kc29uJywgKCkgPT4ge1xuICAgIHRlc3QoJ2hhcHB5IGNhc2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSB7XG4gICAgICAgIGtleTE6ICd2YWwxJyxcbiAgICAgIH07XG4gICAgICBjb25zdCBjb25maWcgPSBhcGlndy5BcGlEZWZpbml0aW9uLmZyb21JbmxpbmUoZGVmaW5pdGlvbikuYmluZChzdGFjayk7XG4gICAgICBleHBlY3QoY29uZmlnLmlubGluZURlZmluaXRpb24pLnRvRXF1YWwoZGVmaW5pdGlvbik7XG4gICAgICBleHBlY3QoY29uZmlnLnMzTG9jYXRpb24pLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2ZhaWxzIGlmIEpzb24gZGVmaW5pdGlvbiBpcyBlbXB0eScsICgpID0+IHtcbiAgICAgIGV4cGVjdChcbiAgICAgICAgKCkgPT4gZGVmaW5lUmVzdEFwaShhcGlndy5BcGlEZWZpbml0aW9uLmZyb21JbmxpbmUoe30pKSlcbiAgICAgICAgLnRvVGhyb3coL2Nhbm5vdCBiZSBlbXB0eS8pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZmFpbHMgaWYgZGVmaW5pdGlvbiBpcyBub3QgYW4gb2JqZWN0JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KFxuICAgICAgICAoKSA9PiBkZWZpbmVSZXN0QXBpKGFwaWd3LkFwaURlZmluaXRpb24uZnJvbUlubGluZSgnbm90LWpzb24nKSkpXG4gICAgICAgIC50b1Rocm93KC9zaG91bGQgYmUgb2YgdHlwZSBvYmplY3QvKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2FwaWdhdGV3YXkuQXBpRGVmaW5pdGlvbi5mcm9tQXNzZXQnLCAoKSA9PiB7XG4gICAgdGVzdCgnaGFwcHkgY2FzZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKHsgY29udGV4dDogeyBbY3hhcGkuTkVXX1NUWUxFX1NUQUNLX1NZTlRIRVNJU19DT05URVhUXTogZmFsc2UgfSB9KTtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHApO1xuICAgICAgY29uc3QgY29uZmlnID0gYXBpZ3cuQXBpRGVmaW5pdGlvbi5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ3NhbXBsZS1kZWZpbml0aW9uLnlhbWwnKSkuYmluZChzdGFjayk7XG4gICAgICBleHBlY3QoY29uZmlnLmlubGluZURlZmluaXRpb24pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcuczNMb2NhdGlvbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKGNvbmZpZy5zM0xvY2F0aW9uIS5idWNrZXQpKS50b0VxdWFsKHtcbiAgICAgICAgUmVmOiAnQXNzZXRQYXJhbWV0ZXJzNjg0OTdhYzg3NmRlNGU5NjNmYzhmN2I1ZjFiMjg4NDRjMThlY2M5NWUzZjdjNmU5ZTBiZjI1MGUwM2MwMzdmYlMzQnVja2V0NDIwMzlFMjknLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdmYWlscyBpZiBhIGRpcmVjdG9yeSBpcyBnaXZlbiBmb3IgYW4gYXNzZXQnLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgZmlsZUFzc2V0ID0gYXBpZ3cuQXBpRGVmaW5pdGlvbi5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2F1dGhvcml6ZXJzJykpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QoKCkgPT4gZGVmaW5lUmVzdEFwaShmaWxlQXNzZXQpKS50b1Rocm93KC9Bc3NldCBjYW5ub3QgYmUgYSBcXC56aXAgZmlsZSBvciBhIGRpcmVjdG9yeS8pO1xuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdvbmx5IG9uZSBBc3NldCBvYmplY3QgZ2V0cyBjcmVhdGVkIGV2ZW4gaWYgbXVsdGlwbGUgZnVuY3Rpb25zIHVzZSB0aGUgc2FtZSBBc3NldEFwaURlZmluaXRpb24nLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgYXBwID0gbmV3IGNkay5BcHAoeyBjb250ZXh0OiB7IFtjeGFwaS5ORVdfU1RZTEVfU1RBQ0tfU1lOVEhFU0lTX0NPTlRFWFRdOiBmYWxzZSB9IH0pO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ015U3RhY2snKTtcbiAgICAgIGNvbnN0IGRpcmVjdG9yeUFzc2V0ID0gYXBpZ3cuQXBpRGVmaW5pdGlvbi5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ3NhbXBsZS1kZWZpbml0aW9uLnlhbWwnKSk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIG5ldyBhcGlndy5TcGVjUmVzdEFwaShzdGFjaywgJ0FQSTEnLCB7XG4gICAgICAgIGFwaURlZmluaXRpb246IGRpcmVjdG9yeUFzc2V0LFxuICAgICAgfSk7XG5cbiAgICAgIG5ldyBhcGlndy5TcGVjUmVzdEFwaShzdGFjaywgJ0FQSTInLCB7XG4gICAgICAgIGFwaURlZmluaXRpb246IGRpcmVjdG9yeUFzc2V0LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGNvbnN0IGFzc2VtYmx5ID0gYXBwLnN5bnRoKCk7XG4gICAgICBjb25zdCBzeW50aGVzaXplZCA9IGFzc2VtYmx5LnN0YWNrc1swXTtcblxuICAgICAgLy8gQVBJMSBoYXMgYW4gYXNzZXQsIEFQSTIgZG9lcyBub3RcbiAgICAgIGV4cGVjdChzeW50aGVzaXplZC5hc3NldHMubGVuZ3RoKS50b0VxdWFsKDEpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnYXNzZXQgbWV0YWRhdGEgYWRkZWQgdG8gUmVzdEFwaSByZXNvdXJjZSB0aGF0IGNvbnRhaW5zIEFzc2V0IEFwaSBEZWZpbml0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgICBzdGFjay5ub2RlLnNldENvbnRleHQoY3hhcGkuQVNTRVRfUkVTT1VSQ0VfTUVUQURBVEFfRU5BQkxFRF9DT05URVhULCB0cnVlKTtcbiAgICAgIGNvbnN0IGFzc2V0QXBpRGVmaW5pdGlvbiA9IGFwaWd3LkFwaURlZmluaXRpb24uZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdzYW1wbGUtZGVmaW5pdGlvbi55YW1sJykpO1xuICAgICAgbmV3IGFwaWd3LlNwZWNSZXN0QXBpKHN0YWNrLCAnQVBJJywge1xuICAgICAgICBhcGlEZWZpbml0aW9uOiBhc3NldEFwaURlZmluaXRpb24sXG4gICAgICB9KTtcblxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpBcGlHYXRld2F5OjpSZXN0QXBpJywge1xuICAgICAgICBNZXRhZGF0YToge1xuICAgICAgICAgICdhd3M6YXNzZXQ6cGF0aCc6ICdhc3NldC42ODQ5N2FjODc2ZGU0ZTk2M2ZjOGY3YjVmMWIyODg0NGMxOGVjYzk1ZTNmN2M2ZTllMGJmMjUwZTAzYzAzN2ZiLnlhbWwnLFxuICAgICAgICAgICdhd3M6YXNzZXQ6cHJvcGVydHknOiAnQm9keVMzTG9jYXRpb24nLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2FwaWdhdGV3YXkuQXBpRGVmaW5pdGlvbi5mcm9tQnVja2V0JywgKCkgPT4ge1xuICAgIHRlc3QoJ2hhcHB5IGNhc2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdteS1idWNrZXQnKTtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IGFwaWd3LkFwaURlZmluaXRpb24uZnJvbUJ1Y2tldChidWNrZXQsICdteS1rZXknLCAnbXktdmVyc2lvbicpLmJpbmQoc3RhY2spO1xuICAgICAgZXhwZWN0KGNvbmZpZy5pbmxpbmVEZWZpbml0aW9uKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnMzTG9jYXRpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZShjb25maWcuczNMb2NhdGlvbiEuYnVja2V0KSkudG9FcXVhbCh7XG4gICAgICAgIFJlZjogJ215YnVja2V0MTVEMTMzQkYnLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoY29uZmlnLnMzTG9jYXRpb24hLmtleSkudG9FcXVhbCgnbXkta2V5Jyk7XG5cbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gZGVmaW5lUmVzdEFwaShkZWZpbml0aW9uOiBhcGlndy5BcGlEZWZpbml0aW9uKSB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICByZXR1cm4gbmV3IGFwaWd3LlNwZWNSZXN0QXBpKHN0YWNrLCAnQVBJJywge1xuICAgIGFwaURlZmluaXRpb246IGRlZmluaXRpb24sXG4gIH0pO1xufVxuIl19