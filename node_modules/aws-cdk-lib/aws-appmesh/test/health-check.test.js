"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("../../core");
const appmesh = require("../lib");
let idCounter = 0;
const getNode = (stack) => {
    const mesh = new appmesh.Mesh(stack, `mesh-${++idCounter}`, {
        meshName: 'test-mesh',
    });
    return mesh.addVirtualNode(`virtual-node-${idCounter}`, {
        serviceDiscovery: appmesh.ServiceDiscovery.dns('test-node'),
    });
};
describe('health check', () => {
    test('interval', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const [min, max] = [5000, 300000];
        // WHEN
        const toThrow = (millis) => getNode(stack).addListener(appmesh.VirtualNodeListener.http2({
            healthCheck: appmesh.HealthCheck.http2({ interval: cdk.Duration.millis(millis) }),
        }));
        // THEN
        expect(() => toThrow(min)).not.toThrow();
        expect(() => toThrow(max)).not.toThrow();
        expect(() => toThrow(min - 1)).toThrow(/interval must be between 5 seconds and 300 seconds/);
        expect(() => toThrow(max + 1)).toThrow(/interval must be between 5 seconds and 300 seconds/);
    });
    test('timeout', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const [min, max] = [2000, 60000];
        // WHEN
        const toThrow = (millis) => getNode(stack).addListener(appmesh.VirtualNodeListener.http2({
            healthCheck: appmesh.HealthCheck.http2({ timeout: cdk.Duration.millis(millis) }),
        }));
        // THEN
        expect(() => toThrow(min)).not.toThrow();
        expect(() => toThrow(max)).not.toThrow();
        expect(() => toThrow(min - 1)).toThrow(/timeout must be between 2 seconds and 60 seconds/);
        expect(() => toThrow(max + 1)).toThrow(/timeout must be between 2 seconds and 60 seconds/);
    });
    test('healthyThreshold', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const [min, max] = [2, 10];
        // WHEN
        const toThrow = (healthyThreshold) => getNode(stack).addListener(appmesh.VirtualNodeListener.http({
            healthCheck: appmesh.HealthCheck.http({ healthyThreshold }),
        }));
        // THEN
        expect(() => toThrow(min)).not.toThrow();
        expect(() => toThrow(max)).not.toThrow();
        expect(() => toThrow(min - 1)).toThrow(/healthyThreshold must be between 2 and 10/);
        expect(() => toThrow(max + 1)).toThrow(/healthyThreshold must be between 2 and 10/);
    });
    test('unhealthyThreshold', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const [min, max] = [2, 10];
        // WHEN
        const toThrow = (unhealthyThreshold) => getNode(stack).addListener(appmesh.VirtualNodeListener.http({
            healthCheck: appmesh.HealthCheck.http({ unhealthyThreshold }),
        }));
        // THEN
        expect(() => toThrow(min)).not.toThrow();
        expect(() => toThrow(max)).not.toThrow();
        expect(() => toThrow(min - 1)).toThrow(/unhealthyThreshold must be between 2 and 10/);
        expect(() => toThrow(max + 1)).toThrow(/unhealthyThreshold must be between 2 and 10/);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhbHRoLWNoZWNrLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoZWFsdGgtY2hlY2sudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUFrQztBQUNsQyxrQ0FBa0M7QUFFbEMsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ2xCLE1BQU0sT0FBTyxHQUFHLENBQUMsS0FBZ0IsRUFBRSxFQUFFO0lBQ25DLE1BQU0sSUFBSSxHQUFHLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxFQUFFO1FBQzFELFFBQVEsRUFBRSxXQUFXO0tBQ3RCLENBQUMsQ0FBQztJQUNILE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsU0FBUyxFQUFFLEVBQUU7UUFDdEQsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7S0FDNUQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7UUFDcEIsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRTlCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFbEMsT0FBTztRQUNQLE1BQU0sT0FBTyxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUM7WUFDL0YsV0FBVyxFQUFFLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0s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dEYsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsNkNBQTZDLENBQUMsQ0FBQztJQUN4RixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgYXBwbWVzaCBmcm9tICcuLi9saWInO1xuXG5sZXQgaWRDb3VudGVyID0gMDtcbmNvbnN0IGdldE5vZGUgPSAoc3RhY2s6IGNkay5TdGFjaykgPT4ge1xuICBjb25zdCBtZXNoID0gbmV3IGFwcG1lc2guTWVzaChzdGFjaywgYG1lc2gtJHsrK2lkQ291bnRlcn1gLCB7XG4gICAgbWVzaE5hbWU6ICd0ZXN0LW1lc2gnLFxuICB9KTtcbiAgcmV0dXJuIG1lc2guYWRkVmlydHVhbE5vZGUoYHZpcnR1YWwtbm9kZS0ke2lkQ291bnRlcn1gLCB7XG4gICAgc2VydmljZURpc2NvdmVyeTogYXBwbWVzaC5TZXJ2aWNlRGlzY292ZXJ5LmRucygndGVzdC1ub2RlJyksXG4gIH0pO1xufTtcblxuZGVzY3JpYmUoJ2hlYWx0aCBjaGVjaycsICgpID0+IHtcbiAgdGVzdCgnaW50ZXJ2YWwnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIGNvbnN0IFttaW4sIG1heF0gPSBbNTAwMCwgMzAwMDAwXTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0b1Rocm93ID0gKG1pbGxpczogbnVtYmVyKSA9PiBnZXROb2RlKHN0YWNrKS5hZGRMaXN0ZW5lcihhcHBtZXNoLlZpcnR1YWxOb2RlTGlzdGVuZXIuaHR0cDIoe1xuICAgICAgaGVhbHRoQ2hlY2s6IGFwcG1lc2guSGVhbHRoQ2hlY2suaHR0cDIoeyBpbnRlcnZhbDogY2RrLkR1cmF0aW9uLm1pbGxpcyhtaWxsaXMpIH0pLFxuICAgIH0pKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoKCkgPT4gdG9UaHJvdyhtaW4pKS5ub3QudG9UaHJvdygpO1xuICAgIGV4cGVjdCgoKSA9PiB0b1Rocm93KG1heCkpLm5vdC50b1Rocm93KCk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWluIC0gMSkpLnRvVGhyb3coL2ludGVydmFsIG11c3QgYmUgYmV0d2VlbiA1IHNlY29uZHMgYW5kIDMwMCBzZWNvbmRzLyk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWF4ICsgMSkpLnRvVGhyb3coL2ludGVydmFsIG11c3QgYmUgYmV0d2VlbiA1IHNlY29uZHMgYW5kIDMwMCBzZWNvbmRzLyk7XG4gIH0pO1xuICB0ZXN0KCd0aW1lb3V0JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICBjb25zdCBbbWluLCBtYXhdID0gWzIwMDAsIDYwMDAwXTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0b1Rocm93ID0gKG1pbGxpczogbnVtYmVyKSA9PiBnZXROb2RlKHN0YWNrKS5hZGRMaXN0ZW5lcihhcHBtZXNoLlZpcnR1YWxOb2RlTGlzdGVuZXIuaHR0cDIoe1xuICAgICAgaGVhbHRoQ2hlY2s6IGFwcG1lc2guSGVhbHRoQ2hlY2suaHR0cDIoeyB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWlsbGlzKG1pbGxpcykgfSksXG4gICAgfSkpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiB0b1Rocm93KG1pbikpLm5vdC50b1Rocm93KCk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWF4KSkubm90LnRvVGhyb3coKTtcbiAgICBleHBlY3QoKCkgPT4gdG9UaHJvdyhtaW4gLSAxKSkudG9UaHJvdygvdGltZW91dCBtdXN0IGJlIGJldHdlZW4gMiBzZWNvbmRzIGFuZCA2MCBzZWNvbmRzLyk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWF4ICsgMSkpLnRvVGhyb3coL3RpbWVvdXQgbXVzdCBiZSBiZXR3ZWVuIDIgc2Vjb25kcyBhbmQgNjAgc2Vjb25kcy8pO1xuICB9KTtcbiAgdGVzdCgnaGVhbHRoeVRocmVzaG9sZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgY29uc3QgW21pbiwgbWF4XSA9IFsyLCAxMF07XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdG9UaHJvdyA9IChoZWFsdGh5VGhyZXNob2xkOiBudW1iZXIpID0+IGdldE5vZGUoc3RhY2spLmFkZExpc3RlbmVyKGFwcG1lc2guVmlydHVhbE5vZGVMaXN0ZW5lci5odHRwKHtcbiAgICAgIGhlYWx0aENoZWNrOiBhcHBtZXNoLkhlYWx0aENoZWNrLmh0dHAoeyBoZWFsdGh5VGhyZXNob2xkIH0pLFxuICAgIH0pKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoKCkgPT4gdG9UaHJvdyhtaW4pKS5ub3QudG9UaHJvdygpO1xuICAgIGV4cGVjdCgoKSA9PiB0b1Rocm93KG1heCkpLm5vdC50b1Rocm93KCk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWluIC0gMSkpLnRvVGhyb3coL2hlYWx0aHlUaHJlc2hvbGQgbXVzdCBiZSBiZXR3ZWVuIDIgYW5kIDEwLyk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWF4ICsgMSkpLnRvVGhyb3coL2hlYWx0aHlUaHJlc2hvbGQgbXVzdCBiZSBiZXR3ZWVuIDIgYW5kIDEwLyk7XG4gIH0pO1xuICB0ZXN0KCd1bmhlYWx0aHlUaHJlc2hvbGQnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIGNvbnN0IFttaW4sIG1heF0gPSBbMiwgMTBdO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHRvVGhyb3cgPSAodW5oZWFsdGh5VGhyZXNob2xkOiBudW1iZXIpID0+IGdldE5vZGUoc3RhY2spLmFkZExpc3RlbmVyKGFwcG1lc2guVmlydHVhbE5vZGVMaXN0ZW5lci5odHRwKHtcbiAgICAgIGhlYWx0aENoZWNrOiBhcHBtZXNoLkhlYWx0aENoZWNrLmh0dHAoeyB1bmhlYWx0aHlUaHJlc2hvbGQgfSksXG4gICAgfSkpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiB0b1Rocm93KG1pbikpLm5vdC50b1Rocm93KCk7XG4gICAgZXhwZWN0KCgpID0+IHRvVGhyb3cobWF4KSkubm90LnRvVGhyb3coKTtcbiAgICBleHBlY3QoKCkgPT4gdG9UaHJvdyhtaW4gLSAxKSkudG9UaHJvdygvdW5oZWFsdGh5VGhyZXNob2xkIG11c3QgYmUgYmV0d2VlbiAyIGFuZCAxMC8pO1xuICAgIGV4cGVjdCgoKSA9PiB0b1Rocm93KG1heCArIDEpKS50b1Rocm93KC91bmhlYWx0aHlUaHJlc2hvbGQgbXVzdCBiZSBiZXR3ZWVuIDIgYW5kIDEwLyk7XG4gIH0pO1xufSk7Il19