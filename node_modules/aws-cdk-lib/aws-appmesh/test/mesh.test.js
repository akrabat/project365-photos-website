"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const ec2 = require("../../aws-ec2");
const cloudmap = require("../../aws-servicediscovery");
const cdk = require("../../core");
const appmesh = require("../lib");
describe('mesh', () => {
    describe('When creating a Mesh', () => {
        describe('with no spec applied', () => {
            test('should defaults to DROP_ALL egress filter', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                new appmesh.Mesh(stack, 'mesh', { meshName: 'test-mesh' });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::Mesh', {
                    Spec: {},
                });
            });
        });
        describe('with spec applied', () => {
            test('should take IP preference from props', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                    serviceDiscovery: {
                        ipPreference: appmesh.IpPreference.IPV4_ONLY,
                    },
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::Mesh', {
                    Spec: {
                        ServiceDiscovery: {
                            IpPreference: 'IPv4_ONLY',
                        },
                    },
                });
            });
            test('should take egress filter from props', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                    egressFilter: appmesh.MeshFilterType.ALLOW_ALL,
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::Mesh', {
                    Spec: {
                        EgressFilter: {
                            Type: 'ALLOW_ALL',
                        },
                    },
                });
            });
        });
    });
    describe('When adding a Virtual Router to existing mesh', () => {
        describe('with at least one complete port mappings', () => {
            test('should create proper router', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                mesh.addVirtualRouter('router');
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualRouter', {
                    Spec: {
                        Listeners: [
                            {
                                PortMapping: {
                                    Port: 8080,
                                    Protocol: 'http',
                                },
                            },
                        ],
                    },
                });
            });
        });
    });
    test('VirtualService can use CloudMap service', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const mesh = new appmesh.Mesh(stack, 'mesh', {
            meshName: 'test-mesh',
        });
        const vpc = new ec2.Vpc(stack, 'vpc');
        const namespace = new cloudmap.PrivateDnsNamespace(stack, 'test-namespace', {
            vpc,
            name: 'domain.local',
        });
        const service = namespace.createService('Svc');
        // WHEN
        new appmesh.VirtualNode(stack, 'test-node', {
            mesh,
            serviceDiscovery: appmesh.ServiceDiscovery.cloudMap(service),
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppMesh::VirtualNode', {
            Spec: {
                ServiceDiscovery: {
                    AWSCloudMap: {
                        NamespaceName: 'domain.local',
                        ServiceName: { 'Fn::GetAtt': ['testnamespaceSvcB55702EC', 'Name'] },
                    },
                },
            },
        });
    });
    test('VirtualService can use CloudMap service with instanceAttributes', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const mesh = new appmesh.Mesh(stack, 'mesh', {
            meshName: 'test-mesh',
        });
        const vpc = new ec2.Vpc(stack, 'vpc');
        const namespace = new cloudmap.PrivateDnsNamespace(stack, 'test-namespace', {
            vpc,
            name: 'domain.local',
        });
        const service = namespace.createService('Svc');
        const instanceAttribute = {};
        instanceAttribute.testKey = 'testValue';
        // WHEN
        new appmesh.VirtualNode(stack, 'test-node', {
            mesh,
            serviceDiscovery: appmesh.ServiceDiscovery.cloudMap(service, instanceAttribute),
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppMesh::VirtualNode', {
            Spec: {
                ServiceDiscovery: {
                    AWSCloudMap: {
                        NamespaceName: 'domain.local',
                        ServiceName: { 'Fn::GetAtt': ['testnamespaceSvcB55702EC', 'Name'] },
                        Attributes: [
                            {
                                Key: 'testKey',
                                Value: 'testValue',
                            },
                        ],
                    },
                },
            },
        });
    });
    describe('When adding a VirtualNode to a mesh', () => {
        describe('with empty default listeners and backends', () => {
            test('should create default resource', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                mesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualNode', {
                    MeshName: {
                        'Fn::GetAtt': ['meshACDFE68E', 'MeshName'],
                    },
                    Spec: {
                        // Specifically: no Listeners and Backends
                        ServiceDiscovery: {
                            DNS: {
                                Hostname: 'test.domain.local',
                            },
                        },
                    },
                });
            });
        });
        describe('with added listeners', () => {
            test('should create listener resource', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                mesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                    listeners: [appmesh.VirtualNodeListener.http({
                            port: 8080,
                        })],
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualNode', {
                    MeshName: {
                        'Fn::GetAtt': ['meshACDFE68E', 'MeshName'],
                    },
                    Spec: {
                        Listeners: [
                            {
                                PortMapping: {
                                    Port: 8080,
                                    Protocol: 'http',
                                },
                            },
                        ],
                    },
                });
            });
        });
        describe('with added listeners with healthchecks', () => {
            test('should create healthcheck resource', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                mesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                    listeners: [appmesh.VirtualNodeListener.http({
                            port: 8080,
                            healthCheck: appmesh.HealthCheck.http({
                                healthyThreshold: 3,
                                path: '/',
                                interval: cdk.Duration.seconds(5),
                                timeout: cdk.Duration.seconds(2),
                                unhealthyThreshold: 2,
                            }),
                        })],
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualNode', {
                    MeshName: {
                        'Fn::GetAtt': ['meshACDFE68E', 'MeshName'],
                    },
                    Spec: {
                        Listeners: [
                            assertions_1.Match.objectLike({
                                HealthCheck: {
                                    HealthyThreshold: 3,
                                    IntervalMillis: 5000,
                                    Path: '/',
                                    Port: 8080,
                                    Protocol: 'http',
                                    TimeoutMillis: 2000,
                                    UnhealthyThreshold: 2,
                                },
                            }),
                        ],
                    },
                });
            });
        });
        describe('with backends', () => {
            test('should create resource with service backends', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                const service1 = new appmesh.VirtualService(stack, 'service-1', {
                    virtualServiceName: 'service1.domain.local',
                    virtualServiceProvider: appmesh.VirtualServiceProvider.none(mesh),
                });
                mesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                    listeners: [appmesh.VirtualNodeListener.http({
                            port: 8080,
                        })],
                    backends: [appmesh.Backend.virtualService(service1)],
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualNode', {
                    Spec: {
                        Backends: [
                            {
                                VirtualService: {
                                    VirtualServiceName: 'service1.domain.local',
                                },
                            },
                        ],
                    },
                });
            });
        });
    });
    test('Can construct a mesh from a name', () => {
        // WHEN
        const stack2 = new cdk.Stack();
        const mesh2 = appmesh.Mesh.fromMeshName(stack2, 'imported-mesh', 'abc');
        new appmesh.VirtualService(stack2, 'service', {
            virtualServiceName: 'test.domain.local',
            virtualServiceProvider: appmesh.VirtualServiceProvider.none(mesh2),
        });
        // THEN
        assertions_1.Template.fromStack(stack2).
            hasResourceProperties('AWS::AppMesh::VirtualService', {
            MeshName: 'abc',
            Spec: {},
            VirtualServiceName: 'test.domain.local',
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzaC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWVzaC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQW1EO0FBQ25ELHFDQUFxQztBQUNyQyx1REFBdUQ7QUFDdkQsa0NBQWtDO0FBQ2xDLGtDQUFrQztBQUVsQyxRQUFRLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRTtJQUNwQixRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO1FBQ3BDLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLDJDQUEyQyxFQUFFLEdBQUcsRUFBRTtnQkFDckQsUUFBUTtnQkFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFFOUIsT0FBTztnQkFDUCxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUUzRCxPQUFPO2dCQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztvQkFDdkIscUJBQXFCLENBQUMsb0JBQW9CLEVBQUU7b0JBQzFDLElBQUksRUFBRSxFQUNMO2lCQUNGLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7Z0JBQ2hELFFBQVE7Z0JBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7Z0JBRTlCLE9BQU87Z0JBQ1AsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUU7b0JBQzlCLFFBQVEsRUFBRSxXQUFXO29CQUNyQixnQkFBZ0IsRUFBRTt3QkFDaEIsWUFBWSxFQUFFLE9BQU8s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OEIsRUFBRTtZQUNwRCxRQUFRLEVBQUUsS0FBSztZQUNmLElBQUksRUFBRSxFQUFFO1lBQ1Isa0JBQWtCLEVBQUUsbUJBQW1CO1NBQ3hDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICcuLi8uLi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGNsb3VkbWFwIGZyb20gJy4uLy4uL2F3cy1zZXJ2aWNlZGlzY292ZXJ5JztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGFwcG1lc2ggZnJvbSAnLi4vbGliJztcblxuZGVzY3JpYmUoJ21lc2gnLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdXaGVuIGNyZWF0aW5nIGEgTWVzaCcsICgpID0+IHtcbiAgICBkZXNjcmliZSgnd2l0aCBubyBzcGVjIGFwcGxpZWQnLCAoKSA9PiB7XG4gICAgICB0ZXN0KCdzaG91bGQgZGVmYXVsdHMgdG8gRFJPUF9BTEwgZWdyZXNzIGZpbHRlcicsICgpID0+IHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICBuZXcgYXBwbWVzaC5NZXNoKHN0YWNrLCAnbWVzaCcsIHsgbWVzaE5hbWU6ICd0ZXN0LW1lc2gnIH0pO1xuXG4gICAgICAgIC8vIFRIRU5cbiAgICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5cbiAgICAgICAgICBoYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwTWVzaDo6TWVzaCcsIHtcbiAgICAgICAgICAgIFNwZWM6IHtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCd3aXRoIHNwZWMgYXBwbGllZCcsICgpID0+IHtcbiAgICAgIHRlc3QoJ3Nob3VsZCB0YWtlIElQIHByZWZlcmVuY2UgZnJvbSBwcm9wcycsICgpID0+IHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICBuZXcgYXBwbWVzaC5NZXNoKHN0YWNrLCAnbWVzaCcsIHtcbiAgICAgICAgICBtZXNoTmFtZTogJ3Rlc3QtbWVzaCcsXG4gICAgICAgICAgc2VydmljZURpc2NvdmVyeToge1xuICAgICAgICAgICAgaXBQcmVmZXJlbmNlOiBhcHBtZXNoLklwUHJlZmVyZW5jZS5JUFY0X09OTFksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVEhFTlxuICAgICAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLlxuICAgICAgICAgIGhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBNZXNoOjpNZXNoJywge1xuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBTZXJ2aWNlRGlzY292ZXJ5OiB7XG4gICAgICAgICAgICAgICAgSXBQcmVmZXJlbmNlOiAnSVB2NF9PTkxZJyxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgdGVzdCgnc2hvdWxkIHRha2UgZWdyZXNzIGZpbHRlciBmcm9tIHByb3BzJywgKCkgPT4ge1xuICAgICAgICAvLyBHSVZFTlxuICAgICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgICAgICAvLyBXSEVOXG4gICAgICAgIG5ldyBhcHBtZXNoLk1lc2goc3RhY2ssICdtZXNoJywge1xuICAgICAgICAgIG1lc2hOYW1lOiAndGVzdC1tZXNoJyxcbiAgICAgICAgICBlZ3Jlc3NGaWx0ZXI6IGFwcG1lc2guTWVzaEZpbHRlclR5cGUuQUxMT1dfQUxMLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuXG4gICAgICAgICAgaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcE1lc2g6Ok1lc2gnLCB7XG4gICAgICAgICAgICBTcGVjOiB7XG4gICAgICAgICAgICAgIEVncmVzc0ZpbHRlcjoge1xuICAgICAgICAgICAgICAgIFR5cGU6ICdBTExPV19BTEwnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnV2hlbiBhZGRpbmcgYSBWaXJ0dWFsIFJvdXRlciB0byBleGlzdGluZyBtZXNoJywgKCkgPT4ge1xuICAgIGRlc2NyaWJlKCd3aXRoIGF0IGxlYXN0IG9uZSBjb21wbGV0ZSBwb3J0IG1hcHBpbmdzJywgKCkgPT4ge1xuICAgICAgdGVzdCgnc2hvdWxkIGNyZWF0ZSBwcm9wZXIgcm91dGVyJywgKCkgPT4ge1xuICAgICAgICAvLyBHSVZFTlxuICAgICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgICAgICAvLyBXSEVOXG4gICAgICAgIGNvbnN0IG1lc2ggPSBuZXcgYXBwbWVzaC5NZXNoKHN0YWNrLCAnbWVzaCcsIHtcbiAgICAgICAgICBtZXNoTmFtZTogJ3Rlc3QtbWVzaCcsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG1lc2guYWRkVmlydHVhbFJvdXRlcigncm91dGVyJyk7XG5cbiAgICAgICAgLy8gVEhFTlxuICAgICAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLlxuICAgICAgICAgIGhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBNZXNoOjpWaXJ0dWFsUm91dGVyJywge1xuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBMaXN0ZW5lcnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBQb3J0TWFwcGluZzoge1xuICAgICAgICAgICAgICAgICAgICBQb3J0OiA4MDgwLFxuICAgICAgICAgICAgICAgICAgICBQcm90b2NvbDogJ2h0dHAnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdWaXJ0dWFsU2VydmljZSBjYW4gdXNlIENsb3VkTWFwIHNlcnZpY2UnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCBtZXNoID0gbmV3IGFwcG1lc2guTWVzaChzdGFjaywgJ21lc2gnLCB7XG4gICAgICBtZXNoTmFtZTogJ3Rlc3QtbWVzaCcsXG4gICAgfSk7XG4gICAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGMoc3RhY2ssICd2cGMnKTtcbiAgICBjb25zdCBuYW1lc3BhY2UgPSBuZXcgY2xvdWRtYXAuUHJpdmF0ZURuc05hbWVzcGFjZShzdGFjaywgJ3Rlc3QtbmFtZXNwYWNlJywge1xuICAgICAgdnBjLFxuICAgICAgbmFtZTogJ2RvbWFpbi5sb2NhbCcsXG4gICAgfSk7XG4gICAgY29uc3Qgc2VydmljZSA9IG5hbWVzcGFjZS5jcmVhdGVTZXJ2aWNlKCdTdmMnKTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgYXBwbWVzaC5WaXJ0dWFsTm9kZShzdGFjaywgJ3Rlc3Qtbm9kZScsIHtcbiAgICAgIG1lc2gsXG4gICAgICBzZXJ2aWNlRGlzY292ZXJ5OiBhcHBtZXNoLlNlcnZpY2VEaXNjb3ZlcnkuY2xvdWRNYXAoc2VydmljZSksXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwTWVzaDo6VmlydHVhbE5vZGUnLCB7XG4gICAgICBTcGVjOiB7XG4gICAgICAgIFNlcnZpY2VEaXNjb3Zlcnk6IHtcbiAgICAgICAgICBBV1NDbG91ZE1hcDoge1xuICAgICAgICAgICAgTmFtZXNwYWNlTmFtZTogJ2RvbWFpbi5sb2NhbCcsXG4gICAgICAgICAgICBTZXJ2aWNlTmFtZTogeyAnRm46OkdldEF0dCc6IFsndGVzdG5hbWVzcGFjZVN2Y0I1NTcwMkVDJywgJ05hbWUnXSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdWaXJ0dWFsU2VydmljZSBjYW4gdXNlIENsb3VkTWFwIHNlcnZpY2Ugd2l0aCBpbnN0YW5jZUF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCBtZXNoID0gbmV3IGFwcG1lc2guTWVzaChzdGFjaywgJ21lc2gnLCB7XG4gICAgICBtZXNoTmFtZTogJ3Rlc3QtbWVzaCcsXG4gICAgfSk7XG4gICAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGMoc3RhY2ssICd2cGMnKTtcbiAgICBjb25zdCBuYW1lc3BhY2UgPSBuZXcgY2xvdWRtYXAuUHJpdmF0ZURuc05hbWVzcGFjZShzdGFjaywgJ3Rlc3QtbmFtZXNwYWNlJywge1xuICAgICAgdnBjLFxuICAgICAgbmFtZTogJ2RvbWFpbi5sb2NhbCcsXG4gICAgfSk7XG4gICAgY29uc3Qgc2VydmljZSA9IG5hbWVzcGFjZS5jcmVhdGVTZXJ2aWNlKCdTdmMnKTtcblxuICAgIGNvbnN0IGluc3RhbmNlQXR0cmlidXRlIDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmd9ID0ge307XG4gICAgaW5zdGFuY2VBdHRyaWJ1dGUudGVzdEtleSA9ICd0ZXN0VmFsdWUnO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBhcHBtZXNoLlZpcnR1YWxOb2RlKHN0YWNrLCAndGVzdC1ub2RlJywge1xuICAgICAgbWVzaCxcbiAgICAgIHNlcnZpY2VEaXNjb3Zlcnk6IGFwcG1lc2guU2VydmljZURpc2NvdmVyeS5jbG91ZE1hcChzZXJ2aWNlLCBpbnN0YW5jZUF0dHJpYnV0ZSksXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwTWVzaDo6VmlydHVhbE5vZGUnLCB7XG4gICAgICBTcGVjOiB7XG4gICAgICAgIFNlcnZpY2VEaXNjb3Zlcnk6IHtcbiAgICAgICAgICBBV1NDbG91ZE1hcDoge1xuICAgICAgICAgICAgTmFtZXNwYWNlTmFtZTogJ2RvbWFpbi5sb2NhbCcsXG4gICAgICAgICAgICBTZXJ2aWNlTmFtZTogeyAnRm46OkdldEF0dCc6IFsndGVzdG5hbWVzcGFjZVN2Y0I1NTcwMkVDJywgJ05hbWUnXSB9LFxuICAgICAgICAgICAgQXR0cmlidXRlczogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgS2V5OiAndGVzdEtleScsXG4gICAgICAgICAgICAgICAgVmFsdWU6ICd0ZXN0VmFsdWUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1doZW4gYWRkaW5nIGEgVmlydHVhbE5vZGUgdG8gYSBtZXNoJywgKCkgPT4ge1xuICAgIGRlc2NyaWJlKCd3aXRoIGVtcHR5IGRlZmF1bHQgbGlzdGVuZXJzIGFuZCBiYWNrZW5kcycsICgpID0+IHtcbiAgICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgZGVmYXVsdCByZXNvdXJjZScsICgpID0+IHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICBjb25zdCBtZXNoID0gbmV3IGFwcG1lc2guTWVzaChzdGFjaywgJ21lc2gnLCB7XG4gICAgICAgICAgbWVzaE5hbWU6ICd0ZXN0LW1lc2gnLFxuICAgICAgICB9KTtcblxuICAgICAgICBtZXNoLmFkZFZpcnR1YWxOb2RlKCd0ZXN0LW5vZGUnLCB7XG4gICAgICAgICAgc2VydmljZURpc2NvdmVyeTogYXBwbWVzaC5TZXJ2aWNlRGlzY292ZXJ5LmRucygndGVzdC5kb21haW4ubG9jYWwnKSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVEhFTlxuICAgICAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLlxuICAgICAgICAgIGhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBNZXNoOjpWaXJ0dWFsTm9kZScsIHtcbiAgICAgICAgICAgIE1lc2hOYW1lOiB7XG4gICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogWydtZXNoQUNERkU2OEUnLCAnTWVzaE5hbWUnXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBTcGVjOiB7XG4gICAgICAgICAgICAgIC8vIFNwZWNpZmljYWxseTogbm8gTGlzdGVuZXJzIGFuZCBCYWNrZW5kc1xuICAgICAgICAgICAgICBTZXJ2aWNlRGlzY292ZXJ5OiB7XG4gICAgICAgICAgICAgICAgRE5TOiB7XG4gICAgICAgICAgICAgICAgICBIb3N0bmFtZTogJ3Rlc3QuZG9tYWluLmxvY2FsJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCd3aXRoIGFkZGVkIGxpc3RlbmVycycsICgpID0+IHtcbiAgICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgbGlzdGVuZXIgcmVzb3VyY2UnLCAoKSA9PiB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBhcHBtZXNoLk1lc2goc3RhY2ssICdtZXNoJywge1xuICAgICAgICAgIG1lc2hOYW1lOiAndGVzdC1tZXNoJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbWVzaC5hZGRWaXJ0dWFsTm9kZSgndGVzdC1ub2RlJywge1xuICAgICAgICAgIHNlcnZpY2VEaXNjb3Zlcnk6IGFwcG1lc2guU2VydmljZURpc2NvdmVyeS5kbnMoJ3Rlc3QuZG9tYWluLmxvY2FsJyksXG4gICAgICAgICAgbGlzdGVuZXJzOiBbYXBwbWVzaC5WaXJ0dWFsTm9kZUxpc3RlbmVyLmh0dHAoe1xuICAgICAgICAgICAgcG9ydDogODA4MCxcbiAgICAgICAgICB9KV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFRIRU5cbiAgICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5cbiAgICAgICAgICBoYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwTWVzaDo6VmlydHVhbE5vZGUnLCB7XG4gICAgICAgICAgICBNZXNoTmFtZToge1xuICAgICAgICAgICAgICAnRm46OkdldEF0dCc6IFsnbWVzaEFDREZFNjhFJywgJ01lc2hOYW1lJ10sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBMaXN0ZW5lcnM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBQb3J0TWFwcGluZzoge1xuICAgICAgICAgICAgICAgICAgICBQb3J0OiA4MDgwLFxuICAgICAgICAgICAgICAgICAgICBQcm90b2NvbDogJ2h0dHAnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCd3aXRoIGFkZGVkIGxpc3RlbmVycyB3aXRoIGhlYWx0aGNoZWNrcycsICgpID0+IHtcbiAgICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgaGVhbHRoY2hlY2sgcmVzb3VyY2UnLCAoKSA9PiB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBhcHBtZXNoLk1lc2goc3RhY2ssICdtZXNoJywge1xuICAgICAgICAgIG1lc2hOYW1lOiAndGVzdC1tZXNoJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbWVzaC5hZGRWaXJ0dWFsTm9kZSgndGVzdC1ub2RlJywge1xuICAgICAgICAgIHNlcnZpY2VEaXNjb3Zlcnk6IGFwcG1lc2guU2VydmljZURpc2NvdmVyeS5kbnMoJ3Rlc3QuZG9tYWluLmxvY2FsJyksXG4gICAgICAgICAgbGlzdGVuZXJzOiBbYXBwbWVzaC5WaXJ0dWFsTm9kZUxpc3RlbmVyLmh0dHAoe1xuICAgICAgICAgICAgcG9ydDogODA4MCxcbiAgICAgICAgICAgIGhlYWx0aENoZWNrOiBhcHBtZXNoLkhlYWx0aENoZWNrLmh0dHAoe1xuICAgICAgICAgICAgICBoZWFsdGh5VGhyZXNob2xkOiAzLFxuICAgICAgICAgICAgICBwYXRoOiAnLycsXG4gICAgICAgICAgICAgIGludGVydmFsOiBjZGsuRHVyYXRpb24uc2Vjb25kcyg1KSwgLy8gbWluXG4gICAgICAgICAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDIpLCAvLyBtaW5cbiAgICAgICAgICAgICAgdW5oZWFsdGh5VGhyZXNob2xkOiAyLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSldLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuXG4gICAgICAgICAgaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcE1lc2g6OlZpcnR1YWxOb2RlJywge1xuICAgICAgICAgICAgTWVzaE5hbWU6IHtcbiAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbJ21lc2hBQ0RGRTY4RScsICdNZXNoTmFtZSddLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFNwZWM6IHtcbiAgICAgICAgICAgICAgTGlzdGVuZXJzOiBbXG4gICAgICAgICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICAgICAgICBIZWFsdGhDaGVjazoge1xuICAgICAgICAgICAgICAgICAgICBIZWFsdGh5VGhyZXNob2xkOiAzLFxuICAgICAgICAgICAgICAgICAgICBJbnRlcnZhbE1pbGxpczogNTAwMCxcbiAgICAgICAgICAgICAgICAgICAgUGF0aDogJy8nLFxuICAgICAgICAgICAgICAgICAgICBQb3J0OiA4MDgwLFxuICAgICAgICAgICAgICAgICAgICBQcm90b2NvbDogJ2h0dHAnLFxuICAgICAgICAgICAgICAgICAgICBUaW1lb3V0TWlsbGlzOiAyMDAwLFxuICAgICAgICAgICAgICAgICAgICBVbmhlYWx0aHlUaHJlc2hvbGQ6IDIsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGRlc2NyaWJlKCd3aXRoIGJhY2tlbmRzJywgKCkgPT4ge1xuICAgICAgdGVzdCgnc2hvdWxkIGNyZWF0ZSByZXNvdXJjZSB3aXRoIHNlcnZpY2UgYmFja2VuZHMnLCAoKSA9PiB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBhcHBtZXNoLk1lc2goc3RhY2ssICdtZXNoJywge1xuICAgICAgICAgIG1lc2hOYW1lOiAndGVzdC1tZXNoJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2VydmljZTEgPSBuZXcgYXBwbWVzaC5WaXJ0dWFsU2VydmljZShzdGFjaywgJ3NlcnZpY2UtMScsIHtcbiAgICAgICAgICB2aXJ0dWFsU2VydmljZU5hbWU6ICdzZXJ2aWNlMS5kb21haW4ubG9jYWwnLFxuICAgICAgICAgIHZpcnR1YWxTZXJ2aWNlUHJvdmlkZXI6IGFwcG1lc2guVmlydHVhbFNlcnZpY2VQcm92aWRlci5ub25lKG1lc2gpLFxuICAgICAgICB9KTtcblxuICAgICAgICBtZXNoLmFkZFZpcnR1YWxOb2RlKCd0ZXN0LW5vZGUnLCB7XG4gICAgICAgICAgc2VydmljZURpc2NvdmVyeTogYXBwbWVzaC5TZXJ2aWNlRGlzY292ZXJ5LmRucygndGVzdC5kb21haW4ubG9jYWwnKSxcbiAgICAgICAgICBsaXN0ZW5lcnM6IFthcHBtZXNoLlZpcnR1YWxOb2RlTGlzdGVuZXIuaHR0cCh7XG4gICAgICAgICAgICBwb3J0OiA4MDgwLFxuICAgICAgICAgIH0pXSxcbiAgICAgICAgICBiYWNrZW5kczogW2FwcG1lc2guQmFja2VuZC52aXJ0dWFsU2VydmljZShzZXJ2aWNlMSldLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuXG4gICAgICAgICAgaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcE1lc2g6OlZpcnR1YWxOb2RlJywge1xuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBCYWNrZW5kczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIFZpcnR1YWxTZXJ2aWNlOiB7XG4gICAgICAgICAgICAgICAgICAgIFZpcnR1YWxTZXJ2aWNlTmFtZTogJ3NlcnZpY2UxLmRvbWFpbi5sb2NhbCcsXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuICB0ZXN0KCdDYW4gY29uc3RydWN0IGEgbWVzaCBmcm9tIGEgbmFtZScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgc3RhY2syID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IG1lc2gyID0gYXBwbWVzaC5NZXNoLmZyb21NZXNoTmFtZShzdGFjazIsICdpbXBvcnRlZC1tZXNoJywgJ2FiYycpO1xuXG4gICAgbmV3IGFwcG1lc2guVmlydHVhbFNlcnZpY2Uoc3RhY2syLCAnc2VydmljZScsIHtcbiAgICAgIHZpcnR1YWxTZXJ2aWNlTmFtZTogJ3Rlc3QuZG9tYWluLmxvY2FsJyxcbiAgICAgIHZpcnR1YWxTZXJ2aWNlUHJvdmlkZXI6IGFwcG1lc2guVmlydHVhbFNlcnZpY2VQcm92aWRlci5ub25lKG1lc2gyKSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2syKS5cbiAgICAgIGhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBNZXNoOjpWaXJ0dWFsU2VydmljZScsIHtcbiAgICAgICAgTWVzaE5hbWU6ICdhYmMnLFxuICAgICAgICBTcGVjOiB7fSxcbiAgICAgICAgVmlydHVhbFNlcnZpY2VOYW1lOiAndGVzdC5kb21haW4ubG9jYWwnLFxuICAgICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=