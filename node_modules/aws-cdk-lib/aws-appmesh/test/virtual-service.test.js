"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const cdk = require("../../core");
const appmesh = require("../lib");
describe('virtual service', () => {
    test('Can import Virtual Services using an ARN', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const meshName = 'testMesh';
        const virtualServiceName = 'virtual-service';
        const arn = `arn:aws:appmesh:us-east-1:123456789012:mesh/${meshName}/virtualService/${virtualServiceName}`;
        // WHEN
        const virtualRouter = appmesh.VirtualRouter.fromVirtualRouterArn(stack, 'importedVirtualRouter', arn);
        // THEN
        expect(virtualRouter.mesh.meshName).toEqual(meshName);
        expect(virtualRouter.virtualRouterName).toEqual(virtualServiceName);
    });
    test('Can import Virtual Services using attributes', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const meshName = 'testMesh';
        const virtualServiceName = 'virtual-service';
        // WHEN
        const virtualService = appmesh.VirtualService.fromVirtualServiceAttributes(stack, 'importedVirtualService', {
            mesh: appmesh.Mesh.fromMeshName(stack, 'Mesh', meshName),
            virtualServiceName: virtualServiceName,
        });
        // THEN
        expect(virtualService.mesh.meshName).toEqual(meshName);
        expect(virtualService.virtualServiceName).toEqual(virtualServiceName);
    });
    describe('When adding a VirtualService to a mesh', () => {
        describe('with single virtual router provider resource', () => {
            test('should create service', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                const testRouter = mesh.addVirtualRouter('test-router', {
                    listeners: [
                        appmesh.VirtualRouterListener.http(),
                    ],
                });
                new appmesh.VirtualService(stack, 'service', {
                    virtualServiceName: 'test-service.domain.local',
                    virtualServiceProvider: appmesh.VirtualServiceProvider.virtualRouter(testRouter),
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualService', {
                    Spec: {
                        Provider: {
                            VirtualRouter: {
                                VirtualRouterName: {
                                    'Fn::GetAtt': ['meshtestrouterF78D72DD', 'VirtualRouterName'],
                                },
                            },
                        },
                    },
                    MeshOwner: assertions_1.Match.absent(),
                });
            });
        });
        describe('with single virtual node provider resource', () => {
            test('should create service', () => {
                // GIVEN
                const stack = new cdk.Stack();
                // WHEN
                const mesh = new appmesh.Mesh(stack, 'mesh', {
                    meshName: 'test-mesh',
                });
                const node = mesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                    listeners: [appmesh.VirtualNodeListener.http({
                            port: 8080,
                        })],
                });
                new appmesh.VirtualService(stack, 'service2', {
                    virtualServiceName: 'test-service.domain.local',
                    virtualServiceProvider: appmesh.VirtualServiceProvider.virtualNode(node),
                });
                // THEN
                assertions_1.Template.fromStack(stack).
                    hasResourceProperties('AWS::AppMesh::VirtualService', {
                    Spec: {
                        Provider: {
                            VirtualNode: {
                                VirtualNodeName: {
                                    'Fn::GetAtt': ['meshtestnodeF93946D4', 'VirtualNodeName'],
                                },
                            },
                        },
                    },
                });
            });
        });
    });
    describe('When creating a VirtualService', () => {
        describe('with shared service mesh', () => {
            test('Mesh Owner is the AWS account ID of the account that shared the mesh with your account', () => {
                // GIVEN
                const app = new cdk.App();
                const meshEnv = { account: '1234567899', region: 'us-west-2' };
                const virtualServiceEnv = { account: '9987654321', region: 'us-west-2' };
                // Creating stack in Account B
                const stack = new cdk.Stack(app, 'mySharedStack', { env: virtualServiceEnv });
                // Mesh is in Account A
                const sharedMesh = appmesh.Mesh.fromMeshArn(stack, 'shared-mesh', `arn:aws:appmesh:${meshEnv.region}:${meshEnv.account}:mesh/shared-mesh`);
                const node = sharedMesh.addVirtualNode('test-node', {
                    serviceDiscovery: appmesh.ServiceDiscovery.dns('test.domain.local'),
                    listeners: [appmesh.VirtualNodeListener.http({
                            port: 8080,
                        })],
                });
                // WHEN
                new appmesh.VirtualService(stack, 'test-node', {
                    virtualServiceProvider: appmesh.VirtualServiceProvider.virtualNode(node),
                });
                // THEN
                assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppMesh::VirtualService', {
                    MeshOwner: meshEnv.account,
                });
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zZXJ2aWNlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2aXJ0dWFsLXNlcnZpY2UudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFtRDtBQUNuRCxrQ0FBa0M7QUFDbEMsa0NBQWtDO0FBRWxDLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRTtRQUNwRCxRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDO1FBQzVCLE1BQU0sa0JBQWtCLEdBQUcsaUJBQWlCLENBQUM7UUFDN0MsTUFBTSxHQUFHLEdBQUcsK0NBQStDLFFBQVEsbUJBQW1CLGtCQUFrQixFQUFFLENBQUM7UUFDM0csT0FBTztRQUNQLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsb0JBQW9CLENBQUMsS0FBSyxFQUFFLHVCQUF1QixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RHLE9BQU87UUFDUCxNQUFNLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdEQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ3RFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDhDQUE4QyxFQUFFLEdBQUcsRUFBRTtRQUN4RCxRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsTUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDO1FBQzVCLE1BQU0sa0JBQWtCLEdBQUcsaUJBQWlCLENBQUM7UUFFN0MsT0FBTztRQUNQLE1BQU0sY0FBYyxHQUFHLE9BQU8s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QU0sSUFBSSxPQUFPLENBQUMsT0FBTyxtQkFBbUIsQ0FBQyxDQUFDO2dCQUUzRSxNQUFNLElBQUksR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRTtvQkFDbEQsZ0JBQWdCLEVBQUUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztvQkFDbkUsU0FBUyxFQUFFLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQzs0QkFDM0MsSUFBSSxFQUFFLElBQUk7eUJBQ1gsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQztnQkFFSCxPQUFPO2dCQUNQLElBQUksT0FBTyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO29CQUM3QyxzQkFBc0IsRUFBRSxPQUFPLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztpQkFDekUsQ0FBQyxDQUFDO2dCQUVILE9BQU87Z0JBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsOEJBQThCLEVBQUU7b0JBQzlFLFNBQVMsRUFBRSxPQUFPLENBQUMsT0FBTztpQkFDM0IsQ0FBQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGFwcG1lc2ggZnJvbSAnLi4vbGliJztcblxuZGVzY3JpYmUoJ3ZpcnR1YWwgc2VydmljZScsICgpID0+IHtcbiAgdGVzdCgnQ2FuIGltcG9ydCBWaXJ0dWFsIFNlcnZpY2VzIHVzaW5nIGFuIEFSTicsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgY29uc3QgbWVzaE5hbWUgPSAndGVzdE1lc2gnO1xuICAgIGNvbnN0IHZpcnR1YWxTZXJ2aWNlTmFtZSA9ICd2aXJ0dWFsLXNlcnZpY2UnO1xuICAgIGNvbnN0IGFybiA9IGBhcm46YXdzOmFwcG1lc2g6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjptZXNoLyR7bWVzaE5hbWV9L3ZpcnR1YWxTZXJ2aWNlLyR7dmlydHVhbFNlcnZpY2VOYW1lfWA7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHZpcnR1YWxSb3V0ZXIgPSBhcHBtZXNoLlZpcnR1YWxSb3V0ZXIuZnJvbVZpcnR1YWxSb3V0ZXJBcm4oc3RhY2ssICdpbXBvcnRlZFZpcnR1YWxSb3V0ZXInLCBhcm4pO1xuICAgIC8vIFRIRU5cbiAgICBleHBlY3QodmlydHVhbFJvdXRlci5tZXNoLm1lc2hOYW1lKS50b0VxdWFsKG1lc2hOYW1lKTtcbiAgICBleHBlY3QodmlydHVhbFJvdXRlci52aXJ0dWFsUm91dGVyTmFtZSkudG9FcXVhbCh2aXJ0dWFsU2VydmljZU5hbWUpO1xuICB9KTtcblxuICB0ZXN0KCdDYW4gaW1wb3J0IFZpcnR1YWwgU2VydmljZXMgdXNpbmcgYXR0cmlidXRlcycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgY29uc3QgbWVzaE5hbWUgPSAndGVzdE1lc2gnO1xuICAgIGNvbnN0IHZpcnR1YWxTZXJ2aWNlTmFtZSA9ICd2aXJ0dWFsLXNlcnZpY2UnO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHZpcnR1YWxTZXJ2aWNlID0gYXBwbWVzaC5WaXJ0dWFsU2VydmljZS5mcm9tVmlydHVhbFNlcnZpY2VBdHRyaWJ1dGVzKHN0YWNrLCAnaW1wb3J0ZWRWaXJ0dWFsU2VydmljZScsIHtcbiAgICAgIG1lc2g6IGFwcG1lc2guTWVzaC5mcm9tTWVzaE5hbWUoc3RhY2ssICdNZXNoJywgbWVzaE5hbWUpLFxuICAgICAgdmlydHVhbFNlcnZpY2VOYW1lOiB2aXJ0dWFsU2VydmljZU5hbWUsXG4gICAgfSk7XG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCh2aXJ0dWFsU2VydmljZS5tZXNoLm1lc2hOYW1lKS50b0VxdWFsKG1lc2hOYW1lKTtcbiAgICBleHBlY3QodmlydHVhbFNlcnZpY2UudmlydHVhbFNlcnZpY2VOYW1lKS50b0VxdWFsKHZpcnR1YWxTZXJ2aWNlTmFtZSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdXaGVuIGFkZGluZyBhIFZpcnR1YWxTZXJ2aWNlIHRvIGEgbWVzaCcsICgpID0+IHtcbiAgICBkZXNjcmliZSgnd2l0aCBzaW5nbGUgdmlydHVhbCByb3V0ZXIgcHJvdmlkZXIgcmVzb3VyY2UnLCAoKSA9PiB7XG4gICAgICB0ZXN0KCdzaG91bGQgY3JlYXRlIHNlcnZpY2UnLCAoKSA9PiB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBhcHBtZXNoLk1lc2goc3RhY2ssICdtZXNoJywge1xuICAgICAgICAgIG1lc2hOYW1lOiAndGVzdC1tZXNoJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgdGVzdFJvdXRlciA9IG1lc2guYWRkVmlydHVhbFJvdXRlcigndGVzdC1yb3V0ZXInLCB7XG4gICAgICAgICAgbGlzdGVuZXJzOiBbXG4gICAgICAgICAgICBhcHBtZXNoLlZpcnR1YWxSb3V0ZXJMaXN0ZW5lci5odHRwKCksXG4gICAgICAgICAgXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV3IGFwcG1lc2guVmlydHVhbFNlcnZpY2Uoc3RhY2ssICdzZXJ2aWNlJywge1xuICAgICAgICAgIHZpcnR1YWxTZXJ2aWNlTmFtZTogJ3Rlc3Qtc2VydmljZS5kb21haW4ubG9jYWwnLFxuICAgICAgICAgIHZpcnR1YWxTZXJ2aWNlUHJvdmlkZXI6IGFwcG1lc2guVmlydHVhbFNlcnZpY2VQcm92aWRlci52aXJ0dWFsUm91dGVyKHRlc3RSb3V0ZXIpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuXG4gICAgICAgICAgaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcE1lc2g6OlZpcnR1YWxTZXJ2aWNlJywge1xuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBQcm92aWRlcjoge1xuICAgICAgICAgICAgICAgIFZpcnR1YWxSb3V0ZXI6IHtcbiAgICAgICAgICAgICAgICAgIFZpcnR1YWxSb3V0ZXJOYW1lOiB7XG4gICAgICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogWydtZXNodGVzdHJvdXRlckY3OEQ3MkREJywgJ1ZpcnR1YWxSb3V0ZXJOYW1lJ10sXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgTWVzaE93bmVyOiBNYXRjaC5hYnNlbnQoKSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ3dpdGggc2luZ2xlIHZpcnR1YWwgbm9kZSBwcm92aWRlciByZXNvdXJjZScsICgpID0+IHtcbiAgICAgIHRlc3QoJ3Nob3VsZCBjcmVhdGUgc2VydmljZScsICgpID0+IHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICBjb25zdCBtZXNoID0gbmV3IGFwcG1lc2guTWVzaChzdGFjaywgJ21lc2gnLCB7XG4gICAgICAgICAgbWVzaE5hbWU6ICd0ZXN0LW1lc2gnLFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBub2RlID0gbWVzaC5hZGRWaXJ0dWFsTm9kZSgndGVzdC1ub2RlJywge1xuICAgICAgICAgIHNlcnZpY2VEaXNjb3Zlcnk6IGFwcG1lc2guU2VydmljZURpc2NvdmVyeS5kbnMoJ3Rlc3QuZG9tYWluLmxvY2FsJyksXG4gICAgICAgICAgbGlzdGVuZXJzOiBbYXBwbWVzaC5WaXJ0dWFsTm9kZUxpc3RlbmVyLmh0dHAoe1xuICAgICAgICAgICAgcG9ydDogODA4MCxcbiAgICAgICAgICB9KV0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBhcHBtZXNoLlZpcnR1YWxTZXJ2aWNlKHN0YWNrLCAnc2VydmljZTInLCB7XG4gICAgICAgICAgdmlydHVhbFNlcnZpY2VOYW1lOiAndGVzdC1zZXJ2aWNlLmRvbWFpbi5sb2NhbCcsXG4gICAgICAgICAgdmlydHVhbFNlcnZpY2VQcm92aWRlcjogYXBwbWVzaC5WaXJ0dWFsU2VydmljZVByb3ZpZGVyLnZpcnR1YWxOb2RlKG5vZGUpLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUSEVOXG4gICAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuXG4gICAgICAgICAgaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcE1lc2g6OlZpcnR1YWxTZXJ2aWNlJywge1xuICAgICAgICAgICAgU3BlYzoge1xuICAgICAgICAgICAgICBQcm92aWRlcjoge1xuICAgICAgICAgICAgICAgIFZpcnR1YWxOb2RlOiB7XG4gICAgICAgICAgICAgICAgICBWaXJ0dWFsTm9kZU5hbWU6IHtcbiAgICAgICAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbJ21lc2h0ZXN0bm9kZUY5Mzk0NkQ0JywgJ1ZpcnR1YWxOb2RlTmFtZSddLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnV2hlbiBjcmVhdGluZyBhIFZpcnR1YWxTZXJ2aWNlJywgKCkgPT4ge1xuICAgIGRlc2NyaWJlKCd3aXRoIHNoYXJlZCBzZXJ2aWNlIG1lc2gnLCAoKSA9PiB7XG4gICAgICB0ZXN0KCdNZXNoIE93bmVyIGlzIHRoZSBBV1MgYWNjb3VudCBJRCBvZiB0aGUgYWNjb3VudCB0aGF0IHNoYXJlZCB0aGUgbWVzaCB3aXRoIHlvdXIgYWNjb3VudCcsICgpID0+IHtcbiAgICAgICAgLy8gR0lWRU5cbiAgICAgICAgY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbiAgICAgICAgY29uc3QgbWVzaEVudiA9IHsgYWNjb3VudDogJzEyMzQ1Njc4OTknLCByZWdpb246ICd1cy13ZXN0LTInIH07XG4gICAgICAgIGNvbnN0IHZpcnR1YWxTZXJ2aWNlRW52ID0geyBhY2NvdW50OiAnOTk4NzY1NDMyMScsIHJlZ2lvbjogJ3VzLXdlc3QtMicgfTtcblxuICAgICAgICAvLyBDcmVhdGluZyBzdGFjayBpbiBBY2NvdW50IEJcbiAgICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ215U2hhcmVkU3RhY2snLCB7IGVudjogdmlydHVhbFNlcnZpY2VFbnYgfSk7XG4gICAgICAgIC8vIE1lc2ggaXMgaW4gQWNjb3VudCBBXG4gICAgICAgIGNvbnN0IHNoYXJlZE1lc2ggPSBhcHBtZXNoLk1lc2guZnJvbU1lc2hBcm4oc3RhY2ssICdzaGFyZWQtbWVzaCcsXG4gICAgICAgICAgYGFybjphd3M6YXBwbWVzaDoke21lc2hFbnYucmVnaW9ufToke21lc2hFbnYuYWNjb3VudH06bWVzaC9zaGFyZWQtbWVzaGApO1xuXG4gICAgICAgIGNvbnN0IG5vZGUgPSBzaGFyZWRNZXNoLmFkZFZpcnR1YWxOb2RlKCd0ZXN0LW5vZGUnLCB7XG4gICAgICAgICAgc2VydmljZURpc2NvdmVyeTogYXBwbWVzaC5TZXJ2aWNlRGlzY292ZXJ5LmRucygndGVzdC5kb21haW4ubG9jYWwnKSxcbiAgICAgICAgICBsaXN0ZW5lcnM6IFthcHBtZXNoLlZpcnR1YWxOb2RlTGlzdGVuZXIuaHR0cCh7XG4gICAgICAgICAgICBwb3J0OiA4MDgwLFxuICAgICAgICAgIH0pXSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gV0hFTlxuICAgICAgICBuZXcgYXBwbWVzaC5WaXJ0dWFsU2VydmljZShzdGFjaywgJ3Rlc3Qtbm9kZScsIHtcbiAgICAgICAgICB2aXJ0dWFsU2VydmljZVByb3ZpZGVyOiBhcHBtZXNoLlZpcnR1YWxTZXJ2aWNlUHJvdmlkZXIudmlydHVhbE5vZGUobm9kZSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFRIRU5cbiAgICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwTWVzaDo6VmlydHVhbFNlcnZpY2UnLCB7XG4gICAgICAgICAgTWVzaE93bmVyOiBtZXNoRW52LmFjY291bnQsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=