"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const lambda = require("../../aws-lambda");
const cdk = require("../../core");
const core_1 = require("../../core");
const appsync = require("../lib");
let stack;
let api;
beforeEach(() => {
    // GIVEN
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'api', {
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.lambda.graphql')),
    });
});
describe('Lambda caching config', () => {
    // GIVEN
    let func;
    beforeEach(() => {
        func = new lambda.Function(stack, 'func', {
            code: lambda.Code.fromAsset(path.join(__dirname, 'verify/lambda-tutorial')),
            handler: 'lambda-tutorial.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
        });
    });
    test('Lambda resolver can be created without caching config', () => {
        // WHEN
        const lambdaDS = api.addLambdaDataSource('LambdaDS', func);
        lambdaDS.createResolver('QueryAllPosts', {
            typeName: 'Query',
            fieldName: 'allPosts',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::Resolver', {
            TypeName: 'Query',
            FieldName: 'allPosts',
            CachingConfig: assertions_1.Match.absent(),
        });
    });
    test('Lambda resolver contains caching config with caching key and TTL', () => {
        // WHEN
        const lambdaDS = api.addLambdaDataSource('LambdaDS', func);
        lambdaDS.createResolver('QueryAllPosts', {
            typeName: 'Query',
            fieldName: 'allPosts',
            cachingConfig: {
                cachingKeys: ['$context.arguments', '$context.source', '$context.identity'],
                ttl: core_1.Duration.seconds(300),
            },
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::Resolver', {
            TypeName: 'Query',
            FieldName: 'allPosts',
            CachingConfig: {
                CachingKeys: ['$context.arguments', '$context.source', '$context.identity'],
                Ttl: 300,
            },
        });
    });
    test('Lambda resolver throws error when caching config with TTL is less than 1 second', () => {
        // WHEN
        const ttlInSconds = 0;
        const lambdaDS = api.addLambdaDataSource('LambdaDS', func);
        // THEN
        expect(() => {
            lambdaDS.createResolver('QueryAllPosts', {
                typeName: 'Query',
                fieldName: 'allPosts',
                cachingConfig: {
                    cachingKeys: ['$context.identity'],
                    ttl: core_1.Duration.seconds(0),
                },
            });
        }).toThrowError(`Caching config TTL must be between 1 and 3600 seconds. Received: ${ttlInSconds}`);
    });
    test('Lambda resolver throws error when caching config with TTL is greater than 3600 seconds', () => {
        // WHEN
        const ttlInSconds = 4200;
        const lambdaDS = api.addLambdaDataSource('LambdaDS', func);
        // THEN
        expect(() => {
            lambdaDS.createResolver('QueryAllPosts', {
                typeName: 'Query',
                fieldName: 'allPosts',
                cachingConfig: {
                    cachingKeys: ['$context.identity'],
                    ttl: core_1.Duration.seconds(ttlInSconds),
                },
            });
        }).toThrowError(`Caching config TTL must be between 1 and 3600 seconds. Received: ${ttlInSconds}`);
    });
    test('Lambda resolver throws error when caching config has invalid caching keys', () => {
        // WHEN
        const invalidCachingKeys = ['$context.metadata'];
        const lambdaDS = api.addLambdaDataSource('LambdaDS', func);
        // THEN
        expect(() => {
            lambdaDS.createResolver('QueryAllPosts', {
                typeName: 'Query',
                fieldName: 'allPosts',
                cachingConfig: {
                    cachingKeys: invalidCachingKeys,
                    ttl: core_1.Duration.seconds(300),
                },
            });
        }).toThrowError(`Caching config keys must begin with $context.arguments, $context.source or $context.identity. Received: ${invalidCachingKeys}`);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1jYWNoaW5nLWNvbmZpZy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwc3luYy1jYWNoaW5nLWNvbmZpZy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGlEQUFtRDtBQUNuRCwyQ0FBMkM7QUFDM0Msa0NBQWtDO0FBQ2xDLHFDQUFzQztBQUN0QyxrQ0FBa0M7QUFFbEMsSUFBSSxLQUFnQixDQUFDO0FBQ3JCLElBQUksR0FBdUIsQ0FBQztBQUU1QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsUUFBUTtJQUNSLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QixHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUU7UUFDekMsSUFBSSxFQUFFLEtBQUs7UUFDWCxNQUFNLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsd0JBQXdCLENBQUMsQ0FBQztLQUNyRixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDckMsUUFBUTtJQUNSLElBQUksSUFBcUIsQ0FBQztJQUUxQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1lBQ3hDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1lBQzNFLE9BQU8sRUFBRSx5QkFBeUI7WUFDbEMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJ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aUJBQ25DO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLG9FQUFvRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3JHLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDJFQUEyRSxFQUFFLEdBQUcsRUFBRTtRQUNyRixPQUFPO1FBQ1AsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDakQsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUUzRCxPQUFPO1FBQ1AsTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUNWLFFBQVEsQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFO2dCQUN2QyxRQUFRLEVBQUUsT0FBTztnQkFDakIsU0FBUyxFQUFFLFVBQVU7Z0JBQ3JCLGFBQWEsRUFBRTtvQkFDYixXQUFXLEVBQUUsa0JBQWtCO29CQUMvQixHQUFHLEVBQUUsZUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7aUJBQzNCO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLDJHQUEyRyxrQkFBa0IsRUFBRSxDQUFDLENBQUM7SUFDbkosQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCB7IER1cmF0aW9uIH0gZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gJy4uL2xpYic7XG5cbmxldCBzdGFjazogY2RrLlN0YWNrO1xubGV0IGFwaTogYXBwc3luYy5HcmFwaHFsQXBpO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgLy8gR0lWRU5cbiAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gIGFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICdhcGknLCB7XG4gICAgbmFtZTogJ2FwaScsXG4gICAgc2NoZW1hOiBhcHBzeW5jLlNjaGVtYUZpbGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdhcHBzeW5jLmxhbWJkYS5ncmFwaHFsJykpLFxuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnTGFtYmRhIGNhY2hpbmcgY29uZmlnJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBsZXQgZnVuYzogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGZ1bmMgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnZnVuYycsIHtcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAndmVyaWZ5L2xhbWJkYS10dXRvcmlhbCcpKSxcbiAgICAgIGhhbmRsZXI6ICdsYW1iZGEtdHV0b3JpYWwuaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnTGFtYmRhIHJlc29sdmVyIGNhbiBiZSBjcmVhdGVkIHdpdGhvdXQgY2FjaGluZyBjb25maWcnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGxhbWJkYURTID0gYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ0xhbWJkYURTJywgZnVuYyk7XG5cbiAgICBsYW1iZGFEUy5jcmVhdGVSZXNvbHZlcignUXVlcnlBbGxQb3N0cycsIHtcbiAgICAgIHR5cGVOYW1lOiAnUXVlcnknLFxuICAgICAgZmllbGROYW1lOiAnYWxsUG9zdHMnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OlJlc29sdmVyJywge1xuICAgICAgVHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICBGaWVsZE5hbWU6ICdhbGxQb3N0cycsXG4gICAgICBDYWNoaW5nQ29uZmlnOiBNYXRjaC5hYnNlbnQoKSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnTGFtYmRhIHJlc29sdmVyIGNvbnRhaW5zIGNhY2hpbmcgY29uZmlnIHdpdGggY2FjaGluZyBrZXkgYW5kIFRUTCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgbGFtYmRhRFMgPSBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZSgnTGFtYmRhRFMnLCBmdW5jKTtcblxuICAgIGxhbWJkYURTLmNyZWF0ZVJlc29sdmVyKCdRdWVyeUFsbFBvc3RzJywge1xuICAgICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICBmaWVsZE5hbWU6ICdhbGxQb3N0cycsXG4gICAgICBjYWNoaW5nQ29uZmlnOiB7XG4gICAgICAgIGNhY2hpbmdLZXlzOiBbJyRjb250ZXh0LmFyZ3VtZW50cycsICckY29udGV4dC5zb3VyY2UnLCAnJGNvbnRleHQuaWRlbnRpdHknXSxcbiAgICAgICAgdHRsOiBEdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OlJlc29sdmVyJywge1xuICAgICAgVHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICBGaWVsZE5hbWU6ICdhbGxQb3N0cycsXG4gICAgICBDYWNoaW5nQ29uZmlnOiB7XG4gICAgICAgIENhY2hpbmdLZXlzOiBbJyRjb250ZXh0LmFyZ3VtZW50cycsICckY29udGV4dC5zb3VyY2UnLCAnJGNvbnRleHQuaWRlbnRpdHknXSxcbiAgICAgICAgVHRsOiAzMDAsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdMYW1iZGEgcmVzb2x2ZXIgdGhyb3dzIGVycm9yIHdoZW4gY2FjaGluZyBjb25maWcgd2l0aCBUVEwgaXMgbGVzcyB0aGFuIDEgc2Vjb25kJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0dGxJblNjb25kcyA9IDA7XG4gICAgY29uc3QgbGFtYmRhRFMgPSBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZSgnTGFtYmRhRFMnLCBmdW5jKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgbGFtYmRhRFMuY3JlYXRlUmVzb2x2ZXIoJ1F1ZXJ5QWxsUG9zdHMnLCB7XG4gICAgICAgIHR5cGVOYW1lOiAnUXVlcnknLFxuICAgICAgICBmaWVsZE5hbWU6ICdhbGxQb3N0cycsXG4gICAgICAgIGNhY2hpbmdDb25maWc6IHtcbiAgICAgICAgICBjYWNoaW5nS2V5czogWyckY29udGV4dC5pZGVudGl0eSddLFxuICAgICAgICAgIHR0bDogRHVyYXRpb24uc2Vjb25kcygwKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pLnRvVGhyb3dFcnJvcihgQ2FjaGluZyBjb25maWcgVFRMIG11c3QgYmUgYmV0d2VlbiAxIGFuZCAzNjAwIHNlY29uZHMuIFJlY2VpdmVkOiAke3R0bEluU2NvbmRzfWApO1xuICB9KTtcblxuICB0ZXN0KCdMYW1iZGEgcmVzb2x2ZXIgdGhyb3dzIGVycm9yIHdoZW4gY2FjaGluZyBjb25maWcgd2l0aCBUVEwgaXMgZ3JlYXRlciB0aGFuIDM2MDAgc2Vjb25kcycsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdHRsSW5TY29uZHMgPSA0MjAwO1xuICAgIGNvbnN0IGxhbWJkYURTID0gYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ0xhbWJkYURTJywgZnVuYyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIGxhbWJkYURTLmNyZWF0ZVJlc29sdmVyKCdRdWVyeUFsbFBvc3RzJywge1xuICAgICAgICB0eXBlTmFtZTogJ1F1ZXJ5JyxcbiAgICAgICAgZmllbGROYW1lOiAnYWxsUG9zdHMnLFxuICAgICAgICBjYWNoaW5nQ29uZmlnOiB7XG4gICAgICAgICAgY2FjaGluZ0tleXM6IFsnJGNvbnRleHQuaWRlbnRpdHknXSxcbiAgICAgICAgICB0dGw6IER1cmF0aW9uLnNlY29uZHModHRsSW5TY29uZHMpLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSkudG9UaHJvd0Vycm9yKGBDYWNoaW5nIGNvbmZpZyBUVEwgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDM2MDAgc2Vjb25kcy4gUmVjZWl2ZWQ6ICR7dHRsSW5TY29uZHN9YCk7XG4gIH0pO1xuXG4gIHRlc3QoJ0xhbWJkYSByZXNvbHZlciB0aHJvd3MgZXJyb3Igd2hlbiBjYWNoaW5nIGNvbmZpZyBoYXMgaW52YWxpZCBjYWNoaW5nIGtleXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGludmFsaWRDYWNoaW5nS2V5cyA9IFsnJGNvbnRleHQubWV0YWRhdGEnXTtcbiAgICBjb25zdCBsYW1iZGFEUyA9IGFwaS5hZGRMYW1iZGFEYXRhU291cmNlKCdMYW1iZGFEUycsIGZ1bmMpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBsYW1iZGFEUy5jcmVhdGVSZXNvbHZlcignUXVlcnlBbGxQb3N0cycsIHtcbiAgICAgICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICAgIGZpZWxkTmFtZTogJ2FsbFBvc3RzJyxcbiAgICAgICAgY2FjaGluZ0NvbmZpZzoge1xuICAgICAgICAgIGNhY2hpbmdLZXlzOiBpbnZhbGlkQ2FjaGluZ0tleXMsXG4gICAgICAgICAgdHRsOiBEdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KS50b1Rocm93RXJyb3IoYENhY2hpbmcgY29uZmlnIGtleXMgbXVzdCBiZWdpbiB3aXRoICRjb250ZXh0LmFyZ3VtZW50cywgJGNvbnRleHQuc291cmNlIG9yICRjb250ZXh0LmlkZW50aXR5LiBSZWNlaXZlZDogJHtpbnZhbGlkQ2FjaGluZ0tleXN9YCk7XG4gIH0pO1xufSk7XG4iXX0=