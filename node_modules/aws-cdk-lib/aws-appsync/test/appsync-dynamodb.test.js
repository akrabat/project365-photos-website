"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const db = require("../../aws-dynamodb");
const cdk = require("../../core");
const appsync = require("../lib");
const lib_1 = require("../lib");
function joined(str) {
    return str.replace(/\s+/g, '');
}
// GLOBAL GIVEN
let stack;
let api;
beforeEach(() => {
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'baseApi', {
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
    });
});
describe('DynamoDb Data Source configuration', () => {
    // GIVEN
    let table;
    beforeEach(() => {
        table = new db.Table(stack, 'table', {
            partitionKey: {
                name: 'id',
                type: db.AttributeType.STRING,
            },
        });
    });
    test('default configuration produces name `DynamoDbCDKDataSource`', () => {
        // WHEN
        api.addDynamoDbDataSource('ds', table);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AMAZON_DYNAMODB',
            Name: 'ds',
        });
    });
    test('appsync configures name correctly', () => {
        // WHEN
        api.addDynamoDbDataSource('ds', table, {
            name: 'custom',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AMAZON_DYNAMODB',
            Name: 'custom',
        });
    });
    test('appsync configures name and description correctly', () => {
        // WHEN
        api.addDynamoDbDataSource('ds', table, {
            name: 'custom',
            description: 'custom description',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AMAZON_DYNAMODB',
            Name: 'custom',
            Description: 'custom description',
        });
    });
    test('appsync errors when creating multiple dynamo db data sources with no configuration', () => {
        // THEN
        expect(() => {
            api.addDynamoDbDataSource('ds', table);
            api.addDynamoDbDataSource('ds', table);
        }).toThrow("There is already a Construct with name 'ds' in GraphqlApi [baseApi]");
    });
});
describe('DynamoDB Mapping Templates', () => {
    test('read consistency option for dynamoDbScanTable should render correctly', () => {
        const template = appsync.MappingTemplate.dynamoDbScanTable(true);
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual('{\"version\":\"2017-02-28\",\"operation\":\"Scan\",\"consistentRead\":true}');
    });
    test('read consistency option for dynamoDbGetItem should render correctly', () => {
        const template = appsync.MappingTemplate.dynamoDbGetItem('id', 'id', true);
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual('{\"version\":\"2017-02-28\",\"operation\":\"GetItem\",\"consistentRead\":true,\"key\":{\"id\":$util.dynamodb.toDynamoDBJson($ctx.args.id)}}');
    });
    test('read consistency option for dynamoDbQuery should render correctly', () => {
        const template = appsync.MappingTemplate.dynamoDbQuery(lib_1.KeyCondition.eq('order', 'order'), 'orderIndex', true);
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual('{\"version\":\"2017-02-28\",\"operation\":\"Query\",\"consistentRead\":true,\"index\":\"orderIndex\",\"query\":{\"expression\":\"#order=:order\",\"expressionNames\":{\"#order\":\"order\"},\"expressionValues\":{\":order\":$util.dynamodb.toDynamoDBJson($ctx.args.order)}}}');
    });
    test('PutItem projecting all', () => {
        const template = appsync.MappingTemplate.dynamoDbPutItem(appsync.PrimaryKey.partition('id').is('id'), appsync.Values.projecting());
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual(joined(`
      #set($input = $ctx.args)
      {
        "version" : "2017-02-28",
        "operation" : "PutItem",
        "key" : {
          "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
        },
        "attributeValues": $util.dynamodb.toMapValuesJson($input)
      }`));
    });
    test('PutItem with invididual attributes', () => {
        const template = appsync.MappingTemplate.dynamoDbPutItem(appsync.PrimaryKey.partition('id').is('id'), appsync.Values.attribute('val').is('ctx.args.val'));
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual(joined(`
      #set($input = {})
      $util.qr($input.put("val", ctx.args.val))
      {
        "version" : "2017-02-28",
        "operation" : "PutItem",
        "key" : {
          "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
        },
        "attributeValues": $util.dynamodb.toMapValuesJson($input)
      }`));
    });
    test('PutItem with additional attributes', () => {
        const template = appsync.MappingTemplate.dynamoDbPutItem(appsync.PrimaryKey.partition('id').is('id'), appsync.Values.projecting().attribute('val').is('ctx.args.val'));
        const rendered = joined(template.renderTemplate());
        expect(rendered).toStrictEqual(joined(`
      #set($input = $ctx.args)
      $util.qr($input.put("val", ctx.args.val))
      {
        "version" : "2017-02-28",
        "operation" : "PutItem",
        "key" : {
          "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
        },
        "attributeValues": $util.dynamodb.toMapValuesJson($input)
      }`));
    });
});
describe('adding DynamoDb data source from imported api', () => {
    // GIVEN
    let table;
    beforeEach(() => {
        table = new db.Table(stack, 'table', {
            partitionKey: {
                name: 'id',
                type: db.AttributeType.STRING,
            },
        });
    });
    test('imported api can add DynamoDbDataSource from id', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
        });
        importedApi.addDynamoDbDataSource('ds', table);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AMAZON_DYNAMODB',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
    test('imported api can add DynamoDbDataSource from attributes', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
            graphqlApiArn: api.arn,
        });
        importedApi.addDynamoDbDataSource('ds', table);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AMAZON_DYNAMODB',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1keW5hbW9kYi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwc3luYy1keW5hbW9kYi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGlEQUE0QztBQUM1Qyx5Q0FBeUM7QUFDekMsa0NBQWtDO0FBQ2xDLGtDQUFrQztBQUNsQyxnQ0FBc0M7QUFFdEMsU0FBUyxNQUFNLENBQUMsR0FBVztJQUN6QixPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUFFRCxlQUFlO0FBQ2YsSUFBSSxLQUFnQixDQUFDO0FBQ3JCLElBQUksR0FBdUIsQ0FBQztBQUM1QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hCLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtRQUM3QyxJQUFJLEVBQUUsS0FBSztRQUNYLE1BQU0sRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0tBQ25GLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtJQUNsRCxRQUFRO0lBQ1IsSUFBSSxLQUFlLENBQUM7SUFDcEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLEtBQUssR0FBRyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRTtZQUNuQyxZQUFZLEVBQUU7Z0JBQ1osSUFBSSxFQUFFLElBQUk7Z0JBQ1YsSUFBSSxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsTUFBTTthQUM5QjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxD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O1NBQ3hCLENBQUMsQ0FBQztRQUNILFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFL0MsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLDBCQUEwQixFQUFFO1lBQzFFLElBQUksRUFBRSxpQkFBaUI7WUFDdkIsS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEVBQUU7U0FDdEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMseURBQXlELEVBQUUsR0FBRyxFQUFFO1FBQ25FLE9BQU87UUFDUCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7WUFDcEYsWUFBWSxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ3ZCLGFBQWEsRUFBRSxHQUFHLENBQUMsR0FBRztTQUN2QixDQUFDLENBQUM7UUFDSCxXQUFXLENBQUMscUJBQXFCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRS9DLE9BQU87UUFDUCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQywwQkFBMEIsRUFBRTtZQUMxRSxJQUFJLEVBQUUsaUJBQWlCO1lBQ3ZCLEtBQUssRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLGlCQUFpQixFQUFFLE9BQU8sQ0FBQyxFQUFFO1NBQ3RELENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGRiIGZyb20gJy4uLy4uL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBLZXlDb25kaXRpb24gfSBmcm9tICcuLi9saWInO1xuXG5mdW5jdGlvbiBqb2luZWQoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL1xccysvZywgJycpO1xufVxuXG4vLyBHTE9CQUwgR0lWRU5cbmxldCBzdGFjazogY2RrLlN0YWNrO1xubGV0IGFwaTogYXBwc3luYy5HcmFwaHFsQXBpO1xuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICBhcGkgPSBuZXcgYXBwc3luYy5HcmFwaHFsQXBpKHN0YWNrLCAnYmFzZUFwaScsIHtcbiAgICBuYW1lOiAnYXBpJyxcbiAgICBzY2hlbWE6IGFwcHN5bmMuU2NoZW1hRmlsZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2FwcHN5bmMudGVzdC5ncmFwaHFsJykpLFxuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnRHluYW1vRGIgRGF0YSBTb3VyY2UgY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbGV0IHRhYmxlOiBkYi5UYWJsZTtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgdGFibGUgPSBuZXcgZGIuVGFibGUoc3RhY2ssICd0YWJsZScsIHtcbiAgICAgIHBhcnRpdGlvbktleToge1xuICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICB0eXBlOiBkYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RlZmF1bHQgY29uZmlndXJhdGlvbiBwcm9kdWNlcyBuYW1lIGBEeW5hbW9EYkNES0RhdGFTb3VyY2VgJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBhcGkuYWRkRHluYW1vRGJEYXRhU291cmNlKCdkcycsIHRhYmxlKTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0FNQVpPTl9EWU5BTU9EQicsXG4gICAgICBOYW1lOiAnZHMnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGNvbmZpZ3VyZXMgbmFtZSBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGFwaS5hZGREeW5hbW9EYkRhdGFTb3VyY2UoJ2RzJywgdGFibGUsIHtcbiAgICAgIG5hbWU6ICdjdXN0b20nLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnQU1BWk9OX0RZTkFNT0RCJyxcbiAgICAgIE5hbWU6ICdjdXN0b20nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGNvbmZpZ3VyZXMgbmFtZSBhbmQgZGVzY3JpcHRpb24gY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBhcGkuYWRkRHluYW1vRGJEYXRhU291cmNlKCdkcycsIHRhYmxlLCB7XG4gICAgICBuYW1lOiAnY3VzdG9tJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0FNQVpPTl9EWU5BTU9EQicsXG4gICAgICBOYW1lOiAnY3VzdG9tJyxcbiAgICAgIERlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXBwc3luYyBlcnJvcnMgd2hlbiBjcmVhdGluZyBtdWx0aXBsZSBkeW5hbW8gZGIgZGF0YSBzb3VyY2VzIHdpdGggbm8gY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIGFwaS5hZGREeW5hbW9EYkRhdGFTb3VyY2UoJ2RzJywgdGFibGUpO1xuICAgICAgYXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnZHMnLCB0YWJsZSk7XG4gICAgfSkudG9UaHJvdyhcIlRoZXJlIGlzIGFscmVhZHkgYSBDb25zdHJ1Y3Qgd2l0aCBuYW1lICdkcycgaW4gR3JhcGhxbEFwaSBbYmFzZUFwaV1cIik7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdEeW5hbW9EQiBNYXBwaW5nIFRlbXBsYXRlcycsICgpID0+IHtcbiAgdGVzdCgncmVhZCBjb25zaXN0ZW5jeSBvcHRpb24gZm9yIGR5bmFtb0RiU2NhblRhYmxlIHNob3VsZCByZW5kZXIgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gYXBwc3luYy5NYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJTY2FuVGFibGUodHJ1ZSk7XG4gICAgY29uc3QgcmVuZGVyZWQgPSBqb2luZWQodGVtcGxhdGUucmVuZGVyVGVtcGxhdGUoKSk7XG4gICAgZXhwZWN0KHJlbmRlcmVkKS50b1N0cmljdEVxdWFsKCd7XFxcInZlcnNpb25cXFwiOlxcXCIyMDE3LTAyLTI4XFxcIixcXFwib3BlcmF0aW9uXFxcIjpcXFwiU2NhblxcXCIsXFxcImNvbnNpc3RlbnRSZWFkXFxcIjp0cnVlfScpO1xuICB9KTtcblxuICB0ZXN0KCdyZWFkIGNvbnNpc3RlbmN5IG9wdGlvbiBmb3IgZHluYW1vRGJHZXRJdGVtIHNob3VsZCByZW5kZXIgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gYXBwc3luYy5NYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJHZXRJdGVtKCdpZCcsICdpZCcsIHRydWUpO1xuICAgIGNvbnN0IHJlbmRlcmVkID0gam9pbmVkKHRlbXBsYXRlLnJlbmRlclRlbXBsYXRlKCkpO1xuICAgIGV4cGVjdChyZW5kZXJlZCkudG9TdHJpY3RFcXVhbCgne1xcXCJ2ZXJzaW9uXFxcIjpcXFwiMjAxNy0wMi0yOFxcXCIsXFxcIm9wZXJhdGlvblxcXCI6XFxcIkdldEl0ZW1cXFwiLFxcXCJjb25zaXN0ZW50UmVhZFxcXCI6dHJ1ZSxcXFwia2V5XFxcIjp7XFxcImlkXFxcIjokdXRpbC5keW5hbW9kYi50b0R5bmFtb0RCSnNvbigkY3R4LmFyZ3MuaWQpfX0nKTtcbiAgfSk7XG5cbiAgdGVzdCgncmVhZCBjb25zaXN0ZW5jeSBvcHRpb24gZm9yIGR5bmFtb0RiUXVlcnkgc2hvdWxkIHJlbmRlciBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlF1ZXJ5KEtleUNvbmRpdGlvbi5lcSgnb3JkZXInLCAnb3JkZXInKSwgJ29yZGVySW5kZXgnLCB0cnVlKTtcbiAgICBjb25zdCByZW5kZXJlZCA9IGpvaW5lZCh0ZW1wbGF0ZS5yZW5kZXJUZW1wbGF0ZSgpKTtcbiAgICBleHBlY3QocmVuZGVyZWQpLnRvU3RyaWN0RXF1YWwoJ3tcXFwidmVyc2lvblxcXCI6XFxcIjIwMTctMDItMjhcXFwiLFxcXCJvcGVyYXRpb25cXFwiOlxcXCJRdWVyeVxcXCIsXFxcImNvbnNpc3RlbnRSZWFkXFxcIjp0cnVlLFxcXCJpbmRleFxcXCI6XFxcIm9yZGVySW5kZXhcXFwiLFxcXCJxdWVyeVxcXCI6e1xcXCJleHByZXNzaW9uXFxcIjpcXFwiI29yZGVyPTpvcmRlclxcXCIsXFxcImV4cHJlc3Npb25OYW1lc1xcXCI6e1xcXCIjb3JkZXJcXFwiOlxcXCJvcmRlclxcXCJ9LFxcXCJleHByZXNzaW9uVmFsdWVzXFxcIjp7XFxcIjpvcmRlclxcXCI6JHV0aWwuZHluYW1vZGIudG9EeW5hbW9EQkpzb24oJGN0eC5hcmdzLm9yZGVyKX19fScpO1xuICB9KTtcblxuICB0ZXN0KCdQdXRJdGVtIHByb2plY3RpbmcgYWxsJywgKCkgPT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gYXBwc3luYy5NYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJQdXRJdGVtKFxuICAgICAgYXBwc3luYy5QcmltYXJ5S2V5LnBhcnRpdGlvbignaWQnKS5pcygnaWQnKSxcbiAgICAgIGFwcHN5bmMuVmFsdWVzLnByb2plY3RpbmcoKSxcbiAgICApO1xuXG4gICAgY29uc3QgcmVuZGVyZWQgPSBqb2luZWQodGVtcGxhdGUucmVuZGVyVGVtcGxhdGUoKSk7XG5cbiAgICBleHBlY3QocmVuZGVyZWQpLnRvU3RyaWN0RXF1YWwoam9pbmVkKGBcbiAgICAgICNzZXQoJGlucHV0ID0gJGN0eC5hcmdzKVxuICAgICAge1xuICAgICAgICBcInZlcnNpb25cIiA6IFwiMjAxNy0wMi0yOFwiLFxuICAgICAgICBcIm9wZXJhdGlvblwiIDogXCJQdXRJdGVtXCIsXG4gICAgICAgIFwia2V5XCIgOiB7XG4gICAgICAgICAgXCJpZFwiIDogJHV0aWwuZHluYW1vZGIudG9EeW5hbW9EQkpzb24oJGN0eC5hcmdzLmlkKVxuICAgICAgICB9LFxuICAgICAgICBcImF0dHJpYnV0ZVZhbHVlc1wiOiAkdXRpbC5keW5hbW9kYi50b01hcFZhbHVlc0pzb24oJGlucHV0KVxuICAgICAgfWApLFxuICAgICk7XG4gIH0pO1xuXG4gIHRlc3QoJ1B1dEl0ZW0gd2l0aCBpbnZpZGlkdWFsIGF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlB1dEl0ZW0oXG4gICAgICBhcHBzeW5jLlByaW1hcnlLZXkucGFydGl0aW9uKCdpZCcpLmlzKCdpZCcpLFxuICAgICAgYXBwc3luYy5WYWx1ZXMuYXR0cmlidXRlKCd2YWwnKS5pcygnY3R4LmFyZ3MudmFsJyksXG4gICAgKTtcblxuICAgIGNvbnN0IHJlbmRlcmVkID0gam9pbmVkKHRlbXBsYXRlLnJlbmRlclRlbXBsYXRlKCkpO1xuXG4gICAgZXhwZWN0KHJlbmRlcmVkKS50b1N0cmljdEVxdWFsKGpvaW5lZChgXG4gICAgICAjc2V0KCRpbnB1dCA9IHt9KVxuICAgICAgJHV0aWwucXIoJGlucHV0LnB1dChcInZhbFwiLCBjdHguYXJncy52YWwpKVxuICAgICAge1xuICAgICAgICBcInZlcnNpb25cIiA6IFwiMjAxNy0wMi0yOFwiLFxuICAgICAgICBcIm9wZXJhdGlvblwiIDogXCJQdXRJdGVtXCIsXG4gICAgICAgIFwia2V5XCIgOiB7XG4gICAgICAgICAgXCJpZFwiIDogJHV0aWwuZHluYW1vZGIudG9EeW5hbW9EQkpzb24oJGN0eC5hcmdzLmlkKVxuICAgICAgICB9LFxuICAgICAgICBcImF0dHJpYnV0ZVZhbHVlc1wiOiAkdXRpbC5keW5hbW9kYi50b01hcFZhbHVlc0pzb24oJGlucHV0KVxuICAgICAgfWApLFxuICAgICk7XG4gIH0pO1xuXG4gIHRlc3QoJ1B1dEl0ZW0gd2l0aCBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlB1dEl0ZW0oXG4gICAgICBhcHBzeW5jLlByaW1hcnlLZXkucGFydGl0aW9uKCdpZCcpLmlzKCdpZCcpLFxuICAgICAgYXBwc3luYy5WYWx1ZXMucHJvamVjdGluZygpLmF0dHJpYnV0ZSgndmFsJykuaXMoJ2N0eC5hcmdzLnZhbCcpLFxuICAgICk7XG5cbiAgICBjb25zdCByZW5kZXJlZCA9IGpvaW5lZCh0ZW1wbGF0ZS5yZW5kZXJUZW1wbGF0ZSgpKTtcblxuICAgIGV4cGVjdChyZW5kZXJlZCkudG9TdHJpY3RFcXVhbChqb2luZWQoYFxuICAgICAgI3NldCgkaW5wdXQgPSAkY3R4LmFyZ3MpXG4gICAgICAkdXRpbC5xcigkaW5wdXQucHV0KFwidmFsXCIsIGN0eC5hcmdzLnZhbCkpXG4gICAgICB7XG4gICAgICAgIFwidmVyc2lvblwiIDogXCIyMDE3LTAyLTI4XCIsXG4gICAgICAgIFwib3BlcmF0aW9uXCIgOiBcIlB1dEl0ZW1cIixcbiAgICAgICAgXCJrZXlcIiA6IHtcbiAgICAgICAgICBcImlkXCIgOiAkdXRpbC5keW5hbW9kYi50b0R5bmFtb0RCSnNvbigkY3R4LmFyZ3MuaWQpXG4gICAgICAgIH0sXG4gICAgICAgIFwiYXR0cmlidXRlVmFsdWVzXCI6ICR1dGlsLmR5bmFtb2RiLnRvTWFwVmFsdWVzSnNvbigkaW5wdXQpXG4gICAgICB9YCksXG4gICAgKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2FkZGluZyBEeW5hbW9EYiBkYXRhIHNvdXJjZSBmcm9tIGltcG9ydGVkIGFwaScsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbGV0IHRhYmxlOiBkYi5UYWJsZTtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgdGFibGUgPSBuZXcgZGIuVGFibGUoc3RhY2ssICd0YWJsZScsIHtcbiAgICAgIHBhcnRpdGlvbktleToge1xuICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICB0eXBlOiBkYi5BdHRyaWJ1dGVUeXBlLlNUUklORyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ltcG9ydGVkIGFwaSBjYW4gYWRkIER5bmFtb0RiRGF0YVNvdXJjZSBmcm9tIGlkJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBpbXBvcnRlZEFwaSA9IGFwcHN5bmMuR3JhcGhxbEFwaS5mcm9tR3JhcGhxbEFwaUF0dHJpYnV0ZXMoc3RhY2ssICdpbXBvcnRlZEFwaScsIHtcbiAgICAgIGdyYXBocWxBcGlJZDogYXBpLmFwaUlkLFxuICAgIH0pO1xuICAgIGltcG9ydGVkQXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnZHMnLCB0YWJsZSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdBTUFaT05fRFlOQU1PREInLFxuICAgICAgQXBpSWQ6IHsgJ0ZuOjpHZXRBdHQnOiBbJ2Jhc2VBcGlDREE0RDQzQScsICdBcGlJZCddIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ltcG9ydGVkIGFwaSBjYW4gYWRkIER5bmFtb0RiRGF0YVNvdXJjZSBmcm9tIGF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGltcG9ydGVkQXBpID0gYXBwc3luYy5HcmFwaHFsQXBpLmZyb21HcmFwaHFsQXBpQXR0cmlidXRlcyhzdGFjaywgJ2ltcG9ydGVkQXBpJywge1xuICAgICAgZ3JhcGhxbEFwaUlkOiBhcGkuYXBpSWQsXG4gICAgICBncmFwaHFsQXBpQXJuOiBhcGkuYXJuLFxuICAgIH0pO1xuICAgIGltcG9ydGVkQXBpLmFkZER5bmFtb0RiRGF0YVNvdXJjZSgnZHMnLCB0YWJsZSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdBTUFaT05fRFlOQU1PREInLFxuICAgICAgQXBpSWQ6IHsgJ0ZuOjpHZXRBdHQnOiBbJ2Jhc2VBcGlDREE0RDQzQScsICdBcGlJZCddIH0sXG4gICAgfSk7XG4gIH0pO1xuXG59KTsiXX0=