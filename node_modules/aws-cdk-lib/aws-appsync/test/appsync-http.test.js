"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const sfn = require("../../aws-stepfunctions");
const cdk = require("../../core");
const appsync = require("../lib");
// GLOBAL GIVEN
let stack;
let api;
let endpoint;
beforeEach(() => {
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'baseApi', {
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
    });
    endpoint = 'aws.amazon.com';
});
describe('Http Data Source configuration', () => {
    test('default configuration produces name `HttpCDKDataSource`', () => {
        // WHEN
        api.addHttpDataSource('ds', endpoint);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            Name: 'ds',
        });
    });
    test('appsync configures name correctly', () => {
        // WHEN
        api.addHttpDataSource('ds', endpoint, {
            name: 'custom',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            Name: 'custom',
        });
    });
    test('appsync configures name and description correctly', () => {
        // WHEN
        api.addHttpDataSource('ds', endpoint, {
            name: 'custom',
            description: 'custom description',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            Name: 'custom',
            Description: 'custom description',
        });
    });
    test('appsync configures name, authorizationConfig correctly', () => {
        // WHEN
        api.addHttpDataSource('ds', endpoint, {
            name: 'custom',
            description: 'custom description',
            authorizationConfig: {
                signingRegion: 'us-east-1',
                signingServiceName: 'states',
            },
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            Name: 'custom',
            Description: 'custom description',
            HttpConfig: {
                Endpoint: endpoint,
                AuthorizationConfig: {
                    AuthorizationType: 'AWS_IAM',
                    AwsIamConfig: {
                        SigningRegion: 'us-east-1',
                        SigningServiceName: 'states',
                    },
                },
            },
        });
    });
    test('other aws resources can grant http data source', () => {
        // WHEN
        const machineArn = 'arn:aws:states:us-east-1::stateMachine:hello';
        const machine = sfn.StateMachine.fromStateMachineArn(stack, 'importedMachine', machineArn);
        const ds = api.addHttpDataSource('ds', endpoint, {
            name: 'custom',
            description: 'custom description',
            authorizationConfig: {
                signingRegion: 'us-east-1',
                signingServiceName: 'states',
            },
        });
        machine.grantRead(ds);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: [
                    {
                        Action: [
                            'states:ListExecutions',
                            'states:ListStateMachines',
                        ],
                        Effect: 'Allow',
                        Resource: machineArn,
                    },
                    {
                        Action: [
                            'states:DescribeExecution',
                            'states:DescribeStateMachineForExecution',
                            'states:GetExecutionHistory',
                        ],
                        Effect: 'Allow',
                        Resource: {
                            'Fn::Join': [
                                '',
                                [
                                    'arn:',
                                    {
                                        Ref: 'AWS::Partition',
                                    },
                                    ':states:',
                                    {
                                        Ref: 'AWS::Region',
                                    },
                                    ':',
                                    {
                                        Ref: 'AWS::AccountId',
                                    },
                                    ':execution:hello:*',
                                ],
                            ],
                        },
                    },
                    {
                        Action: [
                            'states:ListActivities',
                            'states:DescribeStateMachine',
                            'states:DescribeActivity',
                        ],
                        Effect: 'Allow',
                        Resource: '*',
                    },
                ],
                Version: '2012-10-17',
            },
        });
    });
    test('appsync errors when creating multiple http data sources with no configuration', () => {
        // THEN
        expect(() => {
            api.addHttpDataSource('ds', endpoint);
            api.addHttpDataSource('ds', endpoint);
        }).toThrow("There is already a Construct with name 'ds' in GraphqlApi [baseApi]");
    });
});
describe('adding http data source from imported api', () => {
    test('imported api can add HttpDataSource from id', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
        });
        importedApi.addHttpDataSource('ds', endpoint);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
    test('imported api can add HttpDataSource from attributes', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
            graphqlApiArn: api.arn,
        });
        importedApi.addHttpDataSource('ds', endpoint);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'HTTP',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1odHRwLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBzeW5jLWh0dHAudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3QixpREFBNEM7QUFDNUMsK0NBQStDO0FBQy9DLGtDQUFrQztBQUNsQyxrQ0FBa0M7QUFFbEMsZUFBZTtBQUNmLElBQUksS0FBZ0IsQ0FBQztBQUNyQixJQUFJLEdBQXVCLENBQUM7QUFDNUIsSUFBSSxRQUFnQixDQUFDO0FBQ3JCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEIsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFO1FBQzdDLElBQUksRUFBRSxLQUFLO1FBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDLENBQUM7S0FDbkYsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxHQUFHLGdCQUFnQixDQUFDO0FBQzlCLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtJQUU5QyxJQUFJLENBQUMseURBQXlELEVBQUUsR0FBRyxFQUFFO1FBQ25FLE9BQU87UUFDUCxHQUFHLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXRDLE9BQU87UUFDUCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQywwQkFBMEIsRUFBRTtZQUMxRSxJQUFJLEVBQUUsTUFBTTtZQUNaLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1FBQzdD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eEIsQ0FBQyxDQUFDO1FBQ0gsV0FBVyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUU5QyxPQUFPO1FBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsMEJBQTBCLEVBQUU7WUFDMUUsSUFBSSxFQUFFLE1BQU07WUFDWixLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsRUFBRTtTQUN0RCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7UUFDL0QsT0FBTztRQUNQLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsd0JBQXdCLENBQUMsS0FBSyxFQUFFLGFBQWEsRUFBRTtZQUNwRixZQUFZLEVBQUUsR0FBRyxDQUFDLEtBQUs7WUFDdkIsYUFBYSxFQUFFLEdBQUcsQ0FBQyxHQUFHO1NBQ3ZCLENBQUMsQ0FBQztRQUNILFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFOUMsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLDBCQUEwQixFQUFFO1lBQzFFLElBQUksRUFBRSxNQUFNO1lBQ1osS0FBSyxFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLEVBQUU7U0FDdEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgc2ZuIGZyb20gJy4uLy4uL2F3cy1zdGVwZnVuY3Rpb25zJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnLi4vbGliJztcblxuLy8gR0xPQkFMIEdJVkVOXG5sZXQgc3RhY2s6IGNkay5TdGFjaztcbmxldCBhcGk6IGFwcHN5bmMuR3JhcGhxbEFwaTtcbmxldCBlbmRwb2ludDogc3RyaW5nO1xuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICBhcGkgPSBuZXcgYXBwc3luYy5HcmFwaHFsQXBpKHN0YWNrLCAnYmFzZUFwaScsIHtcbiAgICBuYW1lOiAnYXBpJyxcbiAgICBzY2hlbWE6IGFwcHN5bmMuU2NoZW1hRmlsZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2FwcHN5bmMudGVzdC5ncmFwaHFsJykpLFxuICB9KTtcbiAgZW5kcG9pbnQgPSAnYXdzLmFtYXpvbi5jb20nO1xufSk7XG5cbmRlc2NyaWJlKCdIdHRwIERhdGEgU291cmNlIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG5cbiAgdGVzdCgnZGVmYXVsdCBjb25maWd1cmF0aW9uIHByb2R1Y2VzIG5hbWUgYEh0dHBDREtEYXRhU291cmNlYCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZEh0dHBEYXRhU291cmNlKCdkcycsIGVuZHBvaW50KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0hUVFAnLFxuICAgICAgTmFtZTogJ2RzJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXBwc3luYyBjb25maWd1cmVzIG5hbWUgY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBhcGkuYWRkSHR0cERhdGFTb3VyY2UoJ2RzJywgZW5kcG9pbnQsIHtcbiAgICAgIG5hbWU6ICdjdXN0b20nLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnSFRUUCcsXG4gICAgICBOYW1lOiAnY3VzdG9tJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXBwc3luYyBjb25maWd1cmVzIG5hbWUgYW5kIGRlc2NyaXB0aW9uIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZEh0dHBEYXRhU291cmNlKCdkcycsIGVuZHBvaW50LCB7XG4gICAgICBuYW1lOiAnY3VzdG9tJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0hUVFAnLFxuICAgICAgTmFtZTogJ2N1c3RvbScsXG4gICAgICBEZXNjcmlwdGlvbjogJ2N1c3RvbSBkZXNjcmlwdGlvbicsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FwcHN5bmMgY29uZmlndXJlcyBuYW1lLCBhdXRob3JpemF0aW9uQ29uZmlnIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZEh0dHBEYXRhU291cmNlKCdkcycsIGVuZHBvaW50LCB7XG4gICAgICBuYW1lOiAnY3VzdG9tJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICAgIGF1dGhvcml6YXRpb25Db25maWc6IHtcbiAgICAgICAgc2lnbmluZ1JlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICAgIHNpZ25pbmdTZXJ2aWNlTmFtZTogJ3N0YXRlcycsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnSFRUUCcsXG4gICAgICBOYW1lOiAnY3VzdG9tJyxcbiAgICAgIERlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICAgIEh0dHBDb25maWc6IHtcbiAgICAgICAgRW5kcG9pbnQ6IGVuZHBvaW50LFxuICAgICAgICBBdXRob3JpemF0aW9uQ29uZmlnOiB7XG4gICAgICAgICAgQXV0aG9yaXphdGlvblR5cGU6ICdBV1NfSUFNJyxcbiAgICAgICAgICBBd3NJYW1Db25maWc6IHtcbiAgICAgICAgICAgIFNpZ25pbmdSZWdpb246ICd1cy1lYXN0LTEnLFxuICAgICAgICAgICAgU2lnbmluZ1NlcnZpY2VOYW1lOiAnc3RhdGVzJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnb3RoZXIgYXdzIHJlc291cmNlcyBjYW4gZ3JhbnQgaHR0cCBkYXRhIHNvdXJjZScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgbWFjaGluZUFybiA9ICdhcm46YXdzOnN0YXRlczp1cy1lYXN0LTE6OnN0YXRlTWFjaGluZTpoZWxsbyc7XG4gICAgY29uc3QgbWFjaGluZSA9IHNmbi5TdGF0ZU1hY2hpbmUuZnJvbVN0YXRlTWFjaGluZUFybihzdGFjaywgJ2ltcG9ydGVkTWFjaGluZScsIG1hY2hpbmVBcm4pO1xuICAgIGNvbnN0IGRzID0gYXBpLmFkZEh0dHBEYXRhU291cmNlKCdkcycsIGVuZHBvaW50LCB7XG4gICAgICBuYW1lOiAnY3VzdG9tJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICAgIGF1dGhvcml6YXRpb25Db25maWc6IHtcbiAgICAgICAgc2lnbmluZ1JlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICAgIHNpZ25pbmdTZXJ2aWNlTmFtZTogJ3N0YXRlcycsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIG1hY2hpbmUuZ3JhbnRSZWFkKGRzKTtcblxuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uOiBbXG4gICAgICAgICAgICAgICdzdGF0ZXM6TGlzdEV4ZWN1dGlvbnMnLFxuICAgICAgICAgICAgICAnc3RhdGVzOkxpc3RTdGF0ZU1hY2hpbmVzJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICBSZXNvdXJjZTogbWFjaGluZUFybixcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICAgICAnc3RhdGVzOkRlc2NyaWJlRXhlY3V0aW9uJyxcbiAgICAgICAgICAgICAgJ3N0YXRlczpEZXNjcmliZVN0YXRlTWFjaGluZUZvckV4ZWN1dGlvbicsXG4gICAgICAgICAgICAgICdzdGF0ZXM6R2V0RXhlY3V0aW9uSGlzdG9yeScsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICc6c3RhdGVzOicsXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6UmVnaW9uJyxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAnOicsXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6QWNjb3VudElkJyxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAnOmV4ZWN1dGlvbjpoZWxsbzoqJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICAgICAnc3RhdGVzOkxpc3RBY3Rpdml0aWVzJyxcbiAgICAgICAgICAgICAgJ3N0YXRlczpEZXNjcmliZVN0YXRlTWFjaGluZScsXG4gICAgICAgICAgICAgICdzdGF0ZXM6RGVzY3JpYmVBY3Rpdml0eScsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6ICcqJyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGVycm9ycyB3aGVuIGNyZWF0aW5nIG11bHRpcGxlIGh0dHAgZGF0YSBzb3VyY2VzIHdpdGggbm8gY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIGFwaS5hZGRIdHRwRGF0YVNvdXJjZSgnZHMnLCBlbmRwb2ludCk7XG4gICAgICBhcGkuYWRkSHR0cERhdGFTb3VyY2UoJ2RzJywgZW5kcG9pbnQpO1xuICAgIH0pLnRvVGhyb3coXCJUaGVyZSBpcyBhbHJlYWR5IGEgQ29uc3RydWN0IHdpdGggbmFtZSAnZHMnIGluIEdyYXBocWxBcGkgW2Jhc2VBcGldXCIpO1xuICB9KTtcblxufSk7XG5cbmRlc2NyaWJlKCdhZGRpbmcgaHR0cCBkYXRhIHNvdXJjZSBmcm9tIGltcG9ydGVkIGFwaScsICgpID0+IHtcbiAgdGVzdCgnaW1wb3J0ZWQgYXBpIGNhbiBhZGQgSHR0cERhdGFTb3VyY2UgZnJvbSBpZCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgaW1wb3J0ZWRBcGkgPSBhcHBzeW5jLkdyYXBocWxBcGkuZnJvbUdyYXBocWxBcGlBdHRyaWJ1dGVzKHN0YWNrLCAnaW1wb3J0ZWRBcGknLCB7XG4gICAgICBncmFwaHFsQXBpSWQ6IGFwaS5hcGlJZCxcbiAgICB9KTtcbiAgICBpbXBvcnRlZEFwaS5hZGRIdHRwRGF0YVNvdXJjZSgnZHMnLCBlbmRwb2ludCk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdIVFRQJyxcbiAgICAgIEFwaUlkOiB7ICdGbjo6R2V0QXR0JzogWydiYXNlQXBpQ0RBNEQ0M0EnLCAnQXBpSWQnXSB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdpbXBvcnRlZCBhcGkgY2FuIGFkZCBIdHRwRGF0YVNvdXJjZSBmcm9tIGF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGltcG9ydGVkQXBpID0gYXBwc3luYy5HcmFwaHFsQXBpLmZyb21HcmFwaHFsQXBpQXR0cmlidXRlcyhzdGFjaywgJ2ltcG9ydGVkQXBpJywge1xuICAgICAgZ3JhcGhxbEFwaUlkOiBhcGkuYXBpSWQsXG4gICAgICBncmFwaHFsQXBpQXJuOiBhcGkuYXJuLFxuICAgIH0pO1xuICAgIGltcG9ydGVkQXBpLmFkZEh0dHBEYXRhU291cmNlKCdkcycsIGVuZHBvaW50KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0hUVFAnLFxuICAgICAgQXBpSWQ6IHsgJ0ZuOjpHZXRBdHQnOiBbJ2Jhc2VBcGlDREE0RDQzQScsICdBcGlJZCddIH0sXG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=