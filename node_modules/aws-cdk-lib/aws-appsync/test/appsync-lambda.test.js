"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const lambda = require("../../aws-lambda");
const cdk = require("../../core");
const appsync = require("../lib");
// GLOBAL GIVEN
let stack;
let api;
beforeEach(() => {
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'baseApi', {
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
    });
});
describe('Lambda Data Source configuration', () => {
    // GIVEN
    let func;
    beforeEach(() => {
        func = new lambda.Function(stack, 'func', {
            code: lambda.Code.fromAsset(path.join(__dirname, 'verify/iam-query')),
            handler: 'iam-query.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
        });
    });
    test('default configuration produces name `TableCDKDataSource`', () => {
        // WHEN
        api.addLambdaDataSource('ds', func);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            Name: 'ds',
        });
    });
    test('appsync configures name correctly', () => {
        // WHEN
        api.addLambdaDataSource('ds', func, {
            name: 'custom',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            Name: 'custom',
        });
    });
    test('appsync configures name and description correctly', () => {
        // WHEN
        api.addLambdaDataSource('ds', func, {
            name: 'custom',
            description: 'custom description',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            Name: 'custom',
            Description: 'custom description',
        });
    });
    test('appsync sanitized datasource name from unsupported characters', () => {
        const badCharacters = [...'!@#$%^&*()+-=[]{}\\|;:\'",<>?/'];
        badCharacters.forEach((badCharacter) => {
            // WHEN
            const newStack = new cdk.Stack();
            const graphqlapi = new appsync.GraphqlApi(newStack, 'baseApi', {
                name: 'api',
                schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
            });
            const dummyFunction = new lambda.Function(newStack, 'func', {
                code: lambda.Code.fromAsset(path.join(__dirname, 'verify/iam-query')),
                handler: 'iam-query.handler',
                runtime: lambda.Runtime.NODEJS_14_X,
            });
            graphqlapi.addLambdaDataSource(`data-${badCharacter}-source`, dummyFunction);
            // THEN
            assertions_1.Template.fromStack(newStack).hasResourceProperties('AWS::AppSync::DataSource', {
                Type: 'AWS_LAMBDA',
                Name: 'datasource',
            });
        });
    });
    test('appsync leaves underscore untouched in datasource name', () => {
        // WHEN
        api.addLambdaDataSource('data_source', func);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            Name: 'data_source',
        });
    });
    test('appsync errors when creating multiple lambda data sources with no configuration', () => {
        // THEN
        expect(() => {
            api.addLambdaDataSource('ds', func);
            api.addLambdaDataSource('ds', func);
        }).toThrow("There is already a Construct with name 'ds' in GraphqlApi [baseApi]");
    });
    test('lambda data sources dont require mapping templates', () => {
        // WHEN
        const ds = api.addLambdaDataSource('ds', func, {
            name: 'custom',
            description: 'custom description',
        });
        ds.createResolver('TestField', {
            typeName: 'test',
            fieldName: 'field',
        });
        // THEN
        assertions_1.Template.fromStack(stack).resourceCountIs('AWS::AppSync::Resolver', 1);
    });
});
describe('adding lambda data source from imported api', () => {
    let func;
    beforeEach(() => {
        func = new lambda.Function(stack, 'func', {
            code: lambda.Code.fromAsset(path.join(__dirname, 'verify/iam-query')),
            handler: 'iam-query.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
        });
    });
    test('imported api can add LambdaDbDataSource from id', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
        });
        importedApi.addLambdaDataSource('ds', func);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
    test('imported api can add LambdaDataSource from attributes', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
            graphqlApiArn: api.arn,
        });
        importedApi.addLambdaDataSource('ds', func);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'AWS_LAMBDA',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1sYW1iZGEudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcHN5bmMtbGFtYmRhLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsaURBQTRDO0FBQzVDLDJDQUEyQztBQUMzQyxrQ0FBa0M7QUFDbEMsa0NBQWtDO0FBRWxDLGVBQWU7QUFDZixJQUFJLEtBQWdCLENBQUM7QUFDckIsSUFBSSxHQUF1QixDQUFDO0FBQzVCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEIsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFO1FBQzdDLElBQUksRUFBRSxLQUFLO1FBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDLENBQUM7S0FDbkYsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO0lBQ2hELFFBQVE7SUFDUixJQUFJLElBQXFCLENBQUM7SUFDMUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtZQUN4QyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztZQUNyRSxPQUFPLEVBQUUsbUJBQW1CO1lBQzVCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7U0FDcEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsMERBQTBELEVBQUUsR0FB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RTVDLE9BQU87UUFDUCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQywwQkFBMEIsRUFBRTtZQUMxRSxJQUFJLEVBQUUsWUFBWTtZQUNsQixLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsRUFBRTtTQUN0RCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnLi4vLi4vYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gJy4uL2xpYic7XG5cbi8vIEdMT0JBTCBHSVZFTlxubGV0IHN0YWNrOiBjZGsuU3RhY2s7XG5sZXQgYXBpOiBhcHBzeW5jLkdyYXBocWxBcGk7XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gIGFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICdiYXNlQXBpJywge1xuICAgIG5hbWU6ICdhcGknLFxuICAgIHNjaGVtYTogYXBwc3luYy5TY2hlbWFGaWxlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy50ZXN0LmdyYXBocWwnKSksXG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdMYW1iZGEgRGF0YSBTb3VyY2UgY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbGV0IGZ1bmM6IGxhbWJkYS5GdW5jdGlvbjtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZnVuYyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdmdW5jJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICd2ZXJpZnkvaWFtLXF1ZXJ5JykpLFxuICAgICAgaGFuZGxlcjogJ2lhbS1xdWVyeS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdkZWZhdWx0IGNvbmZpZ3VyYXRpb24gcHJvZHVjZXMgbmFtZSBgVGFibGVDREtEYXRhU291cmNlYCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ2RzJywgZnVuYyk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdBV1NfTEFNQkRBJyxcbiAgICAgIE5hbWU6ICdkcycsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FwcHN5bmMgY29uZmlndXJlcyBuYW1lIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ2RzJywgZnVuYywge1xuICAgICAgbmFtZTogJ2N1c3RvbScsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdBV1NfTEFNQkRBJyxcbiAgICAgIE5hbWU6ICdjdXN0b20nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGNvbmZpZ3VyZXMgbmFtZSBhbmQgZGVzY3JpcHRpb24gY29ycmVjdGx5JywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZSgnZHMnLCBmdW5jLCB7XG4gICAgICBuYW1lOiAnY3VzdG9tJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgVHlwZTogJ0FXU19MQU1CREEnLFxuICAgICAgTmFtZTogJ2N1c3RvbScsXG4gICAgICBEZXNjcmlwdGlvbjogJ2N1c3RvbSBkZXNjcmlwdGlvbicsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FwcHN5bmMgc2FuaXRpemVkIGRhdGFzb3VyY2UgbmFtZSBmcm9tIHVuc3VwcG9ydGVkIGNoYXJhY3RlcnMnLCAoKSA9PiB7XG4gICAgY29uc3QgYmFkQ2hhcmFjdGVycyA9IFsuLi4nIUAjJCVeJiooKSstPVtde31cXFxcfDs6XFwnXCIsPD4/LyddO1xuXG4gICAgYmFkQ2hhcmFjdGVycy5mb3JFYWNoKChiYWRDaGFyYWN0ZXIpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IG5ld1N0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgICAgY29uc3QgZ3JhcGhxbGFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkobmV3U3RhY2ssICdiYXNlQXBpJywge1xuICAgICAgICBuYW1lOiAnYXBpJyxcbiAgICAgICAgc2NoZW1hOiBhcHBzeW5jLlNjaGVtYUZpbGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdhcHBzeW5jLnRlc3QuZ3JhcGhxbCcpKSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZHVtbXlGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24obmV3U3RhY2ssICdmdW5jJywge1xuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ3ZlcmlmeS9pYW0tcXVlcnknKSksXG4gICAgICAgIGhhbmRsZXI6ICdpYW0tcXVlcnkuaGFuZGxlcicsXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgfSk7XG4gICAgICBncmFwaHFsYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoYGRhdGEtJHtiYWRDaGFyYWN0ZXJ9LXNvdXJjZWAsIGR1bW15RnVuY3Rpb24pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBUZW1wbGF0ZS5mcm9tU3RhY2sobmV3U3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEYXRhU291cmNlJywge1xuICAgICAgICBUeXBlOiAnQVdTX0xBTUJEQScsXG4gICAgICAgIE5hbWU6ICdkYXRhc291cmNlJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGxlYXZlcyB1bmRlcnNjb3JlIHVudG91Y2hlZCBpbiBkYXRhc291cmNlIG5hbWUnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGFwaS5hZGRMYW1iZGFEYXRhU291cmNlKCdkYXRhX3NvdXJjZScsIGZ1bmMpO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnQVdTX0xBTUJEQScsXG4gICAgICBOYW1lOiAnZGF0YV9zb3VyY2UnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGVycm9ycyB3aGVuIGNyZWF0aW5nIG11bHRpcGxlIGxhbWJkYSBkYXRhIHNvdXJjZXMgd2l0aCBubyBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgIC8vIFRIRU5cbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ2RzJywgZnVuYyk7XG4gICAgICBhcGkuYWRkTGFtYmRhRGF0YVNvdXJjZSgnZHMnLCBmdW5jKTtcbiAgICB9KS50b1Rocm93KFwiVGhlcmUgaXMgYWxyZWFkeSBhIENvbnN0cnVjdCB3aXRoIG5hbWUgJ2RzJyBpbiBHcmFwaHFsQXBpIFtiYXNlQXBpXVwiKTtcbiAgfSk7XG5cbiAgdGVzdCgnbGFtYmRhIGRhdGEgc291cmNlcyBkb250IHJlcXVpcmUgbWFwcGluZyB0ZW1wbGF0ZXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGRzID0gYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ2RzJywgZnVuYywge1xuICAgICAgbmFtZTogJ2N1c3RvbScsXG4gICAgICBkZXNjcmlwdGlvbjogJ2N1c3RvbSBkZXNjcmlwdGlvbicsXG4gICAgfSk7XG5cbiAgICBkcy5jcmVhdGVSZXNvbHZlcignVGVzdEZpZWxkJywge1xuICAgICAgdHlwZU5hbWU6ICd0ZXN0JyxcbiAgICAgIGZpZWxkTmFtZTogJ2ZpZWxkJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnJlc291cmNlQ291bnRJcygnQVdTOjpBcHBTeW5jOjpSZXNvbHZlcicsIDEpO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnYWRkaW5nIGxhbWJkYSBkYXRhIHNvdXJjZSBmcm9tIGltcG9ydGVkIGFwaScsICgpID0+IHtcbiAgbGV0IGZ1bmM6IGxhbWJkYS5GdW5jdGlvbjtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZnVuYyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdmdW5jJywge1xuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICd2ZXJpZnkvaWFtLXF1ZXJ5JykpLFxuICAgICAgaGFuZGxlcjogJ2lhbS1xdWVyeS5oYW5kbGVyJyxcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdpbXBvcnRlZCBhcGkgY2FuIGFkZCBMYW1iZGFEYkRhdGFTb3VyY2UgZnJvbSBpZCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgaW1wb3J0ZWRBcGkgPSBhcHBzeW5jLkdyYXBocWxBcGkuZnJvbUdyYXBocWxBcGlBdHRyaWJ1dGVzKHN0YWNrLCAnaW1wb3J0ZWRBcGknLCB7XG4gICAgICBncmFwaHFsQXBpSWQ6IGFwaS5hcGlJZCxcbiAgICB9KTtcbiAgICBpbXBvcnRlZEFwaS5hZGRMYW1iZGFEYXRhU291cmNlKCdkcycsIGZ1bmMpO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnQVdTX0xBTUJEQScsXG4gICAgICBBcGlJZDogeyAnRm46OkdldEF0dCc6IFsnYmFzZUFwaUNEQTRENDNBJywgJ0FwaUlkJ10gfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnaW1wb3J0ZWQgYXBpIGNhbiBhZGQgTGFtYmRhRGF0YVNvdXJjZSBmcm9tIGF0dHJpYnV0ZXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGltcG9ydGVkQXBpID0gYXBwc3luYy5HcmFwaHFsQXBpLmZyb21HcmFwaHFsQXBpQXR0cmlidXRlcyhzdGFjaywgJ2ltcG9ydGVkQXBpJywge1xuICAgICAgZ3JhcGhxbEFwaUlkOiBhcGkuYXBpSWQsXG4gICAgICBncmFwaHFsQXBpQXJuOiBhcGkuYXJuLFxuICAgIH0pO1xuICAgIGltcG9ydGVkQXBpLmFkZExhbWJkYURhdGFTb3VyY2UoJ2RzJywgZnVuYyk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdBV1NfTEFNQkRBJyxcbiAgICAgIEFwaUlkOiB7ICdGbjo6R2V0QXR0JzogWydiYXNlQXBpQ0RBNEQ0M0EnLCAnQXBpSWQnXSB9LFxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19