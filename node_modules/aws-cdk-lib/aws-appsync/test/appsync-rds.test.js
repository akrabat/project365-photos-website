"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const aws_ec2_1 = require("../../aws-ec2");
const aws_rds_1 = require("../../aws-rds");
const cdk = require("../../core");
const appsync = require("../lib");
// GLOBAL GIVEN
let stack;
let api;
beforeEach(() => {
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'baseApi', {
        name: 'api',
        schema: new appsync.SchemaFile({
            filePath: path.join(__dirname, 'appsync.test.graphql'),
        }),
    });
});
describe('Rds Data Source configuration', () => {
    // GIVEN
    let secret;
    let cluster;
    beforeEach(() => {
        const vpc = new aws_ec2_1.Vpc(stack, 'Vpc', { maxAzs: 2 });
        const securityGroup = new aws_ec2_1.SecurityGroup(stack, 'AuroraSecurityGroup', {
            vpc,
            allowAllOutbound: true,
        });
        secret = new aws_rds_1.DatabaseSecret(stack, 'AuroraSecret', {
            username: 'clusteradmin',
        });
        cluster = new aws_rds_1.ServerlessCluster(stack, 'AuroraCluster', {
            engine: aws_rds_1.DatabaseClusterEngine.auroraMysql({ version: aws_rds_1.AuroraMysqlEngineVersion.VER_2_07_1 }),
            credentials: { username: 'clusteradmin' },
            clusterIdentifier: 'db-endpoint-test',
            vpc,
            vpcSubnets: { subnetType: aws_ec2_1.SubnetType.PRIVATE_WITH_EGRESS },
            securityGroups: [securityGroup],
            defaultDatabaseName: 'Animals',
        });
    });
    test('appsync creates correct policy', () => {
        // WHEN
        api.addRdsDataSource('ds', cluster, secret);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Version: '2012-10-17',
                Statement: [{
                        Action: [
                            'secretsmanager:GetSecretValue',
                            'secretsmanager:DescribeSecret',
                        ],
                        Effect: 'Allow',
                        Resource: { Ref: 'AuroraSecret41E6E877' },
                    },
                    {
                        Action: [
                            'rds-data:BatchExecuteStatement',
                            'rds-data:BeginTransaction',
                            'rds-data:CommitTransaction',
                            'rds-data:ExecuteStatement',
                            'rds-data:RollbackTransaction',
                        ],
                        Effect: 'Allow',
                        Resource: '*',
                    },
                    {
                        Action: [
                            'secretsmanager:GetSecretValue',
                            'secretsmanager:DescribeSecret',
                        ],
                        Effect: 'Allow',
                        Resource: { Ref: 'AuroraClusterSecretAttachmentDB8032DA' },
                    },
                    {
                        Action: [
                            'rds-data:DeleteItems',
                            'rds-data:ExecuteSql',
                            'rds-data:GetItems',
                            'rds-data:InsertItems',
                            'rds-data:UpdateItems',
                        ],
                        Effect: 'Allow',
                        Resource: [{
                                'Fn::Join': ['', ['arn:',
                                        { Ref: 'AWS::Partition' },
                                        ':rds:',
                                        { Ref: 'AWS::Region' },
                                        ':',
                                        { Ref: 'AWS::AccountId' },
                                        ':cluster:',
                                        { Ref: 'AuroraCluster23D869C0' }]],
                            },
                            {
                                'Fn::Join': ['', ['arn:',
                                        { Ref: 'AWS::Partition' },
                                        ':rds:',
                                        { Ref: 'AWS::Region' },
                                        ':',
                                        { Ref: 'AWS::AccountId' },
                                        ':cluster:',
                                        { Ref: 'AuroraCluster23D869C0' },
                                        ':*']],
                            }],
                    }],
            },
        });
    });
    test('rds cluster arn saved to RdsHttpEndpointConfig', () => {
        // WHEN
        api.addRdsDataSource('ds', cluster, secret);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            RelationalDatabaseConfig: {
                RdsHttpEndpointConfig: {
                    AwsRegion: { Ref: 'AWS::Region' },
                    AwsSecretStoreArn: { Ref: 'AuroraSecret41E6E877' },
                    DbClusterIdentifier: {
                        'Fn::Join': ['', ['arn:',
                                { Ref: 'AWS::Partition' },
                                ':rds:',
                                { Ref: 'AWS::Region' },
                                ':',
                                { Ref: 'AWS::AccountId' },
                                ':cluster:',
                                { Ref: 'AuroraCluster23D869C0' }]],
                    },
                },
            },
        });
    });
    test('databaseName saved to RdsHttpEndpointConfig', () => {
        // WHEN
        const testDatabaseName = 'testDatabaseName';
        api.addRdsDataSource('ds', cluster, secret, testDatabaseName);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            RelationalDatabaseConfig: {
                RdsHttpEndpointConfig: {
                    AwsRegion: { Ref: 'AWS::Region' },
                    AwsSecretStoreArn: { Ref: 'AuroraSecret41E6E877' },
                    DbClusterIdentifier: {
                        'Fn::Join': ['', ['arn:',
                                { Ref: 'AWS::Partition' },
                                ':rds:',
                                { Ref: 'AWS::Region' },
                                ':',
                                { Ref: 'AWS::AccountId' },
                                ':cluster:',
                                { Ref: 'AuroraCluster23D869C0' }]],
                    },
                    DatabaseName: testDatabaseName,
                },
            },
        });
    });
    test('default configuration produces name identical to the id', () => {
        // WHEN
        api.addRdsDataSource('ds', cluster, secret);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            Name: 'ds',
        });
    });
    test('appsync configures name correctly', () => {
        // WHEN
        api.addRdsDataSource('ds', cluster, secret, undefined, {
            name: 'custom',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            Name: 'custom',
        });
    });
    test('appsync configures name and description correctly', () => {
        // WHEN
        api.addRdsDataSource('ds', cluster, secret, undefined, {
            name: 'custom',
            description: 'custom description',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            Name: 'custom',
            Description: 'custom description',
        });
    });
    test('appsync errors when creating multiple rds data sources with no configuration', () => {
        // WHEN
        const when = () => {
            api.addRdsDataSource('ds', cluster, secret);
            api.addRdsDataSource('ds', cluster, secret);
        };
        // THEN
        expect(when).toThrow('There is already a Construct with name \'ds\' in GraphqlApi [baseApi]');
    });
});
describe('adding rds data source from imported api', () => {
    // GIVEN
    let secret;
    let cluster;
    beforeEach(() => {
        const vpc = new aws_ec2_1.Vpc(stack, 'Vpc', { maxAzs: 2 });
        const securityGroup = new aws_ec2_1.SecurityGroup(stack, 'AuroraSecurityGroup', {
            vpc,
            allowAllOutbound: true,
        });
        secret = new aws_rds_1.DatabaseSecret(stack, 'AuroraSecret', {
            username: 'clusteradmin',
        });
        cluster = new aws_rds_1.ServerlessCluster(stack, 'AuroraCluster', {
            engine: aws_rds_1.DatabaseClusterEngine.auroraMysql({ version: aws_rds_1.AuroraMysqlEngineVersion.VER_2_07_1 }),
            credentials: { username: 'clusteradmin' },
            clusterIdentifier: 'db-endpoint-test',
            vpc,
            vpcSubnets: { subnetType: aws_ec2_1.SubnetType.PRIVATE_WITH_EGRESS },
            securityGroups: [securityGroup],
            defaultDatabaseName: 'Animals',
        });
    });
    test('imported api can add RdsDbDataSource from id', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
        });
        importedApi.addRdsDataSource('ds', cluster, secret);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
    test('imported api can add RdsDataSource from attributes', () => {
        // WHEN
        const importedApi = appsync.GraphqlApi.fromGraphqlApiAttributes(stack, 'importedApi', {
            graphqlApiId: api.apiId,
            graphqlApiArn: api.arn,
        });
        importedApi.addRdsDataSource('ds', cluster, secret);
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DataSource', {
            Type: 'RELATIONAL_DATABASE',
            ApiId: { 'Fn::GetAtt': ['baseApiCDA4D43A', 'ApiId'] },
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy1yZHMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcHN5bmMtcmRzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsaURBQTRDO0FBQzVDLDJDQUErRDtBQUMvRCwyQ0FBbUg7QUFDbkgsa0NBQWtDO0FBQ2xDLGtDQUFrQztBQUVsQyxlQUFlO0FBQ2YsSUFBSSxLQUFnQixDQUFDO0FBQ3JCLElBQUksR0FBdUIsQ0FBQztBQUM1QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hCLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtRQUM3QyxJQUFJLEVBQUUsS0FBSztRQUNYLE1BQU0sRUFBRSxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUM7WUFDN0IsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLHNCQUFzQixDQUFDO1NBQ3ZELENBQUM7S0FDSCxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7SUFDN0MsUUFBUTtJQUNSLElBQUksTUFBc0IsQ0FBQztJQUMzQixJQUFJLE9BQTBCLENBQUM7SUFDL0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE1BQU0sR0FBRyxHQUFHLElBQUksYUFBRyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqRCxNQUFNLGFBQWEsR0FBRyxJQUFJLHVCQUFhLENBQUMsS0FBSyxFQUFFLHFCQUFxQixFQUFFO1lBQ3BFLEdBQUc7WUFDSCxnQkFBZ0IsRUFBRSxJQUFJO1NBQ3ZCLENBQUMsQ0FBQztRQUNILE1BQU0sR0FBRyxJQUFJLHdCQUFjLENBQUMsS0FBSyxFQUFF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QUUsT0FBTyxDQUFDLEVBQUU7U0FDdEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsb0RBQW9ELEVBQUUsR0FBRyxFQUFFO1FBQzlELE9BQU87UUFDUCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7WUFDcEYsWUFBWSxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ3ZCLGFBQWEsRUFBRSxHQUFHLENBQUMsR0FBRztTQUN2QixDQUFDLENBQUM7UUFDSCxXQUFXLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUVwRCxPQUFPO1FBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsMEJBQTBCLEVBQUU7WUFDMUUsSUFBSSxFQUFFLHFCQUFxQjtZQUMzQixLQUFLLEVBQUUsRUFBRSxZQUFZLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxPQUFPLENBQUMsRUFBRTtTQUN0RCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgeyBWcGMsIFNlY3VyaXR5R3JvdXAsIFN1Ym5ldFR5cGUgfSBmcm9tICcuLi8uLi9hd3MtZWMyJztcbmltcG9ydCB7IERhdGFiYXNlU2VjcmV0LCBEYXRhYmFzZUNsdXN0ZXJFbmdpbmUsIEF1cm9yYU15c3FsRW5naW5lVmVyc2lvbiwgU2VydmVybGVzc0NsdXN0ZXIgfSBmcm9tICcuLi8uLi9hd3MtcmRzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnLi4vbGliJztcblxuLy8gR0xPQkFMIEdJVkVOXG5sZXQgc3RhY2s6IGNkay5TdGFjaztcbmxldCBhcGk6IGFwcHN5bmMuR3JhcGhxbEFwaTtcbmJlZm9yZUVhY2goKCkgPT4ge1xuICBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgYXBpID0gbmV3IGFwcHN5bmMuR3JhcGhxbEFwaShzdGFjaywgJ2Jhc2VBcGknLCB7XG4gICAgbmFtZTogJ2FwaScsXG4gICAgc2NoZW1hOiBuZXcgYXBwc3luYy5TY2hlbWFGaWxlKHtcbiAgICAgIGZpbGVQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy50ZXN0LmdyYXBocWwnKSxcbiAgICB9KSxcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ1JkcyBEYXRhIFNvdXJjZSBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBsZXQgc2VjcmV0OiBEYXRhYmFzZVNlY3JldDtcbiAgbGV0IGNsdXN0ZXI6IFNlcnZlcmxlc3NDbHVzdGVyO1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb25zdCB2cGMgPSBuZXcgVnBjKHN0YWNrLCAnVnBjJywgeyBtYXhBenM6IDIgfSk7XG4gICAgY29uc3Qgc2VjdXJpdHlHcm91cCA9IG5ldyBTZWN1cml0eUdyb3VwKHN0YWNrLCAnQXVyb3JhU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYyxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWUsXG4gICAgfSk7XG4gICAgc2VjcmV0ID0gbmV3IERhdGFiYXNlU2VjcmV0KHN0YWNrLCAnQXVyb3JhU2VjcmV0Jywge1xuICAgICAgdXNlcm5hbWU6ICdjbHVzdGVyYWRtaW4nLFxuICAgIH0pO1xuICAgIGNsdXN0ZXIgPSBuZXcgU2VydmVybGVzc0NsdXN0ZXIoc3RhY2ssICdBdXJvcmFDbHVzdGVyJywge1xuICAgICAgZW5naW5lOiBEYXRhYmFzZUNsdXN0ZXJFbmdpbmUuYXVyb3JhTXlzcWwoeyB2ZXJzaW9uOiBBdXJvcmFNeXNxbEVuZ2luZVZlcnNpb24uVkVSXzJfMDdfMSB9KSxcbiAgICAgIGNyZWRlbnRpYWxzOiB7IHVzZXJuYW1lOiAnY2x1c3RlcmFkbWluJyB9LFxuICAgICAgY2x1c3RlcklkZW50aWZpZXI6ICdkYi1lbmRwb2ludC10ZXN0JyxcbiAgICAgIHZwYyxcbiAgICAgIHZwY1N1Ym5ldHM6IHsgc3VibmV0VHlwZTogU3VibmV0VHlwZS5QUklWQVRFX1dJVEhfRUdSRVNTIH0sXG4gICAgICBzZWN1cml0eUdyb3VwczogW3NlY3VyaXR5R3JvdXBdLFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogJ0FuaW1hbHMnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhcHBzeW5jIGNyZWF0ZXMgY29ycmVjdCBwb2xpY3knLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGFwaS5hZGRSZHNEYXRhU291cmNlKCdkcycsIGNsdXN0ZXIsIHNlY3JldCk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICAgIFN0YXRlbWVudDogW3tcbiAgICAgICAgICBBY3Rpb246IFtcbiAgICAgICAgICAgICdzZWNyZXRzbWFuYWdlcjpHZXRTZWNyZXRWYWx1ZScsXG4gICAgICAgICAgICAnc2VjcmV0c21hbmFnZXI6RGVzY3JpYmVTZWNyZXQnLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiB7IFJlZjogJ0F1cm9yYVNlY3JldDQxRTZFODc3JyB9LFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgQWN0aW9uOiBbXG4gICAgICAgICAgICAncmRzLWRhdGE6QmF0Y2hFeGVjdXRlU3RhdGVtZW50JyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpCZWdpblRyYW5zYWN0aW9uJyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpDb21taXRUcmFuc2FjdGlvbicsXG4gICAgICAgICAgICAncmRzLWRhdGE6RXhlY3V0ZVN0YXRlbWVudCcsXG4gICAgICAgICAgICAncmRzLWRhdGE6Um9sbGJhY2tUcmFuc2FjdGlvbicsXG4gICAgICAgICAgXSxcbiAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgUmVzb3VyY2U6ICcqJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICAgJ3NlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlJyxcbiAgICAgICAgICAgICdzZWNyZXRzbWFuYWdlcjpEZXNjcmliZVNlY3JldCcsXG4gICAgICAgICAgXSxcbiAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgUmVzb3VyY2U6IHsgUmVmOiAnQXVyb3JhQ2x1c3RlclNlY3JldEF0dGFjaG1lbnREQjgwMzJEQScgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICAgJ3Jkcy1kYXRhOkRlbGV0ZUl0ZW1zJyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpFeGVjdXRlU3FsJyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpHZXRJdGVtcycsXG4gICAgICAgICAgICAncmRzLWRhdGE6SW5zZXJ0SXRlbXMnLFxuICAgICAgICAgICAgJ3Jkcy1kYXRhOlVwZGF0ZUl0ZW1zJyxcbiAgICAgICAgICBdLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZTogW3tcbiAgICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgWydhcm46JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgICAgJzpyZHM6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAgICAgICAnOmNsdXN0ZXI6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBdXJvcmFDbHVzdGVyMjNEODY5QzAnIH1dXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgWydhcm46JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgICAgJzpyZHM6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAgICAgICAnOmNsdXN0ZXI6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBdXJvcmFDbHVzdGVyMjNEODY5QzAnIH0sXG4gICAgICAgICAgICAgICc6KiddXSxcbiAgICAgICAgICB9XSxcbiAgICAgICAgfV0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdyZHMgY2x1c3RlciBhcm4gc2F2ZWQgdG8gUmRzSHR0cEVuZHBvaW50Q29uZmlnJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBhcGkuYWRkUmRzRGF0YVNvdXJjZSgnZHMnLCBjbHVzdGVyLCBzZWNyZXQpO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnUkVMQVRJT05BTF9EQVRBQkFTRScsXG4gICAgICBSZWxhdGlvbmFsRGF0YWJhc2VDb25maWc6IHtcbiAgICAgICAgUmRzSHR0cEVuZHBvaW50Q29uZmlnOiB7XG4gICAgICAgICAgQXdzUmVnaW9uOiB7IFJlZjogJ0FXUzo6UmVnaW9uJyB9LFxuICAgICAgICAgIEF3c1NlY3JldFN0b3JlQXJuOiB7IFJlZjogJ0F1cm9yYVNlY3JldDQxRTZFODc3JyB9LFxuICAgICAgICAgIERiQ2x1c3RlcklkZW50aWZpZXI6IHtcbiAgICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgWydhcm46JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgICAgJzpyZHM6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAgICAgICAnOmNsdXN0ZXI6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBdXJvcmFDbHVzdGVyMjNEODY5QzAnIH1dXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZGF0YWJhc2VOYW1lIHNhdmVkIHRvIFJkc0h0dHBFbmRwb2ludENvbmZpZycsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGVzdERhdGFiYXNlTmFtZSA9ICd0ZXN0RGF0YWJhc2VOYW1lJztcbiAgICBhcGkuYWRkUmRzRGF0YVNvdXJjZSgnZHMnLCBjbHVzdGVyLCBzZWNyZXQsIHRlc3REYXRhYmFzZU5hbWUpO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnUkVMQVRJT05BTF9EQVRBQkFTRScsXG4gICAgICBSZWxhdGlvbmFsRGF0YWJhc2VDb25maWc6IHtcbiAgICAgICAgUmRzSHR0cEVuZHBvaW50Q29uZmlnOiB7XG4gICAgICAgICAgQXdzUmVnaW9uOiB7IFJlZjogJ0FXUzo6UmVnaW9uJyB9LFxuICAgICAgICAgIEF3c1NlY3JldFN0b3JlQXJuOiB7IFJlZjogJ0F1cm9yYVNlY3JldDQxRTZFODc3JyB9LFxuICAgICAgICAgIERiQ2x1c3RlcklkZW50aWZpZXI6IHtcbiAgICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgWydhcm46JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgICAgJzpyZHM6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAgICAgICAnOmNsdXN0ZXI6JyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdBdXJvcmFDbHVzdGVyMjNEODY5QzAnIH1dXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIERhdGFiYXNlTmFtZTogdGVzdERhdGFiYXNlTmFtZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RlZmF1bHQgY29uZmlndXJhdGlvbiBwcm9kdWNlcyBuYW1lIGlkZW50aWNhbCB0byB0aGUgaWQnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGFwaS5hZGRSZHNEYXRhU291cmNlKCdkcycsIGNsdXN0ZXIsIHNlY3JldCk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdSRUxBVElPTkFMX0RBVEFCQVNFJyxcbiAgICAgIE5hbWU6ICdkcycsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FwcHN5bmMgY29uZmlndXJlcyBuYW1lIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZFJkc0RhdGFTb3VyY2UoJ2RzJywgY2x1c3Rlciwgc2VjcmV0LCB1bmRlZmluZWQsIHtcbiAgICAgIG5hbWU6ICdjdXN0b20nLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnUkVMQVRJT05BTF9EQVRBQkFTRScsXG4gICAgICBOYW1lOiAnY3VzdG9tJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXBwc3luYyBjb25maWd1cmVzIG5hbWUgYW5kIGRlc2NyaXB0aW9uIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgYXBpLmFkZFJkc0RhdGFTb3VyY2UoJ2RzJywgY2x1c3Rlciwgc2VjcmV0LCB1bmRlZmluZWQsIHtcbiAgICAgIG5hbWU6ICdjdXN0b20nLFxuICAgICAgZGVzY3JpcHRpb246ICdjdXN0b20gZGVzY3JpcHRpb24nLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnUkVMQVRJT05BTF9EQVRBQkFTRScsXG4gICAgICBOYW1lOiAnY3VzdG9tJyxcbiAgICAgIERlc2NyaXB0aW9uOiAnY3VzdG9tIGRlc2NyaXB0aW9uJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXBwc3luYyBlcnJvcnMgd2hlbiBjcmVhdGluZyBtdWx0aXBsZSByZHMgZGF0YSBzb3VyY2VzIHdpdGggbm8gY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgd2hlbiA9ICgpID0+IHtcbiAgICAgIGFwaS5hZGRSZHNEYXRhU291cmNlKCdkcycsIGNsdXN0ZXIsIHNlY3JldCk7XG4gICAgICBhcGkuYWRkUmRzRGF0YVNvdXJjZSgnZHMnLCBjbHVzdGVyLCBzZWNyZXQpO1xuICAgIH07XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHdoZW4pLnRvVGhyb3coJ1RoZXJlIGlzIGFscmVhZHkgYSBDb25zdHJ1Y3Qgd2l0aCBuYW1lIFxcJ2RzXFwnIGluIEdyYXBocWxBcGkgW2Jhc2VBcGldJyk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdhZGRpbmcgcmRzIGRhdGEgc291cmNlIGZyb20gaW1wb3J0ZWQgYXBpJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBsZXQgc2VjcmV0OiBEYXRhYmFzZVNlY3JldDtcbiAgbGV0IGNsdXN0ZXI6IFNlcnZlcmxlc3NDbHVzdGVyO1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb25zdCB2cGMgPSBuZXcgVnBjKHN0YWNrLCAnVnBjJywgeyBtYXhBenM6IDIgfSk7XG4gICAgY29uc3Qgc2VjdXJpdHlHcm91cCA9IG5ldyBTZWN1cml0eUdyb3VwKHN0YWNrLCAnQXVyb3JhU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYyxcbiAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWUsXG4gICAgfSk7XG4gICAgc2VjcmV0ID0gbmV3IERhdGFiYXNlU2VjcmV0KHN0YWNrLCAnQXVyb3JhU2VjcmV0Jywge1xuICAgICAgdXNlcm5hbWU6ICdjbHVzdGVyYWRtaW4nLFxuICAgIH0pO1xuICAgIGNsdXN0ZXIgPSBuZXcgU2VydmVybGVzc0NsdXN0ZXIoc3RhY2ssICdBdXJvcmFDbHVzdGVyJywge1xuICAgICAgZW5naW5lOiBEYXRhYmFzZUNsdXN0ZXJFbmdpbmUuYXVyb3JhTXlzcWwoeyB2ZXJzaW9uOiBBdXJvcmFNeXNxbEVuZ2luZVZlcnNpb24uVkVSXzJfMDdfMSB9KSxcbiAgICAgIGNyZWRlbnRpYWxzOiB7IHVzZXJuYW1lOiAnY2x1c3RlcmFkbWluJyB9LFxuICAgICAgY2x1c3RlcklkZW50aWZpZXI6ICdkYi1lbmRwb2ludC10ZXN0JyxcbiAgICAgIHZwYyxcbiAgICAgIHZwY1N1Ym5ldHM6IHsgc3VibmV0VHlwZTogU3VibmV0VHlwZS5QUklWQVRFX1dJVEhfRUdSRVNTIH0sXG4gICAgICBzZWN1cml0eUdyb3VwczogW3NlY3VyaXR5R3JvdXBdLFxuICAgICAgZGVmYXVsdERhdGFiYXNlTmFtZTogJ0FuaW1hbHMnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdpbXBvcnRlZCBhcGkgY2FuIGFkZCBSZHNEYkRhdGFTb3VyY2UgZnJvbSBpZCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgaW1wb3J0ZWRBcGkgPSBhcHBzeW5jLkdyYXBocWxBcGkuZnJvbUdyYXBocWxBcGlBdHRyaWJ1dGVzKHN0YWNrLCAnaW1wb3J0ZWRBcGknLCB7XG4gICAgICBncmFwaHFsQXBpSWQ6IGFwaS5hcGlJZCxcbiAgICB9KTtcbiAgICBpbXBvcnRlZEFwaS5hZGRSZHNEYXRhU291cmNlKCdkcycsIGNsdXN0ZXIsIHNlY3JldCk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6RGF0YVNvdXJjZScsIHtcbiAgICAgIFR5cGU6ICdSRUxBVElPTkFMX0RBVEFCQVNFJyxcbiAgICAgIEFwaUlkOiB7ICdGbjo6R2V0QXR0JzogWydiYXNlQXBpQ0RBNEQ0M0EnLCAnQXBpSWQnXSB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdpbXBvcnRlZCBhcGkgY2FuIGFkZCBSZHNEYXRhU291cmNlIGZyb20gYXR0cmlidXRlcycsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgaW1wb3J0ZWRBcGkgPSBhcHBzeW5jLkdyYXBocWxBcGkuZnJvbUdyYXBocWxBcGlBdHRyaWJ1dGVzKHN0YWNrLCAnaW1wb3J0ZWRBcGknLCB7XG4gICAgICBncmFwaHFsQXBpSWQ6IGFwaS5hcGlJZCxcbiAgICAgIGdyYXBocWxBcGlBcm46IGFwaS5hcm4sXG4gICAgfSk7XG4gICAgaW1wb3J0ZWRBcGkuYWRkUmRzRGF0YVNvdXJjZSgnZHMnLCBjbHVzdGVyLCBzZWNyZXQpO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkRhdGFTb3VyY2UnLCB7XG4gICAgICBUeXBlOiAnUkVMQVRJT05BTF9EQVRBQkFTRScsXG4gICAgICBBcGlJZDogeyAnRm46OkdldEF0dCc6IFsnYmFzZUFwaUNEQTRENDNBJywgJ0FwaUlkJ10gfSxcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==