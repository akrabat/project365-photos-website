"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const aws_certificatemanager_1 = require("../../aws-certificatemanager");
const iam = require("../../aws-iam");
const logs = require("../../aws-logs");
const cdk = require("../../core");
const appsync = require("../lib");
let stack;
let api;
beforeEach(() => {
    stack = new cdk.Stack();
    api = new appsync.GraphqlApi(stack, 'api', {
        authorizationConfig: {},
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
        logConfig: {},
    });
});
test('appsync should configure pipeline when pipelineConfig has contents', () => {
    // WHEN
    const ds = api.addNoneDataSource('none');
    const test1 = ds.createFunction('Test1Function', {
        name: 'test1',
    });
    const test2 = ds.createFunction('Test2Function', {
        name: 'test2',
    });
    api.createResolver('TestTest2', {
        typeName: 'test',
        fieldName: 'test2',
        pipelineConfig: [test1, test2],
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::Resolver', {
        Kind: 'PIPELINE',
        PipelineConfig: {
            Functions: [
                { 'Fn::GetAtt': ['apiTest1Function793605E9', 'FunctionId'] },
                { 'Fn::GetAtt': ['apiTest2FunctionB704A7AD', 'FunctionId'] },
            ],
        },
    });
});
test('appsync should error when creating pipeline resolver with data source', () => {
    // WHEN
    const ds = api.addNoneDataSource('none');
    const test1 = ds.createFunction('Test1Function', {
        name: 'test1',
    });
    const test2 = ds.createFunction('Test2Function', {
        name: 'test2',
    });
    // THEN
    expect(() => {
        api.createResolver('TestTest2', {
            dataSource: ds,
            typeName: 'test',
            fieldName: 'test2',
            pipelineConfig: [test1, test2],
        });
    }).toThrowError('Pipeline Resolver cannot have data source. Received: none');
});
test('appsync should configure resolver as unit when pipelineConfig is empty', () => {
    // WHEN
    const ds = api.addNoneDataSource('none');
    new appsync.Resolver(stack, 'resolver', {
        api: api,
        dataSource: ds,
        typeName: 'test',
        fieldName: 'test2',
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::Resolver', {
        Kind: 'UNIT',
    });
});
test('appsync should configure resolver as unit when pipelineConfig is empty array', () => {
    // WHEN
    api.createResolver('TestTest2', {
        typeName: 'test',
        fieldName: 'test2',
        pipelineConfig: [],
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::Resolver', {
        Kind: 'UNIT',
    });
});
test('when xray is enabled should not throw an Error', () => {
    // WHEN
    new appsync.GraphqlApi(stack, 'api-x-ray', {
        authorizationConfig: {},
        name: 'api',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
        xrayEnabled: true,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::GraphQLApi', {
        XrayEnabled: true,
    });
});
test('appsync GraphqlApi should be configured with custom CloudWatch Logs role when specified', () => {
    // GIVEN
    const cloudWatchLogRole = new iam.Role(stack, 'CloudWatchLogRole', {
        assumedBy: new iam.ServicePrincipal('appsync.amazonaws.com'),
        managedPolicies: [
            iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSAppSyncPushToCloudWatchLogs'),
        ],
    });
    // WHEN
    new appsync.GraphqlApi(stack, 'api-custom-cw-logs-role', {
        authorizationConfig: {},
        name: 'apiWithCustomRole',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
        logConfig: {
            role: cloudWatchLogRole,
        },
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::GraphQLApi', {
        Name: 'apiWithCustomRole',
        LogConfig: {
            CloudWatchLogsRoleArn: {
                'Fn::GetAtt': [
                    'CloudWatchLogRoleE3242F1C',
                    'Arn',
                ],
            },
        },
    });
});
test('appsync GraphqlApi should not use custom role for CW Logs when not specified', () => {
    // EXPECT
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::GraphQLApi', {
        Name: 'api',
        LogConfig: {
            CloudWatchLogsRoleArn: {
                'Fn::GetAtt': [
                    'apiApiLogsRole56BEE3F1',
                    'Arn',
                ],
            },
        },
    });
});
test('appsync GraphqlApi should be configured with custom domain when specified', () => {
    const domainName = 'api.example.com';
    // GIVEN
    const certificate = new aws_certificatemanager_1.Certificate(stack, 'AcmCertificate', {
        domainName,
    });
    // WHEN
    new appsync.GraphqlApi(stack, 'api-custom-cw-logs-role', {
        authorizationConfig: {},
        name: 'apiWithCustomRole',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
        domainName: {
            domainName,
            certificate,
        },
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DomainNameApiAssociation', {
        ApiId: {
            'Fn::GetAtt': [
                'apicustomcwlogsrole508EAC74',
                'ApiId',
            ],
        },
        DomainName: domainName,
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AppSync::DomainName', {
        CertificateArn: { Ref: 'AcmCertificate49D3B5AF' },
        DomainName: domainName,
    });
});
test('log retention should be configured with given retention time when specified', () => {
    // GIVEN
    const retentionTime = logs.RetentionDays.ONE_WEEK;
    // WHEN
    new appsync.GraphqlApi(stack, 'log-retention', {
        authorizationConfig: {},
        name: 'log-retention',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
        logConfig: {
            retention: retentionTime,
        },
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::LogRetention', {
        LogGroupName: {
            'Fn::Join': [
                '',
                [
                    '/aws/appsync/apis/',
                    {
                        'Fn::GetAtt': [
                            'logretentionB69DFB48',
                            'ApiId',
                        ],
                    },
                ],
            ],
        },
        RetentionInDays: 7,
    });
});
test('log retention should not appear when no retention time is specified', () => {
    // WHEN
    new appsync.GraphqlApi(stack, 'no-log-retention', {
        authorizationConfig: {},
        name: 'no-log-retention',
        schema: appsync.SchemaFile.fromAsset(path.join(__dirname, 'appsync.test.graphql')),
    });
    // THEN
    assertions_1.Template.fromStack(stack).resourceCountIs('Custom::LogRetention', 0);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwc3luYy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwc3luYy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGlEQUE0QztBQUM1Qyx5RUFBMkQ7QUFDM0QscUNBQXFDO0FBQ3JDLHVDQUF1QztBQUN2QyxrQ0FBa0M7QUFDbEMsa0NBQWtDO0FBRWxDLElBQUksS0FBZ0IsQ0FBQztBQUNyQixJQUFJLEdBQXVCLENBQUM7QUFDNUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN4QixHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUU7UUFDekMsbUJBQW1CLEVBQUUsRUFBRTtRQUN2QixJQUFJLEVBQUUsS0FBSztRQUNYLE1BQU0sRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO1FBQ2xGLFNBQVMsRUFBRSxFQUFFO0tBQ2QsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsb0VBQW9FLEVBQUUsR0FBRyxFQUFFO0lBQzlFLE9BQU87SUFDUCxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDekMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUU7UUFDL0MsSUFBSSxFQUFFLE9BQU87S0FDZCxDQUFDLENBQUM7SUFDSCxNQUFNLEtBQUssR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLGVBQWUsRUFBRTtRQUMvQyxJQUFJLEVBQUUsT0FBTztLQUNkLENBQUMsQ0FBQztJQUNILEdBQUcsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFO1FBQzlCLFFBQVEsRUFBRSxNQUFN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a0JBQWtCO1FBQ3hCLE1BQU0sRUFBRSxPQUFPLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0tBQ25GLENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDdkUsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCB7IENlcnRpZmljYXRlIH0gZnJvbSAnLi4vLi4vYXdzLWNlcnRpZmljYXRlbWFuYWdlcic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gJy4uLy4uL2F3cy1sb2dzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnLi4vbGliJztcblxubGV0IHN0YWNrOiBjZGsuU3RhY2s7XG5sZXQgYXBpOiBhcHBzeW5jLkdyYXBocWxBcGk7XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gIGFwaSA9IG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICdhcGknLCB7XG4gICAgYXV0aG9yaXphdGlvbkNvbmZpZzoge30sXG4gICAgbmFtZTogJ2FwaScsXG4gICAgc2NoZW1hOiBhcHBzeW5jLlNjaGVtYUZpbGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdhcHBzeW5jLnRlc3QuZ3JhcGhxbCcpKSxcbiAgICBsb2dDb25maWc6IHt9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdhcHBzeW5jIHNob3VsZCBjb25maWd1cmUgcGlwZWxpbmUgd2hlbiBwaXBlbGluZUNvbmZpZyBoYXMgY29udGVudHMnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgY29uc3QgZHMgPSBhcGkuYWRkTm9uZURhdGFTb3VyY2UoJ25vbmUnKTtcbiAgY29uc3QgdGVzdDEgPSBkcy5jcmVhdGVGdW5jdGlvbignVGVzdDFGdW5jdGlvbicsIHtcbiAgICBuYW1lOiAndGVzdDEnLFxuICB9KTtcbiAgY29uc3QgdGVzdDIgPSBkcy5jcmVhdGVGdW5jdGlvbignVGVzdDJGdW5jdGlvbicsIHtcbiAgICBuYW1lOiAndGVzdDInLFxuICB9KTtcbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCdUZXN0VGVzdDInLCB7XG4gICAgdHlwZU5hbWU6ICd0ZXN0JyxcbiAgICBmaWVsZE5hbWU6ICd0ZXN0MicsXG4gICAgcGlwZWxpbmVDb25maWc6IFt0ZXN0MSwgdGVzdDJdLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OlJlc29sdmVyJywge1xuICAgIEtpbmQ6ICdQSVBFTElORScsXG4gICAgUGlwZWxpbmVDb25maWc6IHtcbiAgICAgIEZ1bmN0aW9uczogW1xuICAgICAgICB7ICdGbjo6R2V0QXR0JzogWydhcGlUZXN0MUZ1bmN0aW9uNzkzNjA1RTknLCAnRnVuY3Rpb25JZCddIH0sXG4gICAgICAgIHsgJ0ZuOjpHZXRBdHQnOiBbJ2FwaVRlc3QyRnVuY3Rpb25CNzA0QTdBRCcsICdGdW5jdGlvbklkJ10gfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnYXBwc3luYyBzaG91bGQgZXJyb3Igd2hlbiBjcmVhdGluZyBwaXBlbGluZSByZXNvbHZlciB3aXRoIGRhdGEgc291cmNlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGRzID0gYXBpLmFkZE5vbmVEYXRhU291cmNlKCdub25lJyk7XG4gIGNvbnN0IHRlc3QxID0gZHMuY3JlYXRlRnVuY3Rpb24oJ1Rlc3QxRnVuY3Rpb24nLCB7XG4gICAgbmFtZTogJ3Rlc3QxJyxcbiAgfSk7XG4gIGNvbnN0IHRlc3QyID0gZHMuY3JlYXRlRnVuY3Rpb24oJ1Rlc3QyRnVuY3Rpb24nLCB7XG4gICAgbmFtZTogJ3Rlc3QyJyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoKCkgPT4ge1xuICAgIGFwaS5jcmVhdGVSZXNvbHZlcignVGVzdFRlc3QyJywge1xuICAgICAgZGF0YVNvdXJjZTogZHMsXG4gICAgICB0eXBlTmFtZTogJ3Rlc3QnLFxuICAgICAgZmllbGROYW1lOiAndGVzdDInLFxuICAgICAgcGlwZWxpbmVDb25maWc6IFt0ZXN0MSwgdGVzdDJdLFxuICAgIH0pO1xuICB9KS50b1Rocm93RXJyb3IoJ1BpcGVsaW5lIFJlc29sdmVyIGNhbm5vdCBoYXZlIGRhdGEgc291cmNlLiBSZWNlaXZlZDogbm9uZScpO1xufSk7XG5cbnRlc3QoJ2FwcHN5bmMgc2hvdWxkIGNvbmZpZ3VyZSByZXNvbHZlciBhcyB1bml0IHdoZW4gcGlwZWxpbmVDb25maWcgaXMgZW1wdHknLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgY29uc3QgZHMgPSBhcGkuYWRkTm9uZURhdGFTb3VyY2UoJ25vbmUnKTtcbiAgbmV3IGFwcHN5bmMuUmVzb2x2ZXIoc3RhY2ssICdyZXNvbHZlcicsIHtcbiAgICBhcGk6IGFwaSxcbiAgICBkYXRhU291cmNlOiBkcyxcbiAgICB0eXBlTmFtZTogJ3Rlc3QnLFxuICAgIGZpZWxkTmFtZTogJ3Rlc3QyJyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpSZXNvbHZlcicsIHtcbiAgICBLaW5kOiAnVU5JVCcsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2FwcHN5bmMgc2hvdWxkIGNvbmZpZ3VyZSByZXNvbHZlciBhcyB1bml0IHdoZW4gcGlwZWxpbmVDb25maWcgaXMgZW1wdHkgYXJyYXknLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgYXBpLmNyZWF0ZVJlc29sdmVyKCdUZXN0VGVzdDInLCB7XG4gICAgdHlwZU5hbWU6ICd0ZXN0JyxcbiAgICBmaWVsZE5hbWU6ICd0ZXN0MicsXG4gICAgcGlwZWxpbmVDb25maWc6IFtdLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OlJlc29sdmVyJywge1xuICAgIEtpbmQ6ICdVTklUJyxcbiAgfSk7XG59KTtcblxudGVzdCgnd2hlbiB4cmF5IGlzIGVuYWJsZWQgc2hvdWxkIG5vdCB0aHJvdyBhbiBFcnJvcicsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgYXBwc3luYy5HcmFwaHFsQXBpKHN0YWNrLCAnYXBpLXgtcmF5Jywge1xuICAgIGF1dGhvcml6YXRpb25Db25maWc6IHt9LFxuICAgIG5hbWU6ICdhcGknLFxuICAgIHNjaGVtYTogYXBwc3luYy5TY2hlbWFGaWxlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy50ZXN0LmdyYXBocWwnKSksXG4gICAgeHJheUVuYWJsZWQ6IHRydWUsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6QXBwU3luYzo6R3JhcGhRTEFwaScsIHtcbiAgICBYcmF5RW5hYmxlZDogdHJ1ZSxcbiAgfSk7XG59KTtcblxudGVzdCgnYXBwc3luYyBHcmFwaHFsQXBpIHNob3VsZCBiZSBjb25maWd1cmVkIHdpdGggY3VzdG9tIENsb3VkV2F0Y2ggTG9ncyByb2xlIHdoZW4gc3BlY2lmaWVkJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBjbG91ZFdhdGNoTG9nUm9sZTogaWFtLlJvbGUgPSBuZXcgaWFtLlJvbGUoc3RhY2ssICdDbG91ZFdhdGNoTG9nUm9sZScsIHtcbiAgICBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnYXBwc3luYy5hbWF6b25hd3MuY29tJyksXG4gICAgbWFuYWdlZFBvbGljaWVzOiBbXG4gICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ3NlcnZpY2Utcm9sZS9BV1NBcHBTeW5jUHVzaFRvQ2xvdWRXYXRjaExvZ3MnKSxcbiAgICBdLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICdhcGktY3VzdG9tLWN3LWxvZ3Mtcm9sZScsIHtcbiAgICBhdXRob3JpemF0aW9uQ29uZmlnOiB7fSxcbiAgICBuYW1lOiAnYXBpV2l0aEN1c3RvbVJvbGUnLFxuICAgIHNjaGVtYTogYXBwc3luYy5TY2hlbWFGaWxlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy50ZXN0LmdyYXBocWwnKSksXG4gICAgbG9nQ29uZmlnOiB7XG4gICAgICByb2xlOiBjbG91ZFdhdGNoTG9nUm9sZSxcbiAgICB9LFxuICB9KTtcblxuICAvLyBUSEVOXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkFwcFN5bmM6OkdyYXBoUUxBcGknLCB7XG4gICAgTmFtZTogJ2FwaVdpdGhDdXN0b21Sb2xlJyxcbiAgICBMb2dDb25maWc6IHtcbiAgICAgIENsb3VkV2F0Y2hMb2dzUm9sZUFybjoge1xuICAgICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgICAnQ2xvdWRXYXRjaExvZ1JvbGVFMzI0MkYxQycsXG4gICAgICAgICAgJ0FybicsXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2FwcHN5bmMgR3JhcGhxbEFwaSBzaG91bGQgbm90IHVzZSBjdXN0b20gcm9sZSBmb3IgQ1cgTG9ncyB3aGVuIG5vdCBzcGVjaWZpZWQnLCAoKSA9PiB7XG4gIC8vIEVYUEVDVFxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpHcmFwaFFMQXBpJywge1xuICAgIE5hbWU6ICdhcGknLFxuICAgIExvZ0NvbmZpZzoge1xuICAgICAgQ2xvdWRXYXRjaExvZ3NSb2xlQXJuOiB7XG4gICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICdhcGlBcGlMb2dzUm9sZTU2QkVFM0YxJyxcbiAgICAgICAgICAnQXJuJyxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnYXBwc3luYyBHcmFwaHFsQXBpIHNob3VsZCBiZSBjb25maWd1cmVkIHdpdGggY3VzdG9tIGRvbWFpbiB3aGVuIHNwZWNpZmllZCcsICgpID0+IHtcbiAgY29uc3QgZG9tYWluTmFtZSA9ICdhcGkuZXhhbXBsZS5jb20nO1xuICAvLyBHSVZFTlxuICBjb25zdCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZShzdGFjaywgJ0FjbUNlcnRpZmljYXRlJywge1xuICAgIGRvbWFpbk5hbWUsXG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgbmV3IGFwcHN5bmMuR3JhcGhxbEFwaShzdGFjaywgJ2FwaS1jdXN0b20tY3ctbG9ncy1yb2xlJywge1xuICAgIGF1dGhvcml6YXRpb25Db25maWc6IHt9LFxuICAgIG5hbWU6ICdhcGlXaXRoQ3VzdG9tUm9sZScsXG4gICAgc2NoZW1hOiBhcHBzeW5jLlNjaGVtYUZpbGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICdhcHBzeW5jLnRlc3QuZ3JhcGhxbCcpKSxcbiAgICBkb21haW5OYW1lOiB7XG4gICAgICBkb21haW5OYW1lLFxuICAgICAgY2VydGlmaWNhdGUsXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEb21haW5OYW1lQXBpQXNzb2NpYXRpb24nLCB7XG4gICAgQXBpSWQ6IHtcbiAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAnYXBpY3VzdG9tY3dsb2dzcm9sZTUwOEVBQzc0JyxcbiAgICAgICAgJ0FwaUlkJyxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBEb21haW5OYW1lOiBkb21haW5OYW1lLFxuICB9KTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBcHBTeW5jOjpEb21haW5OYW1lJywge1xuICAgIENlcnRpZmljYXRlQXJuOiB7IFJlZjogJ0FjbUNlcnRpZmljYXRlNDlEM0I1QUYnIH0sXG4gICAgRG9tYWluTmFtZTogZG9tYWluTmFtZSxcbiAgfSk7XG59KTtcblxudGVzdCgnbG9nIHJldGVudGlvbiBzaG91bGQgYmUgY29uZmlndXJlZCB3aXRoIGdpdmVuIHJldGVudGlvbiB0aW1lIHdoZW4gc3BlY2lmaWVkJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCByZXRlbnRpb25UaW1lID0gbG9ncy5SZXRlbnRpb25EYXlzLk9ORV9XRUVLO1xuXG4gIC8vIFdIRU5cbiAgbmV3IGFwcHN5bmMuR3JhcGhxbEFwaShzdGFjaywgJ2xvZy1yZXRlbnRpb24nLCB7XG4gICAgYXV0aG9yaXphdGlvbkNvbmZpZzoge30sXG4gICAgbmFtZTogJ2xvZy1yZXRlbnRpb24nLFxuICAgIHNjaGVtYTogYXBwc3luYy5TY2hlbWFGaWxlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXBwc3luYy50ZXN0LmdyYXBocWwnKSksXG4gICAgbG9nQ29uZmlnOiB7XG4gICAgICByZXRlbnRpb246IHJldGVudGlvblRpbWUsXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpMb2dSZXRlbnRpb24nLCB7XG4gICAgTG9nR3JvdXBOYW1lOiB7XG4gICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICcnLFxuICAgICAgICBbXG4gICAgICAgICAgJy9hd3MvYXBwc3luYy9hcGlzLycsXG4gICAgICAgICAge1xuICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgICAgICdsb2dyZXRlbnRpb25CNjlERkI0OCcsXG4gICAgICAgICAgICAgICdBcGlJZCcsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICBdLFxuICAgIH0sXG4gICAgUmV0ZW50aW9uSW5EYXlzOiA3LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdsb2cgcmV0ZW50aW9uIHNob3VsZCBub3QgYXBwZWFyIHdoZW4gbm8gcmV0ZW50aW9uIHRpbWUgaXMgc3BlY2lmaWVkJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBhcHBzeW5jLkdyYXBocWxBcGkoc3RhY2ssICduby1sb2ctcmV0ZW50aW9uJywge1xuICAgIGF1dGhvcml6YXRpb25Db25maWc6IHt9LFxuICAgIG5hbWU6ICduby1sb2ctcmV0ZW50aW9uJyxcbiAgICBzY2hlbWE6IGFwcHN5bmMuU2NoZW1hRmlsZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJ2FwcHN5bmMudGVzdC5ncmFwaHFsJykpLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykucmVzb3VyY2VDb3VudElzKCdDdXN0b206OkxvZ1JldGVudGlvbicsIDApO1xufSk7XG4iXX0=