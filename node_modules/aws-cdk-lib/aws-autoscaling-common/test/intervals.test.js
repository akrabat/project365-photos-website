"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fc = require("fast-check");
const util_1 = require("./util");
const interval_utils_1 = require("../lib/interval-utils");
describe('intervals', () => {
    test('test bounds propagation', () => {
        const intervals = (0, interval_utils_1.normalizeIntervals)(realisticRelativeIntervals(), false);
        expect(intervals).toEqual([
            { lower: 0, upper: 10, change: -2 },
            { lower: 10, upper: 20, change: -1 },
            { lower: 20, upper: 80, change: undefined },
            { lower: 80, upper: 90, change: +1 },
            { lower: 90, upper: Infinity, change: +2 },
        ]);
    });
    test('test interval completion', () => {
        const lowerIncompleteIntervals = (0, interval_utils_1.normalizeIntervals)(incompleteLowerRelativeIntervals(), false);
        const upperIncompleteIntervals = (0, interval_utils_1.normalizeIntervals)(incompleteUpperRelativeIntervals(), false);
        expect(lowerIncompleteIntervals).toEqual([
            { lower: 0, upper: 65, change: undefined },
            { lower: 65, upper: 85, change: +2 },
            { lower: 85, upper: Infinity, change: +3 },
        ]);
        expect(upperIncompleteIntervals).toEqual([
            { lower: 0, upper: 65, change: +2 },
            { lower: 65, upper: 85, change: +3 },
            { lower: 85, upper: Infinity, change: undefined },
        ]);
    });
    test('bounds propagation fails if middle boundary missing', () => {
        expect(() => {
            (0, interval_utils_1.normalizeIntervals)([
                { lower: 0, change: -2 },
                { upper: 20, change: -1 },
            ], false);
        }).toThrow();
    });
    test('lower alarm index is lower than higher alarm index', () => {
        fc.assert(fc.property((0, util_1.arbitrary_complete_intervals)(), (intervals) => {
            const alarms = (0, interval_utils_1.findAlarmThresholds)(intervals);
            return (alarms.lowerAlarmIntervalIndex === undefined
                || alarms.upperAlarmIntervalIndex === undefined
                || alarms.lowerAlarmIntervalIndex < alarms.upperAlarmIntervalIndex);
        }));
    });
    test('never pick undefined intervals for relative alarms', () => {
        fc.assert(fc.property((0, util_1.arbitrary_complete_intervals)(), (intervals) => {
            const alarms = (0, interval_utils_1.findAlarmThresholds)(intervals);
            return (alarms.lowerAlarmIntervalIndex === undefined || intervals[alarms.lowerAlarmIntervalIndex].change !== undefined)
                && (alarms.upperAlarmIntervalIndex === undefined || intervals[alarms.upperAlarmIntervalIndex].change !== undefined);
        }));
    });
    test('pick intervals on either side of the undefined interval, if present', () => {
        fc.assert(fc.property((0, util_1.arbitrary_complete_intervals)(), (intervals) => {
            // There must be an undefined interval and it must not be at the edges
            const i = intervals.findIndex(x => x.change === undefined);
            fc.pre(i > 0 && i < intervals.length - 1);
            const alarms = (0, interval_utils_1.findAlarmThresholds)(intervals);
            return (alarms.lowerAlarmIntervalIndex === i - 1 && alarms.upperAlarmIntervalIndex === i + 1);
        }));
    });
    test('no picking upper bound infinity for lower alarm', () => {
        fc.assert(fc.property((0, util_1.arbitrary_complete_intervals)(), (intervals) => {
            const alarms = (0, interval_utils_1.findAlarmThresholds)(intervals);
            fc.pre(alarms.lowerAlarmIntervalIndex !== undefined);
            return intervals[alarms.lowerAlarmIntervalIndex].upper !== Infinity;
        }));
    });
    test('no picking lower bound 0 for upper alarm', () => {
        fc.assert(fc.property((0, util_1.arbitrary_complete_intervals)(), (intervals) => {
            const alarms = (0, interval_utils_1.findAlarmThresholds)(intervals);
            fc.pre(alarms.upperAlarmIntervalIndex !== undefined);
            return intervals[alarms.upperAlarmIntervalIndex].lower !== 0;
        }));
    });
});
function realisticRelativeIntervals() {
    // Function so we don't have to worry about cloning
    return [
        { upper: 10, change: -2 },
        { upper: 20, change: -1 },
        { lower: 80, change: +1 },
        { lower: 90, change: +2 },
    ];
}
function incompleteLowerRelativeIntervals() {
    // Function so we don't have to worry about cloning
    // The first interval's lower is not zero nor undefined
    return [
        { lower: 65, change: +2 },
        { lower: 85, change: +3 },
    ];
}
function incompleteUpperRelativeIntervals() {
    // Function so we don't have to worry about cloning
    // The last interval's upper is not Infinity nor undefined
    return [
        { upper: 65, change: +2 },
        { upper: 85, change: +3 },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJ2YWxzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbnRlcnZhbHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyxpQ0FBc0Q7QUFFdEQsMERBQWdGO0FBRWhGLFFBQVEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO0lBQ3pCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7UUFDbkMsTUFBTSxTQUFTLEdBQUcsSUFBQSxtQ0FBa0IsRUFBQywwQkFBMEIsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRTFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDeEIsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFO1lBQ25DLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRTtZQUNwQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFO1lBQzNDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRTtZQUNwQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUU7U0FDM0MsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO1FBQ3BDLE1BQU0sd0JBQXdCLEdBQUcsSUFBQSxtQ0FBa0IsRUFDakQsZ0NBQWdDLEVBQUUsRUFDbEMsS0FBSyxDQUFDLENBQUM7UUFDVCxNQUFNLHdCQUF3QixHQUFHLElBQUEsbUNBQWtCLEVBQ2pELGdD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LENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmYyBmcm9tICdmYXN0LWNoZWNrJztcbmltcG9ydCB7IGFyYml0cmFyeV9jb21wbGV0ZV9pbnRlcnZhbHMgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0ICogYXMgYXBwc2NhbGluZyBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgZmluZEFsYXJtVGhyZXNob2xkcywgbm9ybWFsaXplSW50ZXJ2YWxzIH0gZnJvbSAnLi4vbGliL2ludGVydmFsLXV0aWxzJztcblxuZGVzY3JpYmUoJ2ludGVydmFscycsICgpID0+IHtcbiAgdGVzdCgndGVzdCBib3VuZHMgcHJvcGFnYXRpb24nLCAoKSA9PiB7XG4gICAgY29uc3QgaW50ZXJ2YWxzID0gbm9ybWFsaXplSW50ZXJ2YWxzKHJlYWxpc3RpY1JlbGF0aXZlSW50ZXJ2YWxzKCksIGZhbHNlKTtcblxuICAgIGV4cGVjdChpbnRlcnZhbHMpLnRvRXF1YWwoW1xuICAgICAgeyBsb3dlcjogMCwgdXBwZXI6IDEwLCBjaGFuZ2U6IC0yIH0sXG4gICAgICB7IGxvd2VyOiAxMCwgdXBwZXI6IDIwLCBjaGFuZ2U6IC0xIH0sXG4gICAgICB7IGxvd2VyOiAyMCwgdXBwZXI6IDgwLCBjaGFuZ2U6IHVuZGVmaW5lZCB9LFxuICAgICAgeyBsb3dlcjogODAsIHVwcGVyOiA5MCwgY2hhbmdlOiArMSB9LFxuICAgICAgeyBsb3dlcjogOTAsIHVwcGVyOiBJbmZpbml0eSwgY2hhbmdlOiArMiB9LFxuICAgIF0pO1xuICB9KTtcblxuICB0ZXN0KCd0ZXN0IGludGVydmFsIGNvbXBsZXRpb24nLCAoKSA9PiB7XG4gICAgY29uc3QgbG93ZXJJbmNvbXBsZXRlSW50ZXJ2YWxzID0gbm9ybWFsaXplSW50ZXJ2YWxzKFxuICAgICAgaW5jb21wbGV0ZUxvd2VyUmVsYXRpdmVJbnRlcnZhbHMoKSxcbiAgICAgIGZhbHNlKTtcbiAgICBjb25zdCB1cHBlckluY29tcGxldGVJbnRlcnZhbHMgPSBub3JtYWxpemVJbnRlcnZhbHMoXG4gICAgICBpbmNvbXBsZXRlVXBwZXJSZWxhdGl2ZUludGVydmFscygpLFxuICAgICAgZmFsc2UpO1xuXG4gICAgZXhwZWN0KGxvd2VySW5jb21wbGV0ZUludGVydmFscykudG9FcXVhbChbXG4gICAgICB7IGxvd2VyOiAwLCB1cHBlcjogNjUsIGNoYW5nZTogdW5kZWZpbmVkIH0sXG4gICAgICB7IGxvd2VyOiA2NSwgdXBwZXI6IDg1LCBjaGFuZ2U6ICsyIH0sXG4gICAgICB7IGxvd2VyOiA4NSwgdXBwZXI6IEluZmluaXR5LCBjaGFuZ2U6ICszIH0sXG4gICAgXSk7XG5cbiAgICBleHBlY3QodXBwZXJJbmNvbXBsZXRlSW50ZXJ2YWxzKS50b0VxdWFsKFtcbiAgICAgIHsgbG93ZXI6IDAsIHVwcGVyOiA2NSwgY2hhbmdlOiArMiB9LFxuICAgICAgeyBsb3dlcjogNjUsIHVwcGVyOiA4NSwgY2hhbmdlOiArMyB9LFxuICAgICAgeyBsb3dlcjogODUsIHVwcGVyOiBJbmZpbml0eSwgY2hhbmdlOiB1bmRlZmluZWQgfSxcbiAgICBdKTtcbiAgfSk7XG5cbiAgdGVzdCgnYm91bmRzIHByb3BhZ2F0aW9uIGZhaWxzIGlmIG1pZGRsZSBib3VuZGFyeSBtaXNzaW5nJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBub3JtYWxpemVJbnRlcnZhbHMoW1xuICAgICAgICB7IGxvd2VyOiAwLCBjaGFuZ2U6IC0yIH0sXG4gICAgICAgIHsgdXBwZXI6IDIwLCBjaGFuZ2U6IC0xIH0sXG4gICAgICBdLCBmYWxzZSk7XG4gICAgfSkudG9UaHJvdygpO1xuICB9KTtcblxuICB0ZXN0KCdsb3dlciBhbGFybSBpbmRleCBpcyBsb3dlciB0aGFuIGhpZ2hlciBhbGFybSBpbmRleCcsICgpID0+IHtcbiAgICBmYy5hc3NlcnQoZmMucHJvcGVydHkoXG4gICAgICBhcmJpdHJhcnlfY29tcGxldGVfaW50ZXJ2YWxzKCksXG4gICAgICAoaW50ZXJ2YWxzKSA9PiB7XG4gICAgICAgIGNvbnN0IGFsYXJtcyA9IGZpbmRBbGFybVRocmVzaG9sZHMoaW50ZXJ2YWxzKTtcblxuICAgICAgICByZXR1cm4gKGFsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgfHwgYWxhcm1zLnVwcGVyQWxhcm1JbnRlcnZhbEluZGV4ID09PSB1bmRlZmluZWRcbiAgICAgICAgICB8fCBhbGFybXMubG93ZXJBbGFybUludGVydmFsSW5kZXggPCBhbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXgpO1xuICAgICAgfSxcbiAgICApKTtcbiAgfSk7XG5cbiAgdGVzdCgnbmV2ZXIgcGljayB1bmRlZmluZWQgaW50ZXJ2YWxzIGZvciByZWxhdGl2ZSBhbGFybXMnLCAoKSA9PiB7XG4gICAgZmMuYXNzZXJ0KGZjLnByb3BlcnR5KFxuICAgICAgYXJiaXRyYXJ5X2NvbXBsZXRlX2ludGVydmFscygpLFxuICAgICAgKGludGVydmFscykgPT4ge1xuICAgICAgICBjb25zdCBhbGFybXMgPSBmaW5kQWxhcm1UaHJlc2hvbGRzKGludGVydmFscyk7XG5cbiAgICAgICAgcmV0dXJuIChhbGFybXMubG93ZXJBbGFybUludGVydmFsSW5kZXggPT09IHVuZGVmaW5lZCB8fCBpbnRlcnZhbHNbYWxhcm1zLmxvd2VyQWxhcm1JbnRlcnZhbEluZGV4XS5jaGFuZ2UgIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAmJiAoYWxhcm1zLnVwcGVyQWxhcm1JbnRlcnZhbEluZGV4ID09PSB1bmRlZmluZWQgfHwgaW50ZXJ2YWxzW2FsYXJtcy51cHBlckFsYXJtSW50ZXJ2YWxJbmRleF0uY2hhbmdlICE9PSB1bmRlZmluZWQpO1xuICAgICAgfSxcbiAgICApKTtcbiAgfSk7XG5cbiAgdGVzdCgncGljayBpbnRlcnZhbHMgb24gZWl0aGVyIHNpZGUgb2YgdGhlIHVuZGVmaW5lZCBpbnRlcnZhbCwgaWYgcHJlc2VudCcsICgpID0+IHtcbiAgICBmYy5hc3NlcnQoZmMucHJvcGVydHkoXG4gICAgICBhcmJpdHJhcnlfY29tcGxldGVfaW50ZXJ2YWxzKCksXG4gICAgICAoaW50ZXJ2YWxzKSA9PiB7XG4gICAgICAgIC8vIFRoZXJlIG11c3QgYmUgYW4gdW5kZWZpbmVkIGludGVydmFsIGFuZCBpdCBtdXN0IG5vdCBiZSBhdCB0aGUgZWRnZXNcbiAgICAgICAgY29uc3QgaSA9IGludGVydmFscy5maW5kSW5kZXgoeCA9PiB4LmNoYW5nZSA9PT0gdW5kZWZpbmVkKTtcbiAgICAgICAgZmMucHJlKGkgPiAwICYmIGkgPCBpbnRlcnZhbHMubGVuZ3RoIC0gMSk7XG5cbiAgICAgICAgY29uc3QgYWxhcm1zID0gZmluZEFsYXJtVGhyZXNob2xkcyhpbnRlcnZhbHMpO1xuICAgICAgICByZXR1cm4gKGFsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCA9PT0gaSAtIDEgJiYgYWxhcm1zLnVwcGVyQWxhcm1JbnRlcnZhbEluZGV4ID09PSBpICsgMSk7XG4gICAgICB9LFxuICAgICkpO1xuICB9KTtcblxuICB0ZXN0KCdubyBwaWNraW5nIHVwcGVyIGJvdW5kIGluZmluaXR5IGZvciBsb3dlciBhbGFybScsICgpID0+IHtcbiAgICBmYy5hc3NlcnQoZmMucHJvcGVydHkoXG4gICAgICBhcmJpdHJhcnlfY29tcGxldGVfaW50ZXJ2YWxzKCksXG4gICAgICAoaW50ZXJ2YWxzKSA9PiB7XG4gICAgICAgIGNvbnN0IGFsYXJtcyA9IGZpbmRBbGFybVRocmVzaG9sZHMoaW50ZXJ2YWxzKTtcbiAgICAgICAgZmMucHJlKGFsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCAhPT0gdW5kZWZpbmVkKTtcblxuICAgICAgICByZXR1cm4gaW50ZXJ2YWxzW2FsYXJtcy5sb3dlckFsYXJtSW50ZXJ2YWxJbmRleCFdLnVwcGVyICE9PSBJbmZpbml0eTtcbiAgICAgIH0sXG4gICAgKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ25vIHBpY2tpbmcgbG93ZXIgYm91bmQgMCBmb3IgdXBwZXIgYWxhcm0nLCAoKSA9PiB7XG4gICAgZmMuYXNzZXJ0KGZjLnByb3BlcnR5KFxuICAgICAgYXJiaXRyYXJ5X2NvbXBsZXRlX2ludGVydmFscygpLFxuICAgICAgKGludGVydmFscykgPT4ge1xuICAgICAgICBjb25zdCBhbGFybXMgPSBmaW5kQWxhcm1UaHJlc2hvbGRzKGludGVydmFscyk7XG4gICAgICAgIGZjLnByZShhbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXggIT09IHVuZGVmaW5lZCk7XG5cbiAgICAgICAgcmV0dXJuIGludGVydmFsc1thbGFybXMudXBwZXJBbGFybUludGVydmFsSW5kZXghXS5sb3dlciAhPT0gMDtcbiAgICAgIH0sXG4gICAgKSk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIHJlYWxpc3RpY1JlbGF0aXZlSW50ZXJ2YWxzKCk6IGFwcHNjYWxpbmcuU2NhbGluZ0ludGVydmFsW10ge1xuICAvLyBGdW5jdGlvbiBzbyB3ZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGNsb25pbmdcbiAgcmV0dXJuIFtcbiAgICB7IHVwcGVyOiAxMCwgY2hhbmdlOiAtMiB9LFxuICAgIHsgdXBwZXI6IDIwLCBjaGFuZ2U6IC0xIH0sXG4gICAgeyBsb3dlcjogODAsIGNoYW5nZTogKzEgfSxcbiAgICB7IGxvd2VyOiA5MCwgY2hhbmdlOiArMiB9LFxuICBdO1xufVxuXG5mdW5jdGlvbiBpbmNvbXBsZXRlTG93ZXJSZWxhdGl2ZUludGVydmFscygpOiBhcHBzY2FsaW5nLlNjYWxpbmdJbnRlcnZhbFtdIHtcbiAgLy8gRnVuY3Rpb24gc28gd2UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBjbG9uaW5nXG4gIC8vIFRoZSBmaXJzdCBpbnRlcnZhbCdzIGxvd2VyIGlzIG5vdCB6ZXJvIG5vciB1bmRlZmluZWRcbiAgcmV0dXJuIFtcbiAgICB7IGxvd2VyOiA2NSwgY2hhbmdlOiArMiB9LFxuICAgIHsgbG93ZXI6IDg1LCBjaGFuZ2U6ICszIH0sXG4gIF07XG59XG5cbmZ1bmN0aW9uIGluY29tcGxldGVVcHBlclJlbGF0aXZlSW50ZXJ2YWxzKCk6IGFwcHNjYWxpbmcuU2NhbGluZ0ludGVydmFsW10ge1xuICAvLyBGdW5jdGlvbiBzbyB3ZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGNsb25pbmdcbiAgLy8gVGhlIGxhc3QgaW50ZXJ2YWwncyB1cHBlciBpcyBub3QgSW5maW5pdHkgbm9yIHVuZGVmaW5lZFxuICByZXR1cm4gW1xuICAgIHsgdXBwZXI6IDY1LCBjaGFuZ2U6ICsyIH0sXG4gICAgeyB1cHBlcjogODUsIGNoYW5nZTogKzMgfSxcbiAgXTtcbn1cbiJdfQ==