"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const ec2 = require("../../aws-ec2");
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const cdk = require("../../core");
const autoscaling = require("../lib");
(0, cdk_build_tools_1.describeDeprecated)('scheduled action', () => {
    test('can schedule an action', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutInTheMorning', {
            schedule: autoscaling.Schedule.cron({ hour: '8', minute: '0' }),
            minCapacity: 10,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AutoScaling::ScheduledAction', {
            Recurrence: '0 8 * * *',
            MinSize: 10,
        });
    });
    test('correctly formats date objects', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutInTheMorning', {
            schedule: autoscaling.Schedule.cron({ hour: '8' }),
            startTime: new Date(Date.UTC(2033, 8, 10, 12, 0, 0)),
            minCapacity: 11,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AutoScaling::ScheduledAction', {
            StartTime: '2033-09-10T12:00:00Z',
        });
    });
    test('have timezone property', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutAtMiddaySeoul', {
            schedule: autoscaling.Schedule.cron({ hour: '12', minute: '0' }),
            minCapacity: 12,
            timeZone: 'Asia/Seoul',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::AutoScaling::ScheduledAction', {
            MinSize: 12,
            Recurrence: '0 12 * * *',
            TimeZone: 'Asia/Seoul',
        });
    });
    test('autoscaling group has recommended updatepolicy for scheduled actions', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutInTheMorning', {
            schedule: autoscaling.Schedule.cron({ hour: '8' }),
            minCapacity: 10,
        });
        // THEN
        assertions_1.Template.fromStack(stack).templateMatches({
            Resources: {
                ASG46ED3070: {
                    Type: 'AWS::AutoScaling::AutoScalingGroup',
                    Properties: {
                        MaxSize: '1',
                        MinSize: '1',
                        LaunchConfigurationName: { Ref: 'ASGLaunchConfigC00AF12B' },
                        Tags: [
                            {
                                Key: 'Name',
                                PropagateAtLaunch: true,
                                Value: 'Default/ASG',
                            },
                        ],
                        VPCZoneIdentifier: [
                            { Ref: 'VPCPrivateSubnet1Subnet8BCA10E0' },
                            { Ref: 'VPCPrivateSubnet2SubnetCFCDAA7A' },
                        ],
                    },
                    UpdatePolicy: {
                        AutoScalingRollingUpdate: {
                            WaitOnResourceSignals: false,
                            PauseTime: 'PT0S',
                            SuspendProcesses: [
                                'HealthCheck',
                                'ReplaceUnhealthy',
                                'AZRebalance',
                                'AlarmNotification',
                                'ScheduledActions',
                            ],
                        },
                        AutoScalingScheduledAction: {
                            IgnoreUnmodifiedGroupSizeProperties: true,
                        },
                    },
                },
            },
            Parameters: {
                SsmParameterValueawsserviceamiamazonlinuxlatestamznamihvmx8664gp2C96584B6F00A464EAD1953AFF4B05118Parameter: {
                    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>',
                    Default: '/aws/service/ami-amazon-linux-latest/amzn-ami-hvm-x86_64-gp2',
                },
            },
        });
    });
    test('scheduled scaling shows warning when minute is not defined in cron', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutInTheMorning', {
            schedule: autoscaling.Schedule.cron({ hour: '8' }),
            minCapacity: 10,
        });
        // THEN
        assertions_1.Annotations.fromStack(stack).hasWarning('/Default/ASG/ScheduledActionScaleOutInTheMorning', "cron: If you don't pass 'minute', by default the event runs every minute. Pass 'minute: '*'' if that's what you intend, or 'minute: 0' to run once per hour instead.");
    });
    test('scheduled scaling shows no warning when minute is * in cron', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        // WHEN
        asg.scaleOnSchedule('ScaleOutInTheMorning', {
            schedule: autoscaling.Schedule.cron({
                hour: '8',
                minute: '*',
            }),
            minCapacity: 10,
        });
        // THEN
        const annotations = assertions_1.Annotations.fromStack(stack).findWarning('*', assertions_1.Match.anyValue());
        expect(annotations.length).toBe(0);
    });
    test('ScheduledActions have a name', () => {
        // GIVEN
        const stack = new cdk.Stack();
        const asg = makeAutoScalingGroup(stack);
        const action = asg.scaleOnSchedule('ScaleOutAtMiddaySeoul', {
            schedule: autoscaling.Schedule.cron({ hour: '12', minute: '0' }),
            minCapacity: 12,
            timeZone: 'Asia/Seoul',
        });
        expect(action.scheduledActionName).toBeDefined();
    });
});
function makeAutoScalingGroup(scope) {
    const vpc = new ec2.Vpc(scope, 'VPC');
    return new autoscaling.AutoScalingGroup(scope, 'ASG', {
        vpc,
        instanceType: new ec2.InstanceType('t2.micro'),
        machineImage: new ec2.AmazonLinuxImage(),
        updateType: autoscaling.UpdateType.ROLLING_UPDATE,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVkLWFjdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2NoZWR1bGVkLWFjdGlvbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQWdFO0FBQ2hFLHFDQUFxQztBQUNyQyw4REFBOEQ7QUFDOUQsa0NBQWtDO0FBRWxDLHNDQUFzQztBQUV0QyxJQUFBLG9DQUFrQixFQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUMxQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO1FBQ2xDLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV4QyxPQUFPO1FBQ1AsR0FBRyxDQUFDLGVBQWUsQ0FBQyxzQkFBc0IsRUFBRTtZQUMxQyxRQUFRLEVBQUUsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUMvRCxXQUFXLEVBQUUsRUFBRTtTQUNoQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsbUNBQW1DLEVBQUU7WUFDbkYsVUFBVSxFQUFFLFdBQVc7WUFDdkIsT0FBTyxFQUFFLEVBQUU7U0FDWixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7UUFDMUMsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLE1BQU0sR0FBRyxHQUFHLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXhDLE9BQU87UUFDUCxHQUFHLENBQUMsZUFBZSxDQUFDLHNC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VUFBVSxDQUFDO1FBQzlDLFlBQVksRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRTtRQUN4QyxVQUFVLEVBQUUsV0FBVyxDQUFDLFVBQVUsQ0FBQyxjQUFjO0tBQ2xELENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbm5vdGF0aW9ucywgTWF0Y2gsIFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnLi4vLi4vYXdzLWVjMic7XG5pbXBvcnQgeyBkZXNjcmliZURlcHJlY2F0ZWQgfSBmcm9tICdAYXdzLWNkay9jZGstYnVpbGQtdG9vbHMnO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgY29uc3RydWN0cyBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGF1dG9zY2FsaW5nIGZyb20gJy4uL2xpYic7XG5cbmRlc2NyaWJlRGVwcmVjYXRlZCgnc2NoZWR1bGVkIGFjdGlvbicsICgpID0+IHtcbiAgdGVzdCgnY2FuIHNjaGVkdWxlIGFuIGFjdGlvbicsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IGFzZyA9IG1ha2VBdXRvU2NhbGluZ0dyb3VwKHN0YWNrKTtcblxuICAgIC8vIFdIRU5cbiAgICBhc2cuc2NhbGVPblNjaGVkdWxlKCdTY2FsZU91dEluVGhlTW9ybmluZycsIHtcbiAgICAgIHNjaGVkdWxlOiBhdXRvc2NhbGluZy5TY2hlZHVsZS5jcm9uKHsgaG91cjogJzgnLCBtaW51dGU6ICcwJyB9KSxcbiAgICAgIG1pbkNhcGFjaXR5OiAxMCxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBdXRvU2NhbGluZzo6U2NoZWR1bGVkQWN0aW9uJywge1xuICAgICAgUmVjdXJyZW5jZTogJzAgOCAqICogKicsXG4gICAgICBNaW5TaXplOiAxMCxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY29ycmVjdGx5IGZvcm1hdHMgZGF0ZSBvYmplY3RzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgYXNnID0gbWFrZUF1dG9TY2FsaW5nR3JvdXAoc3RhY2spO1xuXG4gICAgLy8gV0hFTlxuICAgIGFzZy5zY2FsZU9uU2NoZWR1bGUoJ1NjYWxlT3V0SW5UaGVNb3JuaW5nJywge1xuICAgICAgc2NoZWR1bGU6IGF1dG9zY2FsaW5nLlNjaGVkdWxlLmNyb24oeyBob3VyOiAnOCcgfSksXG4gICAgICBzdGFydFRpbWU6IG5ldyBEYXRlKERhdGUuVVRDKDIwMzMsIDgsIDEwLCAxMiwgMCwgMCkpLCAvLyBKYXZhU2NyaXB0J3MgRGF0ZSBpcyBhIGxpdHRsZSBzaWxseS5cbiAgICAgIG1pbkNhcGFjaXR5OiAxMSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpBdXRvU2NhbGluZzo6U2NoZWR1bGVkQWN0aW9uJywge1xuICAgICAgU3RhcnRUaW1lOiAnMjAzMy0wOS0xMFQxMjowMDowMFonLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdoYXZlIHRpbWV6b25lIHByb3BlcnR5JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgYXNnID0gbWFrZUF1dG9TY2FsaW5nR3JvdXAoc3RhY2spO1xuXG4gICAgLy8gV0hFTlxuICAgIGFzZy5zY2FsZU9uU2NoZWR1bGUoJ1NjYWxlT3V0QXRNaWRkYXlTZW91bCcsIHtcbiAgICAgIHNjaGVkdWxlOiBhdXRvc2NhbGluZy5TY2hlZHVsZS5jcm9uKHsgaG91cjogJzEyJywgbWludXRlOiAnMCcgfSksXG4gICAgICBtaW5DYXBhY2l0eTogMTIsXG4gICAgICB0aW1lWm9uZTogJ0FzaWEvU2VvdWwnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkF1dG9TY2FsaW5nOjpTY2hlZHVsZWRBY3Rpb24nLCB7XG4gICAgICBNaW5TaXplOiAxMixcbiAgICAgIFJlY3VycmVuY2U6ICcwIDEyICogKiAqJyxcbiAgICAgIFRpbWVab25lOiAnQXNpYS9TZW91bCcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2F1dG9zY2FsaW5nIGdyb3VwIGhhcyByZWNvbW1lbmRlZCB1cGRhdGVwb2xpY3kgZm9yIHNjaGVkdWxlZCBhY3Rpb25zJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgYXNnID0gbWFrZUF1dG9TY2FsaW5nR3JvdXAoc3RhY2spO1xuXG4gICAgLy8gV0hFTlxuICAgIGFzZy5zY2FsZU9uU2NoZWR1bGUoJ1NjYWxlT3V0SW5UaGVNb3JuaW5nJywge1xuICAgICAgc2NoZWR1bGU6IGF1dG9zY2FsaW5nLlNjaGVkdWxlLmNyb24oeyBob3VyOiAnOCcgfSksXG4gICAgICBtaW5DYXBhY2l0eTogMTAsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS50ZW1wbGF0ZU1hdGNoZXMoe1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEFTRzQ2RUQzMDcwOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6QXV0b1NjYWxpbmc6OkF1dG9TY2FsaW5nR3JvdXAnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIE1heFNpemU6ICcxJyxcbiAgICAgICAgICAgIE1pblNpemU6ICcxJyxcbiAgICAgICAgICAgIExhdW5jaENvbmZpZ3VyYXRpb25OYW1lOiB7IFJlZjogJ0FTR0xhdW5jaENvbmZpZ0MwMEFGMTJCJyB9LFxuICAgICAgICAgICAgVGFnczogW1xuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgS2V5OiAnTmFtZScsXG4gICAgICAgICAgICAgICAgUHJvcGFnYXRlQXRMYXVuY2g6IHRydWUsXG4gICAgICAgICAgICAgICAgVmFsdWU6ICdEZWZhdWx0L0FTRycsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgVlBDWm9uZUlkZW50aWZpZXI6IFtcbiAgICAgICAgICAgICAgeyBSZWY6ICdWUENQcml2YXRlU3VibmV0MVN1Ym5ldDhCQ0ExMEUwJyB9LFxuICAgICAgICAgICAgICB7IFJlZjogJ1ZQQ1ByaXZhdGVTdWJuZXQyU3VibmV0Q0ZDREFBN0EnIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgVXBkYXRlUG9saWN5OiB7XG4gICAgICAgICAgICBBdXRvU2NhbGluZ1JvbGxpbmdVcGRhdGU6IHtcbiAgICAgICAgICAgICAgV2FpdE9uUmVzb3VyY2VTaWduYWxzOiBmYWxzZSxcbiAgICAgICAgICAgICAgUGF1c2VUaW1lOiAnUFQwUycsXG4gICAgICAgICAgICAgIFN1c3BlbmRQcm9jZXNzZXM6IFtcbiAgICAgICAgICAgICAgICAnSGVhbHRoQ2hlY2snLFxuICAgICAgICAgICAgICAgICdSZXBsYWNlVW5oZWFsdGh5JyxcbiAgICAgICAgICAgICAgICAnQVpSZWJhbGFuY2UnLFxuICAgICAgICAgICAgICAgICdBbGFybU5vdGlmaWNhdGlvbicsXG4gICAgICAgICAgICAgICAgJ1NjaGVkdWxlZEFjdGlvbnMnLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIEF1dG9TY2FsaW5nU2NoZWR1bGVkQWN0aW9uOiB7XG4gICAgICAgICAgICAgIElnbm9yZVVubW9kaWZpZWRHcm91cFNpemVQcm9wZXJ0aWVzOiB0cnVlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgU3NtUGFyYW1ldGVyVmFsdWVhd3NzZXJ2aWNlYW1pYW1hem9ubGludXhsYXRlc3RhbXpuYW1paHZteDg2NjRncDJDOTY1ODRCNkYwMEE0NjRFQUQxOTUzQUZGNEIwNTExOFBhcmFtZXRlcjoge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlNTTTo6UGFyYW1ldGVyOjpWYWx1ZTxBV1M6OkVDMjo6SW1hZ2U6OklkPicsXG4gICAgICAgICAgRGVmYXVsdDogJy9hd3Mvc2VydmljZS9hbWktYW1hem9uLWxpbnV4LWxhdGVzdC9hbXpuLWFtaS1odm0teDg2XzY0LWdwMicsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdzY2hlZHVsZWQgc2NhbGluZyBzaG93cyB3YXJuaW5nIHdoZW4gbWludXRlIGlzIG5vdCBkZWZpbmVkIGluIGNyb24nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcbiAgICBjb25zdCBhc2cgPSBtYWtlQXV0b1NjYWxpbmdHcm91cChzdGFjayk7XG5cbiAgICAvLyBXSEVOXG4gICAgYXNnLnNjYWxlT25TY2hlZHVsZSgnU2NhbGVPdXRJblRoZU1vcm5pbmcnLCB7XG4gICAgICBzY2hlZHVsZTogYXV0b3NjYWxpbmcuU2NoZWR1bGUuY3Jvbih7IGhvdXI6ICc4JyB9KSxcbiAgICAgIG1pbkNhcGFjaXR5OiAxMCxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBBbm5vdGF0aW9ucy5mcm9tU3RhY2soc3RhY2spLmhhc1dhcm5pbmcoJy9EZWZhdWx0L0FTRy9TY2hlZHVsZWRBY3Rpb25TY2FsZU91dEluVGhlTW9ybmluZycsIFwiY3JvbjogSWYgeW91IGRvbid0IHBhc3MgJ21pbnV0ZScsIGJ5IGRlZmF1bHQgdGhlIGV2ZW50IHJ1bnMgZXZlcnkgbWludXRlLiBQYXNzICdtaW51dGU6ICcqJycgaWYgdGhhdCdzIHdoYXQgeW91IGludGVuZCwgb3IgJ21pbnV0ZTogMCcgdG8gcnVuIG9uY2UgcGVyIGhvdXIgaW5zdGVhZC5cIik7XG4gIH0pO1xuXG4gIHRlc3QoJ3NjaGVkdWxlZCBzY2FsaW5nIHNob3dzIG5vIHdhcm5pbmcgd2hlbiBtaW51dGUgaXMgKiBpbiBjcm9uJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gICAgY29uc3QgYXNnID0gbWFrZUF1dG9TY2FsaW5nR3JvdXAoc3RhY2spO1xuXG4gICAgLy8gV0hFTlxuICAgIGFzZy5zY2FsZU9uU2NoZWR1bGUoJ1NjYWxlT3V0SW5UaGVNb3JuaW5nJywge1xuICAgICAgc2NoZWR1bGU6IGF1dG9zY2FsaW5nLlNjaGVkdWxlLmNyb24oe1xuICAgICAgICBob3VyOiAnOCcsXG4gICAgICAgIG1pbnV0ZTogJyonLFxuICAgICAgfSksXG4gICAgICBtaW5DYXBhY2l0eTogMTAsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3QgYW5ub3RhdGlvbnMgPSBBbm5vdGF0aW9ucy5mcm9tU3RhY2soc3RhY2spLmZpbmRXYXJuaW5nKCcqJywgTWF0Y2guYW55VmFsdWUoKSk7XG4gICAgZXhwZWN0KGFubm90YXRpb25zLmxlbmd0aCkudG9CZSgwKTtcbiAgfSk7XG5cbiAgdGVzdCgnU2NoZWR1bGVkQWN0aW9ucyBoYXZlIGEgbmFtZScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICAgIGNvbnN0IGFzZyA9IG1ha2VBdXRvU2NhbGluZ0dyb3VwKHN0YWNrKTtcblxuICAgIGNvbnN0IGFjdGlvbiA9IGFzZy5zY2FsZU9uU2NoZWR1bGUoJ1NjYWxlT3V0QXRNaWRkYXlTZW91bCcsIHtcbiAgICAgIHNjaGVkdWxlOiBhdXRvc2NhbGluZy5TY2hlZHVsZS5jcm9uKHsgaG91cjogJzEyJywgbWludXRlOiAnMCcgfSksXG4gICAgICBtaW5DYXBhY2l0eTogMTIsXG4gICAgICB0aW1lWm9uZTogJ0FzaWEvU2VvdWwnLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KGFjdGlvbi5zY2hlZHVsZWRBY3Rpb25OYW1lKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiBtYWtlQXV0b1NjYWxpbmdHcm91cChzY29wZTogY29uc3RydWN0cy5Db25zdHJ1Y3QpIHtcbiAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGMoc2NvcGUsICdWUEMnKTtcbiAgcmV0dXJuIG5ldyBhdXRvc2NhbGluZy5BdXRvU2NhbGluZ0dyb3VwKHNjb3BlLCAnQVNHJywge1xuICAgIHZwYyxcbiAgICBpbnN0YW5jZVR5cGU6IG5ldyBlYzIuSW5zdGFuY2VUeXBlKCd0Mi5taWNybycpLFxuICAgIG1hY2hpbmVJbWFnZTogbmV3IGVjMi5BbWF6b25MaW51eEltYWdlKCksXG4gICAgdXBkYXRlVHlwZTogYXV0b3NjYWxpbmcuVXBkYXRlVHlwZS5ST0xMSU5HX1VQREFURSxcbiAgfSk7XG59XG4iXX0=