"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const cloudwatch = require("../../aws-cloudwatch");
const iam = require("../../aws-iam");
const logs = require("../../aws-logs");
const sns = require("../../aws-sns");
const cdk = require("../../core");
const chatbot = require("../lib");
describe('SlackChannelConfiguration', () => {
    let stack;
    beforeEach(() => {
        stack = new cdk.Stack();
    });
    test('created with minimal properties creates a new IAM Role', () => {
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Chatbot::SlackChannelConfiguration', {
            ConfigurationName: 'Test',
            IamRoleArn: {
                'Fn::GetAtt': [
                    'MySlackChannelConfigurationRole1D3F23AE',
                    'Arn',
                ],
            },
            SlackChannelId: 'DEF456',
            SlackWorkspaceId: 'ABC123',
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: {
                            Service: 'chatbot.amazonaws.com',
                        },
                    },
                ],
                Version: '2012-10-17',
            },
        });
    });
    test('created and pass loggingLevel parameter [LoggingLevel.ERROR], it should be set [ERROR] logging level in Cloudformation', () => {
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
            loggingLevel: chatbot.LoggingLevel.ERROR,
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Chatbot::SlackChannelConfiguration', {
            ConfigurationName: 'Test',
            IamRoleArn: {
                'Fn::GetAtt': [
                    'MySlackChannelConfigurationRole1D3F23AE',
                    'Arn',
                ],
            },
            SlackChannelId: 'DEF456',
            SlackWorkspaceId: 'ABC123',
            LoggingLevel: 'ERROR',
        });
    });
    test('created with new sns topic', () => {
        const topic = new sns.Topic(stack, 'MyTopic');
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
            notificationTopics: [topic],
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Chatbot::SlackChannelConfiguration', {
            ConfigurationName: 'Test',
            IamRoleArn: {
                'Fn::GetAtt': [
                    'MySlackChannelConfigurationRole1D3F23AE',
                    'Arn',
                ],
            },
            SlackChannelId: 'DEF456',
            SlackWorkspaceId: 'ABC123',
            SnsTopicArns: [
                {
                    Ref: 'MyTopic86869434',
                },
            ],
        });
    });
    test('allows adding a Topic after creating the SlackChannel', () => {
        const slackChannel = new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
        });
        const topic = new sns.Topic(stack, 'MyTopic');
        slackChannel.addNotificationTopic(topic);
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Chatbot::SlackChannelConfiguration', {
            ConfigurationName: 'Test',
            SnsTopicArns: [
                {
                    Ref: 'MyTopic86869434',
                },
            ],
        });
    });
    test('created with existing role', () => {
        const role = iam.Role.fromRoleArn(stack, 'Role', 'arn:aws:iam:::role/test-role');
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
            role: role,
        });
        assertions_1.Template.fromStack(stack).resourceCountIs('AWS::IAM::Role', 0);
    });
    test('created with new role and extra iam policies', () => {
        const slackChannel = new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'Test',
        });
        slackChannel.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                's3:GetObject',
            ],
            resources: ['arn:aws:s3:::abc/xyz/123.txt'],
        }));
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: [
                    {
                        Action: 's3:GetObject',
                        Effect: 'Allow',
                        Resource: 'arn:aws:s3:::abc/xyz/123.txt',
                    },
                ],
                Version: '2012-10-17',
            },
        });
    });
    test('specifying log retention', () => {
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'ConfigurationName',
            logRetention: logs.RetentionDays.ONE_MONTH,
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::LogRetention', {
            LogGroupName: '/aws/chatbot/ConfigurationName',
            RetentionInDays: 30,
            LogGroupRegion: 'us-east-1',
        });
    });
    test('getting configuration metric', () => {
        const slackChannel = new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'ConfigurationName',
            logRetention: logs.RetentionDays.ONE_MONTH,
        });
        const metric = slackChannel.metric('MetricName');
        new cloudwatch.Alarm(stack, 'Alarm', {
            evaluationPeriods: 1,
            threshold: 0,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            metric: metric,
        });
        expect(metric).toEqual(new cloudwatch.Metric({
            namespace: 'AWS/Chatbot',
            region: 'us-east-1',
            dimensionsMap: {
                ConfigurationName: 'ConfigurationName',
            },
            metricName: 'MetricName',
        }));
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudWatch::Alarm', {
            Namespace: 'AWS/Chatbot',
            MetricName: 'MetricName',
            Dimensions: [
                {
                    Name: 'ConfigurationName',
                    Value: 'ConfigurationName',
                },
            ],
            ComparisonOperator: 'GreaterThanThreshold',
            EvaluationPeriods: 1,
            Threshold: 0,
        });
    });
    test('getting all configurations metric', () => {
        const metric = chatbot.SlackChannelConfiguration.metricAll('MetricName');
        new cloudwatch.Alarm(stack, 'Alarm', {
            evaluationPeriods: 1,
            threshold: 0,
            comparisonOperator: cloudwatch.ComparisonOperator.GREATER_THAN_THRESHOLD,
            metric: metric,
        });
        expect(metric).toEqual(new cloudwatch.Metric({
            namespace: 'AWS/Chatbot',
            region: 'us-east-1',
            metricName: 'MetricName',
        }));
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudWatch::Alarm', {
            Namespace: 'AWS/Chatbot',
            MetricName: 'MetricName',
            Dimensions: assertions_1.Match.absent(),
            ComparisonOperator: 'GreaterThanThreshold',
            EvaluationPeriods: 1,
            Threshold: 0,
        });
    });
    test('added a iam policy to a from slack channel configuration ARN will nothing to do', () => {
        const imported = chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(stack, 'MySlackChannel', 'arn:aws:chatbot::1234567890:chat-configuration/slack-channel/my-slack');
        imported.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                's3:GetObject',
            ],
            resources: ['arn:aws:s3:::abc/xyz/123.txt'],
        }));
        assertions_1.Template.fromStack(stack).resourceCountIs('AWS::IAM::Role', 0);
        assertions_1.Template.fromStack(stack).resourceCountIs('AWS::IAM::Policy', 0);
    });
    test('should throw error if ARN invalid', () => {
        expect(() => chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(stack, 'MySlackChannel', 'arn:aws:chatbot::1234567890:chat-configuration/my-slack')).toThrow(/The ARN of a Slack integration must be in the form: arn:aws:chatbot:{region}:{account}:chat-configuration\/slack-channel\/{slackChannelName}/);
    });
    test('from slack channel configuration ARN', () => {
        const imported = chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(stack, 'MySlackChannel', 'arn:aws:chatbot::1234567890:chat-configuration/slack-channel/my-slack');
        expect(imported.slackChannelConfigurationName).toEqual('my-slack');
        expect(imported.slackChannelConfigurationArn).toEqual('arn:aws:chatbot::1234567890:chat-configuration/slack-channel/my-slack');
    });
    test('skip validation for tokenized values', () => {
        // invalid ARN because of underscores, no error because tokenized value
        expect(() => chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(stack, 'MySlackChannel', cdk.Lazy.string({ produce: () => 'arn:aws:chatbot::1234567890:chat-configuration/slack_channel/my_slack' }))).not.toThrow();
    });
    test('test name and ARN from slack channel configuration ARN', () => {
        const imported = chatbot.SlackChannelConfiguration.fromSlackChannelConfigurationArn(stack, 'MySlackChannel', cdk.Token.asString({ Ref: 'ARN' }));
        // THEN
        expect(stack.resolve(imported.slackChannelConfigurationName)).toStrictEqual({
            'Fn::Select': [1, { 'Fn::Split': ['slack-channel/', { 'Fn::Select': [1, { 'Fn::Split': [':chat-configuration/', { Ref: 'ARN' }] }] }] }],
        });
        expect(stack.resolve(imported.slackChannelConfigurationArn)).toStrictEqual({
            Ref: 'ARN',
        });
    });
    test('guardrail policy should be configured by ARN when specified', () => {
        new chatbot.SlackChannelConfiguration(stack, 'MySlackChannel', {
            slackWorkspaceId: 'ABC123',
            slackChannelId: 'DEF456',
            slackChannelConfigurationName: 'ConfigurationName',
            guardrailPolicies: [iam.ManagedPolicy.fromAwsManagedPolicyName('CloudWatchReadOnlyAccess')],
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Chatbot::SlackChannelConfiguration', {
            GuardrailPolicies: [
                { 'Fn::Join': ['', ['arn:', { Ref: 'AWS::Partition' }, ':iam::aws:policy/CloudWatchReadOnlyAccess']] },
            ],
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xhY2stY2hhbm5lbC1jb25maWd1cmF0aW9uLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzbGFjay1jaGFubmVsLWNvbmZpZ3VyYXRpb24udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFtRDtBQUNuRCxtREFBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLHVDQUF1QztBQUN2QyxxQ0FBcUM7QUFDckMsa0NBQWtDO0FBQ2xDLGtDQUFrQztBQUVsQyxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksS0FBZ0IsQ0FBQztJQUVyQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzFCLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHdEQUF3RCxFQUFFLEdBQUcsRUFBRTtRQUNsRSxJQUFJLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUU7WUFDN0QsZ0JBQWdCLEVBQUUsUUFBUTtZQUMxQixjQUFjLEVBQUUsUUFBUTtZQUN4Qiw2QkFBNkIsRUFBRSxNQUFNO1NBQ3RDLENBQUMsQ0FBQztRQUVILHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLHlDQUF5QyxFQUFFO1lBQ3pGLGlCQUFpQixFQUFFLE1BQU07WUFDekIsVUFBVSxFQUFFO2dCQUNWLFlBQVksRUFBRTtvQkFDWix5Q0FBeUM7b0JBQ3pDLEtBQUs7aUJBQ047YUFDRjtZQUNELGNBQWMsRUFBRSxRQUFRO1lBQ3hCLGdCQUFnQixFQUFFLFFBQVE7U0FDM0IsQ0FBQyxDQUFDO1FBRUgscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsZ0JBQWdCLEVBQUU7WUFDaEUsd0JBQXdCLEVBQUU7Z0JBQ3hCLFNBQVMsRUFBRTtvQkFDVDt3QkFDRSxNQUFNLEVB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RSxXQUFXLEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztTQUN6SSxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQztZQUN6RSxHQUFHLEVBQUUsS0FBSztTQUNYLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDZEQUE2RCxFQUFFLEdBQUcsRUFBRTtRQUN2RSxJQUFJLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUU7WUFDN0QsZ0JBQWdCLEVBQUUsUUFBUTtZQUMxQixjQUFjLEVBQUUsUUFBUTtZQUN4Qiw2QkFBNkIsRUFBRSxtQkFBbUI7WUFDbEQsaUJBQWlCLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLDBCQUEwQixDQUFDLENBQUM7U0FDNUYsQ0FBQyxDQUFDO1FBRUgscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMseUNBQXlDLEVBQUU7WUFDekYsaUJBQWlCLEVBQUU7Z0JBQ2pCLEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixFQUFFLEVBQUUsMkNBQTJDLENBQUMsQ0FBQyxFQUFFO2FBQ3ZHO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGNoLCBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgY2xvdWR3YXRjaCBmcm9tICcuLi8uLi9hd3MtY2xvdWR3YXRjaCc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBsb2dzIGZyb20gJy4uLy4uL2F3cy1sb2dzJztcbmltcG9ydCAqIGFzIHNucyBmcm9tICcuLi8uLi9hd3Mtc25zJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGNoYXRib3QgZnJvbSAnLi4vbGliJztcblxuZGVzY3JpYmUoJ1NsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gIGxldCBzdGFjazogY2RrLlN0YWNrO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICB9KTtcblxuICB0ZXN0KCdjcmVhdGVkIHdpdGggbWluaW1hbCBwcm9wZXJ0aWVzIGNyZWF0ZXMgYSBuZXcgSUFNIFJvbGUnLCAoKSA9PiB7XG4gICAgbmV3IGNoYXRib3QuU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbihzdGFjaywgJ015U2xhY2tDaGFubmVsJywge1xuICAgICAgc2xhY2tXb3Jrc3BhY2VJZDogJ0FCQzEyMycsXG4gICAgICBzbGFja0NoYW5uZWxJZDogJ0RFRjQ1NicsXG4gICAgICBzbGFja0NoYW5uZWxDb25maWd1cmF0aW9uTmFtZTogJ1Rlc3QnLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2hhdGJvdDo6U2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbicsIHtcbiAgICAgIENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgICBJYW1Sb2xlQXJuOiB7XG4gICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICdNeVNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25Sb2xlMUQzRjIzQUUnLFxuICAgICAgICAgICdBcm4nLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIFNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIFNsYWNrV29ya3NwYWNlSWQ6ICdBQkMxMjMnLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpSb2xlJywge1xuICAgICAgQXNzdW1lUm9sZVBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ3N0czpBc3N1bWVSb2xlJyxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgICBTZXJ2aWNlOiAnY2hhdGJvdC5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY3JlYXRlZCBhbmQgcGFzcyBsb2dnaW5nTGV2ZWwgcGFyYW1ldGVyIFtMb2dnaW5nTGV2ZWwuRVJST1JdLCBpdCBzaG91bGQgYmUgc2V0IFtFUlJPUl0gbG9nZ2luZyBsZXZlbCBpbiBDbG91ZGZvcm1hdGlvbicsICgpID0+IHtcbiAgICBuZXcgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCB7XG4gICAgICBzbGFja1dvcmtzcGFjZUlkOiAnQUJDMTIzJyxcbiAgICAgIHNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIHNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgICBsb2dnaW5nTGV2ZWw6IGNoYXRib3QuTG9nZ2luZ0xldmVsLkVSUk9SLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2hhdGJvdDo6U2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbicsIHtcbiAgICAgIENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgICBJYW1Sb2xlQXJuOiB7XG4gICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICdNeVNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25Sb2xlMUQzRjIzQUUnLFxuICAgICAgICAgICdBcm4nLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIFNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIFNsYWNrV29ya3NwYWNlSWQ6ICdBQkMxMjMnLFxuICAgICAgTG9nZ2luZ0xldmVsOiAnRVJST1InLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdjcmVhdGVkIHdpdGggbmV3IHNucyB0b3BpYycsICgpID0+IHtcbiAgICBjb25zdCB0b3BpYyA9IG5ldyBzbnMuVG9waWMoc3RhY2ssICdNeVRvcGljJyk7XG5cbiAgICBuZXcgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCB7XG4gICAgICBzbGFja1dvcmtzcGFjZUlkOiAnQUJDMTIzJyxcbiAgICAgIHNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIHNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgICBub3RpZmljYXRpb25Ub3BpY3M6IFt0b3BpY10sXG4gICAgfSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDaGF0Ym90OjpTbGFja0NoYW5uZWxDb25maWd1cmF0aW9uJywge1xuICAgICAgQ29uZmlndXJhdGlvbk5hbWU6ICdUZXN0JyxcbiAgICAgIElhbVJvbGVBcm46IHtcbiAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgJ015U2xhY2tDaGFubmVsQ29uZmlndXJhdGlvblJvbGUxRDNGMjNBRScsXG4gICAgICAgICAgJ0FybicsXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgU2xhY2tDaGFubmVsSWQ6ICdERUY0NTYnLFxuICAgICAgU2xhY2tXb3Jrc3BhY2VJZDogJ0FCQzEyMycsXG4gICAgICBTbnNUb3BpY0FybnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIFJlZjogJ015VG9waWM4Njg2OTQzNCcsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhbGxvd3MgYWRkaW5nIGEgVG9waWMgYWZ0ZXIgY3JlYXRpbmcgdGhlIFNsYWNrQ2hhbm5lbCcsICgpID0+IHtcbiAgICBjb25zdCBzbGFja0NoYW5uZWwgPSBuZXcgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCB7XG4gICAgICBzbGFja1dvcmtzcGFjZUlkOiAnQUJDMTIzJyxcbiAgICAgIHNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIHNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0b3BpYyA9IG5ldyBzbnMuVG9waWMoc3RhY2ssICdNeVRvcGljJyk7XG4gICAgc2xhY2tDaGFubmVsLmFkZE5vdGlmaWNhdGlvblRvcGljKHRvcGljKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNoYXRib3Q6OlNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb24nLCB7XG4gICAgICBDb25maWd1cmF0aW9uTmFtZTogJ1Rlc3QnLFxuICAgICAgU25zVG9waWNBcm5zOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBSZWY6ICdNeVRvcGljODY4Njk0MzQnLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY3JlYXRlZCB3aXRoIGV4aXN0aW5nIHJvbGUnLCAoKSA9PiB7XG4gICAgY29uc3Qgcm9sZSA9IGlhbS5Sb2xlLmZyb21Sb2xlQXJuKHN0YWNrLCAnUm9sZScsICdhcm46YXdzOmlhbTo6OnJvbGUvdGVzdC1yb2xlJyk7XG5cbiAgICBuZXcgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCB7XG4gICAgICBzbGFja1dvcmtzcGFjZUlkOiAnQUJDMTIzJyxcbiAgICAgIHNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIHNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lOiAnVGVzdCcsXG4gICAgICByb2xlOiByb2xlLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6SUFNOjpSb2xlJywgMCk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NyZWF0ZWQgd2l0aCBuZXcgcm9sZSBhbmQgZXh0cmEgaWFtIHBvbGljaWVzJywgKCkgPT4ge1xuICAgIGNvbnN0IHNsYWNrQ2hhbm5lbCA9IG5ldyBjaGF0Ym90LlNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb24oc3RhY2ssICdNeVNsYWNrQ2hhbm5lbCcsIHtcbiAgICAgIHNsYWNrV29ya3NwYWNlSWQ6ICdBQkMxMjMnLFxuICAgICAgc2xhY2tDaGFubmVsSWQ6ICdERUY0NTYnLFxuICAgICAgc2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbk5hbWU6ICdUZXN0JyxcbiAgICB9KTtcblxuICAgIHNsYWNrQ2hhbm5lbC5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgYWN0aW9uczogW1xuICAgICAgICAnczM6R2V0T2JqZWN0JyxcbiAgICAgIF0sXG4gICAgICByZXNvdXJjZXM6IFsnYXJuOmF3czpzMzo6OmFiYy94eXovMTIzLnR4dCddLFxuICAgIH0pKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uOiAnczM6R2V0T2JqZWN0JyxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFJlc291cmNlOiAnYXJuOmF3czpzMzo6OmFiYy94eXovMTIzLnR4dCcsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnc3BlY2lmeWluZyBsb2cgcmV0ZW50aW9uJywgKCkgPT4ge1xuICAgIG5ldyBjaGF0Ym90LlNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb24oc3RhY2ssICdNeVNsYWNrQ2hhbm5lbCcsIHtcbiAgICAgIHNsYWNrV29ya3NwYWNlSWQ6ICdBQkMxMjMnLFxuICAgICAgc2xhY2tDaGFubmVsSWQ6ICdERUY0NTYnLFxuICAgICAgc2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbk5hbWU6ICdDb25maWd1cmF0aW9uTmFtZScsXG4gICAgICBsb2dSZXRlbnRpb246IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfTU9OVEgsXG4gICAgfSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpMb2dSZXRlbnRpb24nLCB7XG4gICAgICBMb2dHcm91cE5hbWU6ICcvYXdzL2NoYXRib3QvQ29uZmlndXJhdGlvbk5hbWUnLFxuICAgICAgUmV0ZW50aW9uSW5EYXlzOiAzMCxcbiAgICAgIExvZ0dyb3VwUmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZ2V0dGluZyBjb25maWd1cmF0aW9uIG1ldHJpYycsICgpID0+IHtcbiAgICBjb25zdCBzbGFja0NoYW5uZWwgPSBuZXcgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCB7XG4gICAgICBzbGFja1dvcmtzcGFjZUlkOiAnQUJDMTIzJyxcbiAgICAgIHNsYWNrQ2hhbm5lbElkOiAnREVGNDU2JyxcbiAgICAgIHNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lOiAnQ29uZmlndXJhdGlvbk5hbWUnLFxuICAgICAgbG9nUmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXMuT05FX01PTlRILFxuICAgIH0pO1xuICAgIGNvbnN0IG1ldHJpYyA9IHNsYWNrQ2hhbm5lbC5tZXRyaWMoJ01ldHJpY05hbWUnKTtcbiAgICBuZXcgY2xvdWR3YXRjaC5BbGFybShzdGFjaywgJ0FsYXJtJywge1xuICAgICAgZXZhbHVhdGlvblBlcmlvZHM6IDEsXG4gICAgICB0aHJlc2hvbGQ6IDAsXG4gICAgICBjb21wYXJpc29uT3BlcmF0b3I6IGNsb3Vkd2F0Y2guQ29tcGFyaXNvbk9wZXJhdG9yLkdSRUFURVJfVEhBTl9USFJFU0hPTEQsXG4gICAgICBtZXRyaWM6IG1ldHJpYyxcbiAgICB9KTtcblxuICAgIGV4cGVjdChtZXRyaWMpLnRvRXF1YWwobmV3IGNsb3Vkd2F0Y2guTWV0cmljKHtcbiAgICAgIG5hbWVzcGFjZTogJ0FXUy9DaGF0Ym90JyxcbiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBkaW1lbnNpb25zTWFwOiB7XG4gICAgICAgIENvbmZpZ3VyYXRpb25OYW1lOiAnQ29uZmlndXJhdGlvbk5hbWUnLFxuICAgICAgfSxcbiAgICAgIG1ldHJpY05hbWU6ICdNZXRyaWNOYW1lJyxcbiAgICB9KSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2xvdWRXYXRjaDo6QWxhcm0nLCB7XG4gICAgICBOYW1lc3BhY2U6ICdBV1MvQ2hhdGJvdCcsXG4gICAgICBNZXRyaWNOYW1lOiAnTWV0cmljTmFtZScsXG4gICAgICBEaW1lbnNpb25zOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBOYW1lOiAnQ29uZmlndXJhdGlvbk5hbWUnLFxuICAgICAgICAgIFZhbHVlOiAnQ29uZmlndXJhdGlvbk5hbWUnLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIENvbXBhcmlzb25PcGVyYXRvcjogJ0dyZWF0ZXJUaGFuVGhyZXNob2xkJyxcbiAgICAgIEV2YWx1YXRpb25QZXJpb2RzOiAxLFxuICAgICAgVGhyZXNob2xkOiAwLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdnZXR0aW5nIGFsbCBjb25maWd1cmF0aW9ucyBtZXRyaWMnLCAoKSA9PiB7XG4gICAgY29uc3QgbWV0cmljID0gY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uLm1ldHJpY0FsbCgnTWV0cmljTmFtZScpO1xuICAgIG5ldyBjbG91ZHdhdGNoLkFsYXJtKHN0YWNrLCAnQWxhcm0nLCB7XG4gICAgICBldmFsdWF0aW9uUGVyaW9kczogMSxcbiAgICAgIHRocmVzaG9sZDogMCxcbiAgICAgIGNvbXBhcmlzb25PcGVyYXRvcjogY2xvdWR3YXRjaC5Db21wYXJpc29uT3BlcmF0b3IuR1JFQVRFUl9USEFOX1RIUkVTSE9MRCxcbiAgICAgIG1ldHJpYzogbWV0cmljLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KG1ldHJpYykudG9FcXVhbChuZXcgY2xvdWR3YXRjaC5NZXRyaWMoe1xuICAgICAgbmFtZXNwYWNlOiAnQVdTL0NoYXRib3QnLFxuICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIG1ldHJpY05hbWU6ICdNZXRyaWNOYW1lJyxcbiAgICB9KSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2xvdWRXYXRjaDo6QWxhcm0nLCB7XG4gICAgICBOYW1lc3BhY2U6ICdBV1MvQ2hhdGJvdCcsXG4gICAgICBNZXRyaWNOYW1lOiAnTWV0cmljTmFtZScsXG4gICAgICBEaW1lbnNpb25zOiBNYXRjaC5hYnNlbnQoKSxcbiAgICAgIENvbXBhcmlzb25PcGVyYXRvcjogJ0dyZWF0ZXJUaGFuVGhyZXNob2xkJyxcbiAgICAgIEV2YWx1YXRpb25QZXJpb2RzOiAxLFxuICAgICAgVGhyZXNob2xkOiAwLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhZGRlZCBhIGlhbSBwb2xpY3kgdG8gYSBmcm9tIHNsYWNrIGNoYW5uZWwgY29uZmlndXJhdGlvbiBBUk4gd2lsbCBub3RoaW5nIHRvIGRvJywgKCkgPT4ge1xuICAgIGNvbnN0IGltcG9ydGVkID0gY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uLmZyb21TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uQXJuKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCAnYXJuOmF3czpjaGF0Ym90OjoxMjM0NTY3ODkwOmNoYXQtY29uZmlndXJhdGlvbi9zbGFjay1jaGFubmVsL215LXNsYWNrJyk7XG5cbiAgICAoaW1wb3J0ZWQgYXMgY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uKS5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgYWN0aW9uczogW1xuICAgICAgICAnczM6R2V0T2JqZWN0JyxcbiAgICAgIF0sXG4gICAgICByZXNvdXJjZXM6IFsnYXJuOmF3czpzMzo6OmFiYy94eXovMTIzLnR4dCddLFxuICAgIH0pKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykucmVzb3VyY2VDb3VudElzKCdBV1M6OklBTTo6Um9sZScsIDApO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykucmVzb3VyY2VDb3VudElzKCdBV1M6OklBTTo6UG9saWN5JywgMCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCB0aHJvdyBlcnJvciBpZiBBUk4gaW52YWxpZCcsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4gY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uLmZyb21TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uQXJuKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCAnYXJuOmF3czpjaGF0Ym90OjoxMjM0NTY3ODkwOmNoYXQtY29uZmlndXJhdGlvbi9teS1zbGFjaycpKS50b1Rocm93KFxuICAgICAgL1RoZSBBUk4gb2YgYSBTbGFjayBpbnRlZ3JhdGlvbiBtdXN0IGJlIGluIHRoZSBmb3JtOiBhcm46YXdzOmNoYXRib3Q6e3JlZ2lvbn06e2FjY291bnR9OmNoYXQtY29uZmlndXJhdGlvblxcL3NsYWNrLWNoYW5uZWxcXC97c2xhY2tDaGFubmVsTmFtZX0vLFxuICAgICk7XG4gIH0pO1xuXG4gIHRlc3QoJ2Zyb20gc2xhY2sgY2hhbm5lbCBjb25maWd1cmF0aW9uIEFSTicsICgpID0+IHtcbiAgICBjb25zdCBpbXBvcnRlZCA9IGNoYXRib3QuU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbi5mcm9tU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbkFybihzdGFjaywgJ015U2xhY2tDaGFubmVsJywgJ2Fybjphd3M6Y2hhdGJvdDo6MTIzNDU2Nzg5MDpjaGF0LWNvbmZpZ3VyYXRpb24vc2xhY2stY2hhbm5lbC9teS1zbGFjaycpO1xuXG4gICAgZXhwZWN0KGltcG9ydGVkLnNsYWNrQ2hhbm5lbENvbmZpZ3VyYXRpb25OYW1lKS50b0VxdWFsKCdteS1zbGFjaycpO1xuICAgIGV4cGVjdChpbXBvcnRlZC5zbGFja0NoYW5uZWxDb25maWd1cmF0aW9uQXJuKS50b0VxdWFsKCdhcm46YXdzOmNoYXRib3Q6OjEyMzQ1Njc4OTA6Y2hhdC1jb25maWd1cmF0aW9uL3NsYWNrLWNoYW5uZWwvbXktc2xhY2snKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2tpcCB2YWxpZGF0aW9uIGZvciB0b2tlbml6ZWQgdmFsdWVzJywgKCkgPT4ge1xuICAgIC8vIGludmFsaWQgQVJOIGJlY2F1c2Ugb2YgdW5kZXJzY29yZXMsIG5vIGVycm9yIGJlY2F1c2UgdG9rZW5pemVkIHZhbHVlXG4gICAgZXhwZWN0KCgpID0+IGNoYXRib3QuU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbi5mcm9tU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbkFybihzdGFjaywgJ015U2xhY2tDaGFubmVsJyxcbiAgICAgIGNkay5MYXp5LnN0cmluZyh7IHByb2R1Y2U6ICgpID0+ICdhcm46YXdzOmNoYXRib3Q6OjEyMzQ1Njc4OTA6Y2hhdC1jb25maWd1cmF0aW9uL3NsYWNrX2NoYW5uZWwvbXlfc2xhY2snIH0pKSkubm90LnRvVGhyb3coKTtcbiAgfSk7XG5cbiAgdGVzdCgndGVzdCBuYW1lIGFuZCBBUk4gZnJvbSBzbGFjayBjaGFubmVsIGNvbmZpZ3VyYXRpb24gQVJOJywgKCkgPT4ge1xuICAgIGNvbnN0IGltcG9ydGVkID0gY2hhdGJvdC5TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uLmZyb21TbGFja0NoYW5uZWxDb25maWd1cmF0aW9uQXJuKHN0YWNrLCAnTXlTbGFja0NoYW5uZWwnLCBjZGsuVG9rZW4uYXNTdHJpbmcoeyBSZWY6ICdBUk4nIH0pKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZShpbXBvcnRlZC5zbGFja0NoYW5uZWxDb25maWd1cmF0aW9uTmFtZSkpLnRvU3RyaWN0RXF1YWwoe1xuICAgICAgJ0ZuOjpTZWxlY3QnOiBbMSwgeyAnRm46OlNwbGl0JzogWydzbGFjay1jaGFubmVsLycsIHvCoCdGbjo6U2VsZWN0JzogWzEsIHsgJ0ZuOjpTcGxpdCc6IFsnOmNoYXQtY29uZmlndXJhdGlvbi8nLCB7IFJlZjogJ0FSTicgfV0gfV0gfV0gfV0sXG4gICAgfSk7XG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUoaW1wb3J0ZWQuc2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbkFybikpLnRvU3RyaWN0RXF1YWwoe1xuICAgICAgUmVmOiAnQVJOJyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZ3VhcmRyYWlsIHBvbGljeSBzaG91bGQgYmUgY29uZmlndXJlZCBieSBBUk4gd2hlbiBzcGVjaWZpZWQnLCAoKSA9PiB7XG4gICAgbmV3IGNoYXRib3QuU2xhY2tDaGFubmVsQ29uZmlndXJhdGlvbihzdGFjaywgJ015U2xhY2tDaGFubmVsJywge1xuICAgICAgc2xhY2tXb3Jrc3BhY2VJZDogJ0FCQzEyMycsXG4gICAgICBzbGFja0NoYW5uZWxJZDogJ0RFRjQ1NicsXG4gICAgICBzbGFja0NoYW5uZWxDb25maWd1cmF0aW9uTmFtZTogJ0NvbmZpZ3VyYXRpb25OYW1lJyxcbiAgICAgIGd1YXJkcmFpbFBvbGljaWVzOiBbaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdDbG91ZFdhdGNoUmVhZE9ubHlBY2Nlc3MnKV0sXG4gICAgfSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDaGF0Ym90OjpTbGFja0NoYW5uZWxDb25maWd1cmF0aW9uJywge1xuICAgICAgR3VhcmRyYWlsUG9saWNpZXM6IFtcbiAgICAgICAgeyAnRm46OkpvaW4nOiBbJycsIFsnYXJuOicsIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sICc6aWFtOjphd3M6cG9saWN5L0Nsb3VkV2F0Y2hSZWFkT25seUFjY2VzcyddXSB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfSk7XG59KTsiXX0=