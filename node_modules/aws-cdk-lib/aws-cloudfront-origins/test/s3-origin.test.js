"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const cloudfront = require("../../aws-cloudfront");
const s3 = require("../../aws-s3");
const core_1 = require("../../core");
const lib_1 = require("../lib");
let app;
let stack;
beforeEach(() => {
    app = new core_1.App();
    stack = new core_1.Stack(app, 'Stack');
});
describe('With bucket', () => {
    test('renders minimal example', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const origin = new lib_1.S3Origin(bucket);
        const originBindConfig = origin.bind(stack, { originId: 'StackOrigin029E19582' });
        expect(stack.resolve(originBindConfig.originProperty)).toEqual({
            id: 'StackOrigin029E19582',
            domainName: { 'Fn::GetAtt': ['Bucket83908E77', 'RegionalDomainName'] },
            s3OriginConfig: {
                originAccessIdentity: {
                    'Fn::Join': ['',
                        [
                            'origin-access-identity/cloudfront/',
                            { Ref: 'S3Origin83A0717C' },
                        ]],
                },
            },
        });
    });
    test('can customize base origin properties', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const origin = new lib_1.S3Origin(bucket, {
            originPath: '/assets',
            connectionTimeout: core_1.Duration.seconds(5),
            connectionAttempts: 2,
            customHeaders: { AUTH: 'NONE' },
        });
        const originBindConfig = origin.bind(stack, { originId: 'StackOrigin029E19582' });
        expect(stack.resolve(originBindConfig.originProperty)).toEqual({
            id: 'StackOrigin029E19582',
            domainName: { 'Fn::GetAtt': ['Bucket83908E77', 'RegionalDomainName'] },
            originPath: '/assets',
            connectionTimeout: 5,
            connectionAttempts: 2,
            originCustomHeaders: [{
                    headerName: 'AUTH',
                    headerValue: 'NONE',
                }],
            s3OriginConfig: {
                originAccessIdentity: {
                    'Fn::Join': ['',
                        [
                            'origin-access-identity/cloudfront/',
                            { Ref: 'S3Origin83A0717C' },
                        ]],
                },
            },
        });
    });
    test('can customize OriginAccessIdentity property', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const originAccessIdentity = new cloudfront.OriginAccessIdentity(stack, 'OriginAccessIdentity', {
            comment: 'Identity for bucket provided by test',
        });
        const origin = new lib_1.S3Origin(bucket, { originAccessIdentity });
        new cloudfront.Distribution(stack, 'Dist', { defaultBehavior: { origin } });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudFront::CloudFrontOriginAccessIdentity', {
            CloudFrontOriginAccessIdentityConfig: {
                Comment: 'Identity for bucket provided by test',
            },
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::S3::BucketPolicy', {
            PolicyDocument: {
                Statement: [{
                        Action: 's3:GetObject',
                        Effect: 'Allow',
                        Principal: {
                            CanonicalUser: { 'Fn::GetAtt': ['OriginAccessIdentityDF1E3CAC', 'S3CanonicalUserId'] },
                        },
                        Resource: {
                            'Fn::Join': ['', [{ 'Fn::GetAtt': ['Bucket83908E77', 'Arn'] }, '/*']],
                        },
                    }],
            },
        });
    });
    test('creates an OriginAccessIdentity and grants read permissions on the bucket', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const origin = new lib_1.S3Origin(bucket);
        new cloudfront.Distribution(stack, 'Dist', { defaultBehavior: { origin } });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudFront::CloudFrontOriginAccessIdentity', {
            CloudFrontOriginAccessIdentityConfig: {
                Comment: 'Identity for StackDistOrigin15754CE84',
            },
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::S3::BucketPolicy', {
            PolicyDocument: {
                Statement: [{
                        Action: 's3:GetObject',
                        Effect: 'Allow',
                        Principal: {
                            CanonicalUser: { 'Fn::GetAtt': ['DistOrigin1S3Origin87D64058', 'S3CanonicalUserId'] },
                        },
                        Resource: {
                            'Fn::Join': ['', [{ 'Fn::GetAtt': ['Bucket83908E77', 'Arn'] }, '/*']],
                        },
                    }],
            },
        });
    });
    test('as a cross-stack reference', () => {
        // Bucket stack and bucket
        const bucketStack = new core_1.Stack(app, 'BucketStack');
        const bucket = new s3.Bucket(bucketStack, 'Bucket');
        // Distribution stack and distribution
        const origin = new lib_1.S3Origin(bucket);
        new cloudfront.Distribution(stack, 'Dist', { defaultBehavior: { origin } });
        assertions_1.Template.fromStack(stack).resourceCountIs('AWS::CloudFront::Distribution', 1);
        assertions_1.Template.fromStack(bucketStack).resourceCountIs('AWS::S3::Bucket', 1);
        assertions_1.Template.fromStack(bucketStack).hasResourceProperties('AWS::CloudFront::CloudFrontOriginAccessIdentity', {
            CloudFrontOriginAccessIdentityConfig: {
                Comment: 'Identity for StackDistOrigin15754CE84',
            },
        });
        assertions_1.Template.fromStack(bucketStack).hasResourceProperties('AWS::S3::BucketPolicy', {
            PolicyDocument: {
                Statement: [assertions_1.Match.objectLike({
                        Principal: {
                            CanonicalUser: { 'Fn::GetAtt': ['StackDistOrigin15754CE84S3Origin25582A25', 'S3CanonicalUserId'] },
                        },
                    })],
            },
        });
    });
    test('Can set a custom originId', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const bucket2 = new s3.Bucket(stack, 'Bucket2');
        const origin2 = new lib_1.S3Origin(bucket2, { originId: 'MyOtherCustomOrigin' });
        const origin = new lib_1.S3Origin(bucket, { originId: 'MyCustomOrigin' });
        const distro = new cloudfront.Distribution(stack, 'Dist', {
            defaultBehavior: { origin },
        });
        distro.addBehavior('/test', origin2);
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudFront::Distribution', {
            DistributionConfig: {
                CacheBehaviors: [
                    {
                        CachePolicyId: '658327ea-f89d-4fab-a63d-7e88639e58f6',
                        Compress: true,
                        PathPattern: '/test',
                        TargetOriginId: 'MyOtherCustomOrigin',
                        ViewerProtocolPolicy: 'allow-all',
                    },
                ],
                DefaultCacheBehavior: {
                    CachePolicyId: '658327ea-f89d-4fab-a63d-7e88639e58f6',
                    Compress: true,
                    TargetOriginId: 'MyCustomOrigin',
                    ViewerProtocolPolicy: 'allow-all',
                },
                Origins: [
                    {
                        Id: 'MyCustomOrigin',
                    },
                    {
                        Id: 'MyOtherCustomOrigin',
                    },
                ],
            },
        });
    });
    test('Cannot set an originId duplicates', () => {
        const bucket = new s3.Bucket(stack, 'Bucket');
        const bucket2 = new s3.Bucket(stack, 'Bucket2');
        const origin = new lib_1.S3Origin(bucket, { originId: 'MyCustomOrigin' });
        const origin2 = new lib_1.S3Origin(bucket2, { originId: 'MyCustomOrigin' });
        expect(() => {
            new cloudfront.Distribution(stack, 'Dist', {
                defaultBehavior: { origin },
                additionalBehaviors: {
                    Origin2: {
                        origin: origin2,
                    },
                },
            });
        }).toThrow(/Origin with id MyCustomOrigin already exists/);
    });
});
describe('With website-configured bucket', () => {
    test('renders all required properties, including custom origin config', () => {
        const bucket = new s3.Bucket(stack, 'Bucket', {
            websiteIndexDocument: 'index.html',
        });
        const origin = new lib_1.S3Origin(bucket);
        const originBindConfig = origin.bind(stack, { originId: 'StackOrigin029E19582' });
        expect(originBindConfig.originProperty).toEqual({
            id: 'StackOrigin029E19582',
            domainName: bucket.bucketWebsiteDomainName,
            customOriginConfig: {
                originProtocolPolicy: 'http-only',
                originSslProtocols: [
                    'TLSv1.2',
                ],
            },
        });
    });
    test('can customize properties', () => {
        const bucket = new s3.Bucket(stack, 'Bucket', {
            websiteIndexDocument: 'index.html',
        });
        const origin = new lib_1.S3Origin(bucket, { originPath: '/assets' });
        const originBindConfig = origin.bind(stack, { originId: 'StackOrigin029E19582' });
        expect(originBindConfig.originProperty).toEqual({
            id: 'StackOrigin029E19582',
            domainName: bucket.bucketWebsiteDomainName,
            originPath: '/assets',
            customOriginConfig: {
                originProtocolPolicy: 'http-only',
                originSslProtocols: [
                    'TLSv1.2',
                ],
            },
        });
    });
    test('Can set an originId', () => {
        const bucket = new s3.Bucket(stack, 'Bucket', {
            websiteIndexDocument: 'index.html',
        });
        const origin = new lib_1.S3Origin(bucket, { originId: 'MyCustomOrigin' });
        new cloudfront.Distribution(stack, 'Dist', { defaultBehavior: { origin } });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CloudFront::Distribution', {
            DistributionConfig: {
                Origins: [{
                        Id: 'MyCustomOrigin',
                    }],
            },
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczMtb3JpZ2luLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzMy1vcmlnaW4udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFtRDtBQUNuRCxtREFBbUQ7QUFDbkQsbUNBQW1DO0FBQ25DLHFDQUFrRDtBQUNsRCxnQ0FBa0M7QUFFbEMsSUFBSSxHQUFRLENBQUM7QUFDYixJQUFJLEtBQVksQ0FBQztBQUVqQixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7SUFDaEIsS0FBSyxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNsQyxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQzNCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7UUFDbkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUU5QyxNQUFNLE1BQU0sR0FBRyxJQUFJLGNBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwQyxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsUUFBUSxFQUFFLHNCQUFzQixFQUFFLENBQUMsQ0FBQztRQUVsRixNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUM3RCxFQUFFLEVBQUUsc0JBQXNCO1lBQzFCLFVBQVUsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLGdCQUFnQixFQUFFLG9CQUFvQixDQUFDLEVBQUU7WUFDdEUsY0FBYyxFQUFFO2dCQUNkLG9CQUFvQixFQUFFO29CQUNwQixVQUFVLEVBQUUsQ0FBQyxFQUFFO3dCQUNiOzRCQUNFLG9DQUFvQzs0QkFDcEMsRUFBRSxH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SUFFSCxJQUFJLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLE1BQU0sTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO1lBQzVDLG9CQUFvQixFQUFFLFlBQVk7U0FDbkMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsSUFBSSxjQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFLENBQUMsQ0FBQztRQUNwRSxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLGVBQWUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM1RSxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQywrQkFBK0IsRUFBRTtZQUMvRSxrQkFBa0IsRUFBRTtnQkFDbEIsT0FBTyxFQUFFLENBQUM7d0JBQ1IsRUFBRSxFQUFFLGdCQUFnQjtxQkFDckIsQ0FBQzthQUNIO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGNoLCBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgY2xvdWRmcm9udCBmcm9tICcuLi8uLi9hd3MtY2xvdWRmcm9udCc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICcuLi8uLi9hd3MtczMnO1xuaW1wb3J0IHsgQXBwLCBEdXJhdGlvbiwgU3RhY2sgfSBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCB7IFMzT3JpZ2luIH0gZnJvbSAnLi4vbGliJztcblxubGV0IGFwcDogQXBwO1xubGV0IHN0YWNrOiBTdGFjaztcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBBcHAoKTtcbiAgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnU3RhY2snKTtcbn0pO1xuXG5kZXNjcmliZSgnV2l0aCBidWNrZXQnLCAoKSA9PiB7XG4gIHRlc3QoJ3JlbmRlcnMgbWluaW1hbCBleGFtcGxlJywgKCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcblxuICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBTM09yaWdpbihidWNrZXQpO1xuICAgIGNvbnN0IG9yaWdpbkJpbmRDb25maWcgPSBvcmlnaW4uYmluZChzdGFjaywgeyBvcmlnaW5JZDogJ1N0YWNrT3JpZ2luMDI5RTE5NTgyJyB9KTtcblxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKG9yaWdpbkJpbmRDb25maWcub3JpZ2luUHJvcGVydHkpKS50b0VxdWFsKHtcbiAgICAgIGlkOiAnU3RhY2tPcmlnaW4wMjlFMTk1ODInLFxuICAgICAgZG9tYWluTmFtZTogeyAnRm46OkdldEF0dCc6IFsnQnVja2V0ODM5MDhFNzcnLCAnUmVnaW9uYWxEb21haW5OYW1lJ10gfSxcbiAgICAgIHMzT3JpZ2luQ29uZmlnOiB7XG4gICAgICAgIG9yaWdpbkFjY2Vzc0lkZW50aXR5OiB7XG4gICAgICAgICAgJ0ZuOjpKb2luJzogWycnLFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAnb3JpZ2luLWFjY2Vzcy1pZGVudGl0eS9jbG91ZGZyb250LycsXG4gICAgICAgICAgICAgIHsgUmVmOiAnUzNPcmlnaW44M0EwNzE3QycgfSxcbiAgICAgICAgICAgIF1dLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIGN1c3RvbWl6ZSBiYXNlIG9yaWdpbiBwcm9wZXJ0aWVzJywgKCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcblxuICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBTM09yaWdpbihidWNrZXQsIHtcbiAgICAgIG9yaWdpblBhdGg6ICcvYXNzZXRzJyxcbiAgICAgIGNvbm5lY3Rpb25UaW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDUpLFxuICAgICAgY29ubmVjdGlvbkF0dGVtcHRzOiAyLFxuICAgICAgY3VzdG9tSGVhZGVyczogeyBBVVRIOiAnTk9ORScgfSxcbiAgICB9KTtcbiAgICBjb25zdCBvcmlnaW5CaW5kQ29uZmlnID0gb3JpZ2luLmJpbmQoc3RhY2ssIHsgb3JpZ2luSWQ6ICdTdGFja09yaWdpbjAyOUUxOTU4MicgfSk7XG5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZShvcmlnaW5CaW5kQ29uZmlnLm9yaWdpblByb3BlcnR5KSkudG9FcXVhbCh7XG4gICAgICBpZDogJ1N0YWNrT3JpZ2luMDI5RTE5NTgyJyxcbiAgICAgIGRvbWFpbk5hbWU6IHsgJ0ZuOjpHZXRBdHQnOiBbJ0J1Y2tldDgzOTA4RTc3JywgJ1JlZ2lvbmFsRG9tYWluTmFtZSddIH0sXG4gICAgICBvcmlnaW5QYXRoOiAnL2Fzc2V0cycsXG4gICAgICBjb25uZWN0aW9uVGltZW91dDogNSxcbiAgICAgIGNvbm5lY3Rpb25BdHRlbXB0czogMixcbiAgICAgIG9yaWdpbkN1c3RvbUhlYWRlcnM6IFt7XG4gICAgICAgIGhlYWRlck5hbWU6ICdBVVRIJyxcbiAgICAgICAgaGVhZGVyVmFsdWU6ICdOT05FJyxcbiAgICAgIH1dLFxuICAgICAgczNPcmlnaW5Db25maWc6IHtcbiAgICAgICAgb3JpZ2luQWNjZXNzSWRlbnRpdHk6IHtcbiAgICAgICAgICAnRm46OkpvaW4nOiBbJycsXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgICdvcmlnaW4tYWNjZXNzLWlkZW50aXR5L2Nsb3VkZnJvbnQvJyxcbiAgICAgICAgICAgICAgeyBSZWY6ICdTM09yaWdpbjgzQTA3MTdDJyB9LFxuICAgICAgICAgICAgXV0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gY3VzdG9taXplIE9yaWdpbkFjY2Vzc0lkZW50aXR5IHByb3BlcnR5JywgKCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcblxuICAgIGNvbnN0IG9yaWdpbkFjY2Vzc0lkZW50aXR5ID0gbmV3IGNsb3VkZnJvbnQuT3JpZ2luQWNjZXNzSWRlbnRpdHkoc3RhY2ssICdPcmlnaW5BY2Nlc3NJZGVudGl0eScsIHtcbiAgICAgIGNvbW1lbnQ6ICdJZGVudGl0eSBmb3IgYnVja2V0IHByb3ZpZGVkIGJ5IHRlc3QnLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgb3JpZ2luID0gbmV3IFMzT3JpZ2luKGJ1Y2tldCwgeyBvcmlnaW5BY2Nlc3NJZGVudGl0eSB9KTtcbiAgICBuZXcgY2xvdWRmcm9udC5EaXN0cmlidXRpb24oc3RhY2ssICdEaXN0JywgeyBkZWZhdWx0QmVoYXZpb3I6IHsgb3JpZ2luIH0gfSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDbG91ZEZyb250OjpDbG91ZEZyb250T3JpZ2luQWNjZXNzSWRlbnRpdHknLCB7XG4gICAgICBDbG91ZEZyb250T3JpZ2luQWNjZXNzSWRlbnRpdHlDb25maWc6IHtcbiAgICAgICAgQ29tbWVudDogJ0lkZW50aXR5IGZvciBidWNrZXQgcHJvdmlkZWQgYnkgdGVzdCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6UzM6OkJ1Y2tldFBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogW3tcbiAgICAgICAgICBBY3Rpb246ICdzMzpHZXRPYmplY3QnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgIENhbm9uaWNhbFVzZXI6IHsgJ0ZuOjpHZXRBdHQnOiBbJ09yaWdpbkFjY2Vzc0lkZW50aXR5REYxRTNDQUMnLCAnUzNDYW5vbmljYWxVc2VySWQnXSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgW3sgJ0ZuOjpHZXRBdHQnOiBbJ0J1Y2tldDgzOTA4RTc3JywgJ0FybiddIH0sICcvKiddXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NyZWF0ZXMgYW4gT3JpZ2luQWNjZXNzSWRlbnRpdHkgYW5kIGdyYW50cyByZWFkIHBlcm1pc3Npb25zIG9uIHRoZSBidWNrZXQnLCAoKSA9PiB7XG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldCcpO1xuXG4gICAgY29uc3Qgb3JpZ2luID0gbmV3IFMzT3JpZ2luKGJ1Y2tldCk7XG4gICAgbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHN0YWNrLCAnRGlzdCcsIHsgZGVmYXVsdEJlaGF2aW9yOiB7IG9yaWdpbiB9IH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q2xvdWRGcm9udDo6Q2xvdWRGcm9udE9yaWdpbkFjY2Vzc0lkZW50aXR5Jywge1xuICAgICAgQ2xvdWRGcm9udE9yaWdpbkFjY2Vzc0lkZW50aXR5Q29uZmlnOiB7XG4gICAgICAgIENvbW1lbnQ6ICdJZGVudGl0eSBmb3IgU3RhY2tEaXN0T3JpZ2luMTU3NTRDRTg0JyxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6UzM6OkJ1Y2tldFBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogW3tcbiAgICAgICAgICBBY3Rpb246ICdzMzpHZXRPYmplY3QnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgIENhbm9uaWNhbFVzZXI6IHsgJ0ZuOjpHZXRBdHQnOiBbJ0Rpc3RPcmlnaW4xUzNPcmlnaW44N0Q2NDA1OCcsICdTM0Nhbm9uaWNhbFVzZXJJZCddIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBSZXNvdXJjZToge1xuICAgICAgICAgICAgJ0ZuOjpKb2luJzogWycnLCBbeyAnRm46OkdldEF0dCc6IFsnQnVja2V0ODM5MDhFNzcnLCAnQXJuJ10gfSwgJy8qJ11dLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1dLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnYXMgYSBjcm9zcy1zdGFjayByZWZlcmVuY2UnLCAoKSA9PiB7XG4gICAgLy8gQnVja2V0IHN0YWNrIGFuZCBidWNrZXRcbiAgICBjb25zdCBidWNrZXRTdGFjayA9IG5ldyBTdGFjayhhcHAsICdCdWNrZXRTdGFjaycpO1xuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoYnVja2V0U3RhY2ssICdCdWNrZXQnKTtcblxuICAgIC8vIERpc3RyaWJ1dGlvbiBzdGFjayBhbmQgZGlzdHJpYnV0aW9uXG4gICAgY29uc3Qgb3JpZ2luID0gbmV3IFMzT3JpZ2luKGJ1Y2tldCk7XG4gICAgbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHN0YWNrLCAnRGlzdCcsIHsgZGVmYXVsdEJlaGF2aW9yOiB7IG9yaWdpbiB9IH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6Q2xvdWRGcm9udDo6RGlzdHJpYnV0aW9uJywgMSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKGJ1Y2tldFN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6UzM6OkJ1Y2tldCcsIDEpO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhidWNrZXRTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNsb3VkRnJvbnQ6OkNsb3VkRnJvbnRPcmlnaW5BY2Nlc3NJZGVudGl0eScsIHtcbiAgICAgIENsb3VkRnJvbnRPcmlnaW5BY2Nlc3NJZGVudGl0eUNvbmZpZzoge1xuICAgICAgICBDb21tZW50OiAnSWRlbnRpdHkgZm9yIFN0YWNrRGlzdE9yaWdpbjE1NzU0Q0U4NCcsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhidWNrZXRTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlMzOjpCdWNrZXRQb2xpY3knLCB7XG4gICAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFtNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgIENhbm9uaWNhbFVzZXI6IHsgJ0ZuOjpHZXRBdHQnOiBbJ1N0YWNrRGlzdE9yaWdpbjE1NzU0Q0U4NFMzT3JpZ2luMjU1ODJBMjUnLCAnUzNDYW5vbmljYWxVc2VySWQnXSB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0NhbiBzZXQgYSBjdXN0b20gb3JpZ2luSWQnLCAoKSA9PiB7XG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldCcpO1xuICAgIGNvbnN0IGJ1Y2tldDIgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQnVja2V0MicpO1xuICAgIGNvbnN0IG9yaWdpbjIgPSBuZXcgUzNPcmlnaW4oYnVja2V0MiwgeyBvcmlnaW5JZDogJ015T3RoZXJDdXN0b21PcmlnaW4nIH0pO1xuICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBTM09yaWdpbihidWNrZXQsIHsgb3JpZ2luSWQ6ICdNeUN1c3RvbU9yaWdpbicgfSk7XG4gICAgY29uc3QgZGlzdHJvID0gbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHN0YWNrLCAnRGlzdCcsIHtcbiAgICAgIGRlZmF1bHRCZWhhdmlvcjogeyBvcmlnaW4gfSxcbiAgICB9KTtcbiAgICBkaXN0cm8uYWRkQmVoYXZpb3IoJy90ZXN0Jywgb3JpZ2luMik7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDbG91ZEZyb250OjpEaXN0cmlidXRpb24nLCB7XG4gICAgICBEaXN0cmlidXRpb25Db25maWc6IHtcbiAgICAgICAgQ2FjaGVCZWhhdmlvcnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBDYWNoZVBvbGljeUlkOiAnNjU4MzI3ZWEtZjg5ZC00ZmFiLWE2M2QtN2U4ODYzOWU1OGY2JyxcbiAgICAgICAgICAgIENvbXByZXNzOiB0cnVlLFxuICAgICAgICAgICAgUGF0aFBhdHRlcm46ICcvdGVzdCcsXG4gICAgICAgICAgICBUYXJnZXRPcmlnaW5JZDogJ015T3RoZXJDdXN0b21PcmlnaW4nLFxuICAgICAgICAgICAgVmlld2VyUHJvdG9jb2xQb2xpY3k6ICdhbGxvdy1hbGwnLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIERlZmF1bHRDYWNoZUJlaGF2aW9yOiB7XG4gICAgICAgICAgQ2FjaGVQb2xpY3lJZDogJzY1ODMyN2VhLWY4OWQtNGZhYi1hNjNkLTdlODg2MzllNThmNicsXG4gICAgICAgICAgQ29tcHJlc3M6IHRydWUsXG4gICAgICAgICAgVGFyZ2V0T3JpZ2luSWQ6ICdNeUN1c3RvbU9yaWdpbicsXG4gICAgICAgICAgVmlld2VyUHJvdG9jb2xQb2xpY3k6ICdhbGxvdy1hbGwnLFxuICAgICAgICB9LFxuICAgICAgICBPcmlnaW5zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgSWQ6ICdNeUN1c3RvbU9yaWdpbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBJZDogJ015T3RoZXJDdXN0b21PcmlnaW4nLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbiAgdGVzdCgnQ2Fubm90IHNldCBhbiBvcmlnaW5JZCBkdXBsaWNhdGVzJywgKCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcbiAgICBjb25zdCBidWNrZXQyID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldDInKTtcbiAgICBjb25zdCBvcmlnaW4gPSBuZXcgUzNPcmlnaW4oYnVja2V0LCB7IG9yaWdpbklkOiAnTXlDdXN0b21PcmlnaW4nIH0pO1xuICAgIGNvbnN0IG9yaWdpbjIgPSBuZXcgUzNPcmlnaW4oYnVja2V0MiwgeyBvcmlnaW5JZDogJ015Q3VzdG9tT3JpZ2luJyB9KTtcbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgbmV3IGNsb3VkZnJvbnQuRGlzdHJpYnV0aW9uKHN0YWNrLCAnRGlzdCcsIHtcbiAgICAgICAgZGVmYXVsdEJlaGF2aW9yOiB7IG9yaWdpbiB9LFxuICAgICAgICBhZGRpdGlvbmFsQmVoYXZpb3JzOiB7XG4gICAgICAgICAgT3JpZ2luMjoge1xuICAgICAgICAgICAgb3JpZ2luOiBvcmlnaW4yLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KS50b1Rocm93KC9PcmlnaW4gd2l0aCBpZCBNeUN1c3RvbU9yaWdpbiBhbHJlYWR5IGV4aXN0cy8pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnV2l0aCB3ZWJzaXRlLWNvbmZpZ3VyZWQgYnVja2V0JywgKCkgPT4ge1xuICB0ZXN0KCdyZW5kZXJzIGFsbCByZXF1aXJlZCBwcm9wZXJ0aWVzLCBpbmNsdWRpbmcgY3VzdG9tIG9yaWdpbiBjb25maWcnLCAoKSA9PiB7XG4gICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldCcsIHtcbiAgICAgIHdlYnNpdGVJbmRleERvY3VtZW50OiAnaW5kZXguaHRtbCcsXG4gICAgfSk7XG5cbiAgICBjb25zdCBvcmlnaW4gPSBuZXcgUzNPcmlnaW4oYnVja2V0KTtcbiAgICBjb25zdCBvcmlnaW5CaW5kQ29uZmlnID0gb3JpZ2luLmJpbmQoc3RhY2ssIHsgb3JpZ2luSWQ6ICdTdGFja09yaWdpbjAyOUUxOTU4MicgfSk7XG5cbiAgICBleHBlY3Qob3JpZ2luQmluZENvbmZpZy5vcmlnaW5Qcm9wZXJ0eSkudG9FcXVhbCh7XG4gICAgICBpZDogJ1N0YWNrT3JpZ2luMDI5RTE5NTgyJyxcbiAgICAgIGRvbWFpbk5hbWU6IGJ1Y2tldC5idWNrZXRXZWJzaXRlRG9tYWluTmFtZSxcbiAgICAgIGN1c3RvbU9yaWdpbkNvbmZpZzoge1xuICAgICAgICBvcmlnaW5Qcm90b2NvbFBvbGljeTogJ2h0dHAtb25seScsXG4gICAgICAgIG9yaWdpblNzbFByb3RvY29sczogW1xuICAgICAgICAgICdUTFN2MS4yJyxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NhbiBjdXN0b21pemUgcHJvcGVydGllcycsICgpID0+IHtcbiAgICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQnVja2V0Jywge1xuICAgICAgd2Vic2l0ZUluZGV4RG9jdW1lbnQ6ICdpbmRleC5odG1sJyxcbiAgICB9KTtcblxuICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBTM09yaWdpbihidWNrZXQsIHsgb3JpZ2luUGF0aDogJy9hc3NldHMnIH0pO1xuICAgIGNvbnN0IG9yaWdpbkJpbmRDb25maWcgPSBvcmlnaW4uYmluZChzdGFjaywgeyBvcmlnaW5JZDogJ1N0YWNrT3JpZ2luMDI5RTE5NTgyJyB9KTtcblxuICAgIGV4cGVjdChvcmlnaW5CaW5kQ29uZmlnLm9yaWdpblByb3BlcnR5KS50b0VxdWFsKHtcbiAgICAgIGlkOiAnU3RhY2tPcmlnaW4wMjlFMTk1ODInLFxuICAgICAgZG9tYWluTmFtZTogYnVja2V0LmJ1Y2tldFdlYnNpdGVEb21haW5OYW1lLFxuICAgICAgb3JpZ2luUGF0aDogJy9hc3NldHMnLFxuICAgICAgY3VzdG9tT3JpZ2luQ29uZmlnOiB7XG4gICAgICAgIG9yaWdpblByb3RvY29sUG9saWN5OiAnaHR0cC1vbmx5JyxcbiAgICAgICAgb3JpZ2luU3NsUHJvdG9jb2xzOiBbXG4gICAgICAgICAgJ1RMU3YxLjInLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnQ2FuIHNldCBhbiBvcmlnaW5JZCcsICgpID0+IHtcbiAgICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQnVja2V0Jywge1xuICAgICAgd2Vic2l0ZUluZGV4RG9jdW1lbnQ6ICdpbmRleC5odG1sJyxcbiAgICB9KTtcbiAgICBjb25zdCBvcmlnaW4gPSBuZXcgUzNPcmlnaW4oYnVja2V0LCB7IG9yaWdpbklkOiAnTXlDdXN0b21PcmlnaW4nIH0pO1xuICAgIG5ldyBjbG91ZGZyb250LkRpc3RyaWJ1dGlvbihzdGFjaywgJ0Rpc3QnLCB7IGRlZmF1bHRCZWhhdmlvcjogeyBvcmlnaW4gfSB9KTtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDbG91ZEZyb250OjpEaXN0cmlidXRpb24nLCB7XG4gICAgICBEaXN0cmlidXRpb25Db25maWc6IHtcbiAgICAgICAgT3JpZ2luczogW3tcbiAgICAgICAgICBJZDogJ015Q3VzdG9tT3JpZ2luJyxcbiAgICAgICAgfV0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19