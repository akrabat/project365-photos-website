"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataResourceType = exports.ManagementEventSources = exports.Trail = exports.InsightType = exports.ReadWriteType = void 0;
const jsiiDeprecationWarnings = require("../../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const events = require("../../aws-events");
const iam = require("../../aws-iam");
const logs = require("../../aws-logs");
const s3 = require("../../aws-s3");
const core_1 = require("../../core");
const cloudtrail_generated_1 = require("./cloudtrail.generated");
/**
 * Types of events that CloudTrail can log
 */
var ReadWriteType;
(function (ReadWriteType) {
    /**
     * Read-only events include API operations that read your resources,
     * but don't make changes.
     * For example, read-only events include the Amazon EC2 DescribeSecurityGroups
     * and DescribeSubnets API operations.
     */
    ReadWriteType["READ_ONLY"] = "ReadOnly";
    /**
     * Write-only events include API operations that modify (or might modify)
     * your resources.
     * For example, the Amazon EC2 RunInstances and TerminateInstances API
     * operations modify your instances.
     */
    ReadWriteType["WRITE_ONLY"] = "WriteOnly";
    /**
     * All events
     */
    ReadWriteType["ALL"] = "All";
    /**
     * No events
     */
    ReadWriteType["NONE"] = "None";
})(ReadWriteType = exports.ReadWriteType || (exports.ReadWriteType = {}));
/**
 * Util element for InsightSelector
 */
class InsightType {
    constructor(value) {
        this.value = value;
    }
}
_a = JSII_RTTI_SYMBOL_1;
InsightType[_a] = { fqn: "aws-cdk-lib.aws_cloudtrail.InsightType", version: "2.73.0" };
/**
 * The type of insights to log on a trail. (API Call Rate)
 */
InsightType.API_CALL_RATE = new InsightType('ApiCallRateInsight');
/**
 * The type of insights to log on a trail. (API Error Rate)
 */
InsightType.API_ERROR_RATE = new InsightType('ApiErrorRateInsight');
exports.InsightType = InsightType;
/**
 * Cloud trail allows you to log events that happen in your AWS account
 * For example:
 *
 * import { CloudTrail } from '@aws-cdk/aws-cloudtrail'
 *
 * const cloudTrail = new CloudTrail(this, 'MyTrail');
 *
 * NOTE the above example creates an UNENCRYPTED bucket by default,
 * If you are required to use an Encrypted bucket you can supply a preconfigured bucket
 * via TrailProps
 *
 */
class Trail extends core_1.Resource {
    /**
     * Create an event rule for when an event is recorded by any Trail in the account.
     *
     * Note that the event doesn't necessarily have to come from this Trail, it can
     * be captured from any one.
     *
     * Be sure to filter the event further down using an event pattern.
     */
    static onEvent(scope, id, options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_events_OnEventOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.onEvent);
            }
            throw error;
        }
        const rule = new events.Rule(scope, id, options);
        rule.addTarget(options.target);
        rule.addEventPattern({
            detailType: ['AWS API Call via CloudTrail'],
        });
        return rule;
    }
    constructor(scope, id, props = {}) {
        super(scope, id, {
            physicalName: props.trailName,
        });
        this.eventSelectors = [];
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_TrailProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, Trail);
            }
            throw error;
        }
        const cloudTrailPrincipal = new iam.ServicePrincipal('cloudtrail.amazonaws.com');
        this.s3bucket = props.bucket || new s3.Bucket(this, 'S3', { encryption: s3.BucketEncryption.UNENCRYPTED, enforceSSL: true });
        this.s3bucket.addToResourcePolicy(new iam.PolicyStatement({
            resources: [this.s3bucket.bucketArn],
            actions: ['s3:GetBucketAcl'],
            principals: [cloudTrailPrincipal],
        }));
        this.s3bucket.addToResourcePolicy(new iam.PolicyStatement({
            resources: [this.s3bucket.arnForObjects(`${props.s3KeyPrefix ? `${props.s3KeyPrefix}/` : ''}AWSLogs/${core_1.Stack.of(this).account}/*`)],
            actions: ['s3:PutObject'],
            principals: [cloudTrailPrincipal],
            conditions: {
                StringEquals: { 's3:x-amz-acl': 'bucket-owner-full-control' },
            },
        }));
        this.topic = props.snsTopic;
        if (this.topic) {
            this.topic.grantPublish(cloudTrailPrincipal);
        }
        let logsRole;
        if (props.sendToCloudWatchLogs) {
            if (props.cloudWatchLogGroup) {
                this.logGroup = props.cloudWatchLogGroup;
            }
            else {
                this.logGroup = new logs.LogGroup(this, 'LogGroup', {
                    retention: props.cloudWatchLogsRetention ?? logs.RetentionDays.ONE_YEAR,
                });
            }
            logsRole = new iam.Role(this, 'LogsRole', { assumedBy: cloudTrailPrincipal });
            logsRole.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['logs:PutLogEvents', 'logs:CreateLogStream'],
                resources: [this.logGroup.logGroupArn],
            }));
        }
        this.managementEvents = props.managementEvents;
        if (this.managementEvents && this.managementEvents !== ReadWriteType.NONE) {
            this.eventSelectors.push({
                includeManagementEvents: true,
                readWriteType: props.managementEvents,
            });
        }
        this.node.addValidation({ validate: () => this.validateEventSelectors() });
        if (props.kmsKey && props.encryptionKey) {
            throw new Error('Both kmsKey and encryptionKey must not be specified. Use only encryptionKey');
        }
        if (props.insightTypes) {
            this.insightTypeValues = props.insightTypes.map(function (t) {
                return { insightType: t.value };
            });
        }
        // TODO: not all regions support validation. Use service configuration data to fail gracefully
        const trail = new cloudtrail_generated_1.CfnTrail(this, 'Resource', {
            isLogging: true,
            enableLogFileValidation: props.enableFileValidation == null ? true : props.enableFileValidation,
            isMultiRegionTrail: props.isMultiRegionTrail == null ? true : props.isMultiRegionTrail,
            includeGlobalServiceEvents: props.includeGlobalServiceEvents == null ? true : props.includeGlobalServiceEvents,
            trailName: this.physicalName,
            kmsKeyId: props.encryptionKey?.keyArn ?? props.kmsKey?.keyArn,
            s3BucketName: this.s3bucket.bucketName,
            s3KeyPrefix: props.s3KeyPrefix,
            cloudWatchLogsLogGroupArn: this.logGroup?.logGroupArn,
            cloudWatchLogsRoleArn: logsRole?.roleArn,
            snsTopicName: this.topic?.topicName,
            eventSelectors: this.eventSelectors,
            isOrganizationTrail: props.isOrganizationTrail,
            insightSelectors: this.insightTypeValues,
        });
        this.trailArn = this.getResourceArnAttribute(trail.attrArn, {
            service: 'cloudtrail',
            resource: 'trail',
            resourceName: this.physicalName,
        });
        this.trailSnsTopicArn = trail.attrSnsTopicArn;
        // Add a dependency on the bucket policy being updated, CloudTrail will test this upon creation.
        if (this.s3bucket.policy) {
            trail.node.addDependency(this.s3bucket.policy);
        }
        // If props.sendToCloudWatchLogs is set to true then the trail needs to depend on the created logsRole
        // so that it can create the log stream for the log group. This ensures the logsRole is created and propagated
        // before the trail tries to create the log stream.
        if (logsRole !== undefined) {
            trail.node.addDependency(logsRole);
        }
    }
    /**
     * When an event occurs in your account, CloudTrail evaluates whether the event matches the settings for your trails.
     * Only events that match your trail settings are delivered to your Amazon S3 bucket and Amazon CloudWatch Logs log group.
     *
     * This method adds an Event Selector for filtering events that match either S3 or Lambda function operations.
     *
     * Data events: These events provide insight into the resource operations performed on or within a resource.
     * These are also known as data plane operations.
     *
     * @param dataResourceValues the list of data resource ARNs to include in logging (maximum 250 entries).
     * @param options the options to configure logging of management and data events.
     */
    addEventSelector(dataResourceType, dataResourceValues, options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_DataResourceType(dataResourceType);
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_AddEventSelectorOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addEventSelector);
            }
            throw error;
        }
        if (dataResourceValues.length > 250) {
            throw new Error('A maximum of 250 data elements can be in one event selector');
        }
        if (this.eventSelectors.length > 5) {
            throw new Error('A maximum of 5 event selectors are supported per trail.');
        }
        let includeAllManagementEvents;
        if (this.managementEvents === ReadWriteType.NONE) {
            includeAllManagementEvents = false;
        }
        this.eventSelectors.push({
            dataResources: [{
                    type: dataResourceType,
                    values: dataResourceValues,
                }],
            includeManagementEvents: options.includeManagementEvents ?? includeAllManagementEvents,
            excludeManagementEventSources: options.excludeManagementEventSources,
            readWriteType: options.readWriteType,
        });
    }
    /**
     * When an event occurs in your account, CloudTrail evaluates whether the event matches the settings for your trails.
     * Only events that match your trail settings are delivered to your Amazon S3 bucket and Amazon CloudWatch Logs log group.
     *
     * This method adds a Lambda Data Event Selector for filtering events that match Lambda function operations.
     *
     * Data events: These events provide insight into the resource operations performed on or within a resource.
     * These are also known as data plane operations.
     *
     * @param handlers the list of lambda function handlers whose data events should be logged (maximum 250 entries).
     * @param options the options to configure logging of management and data events.
     */
    addLambdaEventSelector(handlers, options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_AddEventSelectorOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addLambdaEventSelector);
            }
            throw error;
        }
        if (handlers.length === 0) {
            return;
        }
        const dataResourceValues = handlers.map((h) => h.functionArn);
        return this.addEventSelector(DataResourceType.LAMBDA_FUNCTION, dataResourceValues, options);
    }
    /**
     * Log all Lambda data events for all lambda functions the account.
     * @see https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-data-events-with-cloudtrail.html
     * @default false
     */
    logAllLambdaDataEvents(options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_AddEventSelectorOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.logAllLambdaDataEvents);
            }
            throw error;
        }
        return this.addEventSelector(DataResourceType.LAMBDA_FUNCTION, [`arn:${this.stack.partition}:lambda`], options);
    }
    /**
     * When an event occurs in your account, CloudTrail evaluates whether the event matches the settings for your trails.
     * Only events that match your trail settings are delivered to your Amazon S3 bucket and Amazon CloudWatch Logs log group.
     *
     * This method adds an S3 Data Event Selector for filtering events that match S3 operations.
     *
     * Data events: These events provide insight into the resource operations performed on or within a resource.
     * These are also known as data plane operations.
     *
     * @param s3Selector the list of S3 bucket with optional prefix to include in logging (maximum 250 entries).
     * @param options the options to configure logging of management and data events.
     */
    addS3EventSelector(s3Selector, options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_AddEventSelectorOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.addS3EventSelector);
            }
            throw error;
        }
        if (s3Selector.length === 0) {
            return;
        }
        const dataResourceValues = s3Selector.map((sel) => `${sel.bucket.bucketArn}/${sel.objectPrefix ?? ''}`);
        return this.addEventSelector(DataResourceType.S3_OBJECT, dataResourceValues, options);
    }
    /**
     * Log all S3 data events for all objects for all buckets in the account.
     * @see https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-data-events-with-cloudtrail.html
     * @default false
     */
    logAllS3DataEvents(options = {}) {
        try {
            jsiiDeprecationWarnings.aws_cdk_lib_aws_cloudtrail_AddEventSelectorOptions(options);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.logAllS3DataEvents);
            }
            throw error;
        }
        return this.addEventSelector(DataResourceType.S3_OBJECT, [`arn:${this.stack.partition}:s3:::`], options);
    }
    /**
     * Create an event rule for when an event is recorded by any Trail in the account.
     *
     * Note that the event doesn't necessarily have to come from this Trail, it can
     * be captured from any one.
     *
     * Be sure to filter the event further down using an event pattern.
     *
     * @deprecated - use Trail.onEvent()
     */
    onCloudTrailEvent(id, options = {}) {
        return Trail.onEvent(this, id, options);
    }
    validateEventSelectors() {
        const errors = [];
        // Ensure that there is at least one event selector when management events are set to None
        if (this.managementEvents === ReadWriteType.NONE && this.eventSelectors.length === 0) {
            errors.push('At least one event selector must be added when management event recording is set to None');
        }
        return errors;
    }
}
_b = JSII_RTTI_SYMBOL_1;
Trail[_b] = { fqn: "aws-cdk-lib.aws_cloudtrail.Trail", version: "2.73.0" };
exports.Trail = Trail;
/**
 * Types of management event sources that can be excluded
 */
var ManagementEventSources;
(function (ManagementEventSources) {
    /**
     * AWS Key Management Service (AWS KMS) events
     */
    ManagementEventSources["KMS"] = "kms.amazonaws.com";
    /**
     * Data API events
     */
    ManagementEventSources["RDS_DATA_API"] = "rdsdata.amazonaws.com";
})(ManagementEventSources = exports.ManagementEventSources || (exports.ManagementEventSources = {}));
/**
 * Resource type for a data event
 */
var DataResourceType;
(function (DataResourceType) {
    /**
     * Data resource type for Lambda function
     */
    DataResourceType["LAMBDA_FUNCTION"] = "AWS::Lambda::Function";
    /**
     * Data resource type for S3 objects
     */
    DataResourceType["S3_OBJECT"] = "AWS::S3::Object";
})(DataResourceType = exports.DataResourceType || (exports.DataResourceType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xvdWR0cmFpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNsb3VkdHJhaWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsMkNBQTJDO0FBQzNDLHFDQUFxQztBQUdyQyx1Q0FBdUM7QUFDdkMsbUNBQW1DO0FBRW5DLHFDQUE2QztBQUU3QyxpRUFBa0Q7QUFpSWxEOztHQUVHO0FBQ0gsSUFBWSxhQXdCWDtBQXhCRCxXQUFZLGFBQWE7SUFDdkI7Ozs7O09BS0c7SUFDSCx1Q0FBc0IsQ0FBQTtJQUN0Qjs7Ozs7T0FLRztJQUNILHlDQUF3QixDQUFBO0lBQ3hCOztPQUVHO0lBQ0gsNEJBQVcsQ0FBQTtJQUVYOztPQUVHO0lBQ0gsOEJBQWEsQ0FBQTtBQUNmLENBQUMsRUF4QlcsYUFBYSxHQUFiLHFCQUFhLEtBQWIscUJBQWEsUUF3QnhCO0FBRUQ7O0dBRUc7QUFDSCxNQUFhLFdBQVc7SUFXdEIsWUFBc0MsS0FBYTtRQUFiLFVBQUssR0FBTCxLQUFLLENBQVE7S0FBSTs7OztBQVZ2RDs7R0FFRztBQUNvQix5QkFBYSxHQUFHLElBQUksV0FBVyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFFN0U7O0dBRUc7QUFDb0IsMEJBQWMsR0FBRyxJQUFJLFdBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBVHBFLGtDQUFXO0FBY3hCOzs7Ozs7Ozs7Ozs7R0FZRztBQUNILE1BQWEsS0FBTSxTQUFRLGVBQVE7SUFFakM7Ozs7Ozs7T0FPRztJQUNJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsVUFBaUMsRUFBRTs7Ozs7Ozs7OztRQUNyRixNQUFNLElBQUksR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsZUFBZSxDQUFDO1lB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LEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3pDO0lBRU8sc0JBQXNCO1FBQzVCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUM1QiwwRkFBMEY7UUFDMUYsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEtBQUssYUFBYSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDcEYsTUFBTSxDQUFDLElBQUksQ0FBQywwRkFBMEYsQ0FBQyxDQUFDO1NBQ3pHO1FBQ0QsT0FBTyxNQUFNLENBQUM7S0FDZjs7OztBQXhRVSxzQkFBSztBQXFTbEI7O0dBRUc7QUFDSCxJQUFZLHNCQVVYO0FBVkQsV0FBWSxzQkFBc0I7SUFDaEM7O09BRUc7SUFDSCxtREFBeUIsQ0FBQTtJQUV6Qjs7T0FFRztJQUNILGdFQUFzQyxDQUFBO0FBQ3hDLENBQUMsRUFWVyxzQkFBc0IsR0FBdEIsOEJBQXNCLEtBQXRCLDhCQUFzQixRQVVqQztBQWdCRDs7R0FFRztBQUNILElBQVksZ0JBVVg7QUFWRCxXQUFZLGdCQUFnQjtJQUMxQjs7T0FFRztJQUNILDZEQUF5QyxDQUFBO0lBRXpDOztPQUVHO0lBQ0gsaURBQTZCLENBQUE7QUFDL0IsQ0FBQyxFQVZXLGdCQUFnQixHQUFoQix3QkFBZ0IsS0FBaEIsd0JBQWdCLFFBVTNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXZlbnRzIGZyb20gJy4uLy4uL2F3cy1ldmVudHMnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJy4uLy4uL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMga21zIGZyb20gJy4uLy4uL2F3cy1rbXMnO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJy4uLy4uL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tICcuLi8uLi9hd3MtbG9ncyc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICcuLi8uLi9hd3MtczMnO1xuaW1wb3J0ICogYXMgc25zIGZyb20gJy4uLy4uL2F3cy1zbnMnO1xuaW1wb3J0IHsgUmVzb3VyY2UsIFN0YWNrIH0gZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENmblRyYWlsIH0gZnJvbSAnLi9jbG91ZHRyYWlsLmdlbmVyYXRlZCc7XG5cbi8qKlxuICogUHJvcGVydGllcyBmb3IgYW4gQVdTIENsb3VkVHJhaWwgdHJhaWxcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBUcmFpbFByb3BzIHtcbiAgLyoqXG4gICAqIEZvciBtb3N0IHNlcnZpY2VzLCBldmVudHMgYXJlIHJlY29yZGVkIGluIHRoZSByZWdpb24gd2hlcmUgdGhlIGFjdGlvbiBvY2N1cnJlZC5cbiAgICogRm9yIGdsb2JhbCBzZXJ2aWNlcyBzdWNoIGFzIEFXUyBJZGVudGl0eSBhbmQgQWNjZXNzIE1hbmFnZW1lbnQgKElBTSksIEFXUyBTVFMsIEFtYXpvbiBDbG91ZEZyb250LCBhbmQgUm91dGUgNTMsXG4gICAqIGV2ZW50cyBhcmUgZGVsaXZlcmVkIHRvIGFueSB0cmFpbCB0aGF0IGluY2x1ZGVzIGdsb2JhbCBzZXJ2aWNlcywgYW5kIGFyZSBsb2dnZWQgYXMgb2NjdXJyaW5nIGluIFVTIEVhc3QgKE4uIFZpcmdpbmlhKSBSZWdpb24uXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IGluY2x1ZGVHbG9iYWxTZXJ2aWNlRXZlbnRzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhpcyB0cmFpbCBkZWxpdmVycyBsb2cgZmlsZXMgZnJvbSBtdWx0aXBsZSByZWdpb25zIHRvIGEgc2luZ2xlIFMzIGJ1Y2tldCBmb3IgYSBzaW5nbGUgYWNjb3VudC5cbiAgICpcbiAgICogQGRlZmF1bHQgdHJ1ZVxuICAgKi9cbiAgcmVhZG9ubHkgaXNNdWx0aVJlZ2lvblRyYWlsPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogV2hlbiBhbiBldmVudCBvY2N1cnMgaW4geW91ciBhY2NvdW50LCBDbG91ZFRyYWlsIGV2YWx1YXRlcyB3aGV0aGVyIHRoZSBldmVudCBtYXRjaGVzIHRoZSBzZXR0aW5ncyBmb3IgeW91ciB0cmFpbHMuXG4gICAqIE9ubHkgZXZlbnRzIHRoYXQgbWF0Y2ggeW91ciB0cmFpbCBzZXR0aW5ncyBhcmUgZGVsaXZlcmVkIHRvIHlvdXIgQW1hem9uIFMzIGJ1Y2tldCBhbmQgQW1hem9uIENsb3VkV2F0Y2ggTG9ncyBsb2cgZ3JvdXAuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIHNldHMgdGhlIG1hbmFnZW1lbnQgY29uZmlndXJhdGlvbiBmb3IgdGhpcyB0cmFpbC5cbiAgICpcbiAgICogTWFuYWdlbWVudCBldmVudHMgcHJvdmlkZSBpbnNpZ2h0IGludG8gbWFuYWdlbWVudCBvcGVyYXRpb25zIHRoYXQgYXJlIHBlcmZvcm1lZCBvbiByZXNvdXJjZXMgaW4geW91ciBBV1MgYWNjb3VudC5cbiAgICogVGhlc2UgYXJlIGFsc28ga25vd24gYXMgY29udHJvbCBwbGFuZSBvcGVyYXRpb25zLlxuICAgKiBNYW5hZ2VtZW50IGV2ZW50cyBjYW4gYWxzbyBpbmNsdWRlIG5vbi1BUEkgZXZlbnRzIHRoYXQgb2NjdXIgaW4geW91ciBhY2NvdW50LlxuICAgKiBGb3IgZXhhbXBsZSwgd2hlbiBhIHVzZXIgbG9ncyBpbiB0byB5b3VyIGFjY291bnQsIENsb3VkVHJhaWwgbG9ncyB0aGUgQ29uc29sZUxvZ2luIGV2ZW50LlxuICAgKlxuICAgKiBAcGFyYW0gbWFuYWdlbWVudEV2ZW50cyB0aGUgbWFuYWdlbWVudCBjb25maWd1cmF0aW9uIHR5cGUgdG8gbG9nXG4gICAqXG4gICAqIEBkZWZhdWx0IFJlYWRXcml0ZVR5cGUuQUxMXG4gICAqL1xuICByZWFkb25seSBtYW5hZ2VtZW50RXZlbnRzPzogUmVhZFdyaXRlVHlwZTtcblxuICAvKipcbiAgICogVG8gZGV0ZXJtaW5lIHdoZXRoZXIgYSBsb2cgZmlsZSB3YXMgbW9kaWZpZWQsIGRlbGV0ZWQsIG9yIHVuY2hhbmdlZCBhZnRlciBDbG91ZFRyYWlsIGRlbGl2ZXJlZCBpdCxcbiAgICogeW91IGNhbiB1c2UgQ2xvdWRUcmFpbCBsb2cgZmlsZSBpbnRlZ3JpdHkgdmFsaWRhdGlvbi5cbiAgICogVGhpcyBmZWF0dXJlIGlzIGJ1aWx0IHVzaW5nIGluZHVzdHJ5IHN0YW5kYXJkIGFsZ29yaXRobXM6IFNIQS0yNTYgZm9yIGhhc2hpbmcgYW5kIFNIQS0yNTYgd2l0aCBSU0EgZm9yIGRpZ2l0YWwgc2lnbmluZy5cbiAgICogVGhpcyBtYWtlcyBpdCBjb21wdXRhdGlvbmFsbHkgaW5mZWFzaWJsZSB0byBtb2RpZnksIGRlbGV0ZSBvciBmb3JnZSBDbG91ZFRyYWlsIGxvZyBmaWxlcyB3aXRob3V0IGRldGVjdGlvbi5cbiAgICogWW91IGNhbiB1c2UgdGhlIEFXUyBDTEkgdG8gdmFsaWRhdGUgdGhlIGZpbGVzIGluIHRoZSBsb2NhdGlvbiB3aGVyZSBDbG91ZFRyYWlsIGRlbGl2ZXJlZCB0aGVtLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBlbmFibGVGaWxlVmFsaWRhdGlvbj86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIElmIENsb3VkVHJhaWwgcHVzaGVzIGxvZ3MgdG8gQ2xvdWRXYXRjaCBMb2dzIGluIGFkZGl0aW9uIHRvIFMzLlxuICAgKiBEaXNhYmxlZCBmb3IgY29zdCBvdXQgb2YgdGhlIGJveC5cbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHNlbmRUb0Nsb3VkV2F0Y2hMb2dzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogSG93IGxvbmcgdG8gcmV0YWluIGxvZ3MgaW4gQ2xvdWRXYXRjaExvZ3MuXG4gICAqIElnbm9yZWQgaWYgc2VuZFRvQ2xvdWRXYXRjaExvZ3MgaXMgZmFsc2Ugb3IgaWYgY2xvdWRXYXRjaExvZ0dyb3VwIGlzIHNldC5cbiAgICpcbiAgICogIEBkZWZhdWx0IGxvZ3MuUmV0ZW50aW9uRGF5cy5PTkVfWUVBUlxuICAgKi9cbiAgcmVhZG9ubHkgY2xvdWRXYXRjaExvZ3NSZXRlbnRpb24/OiBsb2dzLlJldGVudGlvbkRheXM7XG5cbiAgLyoqXG4gICAqIExvZyBHcm91cCB0byB3aGljaCBDbG91ZFRyYWlsIHRvIHB1c2ggbG9ncyB0by4gSWdub3JlZCBpZiBzZW5kVG9DbG91ZFdhdGNoTG9ncyBpcyBzZXQgdG8gZmFsc2UuXG4gICAqIEBkZWZhdWx0IC0gYSBuZXcgbG9nIGdyb3VwIGlzIGNyZWF0ZWQgYW5kIHVzZWQuXG4gICAqL1xuICByZWFkb25seSBjbG91ZFdhdGNoTG9nR3JvdXA/OiBsb2dzLklMb2dHcm91cDtcblxuICAvKiogVGhlIEFXUyBLZXkgTWFuYWdlbWVudCBTZXJ2aWNlIChBV1MgS01TKSBrZXkgSUQgdGhhdCB5b3Ugd2FudCB0byB1c2UgdG8gZW5jcnlwdCBDbG91ZFRyYWlsIGxvZ3MuXG4gICAqIEBkZWZhdWx0IC0gTm8gZW5jcnlwdGlvbi5cbiAgICogQGRlcHJlY2F0ZWQgLSB1c2UgZW5jcnlwdGlvbktleSBpbnN0ZWFkLlxuICAgKi9cbiAgcmVhZG9ubHkga21zS2V5Pzoga21zLklLZXk7XG5cbiAgLyoqIFRoZSBBV1MgS2V5IE1hbmFnZW1lbnQgU2VydmljZSAoQVdTIEtNUykga2V5IElEIHRoYXQgeW91IHdhbnQgdG8gdXNlIHRvIGVuY3J5cHQgQ2xvdWRUcmFpbCBsb2dzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIGVuY3J5cHRpb24uXG4gICAqL1xuICByZWFkb25seSBlbmNyeXB0aW9uS2V5Pzoga21zLklLZXk7XG5cbiAgLyoqIFNOUyB0b3BpYyB0aGF0IGlzIG5vdGlmaWVkIHdoZW4gbmV3IGxvZyBmaWxlcyBhcmUgcHVibGlzaGVkLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIG5vdGlmaWNhdGlvbnMuXG4gICAqL1xuICByZWFkb25seSBzbnNUb3BpYz86IHNucy5JVG9waWM7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSB0cmFpbC4gV2UgcmVjb21tZW5kIGN1c3RvbWVycyBkbyBub3Qgc2V0IGFuIGV4cGxpY2l0IG5hbWUuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQVdTIENsb3VkRm9ybWF0aW9uIGdlbmVyYXRlZCBuYW1lLlxuICAgKi9cbiAgcmVhZG9ubHkgdHJhaWxOYW1lPzogc3RyaW5nO1xuXG4gIC8qKiBBbiBBbWF6b24gUzMgb2JqZWN0IGtleSBwcmVmaXggdGhhdCBwcmVjZWRlcyB0aGUgbmFtZSBvZiBhbGwgbG9nIGZpbGVzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIHByZWZpeC5cbiAgICovXG4gIHJlYWRvbmx5IHMzS2V5UHJlZml4Pzogc3RyaW5nO1xuXG4gIC8qKiBUaGUgQW1hem9uIFMzIGJ1Y2tldFxuICAgKlxuICAgKiBAZGVmYXVsdCAtIGlmIG5vdCBzdXBwbGllZCBhIGJ1Y2tldCB3aWxsIGJlIGNyZWF0ZWQgd2l0aCBhbGwgdGhlIGNvcnJlY3QgcGVybWlzaW9uc1xuICAgKi9cbiAgcmVhZG9ubHkgYnVja2V0PzogczMuSUJ1Y2tldDtcblxuICAvKipcbiAgICogU3BlY2lmaWVzIHdoZXRoZXIgdGhlIHRyYWlsIGlzIGFwcGxpZWQgdG8gYWxsIGFjY291bnRzIGluIGFuIG9yZ2FuaXphdGlvbiBpbiBBV1MgT3JnYW5pemF0aW9ucywgb3Igb25seSBmb3IgdGhlIGN1cnJlbnQgQVdTIGFjY291bnQuXG4gICAqXG4gICAqIElmIHRoaXMgaXMgc2V0IHRvIHRydWUgdGhlbiB0aGUgY3VycmVudCBhY2NvdW50IF9tdXN0XyBiZSB0aGUgbWFuYWdlbWVudCBhY2NvdW50LiBJZiBpdCBpcyBub3QsIHRoZW4gQ2xvdWRGb3JtYXRpb24gd2lsbCB0aHJvdyBhbiBlcnJvci5cbiAgICpcbiAgICogSWYgdGhpcyBpcyBzZXQgdG8gdHJ1ZSBhbmQgdGhlIGN1cnJlbnQgYWNjb3VudCBpcyBhIG1hbmFnZW1lbnQgYWNjb3VudCBmb3IgYW4gb3JnYW5pemF0aW9uIGluIEFXUyBPcmdhbml6YXRpb25zLCB0aGUgdHJhaWwgd2lsbCBiZSBjcmVhdGVkIGluIGFsbCBBV1MgYWNjb3VudHMgdGhhdCBiZWxvbmcgdG8gdGhlIG9yZ2FuaXphdGlvbi5cbiAgICogSWYgdGhpcyBpcyBzZXQgdG8gZmFsc2UsIHRoZSB0cmFpbCB3aWxsIHJlbWFpbiBpbiB0aGUgY3VycmVudCBBV1MgYWNjb3VudCBidXQgYmUgZGVsZXRlZCBmcm9tIGFsbCBtZW1iZXIgYWNjb3VudHMgaW4gdGhlIG9yZ2FuaXphdGlvbi5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBmYWxzZVxuICAgKi9cbiAgcmVhZG9ubHkgaXNPcmdhbml6YXRpb25UcmFpbD86IGJvb2xlYW5cblxuICAvKipcbiAgICogQSBKU09OIHN0cmluZyB0aGF0IGNvbnRhaW5zIHRoZSBpbnNpZ2h0IHR5cGVzIHlvdSB3YW50IHRvIGxvZyBvbiBhIHRyYWlsLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIE5vIFZhbHVlLlxuICAgKi9cbiAgcmVhZG9ubHkgaW5zaWdodFR5cGVzPzogSW5zaWdodFR5cGVbXVxufVxuXG4vKipcbiAqIFR5cGVzIG9mIGV2ZW50cyB0aGF0IENsb3VkVHJhaWwgY2FuIGxvZ1xuICovXG5leHBvcnQgZW51bSBSZWFkV3JpdGVUeXBlIHtcbiAgLyoqXG4gICAqIFJlYWQtb25seSBldmVudHMgaW5jbHVkZSBBUEkgb3BlcmF0aW9ucyB0aGF0IHJlYWQgeW91ciByZXNvdXJjZXMsXG4gICAqIGJ1dCBkb24ndCBtYWtlIGNoYW5nZXMuXG4gICAqIEZvciBleGFtcGxlLCByZWFkLW9ubHkgZXZlbnRzIGluY2x1ZGUgdGhlIEFtYXpvbiBFQzIgRGVzY3JpYmVTZWN1cml0eUdyb3Vwc1xuICAgKiBhbmQgRGVzY3JpYmVTdWJuZXRzIEFQSSBvcGVyYXRpb25zLlxuICAgKi9cbiAgUkVBRF9PTkxZID0gJ1JlYWRPbmx5JyxcbiAgLyoqXG4gICAqIFdyaXRlLW9ubHkgZXZlbnRzIGluY2x1ZGUgQVBJIG9wZXJhdGlvbnMgdGhhdCBtb2RpZnkgKG9yIG1pZ2h0IG1vZGlmeSlcbiAgICogeW91ciByZXNvdXJjZXMuXG4gICAqIEZvciBleGFtcGxlLCB0aGUgQW1hem9uIEVDMiBSdW5JbnN0YW5jZXMgYW5kIFRlcm1pbmF0ZUluc3RhbmNlcyBBUElcbiAgICogb3BlcmF0aW9ucyBtb2RpZnkgeW91ciBpbnN0YW5jZXMuXG4gICAqL1xuICBXUklURV9PTkxZID0gJ1dyaXRlT25seScsXG4gIC8qKlxuICAgKiBBbGwgZXZlbnRzXG4gICAqL1xuICBBTEwgPSAnQWxsJyxcblxuICAvKipcbiAgICogTm8gZXZlbnRzXG4gICAqL1xuICBOT05FID0gJ05vbmUnLFxufVxuXG4vKipcbiAqIFV0aWwgZWxlbWVudCBmb3IgSW5zaWdodFNlbGVjdG9yXG4gKi9cbmV4cG9ydCBjbGFzcyBJbnNpZ2h0VHlwZSB7XG4gIC8qKlxuICAgKiBUaGUgdHlwZSBvZiBpbnNpZ2h0cyB0byBsb2cgb24gYSB0cmFpbC4gKEFQSSBDYWxsIFJhdGUpXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IEFQSV9DQUxMX1JBVEUgPSBuZXcgSW5zaWdodFR5cGUoJ0FwaUNhbGxSYXRlSW5zaWdodCcpO1xuXG4gIC8qKlxuICAgKiBUaGUgdHlwZSBvZiBpbnNpZ2h0cyB0byBsb2cgb24gYSB0cmFpbC4gKEFQSSBFcnJvciBSYXRlKVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBBUElfRVJST1JfUkFURSA9IG5ldyBJbnNpZ2h0VHlwZSgnQXBpRXJyb3JSYXRlSW5zaWdodCcpO1xuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgdmFsdWU6IHN0cmluZykge31cbn1cblxuLyoqXG4gKiBDbG91ZCB0cmFpbCBhbGxvd3MgeW91IHRvIGxvZyBldmVudHMgdGhhdCBoYXBwZW4gaW4geW91ciBBV1MgYWNjb3VudFxuICogRm9yIGV4YW1wbGU6XG4gKlxuICogaW1wb3J0IHsgQ2xvdWRUcmFpbCB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1jbG91ZHRyYWlsJ1xuICpcbiAqIGNvbnN0IGNsb3VkVHJhaWwgPSBuZXcgQ2xvdWRUcmFpbCh0aGlzLCAnTXlUcmFpbCcpO1xuICpcbiAqIE5PVEUgdGhlIGFib3ZlIGV4YW1wbGUgY3JlYXRlcyBhbiBVTkVOQ1JZUFRFRCBidWNrZXQgYnkgZGVmYXVsdCxcbiAqIElmIHlvdSBhcmUgcmVxdWlyZWQgdG8gdXNlIGFuIEVuY3J5cHRlZCBidWNrZXQgeW91IGNhbiBzdXBwbHkgYSBwcmVjb25maWd1cmVkIGJ1Y2tldFxuICogdmlhIFRyYWlsUHJvcHNcbiAqXG4gKi9cbmV4cG9ydCBjbGFzcyBUcmFpbCBleHRlbmRzIFJlc291cmNlIHtcblxuICAvKipcbiAgICogQ3JlYXRlIGFuIGV2ZW50IHJ1bGUgZm9yIHdoZW4gYW4gZXZlbnQgaXMgcmVjb3JkZWQgYnkgYW55IFRyYWlsIGluIHRoZSBhY2NvdW50LlxuICAgKlxuICAgKiBOb3RlIHRoYXQgdGhlIGV2ZW50IGRvZXNuJ3QgbmVjZXNzYXJpbHkgaGF2ZSB0byBjb21lIGZyb20gdGhpcyBUcmFpbCwgaXQgY2FuXG4gICAqIGJlIGNhcHR1cmVkIGZyb20gYW55IG9uZS5cbiAgICpcbiAgICogQmUgc3VyZSB0byBmaWx0ZXIgdGhlIGV2ZW50IGZ1cnRoZXIgZG93biB1c2luZyBhbiBldmVudCBwYXR0ZXJuLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBvbkV2ZW50KHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIG9wdGlvbnM6IGV2ZW50cy5PbkV2ZW50T3B0aW9ucyA9IHt9KTogZXZlbnRzLlJ1bGUge1xuICAgIGNvbnN0IHJ1bGUgPSBuZXcgZXZlbnRzLlJ1bGUoc2NvcGUsIGlkLCBvcHRpb25zKTtcbiAgICBydWxlLmFkZFRhcmdldChvcHRpb25zLnRhcmdldCk7XG4gICAgcnVsZS5hZGRFdmVudFBhdHRlcm4oe1xuICAgICAgZGV0YWlsVHlwZTogWydBV1MgQVBJIENhbGwgdmlhIENsb3VkVHJhaWwnXSxcbiAgICB9KTtcbiAgICByZXR1cm4gcnVsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBUk4gb2YgdGhlIENsb3VkVHJhaWwgdHJhaWxcbiAgICogaS5lLiBhcm46YXdzOmNsb3VkdHJhaWw6dXMtZWFzdC0yOjEyMzQ1Njc4OTAxMjp0cmFpbC9teUNsb3VkVHJhaWxcbiAgICogQGF0dHJpYnV0ZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHRyYWlsQXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFSTiBvZiB0aGUgQW1hem9uIFNOUyB0b3BpYyB0aGF0J3MgYXNzb2NpYXRlZCB3aXRoIHRoZSBDbG91ZFRyYWlsIHRyYWlsLFxuICAgKiBpLmUuIGFybjphd3M6c25zOnVzLWVhc3QtMjoxMjM0NTY3ODkwMTI6bXlTTlNUb3BpY1xuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdHJhaWxTbnNUb3BpY0Fybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQ2xvdWRXYXRjaCBsb2cgZ3JvdXAgdG8gd2hpY2ggQ2xvdWRUcmFpbCBldmVudHMgYXJlIHNlbnQuXG4gICAqIGB1bmRlZmluZWRgIGlmIGBzZW5kVG9DbG91ZFdhdGNoTG9nc2AgcHJvcGVydHkgaXMgZmFsc2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgbG9nR3JvdXA/OiBsb2dzLklMb2dHcm91cDtcblxuICBwcml2YXRlIHMzYnVja2V0OiBzMy5JQnVja2V0O1xuICBwcml2YXRlIG1hbmFnZW1lbnRFdmVudHM6IFJlYWRXcml0ZVR5cGUgfCB1bmRlZmluZWQ7XG4gIHByaXZhdGUgZXZlbnRTZWxlY3RvcnM6IEV2ZW50U2VsZWN0b3JbXSA9IFtdO1xuICBwcml2YXRlIHRvcGljOiBzbnMuSVRvcGljIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIGluc2lnaHRUeXBlVmFsdWVzOiBJbnNpZ2h0U2VsZWN0b3JbXSB8IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogVHJhaWxQcm9wcyA9IHt9KSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCB7XG4gICAgICBwaHlzaWNhbE5hbWU6IHByb3BzLnRyYWlsTmFtZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGNsb3VkVHJhaWxQcmluY2lwYWwgPSBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2Nsb3VkdHJhaWwuYW1hem9uYXdzLmNvbScpO1xuXG4gICAgdGhpcy5zM2J1Y2tldCA9IHByb3BzLmJ1Y2tldCB8fCBuZXcgczMuQnVja2V0KHRoaXMsICdTMycsIHsgZW5jcnlwdGlvbjogczMuQnVja2V0RW5jcnlwdGlvbi5VTkVOQ1JZUFRFRCwgZW5mb3JjZVNTTDogdHJ1ZSB9KTtcblxuICAgIHRoaXMuczNidWNrZXQuYWRkVG9SZXNvdXJjZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFt0aGlzLnMzYnVja2V0LmJ1Y2tldEFybl0sXG4gICAgICBhY3Rpb25zOiBbJ3MzOkdldEJ1Y2tldEFjbCddLFxuICAgICAgcHJpbmNpcGFsczogW2Nsb3VkVHJhaWxQcmluY2lwYWxdLFxuICAgIH0pKTtcblxuICAgIHRoaXMuczNidWNrZXQuYWRkVG9SZXNvdXJjZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZXM6IFt0aGlzLnMzYnVja2V0LmFybkZvck9iamVjdHMoXG4gICAgICAgIGAke3Byb3BzLnMzS2V5UHJlZml4ID8gYCR7cHJvcHMuczNLZXlQcmVmaXh9L2AgOiAnJ31BV1NMb2dzLyR7U3RhY2sub2YodGhpcykuYWNjb3VudH0vKmAsXG4gICAgICApXSxcbiAgICAgIGFjdGlvbnM6IFsnczM6UHV0T2JqZWN0J10sXG4gICAgICBwcmluY2lwYWxzOiBbY2xvdWRUcmFpbFByaW5jaXBhbF0sXG4gICAgICBjb25kaXRpb25zOiB7XG4gICAgICAgIFN0cmluZ0VxdWFsczogeyAnczM6eC1hbXotYWNsJzogJ2J1Y2tldC1vd25lci1mdWxsLWNvbnRyb2wnIH0sXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIHRoaXMudG9waWMgPSBwcm9wcy5zbnNUb3BpYztcbiAgICBpZiAodGhpcy50b3BpYykge1xuICAgICAgdGhpcy50b3BpYy5ncmFudFB1Ymxpc2goY2xvdWRUcmFpbFByaW5jaXBhbCk7XG4gICAgfVxuXG4gICAgbGV0IGxvZ3NSb2xlOiBpYW0uSVJvbGUgfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAocHJvcHMuc2VuZFRvQ2xvdWRXYXRjaExvZ3MpIHtcbiAgICAgIGlmIChwcm9wcy5jbG91ZFdhdGNoTG9nR3JvdXApIHtcbiAgICAgICAgdGhpcy5sb2dHcm91cCA9IHByb3BzLmNsb3VkV2F0Y2hMb2dHcm91cDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cCh0aGlzLCAnTG9nR3JvdXAnLCB7XG4gICAgICAgICAgcmV0ZW50aW9uOiBwcm9wcy5jbG91ZFdhdGNoTG9nc1JldGVudGlvbiA/PyBsb2dzLlJldGVudGlvbkRheXMuT05FX1lFQVIsXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBsb2dzUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCAnTG9nc1JvbGUnLCB7IGFzc3VtZWRCeTogY2xvdWRUcmFpbFByaW5jaXBhbCB9KTtcblxuICAgICAgbG9nc1JvbGUuYWRkVG9QcmluY2lwYWxQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBhY3Rpb25zOiBbJ2xvZ3M6UHV0TG9nRXZlbnRzJywgJ2xvZ3M6Q3JlYXRlTG9nU3RyZWFtJ10sXG4gICAgICAgIHJlc291cmNlczogW3RoaXMubG9nR3JvdXAubG9nR3JvdXBBcm5dLFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIHRoaXMubWFuYWdlbWVudEV2ZW50cyA9IHByb3BzLm1hbmFnZW1lbnRFdmVudHM7XG4gICAgaWYgKHRoaXMubWFuYWdlbWVudEV2ZW50cyAmJiB0aGlzLm1hbmFnZW1lbnRFdmVudHMgIT09IFJlYWRXcml0ZVR5cGUuTk9ORSkge1xuICAgICAgdGhpcy5ldmVudFNlbGVjdG9ycy5wdXNoKHtcbiAgICAgICAgaW5jbHVkZU1hbmFnZW1lbnRFdmVudHM6IHRydWUsXG4gICAgICAgIHJlYWRXcml0ZVR5cGU6IHByb3BzLm1hbmFnZW1lbnRFdmVudHMsXG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5ub2RlLmFkZFZhbGlkYXRpb24oeyB2YWxpZGF0ZTogKCkgPT4gdGhpcy52YWxpZGF0ZUV2ZW50U2VsZWN0b3JzKCkgfSk7XG5cbiAgICBpZiAocHJvcHMua21zS2V5ICYmIHByb3BzLmVuY3J5cHRpb25LZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQm90aCBrbXNLZXkgYW5kIGVuY3J5cHRpb25LZXkgbXVzdCBub3QgYmUgc3BlY2lmaWVkLiBVc2Ugb25seSBlbmNyeXB0aW9uS2V5Jyk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLmluc2lnaHRUeXBlcykge1xuICAgICAgdGhpcy5pbnNpZ2h0VHlwZVZhbHVlcyA9IHByb3BzLmluc2lnaHRUeXBlcy5tYXAoZnVuY3Rpb24odCkge1xuICAgICAgICByZXR1cm4geyBpbnNpZ2h0VHlwZTogdC52YWx1ZSB9O1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gVE9ETzogbm90IGFsbCByZWdpb25zIHN1cHBvcnQgdmFsaWRhdGlvbi4gVXNlIHNlcnZpY2UgY29uZmlndXJhdGlvbiBkYXRhIHRvIGZhaWwgZ3JhY2VmdWxseVxuICAgIGNvbnN0IHRyYWlsID0gbmV3IENmblRyYWlsKHRoaXMsICdSZXNvdXJjZScsIHtcbiAgICAgIGlzTG9nZ2luZzogdHJ1ZSxcbiAgICAgIGVuYWJsZUxvZ0ZpbGVWYWxpZGF0aW9uOiBwcm9wcy5lbmFibGVGaWxlVmFsaWRhdGlvbiA9PSBudWxsID8gdHJ1ZSA6IHByb3BzLmVuYWJsZUZpbGVWYWxpZGF0aW9uLFxuICAgICAgaXNNdWx0aVJlZ2lvblRyYWlsOiBwcm9wcy5pc011bHRpUmVnaW9uVHJhaWwgPT0gbnVsbCA/IHRydWUgOiBwcm9wcy5pc011bHRpUmVnaW9uVHJhaWwsXG4gICAgICBpbmNsdWRlR2xvYmFsU2VydmljZUV2ZW50czogcHJvcHMuaW5jbHVkZUdsb2JhbFNlcnZpY2VFdmVudHMgPT0gbnVsbCA/IHRydWUgOiBwcm9wcy5pbmNsdWRlR2xvYmFsU2VydmljZUV2ZW50cyxcbiAgICAgIHRyYWlsTmFtZTogdGhpcy5waHlzaWNhbE5hbWUsXG4gICAgICBrbXNLZXlJZDogcHJvcHMuZW5jcnlwdGlvbktleT8ua2V5QXJuID8/IHByb3BzLmttc0tleT8ua2V5QXJuLFxuICAgICAgczNCdWNrZXROYW1lOiB0aGlzLnMzYnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICBzM0tleVByZWZpeDogcHJvcHMuczNLZXlQcmVmaXgsXG4gICAgICBjbG91ZFdhdGNoTG9nc0xvZ0dyb3VwQXJuOiB0aGlzLmxvZ0dyb3VwPy5sb2dHcm91cEFybixcbiAgICAgIGNsb3VkV2F0Y2hMb2dzUm9sZUFybjogbG9nc1JvbGU/LnJvbGVBcm4sXG4gICAgICBzbnNUb3BpY05hbWU6IHRoaXMudG9waWM/LnRvcGljTmFtZSxcbiAgICAgIGV2ZW50U2VsZWN0b3JzOiB0aGlzLmV2ZW50U2VsZWN0b3JzLFxuICAgICAgaXNPcmdhbml6YXRpb25UcmFpbDogcHJvcHMuaXNPcmdhbml6YXRpb25UcmFpbCxcbiAgICAgIGluc2lnaHRTZWxlY3RvcnM6IHRoaXMuaW5zaWdodFR5cGVWYWx1ZXMsXG4gICAgfSk7XG5cbiAgICB0aGlzLnRyYWlsQXJuID0gdGhpcy5nZXRSZXNvdXJjZUFybkF0dHJpYnV0ZSh0cmFpbC5hdHRyQXJuLCB7XG4gICAgICBzZXJ2aWNlOiAnY2xvdWR0cmFpbCcsXG4gICAgICByZXNvdXJjZTogJ3RyYWlsJyxcbiAgICAgIHJlc291cmNlTmFtZTogdGhpcy5waHlzaWNhbE5hbWUsXG4gICAgfSk7XG4gICAgdGhpcy50cmFpbFNuc1RvcGljQXJuID0gdHJhaWwuYXR0clNuc1RvcGljQXJuO1xuXG4gICAgLy8gQWRkIGEgZGVwZW5kZW5jeSBvbiB0aGUgYnVja2V0IHBvbGljeSBiZWluZyB1cGRhdGVkLCBDbG91ZFRyYWlsIHdpbGwgdGVzdCB0aGlzIHVwb24gY3JlYXRpb24uXG4gICAgaWYgKHRoaXMuczNidWNrZXQucG9saWN5KSB7XG4gICAgICB0cmFpbC5ub2RlLmFkZERlcGVuZGVuY3kodGhpcy5zM2J1Y2tldC5wb2xpY3kpO1xuICAgIH1cblxuICAgIC8vIElmIHByb3BzLnNlbmRUb0Nsb3VkV2F0Y2hMb2dzIGlzIHNldCB0byB0cnVlIHRoZW4gdGhlIHRyYWlsIG5lZWRzIHRvIGRlcGVuZCBvbiB0aGUgY3JlYXRlZCBsb2dzUm9sZVxuICAgIC8vIHNvIHRoYXQgaXQgY2FuIGNyZWF0ZSB0aGUgbG9nIHN0cmVhbSBmb3IgdGhlIGxvZyBncm91cC4gVGhpcyBlbnN1cmVzIHRoZSBsb2dzUm9sZSBpcyBjcmVhdGVkIGFuZCBwcm9wYWdhdGVkXG4gICAgLy8gYmVmb3JlIHRoZSB0cmFpbCB0cmllcyB0byBjcmVhdGUgdGhlIGxvZyBzdHJlYW0uXG4gICAgaWYgKGxvZ3NSb2xlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRyYWlsLm5vZGUuYWRkRGVwZW5kZW5jeShsb2dzUm9sZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gYW4gZXZlbnQgb2NjdXJzIGluIHlvdXIgYWNjb3VudCwgQ2xvdWRUcmFpbCBldmFsdWF0ZXMgd2hldGhlciB0aGUgZXZlbnQgbWF0Y2hlcyB0aGUgc2V0dGluZ3MgZm9yIHlvdXIgdHJhaWxzLlxuICAgKiBPbmx5IGV2ZW50cyB0aGF0IG1hdGNoIHlvdXIgdHJhaWwgc2V0dGluZ3MgYXJlIGRlbGl2ZXJlZCB0byB5b3VyIEFtYXpvbiBTMyBidWNrZXQgYW5kIEFtYXpvbiBDbG91ZFdhdGNoIExvZ3MgbG9nIGdyb3VwLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCBhZGRzIGFuIEV2ZW50IFNlbGVjdG9yIGZvciBmaWx0ZXJpbmcgZXZlbnRzIHRoYXQgbWF0Y2ggZWl0aGVyIFMzIG9yIExhbWJkYSBmdW5jdGlvbiBvcGVyYXRpb25zLlxuICAgKlxuICAgKiBEYXRhIGV2ZW50czogVGhlc2UgZXZlbnRzIHByb3ZpZGUgaW5zaWdodCBpbnRvIHRoZSByZXNvdXJjZSBvcGVyYXRpb25zIHBlcmZvcm1lZCBvbiBvciB3aXRoaW4gYSByZXNvdXJjZS5cbiAgICogVGhlc2UgYXJlIGFsc28ga25vd24gYXMgZGF0YSBwbGFuZSBvcGVyYXRpb25zLlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YVJlc291cmNlVmFsdWVzIHRoZSBsaXN0IG9mIGRhdGEgcmVzb3VyY2UgQVJOcyB0byBpbmNsdWRlIGluIGxvZ2dpbmcgKG1heGltdW0gMjUwIGVudHJpZXMpLlxuICAgKiBAcGFyYW0gb3B0aW9ucyB0aGUgb3B0aW9ucyB0byBjb25maWd1cmUgbG9nZ2luZyBvZiBtYW5hZ2VtZW50IGFuZCBkYXRhIGV2ZW50cy5cbiAgICovXG4gIHB1YmxpYyBhZGRFdmVudFNlbGVjdG9yKGRhdGFSZXNvdXJjZVR5cGU6IERhdGFSZXNvdXJjZVR5cGUsIGRhdGFSZXNvdXJjZVZhbHVlczogc3RyaW5nW10sIG9wdGlvbnM6IEFkZEV2ZW50U2VsZWN0b3JPcHRpb25zID0ge30pIHtcbiAgICBpZiAoZGF0YVJlc291cmNlVmFsdWVzLmxlbmd0aCA+IDI1MCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIG1heGltdW0gb2YgMjUwIGRhdGEgZWxlbWVudHMgY2FuIGJlIGluIG9uZSBldmVudCBzZWxlY3RvcicpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmV2ZW50U2VsZWN0b3JzLmxlbmd0aCA+IDUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQSBtYXhpbXVtIG9mIDUgZXZlbnQgc2VsZWN0b3JzIGFyZSBzdXBwb3J0ZWQgcGVyIHRyYWlsLicpO1xuICAgIH1cblxuICAgIGxldCBpbmNsdWRlQWxsTWFuYWdlbWVudEV2ZW50cztcbiAgICBpZiAodGhpcy5tYW5hZ2VtZW50RXZlbnRzID09PSBSZWFkV3JpdGVUeXBlLk5PTkUpIHtcbiAgICAgIGluY2x1ZGVBbGxNYW5hZ2VtZW50RXZlbnRzID0gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5ldmVudFNlbGVjdG9ycy5wdXNoKHtcbiAgICAgIGRhdGFSZXNvdXJjZXM6IFt7XG4gICAgICAgIHR5cGU6IGRhdGFSZXNvdXJjZVR5cGUsXG4gICAgICAgIHZhbHVlczogZGF0YVJlc291cmNlVmFsdWVzLFxuICAgICAgfV0sXG4gICAgICBpbmNsdWRlTWFuYWdlbWVudEV2ZW50czogb3B0aW9ucy5pbmNsdWRlTWFuYWdlbWVudEV2ZW50cyA/PyBpbmNsdWRlQWxsTWFuYWdlbWVudEV2ZW50cyxcbiAgICAgIGV4Y2x1ZGVNYW5hZ2VtZW50RXZlbnRTb3VyY2VzOiBvcHRpb25zLmV4Y2x1ZGVNYW5hZ2VtZW50RXZlbnRTb3VyY2VzLFxuICAgICAgcmVhZFdyaXRlVHlwZTogb3B0aW9ucy5yZWFkV3JpdGVUeXBlLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gYW4gZXZlbnQgb2NjdXJzIGluIHlvdXIgYWNjb3VudCwgQ2xvdWRUcmFpbCBldmFsdWF0ZXMgd2hldGhlciB0aGUgZXZlbnQgbWF0Y2hlcyB0aGUgc2V0dGluZ3MgZm9yIHlvdXIgdHJhaWxzLlxuICAgKiBPbmx5IGV2ZW50cyB0aGF0IG1hdGNoIHlvdXIgdHJhaWwgc2V0dGluZ3MgYXJlIGRlbGl2ZXJlZCB0byB5b3VyIEFtYXpvbiBTMyBidWNrZXQgYW5kIEFtYXpvbiBDbG91ZFdhdGNoIExvZ3MgbG9nIGdyb3VwLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCBhZGRzIGEgTGFtYmRhIERhdGEgRXZlbnQgU2VsZWN0b3IgZm9yIGZpbHRlcmluZyBldmVudHMgdGhhdCBtYXRjaCBMYW1iZGEgZnVuY3Rpb24gb3BlcmF0aW9ucy5cbiAgICpcbiAgICogRGF0YSBldmVudHM6IFRoZXNlIGV2ZW50cyBwcm92aWRlIGluc2lnaHQgaW50byB0aGUgcmVzb3VyY2Ugb3BlcmF0aW9ucyBwZXJmb3JtZWQgb24gb3Igd2l0aGluIGEgcmVzb3VyY2UuXG4gICAqIFRoZXNlIGFyZSBhbHNvIGtub3duIGFzIGRhdGEgcGxhbmUgb3BlcmF0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIGhhbmRsZXJzIHRoZSBsaXN0IG9mIGxhbWJkYSBmdW5jdGlvbiBoYW5kbGVycyB3aG9zZSBkYXRhIGV2ZW50cyBzaG91bGQgYmUgbG9nZ2VkIChtYXhpbXVtIDI1MCBlbnRyaWVzKS5cbiAgICogQHBhcmFtIG9wdGlvbnMgdGhlIG9wdGlvbnMgdG8gY29uZmlndXJlIGxvZ2dpbmcgb2YgbWFuYWdlbWVudCBhbmQgZGF0YSBldmVudHMuXG4gICAqL1xuICBwdWJsaWMgYWRkTGFtYmRhRXZlbnRTZWxlY3RvcihoYW5kbGVyczogbGFtYmRhLklGdW5jdGlvbltdLCBvcHRpb25zOiBBZGRFdmVudFNlbGVjdG9yT3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKGhhbmRsZXJzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cbiAgICBjb25zdCBkYXRhUmVzb3VyY2VWYWx1ZXMgPSBoYW5kbGVycy5tYXAoKGgpID0+IGguZnVuY3Rpb25Bcm4pO1xuICAgIHJldHVybiB0aGlzLmFkZEV2ZW50U2VsZWN0b3IoRGF0YVJlc291cmNlVHlwZS5MQU1CREFfRlVOQ1RJT04sIGRhdGFSZXNvdXJjZVZhbHVlcywgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogTG9nIGFsbCBMYW1iZGEgZGF0YSBldmVudHMgZm9yIGFsbCBsYW1iZGEgZnVuY3Rpb25zIHRoZSBhY2NvdW50LlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3NjbG91ZHRyYWlsL2xhdGVzdC91c2VyZ3VpZGUvbG9nZ2luZy1kYXRhLWV2ZW50cy13aXRoLWNsb3VkdHJhaWwuaHRtbFxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgcHVibGljIGxvZ0FsbExhbWJkYURhdGFFdmVudHMob3B0aW9uczogQWRkRXZlbnRTZWxlY3Rvck9wdGlvbnMgPSB7fSkge1xuICAgIHJldHVybiB0aGlzLmFkZEV2ZW50U2VsZWN0b3IoRGF0YVJlc291cmNlVHlwZS5MQU1CREFfRlVOQ1RJT04sIFtgYXJuOiR7dGhpcy5zdGFjay5wYXJ0aXRpb259OmxhbWJkYWBdLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaGVuIGFuIGV2ZW50IG9jY3VycyBpbiB5b3VyIGFjY291bnQsIENsb3VkVHJhaWwgZXZhbHVhdGVzIHdoZXRoZXIgdGhlIGV2ZW50IG1hdGNoZXMgdGhlIHNldHRpbmdzIGZvciB5b3VyIHRyYWlscy5cbiAgICogT25seSBldmVudHMgdGhhdCBtYXRjaCB5b3VyIHRyYWlsIHNldHRpbmdzIGFyZSBkZWxpdmVyZWQgdG8geW91ciBBbWF6b24gUzMgYnVja2V0IGFuZCBBbWF6b24gQ2xvdWRXYXRjaCBMb2dzIGxvZyBncm91cC5cbiAgICpcbiAgICogVGhpcyBtZXRob2QgYWRkcyBhbiBTMyBEYXRhIEV2ZW50IFNlbGVjdG9yIGZvciBmaWx0ZXJpbmcgZXZlbnRzIHRoYXQgbWF0Y2ggUzMgb3BlcmF0aW9ucy5cbiAgICpcbiAgICogRGF0YSBldmVudHM6IFRoZXNlIGV2ZW50cyBwcm92aWRlIGluc2lnaHQgaW50byB0aGUgcmVzb3VyY2Ugb3BlcmF0aW9ucyBwZXJmb3JtZWQgb24gb3Igd2l0aGluIGEgcmVzb3VyY2UuXG4gICAqIFRoZXNlIGFyZSBhbHNvIGtub3duIGFzIGRhdGEgcGxhbmUgb3BlcmF0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIHMzU2VsZWN0b3IgdGhlIGxpc3Qgb2YgUzMgYnVja2V0IHdpdGggb3B0aW9uYWwgcHJlZml4IHRvIGluY2x1ZGUgaW4gbG9nZ2luZyAobWF4aW11bSAyNTAgZW50cmllcykuXG4gICAqIEBwYXJhbSBvcHRpb25zIHRoZSBvcHRpb25zIHRvIGNvbmZpZ3VyZSBsb2dnaW5nIG9mIG1hbmFnZW1lbnQgYW5kIGRhdGEgZXZlbnRzLlxuICAgKi9cbiAgcHVibGljIGFkZFMzRXZlbnRTZWxlY3RvcihzM1NlbGVjdG9yOiBTM0V2ZW50U2VsZWN0b3JbXSwgb3B0aW9uczogQWRkRXZlbnRTZWxlY3Rvck9wdGlvbnMgPSB7fSkge1xuICAgIGlmIChzM1NlbGVjdG9yLmxlbmd0aCA9PT0gMCkgeyByZXR1cm47IH1cbiAgICBjb25zdCBkYXRhUmVzb3VyY2VWYWx1ZXMgPSBzM1NlbGVjdG9yLm1hcCgoc2VsKSA9PiBgJHtzZWwuYnVja2V0LmJ1Y2tldEFybn0vJHtzZWwub2JqZWN0UHJlZml4ID8/ICcnfWApO1xuICAgIHJldHVybiB0aGlzLmFkZEV2ZW50U2VsZWN0b3IoRGF0YVJlc291cmNlVHlwZS5TM19PQkpFQ1QsIGRhdGFSZXNvdXJjZVZhbHVlcywgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogTG9nIGFsbCBTMyBkYXRhIGV2ZW50cyBmb3IgYWxsIG9iamVjdHMgZm9yIGFsbCBidWNrZXRzIGluIHRoZSBhY2NvdW50LlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hd3NjbG91ZHRyYWlsL2xhdGVzdC91c2VyZ3VpZGUvbG9nZ2luZy1kYXRhLWV2ZW50cy13aXRoLWNsb3VkdHJhaWwuaHRtbFxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgcHVibGljIGxvZ0FsbFMzRGF0YUV2ZW50cyhvcHRpb25zOiBBZGRFdmVudFNlbGVjdG9yT3B0aW9ucyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkRXZlbnRTZWxlY3RvcihEYXRhUmVzb3VyY2VUeXBlLlMzX09CSkVDVCwgW2Bhcm46JHt0aGlzLnN0YWNrLnBhcnRpdGlvbn06czM6OjpgXSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGFuIGV2ZW50IHJ1bGUgZm9yIHdoZW4gYW4gZXZlbnQgaXMgcmVjb3JkZWQgYnkgYW55IFRyYWlsIGluIHRoZSBhY2NvdW50LlxuICAgKlxuICAgKiBOb3RlIHRoYXQgdGhlIGV2ZW50IGRvZXNuJ3QgbmVjZXNzYXJpbHkgaGF2ZSB0byBjb21lIGZyb20gdGhpcyBUcmFpbCwgaXQgY2FuXG4gICAqIGJlIGNhcHR1cmVkIGZyb20gYW55IG9uZS5cbiAgICpcbiAgICogQmUgc3VyZSB0byBmaWx0ZXIgdGhlIGV2ZW50IGZ1cnRoZXIgZG93biB1c2luZyBhbiBldmVudCBwYXR0ZXJuLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCAtIHVzZSBUcmFpbC5vbkV2ZW50KClcbiAgICovXG4gIHB1YmxpYyBvbkNsb3VkVHJhaWxFdmVudChpZDogc3RyaW5nLCBvcHRpb25zOiBldmVudHMuT25FdmVudE9wdGlvbnMgPSB7fSk6IGV2ZW50cy5SdWxlIHtcbiAgICByZXR1cm4gVHJhaWwub25FdmVudCh0aGlzLCBpZCwgb3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlRXZlbnRTZWxlY3RvcnMoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICAvLyBFbnN1cmUgdGhhdCB0aGVyZSBpcyBhdCBsZWFzdCBvbmUgZXZlbnQgc2VsZWN0b3Igd2hlbiBtYW5hZ2VtZW50IGV2ZW50cyBhcmUgc2V0IHRvIE5vbmVcbiAgICBpZiAodGhpcy5tYW5hZ2VtZW50RXZlbnRzID09PSBSZWFkV3JpdGVUeXBlLk5PTkUgJiYgdGhpcy5ldmVudFNlbGVjdG9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIGVycm9ycy5wdXNoKCdBdCBsZWFzdCBvbmUgZXZlbnQgc2VsZWN0b3IgbXVzdCBiZSBhZGRlZCB3aGVuIG1hbmFnZW1lbnQgZXZlbnQgcmVjb3JkaW5nIGlzIHNldCB0byBOb25lJyk7XG4gICAgfVxuICAgIHJldHVybiBlcnJvcnM7XG4gIH1cbn1cblxuLyoqXG4gKiBPcHRpb25zIGZvciBhZGRpbmcgYW4gZXZlbnQgc2VsZWN0b3IuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQWRkRXZlbnRTZWxlY3Rvck9wdGlvbnMge1xuICAvKipcbiAgICogU3BlY2lmaWVzIHdoZXRoZXIgdG8gbG9nIHJlYWQtb25seSBldmVudHMsIHdyaXRlLW9ubHkgZXZlbnRzLCBvciBhbGwgZXZlbnRzLlxuICAgKlxuICAgKiBAZGVmYXVsdCBSZWFkV3JpdGVUeXBlLkFsbFxuICAgKi9cbiAgcmVhZG9ubHkgcmVhZFdyaXRlVHlwZT86IFJlYWRXcml0ZVR5cGU7XG5cbiAgLyoqXG4gICAqIFNwZWNpZmllcyB3aGV0aGVyIHRoZSBldmVudCBzZWxlY3RvciBpbmNsdWRlcyBtYW5hZ2VtZW50IGV2ZW50cyBmb3IgdGhlIHRyYWlsLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBpbmNsdWRlTWFuYWdlbWVudEV2ZW50cz86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEFuIG9wdGlvbmFsIGxpc3Qgb2Ygc2VydmljZSBldmVudCBzb3VyY2VzIGZyb20gd2hpY2ggeW91IGRvIG5vdCB3YW50IG1hbmFnZW1lbnQgZXZlbnRzIHRvIGJlIGxvZ2dlZCBvbiB5b3VyIHRyYWlsLlxuICAgKlxuICAgKiBAZGVmYXVsdCBbXVxuICAgKi9cbiAgcmVhZG9ubHkgZXhjbHVkZU1hbmFnZW1lbnRFdmVudFNvdXJjZXM/OiBNYW5hZ2VtZW50RXZlbnRTb3VyY2VzW107XG59XG5cbi8qKlxuICogVHlwZXMgb2YgbWFuYWdlbWVudCBldmVudCBzb3VyY2VzIHRoYXQgY2FuIGJlIGV4Y2x1ZGVkXG4gKi9cbmV4cG9ydCBlbnVtIE1hbmFnZW1lbnRFdmVudFNvdXJjZXMge1xuICAvKipcbiAgICogQVdTIEtleSBNYW5hZ2VtZW50IFNlcnZpY2UgKEFXUyBLTVMpIGV2ZW50c1xuICAgKi9cbiAgS01TID0gJ2ttcy5hbWF6b25hd3MuY29tJyxcblxuICAvKipcbiAgICogRGF0YSBBUEkgZXZlbnRzXG4gICAqL1xuICBSRFNfREFUQV9BUEkgPSAncmRzZGF0YS5hbWF6b25hd3MuY29tJyxcbn1cblxuLyoqXG4gKiBTZWxlY3RpbmcgYW4gUzMgYnVja2V0IGFuZCBhbiBvcHRpb25hbCBwcmVmaXggdG8gYmUgbG9nZ2VkIGZvciBkYXRhIGV2ZW50cy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTM0V2ZW50U2VsZWN0b3Ige1xuICAvKiogUzMgYnVja2V0ICovXG4gIHJlYWRvbmx5IGJ1Y2tldDogczMuSUJ1Y2tldDtcblxuICAvKipcbiAgICogRGF0YSBldmVudHMgZm9yIG9iamVjdHMgd2hvc2Uga2V5IG1hdGNoZXMgdGhpcyBwcmVmaXggd2lsbCBiZSBsb2dnZWQuXG4gICAqIEBkZWZhdWx0IC0gYWxsIG9iamVjdHNcbiAgICovXG4gIHJlYWRvbmx5IG9iamVjdFByZWZpeD86IHN0cmluZztcbn1cblxuLyoqXG4gKiBSZXNvdXJjZSB0eXBlIGZvciBhIGRhdGEgZXZlbnRcbiAqL1xuZXhwb3J0IGVudW0gRGF0YVJlc291cmNlVHlwZSB7XG4gIC8qKlxuICAgKiBEYXRhIHJlc291cmNlIHR5cGUgZm9yIExhbWJkYSBmdW5jdGlvblxuICAgKi9cbiAgTEFNQkRBX0ZVTkNUSU9OID0gJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsXG5cbiAgLyoqXG4gICAqIERhdGEgcmVzb3VyY2UgdHlwZSBmb3IgUzMgb2JqZWN0c1xuICAgKi9cbiAgUzNfT0JKRUNUID0gJ0FXUzo6UzM6Ok9iamVjdCcsXG59XG5cbmludGVyZmFjZSBFdmVudFNlbGVjdG9yIHtcbiAgcmVhZG9ubHkgaW5jbHVkZU1hbmFnZW1lbnRFdmVudHM/OiBib29sZWFuO1xuICByZWFkb25seSBleGNsdWRlTWFuYWdlbWVudEV2ZW50U291cmNlcz86IHN0cmluZ1tdO1xuICByZWFkb25seSByZWFkV3JpdGVUeXBlPzogUmVhZFdyaXRlVHlwZTtcbiAgcmVhZG9ubHkgZGF0YVJlc291cmNlcz86IEV2ZW50U2VsZWN0b3JEYXRhW107XG59XG5cbmludGVyZmFjZSBFdmVudFNlbGVjdG9yRGF0YSB7XG4gIHJlYWRvbmx5IHR5cGU6IHN0cmluZztcbiAgcmVhZG9ubHkgdmFsdWVzOiBzdHJpbmdbXTtcbn1cblxuaW50ZXJmYWNlIEluc2lnaHRTZWxlY3RvciB7XG4gIHJlYWRvbmx5IGluc2lnaHRUeXBlPzogc3RyaW5nO1xufSJdfQ==