"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.normalizeRawStringStatistic = exports.normalizeStatistic = exports.parseStatistic = exports.pairStatisticToString = exports.singleStatisticToString = void 0;
const stats_1 = require("../stats");
function parseSingleStatistic(statistic, prefix) {
    const prefixLower = prefix.toLowerCase();
    // Allow `P99` uppercase
    statistic = statistic.toLowerCase();
    if (!statistic.startsWith(prefixLower)) {
        return undefined;
    }
    let r = null;
    // p99.99
    // /^p(\d{1,2}(?:\.\d+)?)$/
    r = new RegExp(`^${prefixLower}(\\d{1,2}(?:\\.\\d+)?)$`).exec(statistic);
    if (r) {
        return {
            type: 'single',
            rawStatistic: statistic,
            statPrefix: prefixLower,
            value: parseFloat(r[1]),
        };
    }
    return undefined;
}
function parsePairStatistic(statistic, prefix) {
    const prefixUpper = prefix.toUpperCase();
    // Allow `tm(10%:90%)` lowercase
    statistic = statistic.toUpperCase();
    if (!statistic.startsWith(prefixUpper)) {
        return undefined;
    }
    const common = {
        type: 'pair',
        canBeSingleStat: false,
        rawStatistic: statistic,
        statPrefix: prefixUpper,
    };
    let r = null;
    // TM(99.999:)
    // /TM\((\d{1,2}(?:\.\d+)?):\)/
    r = new RegExp(`^${prefixUpper}\\((\\d+(?:\\.\\d+)?)\\:\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            lower: parseFloat(r[1]),
            upper: undefined,
            isPercent: false,
        };
    }
    // TM(99.999%:)
    // /TM\((\d{1,2}(?:\.\d+)?)%:\)/
    r = new RegExp(`^${prefixUpper}\\((\\d{1,2}(?:\\.\\d+)?)%\\:\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            lower: parseFloat(r[1]),
            upper: undefined,
            isPercent: true,
        };
    }
    // TM(:99.999)
    // /TM\(:(\d{1,2}(?:\.\d+)?)\)/
    r = new RegExp(`^${prefixUpper}\\(\\:(\\d+(?:\\.\\d+)?)\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            lower: undefined,
            upper: parseFloat(r[1]),
            isPercent: false,
        };
    }
    // TM(:99.999%)
    // /TM\(:(\d{1,2}(?:\.\d+)?)%\)/
    // Note: this can be represented as a single stat! TM(:90%) = tm90
    r = new RegExp(`^${prefixUpper}\\(\\:(\\d{1,2}(?:\\.\\d+)?)%\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            canBeSingleStat: true,
            asSingleStatStr: `${prefix.toLowerCase()}${r[1]}`,
            lower: undefined,
            upper: parseFloat(r[1]),
            isPercent: true,
        };
    }
    // TM(99.999:99.999)
    // /TM\((\d{1,2}(?:\.\d+)?):(\d{1,2}(?:\.\d+)?)\)/
    r = new RegExp(`^${prefixUpper}\\((\\d+(?:\\.\\d+)?)\\:(\\d+(?:\\.\\d+)?)\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            lower: parseFloat(r[1]),
            upper: parseFloat(r[2]),
            isPercent: false,
        };
    }
    // TM(99.999%:99.999%)
    // /TM\((\d{1,2}(?:\.\d+)?)%:(\d{1,2}(?:\.\d+)?)%\)/
    r = new RegExp(`^${prefixUpper}\\((\\d{1,2}(?:\\.\\d+)?)%\\:(\\d{1,2}(?:\\.\\d+)?)%\\)$`).exec(statistic);
    if (r) {
        return {
            ...common,
            lower: parseFloat(r[1]),
            upper: parseFloat(r[2]),
            isPercent: true,
        };
    }
    return undefined;
}
function singleStatisticToString(parsed) {
    return `${parsed.statPrefix}${parsed.value}`;
}
exports.singleStatisticToString = singleStatisticToString;
function pairStatisticToString(parsed) {
    const percent = parsed.isPercent ? '%' : '';
    const lower = parsed.lower ? `${parsed.lower}${percent}` : '';
    const upper = parsed.upper ? `${parsed.upper}${percent}` : '';
    return `${parsed.statPrefix}(${lower}:${upper})`;
}
exports.pairStatisticToString = pairStatisticToString;
/**
 * Parse a statistic, returning the type of metric that was used
 */
function parseStatistic(stat) {
    const lowerStat = stat.toLowerCase();
    // Simple statistics
    const statMap = {
        average: stats_1.Stats.AVERAGE,
        avg: stats_1.Stats.AVERAGE,
        minimum: stats_1.Stats.MINIMUM,
        min: stats_1.Stats.MINIMUM,
        maximum: stats_1.Stats.MAXIMUM,
        max: stats_1.Stats.MAXIMUM,
        samplecount: stats_1.Stats.SAMPLE_COUNT,
        n: stats_1.Stats.SAMPLE_COUNT,
        sum: stats_1.Stats.SUM,
        iqm: stats_1.Stats.IQM,
    };
    if (lowerStat in statMap) {
        return {
            type: 'simple',
            statistic: statMap[lowerStat],
        };
    }
    let m = undefined;
    // Percentile statistics
    m = parseSingleStatistic(stat, 'p');
    if (m)
        return { ...m, statName: 'percentile' };
    // Trimmed mean statistics
    m = parseSingleStatistic(stat, 'tm') || parsePairStatistic(stat, 'tm');
    if (m)
        return { ...m, statName: 'trimmedMean' };
    // Winsorized mean statistics
    m = parseSingleStatistic(stat, 'wm') || parsePairStatistic(stat, 'wm');
    if (m)
        return { ...m, statName: 'winsorizedMean' };
    // Trimmed count statistics
    m = parseSingleStatistic(stat, 'tc') || parsePairStatistic(stat, 'tc');
    if (m)
        return { ...m, statName: 'trimmedCount' };
    // Trimmed sum statistics
    m = parseSingleStatistic(stat, 'ts') || parsePairStatistic(stat, 'ts');
    if (m)
        return { ...m, statName: 'trimmedSum' };
    return {
        type: 'generic',
        statistic: stat,
    };
}
exports.parseStatistic = parseStatistic;
function normalizeStatistic(parsed) {
    if (parsed.type === 'simple' || parsed.type === 'generic') {
        return parsed.statistic;
    }
    else if (parsed.type === 'single') {
        // Avoid parsing because we might get into
        // floating point rounding issues, return as-is but lowercase the stat prefix.
        return parsed.rawStatistic.toLowerCase();
    }
    else if (parsed.type === 'pair') {
        // Avoid parsing because we might get into
        // floating point rounding issues, return as-is but uppercase the stat prefix.
        return parsed.rawStatistic.toUpperCase();
    }
    return '';
}
exports.normalizeStatistic = normalizeStatistic;
function normalizeRawStringStatistic(stat) {
    const parsed = parseStatistic(stat);
    return normalizeStatistic(parsed);
}
exports.normalizeRawStringStatistic = normalizeRawStringStatistic;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGlzdGljLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3RhdGlzdGljLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9DQUFpQztBQW9EakMsU0FBUyxvQkFBb0IsQ0FBQyxTQUFpQixFQUFFLE1BQWM7SUFDN0QsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXpDLHdCQUF3QjtJQUN4QixTQUFTLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXBDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQ3RDLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsSUFBSSxDQUFDLEdBQTJCLElBQUksQ0FBQztJQUVyQyxTQUFTO0lBQ1QsMkJBQTJCO0lBQzNCLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLFdBQVcseUJBQXlCLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDekUsSUFBSSxDQUFDLEVBQUU7UUFDTCxPQUFPO1lBQ0wsSUFBSSxFQUFFLFFBQVE7WUFDZCxZQUFZLEVBQUUsU0FBUztZQUN2QixVQUFVLEVBQUUsV0FBVztZQUN2QixLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QixDQUFDO0tBQ0g7SUFFRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxTQUFpQixFQUFFLE1BQWM7SUFDM0QsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXpDLGdDQUFnQztJQUNoQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRXBDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQ3RDLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsTUFBTSxNQUFNLEdBQWtEO1FB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bSAnLi4vc3RhdHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNpbXBsZVN0YXRpc3RpYyB7XG4gIHR5cGU6ICdzaW1wbGUnO1xuICBzdGF0aXN0aWM6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZW5lcmljU3RhdGlzdGljIHtcbiAgdHlwZTogJ2dlbmVyaWMnO1xuICBzdGF0aXN0aWM6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQYXJzZWFibGVTdGF0aXN0aWMge1xuICBzdGF0UHJlZml4OiBzdHJpbmc7XG4gIHN0YXROYW1lOiBzdHJpbmc7XG4gIHJhd1N0YXRpc3RpYzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNpbmdsZVN0YXRpc3RpYyBleHRlbmRzIFBhcnNlYWJsZVN0YXRpc3RpYyB7XG4gIHR5cGU6ICdzaW5nbGUnO1xuICB2YWx1ZTogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhaXJTdGF0aXN0aWMgZXh0ZW5kcyBQYXJzZWFibGVTdGF0aXN0aWMge1xuICB0eXBlOiAncGFpcic7XG4gIGlzUGVyY2VudDogYm9vbGVhbjtcbiAgbG93ZXI/OiBudW1iZXI7XG4gIHVwcGVyPzogbnVtYmVyO1xuICBjYW5CZVNpbmdsZVN0YXQ6IGJvb2xlYW47XG4gIGFzU2luZ2xlU3RhdFN0cj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZXJjZW50aWxlU3RhdGlzdGljIGV4dGVuZHMgU2luZ2xlU3RhdGlzdGljIHtcbiAgc3RhdE5hbWU6ICdwZXJjZW50aWxlJztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmltbWVkTWVhblN0YXRpc3RpYyBleHRlbmRzIFBhaXJTdGF0aXN0aWMge1xuICBzdGF0TmFtZTogJ3RyaW1tZWRNZWFuJztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaW5zb3JpemVkTWVhblN0YXRpc3RpYyBleHRlbmRzIFBhaXJTdGF0aXN0aWMge1xuICBzdGF0TmFtZTogJ3dpbnNvcml6ZWRNZWFuJztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmltbWVkQ291bnRTdGF0aXN0aWMgZXh0ZW5kcyBQYWlyU3RhdGlzdGljIHtcbiAgc3RhdE5hbWU6ICd0cmltbWVkQ291bnQnO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyaW1tZWRTdW1TdGF0aXN0aWMgZXh0ZW5kcyBQYWlyU3RhdGlzdGljIHtcbiAgc3RhdE5hbWU6ICd0cmltbWVkU3VtJztcbn1cblxuZnVuY3Rpb24gcGFyc2VTaW5nbGVTdGF0aXN0aWMoc3RhdGlzdGljOiBzdHJpbmcsIHByZWZpeDogc3RyaW5nKTogT21pdDxTaW5nbGVTdGF0aXN0aWMsICdzdGF0TmFtZSc+IHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgcHJlZml4TG93ZXIgPSBwcmVmaXgudG9Mb3dlckNhc2UoKTtcblxuICAvLyBBbGxvdyBgUDk5YCB1cHBlcmNhc2VcbiAgc3RhdGlzdGljID0gc3RhdGlzdGljLnRvTG93ZXJDYXNlKCk7XG5cbiAgaWYgKCFzdGF0aXN0aWMuc3RhcnRzV2l0aChwcmVmaXhMb3dlcikpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgbGV0IHI6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGwgPSBudWxsO1xuXG4gIC8vIHA5OS45OVxuICAvLyAvXnAoXFxkezEsMn0oPzpcXC5cXGQrKT8pJC9cbiAgciA9IG5ldyBSZWdFeHAoYF4ke3ByZWZpeExvd2VyfShcXFxcZHsxLDJ9KD86XFxcXC5cXFxcZCspPykkYCkuZXhlYyhzdGF0aXN0aWMpO1xuICBpZiAocikge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnc2luZ2xlJyxcbiAgICAgIHJhd1N0YXRpc3RpYzogc3RhdGlzdGljLFxuICAgICAgc3RhdFByZWZpeDogcHJlZml4TG93ZXIsXG4gICAgICB2YWx1ZTogcGFyc2VGbG9hdChyWzFdKSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gcGFyc2VQYWlyU3RhdGlzdGljKHN0YXRpc3RpYzogc3RyaW5nLCBwcmVmaXg6IHN0cmluZyk6IE9taXQ8UGFpclN0YXRpc3RpYywgJ3N0YXROYW1lJz4gfCB1bmRlZmluZWQge1xuICBjb25zdCBwcmVmaXhVcHBlciA9IHByZWZpeC50b1VwcGVyQ2FzZSgpO1xuXG4gIC8vIEFsbG93IGB0bSgxMCU6OTAlKWAgbG93ZXJjYXNlXG4gIHN0YXRpc3RpYyA9IHN0YXRpc3RpYy50b1VwcGVyQ2FzZSgpO1xuXG4gIGlmICghc3RhdGlzdGljLnN0YXJ0c1dpdGgocHJlZml4VXBwZXIpKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IGNvbW1vbjogT21pdDxQYWlyU3RhdGlzdGljLCAnc3RhdE5hbWUnIHwgJ2lzUGVyY2VudCc+ID0ge1xuICAgIHR5cGU6ICdwYWlyJyxcbiAgICBjYW5CZVNpbmdsZVN0YXQ6IGZhbHNlLFxuICAgIHJhd1N0YXRpc3RpYzogc3RhdGlzdGljLFxuICAgIHN0YXRQcmVmaXg6IHByZWZpeFVwcGVyLFxuICB9O1xuXG4gIGxldCByOiBSZWdFeHBFeGVjQXJyYXkgfCBudWxsID0gbnVsbDtcblxuICAvLyBUTSg5OS45OTk6KVxuICAvLyAvVE1cXCgoXFxkezEsMn0oPzpcXC5cXGQrKT8pOlxcKS9cbiAgciA9IG5ldyBSZWdFeHAoYF4ke3ByZWZpeFVwcGVyfVxcXFwoKFxcXFxkKyg/OlxcXFwuXFxcXGQrKT8pXFxcXDpcXFxcKSRgKS5leGVjKHN0YXRpc3RpYyk7XG4gIGlmIChyKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvbW1vbixcbiAgICAgIGxvd2VyOiBwYXJzZUZsb2F0KHJbMV0pLFxuICAgICAgdXBwZXI6IHVuZGVmaW5lZCxcbiAgICAgIGlzUGVyY2VudDogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFRNKDk5Ljk5OSU6KVxuICAvLyAvVE1cXCgoXFxkezEsMn0oPzpcXC5cXGQrKT8pJTpcXCkvXG4gIHIgPSBuZXcgUmVnRXhwKGBeJHtwcmVmaXhVcHBlcn1cXFxcKChcXFxcZHsxLDJ9KD86XFxcXC5cXFxcZCspPyklXFxcXDpcXFxcKSRgKS5leGVjKHN0YXRpc3RpYyk7XG4gIGlmIChyKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmNvbW1vbixcbiAgICAgIGxvd2VyOiBwYXJzZUZsb2F0KHJbMV0pLFxuICAgICAgdXBwZXI6IHVuZGVmaW5lZCxcbiAgICAgIGlzUGVyY2VudDogdHJ1ZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gVE0oOjk5Ljk5OSlcbiAgLy8gL1RNXFwoOihcXGR7MSwyfSg/OlxcLlxcZCspPylcXCkvXG4gIHIgPSBuZXcgUmVnRXhwKGBeJHtwcmVmaXhVcHBlcn1cXFxcKFxcXFw6KFxcXFxkKyg/OlxcXFwuXFxcXGQrKT8pXFxcXCkkYCkuZXhlYyhzdGF0aXN0aWMpO1xuICBpZiAocikge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5jb21tb24sXG4gICAgICBsb3dlcjogdW5kZWZpbmVkLFxuICAgICAgdXBwZXI6IHBhcnNlRmxvYXQoclsxXSksXG4gICAgICBpc1BlcmNlbnQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyBUTSg6OTkuOTk5JSlcbiAgLy8gL1RNXFwoOihcXGR7MSwyfSg/OlxcLlxcZCspPyklXFwpL1xuICAvLyBOb3RlOiB0aGlzIGNhbiBiZSByZXByZXNlbnRlZCBhcyBhIHNpbmdsZSBzdGF0ISBUTSg6OTAlKSA9IHRtOTBcbiAgciA9IG5ldyBSZWdFeHAoYF4ke3ByZWZpeFVwcGVyfVxcXFwoXFxcXDooXFxcXGR7MSwyfSg/OlxcXFwuXFxcXGQrKT8pJVxcXFwpJGApLmV4ZWMoc3RhdGlzdGljKTtcbiAgaWYgKHIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uY29tbW9uLFxuICAgICAgY2FuQmVTaW5nbGVTdGF0OiB0cnVlLFxuICAgICAgYXNTaW5nbGVTdGF0U3RyOiBgJHtwcmVmaXgudG9Mb3dlckNhc2UoKX0ke3JbMV19YCxcbiAgICAgIGxvd2VyOiB1bmRlZmluZWQsXG4gICAgICB1cHBlcjogcGFyc2VGbG9hdChyWzFdKSxcbiAgICAgIGlzUGVyY2VudDogdHJ1ZSxcbiAgICB9O1xuICB9XG5cbiAgLy8gVE0oOTkuOTk5Ojk5Ljk5OSlcbiAgLy8gL1RNXFwoKFxcZHsxLDJ9KD86XFwuXFxkKyk/KTooXFxkezEsMn0oPzpcXC5cXGQrKT8pXFwpL1xuICByID0gbmV3IFJlZ0V4cChgXiR7cHJlZml4VXBwZXJ9XFxcXCgoXFxcXGQrKD86XFxcXC5cXFxcZCspPylcXFxcOihcXFxcZCsoPzpcXFxcLlxcXFxkKyk/KVxcXFwpJGApLmV4ZWMoc3RhdGlzdGljKTtcbiAgaWYgKHIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uY29tbW9uLFxuICAgICAgbG93ZXI6IHBhcnNlRmxvYXQoclsxXSksXG4gICAgICB1cHBlcjogcGFyc2VGbG9hdChyWzJdKSxcbiAgICAgIGlzUGVyY2VudDogZmFsc2UsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFRNKDk5Ljk5OSU6OTkuOTk5JSlcbiAgLy8gL1RNXFwoKFxcZHsxLDJ9KD86XFwuXFxkKyk/KSU6KFxcZHsxLDJ9KD86XFwuXFxkKyk/KSVcXCkvXG4gIHIgPSBuZXcgUmVnRXhwKGBeJHtwcmVmaXhVcHBlcn1cXFxcKChcXFxcZHsxLDJ9KD86XFxcXC5cXFxcZCspPyklXFxcXDooXFxcXGR7MSwyfSg/OlxcXFwuXFxcXGQrKT8pJVxcXFwpJGApLmV4ZWMoc3RhdGlzdGljKTtcbiAgaWYgKHIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uY29tbW9uLFxuICAgICAgbG93ZXI6IHBhcnNlRmxvYXQoclsxXSksXG4gICAgICB1cHBlcjogcGFyc2VGbG9hdChyWzJdKSxcbiAgICAgIGlzUGVyY2VudDogdHJ1ZSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNpbmdsZVN0YXRpc3RpY1RvU3RyaW5nKHBhcnNlZDogU2luZ2xlU3RhdGlzdGljKTogc3RyaW5nIHtcbiAgcmV0dXJuIGAke3BhcnNlZC5zdGF0UHJlZml4fSR7cGFyc2VkLnZhbHVlfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYWlyU3RhdGlzdGljVG9TdHJpbmcocGFyc2VkOiBQYWlyU3RhdGlzdGljKTogc3RyaW5nIHtcbiAgY29uc3QgcGVyY2VudCA9IHBhcnNlZC5pc1BlcmNlbnQgPyAnJScgOiAnJztcbiAgY29uc3QgbG93ZXIgPSBwYXJzZWQubG93ZXIgPyBgJHtwYXJzZWQubG93ZXJ9JHtwZXJjZW50fWAgOiAnJztcbiAgY29uc3QgdXBwZXIgPSBwYXJzZWQudXBwZXIgPyBgJHtwYXJzZWQudXBwZXJ9JHtwZXJjZW50fWAgOiAnJztcbiAgcmV0dXJuIGAke3BhcnNlZC5zdGF0UHJlZml4fSgke2xvd2VyfToke3VwcGVyfSlgO1xufVxuXG4vKipcbiAqIFBhcnNlIGEgc3RhdGlzdGljLCByZXR1cm5pbmcgdGhlIHR5cGUgb2YgbWV0cmljIHRoYXQgd2FzIHVzZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlU3RhdGlzdGljKFxuICBzdGF0OiBzdHJpbmcsXG4pOlxuICB8IFNpbXBsZVN0YXRpc3RpY1xuICB8IFBlcmNlbnRpbGVTdGF0aXN0aWNcbiAgfCBUcmltbWVkTWVhblN0YXRpc3RpY1xuICB8IFdpbnNvcml6ZWRNZWFuU3RhdGlzdGljXG4gIHwgVHJpbW1lZENvdW50U3RhdGlzdGljXG4gIHwgVHJpbW1lZFN1bVN0YXRpc3RpY1xuICB8IEdlbmVyaWNTdGF0aXN0aWMge1xuICBjb25zdCBsb3dlclN0YXQgPSBzdGF0LnRvTG93ZXJDYXNlKCk7XG5cbiAgLy8gU2ltcGxlIHN0YXRpc3RpY3NcbiAgY29uc3Qgc3RhdE1hcDogeyBbazogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gICAgYXZlcmFnZTogU3RhdHMuQVZFUkFHRSxcbiAgICBhdmc6IFN0YXRzLkFWRVJBR0UsXG4gICAgbWluaW11bTogU3RhdHMuTUlOSU1VTSxcbiAgICBtaW46IFN0YXRzLk1JTklNVU0sXG4gICAgbWF4aW11bTogU3RhdHMuTUFYSU1VTSxcbiAgICBtYXg6IFN0YXRzLk1BWElNVU0sXG4gICAgc2FtcGxlY291bnQ6IFN0YXRzLlNBTVBMRV9DT1VOVCxcbiAgICBuOiBTdGF0cy5TQU1QTEVfQ09VTlQsXG4gICAgc3VtOiBTdGF0cy5TVU0sXG4gICAgaXFtOiBTdGF0cy5JUU0sXG4gIH07XG5cbiAgaWYgKGxvd2VyU3RhdCBpbiBzdGF0TWFwKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6ICdzaW1wbGUnLFxuICAgICAgc3RhdGlzdGljOiBzdGF0TWFwW2xvd2VyU3RhdF0sXG4gICAgfSBhcyBTaW1wbGVTdGF0aXN0aWM7XG4gIH1cblxuICBsZXQgbTogUmV0dXJuVHlwZTx0eXBlb2YgcGFyc2VTaW5nbGVTdGF0aXN0aWM+IHwgUmV0dXJuVHlwZTx0eXBlb2YgcGFyc2VQYWlyU3RhdGlzdGljPiA9IHVuZGVmaW5lZDtcblxuICAvLyBQZXJjZW50aWxlIHN0YXRpc3RpY3NcbiAgbSA9IHBhcnNlU2luZ2xlU3RhdGlzdGljKHN0YXQsICdwJyk7XG4gIGlmIChtKSByZXR1cm4geyAuLi5tLCBzdGF0TmFtZTogJ3BlcmNlbnRpbGUnIH0gYXMgUGVyY2VudGlsZVN0YXRpc3RpYztcblxuICAvLyBUcmltbWVkIG1lYW4gc3RhdGlzdGljc1xuICBtID0gcGFyc2VTaW5nbGVTdGF0aXN0aWMoc3RhdCwgJ3RtJykgfHwgcGFyc2VQYWlyU3RhdGlzdGljKHN0YXQsICd0bScpO1xuICBpZiAobSkgcmV0dXJuIHsgLi4ubSwgc3RhdE5hbWU6ICd0cmltbWVkTWVhbicgfSBhcyBUcmltbWVkTWVhblN0YXRpc3RpYztcblxuICAvLyBXaW5zb3JpemVkIG1lYW4gc3RhdGlzdGljc1xuICBtID0gcGFyc2VTaW5nbGVTdGF0aXN0aWMoc3RhdCwgJ3dtJykgfHwgcGFyc2VQYWlyU3RhdGlzdGljKHN0YXQsICd3bScpO1xuICBpZiAobSkgcmV0dXJuIHsgLi4ubSwgc3RhdE5hbWU6ICd3aW5zb3JpemVkTWVhbicgfSBhcyBXaW5zb3JpemVkTWVhblN0YXRpc3RpYztcblxuICAvLyBUcmltbWVkIGNvdW50IHN0YXRpc3RpY3NcbiAgbSA9IHBhcnNlU2luZ2xlU3RhdGlzdGljKHN0YXQsICd0YycpIHx8IHBhcnNlUGFpclN0YXRpc3RpYyhzdGF0LCAndGMnKTtcbiAgaWYgKG0pIHJldHVybiB7IC4uLm0sIHN0YXROYW1lOiAndHJpbW1lZENvdW50JyB9IGFzIFRyaW1tZWRDb3VudFN0YXRpc3RpYztcblxuICAvLyBUcmltbWVkIHN1bSBzdGF0aXN0aWNzXG4gIG0gPSBwYXJzZVNpbmdsZVN0YXRpc3RpYyhzdGF0LCAndHMnKSB8fCBwYXJzZVBhaXJTdGF0aXN0aWMoc3RhdCwgJ3RzJyk7XG4gIGlmIChtKSByZXR1cm4geyAuLi5tLCBzdGF0TmFtZTogJ3RyaW1tZWRTdW0nIH0gYXMgVHJpbW1lZFN1bVN0YXRpc3RpYztcblxuICByZXR1cm4ge1xuICAgIHR5cGU6ICdnZW5lcmljJyxcbiAgICBzdGF0aXN0aWM6IHN0YXQsXG4gIH0gYXMgR2VuZXJpY1N0YXRpc3RpYztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVN0YXRpc3RpYyhwYXJzZWQ6IFJldHVyblR5cGU8dHlwZW9mIHBhcnNlU3RhdGlzdGljPik6IHN0cmluZyB7XG4gIGlmIChwYXJzZWQudHlwZSA9PT0gJ3NpbXBsZScgfHwgcGFyc2VkLnR5cGUgPT09ICdnZW5lcmljJykge1xuICAgIHJldHVybiBwYXJzZWQuc3RhdGlzdGljO1xuICB9IGVsc2UgaWYgKHBhcnNlZC50eXBlID09PSAnc2luZ2xlJykge1xuICAgIC8vIEF2b2lkIHBhcnNpbmcgYmVjYXVzZSB3ZSBtaWdodCBnZXQgaW50b1xuICAgIC8vIGZsb2F0aW5nIHBvaW50IHJvdW5kaW5nIGlzc3VlcywgcmV0dXJuIGFzLWlzIGJ1dCBsb3dlcmNhc2UgdGhlIHN0YXQgcHJlZml4LlxuICAgIHJldHVybiBwYXJzZWQucmF3U3RhdGlzdGljLnRvTG93ZXJDYXNlKCk7XG4gIH0gZWxzZSBpZiAocGFyc2VkLnR5cGUgPT09ICdwYWlyJykge1xuICAgIC8vIEF2b2lkIHBhcnNpbmcgYmVjYXVzZSB3ZSBtaWdodCBnZXQgaW50b1xuICAgIC8vIGZsb2F0aW5nIHBvaW50IHJvdW5kaW5nIGlzc3VlcywgcmV0dXJuIGFzLWlzIGJ1dCB1cHBlcmNhc2UgdGhlIHN0YXQgcHJlZml4LlxuICAgIHJldHVybiBwYXJzZWQucmF3U3RhdGlzdGljLnRvVXBwZXJDYXNlKCk7XG4gIH1cblxuICByZXR1cm4gJyc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVSYXdTdHJpbmdTdGF0aXN0aWMoc3RhdDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgcGFyc2VkID0gcGFyc2VTdGF0aXN0aWMoc3RhdCk7XG4gIHJldHVybiBub3JtYWxpemVTdGF0aXN0aWMocGFyc2VkKTtcbn1cbiJdfQ==