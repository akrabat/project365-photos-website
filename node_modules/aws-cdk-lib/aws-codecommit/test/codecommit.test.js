"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path_1 = require("path");
const assertions_1 = require("../../assertions");
const aws_iam_1 = require("../../aws-iam");
const aws_s3_assets_1 = require("../../aws-s3-assets");
const core_1 = require("../../core");
const lib_1 = require("../lib");
describe('codecommit', () => {
    describe('CodeCommit Repositories', () => {
        test('add an SNS trigger to repository', () => {
            const stack = new core_1.Stack();
            const props = {
                repositoryName: 'MyRepository',
            };
            const snsArn = 'arn:aws:sns:*:123456789012:my_topic';
            new lib_1.Repository(stack, 'MyRepository', props).notify(snsArn);
            assertions_1.Template.fromStack(stack).templateMatches({
                Resources: {
                    MyRepository4C4BD5FC: {
                        Type: 'AWS::CodeCommit::Repository',
                        Properties: {
                            RepositoryName: 'MyRepository',
                            Triggers: [
                                {
                                    Events: [
                                        'all',
                                    ],
                                    DestinationArn: 'arn:aws:sns:*:123456789012:my_topic',
                                    Name: 'Default/MyRepository/arn:aws:sns:*:123456789012:my_topic',
                                },
                            ],
                        },
                    },
                },
            });
        });
        test('fails when triggers have duplicate names', () => {
            const stack = new core_1.Stack();
            const myRepository = new lib_1.Repository(stack, 'MyRepository', {
                repositoryName: 'MyRepository',
            }).notify('myTrigger');
            expect(() => myRepository.notify('myTrigger')).toThrow();
        });
        test('can be imported using a Repository ARN', () => {
            // GIVEN
            const stack = new core_1.Stack();
            const repositoryArn = 'arn:aws:codecommit:us-east-1:585695036304:my-repo';
            // WHEN
            const repo = lib_1.Repository.fromRepositoryArn(stack, 'ImportedRepo', repositoryArn);
            // THEN
            expect(stack.resolve(repo.repositoryArn)).toEqual(repositoryArn);
            expect(stack.resolve(repo.repositoryName)).toEqual('my-repo');
        });
        test('Repository can be initialized with contents from a ZIP file', () => {
            // GIVEN
            const app = new core_1.App();
            const stack = new core_1.Stack(app, 'MyStack');
            // WHEN
            new lib_1.Repository(stack, 'Repository', {
                repositoryName: 'MyRepositoryName',
                code: lib_1.Code.fromZipFile((0, path_1.join)(__dirname, 'asset-test.zip')),
            });
            const assembly = app.synth();
            const assets = JSON.parse(fs.readFileSync((0, path_1.join)(assembly.directory, `${stack.stackName}.assets.json`), 'utf-8'));
            // our asset + the template itself
            expect(Object.entries(assets.files)).toHaveLength(2);
        });
        test('Repository can be initialized with contents from a directory', () => {
            // GIVEN
            const app = new core_1.App();
            const stack = new core_1.Stack(app, 'MyStack');
            // WHEN
            new lib_1.Repository(stack, 'Repository', {
                repositoryName: 'MyRepositoryName',
                code: lib_1.Code.fromDirectory((0, path_1.join)(__dirname, 'asset-test')),
            });
            const assembly = app.synth();
            const assets = JSON.parse(fs.readFileSync((0, path_1.join)(assembly.directory, `${stack.stackName}.assets.json`), 'utf-8'));
            // our asset + the template itself
            expect(Object.entries(assets.files)).toHaveLength(2);
        });
        test('Repository can be initialized with contents from an asset', () => {
            // GIVEN
            const app = new core_1.App();
            const stack = new core_1.Stack(app, 'MyStack');
            const readmeAsset = new aws_s3_assets_1.Asset(stack, 'ReadmeAsset', {
                path: (0, path_1.join)(__dirname, 'asset-test'),
            });
            // WHEN
            new lib_1.Repository(stack, 'Repository', {
                repositoryName: 'MyRepositoryName',
                code: lib_1.Code.fromAsset(readmeAsset),
            });
            // THEN
            const assembly = app.synth();
            const assets = JSON.parse(fs.readFileSync((0, path_1.join)(assembly.directory, `${stack.stackName}.assets.json`), 'utf-8'));
            // our asset + the template itself
            expect(Object.entries(assets.files)).toHaveLength(2);
        });
        test('Repository throws Error when initialized with file while expecting directory', () => {
            // GIVEN
            const app = new core_1.App();
            const stack = new core_1.Stack(app, 'MyStack');
            const filePath = (0, path_1.join)(__dirname, 'asset-test/test.md');
            // THEN
            expect(() => {
                new lib_1.Repository(stack, 'Repository', {
                    repositoryName: 'MyRepositoryName',
                    code: lib_1.Code.fromDirectory(filePath),
                });
            }).toThrow(`'${filePath}' needs to be a path to a directory (resolved to: '${(0, path_1.resolve)(filePath)}')`);
        });
        test('Repository throws Error when initialized with directory while expecting file', () => {
            // GIVEN
            const app = new core_1.App();
            const stack = new core_1.Stack(app, 'MyStack');
            const dirPath = (0, path_1.join)(__dirname, 'asset-test/');
            // THEN
            expect(() => {
                new lib_1.Repository(stack, 'Repository', {
                    repositoryName: 'MyRepositoryName',
                    code: lib_1.Code.fromZipFile(dirPath),
                });
            }).toThrow(`'${dirPath}' needs to be a path to a ZIP file (resolved to: '${(0, path_1.resolve)(dirPath)}')`);
        });
        /**
         * Fix for https://github.com/aws/aws-cdk/issues/10630
         */
        test('can be imported using a Repository ARN and respect the region in clone urls', () => {
            // GIVEN
            const stack = new core_1.Stack();
            const repositoryArn = 'arn:aws:codecommit:us-west-2:585695036304:my-repo';
            // WHEN
            const repo = lib_1.Repository.fromRepositoryArn(stack, 'ImportedRepo', repositoryArn);
            // THEN
            // a fully qualified arn should use the region from the arn
            expect(stack.resolve(repo.repositoryCloneUrlHttp)).toEqual({
                'Fn::Join': [
                    '',
                    [
                        'https://git-codecommit.us-west-2.',
                        { Ref: 'AWS::URLSuffix' },
                        '/v1/repos/my-repo',
                    ],
                ],
            });
            expect(stack.resolve(repo.repositoryCloneUrlSsh)).toEqual({
                'Fn::Join': [
                    '',
                    [
                        'ssh://git-codecommit.us-west-2.',
                        { Ref: 'AWS::URLSuffix' },
                        '/v1/repos/my-repo',
                    ],
                ],
            });
            expect(stack.resolve(repo.repositoryCloneUrlGrc)).toEqual('codecommit::us-west-2://my-repo');
            expect(repo.env.account).toEqual('585695036304');
            expect(repo.env.region).toEqual('us-west-2');
        });
        test('can be imported using just a Repository name (the ARN is deduced)', () => {
            // GIVEN
            const stack = new core_1.Stack();
            // WHEN
            const repo = lib_1.Repository.fromRepositoryName(stack, 'ImportedRepo', 'my-repo');
            // THEN
            expect(stack.resolve(repo.repositoryArn)).toEqual({
                'Fn::Join': ['', [
                        'arn:',
                        { Ref: 'AWS::Partition' },
                        ':codecommit:',
                        { Ref: 'AWS::Region' },
                        ':',
                        { Ref: 'AWS::AccountId' },
                        ':my-repo',
                    ]],
            });
            expect(stack.resolve(repo.repositoryName)).toEqual('my-repo');
            //local name resolution should use stack region
            expect(stack.resolve(repo.repositoryCloneUrlHttp)).toEqual({
                'Fn::Join': [
                    '',
                    [
                        'https://git-codecommit.',
                        { Ref: 'AWS::Region' },
                        '.',
                        { Ref: 'AWS::URLSuffix' },
                        '/v1/repos/my-repo',
                    ],
                ],
            });
            expect(stack.resolve(repo.repositoryCloneUrlGrc)).toEqual({
                'Fn::Join': [
                    '',
                    [
                        'codecommit::',
                        { Ref: 'AWS::Region' },
                        '://my-repo',
                    ],
                ],
            });
        });
        test('grant push', () => {
            // GIVEN
            const stack = new core_1.Stack();
            const repository = new lib_1.Repository(stack, 'Repo', {
                repositoryName: 'repo-name',
            });
            const role = new aws_iam_1.Role(stack, 'Role', {
                assumedBy: new aws_iam_1.ServicePrincipal('ec2.amazonaws.com'),
            });
            // WHEN
            repository.grantPullPush(role);
            // THEN
            assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
                PolicyDocument: {
                    Statement: [
                        {
                            Action: 'codecommit:GitPull',
                            Effect: 'Allow',
                            Resource: {
                                'Fn::GetAtt': [
                                    'Repo02AC86CF',
                                    'Arn',
                                ],
                            },
                        },
                        {
                            Action: 'codecommit:GitPush',
                            Effect: 'Allow',
                            Resource: {
                                'Fn::GetAtt': [
                                    'Repo02AC86CF',
                                    'Arn',
                                ],
                            },
                        },
                    ],
                    Version: '2012-10-17',
                },
            });
        });
        test('HTTPS (GRC) clone URL', () => {
            const stack = new core_1.Stack();
            const repository = new lib_1.Repository(stack, 'Repository', {
                repositoryName: 'my-repo',
            });
            expect(stack.resolve(repository.repositoryCloneUrlGrc)).toEqual({
                'Fn::Join': [
                    '',
                    [
                        'codecommit::',
                        { Ref: 'AWS::Region' },
                        '://',
                        { 'Fn::GetAtt': ['Repository22E53BBD', 'Name'] },
                    ],
                ],
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWNvbW1pdC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29kZWNvbW1pdC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUJBQXlCO0FBQ3pCLCtCQUFxQztBQUNyQyxpREFBNEM7QUFDNUMsMkNBQXVEO0FBQ3ZELHVEQUE0QztBQUM1QyxxQ0FBd0M7QUFDeEMsZ0NBQTJEO0FBRTNELFFBQVEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxFQUFFO0lBQzFCLFFBQVEsQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLEVBQUU7UUFDdkMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRTtZQUM1QyxNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO1lBRTFCLE1BQU0sS0FBSyxHQUFvQjtnQkFDN0IsY0FBYyxFQUFFLGNBQWM7YUFDL0IsQ0FBQztZQUVGLE1BQU0sTUFBTSxHQUFHLHFDQUFxQyxDQUFDO1lBRXJELElBQUksZ0JBQVUsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUU1RCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUM7Z0JBQ3hDLFNBQVMsRUFBRTtvQkFDVCxvQkFBb0IsRUFBRTt3QkFDcEIsSUFBSSxFQUFFLDZCQUE2Qjt3QkFDbkMsVUFBVSxFQUFFOzRCQUNWLGNBQWMsRUFBRSxjQUFjOzRCQUM5QixRQUFRLEVBQUU7Z0NBQ1I7b0NBQ0UsTUFBTSxFQUFFO3dDQUNOLEtBQUs7cUNBQ047b0NBQ0QsY0FBYyxFQUFFLHFDQUFxQztvQ0FDckQsSUFBSSxFQUFFLDBEQUEwRDtpQ0FDakU7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7UUFHTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQywwQ0FBMEMsRUFBRSxHQUFHLEVBQUU7WUFDcEQsTUFBTSxLQUFLLEdB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QkFDRjtxQkFDRjtvQkFDRCxPQUFPLEVBQUUsWUFBWTtpQkFDdEI7YUFDRixDQUFDLENBQUM7UUFHTCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7WUFDakMsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztZQUUxQixNQUFNLFVBQVUsR0FBRyxJQUFJLGdCQUFVLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRTtnQkFDckQsY0FBYyxFQUFFLFNBQVM7YUFDMUIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQzlELFVBQVUsRUFBRTtvQkFDVixFQUFFO29CQUNGO3dCQUNFLGNBQWM7d0JBQ2QsRUFBRSxHQUFHLEVBQUUsYUFBYSxFQUFFO3dCQUN0QixLQUFLO3dCQUNMLEVBQUUsWUFBWSxFQUFFLENBQUMsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLEVBQUU7cUJBQ2pEO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1FBR0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiwgcmVzb2x2ZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCB7IFJvbGUsIFNlcnZpY2VQcmluY2lwYWwgfSBmcm9tICcuLi8uLi9hd3MtaWFtJztcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnLi4vLi4vYXdzLXMzLWFzc2V0cyc7XG5pbXBvcnQgeyBBcHAsIFN0YWNrIH0gZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDb2RlLCBSZXBvc2l0b3J5LCBSZXBvc2l0b3J5UHJvcHMgfSBmcm9tICcuLi9saWInO1xuXG5kZXNjcmliZSgnY29kZWNvbW1pdCcsICgpID0+IHtcbiAgZGVzY3JpYmUoJ0NvZGVDb21taXQgUmVwb3NpdG9yaWVzJywgKCkgPT4ge1xuICAgIHRlc3QoJ2FkZCBhbiBTTlMgdHJpZ2dlciB0byByZXBvc2l0b3J5JywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgICAgY29uc3QgcHJvcHM6IFJlcG9zaXRvcnlQcm9wcyA9IHtcbiAgICAgICAgcmVwb3NpdG9yeU5hbWU6ICdNeVJlcG9zaXRvcnknLFxuICAgICAgfTtcblxuICAgICAgY29uc3Qgc25zQXJuID0gJ2Fybjphd3M6c25zOio6MTIzNDU2Nzg5MDEyOm15X3RvcGljJztcblxuICAgICAgbmV3IFJlcG9zaXRvcnkoc3RhY2ssICdNeVJlcG9zaXRvcnknLCBwcm9wcykubm90aWZ5KHNuc0Fybik7XG5cbiAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykudGVtcGxhdGVNYXRjaGVzKHtcbiAgICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgICAgTXlSZXBvc2l0b3J5NEM0QkQ1RkM6IHtcbiAgICAgICAgICAgIFR5cGU6ICdBV1M6OkNvZGVDb21taXQ6OlJlcG9zaXRvcnknLFxuICAgICAgICAgICAgUHJvcGVydGllczoge1xuICAgICAgICAgICAgICBSZXBvc2l0b3J5TmFtZTogJ015UmVwb3NpdG9yeScsXG4gICAgICAgICAgICAgIFRyaWdnZXJzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgRXZlbnRzOiBbXG4gICAgICAgICAgICAgICAgICAgICdhbGwnLFxuICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgIERlc3RpbmF0aW9uQXJuOiAnYXJuOmF3czpzbnM6KjoxMjM0NTY3ODkwMTI6bXlfdG9waWMnLFxuICAgICAgICAgICAgICAgICAgTmFtZTogJ0RlZmF1bHQvTXlSZXBvc2l0b3J5L2Fybjphd3M6c25zOio6MTIzNDU2Nzg5MDEyOm15X3RvcGljJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cblxuICAgIH0pO1xuXG4gICAgdGVzdCgnZmFpbHMgd2hlbiB0cmlnZ2VycyBoYXZlIGR1cGxpY2F0ZSBuYW1lcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAgIGNvbnN0IG15UmVwb3NpdG9yeSA9IG5ldyBSZXBvc2l0b3J5KHN0YWNrLCAnTXlSZXBvc2l0b3J5Jywge1xuICAgICAgICByZXBvc2l0b3J5TmFtZTogJ015UmVwb3NpdG9yeScsXG4gICAgICB9KS5ub3RpZnkoJ215VHJpZ2dlcicpO1xuXG4gICAgICBleHBlY3QoKCkgPT4gbXlSZXBvc2l0b3J5Lm5vdGlmeSgnbXlUcmlnZ2VyJykpLnRvVGhyb3coKTtcblxuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdjYW4gYmUgaW1wb3J0ZWQgdXNpbmcgYSBSZXBvc2l0b3J5IEFSTicsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgICAgY29uc3QgcmVwb3NpdG9yeUFybiA9ICdhcm46YXdzOmNvZGVjb21taXQ6dXMtZWFzdC0xOjU4NTY5NTAzNjMwNDpteS1yZXBvJztcblxuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcmVwbyA9IFJlcG9zaXRvcnkuZnJvbVJlcG9zaXRvcnlBcm4oc3RhY2ssICdJbXBvcnRlZFJlcG8nLCByZXBvc2l0b3J5QXJuKTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5QXJuKSkudG9FcXVhbChyZXBvc2l0b3J5QXJuKTtcbiAgICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHJlcG8ucmVwb3NpdG9yeU5hbWUpKS50b0VxdWFsKCdteS1yZXBvJyk7XG5cblxuICAgIH0pO1xuXG4gICAgdGVzdCgnUmVwb3NpdG9yeSBjYW4gYmUgaW5pdGlhbGl6ZWQgd2l0aCBjb250ZW50cyBmcm9tIGEgWklQIGZpbGUnLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnTXlTdGFjaycpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgUmVwb3NpdG9yeShzdGFjaywgJ1JlcG9zaXRvcnknLCB7XG4gICAgICAgIHJlcG9zaXRvcnlOYW1lOiAnTXlSZXBvc2l0b3J5TmFtZScsXG4gICAgICAgIGNvZGU6IENvZGUuZnJvbVppcEZpbGUoam9pbihfX2Rpcm5hbWUsICdhc3NldC10ZXN0LnppcCcpKSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBhc3NlbWJseSA9IGFwcC5zeW50aCgpO1xuICAgICAgY29uc3QgYXNzZXRzID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoam9pbihhc3NlbWJseS5kaXJlY3RvcnksIGAke3N0YWNrLnN0YWNrTmFtZX0uYXNzZXRzLmpzb25gKSwgJ3V0Zi04JykpO1xuXG4gICAgICAvLyBvdXIgYXNzZXQgKyB0aGUgdGVtcGxhdGUgaXRzZWxmXG4gICAgICBleHBlY3QoT2JqZWN0LmVudHJpZXMoYXNzZXRzLmZpbGVzKSkudG9IYXZlTGVuZ3RoKDIpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnUmVwb3NpdG9yeSBjYW4gYmUgaW5pdGlhbGl6ZWQgd2l0aCBjb250ZW50cyBmcm9tIGEgZGlyZWN0b3J5JywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ015U3RhY2snKTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgbmV3IFJlcG9zaXRvcnkoc3RhY2ssICdSZXBvc2l0b3J5Jywge1xuICAgICAgICByZXBvc2l0b3J5TmFtZTogJ015UmVwb3NpdG9yeU5hbWUnLFxuICAgICAgICBjb2RlOiBDb2RlLmZyb21EaXJlY3Rvcnkoam9pbihfX2Rpcm5hbWUsICdhc3NldC10ZXN0JykpLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGFzc2VtYmx5ID0gYXBwLnN5bnRoKCk7XG4gICAgICBjb25zdCBhc3NldHMgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhqb2luKGFzc2VtYmx5LmRpcmVjdG9yeSwgYCR7c3RhY2suc3RhY2tOYW1lfS5hc3NldHMuanNvbmApLCAndXRmLTgnKSk7XG5cbiAgICAgIC8vIG91ciBhc3NldCArIHRoZSB0ZW1wbGF0ZSBpdHNlbGZcbiAgICAgIGV4cGVjdChPYmplY3QuZW50cmllcyhhc3NldHMuZmlsZXMpKS50b0hhdmVMZW5ndGgoMik7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdSZXBvc2l0b3J5IGNhbiBiZSBpbml0aWFsaXplZCB3aXRoIGNvbnRlbnRzIGZyb20gYW4gYXNzZXQnLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgYXBwID0gbmV3IEFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnTXlTdGFjaycpO1xuXG4gICAgICBjb25zdCByZWFkbWVBc3NldCA9IG5ldyBBc3NldChzdGFjaywgJ1JlYWRtZUFzc2V0Jywge1xuICAgICAgICBwYXRoOiBqb2luKF9fZGlybmFtZSwgJ2Fzc2V0LXRlc3QnKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgUmVwb3NpdG9yeShzdGFjaywgJ1JlcG9zaXRvcnknLCB7XG4gICAgICAgIHJlcG9zaXRvcnlOYW1lOiAnTXlSZXBvc2l0b3J5TmFtZScsXG4gICAgICAgIGNvZGU6IENvZGUuZnJvbUFzc2V0KHJlYWRtZUFzc2V0KSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBjb25zdCBhc3NlbWJseSA9IGFwcC5zeW50aCgpO1xuICAgICAgY29uc3QgYXNzZXRzID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoam9pbihhc3NlbWJseS5kaXJlY3RvcnksIGAke3N0YWNrLnN0YWNrTmFtZX0uYXNzZXRzLmpzb25gKSwgJ3V0Zi04JykpO1xuXG4gICAgICAvLyBvdXIgYXNzZXQgKyB0aGUgdGVtcGxhdGUgaXRzZWxmXG4gICAgICBleHBlY3QoT2JqZWN0LmVudHJpZXMoYXNzZXRzLmZpbGVzKSkudG9IYXZlTGVuZ3RoKDIpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnUmVwb3NpdG9yeSB0aHJvd3MgRXJyb3Igd2hlbiBpbml0aWFsaXplZCB3aXRoIGZpbGUgd2hpbGUgZXhwZWN0aW5nIGRpcmVjdG9yeScsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdNeVN0YWNrJyk7XG4gICAgICBjb25zdCBmaWxlUGF0aCA9IGpvaW4oX19kaXJuYW1lLCAnYXNzZXQtdGVzdC90ZXN0Lm1kJyk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIG5ldyBSZXBvc2l0b3J5KHN0YWNrLCAnUmVwb3NpdG9yeScsIHtcbiAgICAgICAgICByZXBvc2l0b3J5TmFtZTogJ015UmVwb3NpdG9yeU5hbWUnLFxuICAgICAgICAgIGNvZGU6IENvZGUuZnJvbURpcmVjdG9yeShmaWxlUGF0aCksXG4gICAgICAgIH0pO1xuICAgICAgfSkudG9UaHJvdyhgJyR7ZmlsZVBhdGh9JyBuZWVkcyB0byBiZSBhIHBhdGggdG8gYSBkaXJlY3RvcnkgKHJlc29sdmVkIHRvOiAnJHtyZXNvbHZlKGZpbGVQYXRoKX0nKWApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnUmVwb3NpdG9yeSB0aHJvd3MgRXJyb3Igd2hlbiBpbml0aWFsaXplZCB3aXRoIGRpcmVjdG9yeSB3aGlsZSBleHBlY3RpbmcgZmlsZScsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayhhcHAsICdNeVN0YWNrJyk7XG5cbiAgICAgIGNvbnN0IGRpclBhdGggPSBqb2luKF9fZGlybmFtZSwgJ2Fzc2V0LXRlc3QvJyk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIG5ldyBSZXBvc2l0b3J5KHN0YWNrLCAnUmVwb3NpdG9yeScsIHtcbiAgICAgICAgICByZXBvc2l0b3J5TmFtZTogJ015UmVwb3NpdG9yeU5hbWUnLFxuICAgICAgICAgIGNvZGU6IENvZGUuZnJvbVppcEZpbGUoZGlyUGF0aCksXG4gICAgICAgIH0pO1xuICAgICAgfSkudG9UaHJvdyhgJyR7ZGlyUGF0aH0nIG5lZWRzIHRvIGJlIGEgcGF0aCB0byBhIFpJUCBmaWxlIChyZXNvbHZlZCB0bzogJyR7cmVzb2x2ZShkaXJQYXRoKX0nKWApO1xuICAgIH0pO1xuXG4gICAgLyoqXG4gICAgICogRml4IGZvciBodHRwczovL2dpdGh1Yi5jb20vYXdzL2F3cy1jZGsvaXNzdWVzLzEwNjMwXG4gICAgICovXG4gICAgdGVzdCgnY2FuIGJlIGltcG9ydGVkIHVzaW5nIGEgUmVwb3NpdG9yeSBBUk4gYW5kIHJlc3BlY3QgdGhlIHJlZ2lvbiBpbiBjbG9uZSB1cmxzJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gICAgICBjb25zdCByZXBvc2l0b3J5QXJuID0gJ2Fybjphd3M6Y29kZWNvbW1pdDp1cy13ZXN0LTI6NTg1Njk1MDM2MzA0Om15LXJlcG8nO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCByZXBvID0gUmVwb3NpdG9yeS5mcm9tUmVwb3NpdG9yeUFybihzdGFjaywgJ0ltcG9ydGVkUmVwbycsIHJlcG9zaXRvcnlBcm4pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICAvLyBhIGZ1bGx5IHF1YWxpZmllZCBhcm4gc2hvdWxkIHVzZSB0aGUgcmVnaW9uIGZyb20gdGhlIGFyblxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5Q2xvbmVVcmxIdHRwKSkudG9FcXVhbCh7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnaHR0cHM6Ly9naXQtY29kZWNvbW1pdC51cy13ZXN0LTIuJyxcbiAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpVUkxTdWZmaXgnIH0sXG4gICAgICAgICAgICAnL3YxL3JlcG9zL215LXJlcG8nLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5Q2xvbmVVcmxTc2gpKS50b0VxdWFsKHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdzc2g6Ly9naXQtY29kZWNvbW1pdC51cy13ZXN0LTIuJyxcbiAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpVUkxTdWZmaXgnIH0sXG4gICAgICAgICAgICAnL3YxL3JlcG9zL215LXJlcG8nLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5Q2xvbmVVcmxHcmMpKS50b0VxdWFsKCdjb2RlY29tbWl0Ojp1cy13ZXN0LTI6Ly9teS1yZXBvJyk7XG5cbiAgICAgIGV4cGVjdChyZXBvLmVudi5hY2NvdW50KS50b0VxdWFsKCc1ODU2OTUwMzYzMDQnKTtcbiAgICAgIGV4cGVjdChyZXBvLmVudi5yZWdpb24pLnRvRXF1YWwoJ3VzLXdlc3QtMicpO1xuXG5cbiAgICB9KTtcblxuICAgIHRlc3QoJ2NhbiBiZSBpbXBvcnRlZCB1c2luZyBqdXN0IGEgUmVwb3NpdG9yeSBuYW1lICh0aGUgQVJOIGlzIGRlZHVjZWQpJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHJlcG8gPSBSZXBvc2l0b3J5LmZyb21SZXBvc2l0b3J5TmFtZShzdGFjaywgJ0ltcG9ydGVkUmVwbycsICdteS1yZXBvJyk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHJlcG8ucmVwb3NpdG9yeUFybikpLnRvRXF1YWwoe1xuICAgICAgICAnRm46OkpvaW4nOiBbJycsIFtcbiAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAnOmNvZGVjb21taXQ6JyxcbiAgICAgICAgICB7IFJlZjogJ0FXUzo6UmVnaW9uJyB9LFxuICAgICAgICAgICc6JyxcbiAgICAgICAgICB7IFJlZjogJ0FXUzo6QWNjb3VudElkJyB9LFxuICAgICAgICAgICc6bXktcmVwbycsXG4gICAgICAgIF1dLFxuICAgICAgfSk7XG4gICAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZShyZXBvLnJlcG9zaXRvcnlOYW1lKSkudG9FcXVhbCgnbXktcmVwbycpO1xuXG4gICAgICAvL2xvY2FsIG5hbWUgcmVzb2x1dGlvbiBzaG91bGQgdXNlIHN0YWNrIHJlZ2lvblxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5Q2xvbmVVcmxIdHRwKSkudG9FcXVhbCh7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnaHR0cHM6Ly9naXQtY29kZWNvbW1pdC4nLFxuICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICcuJyxcbiAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpVUkxTdWZmaXgnIH0sXG4gICAgICAgICAgICAnL3YxL3JlcG9zL215LXJlcG8nLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHN0YWNrLnJlc29sdmUocmVwby5yZXBvc2l0b3J5Q2xvbmVVcmxHcmMpKS50b0VxdWFsKHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdjb2RlY29tbWl0OjonLFxuICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlJlZ2lvbicgfSxcbiAgICAgICAgICAgICc6Ly9teS1yZXBvJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cblxuICAgIH0pO1xuXG4gICAgdGVzdCgnZ3JhbnQgcHVzaCcsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgICAgY29uc3QgcmVwb3NpdG9yeSA9IG5ldyBSZXBvc2l0b3J5KHN0YWNrLCAnUmVwbycsIHtcbiAgICAgICAgcmVwb3NpdG9yeU5hbWU6ICdyZXBvLW5hbWUnLFxuICAgICAgfSk7XG4gICAgICBjb25zdCByb2xlID0gbmV3IFJvbGUoc3RhY2ssICdSb2xlJywge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBTZXJ2aWNlUHJpbmNpcGFsKCdlYzIuYW1hem9uYXdzLmNvbScpLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIHJlcG9zaXRvcnkuZ3JhbnRQdWxsUHVzaChyb2xlKTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIEFjdGlvbjogJ2NvZGVjb21taXQ6R2l0UHVsbCcsXG4gICAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgICAgICAgICAgICdSZXBvMDJBQzg2Q0YnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIEFjdGlvbjogJ2NvZGVjb21taXQ6R2l0UHVzaCcsXG4gICAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgICAgICAgICAgICdSZXBvMDJBQzg2Q0YnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdIVFRQUyAoR1JDKSBjbG9uZSBVUkwnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgICBjb25zdCByZXBvc2l0b3J5ID0gbmV3IFJlcG9zaXRvcnkoc3RhY2ssICdSZXBvc2l0b3J5Jywge1xuICAgICAgICByZXBvc2l0b3J5TmFtZTogJ215LXJlcG8nLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHJlcG9zaXRvcnkucmVwb3NpdG9yeUNsb25lVXJsR3JjKSkudG9FcXVhbCh7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnY29kZWNvbW1pdDo6JyxcbiAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sXG4gICAgICAgICAgICAnOi8vJyxcbiAgICAgICAgICAgIHsgJ0ZuOjpHZXRBdHQnOiBbJ1JlcG9zaXRvcnkyMkU1M0JCRCcsICdOYW1lJ10gfSxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSk7XG5cblxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19