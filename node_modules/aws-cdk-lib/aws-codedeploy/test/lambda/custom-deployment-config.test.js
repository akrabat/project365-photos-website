"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const lambda = require("../../../aws-lambda");
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const cdk = require("../../../core");
const codedeploy = require("../../lib");
function mockFunction(stack, id) {
    return new lambda.Function(stack, id, {
        code: lambda.Code.fromInline('mock'),
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
    });
}
function mockAlias(stack) {
    return new lambda.Alias(stack, 'Alias', {
        aliasName: 'my-alias',
        version: new lambda.Version(stack, 'Version', {
            lambda: mockFunction(stack, 'Function'),
        }),
    });
}
let stack;
let application;
let alias;
beforeEach(() => {
    stack = new cdk.Stack();
    application = new codedeploy.LambdaApplication(stack, 'MyApp');
    alias = mockAlias(stack);
});
(0, cdk_build_tools_1.testDeprecated)('custom resource created', () => {
    // WHEN
    const config = new codedeploy.CustomLambdaDeploymentConfig(stack, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
    });
    new codedeploy.LambdaDeploymentGroup(stack, 'MyDG', {
        application,
        alias,
        deploymentConfig: config,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::AWS', {
        ServiceToken: {
            'Fn::GetAtt': [
                'AWS679f53fac002430cb0da5b7982bd22872D164C4C',
                'Arn',
            ],
        },
        Create: '{"service":"CodeDeploy","action":"createDeploymentConfig","parameters":{"deploymentConfigName":"CustomConfig.LambdaCanary5Percent1Minutes","computePlatform":"Lambda","trafficRoutingConfig":{"type":"TimeBasedCanary","timeBasedCanary":{"canaryInterval":"1","canaryPercentage":"5"}}},"physicalResourceId":{"id":"CustomConfig.LambdaCanary5Percent1Minutes"}}',
        Update: '{"service":"CodeDeploy","action":"createDeploymentConfig","parameters":{"deploymentConfigName":"CustomConfig.LambdaCanary5Percent1Minutes","computePlatform":"Lambda","trafficRoutingConfig":{"type":"TimeBasedCanary","timeBasedCanary":{"canaryInterval":"1","canaryPercentage":"5"}}},"physicalResourceId":{"id":"CustomConfig.LambdaCanary5Percent1Minutes"}}',
        Delete: '{"service":"CodeDeploy","action":"deleteDeploymentConfig","parameters":{"deploymentConfigName":"CustomConfig.LambdaCanary5Percent1Minutes"}}',
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [
                {
                    Action: 'codedeploy:CreateDeploymentConfig',
                    Effect: 'Allow',
                    Resource: '*',
                },
                {
                    Action: 'codedeploy:DeleteDeploymentConfig',
                    Effect: 'Allow',
                    Resource: '*',
                },
            ],
            Version: '2012-10-17',
        },
    });
});
(0, cdk_build_tools_1.testDeprecated)('custom resource created with specific name', () => {
    // WHEN
    const config = new codedeploy.CustomLambdaDeploymentConfig(stack, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
        deploymentConfigName: 'MyDeploymentConfig',
    });
    new codedeploy.LambdaDeploymentGroup(stack, 'MyDG', {
        application,
        alias,
        deploymentConfig: config,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::AWS', {
        Create: '{"service":"CodeDeploy","action":"createDeploymentConfig","parameters":{"deploymentConfigName":"MyDeploymentConfig","computePlatform":"Lambda","trafficRoutingConfig":{"type":"TimeBasedCanary","timeBasedCanary":{"canaryInterval":"1","canaryPercentage":"5"}}},"physicalResourceId":{"id":"MyDeploymentConfig"}}',
        Update: '{"service":"CodeDeploy","action":"createDeploymentConfig","parameters":{"deploymentConfigName":"MyDeploymentConfig","computePlatform":"Lambda","trafficRoutingConfig":{"type":"TimeBasedCanary","timeBasedCanary":{"canaryInterval":"1","canaryPercentage":"5"}}},"physicalResourceId":{"id":"MyDeploymentConfig"}}',
        Delete: '{"service":"CodeDeploy","action":"deleteDeploymentConfig","parameters":{"deploymentConfigName":"MyDeploymentConfig"}}',
    });
});
(0, cdk_build_tools_1.testDeprecated)('fail with more than 100 characters in name', () => {
    const app = new cdk.App();
    const stackWithApp = new cdk.Stack(app);
    new codedeploy.CustomLambdaDeploymentConfig(stackWithApp, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
        deploymentConfigName: 'a'.repeat(101),
    });
    expect(() => app.synth()).toThrow(`Deployment config name: "${'a'.repeat(101)}" can be a max of 100 characters.`);
});
(0, cdk_build_tools_1.testDeprecated)('fail with unallowed characters in name', () => {
    const app = new cdk.App();
    const stackWithApp = new cdk.Stack(app);
    new codedeploy.CustomLambdaDeploymentConfig(stackWithApp, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
        deploymentConfigName: 'my name',
    });
    expect(() => app.synth()).toThrow('Deployment config name: "my name" can only contain letters (a-z, A-Z), numbers (0-9), periods (.), underscores (_), + (plus signs), = (equals signs), , (commas), @ (at signs), - (minus signs).');
});
(0, cdk_build_tools_1.testDeprecated)('can create linear custom config', () => {
    // WHEN
    const config = new codedeploy.CustomLambdaDeploymentConfig(stack, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.LINEAR,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
    });
    new codedeploy.LambdaDeploymentGroup(stack, 'MyDG', {
        application,
        alias,
        deploymentConfig: config,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CodeDeploy::DeploymentGroup', {
        DeploymentConfigName: 'CustomConfig.LambdaLinear5PercentEvery1Minutes',
    });
});
(0, cdk_build_tools_1.testDeprecated)('can create canary custom config', () => {
    // WHEN
    const config = new codedeploy.CustomLambdaDeploymentConfig(stack, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
    });
    new codedeploy.LambdaDeploymentGroup(stack, 'MyDG', {
        application,
        alias,
        deploymentConfig: config,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::CodeDeploy::DeploymentGroup', {
        DeploymentConfigName: 'CustomConfig.LambdaCanary5Percent1Minutes',
    });
});
(0, cdk_build_tools_1.testDeprecated)('dependency on the config exists to ensure ordering', () => {
    // WHEN
    const config = new codedeploy.CustomLambdaDeploymentConfig(stack, 'CustomConfig', {
        type: codedeploy.CustomLambdaDeploymentConfigType.CANARY,
        interval: cdk.Duration.minutes(1),
        percentage: 5,
    });
    new codedeploy.LambdaDeploymentGroup(stack, 'MyDG', {
        application,
        alias,
        deploymentConfig: config,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResource('AWS::CodeDeploy::DeploymentGroup', {
        Properties: {
            DeploymentConfigName: 'CustomConfig.LambdaCanary5Percent1Minutes',
        },
        DependsOn: [
            'CustomConfigDeploymentConfigCustomResourcePolicy0426B684',
            'CustomConfigDeploymentConfigE9E1F384',
        ],
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLWRlcGxveW1lbnQtY29uZmlnLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjdXN0b20tZGVwbG95bWVudC1jb25maWcudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUErQztBQUMvQyw4Q0FBOEM7QUFDOUMsOERBQTBEO0FBQzFELHFDQUFxQztBQUNyQyx3Q0FBd0M7QUFFeEMsU0FBUyxZQUFZLENBQUMsS0FBZ0IsRUFBRSxFQUFVO0lBQ2hELE9BQU8sSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUU7UUFDcEMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQztRQUNwQyxPQUFPLEVBQUUsZUFBZTtRQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO0tBQ3BDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFDRCxTQUFTLFNBQVMsQ0FBQyxLQUFnQjtJQUNqQyxPQUFPLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFO1FBQ3RDLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLE9BQU8sRUFBRSxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtZQUM1QyxNQUFNLEVBQUUsWUFBWSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUM7U0FDeEMsQ0FBQztLQUNILENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxJQUFJLEtBQWdCLENBQUM7QUFDckIsSUFBSSxXQUF5QyxDQUFDO0FBQzlDLElBQUksS0FBbUIsQ0FBQztBQUV4QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3hCLFdBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDL0Qs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QUFPO0lBQ1AsTUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsNEJBQTRCLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRTtRQUNoRixJQUFJLEVBQUUsVUFBVSxDQUFDLGdDQUFnQyxDQUFDLE1BQU07UUFDeEQsUUFBUSxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNqQyxVQUFVLEVBQUUsQ0FBQztLQUNkLENBQUMsQ0FBQztJQUNILElBQUksVUFBVSxDQUFDLHFCQUFxQixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUU7UUFDbEQsV0FBVztRQUNYLEtBQUs7UUFDTCxnQkFBZ0IsRUFBRSxNQUFNO0tBQ3pCLENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLENBQUMsa0NBQWtDLEVBQUU7UUFDeEUsVUFBVSxFQUFFO1lBQ1Ysb0JBQW9CLEVBQUUsMkNBQTJDO1NBQ2xFO1FBQ0QsU0FBUyxFQUFFO1lBQ1QsMERBQTBEO1lBQzFELHNDQUFzQztTQUN2QztLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IHRlc3REZXByZWNhdGVkIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWJ1aWxkLXRvb2xzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGNvZGVkZXBsb3kgZnJvbSAnLi4vLi4vbGliJztcblxuZnVuY3Rpb24gbW9ja0Z1bmN0aW9uKHN0YWNrOiBjZGsuU3RhY2ssIGlkOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssIGlkLCB7XG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnbW9jaycpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgfSk7XG59XG5mdW5jdGlvbiBtb2NrQWxpYXMoc3RhY2s6IGNkay5TdGFjaykge1xuICByZXR1cm4gbmV3IGxhbWJkYS5BbGlhcyhzdGFjaywgJ0FsaWFzJywge1xuICAgIGFsaWFzTmFtZTogJ215LWFsaWFzJyxcbiAgICB2ZXJzaW9uOiBuZXcgbGFtYmRhLlZlcnNpb24oc3RhY2ssICdWZXJzaW9uJywge1xuICAgICAgbGFtYmRhOiBtb2NrRnVuY3Rpb24oc3RhY2ssICdGdW5jdGlvbicpLFxuICAgIH0pLFxuICB9KTtcbn1cblxubGV0IHN0YWNrOiBjZGsuU3RhY2s7XG5sZXQgYXBwbGljYXRpb246IGNvZGVkZXBsb3kuTGFtYmRhQXBwbGljYXRpb247XG5sZXQgYWxpYXM6IGxhbWJkYS5BbGlhcztcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuICBhcHBsaWNhdGlvbiA9IG5ldyBjb2RlZGVwbG95LkxhbWJkYUFwcGxpY2F0aW9uKHN0YWNrLCAnTXlBcHAnKTtcbiAgYWxpYXMgPSBtb2NrQWxpYXMoc3RhY2spO1xufSk7XG5cblxudGVzdERlcHJlY2F0ZWQoJ2N1c3RvbSByZXNvdXJjZSBjcmVhdGVkJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGNvbmZpZyA9IG5ldyBjb2RlZGVwbG95LkN1c3RvbUxhbWJkYURlcGxveW1lbnRDb25maWcoc3RhY2ssICdDdXN0b21Db25maWcnLCB7XG4gICAgdHlwZTogY29kZWRlcGxveS5DdXN0b21MYW1iZGFEZXBsb3ltZW50Q29uZmlnVHlwZS5DQU5BUlksXG4gICAgaW50ZXJ2YWw6IGNkay5EdXJhdGlvbi5taW51dGVzKDEpLFxuICAgIHBlcmNlbnRhZ2U6IDUsXG4gIH0pO1xuICBuZXcgY29kZWRlcGxveS5MYW1iZGFEZXBsb3ltZW50R3JvdXAoc3RhY2ssICdNeURHJywge1xuICAgIGFwcGxpY2F0aW9uLFxuICAgIGFsaWFzLFxuICAgIGRlcGxveW1lbnRDb25maWc6IGNvbmZpZyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpBV1MnLCB7XG4gICAgU2VydmljZVRva2VuOiB7XG4gICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgJ0FXUzY3OWY1M2ZhYzAwMjQzMGNiMGRhNWI3OTgyYmQyMjg3MkQxNjRDNEMnLFxuICAgICAgICAnQXJuJyxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBDcmVhdGU6ICd7XCJzZXJ2aWNlXCI6XCJDb2RlRGVwbG95XCIsXCJhY3Rpb25cIjpcImNyZWF0ZURlcGxveW1lbnRDb25maWdcIixcInBhcmFtZXRlcnNcIjp7XCJkZXBsb3ltZW50Q29uZmlnTmFtZVwiOlwiQ3VzdG9tQ29uZmlnLkxhbWJkYUNhbmFyeTVQZXJjZW50MU1pbnV0ZXNcIixcImNvbXB1dGVQbGF0Zm9ybVwiOlwiTGFtYmRhXCIsXCJ0cmFmZmljUm91dGluZ0NvbmZpZ1wiOntcInR5cGVcIjpcIlRpbWVCYXNlZENhbmFyeVwiLFwidGltZUJhc2VkQ2FuYXJ5XCI6e1wiY2FuYXJ5SW50ZXJ2YWxcIjpcIjFcIixcImNhbmFyeVBlcmNlbnRhZ2VcIjpcIjVcIn19fSxcInBoeXNpY2FsUmVzb3VyY2VJZFwiOntcImlkXCI6XCJDdXN0b21Db25maWcuTGFtYmRhQ2FuYXJ5NVBlcmNlbnQxTWludXRlc1wifX0nLFxuICAgIFVwZGF0ZTogJ3tcInNlcnZpY2VcIjpcIkNvZGVEZXBsb3lcIixcImFjdGlvblwiOlwiY3JlYXRlRGVwbG95bWVudENvbmZpZ1wiLFwicGFyYW1ldGVyc1wiOntcImRlcGxveW1lbnRDb25maWdOYW1lXCI6XCJDdXN0b21Db25maWcuTGFtYmRhQ2FuYXJ5NVBlcmNlbnQxTWludXRlc1wiLFwiY29tcHV0ZVBsYXRmb3JtXCI6XCJMYW1iZGFcIixcInRyYWZmaWNSb3V0aW5nQ29uZmlnXCI6e1widHlwZVwiOlwiVGltZUJhc2VkQ2FuYXJ5XCIsXCJ0aW1lQmFzZWRDYW5hcnlcIjp7XCJjYW5hcnlJbnRlcnZhbFwiOlwiMVwiLFwiY2FuYXJ5UGVyY2VudGFnZVwiOlwiNVwifX19LFwicGh5c2ljYWxSZXNvdXJjZUlkXCI6e1wiaWRcIjpcIkN1c3RvbUNvbmZpZy5MYW1iZGFDYW5hcnk1UGVyY2VudDFNaW51dGVzXCJ9fScsXG4gICAgRGVsZXRlOiAne1wic2VydmljZVwiOlwiQ29kZURlcGxveVwiLFwiYWN0aW9uXCI6XCJkZWxldGVEZXBsb3ltZW50Q29uZmlnXCIsXCJwYXJhbWV0ZXJzXCI6e1wiZGVwbG95bWVudENvbmZpZ05hbWVcIjpcIkN1c3RvbUNvbmZpZy5MYW1iZGFDYW5hcnk1UGVyY2VudDFNaW51dGVzXCJ9fScsXG4gIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogJ2NvZGVkZXBsb3k6Q3JlYXRlRGVwbG95bWVudENvbmZpZycsXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiAnKicsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246ICdjb2RlZGVwbG95OkRlbGV0ZURlcGxveW1lbnRDb25maWcnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZTogJyonLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0RGVwcmVjYXRlZCgnY3VzdG9tIHJlc291cmNlIGNyZWF0ZWQgd2l0aCBzcGVjaWZpYyBuYW1lJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGNvbmZpZyA9IG5ldyBjb2RlZGVwbG95LkN1c3RvbUxhbWJkYURlcGxveW1lbnRDb25maWcoc3RhY2ssICdDdXN0b21Db25maWcnLCB7XG4gICAgdHlwZTogY29kZWRlcGxveS5DdXN0b21MYW1iZGFEZXBsb3ltZW50Q29uZmlnVHlwZS5DQU5BUlksXG4gICAgaW50ZXJ2YWw6IGNkay5EdXJhdGlvbi5taW51dGVzKDEpLFxuICAgIHBlcmNlbnRhZ2U6IDUsXG4gICAgZGVwbG95bWVudENvbmZpZ05hbWU6ICdNeURlcGxveW1lbnRDb25maWcnLFxuICB9KTtcbiAgbmV3IGNvZGVkZXBsb3kuTGFtYmRhRGVwbG95bWVudEdyb3VwKHN0YWNrLCAnTXlERycsIHtcbiAgICBhcHBsaWNhdGlvbixcbiAgICBhbGlhcyxcbiAgICBkZXBsb3ltZW50Q29uZmlnOiBjb25maWcsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0N1c3RvbTo6QVdTJywge1xuICAgIENyZWF0ZTogJ3tcInNlcnZpY2VcIjpcIkNvZGVEZXBsb3lcIixcImFjdGlvblwiOlwiY3JlYXRlRGVwbG95bWVudENvbmZpZ1wiLFwicGFyYW1ldGVyc1wiOntcImRlcGxveW1lbnRDb25maWdOYW1lXCI6XCJNeURlcGxveW1lbnRDb25maWdcIixcImNvbXB1dGVQbGF0Zm9ybVwiOlwiTGFtYmRhXCIsXCJ0cmFmZmljUm91dGluZ0NvbmZpZ1wiOntcInR5cGVcIjpcIlRpbWVCYXNlZENhbmFyeVwiLFwidGltZUJhc2VkQ2FuYXJ5XCI6e1wiY2FuYXJ5SW50ZXJ2YWxcIjpcIjFcIixcImNhbmFyeVBlcmNlbnRhZ2VcIjpcIjVcIn19fSxcInBoeXNpY2FsUmVzb3VyY2VJZFwiOntcImlkXCI6XCJNeURlcGxveW1lbnRDb25maWdcIn19JyxcbiAgICBVcGRhdGU6ICd7XCJzZXJ2aWNlXCI6XCJDb2RlRGVwbG95XCIsXCJhY3Rpb25cIjpcImNyZWF0ZURlcGxveW1lbnRDb25maWdcIixcInBhcmFtZXRlcnNcIjp7XCJkZXBsb3ltZW50Q29uZmlnTmFtZVwiOlwiTXlEZXBsb3ltZW50Q29uZmlnXCIsXCJjb21wdXRlUGxhdGZvcm1cIjpcIkxhbWJkYVwiLFwidHJhZmZpY1JvdXRpbmdDb25maWdcIjp7XCJ0eXBlXCI6XCJUaW1lQmFzZWRDYW5hcnlcIixcInRpbWVCYXNlZENhbmFyeVwiOntcImNhbmFyeUludGVydmFsXCI6XCIxXCIsXCJjYW5hcnlQZXJjZW50YWdlXCI6XCI1XCJ9fX0sXCJwaHlzaWNhbFJlc291cmNlSWRcIjp7XCJpZFwiOlwiTXlEZXBsb3ltZW50Q29uZmlnXCJ9fScsXG4gICAgRGVsZXRlOiAne1wic2VydmljZVwiOlwiQ29kZURlcGxveVwiLFwiYWN0aW9uXCI6XCJkZWxldGVEZXBsb3ltZW50Q29uZmlnXCIsXCJwYXJhbWV0ZXJzXCI6e1wiZGVwbG95bWVudENvbmZpZ05hbWVcIjpcIk15RGVwbG95bWVudENvbmZpZ1wifX0nLFxuICB9KTtcbn0pO1xuXG50ZXN0RGVwcmVjYXRlZCgnZmFpbCB3aXRoIG1vcmUgdGhhbiAxMDAgY2hhcmFjdGVycyBpbiBuYW1lJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICBjb25zdCBzdGFja1dpdGhBcHAgPSBuZXcgY2RrLlN0YWNrKGFwcCk7XG4gIG5ldyBjb2RlZGVwbG95LkN1c3RvbUxhbWJkYURlcGxveW1lbnRDb25maWcoc3RhY2tXaXRoQXBwLCAnQ3VzdG9tQ29uZmlnJywge1xuICAgIHR5cGU6IGNvZGVkZXBsb3kuQ3VzdG9tTGFtYmRhRGVwbG95bWVudENvbmZpZ1R5cGUuQ0FOQVJZLFxuICAgIGludGVydmFsOiBjZGsuRHVyYXRpb24ubWludXRlcygxKSxcbiAgICBwZXJjZW50YWdlOiA1LFxuICAgIGRlcGxveW1lbnRDb25maWdOYW1lOiAnYScucmVwZWF0KDEwMSksXG4gIH0pO1xuXG4gIGV4cGVjdCgoKSA9PiBhcHAuc3ludGgoKSkudG9UaHJvdyhgRGVwbG95bWVudCBjb25maWcgbmFtZTogXCIkeydhJy5yZXBlYXQoMTAxKX1cIiBjYW4gYmUgYSBtYXggb2YgMTAwIGNoYXJhY3RlcnMuYCk7XG59KTtcblxudGVzdERlcHJlY2F0ZWQoJ2ZhaWwgd2l0aCB1bmFsbG93ZWQgY2hhcmFjdGVycyBpbiBuYW1lJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICBjb25zdCBzdGFja1dpdGhBcHAgPSBuZXcgY2RrLlN0YWNrKGFwcCk7XG4gIG5ldyBjb2RlZGVwbG95LkN1c3RvbUxhbWJkYURlcGxveW1lbnRDb25maWcoc3RhY2tXaXRoQXBwLCAnQ3VzdG9tQ29uZmlnJywge1xuICAgIHR5cGU6IGNvZGVkZXBsb3kuQ3VzdG9tTGFtYmRhRGVwbG95bWVudENvbmZpZ1R5cGUuQ0FOQVJZLFxuICAgIGludGVydmFsOiBjZGsuRHVyYXRpb24ubWludXRlcygxKSxcbiAgICBwZXJjZW50YWdlOiA1LFxuICAgIGRlcGxveW1lbnRDb25maWdOYW1lOiAnbXkgbmFtZScsXG4gIH0pO1xuXG4gIGV4cGVjdCgoKSA9PiBhcHAuc3ludGgoKSkudG9UaHJvdygnRGVwbG95bWVudCBjb25maWcgbmFtZTogXCJteSBuYW1lXCIgY2FuIG9ubHkgY29udGFpbiBsZXR0ZXJzIChhLXosIEEtWiksIG51bWJlcnMgKDAtOSksIHBlcmlvZHMgKC4pLCB1bmRlcnNjb3JlcyAoXyksICsgKHBsdXMgc2lnbnMpLCA9IChlcXVhbHMgc2lnbnMpLCAsIChjb21tYXMpLCBAIChhdCBzaWducyksIC0gKG1pbnVzIHNpZ25zKS4nKTtcbn0pO1xuXG50ZXN0RGVwcmVjYXRlZCgnY2FuIGNyZWF0ZSBsaW5lYXIgY3VzdG9tIGNvbmZpZycsICgpID0+IHtcbiAgLy8gV0hFTlxuICBjb25zdCBjb25maWcgPSBuZXcgY29kZWRlcGxveS5DdXN0b21MYW1iZGFEZXBsb3ltZW50Q29uZmlnKHN0YWNrLCAnQ3VzdG9tQ29uZmlnJywge1xuICAgIHR5cGU6IGNvZGVkZXBsb3kuQ3VzdG9tTGFtYmRhRGVwbG95bWVudENvbmZpZ1R5cGUuTElORUFSLFxuICAgIGludGVydmFsOiBjZGsuRHVyYXRpb24ubWludXRlcygxKSxcbiAgICBwZXJjZW50YWdlOiA1LFxuICB9KTtcbiAgbmV3IGNvZGVkZXBsb3kuTGFtYmRhRGVwbG95bWVudEdyb3VwKHN0YWNrLCAnTXlERycsIHtcbiAgICBhcHBsaWNhdGlvbixcbiAgICBhbGlhcyxcbiAgICBkZXBsb3ltZW50Q29uZmlnOiBjb25maWcsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZURlcGxveTo6RGVwbG95bWVudEdyb3VwJywge1xuICAgIERlcGxveW1lbnRDb25maWdOYW1lOiAnQ3VzdG9tQ29uZmlnLkxhbWJkYUxpbmVhcjVQZXJjZW50RXZlcnkxTWludXRlcycsXG4gIH0pO1xufSk7XG5cbnRlc3REZXByZWNhdGVkKCdjYW4gY3JlYXRlIGNhbmFyeSBjdXN0b20gY29uZmlnJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IGNvbmZpZyA9IG5ldyBjb2RlZGVwbG95LkN1c3RvbUxhbWJkYURlcGxveW1lbnRDb25maWcoc3RhY2ssICdDdXN0b21Db25maWcnLCB7XG4gICAgdHlwZTogY29kZWRlcGxveS5DdXN0b21MYW1iZGFEZXBsb3ltZW50Q29uZmlnVHlwZS5DQU5BUlksXG4gICAgaW50ZXJ2YWw6IGNkay5EdXJhdGlvbi5taW51dGVzKDEpLFxuICAgIHBlcmNlbnRhZ2U6IDUsXG4gIH0pO1xuICBuZXcgY29kZWRlcGxveS5MYW1iZGFEZXBsb3ltZW50R3JvdXAoc3RhY2ssICdNeURHJywge1xuICAgIGFwcGxpY2F0aW9uLFxuICAgIGFsaWFzLFxuICAgIGRlcGxveW1lbnRDb25maWc6IGNvbmZpZyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlRGVwbG95OjpEZXBsb3ltZW50R3JvdXAnLCB7XG4gICAgRGVwbG95bWVudENvbmZpZ05hbWU6ICdDdXN0b21Db25maWcuTGFtYmRhQ2FuYXJ5NVBlcmNlbnQxTWludXRlcycsXG4gIH0pO1xufSk7XG5cbnRlc3REZXByZWNhdGVkKCdkZXBlbmRlbmN5IG9uIHRoZSBjb25maWcgZXhpc3RzIHRvIGVuc3VyZSBvcmRlcmluZycsICgpID0+IHtcbiAgLy8gV0hFTlxuICBjb25zdCBjb25maWcgPSBuZXcgY29kZWRlcGxveS5DdXN0b21MYW1iZGFEZXBsb3ltZW50Q29uZmlnKHN0YWNrLCAnQ3VzdG9tQ29uZmlnJywge1xuICAgIHR5cGU6IGNvZGVkZXBsb3kuQ3VzdG9tTGFtYmRhRGVwbG95bWVudENvbmZpZ1R5cGUuQ0FOQVJZLFxuICAgIGludGVydmFsOiBjZGsuRHVyYXRpb24ubWludXRlcygxKSxcbiAgICBwZXJjZW50YWdlOiA1LFxuICB9KTtcbiAgbmV3IGNvZGVkZXBsb3kuTGFtYmRhRGVwbG95bWVudEdyb3VwKHN0YWNrLCAnTXlERycsIHtcbiAgICBhcHBsaWNhdGlvbixcbiAgICBhbGlhcyxcbiAgICBkZXBsb3ltZW50Q29uZmlnOiBjb25maWcsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpDb2RlRGVwbG95OjpEZXBsb3ltZW50R3JvdXAnLCB7XG4gICAgUHJvcGVydGllczoge1xuICAgICAgRGVwbG95bWVudENvbmZpZ05hbWU6ICdDdXN0b21Db25maWcuTGFtYmRhQ2FuYXJ5NVBlcmNlbnQxTWludXRlcycsXG4gICAgfSxcbiAgICBEZXBlbmRzT246IFtcbiAgICAgICdDdXN0b21Db25maWdEZXBsb3ltZW50Q29uZmlnQ3VzdG9tUmVzb3VyY2VQb2xpY3kwNDI2QjY4NCcsXG4gICAgICAnQ3VzdG9tQ29uZmlnRGVwbG95bWVudENvbmZpZ0U5RTFGMzg0JyxcbiAgICBdLFxuICB9KTtcbn0pO1xuIl19