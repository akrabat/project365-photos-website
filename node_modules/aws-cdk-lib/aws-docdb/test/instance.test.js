"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const ec2 = require("../../aws-ec2");
const cdk = require("../../core");
const lib_1 = require("../lib");
const CLUSTER_INSTANCE_TYPE = ec2.InstanceType.of(ec2.InstanceClass.R5, ec2.InstanceSize.LARGE);
const SINGLE_INSTANCE_TYPE = ec2.InstanceType.of(ec2.InstanceClass.R5, ec2.InstanceSize.XLARGE);
const EXPECTED_SYNTH_INSTANCE_TYPE = `db.${SINGLE_INSTANCE_TYPE}`;
describe('DatabaseInstance', () => {
    test('check that instantiation works', () => {
        // GIVEN
        const stack = testStack();
        // WHEN
        new lib_1.DatabaseInstance(stack, 'Instance', {
            cluster: stack.cluster,
            instanceType: SINGLE_INSTANCE_TYPE,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResource('AWS::DocDB::DBInstance', {
            Properties: {
                DBClusterIdentifier: { Ref: 'DatabaseB269D8BB' },
                DBInstanceClass: EXPECTED_SYNTH_INSTANCE_TYPE,
                AutoMinorVersionUpgrade: true,
            },
            DeletionPolicy: 'Retain',
            UpdateReplacePolicy: 'Retain',
        });
    });
    test.each([
        [undefined, true],
        [true, true],
        [false, false],
    ])('check that autoMinorVersionUpdate works: %p', (given, expected) => {
        // GIVEN
        const stack = testStack();
        // WHEN
        new lib_1.DatabaseInstance(stack, 'Instance', {
            cluster: stack.cluster,
            instanceType: SINGLE_INSTANCE_TYPE,
            autoMinorVersionUpgrade: given,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResource('AWS::DocDB::DBInstance', {
            Properties: {
                DBClusterIdentifier: { Ref: 'DatabaseB269D8BB' },
                DBInstanceClass: EXPECTED_SYNTH_INSTANCE_TYPE,
                AutoMinorVersionUpgrade: expected,
            },
            DeletionPolicy: 'Retain',
            UpdateReplacePolicy: 'Retain',
        });
    });
    test('check that the endpoint works', () => {
        // GIVEN
        const stack = testStack();
        const instance = new lib_1.DatabaseInstance(stack, 'Instance', {
            cluster: stack.cluster,
            instanceType: SINGLE_INSTANCE_TYPE,
        });
        const exportName = 'DbInstanceEndpoint';
        // WHEN
        new cdk.CfnOutput(stack, exportName, {
            exportName,
            value: instance.instanceEndpoint.socketAddress,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasOutput(exportName, {
            Export: {
                Name: exportName,
            },
            Value: {
                'Fn::Join': [
                    '',
                    [
                        { 'Fn::GetAtt': ['InstanceC1063A87', 'Endpoint'] },
                        ':',
                        { 'Fn::GetAtt': ['InstanceC1063A87', 'Port'] },
                    ],
                ],
            },
        });
    });
    test('check that instanceArn property works', () => {
        // GIVEN
        const stack = testStack();
        const instance = new lib_1.DatabaseInstance(stack, 'Instance', {
            cluster: stack.cluster,
            instanceType: SINGLE_INSTANCE_TYPE,
        });
        const exportName = 'DbInstanceArn';
        // WHEN
        new cdk.CfnOutput(stack, exportName, {
            exportName,
            value: instance.instanceArn,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasOutput(exportName, {
            Export: {
                Name: exportName,
            },
            Value: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        { Ref: 'AWS::Partition' },
                        ':rds:us-test-1:12345:db:',
                        { Ref: 'InstanceC1063A87' },
                    ],
                ],
            },
        });
    });
    test('check importing works as expected', () => {
        // GIVEN
        const stack = testStack();
        const arnExportName = 'DbInstanceArn';
        const endpointExportName = 'DbInstanceEndpoint';
        const instanceEndpointAddress = '127.0.0.1';
        const instanceIdentifier = 'InstanceID';
        const port = 8888;
        // WHEN
        const instance = lib_1.DatabaseInstance.fromDatabaseInstanceAttributes(stack, 'Instance', {
            instanceEndpointAddress,
            instanceIdentifier,
            port,
        });
        new cdk.CfnOutput(stack, 'ArnOutput', {
            exportName: arnExportName,
            value: instance.instanceArn,
        });
        new cdk.CfnOutput(stack, 'EndpointOutput', {
            exportName: endpointExportName,
            value: instance.instanceEndpoint.socketAddress,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasOutput('ArnOutput', {
            Export: {
                Name: arnExportName,
            },
            Value: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        { Ref: 'AWS::Partition' },
                        `:rds:us-test-1:12345:db:${instanceIdentifier}`,
                    ],
                ],
            },
        });
        assertions_1.Template.fromStack(stack).hasOutput('EndpointOutput', {
            Export: {
                Name: endpointExportName,
            },
            Value: `${instanceEndpointAddress}:${port}`,
        });
    });
    test('can enable performance insights on instances', () => {
        // GIVEN
        const stack = testStack();
        // WHEN
        new lib_1.DatabaseInstance(stack, 'Instance', {
            cluster: stack.cluster,
            instanceType: SINGLE_INSTANCE_TYPE,
            enablePerformanceInsights: true,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResource('AWS::DocDB::DBInstance', {
            Properties: {
                EnablePerformanceInsights: true,
            },
        });
    });
});
class TestStack extends cdk.Stack {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        this.node.setContext('availability-zones:12345:us-test-1', ['us-test-1a', 'us-test-1b']);
        this.vpc = new ec2.Vpc(this, 'VPC');
        this.cluster = new lib_1.DatabaseCluster(this, 'Database', {
            masterUser: {
                username: 'admin',
                password: cdk.SecretValue.unsafePlainText('tooshort'),
            },
            instanceType: CLUSTER_INSTANCE_TYPE,
            vpc: this.vpc,
        });
    }
}
function testStack() {
    const stack = new TestStack(undefined, undefined, { env: { account: '12345', region: 'us-test-1' } });
    return stack;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFuY2UudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluc3RhbmNlLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBNEM7QUFDNUMscUNBQXFDO0FBQ3JDLGtDQUFrQztBQUVsQyxnQ0FBMkQ7QUFFM0QsTUFBTSxxQkFBcUIsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2hHLE1BQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNoRyxNQUFNLDRCQUE0QixHQUFHLE1BQU0sb0JBQW9CLEVBQUUsQ0FBQztBQUVsRSxRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO0lBQ2hDLElBQUksQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7UUFDMUMsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLFNBQVMsRUFBRSxDQUFDO1FBRTFCLE9BQU87UUFDUCxJQUFJLHNCQUFnQixDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUU7WUFDdEMsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1lBQ3RCLFlBQVksRUFBRSxvQkFBb0I7U0FDbkMsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsRUFBRTtZQUM5RCxVQUFVLEVBQUU7Z0JBQ1YsbUJBQW1CLEVBQUUsRUFBRSxHQUFHLEVBQUUsa0JBQWtCLEVBQUU7Z0JBQ2hELGVBQWUsRUFBRSw0QkFBNEI7Z0JBQzdDLHVCQUF1QixFQUFFLElBQUk7YUFDOUI7WUFDRCxjQUFjLEVBQUUsUUFBUTtZQUN4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LEVBQUUsUUFBd0IsRUFBRTtRQUMvRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxvQ0FBb0MsRUFBRSxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBRXpGLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUkscUJBQWUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQ25ELFVBQVUsRUFBRTtnQkFDVixRQUFRLEVBQUUsT0FBTztnQkFDakIsUUFBUSxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQzthQUN0RDtZQUNELFlBQVksRUFBRSxxQkFBcUI7WUFDbkMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO1NBQ2QsQ0FBQyxDQUFDO0tBQ0o7Q0FDRjtBQUVELFNBQVMsU0FBUztJQUNoQixNQUFNLEtBQUssR0FBRyxJQUFJLFNBQVMsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RHLE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnLi4vLi4vYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBjb25zdHJ1Y3RzIGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgRGF0YWJhc2VDbHVzdGVyLCBEYXRhYmFzZUluc3RhbmNlIH0gZnJvbSAnLi4vbGliJztcblxuY29uc3QgQ0xVU1RFUl9JTlNUQU5DRV9UWVBFID0gZWMyLkluc3RhbmNlVHlwZS5vZihlYzIuSW5zdGFuY2VDbGFzcy5SNSwgZWMyLkluc3RhbmNlU2l6ZS5MQVJHRSk7XG5jb25zdCBTSU5HTEVfSU5TVEFOQ0VfVFlQRSA9IGVjMi5JbnN0YW5jZVR5cGUub2YoZWMyLkluc3RhbmNlQ2xhc3MuUjUsIGVjMi5JbnN0YW5jZVNpemUuWExBUkdFKTtcbmNvbnN0IEVYUEVDVEVEX1NZTlRIX0lOU1RBTkNFX1RZUEUgPSBgZGIuJHtTSU5HTEVfSU5TVEFOQ0VfVFlQRX1gO1xuXG5kZXNjcmliZSgnRGF0YWJhc2VJbnN0YW5jZScsICgpID0+IHtcbiAgdGVzdCgnY2hlY2sgdGhhdCBpbnN0YW50aWF0aW9uIHdvcmtzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSB0ZXN0U3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgRGF0YWJhc2VJbnN0YW5jZShzdGFjaywgJ0luc3RhbmNlJywge1xuICAgICAgY2x1c3Rlcjogc3RhY2suY2x1c3RlcixcbiAgICAgIGluc3RhbmNlVHlwZTogU0lOR0xFX0lOU1RBTkNFX1RZUEUsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpEb2NEQjo6REJJbnN0YW5jZScsIHtcbiAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgREJDbHVzdGVySWRlbnRpZmllcjogeyBSZWY6ICdEYXRhYmFzZUIyNjlEOEJCJyB9LFxuICAgICAgICBEQkluc3RhbmNlQ2xhc3M6IEVYUEVDVEVEX1NZTlRIX0lOU1RBTkNFX1RZUEUsXG4gICAgICAgIEF1dG9NaW5vclZlcnNpb25VcGdyYWRlOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIERlbGV0aW9uUG9saWN5OiAnUmV0YWluJyxcbiAgICAgIFVwZGF0ZVJlcGxhY2VQb2xpY3k6ICdSZXRhaW4nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0LmVhY2goW1xuICAgIFt1bmRlZmluZWQsIHRydWVdLFxuICAgIFt0cnVlLCB0cnVlXSxcbiAgICBbZmFsc2UsIGZhbHNlXSxcbiAgXSkoJ2NoZWNrIHRoYXQgYXV0b01pbm9yVmVyc2lvblVwZGF0ZSB3b3JrczogJXAnLCAoZ2l2ZW46IGJvb2xlYW4gfCB1bmRlZmluZWQsIGV4cGVjdGVkOiBib29sZWFuKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IHRlc3RTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBEYXRhYmFzZUluc3RhbmNlKHN0YWNrLCAnSW5zdGFuY2UnLCB7XG4gICAgICBjbHVzdGVyOiBzdGFjay5jbHVzdGVyLFxuICAgICAgaW5zdGFuY2VUeXBlOiBTSU5HTEVfSU5TVEFOQ0VfVFlQRSxcbiAgICAgIGF1dG9NaW5vclZlcnNpb25VcGdyYWRlOiBnaXZlbixcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlKCdBV1M6OkRvY0RCOjpEQkluc3RhbmNlJywge1xuICAgICAgUHJvcGVydGllczoge1xuICAgICAgICBEQkNsdXN0ZXJJZGVudGlmaWVyOiB7IFJlZjogJ0RhdGFiYXNlQjI2OUQ4QkInIH0sXG4gICAgICAgIERCSW5zdGFuY2VDbGFzczogRVhQRUNURURfU1lOVEhfSU5TVEFOQ0VfVFlQRSxcbiAgICAgICAgQXV0b01pbm9yVmVyc2lvblVwZ3JhZGU6IGV4cGVjdGVkLFxuICAgICAgfSxcbiAgICAgIERlbGV0aW9uUG9saWN5OiAnUmV0YWluJyxcbiAgICAgIFVwZGF0ZVJlcGxhY2VQb2xpY3k6ICdSZXRhaW4nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdjaGVjayB0aGF0IHRoZSBlbmRwb2ludCB3b3JrcycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gdGVzdFN0YWNrKCk7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgRGF0YWJhc2VJbnN0YW5jZShzdGFjaywgJ0luc3RhbmNlJywge1xuICAgICAgY2x1c3Rlcjogc3RhY2suY2x1c3RlcixcbiAgICAgIGluc3RhbmNlVHlwZTogU0lOR0xFX0lOU1RBTkNFX1RZUEUsXG4gICAgfSk7XG4gICAgY29uc3QgZXhwb3J0TmFtZSA9ICdEYkluc3RhbmNlRW5kcG9pbnQnO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHN0YWNrLCBleHBvcnROYW1lLCB7XG4gICAgICBleHBvcnROYW1lLFxuICAgICAgdmFsdWU6IGluc3RhbmNlLmluc3RhbmNlRW5kcG9pbnQuc29ja2V0QWRkcmVzcyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc091dHB1dChleHBvcnROYW1lLCB7XG4gICAgICBFeHBvcnQ6IHtcbiAgICAgICAgTmFtZTogZXhwb3J0TmFtZSxcbiAgICAgIH0sXG4gICAgICBWYWx1ZToge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgeyAnRm46OkdldEF0dCc6IFsnSW5zdGFuY2VDMTA2M0E4NycsICdFbmRwb2ludCddIH0sXG4gICAgICAgICAgICAnOicsXG4gICAgICAgICAgICB7ICdGbjo6R2V0QXR0JzogWydJbnN0YW5jZUMxMDYzQTg3JywgJ1BvcnQnXSB9LFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdjaGVjayB0aGF0IGluc3RhbmNlQXJuIHByb3BlcnR5IHdvcmtzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSB0ZXN0U3RhY2soKTtcbiAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBEYXRhYmFzZUluc3RhbmNlKHN0YWNrLCAnSW5zdGFuY2UnLCB7XG4gICAgICBjbHVzdGVyOiBzdGFjay5jbHVzdGVyLFxuICAgICAgaW5zdGFuY2VUeXBlOiBTSU5HTEVfSU5TVEFOQ0VfVFlQRSxcbiAgICB9KTtcbiAgICBjb25zdCBleHBvcnROYW1lID0gJ0RiSW5zdGFuY2VBcm4nO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHN0YWNrLCBleHBvcnROYW1lLCB7XG4gICAgICBleHBvcnROYW1lLFxuICAgICAgdmFsdWU6IGluc3RhbmNlLmluc3RhbmNlQXJuLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KGV4cG9ydE5hbWUsIHtcbiAgICAgIEV4cG9ydDoge1xuICAgICAgICBOYW1lOiBleHBvcnROYW1lLFxuICAgICAgfSxcbiAgICAgIFZhbHVlOiB7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LFxuICAgICAgICAgICAgJzpyZHM6dXMtdGVzdC0xOjEyMzQ1OmRiOicsXG4gICAgICAgICAgICB7IFJlZjogJ0luc3RhbmNlQzEwNjNBODcnIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NoZWNrIGltcG9ydGluZyB3b3JrcyBhcyBleHBlY3RlZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gdGVzdFN0YWNrKCk7XG4gICAgY29uc3QgYXJuRXhwb3J0TmFtZSA9ICdEYkluc3RhbmNlQXJuJztcbiAgICBjb25zdCBlbmRwb2ludEV4cG9ydE5hbWUgPSAnRGJJbnN0YW5jZUVuZHBvaW50JztcbiAgICBjb25zdCBpbnN0YW5jZUVuZHBvaW50QWRkcmVzcyA9ICcxMjcuMC4wLjEnO1xuICAgIGNvbnN0IGluc3RhbmNlSWRlbnRpZmllciA9ICdJbnN0YW5jZUlEJztcbiAgICBjb25zdCBwb3J0ID0gODg4ODtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBpbnN0YW5jZSA9IERhdGFiYXNlSW5zdGFuY2UuZnJvbURhdGFiYXNlSW5zdGFuY2VBdHRyaWJ1dGVzKHN0YWNrLCAnSW5zdGFuY2UnLCB7XG4gICAgICBpbnN0YW5jZUVuZHBvaW50QWRkcmVzcyxcbiAgICAgIGluc3RhbmNlSWRlbnRpZmllcixcbiAgICAgIHBvcnQsXG4gICAgfSk7XG4gICAgbmV3IGNkay5DZm5PdXRwdXQoc3RhY2ssICdBcm5PdXRwdXQnLCB7XG4gICAgICBleHBvcnROYW1lOiBhcm5FeHBvcnROYW1lLFxuICAgICAgdmFsdWU6IGluc3RhbmNlLmluc3RhbmNlQXJuLFxuICAgIH0pO1xuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHN0YWNrLCAnRW5kcG9pbnRPdXRwdXQnLCB7XG4gICAgICBleHBvcnROYW1lOiBlbmRwb2ludEV4cG9ydE5hbWUsXG4gICAgICB2YWx1ZTogaW5zdGFuY2UuaW5zdGFuY2VFbmRwb2ludC5zb2NrZXRBZGRyZXNzLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KCdBcm5PdXRwdXQnLCB7XG4gICAgICBFeHBvcnQ6IHtcbiAgICAgICAgTmFtZTogYXJuRXhwb3J0TmFtZSxcbiAgICAgIH0sXG4gICAgICBWYWx1ZToge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgIGA6cmRzOnVzLXRlc3QtMToxMjM0NTpkYjoke2luc3RhbmNlSWRlbnRpZmllcn1gLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0pO1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzT3V0cHV0KCdFbmRwb2ludE91dHB1dCcsIHtcbiAgICAgIEV4cG9ydDoge1xuICAgICAgICBOYW1lOiBlbmRwb2ludEV4cG9ydE5hbWUsXG4gICAgICB9LFxuICAgICAgVmFsdWU6IGAke2luc3RhbmNlRW5kcG9pbnRBZGRyZXNzfToke3BvcnR9YCxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIGVuYWJsZSBwZXJmb3JtYW5jZSBpbnNpZ2h0cyBvbiBpbnN0YW5jZXMnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IHRlc3RTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBEYXRhYmFzZUluc3RhbmNlKHN0YWNrLCAnSW5zdGFuY2UnLCB7XG4gICAgICBjbHVzdGVyOiBzdGFjay5jbHVzdGVyLFxuICAgICAgaW5zdGFuY2VUeXBlOiBTSU5HTEVfSU5TVEFOQ0VfVFlQRSxcbiAgICAgIGVuYWJsZVBlcmZvcm1hbmNlSW5zaWdodHM6IHRydWUsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpEb2NEQjo6REJJbnN0YW5jZScsIHtcbiAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgRW5hYmxlUGVyZm9ybWFuY2VJbnNpZ2h0czogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmNsYXNzIFRlc3RTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIHB1YmxpYyByZWFkb25seSB2cGM6IGVjMi5WcGM7XG4gIHB1YmxpYyByZWFkb25seSBjbHVzdGVyOiBEYXRhYmFzZUNsdXN0ZXI7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU/OiBjb25zdHJ1Y3RzLkNvbnN0cnVjdCwgaWQ/OiBzdHJpbmcsIHByb3BzOiBjZGsuU3RhY2tQcm9wcyA9IHt9KSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICB0aGlzLm5vZGUuc2V0Q29udGV4dCgnYXZhaWxhYmlsaXR5LXpvbmVzOjEyMzQ1OnVzLXRlc3QtMScsIFsndXMtdGVzdC0xYScsICd1cy10ZXN0LTFiJ10pO1xuXG4gICAgdGhpcy52cGMgPSBuZXcgZWMyLlZwYyh0aGlzLCAnVlBDJyk7XG4gICAgdGhpcy5jbHVzdGVyID0gbmV3IERhdGFiYXNlQ2x1c3Rlcih0aGlzLCAnRGF0YWJhc2UnLCB7XG4gICAgICBtYXN0ZXJVc2VyOiB7XG4gICAgICAgIHVzZXJuYW1lOiAnYWRtaW4nLFxuICAgICAgICBwYXNzd29yZDogY2RrLlNlY3JldFZhbHVlLnVuc2FmZVBsYWluVGV4dCgndG9vc2hvcnQnKSxcbiAgICAgIH0sXG4gICAgICBpbnN0YW5jZVR5cGU6IENMVVNURVJfSU5TVEFOQ0VfVFlQRSxcbiAgICAgIHZwYzogdGhpcy52cGMsXG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdGVzdFN0YWNrKCkge1xuICBjb25zdCBzdGFjayA9IG5ldyBUZXN0U3RhY2sodW5kZWZpbmVkLCB1bmRlZmluZWQsIHsgZW52OiB7IGFjY291bnQ6ICcxMjM0NScsIHJlZ2lvbjogJ3VzLXRlc3QtMScgfSB9KTtcbiAgcmV0dXJuIHN0YWNrO1xufVxuIl19