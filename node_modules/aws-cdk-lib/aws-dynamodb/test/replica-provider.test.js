"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk-mock");
const sinon = require("sinon");
const replica_handler_1 = require("../lib/replica-handler");
let oldConsoleLog;
beforeAll(() => {
    oldConsoleLog = global.console.log;
    global.console.log = jest.fn();
});
afterAll(() => {
    global.console.log = oldConsoleLog;
});
AWS.setSDK(require.resolve('aws-sdk'));
const REGION = 'eu-west-2';
const createEvent = {
    RequestType: 'Create',
    ResourceProperties: {
        TableName: 'my-table',
        Region: REGION,
        ServiceToken: 'token',
    },
    ServiceToken: 'token',
    ResponseURL: 'url',
    LogicalResourceId: 'logical-id',
    RequestId: 'request-id',
    StackId: 'stack-id',
    ResourceType: 'resource-type',
};
afterEach(() => {
    AWS.restore();
});
test('on event', async () => {
    const updateTableMock = sinon.fake.resolves({});
    AWS.mock('DynamoDB', 'updateTable', updateTableMock);
    const data = await (0, replica_handler_1.onEventHandler)(createEvent);
    sinon.assert.calledWith(updateTableMock, {
        TableName: 'my-table',
        ReplicaUpdates: [
            {
                Create: {
                    RegionName: REGION,
                },
            },
        ],
    });
    expect(data).toEqual({
        PhysicalResourceId: 'my-table-eu-west-2',
    });
});
test("on Update event from CFN calls updateTable with Create if a replica in the region doesn't exist", async () => {
    AWS.mock('DynamoDB', 'describeTable', sinon.fake.resolves({
        Table: {
            Replicas: [
            // no replicas exist yet
            ],
        },
    }));
    const updateTableMock = sinon.fake.resolves({});
    AWS.mock('DynamoDB', 'updateTable', updateTableMock);
    const data = await (0, replica_handler_1.onEventHandler)({
        ...createEvent,
        OldResourceProperties: {
            TableName: 'my-old-table',
        },
        RequestType: 'Update',
    });
    sinon.assert.calledWith(updateTableMock, {
        TableName: 'my-table',
        ReplicaUpdates: [
            {
                Create: {
                    RegionName: REGION,
                },
            },
        ],
    });
    expect(data).toEqual({
        PhysicalResourceId: 'my-table-eu-west-2',
    });
});
test("on Update event from CFN calls doesn't call updateTable if a replica in the region does exist", async () => {
    AWS.mock('DynamoDB', 'describeTable', sinon.fake.resolves({
        Table: {
            Replicas: [
                { RegionName: REGION },
            ],
        },
    }));
    const updateTableMock = sinon.fake.resolves({});
    AWS.mock('DynamoDB', 'updateTable', updateTableMock);
    await (0, replica_handler_1.onEventHandler)({
        ...createEvent,
        OldResourceProperties: {
            TableName: 'my-old-table',
        },
        RequestType: 'Update',
    });
    sinon.assert.notCalled(updateTableMock);
});
test('on event calls updateTable with Delete', async () => {
    const updateTableMock = sinon.fake.resolves({});
    AWS.mock('DynamoDB', 'updateTable', updateTableMock);
    const data = await (0, replica_handler_1.onEventHandler)({
        ...createEvent,
        RequestType: 'Delete',
    });
    sinon.assert.calledWith(updateTableMock, {
        TableName: 'my-table',
        ReplicaUpdates: [
            {
                Delete: {
                    RegionName: REGION,
                },
            },
        ],
    });
    // Physical resource id never changed on Delete
    expect(data).toEqual({});
});
test('is complete for create returns false without replicas', async () => {
    const describeTableMock = sinon.fake.resolves({
        Table: {},
    });
    AWS.mock('DynamoDB', 'describeTable', describeTableMock);
    const data = await (0, replica_handler_1.isCompleteHandler)(createEvent);
    expect(data).toEqual({ IsComplete: false });
});
test('is complete for create returns false when replica is not active', async () => {
    const describeTableMock = sinon.fake.resolves({
        Table: {
            Replicas: [
                {
                    RegionName: REGION,
                    ReplicaStatus: 'CREATING',
                },
            ],
        },
    });
    AWS.mock('DynamoDB', 'describeTable', describeTableMock);
    const data = await (0, replica_handler_1.isCompleteHandler)(createEvent);
    expect(data).toEqual({ IsComplete: false });
});
test('is complete for create returns false when table is not active', async () => {
    const describeTableMock = sinon.fake.resolves({
        Table: {
            Replicas: [
                {
                    RegionName: REGION,
                    ReplicaStatus: 'ACTIVE',
                },
            ],
            TableStatus: 'UPDATING',
        },
    });
    AWS.mock('DynamoDB', 'describeTable', describeTableMock);
    const data = await (0, replica_handler_1.isCompleteHandler)(createEvent);
    expect(data).toEqual({ IsComplete: false });
});
test('is complete for create returns true when replica is active', async () => {
    const describeTableMock = sinon.fake.resolves({
        Table: {
            Replicas: [
                {
                    RegionName: REGION,
                    ReplicaStatus: 'ACTIVE',
                },
            ],
            TableStatus: 'ACTIVE',
        },
    });
    AWS.mock('DynamoDB', 'describeTable', describeTableMock);
    const data = await (0, replica_handler_1.isCompleteHandler)(createEvent);
    expect(data).toEqual({ IsComplete: true });
});
test('is complete for delete returns true when replica is gone', async () => {
    const describeTableMock = sinon.fake.resolves({
        Table: {
            Replicas: [
                {
                    RegionName: 'eu-west-1',
                    ReplicaStatus: 'ACTIVE',
                },
            ],
            TableStatus: 'ACTIVE',
        },
    });
    AWS.mock('DynamoDB', 'describeTable', describeTableMock);
    const data = await (0, replica_handler_1.isCompleteHandler)({
        ...createEvent,
        RequestType: 'Delete',
    });
    expect(data).toEqual({ IsComplete: true });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwbGljYS1wcm92aWRlci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVwbGljYS1wcm92aWRlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0Esb0NBQW9DO0FBQ3BDLCtCQUErQjtBQUMvQiw0REFBMkU7QUFFM0UsSUFBSSxhQUFrQixDQUFDO0FBRXZCLFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixhQUFhLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDbkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ2pDLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRTtJQUNaLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLGFBQWEsQ0FBQztBQUNyQyxDQUFDLENBQUMsQ0FBQztBQUVILEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBRXZDLE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQztBQUUzQixNQUFNLFdBQVcsR0FBbUI7SUFDbEMsV0FBVyxFQUFFLFFBQVE7SUFDckIsa0JBQWtCLEVBQUU7UUFDbEIsU0FBUyxFQUFFLFVBQVU7UUFDckIsTUFBTSxFQUFFLE1BQU07UUFDZCxZQUFZLEVBQUUsT0FBTztLQUN0QjtJQUNELFlBQVksRUFBRSxPQUFPO0lBQ3JCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLGlCQUFpQixFQUFFLFlBQVk7SUFDL0IsU0FBUyxFQUFFLFlBQVk7SUFDdkIsT0FBTyxFQUFFLFVBQVU7SUFDbkIsWUFBWSxFQUFFLGVBQWU7Q0FDOUIsQ0FBQztBQUVGLFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUss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eEI7YUFDRjtZQUNELFdBQVcsRUFBRSxRQUFRO1NBQ3RCO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsZUFBZSxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFekQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFBLG1DQUFpQixFQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRWxELE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUM3QyxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQywwREFBMEQsRUFBRSxLQUFLLElBQUksRUFBRTtJQUMxRSxNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzVDLEtBQUssRUFBRTtZQUNMLFFBQVEsRUFBRTtnQkFDUjtvQkFDRSxVQUFVLEVBQUUsV0FBVztvQkFDdkIsYUFBYSxFQUFFLFFBQVE7aUJBQ3hCO2FBQ0Y7WUFDRCxXQUFXLEVBQUUsUUFBUTtTQUN0QjtLQUNGLENBQUMsQ0FBQztJQUVILEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLGVBQWUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBRXpELE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBQSxtQ0FBaUIsRUFBQztRQUNuQyxHQUFHLFdBQVc7UUFDZCxXQUFXLEVBQUUsUUFBUTtLQUN0QixDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7QUFDN0MsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPbkV2ZW50UmVxdWVzdCB9IGZyb20gJy4uLy4uL2N1c3RvbS1yZXNvdXJjZXMvbGliL3Byb3ZpZGVyLWZyYW1ld29yay90eXBlcyc7XG5pbXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkay1tb2NrJztcbmltcG9ydCAqIGFzIHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCB7IGlzQ29tcGxldGVIYW5kbGVyLCBvbkV2ZW50SGFuZGxlciB9IGZyb20gJy4uL2xpYi9yZXBsaWNhLWhhbmRsZXInO1xuXG5sZXQgb2xkQ29uc29sZUxvZzogYW55O1xuXG5iZWZvcmVBbGwoKCkgPT4ge1xuICBvbGRDb25zb2xlTG9nID0gZ2xvYmFsLmNvbnNvbGUubG9nO1xuICBnbG9iYWwuY29uc29sZS5sb2cgPSBqZXN0LmZuKCk7XG59KTtcblxuYWZ0ZXJBbGwoKCkgPT4ge1xuICBnbG9iYWwuY29uc29sZS5sb2cgPSBvbGRDb25zb2xlTG9nO1xufSk7XG5cbkFXUy5zZXRTREsocmVxdWlyZS5yZXNvbHZlKCdhd3Mtc2RrJykpO1xuXG5jb25zdCBSRUdJT04gPSAnZXUtd2VzdC0yJztcblxuY29uc3QgY3JlYXRlRXZlbnQ6IE9uRXZlbnRSZXF1ZXN0ID0ge1xuICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gIFJlc291cmNlUHJvcGVydGllczoge1xuICAgIFRhYmxlTmFtZTogJ215LXRhYmxlJyxcbiAgICBSZWdpb246IFJFR0lPTixcbiAgICBTZXJ2aWNlVG9rZW46ICd0b2tlbicsXG4gIH0sXG4gIFNlcnZpY2VUb2tlbjogJ3Rva2VuJyxcbiAgUmVzcG9uc2VVUkw6ICd1cmwnLFxuICBMb2dpY2FsUmVzb3VyY2VJZDogJ2xvZ2ljYWwtaWQnLFxuICBSZXF1ZXN0SWQ6ICdyZXF1ZXN0LWlkJyxcbiAgU3RhY2tJZDogJ3N0YWNrLWlkJyxcbiAgUmVzb3VyY2VUeXBlOiAncmVzb3VyY2UtdHlwZScsXG59O1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBBV1MucmVzdG9yZSgpO1xufSk7XG5cbnRlc3QoJ29uIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCB1cGRhdGVUYWJsZU1vY2sgPSBzaW5vbi5mYWtlLnJlc29sdmVzKHt9KTtcblxuICBBV1MubW9jaygnRHluYW1vREInLCAndXBkYXRlVGFibGUnLCB1cGRhdGVUYWJsZU1vY2spO1xuXG4gIGNvbnN0IGRhdGEgPSBhd2FpdCBvbkV2ZW50SGFuZGxlcihjcmVhdGVFdmVudCk7XG5cbiAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgodXBkYXRlVGFibGVNb2NrLCB7XG4gICAgVGFibGVOYW1lOiAnbXktdGFibGUnLFxuICAgIFJlcGxpY2FVcGRhdGVzOiBbXG4gICAgICB7XG4gICAgICAgIENyZWF0ZToge1xuICAgICAgICAgIFJlZ2lvbk5hbWU6IFJFR0lPTixcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgfSk7XG5cbiAgZXhwZWN0KGRhdGEpLnRvRXF1YWwoe1xuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ215LXRhYmxlLWV1LXdlc3QtMicsXG4gIH0pO1xufSk7XG5cbnRlc3QoXCJvbiBVcGRhdGUgZXZlbnQgZnJvbSBDRk4gY2FsbHMgdXBkYXRlVGFibGUgd2l0aCBDcmVhdGUgaWYgYSByZXBsaWNhIGluIHRoZSByZWdpb24gZG9lc24ndCBleGlzdFwiLCBhc3luYyAoKSA9PiB7XG4gIEFXUy5tb2NrKCdEeW5hbW9EQicsICdkZXNjcmliZVRhYmxlJywgc2lub24uZmFrZS5yZXNvbHZlcyh7XG4gICAgVGFibGU6IHtcbiAgICAgIFJlcGxpY2FzOiBbXG4gICAgICAgIC8vIG5vIHJlcGxpY2FzIGV4aXN0IHlldFxuICAgICAgXSxcbiAgICB9LFxuICB9KSk7XG5cbiAgY29uc3QgdXBkYXRlVGFibGVNb2NrID0gc2lub24uZmFrZS5yZXNvbHZlcyh7fSk7XG4gIEFXUy5tb2NrKCdEeW5hbW9EQicsICd1cGRhdGVUYWJsZScsIHVwZGF0ZVRhYmxlTW9jayk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IG9uRXZlbnRIYW5kbGVyKHtcbiAgICAuLi5jcmVhdGVFdmVudCxcbiAgICBPbGRSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFRhYmxlTmFtZTogJ215LW9sZC10YWJsZScsXG4gICAgfSxcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gIH0pO1xuXG4gIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKHVwZGF0ZVRhYmxlTW9jaywge1xuICAgIFRhYmxlTmFtZTogJ215LXRhYmxlJyxcbiAgICBSZXBsaWNhVXBkYXRlczogW1xuICAgICAge1xuICAgICAgICBDcmVhdGU6IHtcbiAgICAgICAgICBSZWdpb25OYW1lOiBSRUdJT04sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGV4cGVjdChkYXRhKS50b0VxdWFsKHtcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdteS10YWJsZS1ldS13ZXN0LTInLFxuICB9KTtcbn0pO1xuXG50ZXN0KFwib24gVXBkYXRlIGV2ZW50IGZyb20gQ0ZOIGNhbGxzIGRvZXNuJ3QgY2FsbCB1cGRhdGVUYWJsZSBpZiBhIHJlcGxpY2EgaW4gdGhlIHJlZ2lvbiBkb2VzIGV4aXN0XCIsIGFzeW5jICgpID0+IHtcbiAgQVdTLm1vY2soJ0R5bmFtb0RCJywgJ2Rlc2NyaWJlVGFibGUnLCBzaW5vbi5mYWtlLnJlc29sdmVzKHtcbiAgICBUYWJsZToge1xuICAgICAgUmVwbGljYXM6IFtcbiAgICAgICAgeyBSZWdpb25OYW1lOiBSRUdJT04gfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSkpO1xuXG4gIGNvbnN0IHVwZGF0ZVRhYmxlTW9jayA9IHNpbm9uLmZha2UucmVzb2x2ZXMoe30pO1xuICBBV1MubW9jaygnRHluYW1vREInLCAndXBkYXRlVGFibGUnLCB1cGRhdGVUYWJsZU1vY2spO1xuXG4gIGF3YWl0IG9uRXZlbnRIYW5kbGVyKHtcbiAgICAuLi5jcmVhdGVFdmVudCxcbiAgICBPbGRSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFRhYmxlTmFtZTogJ215LW9sZC10YWJsZScsXG4gICAgfSxcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gIH0pO1xuXG4gIHNpbm9uLmFzc2VydC5ub3RDYWxsZWQodXBkYXRlVGFibGVNb2NrKTtcbn0pO1xuXG50ZXN0KCdvbiBldmVudCBjYWxscyB1cGRhdGVUYWJsZSB3aXRoIERlbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgdXBkYXRlVGFibGVNb2NrID0gc2lub24uZmFrZS5yZXNvbHZlcyh7fSk7XG5cbiAgQVdTLm1vY2soJ0R5bmFtb0RCJywgJ3VwZGF0ZVRhYmxlJywgdXBkYXRlVGFibGVNb2NrKTtcblxuICBjb25zdCBkYXRhID0gYXdhaXQgb25FdmVudEhhbmRsZXIoe1xuICAgIC4uLmNyZWF0ZUV2ZW50LFxuICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgfSk7XG5cbiAgc2lub24uYXNzZXJ0LmNhbGxlZFdpdGgodXBkYXRlVGFibGVNb2NrLCB7XG4gICAgVGFibGVOYW1lOiAnbXktdGFibGUnLFxuICAgIFJlcGxpY2FVcGRhdGVzOiBbXG4gICAgICB7XG4gICAgICAgIERlbGV0ZToge1xuICAgICAgICAgIFJlZ2lvbk5hbWU6IFJFR0lPTixcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgXSxcbiAgfSk7XG5cbiAgLy8gUGh5c2ljYWwgcmVzb3VyY2UgaWQgbmV2ZXIgY2hhbmdlZCBvbiBEZWxldGVcbiAgZXhwZWN0KGRhdGEpLnRvRXF1YWwoe30pO1xufSk7XG5cbnRlc3QoJ2lzIGNvbXBsZXRlIGZvciBjcmVhdGUgcmV0dXJucyBmYWxzZSB3aXRob3V0IHJlcGxpY2FzJywgYXN5bmMgKCkgPT4ge1xuICBjb25zdCBkZXNjcmliZVRhYmxlTW9jayA9IHNpbm9uLmZha2UucmVzb2x2ZXMoe1xuICAgIFRhYmxlOiB7fSxcbiAgfSk7XG5cbiAgQVdTLm1vY2soJ0R5bmFtb0RCJywgJ2Rlc2NyaWJlVGFibGUnLCBkZXNjcmliZVRhYmxlTW9jayk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGlzQ29tcGxldGVIYW5kbGVyKGNyZWF0ZUV2ZW50KTtcblxuICBleHBlY3QoZGF0YSkudG9FcXVhbCh7IElzQ29tcGxldGU6IGZhbHNlIH0pO1xufSk7XG5cbnRlc3QoJ2lzIGNvbXBsZXRlIGZvciBjcmVhdGUgcmV0dXJucyBmYWxzZSB3aGVuIHJlcGxpY2EgaXMgbm90IGFjdGl2ZScsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgZGVzY3JpYmVUYWJsZU1vY2sgPSBzaW5vbi5mYWtlLnJlc29sdmVzKHtcbiAgICBUYWJsZToge1xuICAgICAgUmVwbGljYXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIFJlZ2lvbk5hbWU6IFJFR0lPTixcbiAgICAgICAgICBSZXBsaWNhU3RhdHVzOiAnQ1JFQVRJTkcnLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9LFxuICB9KTtcblxuICBBV1MubW9jaygnRHluYW1vREInLCAnZGVzY3JpYmVUYWJsZScsIGRlc2NyaWJlVGFibGVNb2NrKTtcblxuICBjb25zdCBkYXRhID0gYXdhaXQgaXNDb21wbGV0ZUhhbmRsZXIoY3JlYXRlRXZlbnQpO1xuXG4gIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgSXNDb21wbGV0ZTogZmFsc2UgfSk7XG59KTtcblxudGVzdCgnaXMgY29tcGxldGUgZm9yIGNyZWF0ZSByZXR1cm5zIGZhbHNlIHdoZW4gdGFibGUgaXMgbm90IGFjdGl2ZScsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgZGVzY3JpYmVUYWJsZU1vY2sgPSBzaW5vbi5mYWtlLnJlc29sdmVzKHtcbiAgICBUYWJsZToge1xuICAgICAgUmVwbGljYXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIFJlZ2lvbk5hbWU6IFJFR0lPTixcbiAgICAgICAgICBSZXBsaWNhU3RhdHVzOiAnQUNUSVZFJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBUYWJsZVN0YXR1czogJ1VQREFUSU5HJyxcbiAgICB9LFxuICB9KTtcblxuICBBV1MubW9jaygnRHluYW1vREInLCAnZGVzY3JpYmVUYWJsZScsIGRlc2NyaWJlVGFibGVNb2NrKTtcblxuICBjb25zdCBkYXRhID0gYXdhaXQgaXNDb21wbGV0ZUhhbmRsZXIoY3JlYXRlRXZlbnQpO1xuXG4gIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgSXNDb21wbGV0ZTogZmFsc2UgfSk7XG59KTtcblxudGVzdCgnaXMgY29tcGxldGUgZm9yIGNyZWF0ZSByZXR1cm5zIHRydWUgd2hlbiByZXBsaWNhIGlzIGFjdGl2ZScsIGFzeW5jICgpID0+IHtcbiAgY29uc3QgZGVzY3JpYmVUYWJsZU1vY2sgPSBzaW5vbi5mYWtlLnJlc29sdmVzKHtcbiAgICBUYWJsZToge1xuICAgICAgUmVwbGljYXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIFJlZ2lvbk5hbWU6IFJFR0lPTixcbiAgICAgICAgICBSZXBsaWNhU3RhdHVzOiAnQUNUSVZFJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBUYWJsZVN0YXR1czogJ0FDVElWRScsXG4gICAgfSxcbiAgfSk7XG5cbiAgQVdTLm1vY2soJ0R5bmFtb0RCJywgJ2Rlc2NyaWJlVGFibGUnLCBkZXNjcmliZVRhYmxlTW9jayk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGlzQ29tcGxldGVIYW5kbGVyKGNyZWF0ZUV2ZW50KTtcblxuICBleHBlY3QoZGF0YSkudG9FcXVhbCh7IElzQ29tcGxldGU6IHRydWUgfSk7XG59KTtcblxudGVzdCgnaXMgY29tcGxldGUgZm9yIGRlbGV0ZSByZXR1cm5zIHRydWUgd2hlbiByZXBsaWNhIGlzIGdvbmUnLCBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGRlc2NyaWJlVGFibGVNb2NrID0gc2lub24uZmFrZS5yZXNvbHZlcyh7XG4gICAgVGFibGU6IHtcbiAgICAgIFJlcGxpY2FzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBSZWdpb25OYW1lOiAnZXUtd2VzdC0xJyxcbiAgICAgICAgICBSZXBsaWNhU3RhdHVzOiAnQUNUSVZFJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBUYWJsZVN0YXR1czogJ0FDVElWRScsXG4gICAgfSxcbiAgfSk7XG5cbiAgQVdTLm1vY2soJ0R5bmFtb0RCJywgJ2Rlc2NyaWJlVGFibGUnLCBkZXNjcmliZVRhYmxlTW9jayk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGlzQ29tcGxldGVIYW5kbGVyKHtcbiAgICAuLi5jcmVhdGVFdmVudCxcbiAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gIH0pO1xuXG4gIGV4cGVjdChkYXRhKS50b0VxdWFsKHsgSXNDb21wbGV0ZTogdHJ1ZSB9KTtcbn0pO1xuIl19