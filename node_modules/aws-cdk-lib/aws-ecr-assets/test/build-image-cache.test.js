"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const core_1 = require("../../core");
const cx_api_1 = require("../../cx-api");
const lib_1 = require("../lib");
describe('build cache', () => {
    test('manifest contains cache from options ', () => {
        // GIVEN
        const app = new core_1.App();
        const stack = new core_1.Stack(app);
        const asset = new lib_1.DockerImageAsset(stack, 'DockerImage6', {
            directory: path.join(__dirname, 'demo-image'),
            cacheFrom: [{ type: 'registry', params: { image: 'foo' } }],
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const manifestArtifact = getAssetManifest(asm);
        const manifest = readAssetManifest(manifestArtifact);
        expect(Object.keys(manifest.dockerImages ?? {}).length).toBe(1);
        expect(manifest.dockerImages?.[asset.assetHash]?.source.cacheFrom?.length).toBe(1);
        expect(manifest.dockerImages?.[asset.assetHash]?.source.cacheFrom?.[0]).toStrictEqual({
            type: 'registry',
            params: { image: 'foo' },
        });
    });
    test('manifest contains cache to options ', () => {
        // GIVEN
        const app = new core_1.App();
        const stack = new core_1.Stack(app);
        const asset = new lib_1.DockerImageAsset(stack, 'DockerImage6', {
            directory: path.join(__dirname, 'demo-image'),
            cacheTo: { type: 'inline' },
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const manifestArtifact = getAssetManifest(asm);
        const manifest = readAssetManifest(manifestArtifact);
        expect(Object.keys(manifest.dockerImages ?? {}).length).toBe(1);
        expect(manifest.dockerImages?.[asset.assetHash]?.source.cacheTo).toStrictEqual({
            type: 'inline',
        });
    });
    test('manifest does not contain options when not specified', () => {
        // GIVEN
        const app = new core_1.App();
        const stack = new core_1.Stack(app);
        const asset = new lib_1.DockerImageAsset(stack, 'DockerImage6', {
            directory: path.join(__dirname, 'demo-image'),
        });
        // WHEN
        const asm = app.synth();
        // THEN
        const manifestArtifact = getAssetManifest(asm);
        const manifest = readAssetManifest(manifestArtifact);
        expect(Object.keys(manifest.dockerImages ?? {}).length).toBe(1);
        expect(manifest.dockerImages?.[asset.assetHash]?.source.cacheFrom).toBeUndefined();
        expect(manifest.dockerImages?.[asset.assetHash]?.source.cacheTo).toBeUndefined();
    });
});
function isAssetManifest(x) {
    return x instanceof cx_api_1.AssetManifestArtifact;
}
function getAssetManifest(asm) {
    const manifestArtifact = asm.artifacts.filter(isAssetManifest)[0];
    if (!manifestArtifact) {
        throw new Error('no asset manifest in assembly');
    }
    return manifestArtifact;
}
function readAssetManifest(manifestArtifact) {
    return JSON.parse(fs.readFileSync(manifestArtifact.file, { encoding: 'utf-8' }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtaW1hZ2UtY2FjaGUudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJ1aWxkLWltYWdlLWNhY2hlLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLHFDQUF3QztBQUN4Qyx5Q0FBbUY7QUFDbkYsZ0NBQTBDO0FBRTFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQzNCLElBQUksQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7UUFDakQsUUFBUTtRQUNSLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7UUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxzQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFO1lBQ3hELFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUM7WUFDN0MsU0FBUyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO1NBQzVELENBQUMsQ0FBQztRQUVILE9BQU87UUFDUCxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFeEIsT0FBTztRQUNQLE1BQU0sZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0MsTUFBTSxRQUFRLEdBQUcsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUVyRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRSxNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRixNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7WUFDcEYsSUFBSSxFQUFFLFVBQVU7WUFDaEIsTUFBTSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRTtTQUN6QixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUU7UUFDL0MsUUFBUTtRQUNSLE1BQU0sR0FBRyxHQUFHLElBQUksVUFBRyxFQUFFLENBQUM7UUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxzQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsY0FBYyxFQUFFO1lBQ3hELFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUM7WUFDN0MsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtTQUM1QixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXhCLE9BQU87UUFDUCxNQUFNLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFckQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQztZQUM3RSxJQUFJLEVBQUUsUUFBUTtTQUNmLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHNEQUFzRCxFQUFFLEdBQUcsRUFBRTtRQUNoRSxRQUFRO1FBQ1IsTUFBTSxHQUFHLEdBQUcsSUFBSSxVQUFHLEVBQUUsQ0FBQztRQUN0QixNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBRyxJQUFJLHNCQUFnQixDQUFDLEtBQUssRUFBRSxjQUFjLEVBQUU7WUFDeEQsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQztTQUM5QyxDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXhCLE9BQU87UUFDUCxNQUFNLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDckQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ25GLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUNuRixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxlQUFlLENBQUMsQ0FBZ0I7SUFDdkMsT0FBTyxDQUFDLFlBQVksOEJBQXFCLENBQUM7QUFDNUMsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsR0FBa0I7SUFDMUMsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7UUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0tBQ2xEO0lBQ0QsT0FBTyxnQkFBZ0IsQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxnQkFBdUM7SUFDaEUsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNuRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEFzc2V0TWFuaWZlc3QgfSBmcm9tICcuLi8uLi9jbG91ZC1hc3NlbWJseS1zY2hlbWEnO1xuaW1wb3J0IHsgQXBwLCBTdGFjayB9IGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgQXNzZXRNYW5pZmVzdEFydGlmYWN0LCBDbG91ZEFydGlmYWN0LCBDbG91ZEFzc2VtYmx5IH0gZnJvbSAnLi4vLi4vY3gtYXBpJztcbmltcG9ydCB7IERvY2tlckltYWdlQXNzZXQgfSBmcm9tICcuLi9saWInO1xuXG5kZXNjcmliZSgnYnVpbGQgY2FjaGUnLCAoKSA9PiB7XG4gIHRlc3QoJ21hbmlmZXN0IGNvbnRhaW5zIGNhY2hlIGZyb20gb3B0aW9ucyAnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBEb2NrZXJJbWFnZUFzc2V0KHN0YWNrLCAnRG9ja2VySW1hZ2U2Jywge1xuICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZGVtby1pbWFnZScpLFxuICAgICAgY2FjaGVGcm9tOiBbeyB0eXBlOiAncmVnaXN0cnknLCBwYXJhbXM6IHsgaW1hZ2U6ICdmb28nIH0gfV0sXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgYXNtID0gYXBwLnN5bnRoKCk7XG5cbiAgICAvLyBUSEVOXG4gICAgY29uc3QgbWFuaWZlc3RBcnRpZmFjdCA9IGdldEFzc2V0TWFuaWZlc3QoYXNtKTtcbiAgICBjb25zdCBtYW5pZmVzdCA9IHJlYWRBc3NldE1hbmlmZXN0KG1hbmlmZXN0QXJ0aWZhY3QpO1xuXG4gICAgZXhwZWN0KE9iamVjdC5rZXlzKG1hbmlmZXN0LmRvY2tlckltYWdlcyA/PyB7fSkubGVuZ3RoKS50b0JlKDEpO1xuICAgIGV4cGVjdChtYW5pZmVzdC5kb2NrZXJJbWFnZXM/Llthc3NldC5hc3NldEhhc2hdPy5zb3VyY2UuY2FjaGVGcm9tPy5sZW5ndGgpLnRvQmUoMSk7XG4gICAgZXhwZWN0KG1hbmlmZXN0LmRvY2tlckltYWdlcz8uW2Fzc2V0LmFzc2V0SGFzaF0/LnNvdXJjZS5jYWNoZUZyb20/LlswXSkudG9TdHJpY3RFcXVhbCh7XG4gICAgICB0eXBlOiAncmVnaXN0cnknLFxuICAgICAgcGFyYW1zOiB7IGltYWdlOiAnZm9vJyB9LFxuICAgIH0pO1xuICB9KTtcbiAgdGVzdCgnbWFuaWZlc3QgY29udGFpbnMgY2FjaGUgdG8gb3B0aW9ucyAnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBEb2NrZXJJbWFnZUFzc2V0KHN0YWNrLCAnRG9ja2VySW1hZ2U2Jywge1xuICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZGVtby1pbWFnZScpLFxuICAgICAgY2FjaGVUbzogeyB0eXBlOiAnaW5saW5lJyB9LFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGFzbSA9IGFwcC5zeW50aCgpO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IG1hbmlmZXN0QXJ0aWZhY3QgPSBnZXRBc3NldE1hbmlmZXN0KGFzbSk7XG4gICAgY29uc3QgbWFuaWZlc3QgPSByZWFkQXNzZXRNYW5pZmVzdChtYW5pZmVzdEFydGlmYWN0KTtcblxuICAgIGV4cGVjdChPYmplY3Qua2V5cyhtYW5pZmVzdC5kb2NrZXJJbWFnZXMgPz8ge30pLmxlbmd0aCkudG9CZSgxKTtcbiAgICBleHBlY3QobWFuaWZlc3QuZG9ja2VySW1hZ2VzPy5bYXNzZXQuYXNzZXRIYXNoXT8uc291cmNlLmNhY2hlVG8pLnRvU3RyaWN0RXF1YWwoe1xuICAgICAgdHlwZTogJ2lubGluZScsXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ21hbmlmZXN0IGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyB3aGVuIG5vdCBzcGVjaWZpZWQnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBEb2NrZXJJbWFnZUFzc2V0KHN0YWNrLCAnRG9ja2VySW1hZ2U2Jywge1xuICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZGVtby1pbWFnZScpLFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGFzbSA9IGFwcC5zeW50aCgpO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IG1hbmlmZXN0QXJ0aWZhY3QgPSBnZXRBc3NldE1hbmlmZXN0KGFzbSk7XG4gICAgY29uc3QgbWFuaWZlc3QgPSByZWFkQXNzZXRNYW5pZmVzdChtYW5pZmVzdEFydGlmYWN0KTtcbiAgICBleHBlY3QoT2JqZWN0LmtleXMobWFuaWZlc3QuZG9ja2VySW1hZ2VzID8/IHt9KS5sZW5ndGgpLnRvQmUoMSk7XG4gICAgZXhwZWN0KG1hbmlmZXN0LmRvY2tlckltYWdlcz8uW2Fzc2V0LmFzc2V0SGFzaF0/LnNvdXJjZS5jYWNoZUZyb20pLnRvQmVVbmRlZmluZWQoKTtcbiAgICBleHBlY3QobWFuaWZlc3QuZG9ja2VySW1hZ2VzPy5bYXNzZXQuYXNzZXRIYXNoXT8uc291cmNlLmNhY2hlVG8pLnRvQmVVbmRlZmluZWQoKTtcbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gaXNBc3NldE1hbmlmZXN0KHg6IENsb3VkQXJ0aWZhY3QpOiB4IGlzIEFzc2V0TWFuaWZlc3RBcnRpZmFjdCB7XG4gIHJldHVybiB4IGluc3RhbmNlb2YgQXNzZXRNYW5pZmVzdEFydGlmYWN0O1xufVxuXG5mdW5jdGlvbiBnZXRBc3NldE1hbmlmZXN0KGFzbTogQ2xvdWRBc3NlbWJseSk6IEFzc2V0TWFuaWZlc3RBcnRpZmFjdCB7XG4gIGNvbnN0IG1hbmlmZXN0QXJ0aWZhY3QgPSBhc20uYXJ0aWZhY3RzLmZpbHRlcihpc0Fzc2V0TWFuaWZlc3QpWzBdO1xuICBpZiAoIW1hbmlmZXN0QXJ0aWZhY3QpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ25vIGFzc2V0IG1hbmlmZXN0IGluIGFzc2VtYmx5Jyk7XG4gIH1cbiAgcmV0dXJuIG1hbmlmZXN0QXJ0aWZhY3Q7XG59XG5cbmZ1bmN0aW9uIHJlYWRBc3NldE1hbmlmZXN0KG1hbmlmZXN0QXJ0aWZhY3Q6IEFzc2V0TWFuaWZlc3RBcnRpZmFjdCk6IEFzc2V0TWFuaWZlc3Qge1xuICByZXR1cm4gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMobWFuaWZlc3RBcnRpZmFjdC5maWxlLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcbn1cbiJdfQ==