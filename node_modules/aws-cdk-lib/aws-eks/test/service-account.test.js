"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const iam = require("../../aws-iam");
const util_1 = require("./util");
const eks = require("../lib");
/* eslint-disable max-len */
describe('service account', () => {
    describe('add Service Account', () => {
        test('defaults should have default namespace and lowercase unique id', () => {
            // GIVEN
            const { stack, cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            new eks.ServiceAccount(stack, 'MyServiceAccount', { cluster });
            // THEN
            assertions_1.Template.fromStack(stack).hasResourceProperties(eks.KubernetesManifest.RESOURCE_TYPE, {
                ServiceToken: {
                    'Fn::GetAtt': [
                        'awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B',
                        'Outputs.StackawscdkawseksKubectlProviderframeworkonEvent8897FD9BArn',
                    ],
                },
                Manifest: {
                    'Fn::Join': [
                        '',
                        [
                            '[{\"apiVersion\":\"v1\",\"kind\":\"ServiceAccount\",\"metadata\":{\"name\":\"stackmyserviceaccount58b9529e\",\"namespace\":\"default\",\"labels\":{\"app.kubernetes.io/name\":\"stackmyserviceaccount58b9529e\"},\"annotations\":{\"eks.amazonaws.com/role-arn\":\"',
                            {
                                'Fn::GetAtt': [
                                    'MyServiceAccountRoleB41709FF',
                                    'Arn',
                                ],
                            },
                            '\"}}}]',
                        ],
                    ],
                },
            });
            assertions_1.Template.fromStack(stack).hasResourceProperties(iam.CfnRole.CFN_RESOURCE_TYPE_NAME, {
                AssumeRolePolicyDocument: {
                    Statement: [
                        {
                            Action: 'sts:AssumeRoleWithWebIdentity',
                            Effect: 'Allow',
                            Principal: {
                                Federated: {
                                    Ref: 'ClusterOpenIdConnectProviderE7EB0530',
                                },
                            },
                            Condition: {
                                StringEquals: {
                                    'Fn::GetAtt': [
                                        'MyServiceAccountConditionJson1ED3BC54',
                                        'Value',
                                    ],
                                },
                            },
                        },
                    ],
                    Version: '2012-10-17',
                },
            });
        });
        test('it is possible to add annotations and labels', () => {
            // GIVEN
            const { stack, cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            new eks.ServiceAccount(stack, 'MyServiceAccount', {
                cluster,
                annotations: {
                    'eks.amazonaws.com/sts-regional-endpoints': 'false',
                },
                labels: {
                    'some-label': 'with-some-value',
                },
            });
            // THEN
            assertions_1.Template.fromStack(stack).hasResourceProperties(eks.KubernetesManifest.RESOURCE_TYPE, {
                ServiceToken: {
                    'Fn::GetAtt': [
                        'awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B',
                        'Outputs.StackawscdkawseksKubectlProviderframeworkonEvent8897FD9BArn',
                    ],
                },
                Manifest: {
                    'Fn::Join': [
                        '',
                        [
                            '[{\"apiVersion\":\"v1\",\"kind\":\"ServiceAccount\",\"metadata\":{\"name\":\"stackmyserviceaccount58b9529e\",\"namespace\":\"default\",\"labels\":{\"app.kubernetes.io/name\":\"stackmyserviceaccount58b9529e\",\"some-label\":\"with-some-value\"},\"annotations\":{\"eks.amazonaws.com/role-arn\":\"',
                            {
                                'Fn::GetAtt': [
                                    'MyServiceAccountRoleB41709FF',
                                    'Arn',
                                ],
                            },
                            '\",\"eks.amazonaws.com/sts-regional-endpoints\":\"false\"}}}]',
                        ],
                    ],
                },
            });
            assertions_1.Template.fromStack(stack).hasResourceProperties(iam.CfnRole.CFN_RESOURCE_TYPE_NAME, {
                AssumeRolePolicyDocument: {
                    Statement: [
                        {
                            Action: 'sts:AssumeRoleWithWebIdentity',
                            Effect: 'Allow',
                            Principal: {
                                Federated: {
                                    Ref: 'ClusterOpenIdConnectProviderE7EB0530',
                                },
                            },
                            Condition: {
                                StringEquals: {
                                    'Fn::GetAtt': [
                                        'MyServiceAccountConditionJson1ED3BC54',
                                        'Value',
                                    ],
                                },
                            },
                        },
                    ],
                    Version: '2012-10-17',
                },
            });
        });
        test('should have allow multiple services accounts', () => {
            // GIVEN
            const { stack, cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            cluster.addServiceAccount('MyServiceAccount');
            cluster.addServiceAccount('MyOtherServiceAccount');
            // THEN
            assertions_1.Template.fromStack(stack).hasResourceProperties(eks.KubernetesManifest.RESOURCE_TYPE, {
                ServiceToken: {
                    'Fn::GetAtt': [
                        'awscdkawseksKubectlProviderNestedStackawscdkawseksKubectlProviderNestedStackResourceA7AEBA6B',
                        'Outputs.StackawscdkawseksKubectlProviderframeworkonEvent8897FD9BArn',
                    ],
                },
                Manifest: {
                    'Fn::Join': [
                        '',
                        [
                            '[{\"apiVersion\":\"v1\",\"kind\":\"ServiceAccount\",\"metadata\":{\"name\":\"stackclustermyotherserviceaccounta472761a\",\"namespace\":\"default\",\"labels\":{\"app.kubernetes.io/name\":\"stackclustermyotherserviceaccounta472761a\"},\"annotations\":{\"eks.amazonaws.com/role-arn\":\"',
                            {
                                'Fn::GetAtt': [
                                    'ClusterMyOtherServiceAccountRole764583C5',
                                    'Arn',
                                ],
                            },
                            '\"}}}]',
                        ],
                    ],
                },
            });
        });
        test('should have unique resource name', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            cluster.addServiceAccount('MyServiceAccount');
            // THEN
            expect(() => cluster.addServiceAccount('MyServiceAccount')).toThrow();
        });
        test('addServiceAccount for imported cluster', () => {
            const { stack } = (0, util_1.testFixture)();
            const oidcProvider = new iam.OpenIdConnectProvider(stack, 'ClusterOpenIdConnectProvider', {
                url: 'oidc_issuer',
            });
            const cluster = eks.Cluster.fromClusterAttributes(stack, 'Cluster', {
                clusterName: 'Cluster',
                openIdConnectProvider: oidcProvider,
                kubectlRoleArn: 'arn:aws:iam::123456:role/service-role/k8sservicerole',
            });
            cluster.addServiceAccount('MyServiceAccount');
            assertions_1.Template.fromStack(stack).hasResourceProperties(eks.KubernetesManifest.RESOURCE_TYPE, {
                ServiceToken: {
                    'Fn::GetAtt': [
                        'StackClusterF0EB02FAKubectlProviderNestedStackStackClusterF0EB02FAKubectlProviderNestedStackResource739D12C4',
                        'Outputs.StackStackClusterF0EB02FAKubectlProviderframeworkonEvent8377F076Arn',
                    ],
                },
                PruneLabel: 'aws.cdk.eks/prune-c8d8e1722a4f3ed332f8ac74cb3d962f01fbb62291',
                Manifest: {
                    'Fn::Join': [
                        '',
                        [
                            '[{"apiVersion":"v1","kind":"ServiceAccount","metadata":{"name":"stackclustermyserviceaccount373b933c","namespace":"default","labels":{"aws.cdk.eks/prune-c8d8e1722a4f3ed332f8ac74cb3d962f01fbb62291":"","app.kubernetes.io/name":"stackclustermyserviceaccount373b933c"},"annotations":{"eks.amazonaws.com/role-arn":"',
                            {
                                'Fn::GetAtt': [
                                    'ClusterMyServiceAccountRole85337B29',
                                    'Arn',
                                ],
                            },
                            '"}}}]',
                        ],
                    ],
                },
            });
            assertions_1.Template.fromStack(stack).hasResourceProperties(iam.CfnRole.CFN_RESOURCE_TYPE_NAME, {
                AssumeRolePolicyDocument: {
                    Statement: [
                        {
                            Action: 'sts:AssumeRoleWithWebIdentity',
                            Condition: {
                                StringEquals: {
                                    'Fn::GetAtt': [
                                        'ClusterMyServiceAccountConditionJson671C0633',
                                        'Value',
                                    ],
                                },
                            },
                            Effect: 'Allow',
                            Principal: {
                                Federated: {
                                    Ref: 'ClusterOpenIdConnectProviderA8B8E987',
                                },
                            },
                        },
                    ],
                    Version: '2012-10-17',
                },
            });
        });
    });
    describe('Service Account name must follow Kubernetes spec', () => {
        test('throw error on capital letters', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                name: 'XXX',
            }))
                // THEN
                .toThrowError(RangeError);
        });
        test('throw error if ends with dot', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                name: 'test.',
            }))
                // THEN
                .toThrowError(RangeError);
        });
        test('dot in the name is allowed', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            const valueWithDot = 'test.name';
            // WHEN
            const sa = cluster.addServiceAccount('InvalidServiceAccount', {
                name: valueWithDot,
            });
            // THEN
            expect(sa.serviceAccountName).toEqual(valueWithDot);
        });
        test('throw error if name is too long', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                name: 'x'.repeat(255),
            }))
                // THEN
                .toThrowError(RangeError);
        });
    });
    describe('Service Account namespace must follow Kubernetes spec', () => {
        test('throw error on capital letters', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                namespace: 'XXX',
            }))
                // THEN
                .toThrowError(RangeError);
        });
        test('throw error if ends with dot', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                namespace: 'test.',
            }))
                // THEN
                .toThrowError(RangeError);
        });
        test('throw error if dot is in the name', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            const valueWithDot = 'test.name';
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                namespace: valueWithDot,
            }))
                // THEN
                .toThrowError(RangeError);
        });
        test('throw error if name is too long', () => {
            // GIVEN
            const { cluster } = (0, util_1.testFixtureCluster)();
            // WHEN
            expect(() => cluster.addServiceAccount('InvalidServiceAccount', {
                namespace: 'x'.repeat(65),
            }))
                // THEN
                .toThrowError(RangeError);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS1hY2NvdW50LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXJ2aWNlLWFjY291bnQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUE0QztBQUM1QyxxQ0FBcUM7QUFDckMsaUNBQXlEO0FBQ3pELDhCQUE4QjtBQUU5Qiw0QkFBNEI7QUFFNUIsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLElBQUksQ0FBQyxnRUFBZ0UsRUFBRSxHQUFHLEVBQUU7WUFDMUUsUUFBUTtZQUNSLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBQSx5QkFBa0IsR0FBRSxDQUFDO1lBRWhELE9BQU87WUFDUCxJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLGtCQUFrQixFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUUvRCxPQUFPO1lBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRTtnQkFDcEYsWUFBWSxFQUFFO29CQUNaLFlBQVksRUFBRTt3QkFDWiw4RkFBOEY7d0JBQzlGLHFFQUFxRTtxQkFDdEU7aUJBQ0Y7Z0JBQ0QsUUFBUSxFQUFFO29CQUNSLFVBQVUsRUFBRTt3QkFDVixFQUFFO3dCQUNGOzRCQUNFLHFRQUFxUTs0QkFDclE7Z0NBQ0UsWUFBWSxFQUFFO29DQUNaLDhCQUE4QjtvQ0FDOUIsS0FBSztpQ0FDTjs2QkFDRjs0QkFDRCxRQUFRO3lCQUNUO3FCQUNGO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1lBQ0gscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRTtnQkFDbEYsd0JBQXdCLEVB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QUFTLEVBQUUsWUFBWTthQUN4QixDQUFDLENBQUM7Z0JBQ0gsT0FBTztpQkFDSixZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1lBQzNDLFFBQVE7WUFDUixNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBQSx5QkFBa0IsR0FBRSxDQUFDO1lBRXpDLE9BQU87WUFDUCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLHVCQUF1QixFQUFFO2dCQUM5RCxTQUFTLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7YUFDMUIsQ0FBQyxDQUFDO2dCQUNILE9BQU87aUJBQ0osWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vLi4vYXdzLWlhbSc7XG5pbXBvcnQgeyB0ZXN0Rml4dHVyZSwgdGVzdEZpeHR1cmVDbHVzdGVyIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCAqIGFzIGVrcyBmcm9tICcuLi9saWInO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGVuICovXG5cbmRlc2NyaWJlKCdzZXJ2aWNlIGFjY291bnQnLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdhZGQgU2VydmljZSBBY2NvdW50JywgKCkgPT4ge1xuICAgIHRlc3QoJ2RlZmF1bHRzIHNob3VsZCBoYXZlIGRlZmF1bHQgbmFtZXNwYWNlIGFuZCBsb3dlcmNhc2UgdW5pcXVlIGlkJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHsgc3RhY2ssIGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgZWtzLlNlcnZpY2VBY2NvdW50KHN0YWNrLCAnTXlTZXJ2aWNlQWNjb3VudCcsIHsgY2x1c3RlciB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoZWtzLkt1YmVybmV0ZXNNYW5pZmVzdC5SRVNPVVJDRV9UWVBFLCB7XG4gICAgICAgIFNlcnZpY2VUb2tlbjoge1xuICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgJ2F3c2Nka2F3c2Vrc0t1YmVjdGxQcm92aWRlck5lc3RlZFN0YWNrYXdzY2RrYXdzZWtzS3ViZWN0bFByb3ZpZGVyTmVzdGVkU3RhY2tSZXNvdXJjZUE3QUVCQTZCJyxcbiAgICAgICAgICAgICdPdXRwdXRzLlN0YWNrYXdzY2RrYXdzZWtzS3ViZWN0bFByb3ZpZGVyZnJhbWV3b3Jrb25FdmVudDg4OTdGRDlCQXJuJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBNYW5pZmVzdDoge1xuICAgICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAnW3tcXFwiYXBpVmVyc2lvblxcXCI6XFxcInYxXFxcIixcXFwia2luZFxcXCI6XFxcIlNlcnZpY2VBY2NvdW50XFxcIixcXFwibWV0YWRhdGFcXFwiOntcXFwibmFtZVxcXCI6XFxcInN0YWNrbXlzZXJ2aWNlYWNjb3VudDU4Yjk1MjllXFxcIixcXFwibmFtZXNwYWNlXFxcIjpcXFwiZGVmYXVsdFxcXCIsXFxcImxhYmVsc1xcXCI6e1xcXCJhcHAua3ViZXJuZXRlcy5pby9uYW1lXFxcIjpcXFwic3RhY2tteXNlcnZpY2VhY2NvdW50NThiOTUyOWVcXFwifSxcXFwiYW5ub3RhdGlvbnNcXFwiOntcXFwiZWtzLmFtYXpvbmF3cy5jb20vcm9sZS1hcm5cXFwiOlxcXCInLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgICAgICAgICAnTXlTZXJ2aWNlQWNjb3VudFJvbGVCNDE3MDlGRicsXG4gICAgICAgICAgICAgICAgICAnQXJuJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAnXFxcIn19fV0nLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcyhpYW0uQ2ZuUm9sZS5DRk5fUkVTT1VSQ0VfVFlQRV9OQU1FLCB7XG4gICAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBBY3Rpb246ICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsXG4gICAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgICAgUHJpbmNpcGFsOiB7XG4gICAgICAgICAgICAgICAgRmVkZXJhdGVkOiB7XG4gICAgICAgICAgICAgICAgICBSZWY6ICdDbHVzdGVyT3BlbklkQ29ubmVjdFByb3ZpZGVyRTdFQjA1MzAnLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIENvbmRpdGlvbjoge1xuICAgICAgICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgICAgICAgICAgICdNeVNlcnZpY2VBY2NvdW50Q29uZGl0aW9uSnNvbjFFRDNCQzU0JyxcbiAgICAgICAgICAgICAgICAgICAgJ1ZhbHVlJyxcbiAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2l0IGlzIHBvc3NpYmxlIHRvIGFkZCBhbm5vdGF0aW9ucyBhbmQgbGFiZWxzJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHsgc3RhY2ssIGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgZWtzLlNlcnZpY2VBY2NvdW50KHN0YWNrLCAnTXlTZXJ2aWNlQWNjb3VudCcsIHtcbiAgICAgICAgY2x1c3RlcixcbiAgICAgICAgYW5ub3RhdGlvbnM6IHtcbiAgICAgICAgICAnZWtzLmFtYXpvbmF3cy5jb20vc3RzLXJlZ2lvbmFsLWVuZHBvaW50cyc6ICdmYWxzZScsXG4gICAgICAgIH0sXG4gICAgICAgIGxhYmVsczoge1xuICAgICAgICAgICdzb21lLWxhYmVsJzogJ3dpdGgtc29tZS12YWx1ZScsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoZWtzLkt1YmVybmV0ZXNNYW5pZmVzdC5SRVNPVVJDRV9UWVBFLCB7XG4gICAgICAgIFNlcnZpY2VUb2tlbjoge1xuICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgJ2F3c2Nka2F3c2Vrc0t1YmVjdGxQcm92aWRlck5lc3RlZFN0YWNrYXdzY2RrYXdzZWtzS3ViZWN0bFByb3ZpZGVyTmVzdGVkU3RhY2tSZXNvdXJjZUE3QUVCQTZCJyxcbiAgICAgICAgICAgICdPdXRwdXRzLlN0YWNrYXdzY2RrYXdzZWtzS3ViZWN0bFByb3ZpZGVyZnJhbWV3b3Jrb25FdmVudDg4OTdGRDlCQXJuJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBNYW5pZmVzdDoge1xuICAgICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAnW3tcXFwiYXBpVmVyc2lvblxcXCI6XFxcInYxXFxcIixcXFwia2luZFxcXCI6XFxcIlNlcnZpY2VBY2NvdW50XFxcIixcXFwibWV0YWRhdGFcXFwiOntcXFwibmFtZVxcXCI6XFxcInN0YWNrbXlzZXJ2aWNlYWNjb3VudDU4Yjk1MjllXFxcIixcXFwibmFtZXNwYWNlXFxcIjpcXFwiZGVmYXVsdFxcXCIsXFxcImxhYmVsc1xcXCI6e1xcXCJhcHAua3ViZXJuZXRlcy5pby9uYW1lXFxcIjpcXFwic3RhY2tteXNlcnZpY2VhY2NvdW50NThiOTUyOWVcXFwiLFxcXCJzb21lLWxhYmVsXFxcIjpcXFwid2l0aC1zb21lLXZhbHVlXFxcIn0sXFxcImFubm90YXRpb25zXFxcIjp7XFxcImVrcy5hbWF6b25hd3MuY29tL3JvbGUtYXJuXFxcIjpcXFwiJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgJ015U2VydmljZUFjY291bnRSb2xlQjQxNzA5RkYnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgJ1xcXCIsXFxcImVrcy5hbWF6b25hd3MuY29tL3N0cy1yZWdpb25hbC1lbmRwb2ludHNcXFwiOlxcXCJmYWxzZVxcXCJ9fX1dJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoaWFtLkNmblJvbGUuQ0ZOX1JFU09VUkNFX1RZUEVfTkFNRSwge1xuICAgICAgICBBc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLFxuICAgICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgICAgIEZlZGVyYXRlZDoge1xuICAgICAgICAgICAgICAgICAgUmVmOiAnQ2x1c3Rlck9wZW5JZENvbm5lY3RQcm92aWRlckU3RUIwNTMwJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgICAnTXlTZXJ2aWNlQWNjb3VudENvbmRpdGlvbkpzb24xRUQzQkM1NCcsXG4gICAgICAgICAgICAgICAgICAgICdWYWx1ZScsXG4gICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIF0sXG4gICAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdzaG91bGQgaGF2ZSBhbGxvdyBtdWx0aXBsZSBzZXJ2aWNlcyBhY2NvdW50cycsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IHN0YWNrLCBjbHVzdGVyIH0gPSB0ZXN0Rml4dHVyZUNsdXN0ZXIoKTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnTXlTZXJ2aWNlQWNjb3VudCcpO1xuICAgICAgY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnTXlPdGhlclNlcnZpY2VBY2NvdW50Jyk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKGVrcy5LdWJlcm5ldGVzTWFuaWZlc3QuUkVTT1VSQ0VfVFlQRSwge1xuICAgICAgICBTZXJ2aWNlVG9rZW46IHtcbiAgICAgICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgICAgICdhd3NjZGthd3Nla3NLdWJlY3RsUHJvdmlkZXJOZXN0ZWRTdGFja2F3c2Nka2F3c2Vrc0t1YmVjdGxQcm92aWRlck5lc3RlZFN0YWNrUmVzb3VyY2VBN0FFQkE2QicsXG4gICAgICAgICAgICAnT3V0cHV0cy5TdGFja2F3c2Nka2F3c2Vrc0t1YmVjdGxQcm92aWRlcmZyYW1ld29ya29uRXZlbnQ4ODk3RkQ5QkFybicsXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgTWFuaWZlc3Q6IHtcbiAgICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgJ1t7XFxcImFwaVZlcnNpb25cXFwiOlxcXCJ2MVxcXCIsXFxcImtpbmRcXFwiOlxcXCJTZXJ2aWNlQWNjb3VudFxcXCIsXFxcIm1ldGFkYXRhXFxcIjp7XFxcIm5hbWVcXFwiOlxcXCJzdGFja2NsdXN0ZXJteW90aGVyc2VydmljZWFjY291bnRhNDcyNzYxYVxcXCIsXFxcIm5hbWVzcGFjZVxcXCI6XFxcImRlZmF1bHRcXFwiLFxcXCJsYWJlbHNcXFwiOntcXFwiYXBwLmt1YmVybmV0ZXMuaW8vbmFtZVxcXCI6XFxcInN0YWNrY2x1c3Rlcm15b3RoZXJzZXJ2aWNlYWNjb3VudGE0NzI3NjFhXFxcIn0sXFxcImFubm90YXRpb25zXFxcIjp7XFxcImVrcy5hbWF6b25hd3MuY29tL3JvbGUtYXJuXFxcIjpcXFwiJyxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgJ0NsdXN0ZXJNeU90aGVyU2VydmljZUFjY291bnRSb2xlNzY0NTgzQzUnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgJ1xcXCJ9fX1dJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGhhdmUgdW5pcXVlIHJlc291cmNlIG5hbWUnLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgeyBjbHVzdGVyIH0gPSB0ZXN0Rml4dHVyZUNsdXN0ZXIoKTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnTXlTZXJ2aWNlQWNjb3VudCcpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QoKCkgPT4gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnTXlTZXJ2aWNlQWNjb3VudCcpKS50b1Rocm93KCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdhZGRTZXJ2aWNlQWNjb3VudCBmb3IgaW1wb3J0ZWQgY2x1c3RlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHsgc3RhY2sgfSA9IHRlc3RGaXh0dXJlKCk7XG4gICAgICBjb25zdCBvaWRjUHJvdmlkZXIgPSBuZXcgaWFtLk9wZW5JZENvbm5lY3RQcm92aWRlcihzdGFjaywgJ0NsdXN0ZXJPcGVuSWRDb25uZWN0UHJvdmlkZXInLCB7XG4gICAgICAgIHVybDogJ29pZGNfaXNzdWVyJyxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgY2x1c3RlciA9IGVrcy5DbHVzdGVyLmZyb21DbHVzdGVyQXR0cmlidXRlcyhzdGFjaywgJ0NsdXN0ZXInLCB7XG4gICAgICAgIGNsdXN0ZXJOYW1lOiAnQ2x1c3RlcicsXG4gICAgICAgIG9wZW5JZENvbm5lY3RQcm92aWRlcjogb2lkY1Byb3ZpZGVyLFxuICAgICAgICBrdWJlY3RsUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY6cm9sZS9zZXJ2aWNlLXJvbGUvazhzc2VydmljZXJvbGUnLFxuICAgICAgfSk7XG5cbiAgICAgIGNsdXN0ZXIuYWRkU2VydmljZUFjY291bnQoJ015U2VydmljZUFjY291bnQnKTtcblxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoZWtzLkt1YmVybmV0ZXNNYW5pZmVzdC5SRVNPVVJDRV9UWVBFLCB7XG4gICAgICAgIFNlcnZpY2VUb2tlbjoge1xuICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgJ1N0YWNrQ2x1c3RlckYwRUIwMkZBS3ViZWN0bFByb3ZpZGVyTmVzdGVkU3RhY2tTdGFja0NsdXN0ZXJGMEVCMDJGQUt1YmVjdGxQcm92aWRlck5lc3RlZFN0YWNrUmVzb3VyY2U3MzlEMTJDNCcsXG4gICAgICAgICAgICAnT3V0cHV0cy5TdGFja1N0YWNrQ2x1c3RlckYwRUIwMkZBS3ViZWN0bFByb3ZpZGVyZnJhbWV3b3Jrb25FdmVudDgzNzdGMDc2QXJuJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBQcnVuZUxhYmVsOiAnYXdzLmNkay5la3MvcHJ1bmUtYzhkOGUxNzIyYTRmM2VkMzMyZjhhYzc0Y2IzZDk2MmYwMWZiYjYyMjkxJyxcbiAgICAgICAgTWFuaWZlc3Q6IHtcbiAgICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgJ1t7XCJhcGlWZXJzaW9uXCI6XCJ2MVwiLFwia2luZFwiOlwiU2VydmljZUFjY291bnRcIixcIm1ldGFkYXRhXCI6e1wibmFtZVwiOlwic3RhY2tjbHVzdGVybXlzZXJ2aWNlYWNjb3VudDM3M2I5MzNjXCIsXCJuYW1lc3BhY2VcIjpcImRlZmF1bHRcIixcImxhYmVsc1wiOntcImF3cy5jZGsuZWtzL3BydW5lLWM4ZDhlMTcyMmE0ZjNlZDMzMmY4YWM3NGNiM2Q5NjJmMDFmYmI2MjI5MVwiOlwiXCIsXCJhcHAua3ViZXJuZXRlcy5pby9uYW1lXCI6XCJzdGFja2NsdXN0ZXJteXNlcnZpY2VhY2NvdW50MzczYjkzM2NcIn0sXCJhbm5vdGF0aW9uc1wiOntcImVrcy5hbWF6b25hd3MuY29tL3JvbGUtYXJuXCI6XCInLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgICAgICAgICAnQ2x1c3Rlck15U2VydmljZUFjY291bnRSb2xlODUzMzdCMjknLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgJ1wifX19XScsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoaWFtLkNmblJvbGUuQ0ZOX1JFU09VUkNFX1RZUEVfTkFNRSwge1xuICAgICAgICBBc3N1bWVSb2xlUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLFxuICAgICAgICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgICAnQ2x1c3Rlck15U2VydmljZUFjY291bnRDb25kaXRpb25Kc29uNjcxQzA2MzMnLFxuICAgICAgICAgICAgICAgICAgICAnVmFsdWUnLFxuICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgICAgIEZlZGVyYXRlZDoge1xuICAgICAgICAgICAgICAgICAgUmVmOiAnQ2x1c3Rlck9wZW5JZENvbm5lY3RQcm92aWRlckE4QjhFOTg3JyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2VydmljZSBBY2NvdW50IG5hbWUgbXVzdCBmb2xsb3cgS3ViZXJuZXRlcyBzcGVjJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Rocm93IGVycm9yIG9uIGNhcGl0YWwgbGV0dGVycycsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBleHBlY3QoKCkgPT4gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnSW52YWxpZFNlcnZpY2VBY2NvdW50Jywge1xuICAgICAgICBuYW1lOiAnWFhYJyxcbiAgICAgIH0pKVxuICAgICAgLy8gVEhFTlxuICAgICAgICAudG9UaHJvd0Vycm9yKFJhbmdlRXJyb3IpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndGhyb3cgZXJyb3IgaWYgZW5kcyB3aXRoIGRvdCcsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBleHBlY3QoKCkgPT4gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnSW52YWxpZFNlcnZpY2VBY2NvdW50Jywge1xuICAgICAgICBuYW1lOiAndGVzdC4nLFxuICAgICAgfSkpXG4gICAgICAvLyBUSEVOXG4gICAgICAgIC50b1Rocm93RXJyb3IoUmFuZ2VFcnJvcik7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkb3QgaW4gdGhlIG5hbWUgaXMgYWxsb3dlZCcsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuICAgICAgY29uc3QgdmFsdWVXaXRoRG90ID0gJ3Rlc3QubmFtZSc7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHNhID0gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnSW52YWxpZFNlcnZpY2VBY2NvdW50Jywge1xuICAgICAgICBuYW1lOiB2YWx1ZVdpdGhEb3QsXG4gICAgICB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHNhLnNlcnZpY2VBY2NvdW50TmFtZSkudG9FcXVhbCh2YWx1ZVdpdGhEb3QpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndGhyb3cgZXJyb3IgaWYgbmFtZSBpcyB0b28gbG9uZycsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBleHBlY3QoKCkgPT4gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnSW52YWxpZFNlcnZpY2VBY2NvdW50Jywge1xuICAgICAgICBuYW1lOiAneCcucmVwZWF0KDI1NSksXG4gICAgICB9KSlcbiAgICAgIC8vIFRIRU5cbiAgICAgICAgLnRvVGhyb3dFcnJvcihSYW5nZUVycm9yKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1NlcnZpY2UgQWNjb3VudCBuYW1lc3BhY2UgbXVzdCBmb2xsb3cgS3ViZXJuZXRlcyBzcGVjJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Rocm93IGVycm9yIG9uIGNhcGl0YWwgbGV0dGVycycsICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCB7IGNsdXN0ZXIgfSA9IHRlc3RGaXh0dXJlQ2x1c3RlcigpO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBleHBlY3QoKCkgPT4gY2x1c3Rlci5hZGRTZXJ2aWNlQWNjb3VudCgnSW52YWxpZFNlcnZpY2VBY2NvdW50Jywge1xuICAgICAgICBuYW1lc3BhY2U6ICdYWFgnLFxuICAgICAgfSkpXG4gICAgICAvLyBUSEVOXG4gICAgICAgIC50b1Rocm93RXJyb3IoUmFuZ2VFcnJvcik7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCd0aHJvdyBlcnJvciBpZiBlbmRzIHdpdGggZG90JywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHsgY2x1c3RlciB9ID0gdGVzdEZpeHR1cmVDbHVzdGVyKCk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIGV4cGVjdCgoKSA9PiBjbHVzdGVyLmFkZFNlcnZpY2VBY2NvdW50KCdJbnZhbGlkU2VydmljZUFjY291bnQnLCB7XG4gICAgICAgIG5hbWVzcGFjZTogJ3Rlc3QuJyxcbiAgICAgIH0pKVxuICAgICAgLy8gVEhFTlxuICAgICAgICAudG9UaHJvd0Vycm9yKFJhbmdlRXJyb3IpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndGhyb3cgZXJyb3IgaWYgZG90IGlzIGluIHRoZSBuYW1lJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IHsgY2x1c3RlciB9ID0gdGVzdEZpeHR1cmVDbHVzdGVyKCk7XG4gICAgICBjb25zdCB2YWx1ZVdpdGhEb3QgPSAndGVzdC5uYW1lJztcblxuICAgICAgLy8gV0hFTlxuICAgICAgZXhwZWN0KCgpID0+IGNsdXN0ZXIuYWRkU2VydmljZUFjY291bnQoJ0ludmFsaWRTZXJ2aWNlQWNjb3VudCcsIHtcbiAgICAgICAgbmFtZXNwYWNlOiB2YWx1ZVdpdGhEb3QsXG4gICAgICB9KSlcbiAgICAgIC8vIFRIRU5cbiAgICAgICAgLnRvVGhyb3dFcnJvcihSYW5nZUVycm9yKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Rocm93IGVycm9yIGlmIG5hbWUgaXMgdG9vIGxvbmcnLCAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgeyBjbHVzdGVyIH0gPSB0ZXN0Rml4dHVyZUNsdXN0ZXIoKTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgZXhwZWN0KCgpID0+IGNsdXN0ZXIuYWRkU2VydmljZUFjY291bnQoJ0ludmFsaWRTZXJ2aWNlQWNjb3VudCcsIHtcbiAgICAgICAgbmFtZXNwYWNlOiAneCcucmVwZWF0KDY1KSxcbiAgICAgIH0pKVxuICAgICAgLy8gVEhFTlxuICAgICAgICAudG9UaHJvd0Vycm9yKFJhbmdlRXJyb3IpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19