"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const cdk = require("../../core");
const iam = require("../lib");
// Test cross-account grant scenario's for principals
//
// When doing a grant on a resource with a resource policy:
//
// - Permissions are added to the identity if possible.
// - Trust is added to the resource if necessary (identity is in
//   a different account than the resource).
let app;
const stack1Account = '1234';
let stack1;
const stack2Account = '5678';
let stack2;
const thirdAccount = '123456789012';
beforeEach(() => {
    app = new cdk.App();
    stack1 = new cdk.Stack(app, 'Stack1', { env: { account: stack1Account, region: 'us-bla-5' } });
    stack2 = new cdk.Stack(app, 'Stack2', { env: { account: stack2Account, region: 'us-bla-5' } });
});
test('cross-account Role grant creates permissions AND trust', () => {
    // GIVEN
    const role = new iam.Role(stack1, 'Role', {
        roleName: cdk.PhysicalName.GENERATE_IF_NEEDED,
        assumedBy: new iam.ServicePrincipal('some.service'),
    });
    const resource = new FakeResource(stack2, 'Resource');
    // WHEN
    doGrant(resource, role);
    // THEN
    assertPolicyCreated(stack1);
    assertTrustCreated(stack2, {
        AWS: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    `:iam::${stack1Account}:role/stack1stack1rolef3c14260253562f428b7`,
                ]],
        },
    });
});
test('Service Principal grant creates trust', () => {
    const resource = new FakeResource(stack2, 'Resource');
    // WHEN
    doGrant(resource, new iam.ServicePrincipal('service.amazonaws.com'));
    // THEN
    assertTrustCreated(stack2, { Service: 'service.amazonaws.com' });
});
test('Imported Role with definitely different account grant creates trust', () => {
    const resource = new FakeResource(stack2, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:aws:iam::${thirdAccount}:role/S3Access`, { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    noPolicyCreated(stack2);
    assertTrustCreated(stack2, {
        AWS: `arn:aws:iam::${thirdAccount}:role/S3Access`,
    });
});
test('Imported Role with partition token in ARN (definitely different account) grant creates trust', () => {
    const resource = new FakeResource(stack2, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:${stack2.partition}:iam::${thirdAccount}:role/S3Access`, { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    noPolicyCreated(stack2);
    assertTrustCreated(stack2, {
        AWS: {
            'Fn::Join': ['', [
                    'arn:',
                    { Ref: 'AWS::Partition' },
                    `:iam::${thirdAccount}:role/S3Access`,
                ]],
        },
    });
});
test('Imported Role with definitely same account grant does not create trust', () => {
    const resource = new FakeResource(stack2, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:aws:iam::${stack2Account}:role/S3Access`, { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    assertPolicyCreated(stack2);
    noTrustCreated(stack2);
});
test('Imported Role with partition token and definitely same account grant does not create trust', () => {
    const resource = new FakeResource(stack2, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:${stack2.partition}:iam::5678:role/S3Access`, { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    assertPolicyCreated(stack2);
    noTrustCreated(stack2);
});
test('Agnostic stack with concrete imported role adds trust', () => {
    // GIVEN
    const stack = new cdk.Stack(app, 'AgStack');
    const resource = new FakeResource(stack, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', 'arn:aws:iam::5678:role/S3Access', { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    assertTrustCreated(stack, { AWS: 'arn:aws:iam::5678:role/S3Access' });
    noPolicyCreated(stack);
});
test('Agnostic stack with agnostic imported role does not add trust', () => {
    // GIVEN
    const stack = new cdk.Stack(app, 'AgStack');
    const resource = new FakeResource(stack, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:aws:iam::${cdk.Aws.ACCOUNT_ID}:role/S3Access`, { mutable: true });
    // WHEN
    doGrant(resource, role);
    // THEN
    assertPolicyCreated(stack2);
    noTrustCreated(stack);
});
test('Immutable role in same account adds no policy and no trust', () => {
    // GIVEN
    const resource = new FakeResource(stack2, 'Resource');
    const role = iam.Role.fromRoleArn(stack2, 'Role', `arn:aws:iam::${stack2Account}:role/S3Access`, { mutable: false });
    // require('util').inspect.defaultOptions.customInspect = false; // ?
    // WHEN
    doGrant(resource, role);
    // THEN
    noTrustCreated(stack2);
    noPolicyCreated(stack2);
});
class FakeResource extends cdk.Resource {
    constructor(scope, id) {
        super(scope, id);
        this.arn = 'arn:aws:resource';
        this.policy = new iam.PolicyDocument();
        new cdk.CfnResource(this, 'Default', {
            type: 'Test::Fake::Resource',
            properties: {
                ResourcePolicy: cdk.Lazy.any({ produce: () => this.policy }),
            },
        });
    }
    addToResourcePolicy(statement) {
        this.policy.addStatements(statement);
        return { statementAdded: true, policyDependable: this.policy };
    }
}
function doGrant(resource, principal) {
    iam.Grant.addToPrincipalOrResource({
        actions: ['some:action'],
        grantee: principal,
        resourceArns: [resource.arn],
        resource,
    });
}
function assertTrustCreated(stack, principal) {
    assertions_1.Template.fromStack(stack).hasResourceProperties('Test::Fake::Resource', {
        ResourcePolicy: {
            Statement: [
                {
                    Action: 'some:action',
                    Effect: 'Allow',
                    Resource: 'arn:aws:resource',
                    Principal: principal,
                },
            ],
            Version: '2012-10-17',
        },
    });
}
function noTrustCreated(stack) {
    expect(assertions_1.Template.fromStack(stack).findResources('Test::Fake::Resource', {
        ResourcePolicy: {
            Statement: [
                {},
            ],
        },
    })).toEqual({});
}
function assertPolicyCreated(stack) {
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [
                {
                    Action: 'some:action',
                    Effect: 'Allow',
                    Resource: 'arn:aws:resource',
                },
            ],
            Version: '2012-10-17',
        },
    });
}
function noPolicyCreated(stack) {
    assertions_1.Template.fromStack(stack).resourceCountIs('AWS::IAM::Policy', 0);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3MtYWNjb3VudC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3Jvc3MtYWNjb3VudC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQTRDO0FBQzVDLGtDQUFrQztBQUVsQyw4QkFBOEI7QUFFOUIscURBQXFEO0FBQ3JELEVBQUU7QUFDRiwyREFBMkQ7QUFDM0QsRUFBRTtBQUNGLHVEQUF1RDtBQUN2RCxnRUFBZ0U7QUFDaEUsNENBQTRDO0FBRTVDLElBQUksR0FBWSxDQUFDO0FBQ2pCLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQztBQUM3QixJQUFJLE1BQWlCLENBQUM7QUFDdEIsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBQzdCLElBQUksTUFBaUIsQ0FBQztBQUN0QixNQUFNLFlBQVksR0FBRyxjQUFjLENBQUM7QUFFcEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNwQixNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDL0YsTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ2pHLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHdEQUF3RCxFQUFFLEdBQUcsRUFBRTtJQUNsRSxRQUFRO0lBQ1IsTUFBTSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUU7UUFDeEMsUUFBUSxFQUFFLEdBQUcs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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGNvbnN0cnVjdHMgZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnLi4vbGliJztcblxuLy8gVGVzdCBjcm9zcy1hY2NvdW50IGdyYW50IHNjZW5hcmlvJ3MgZm9yIHByaW5jaXBhbHNcbi8vXG4vLyBXaGVuIGRvaW5nIGEgZ3JhbnQgb24gYSByZXNvdXJjZSB3aXRoIGEgcmVzb3VyY2UgcG9saWN5OlxuLy9cbi8vIC0gUGVybWlzc2lvbnMgYXJlIGFkZGVkIHRvIHRoZSBpZGVudGl0eSBpZiBwb3NzaWJsZS5cbi8vIC0gVHJ1c3QgaXMgYWRkZWQgdG8gdGhlIHJlc291cmNlIGlmIG5lY2Vzc2FyeSAoaWRlbnRpdHkgaXMgaW5cbi8vICAgYSBkaWZmZXJlbnQgYWNjb3VudCB0aGFuIHRoZSByZXNvdXJjZSkuXG5cbmxldCBhcHA6IGNkay5BcHA7XG5jb25zdCBzdGFjazFBY2NvdW50ID0gJzEyMzQnO1xubGV0IHN0YWNrMTogY2RrLlN0YWNrO1xuY29uc3Qgc3RhY2syQWNjb3VudCA9ICc1Njc4JztcbmxldCBzdGFjazI6IGNkay5TdGFjaztcbmNvbnN0IHRoaXJkQWNjb3VudCA9ICcxMjM0NTY3ODkwMTInO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgYXBwID0gbmV3IGNkay5BcHAoKTtcbiAgc3RhY2sxID0gbmV3IGNkay5TdGFjayhhcHAsICdTdGFjazEnLCB7IGVudjogeyBhY2NvdW50OiBzdGFjazFBY2NvdW50LCByZWdpb246ICd1cy1ibGEtNScgfSB9KTtcbiAgc3RhY2syID0gbmV3IGNkay5TdGFjayhhcHAsICdTdGFjazInLCB7IGVudjogeyBhY2NvdW50OiBzdGFjazJBY2NvdW50LCByZWdpb246ICd1cy1ibGEtNScgfSB9KTtcbn0pO1xuXG50ZXN0KCdjcm9zcy1hY2NvdW50IFJvbGUgZ3JhbnQgY3JlYXRlcyBwZXJtaXNzaW9ucyBBTkQgdHJ1c3QnLCAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUoc3RhY2sxLCAnUm9sZScsIHtcbiAgICByb2xlTmFtZTogY2RrLlBoeXNpY2FsTmFtZS5HRU5FUkFURV9JRl9ORUVERUQsXG4gICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ3NvbWUuc2VydmljZScpLFxuICB9KTtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlJyk7XG5cbiAgLy8gV0hFTlxuICBkb0dyYW50KHJlc291cmNlLCByb2xlKTtcblxuICAvLyBUSEVOXG4gIGFzc2VydFBvbGljeUNyZWF0ZWQoc3RhY2sxKTtcbiAgYXNzZXJ0VHJ1c3RDcmVhdGVkKHN0YWNrMiwge1xuICAgIEFXUzoge1xuICAgICAgJ0ZuOjpKb2luJzogWycnLCBbXG4gICAgICAgICdhcm46JyxcbiAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgYDppYW06OiR7c3RhY2sxQWNjb3VudH06cm9sZS9zdGFjazFzdGFjazFyb2xlZjNjMTQyNjAyNTM1NjJmNDI4YjdgLFxuICAgICAgXV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnU2VydmljZSBQcmluY2lwYWwgZ3JhbnQgY3JlYXRlcyB0cnVzdCcsICgpID0+IHtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlJyk7XG5cbiAgLy8gV0hFTlxuICBkb0dyYW50KHJlc291cmNlLCBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ3NlcnZpY2UuYW1hem9uYXdzLmNvbScpKTtcblxuICAvLyBUSEVOXG4gIGFzc2VydFRydXN0Q3JlYXRlZChzdGFjazIsIHsgU2VydmljZTogJ3NlcnZpY2UuYW1hem9uYXdzLmNvbScgfSk7XG59KTtcblxudGVzdCgnSW1wb3J0ZWQgUm9sZSB3aXRoIGRlZmluaXRlbHkgZGlmZmVyZW50IGFjY291bnQgZ3JhbnQgY3JlYXRlcyB0cnVzdCcsICgpID0+IHtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlJyk7XG4gIGNvbnN0IHJvbGUgPSBpYW0uUm9sZS5mcm9tUm9sZUFybihzdGFjazIsICdSb2xlJywgYGFybjphd3M6aWFtOjoke3RoaXJkQWNjb3VudH06cm9sZS9TM0FjY2Vzc2AsIHsgbXV0YWJsZTogdHJ1ZSB9KTtcblxuICAvLyBXSEVOXG4gIGRvR3JhbnQocmVzb3VyY2UsIHJvbGUpO1xuXG4gIC8vIFRIRU5cbiAgbm9Qb2xpY3lDcmVhdGVkKHN0YWNrMik7XG4gIGFzc2VydFRydXN0Q3JlYXRlZChzdGFjazIsIHtcbiAgICBBV1M6IGBhcm46YXdzOmlhbTo6JHt0aGlyZEFjY291bnR9OnJvbGUvUzNBY2Nlc3NgLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdJbXBvcnRlZCBSb2xlIHdpdGggcGFydGl0aW9uIHRva2VuIGluIEFSTiAoZGVmaW5pdGVseSBkaWZmZXJlbnQgYWNjb3VudCkgZ3JhbnQgY3JlYXRlcyB0cnVzdCcsICgpID0+IHtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlJyk7XG4gIGNvbnN0IHJvbGUgPSBpYW0uUm9sZS5mcm9tUm9sZUFybihzdGFjazIsICdSb2xlJywgYGFybjoke3N0YWNrMi5wYXJ0aXRpb259OmlhbTo6JHt0aGlyZEFjY291bnR9OnJvbGUvUzNBY2Nlc3NgLCB7IG11dGFibGU6IHRydWUgfSk7XG5cbiAgLy8gV0hFTlxuICBkb0dyYW50KHJlc291cmNlLCByb2xlKTtcblxuICAvLyBUSEVOXG4gIG5vUG9saWN5Q3JlYXRlZChzdGFjazIpO1xuICBhc3NlcnRUcnVzdENyZWF0ZWQoc3RhY2syLCB7XG4gICAgQVdTOiB7XG4gICAgICAnRm46OkpvaW4nOiBbJycsIFtcbiAgICAgICAgJ2FybjonLFxuICAgICAgICB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LFxuICAgICAgICBgOmlhbTo6JHt0aGlyZEFjY291bnR9OnJvbGUvUzNBY2Nlc3NgLFxuICAgICAgXV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnSW1wb3J0ZWQgUm9sZSB3aXRoIGRlZmluaXRlbHkgc2FtZSBhY2NvdW50IGdyYW50IGRvZXMgbm90IGNyZWF0ZSB0cnVzdCcsICgpID0+IHtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrMiwgJ1Jlc291cmNlJyk7XG4gIGNvbnN0IHJvbGUgPSBpYW0uUm9sZS5mcm9tUm9sZUFybihzdGFjazIsICdSb2xlJywgYGFybjphd3M6aWFtOjoke3N0YWNrMkFjY291bnR9OnJvbGUvUzNBY2Nlc3NgLCB7IG11dGFibGU6IHRydWUgfSk7XG5cbiAgLy8gV0hFTlxuICBkb0dyYW50KHJlc291cmNlLCByb2xlKTtcblxuICAvLyBUSEVOXG4gIGFzc2VydFBvbGljeUNyZWF0ZWQoc3RhY2syKTtcbiAgbm9UcnVzdENyZWF0ZWQoc3RhY2syKTtcbn0pO1xuXG50ZXN0KCdJbXBvcnRlZCBSb2xlIHdpdGggcGFydGl0aW9uIHRva2VuIGFuZCBkZWZpbml0ZWx5IHNhbWUgYWNjb3VudCBncmFudCBkb2VzIG5vdCBjcmVhdGUgdHJ1c3QnLCAoKSA9PiB7XG4gIGNvbnN0IHJlc291cmNlID0gbmV3IEZha2VSZXNvdXJjZShzdGFjazIsICdSZXNvdXJjZScpO1xuICBjb25zdCByb2xlID0gaWFtLlJvbGUuZnJvbVJvbGVBcm4oc3RhY2syLCAnUm9sZScsIGBhcm46JHtzdGFjazIucGFydGl0aW9ufTppYW06OjU2Nzg6cm9sZS9TM0FjY2Vzc2AsIHsgbXV0YWJsZTogdHJ1ZSB9KTtcblxuICAvLyBXSEVOXG4gIGRvR3JhbnQocmVzb3VyY2UsIHJvbGUpO1xuXG4gIC8vIFRIRU5cbiAgYXNzZXJ0UG9saWN5Q3JlYXRlZChzdGFjazIpO1xuICBub1RydXN0Q3JlYXRlZChzdGFjazIpO1xufSk7XG5cbnRlc3QoJ0Fnbm9zdGljIHN0YWNrIHdpdGggY29uY3JldGUgaW1wb3J0ZWQgcm9sZSBhZGRzIHRydXN0JywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soYXBwLCAnQWdTdGFjaycpO1xuICBjb25zdCByZXNvdXJjZSA9IG5ldyBGYWtlUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZScpO1xuICBjb25zdCByb2xlID0gaWFtLlJvbGUuZnJvbVJvbGVBcm4oc3RhY2syLCAnUm9sZScsICdhcm46YXdzOmlhbTo6NTY3ODpyb2xlL1MzQWNjZXNzJywgeyBtdXRhYmxlOiB0cnVlIH0pO1xuXG4gIC8vIFdIRU5cbiAgZG9HcmFudChyZXNvdXJjZSwgcm9sZSk7XG5cbiAgLy8gVEhFTlxuICBhc3NlcnRUcnVzdENyZWF0ZWQoc3RhY2ssIHsgQVdTOiAnYXJuOmF3czppYW06OjU2Nzg6cm9sZS9TM0FjY2VzcycgfSk7XG4gIG5vUG9saWN5Q3JlYXRlZChzdGFjayk7XG59KTtcblxudGVzdCgnQWdub3N0aWMgc3RhY2sgd2l0aCBhZ25vc3RpYyBpbXBvcnRlZCByb2xlIGRvZXMgbm90IGFkZCB0cnVzdCcsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ0FnU3RhY2snKTtcbiAgY29uc3QgcmVzb3VyY2UgPSBuZXcgRmFrZVJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UnKTtcbiAgY29uc3Qgcm9sZSA9IGlhbS5Sb2xlLmZyb21Sb2xlQXJuKHN0YWNrMiwgJ1JvbGUnLCBgYXJuOmF3czppYW06OiR7Y2RrLkF3cy5BQ0NPVU5UX0lEfTpyb2xlL1MzQWNjZXNzYCwgeyBtdXRhYmxlOiB0cnVlIH0pO1xuXG4gIC8vIFdIRU5cbiAgZG9HcmFudChyZXNvdXJjZSwgcm9sZSk7XG5cbiAgLy8gVEhFTlxuICBhc3NlcnRQb2xpY3lDcmVhdGVkKHN0YWNrMik7XG4gIG5vVHJ1c3RDcmVhdGVkKHN0YWNrKTtcbn0pO1xuXG50ZXN0KCdJbW11dGFibGUgcm9sZSBpbiBzYW1lIGFjY291bnQgYWRkcyBubyBwb2xpY3kgYW5kIG5vIHRydXN0JywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCByZXNvdXJjZSA9IG5ldyBGYWtlUmVzb3VyY2Uoc3RhY2syLCAnUmVzb3VyY2UnKTtcbiAgY29uc3Qgcm9sZSA9IGlhbS5Sb2xlLmZyb21Sb2xlQXJuKHN0YWNrMiwgJ1JvbGUnLCBgYXJuOmF3czppYW06OiR7c3RhY2syQWNjb3VudH06cm9sZS9TM0FjY2Vzc2AsIHsgbXV0YWJsZTogZmFsc2UgfSk7XG5cbiAgLy8gcmVxdWlyZSgndXRpbCcpLmluc3BlY3QuZGVmYXVsdE9wdGlvbnMuY3VzdG9tSW5zcGVjdCA9IGZhbHNlOyAvLyA/XG5cbiAgLy8gV0hFTlxuICBkb0dyYW50KHJlc291cmNlLCByb2xlKTtcblxuICAvLyBUSEVOXG4gIG5vVHJ1c3RDcmVhdGVkKHN0YWNrMik7XG4gIG5vUG9saWN5Q3JlYXRlZChzdGFjazIpO1xuXG59KTtcblxuY2xhc3MgRmFrZVJlc291cmNlIGV4dGVuZHMgY2RrLlJlc291cmNlIGltcGxlbWVudHMgaWFtLklSZXNvdXJjZVdpdGhQb2xpY3kge1xuICBwdWJsaWMgcmVhZG9ubHkgYXJuID0gJ2Fybjphd3M6cmVzb3VyY2UnO1xuICBwcml2YXRlIHJlYWRvbmx5IHBvbGljeSA9IG5ldyBpYW0uUG9saWN5RG9jdW1lbnQoKTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY29uc3RydWN0cy5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgbmV3IGNkay5DZm5SZXNvdXJjZSh0aGlzLCAnRGVmYXVsdCcsIHtcbiAgICAgIHR5cGU6ICdUZXN0OjpGYWtlOjpSZXNvdXJjZScsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIFJlc291cmNlUG9saWN5OiBjZGsuTGF6eS5hbnkoeyBwcm9kdWNlOiAoKSA9PiB0aGlzLnBvbGljeSB9KSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYWRkVG9SZXNvdXJjZVBvbGljeShzdGF0ZW1lbnQ6IGlhbS5Qb2xpY3lTdGF0ZW1lbnQpOiBpYW0uQWRkVG9SZXNvdXJjZVBvbGljeVJlc3VsdCB7XG4gICAgdGhpcy5wb2xpY3kuYWRkU3RhdGVtZW50cyhzdGF0ZW1lbnQpO1xuICAgIHJldHVybiB7IHN0YXRlbWVudEFkZGVkOiB0cnVlLCBwb2xpY3lEZXBlbmRhYmxlOiB0aGlzLnBvbGljeSB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIGRvR3JhbnQocmVzb3VyY2U6IEZha2VSZXNvdXJjZSwgcHJpbmNpcGFsOiBpYW0uSVByaW5jaXBhbCkge1xuICBpYW0uR3JhbnQuYWRkVG9QcmluY2lwYWxPclJlc291cmNlKHtcbiAgICBhY3Rpb25zOiBbJ3NvbWU6YWN0aW9uJ10sXG4gICAgZ3JhbnRlZTogcHJpbmNpcGFsLFxuICAgIHJlc291cmNlQXJuczogW3Jlc291cmNlLmFybl0sXG4gICAgcmVzb3VyY2UsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBhc3NlcnRUcnVzdENyZWF0ZWQoc3RhY2s6IGNkay5TdGFjaywgcHJpbmNpcGFsOiBhbnkpIHtcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ1Rlc3Q6OkZha2U6OlJlc291cmNlJywge1xuICAgIFJlc291cmNlUG9saWN5OiB7XG4gICAgICBTdGF0ZW1lbnQ6IFtcbiAgICAgICAge1xuICAgICAgICAgIEFjdGlvbjogJ3NvbWU6YWN0aW9uJyxcbiAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgUmVzb3VyY2U6ICdhcm46YXdzOnJlc291cmNlJyxcbiAgICAgICAgICBQcmluY2lwYWw6IHByaW5jaXBhbCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgfSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG5vVHJ1c3RDcmVhdGVkKHN0YWNrOiBjZGsuU3RhY2spIHtcbiAgZXhwZWN0KFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuZmluZFJlc291cmNlcygnVGVzdDo6RmFrZTo6UmVzb3VyY2UnLCB7XG4gICAgUmVzb3VyY2VQb2xpY3k6IHtcbiAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICB7fSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSkpLnRvRXF1YWwoe30pO1xufVxuXG5mdW5jdGlvbiBhc3NlcnRQb2xpY3lDcmVhdGVkKHN0YWNrOiBjZGsuU3RhY2spIHtcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICB7XG4gICAgICAgICAgQWN0aW9uOiAnc29tZTphY3Rpb24nLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZTogJ2Fybjphd3M6cmVzb3VyY2UnLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICB9LFxuICB9KTtcbn1cblxuZnVuY3Rpb24gbm9Qb2xpY3lDcmVhdGVkKHN0YWNrOiBjZGsuU3RhY2spIHtcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5yZXNvdXJjZUNvdW50SXMoJ0FXUzo6SUFNOjpQb2xpY3knLCAwKTtcbn1cbiJdfQ==