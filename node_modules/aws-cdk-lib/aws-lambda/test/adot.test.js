"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const s3 = require("../../aws-s3");
const cdk = require("../../core");
const lambda = require("../lib");
describe('ADOT Lambda Layer', () => {
    describe('when the stack region is specified and supported', () => {
        let fn;
        beforeEach(() => {
            const app = new cdk.App();
            const stack = new cdk.Stack(app, 'stack', { env: { region: 'us-west-2' } });
            const bucket = new s3.Bucket(stack, 'CodeBucket');
            fn = new lambda.Function(stack, 'Function', {
                code: lambda.Code.fromBucket(bucket, 'mock_key'),
                handler: 'index.handler',
                runtime: lambda.Runtime.JAVA_11,
            });
        });
        test('is added properly when the region information is available at synthesis time', () => {
            const layerArn = lambda.AdotLambdaLayerJavaSdkVersion.V1_19_0.layerArn(fn.stack, fn.architecture);
            expect(layerArn).toEqual('arn:aws:lambda:us-west-2:901920570463:layer:aws-otel-java-wrapper-amd64-ver-1-19-0:1');
        });
        test('is added properly when using "LATEST" version', () => {
            const layerArn = lambda.AdotLambdaLayerJavaSdkVersion.LATEST.layerArn(fn.stack, fn.architecture);
            expect(layerArn).toEqual('arn:aws:lambda:us-west-2:901920570463:layer:aws-otel-java-wrapper-amd64-ver-1-19-0:1');
        });
    });
    describe('when the stack region is not supported', () => {
        test('throws error if the region is not supported', () => {
            const app = new cdk.App();
            const stack = new cdk.Stack(app, 'stack', { env: { region: 'neverland' } });
            const bucket = new s3.Bucket(stack, 'CodeBucket');
            const fn = new lambda.Function(stack, 'Function', {
                code: lambda.Code.fromBucket(bucket, 'mock_key'),
                handler: 'index.handler',
                runtime: lambda.Runtime.JAVA_11,
            });
            expect(() => {
                lambda.AdotLayerVersion.fromJavaSdkLayerVersion(lambda.AdotLambdaLayerJavaSdkVersion.LATEST)._bind(fn).arn;
            }).toThrow(/Could not find the ARN information for the ADOT Lambda Layer/);
        });
    });
    describe('when the stack is region agnostic', () => {
        test('is added properly', () => {
            const app = new cdk.App();
            const stack = new cdk.Stack(app, 'region-agnostic-stack');
            const fn = new lambda.Function(stack, 'Function', {
                code: new lambda.InlineCode('FooBar'),
                handler: 'index.handler',
                runtime: lambda.Runtime.NODEJS_14_X,
                architecture: lambda.Architecture.ARM_64,
            });
            const layerArn = lambda.AdotLambdaLayerJavaSdkVersion.LATEST.layerArn(stack, fn.architecture);
            fn.stack.exportValue(layerArn, {
                name: 'LayerArn',
            });
            // THEN
            assertions_1.Template.fromStack(fn.stack).hasOutput('ExportLayerArn', {
                Value: {
                    'Fn::FindInMap': [
                        'AdotlambdalayerMap',
                        {
                            Ref: 'AWS::Region',
                        },
                        'JAVAxSDKx1x19x0xarm64',
                    ],
                },
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRvdC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWRvdC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQTRDO0FBQzVDLG1DQUFtQztBQUNuQyxrQ0FBa0M7QUFDbEMsaUNBQWlDO0FBRWpDLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFFakMsUUFBUSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtRQUVoRSxJQUFJLEVBQW1CLENBQUM7UUFFeEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzFCLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM1RSxNQUFNLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2xELEVBQUUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRTtnQkFDMUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUM7Z0JBQ2hELE9BQU8sRUFBRSxlQUFlO2dCQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPO2FBQ2hDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLDhFQUE4RSxFQUFFLEdBQUcsRUFBRTtZQUN4RixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsNkJBQTZCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUVsRyxN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Q0wsZUFBZSxFQUFFO3dCQUNmLG9CQUFvQjt3QkFDcEI7NEJBQ0UsR0FBRyxFQUFFLGFBQWE7eUJBQ25CO3dCQUNELHVCQUF1QjtxQkFDeEI7aUJBQ0Y7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnLi4vLi4vYXdzLXMzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi9saWInO1xuXG5kZXNjcmliZSgnQURPVCBMYW1iZGEgTGF5ZXInLCAoKSA9PiB7XG5cbiAgZGVzY3JpYmUoJ3doZW4gdGhlIHN0YWNrIHJlZ2lvbiBpcyBzcGVjaWZpZWQgYW5kIHN1cHBvcnRlZCcsICgpID0+IHtcblxuICAgIGxldCBmbjogbGFtYmRhLkZ1bmN0aW9uO1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKGFwcCwgJ3N0YWNrJywgeyBlbnY6IHsgcmVnaW9uOiAndXMtd2VzdC0yJyB9IH0pO1xuICAgICAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0NvZGVCdWNrZXQnKTtcbiAgICAgIGZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ0Z1bmN0aW9uJywge1xuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQnVja2V0KGJ1Y2tldCwgJ21vY2tfa2V5JyksXG4gICAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuSkFWQV8xMSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnaXMgYWRkZWQgcHJvcGVybHkgd2hlbiB0aGUgcmVnaW9uIGluZm9ybWF0aW9uIGlzIGF2YWlsYWJsZSBhdCBzeW50aGVzaXMgdGltZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGxheWVyQXJuID0gbGFtYmRhLkFkb3RMYW1iZGFMYXllckphdmFTZGtWZXJzaW9uLlYxXzE5XzAubGF5ZXJBcm4oZm4uc3RhY2ssIGZuLmFyY2hpdGVjdHVyZSk7XG5cbiAgICAgIGV4cGVjdChsYXllckFybikudG9FcXVhbChcbiAgICAgICAgJ2Fybjphd3M6bGFtYmRhOnVzLXdlc3QtMjo5MDE5MjA1NzA0NjM6bGF5ZXI6YXdzLW90ZWwtamF2YS13cmFwcGVyLWFtZDY0LXZlci0xLTE5LTA6MScsXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnaXMgYWRkZWQgcHJvcGVybHkgd2hlbiB1c2luZyBcIkxBVEVTVFwiIHZlcnNpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBsYXllckFybiA9IGxhbWJkYS5BZG90TGFtYmRhTGF5ZXJKYXZhU2RrVmVyc2lvbi5MQVRFU1QubGF5ZXJBcm4oZm4uc3RhY2ssIGZuLmFyY2hpdGVjdHVyZSk7XG5cbiAgICAgIGV4cGVjdChsYXllckFybikudG9FcXVhbChcbiAgICAgICAgJ2Fybjphd3M6bGFtYmRhOnVzLXdlc3QtMjo5MDE5MjA1NzA0NjM6bGF5ZXI6YXdzLW90ZWwtamF2YS13cmFwcGVyLWFtZDY0LXZlci0xLTE5LTA6MScsXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnd2hlbiB0aGUgc3RhY2sgcmVnaW9uIGlzIG5vdCBzdXBwb3J0ZWQnLCAoKSA9PiB7XG4gICAgdGVzdCgndGhyb3dzIGVycm9yIGlmIHRoZSByZWdpb24gaXMgbm90IHN1cHBvcnRlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soYXBwLCAnc3RhY2snLCB7IGVudjogeyByZWdpb246ICduZXZlcmxhbmQnIH0gfSk7XG4gICAgICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQ29kZUJ1Y2tldCcpO1xuICAgICAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnRnVuY3Rpb24nLCB7XG4gICAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21CdWNrZXQoYnVja2V0LCAnbW9ja19rZXknKSxcbiAgICAgICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5KQVZBXzExLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgIGxhbWJkYS5BZG90TGF5ZXJWZXJzaW9uLmZyb21KYXZhU2RrTGF5ZXJWZXJzaW9uKFxuICAgICAgICAgIGxhbWJkYS5BZG90TGFtYmRhTGF5ZXJKYXZhU2RrVmVyc2lvbi5MQVRFU1QsXG4gICAgICAgICkuX2JpbmQoZm4pLmFybjtcbiAgICAgIH0pLnRvVGhyb3coL0NvdWxkIG5vdCBmaW5kIHRoZSBBUk4gaW5mb3JtYXRpb24gZm9yIHRoZSBBRE9UIExhbWJkYSBMYXllci8pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnd2hlbiB0aGUgc3RhY2sgaXMgcmVnaW9uIGFnbm9zdGljJywgKCkgPT4ge1xuICAgIHRlc3QoJ2lzIGFkZGVkIHByb3Blcmx5JywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsICdyZWdpb24tYWdub3N0aWMtc3RhY2snKTtcbiAgICAgIGNvbnN0IGZuID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ0Z1bmN0aW9uJywge1xuICAgICAgICBjb2RlOiBuZXcgbGFtYmRhLklubGluZUNvZGUoJ0Zvb0JhcicpLFxuICAgICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuQVJNXzY0LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGxheWVyQXJuID0gbGFtYmRhLkFkb3RMYW1iZGFMYXllckphdmFTZGtWZXJzaW9uLkxBVEVTVC5sYXllckFybihzdGFjaywgZm4uYXJjaGl0ZWN0dXJlKTtcbiAgICAgIGZuLnN0YWNrLmV4cG9ydFZhbHVlKGxheWVyQXJuLCB7XG4gICAgICAgIG5hbWU6ICdMYXllckFybicsXG4gICAgICB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKGZuLnN0YWNrKS5oYXNPdXRwdXQoJ0V4cG9ydExheWVyQXJuJywge1xuICAgICAgICBWYWx1ZToge1xuICAgICAgICAgICdGbjo6RmluZEluTWFwJzogW1xuICAgICAgICAgICAgJ0Fkb3RsYW1iZGFsYXllck1hcCcsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFJlZjogJ0FXUzo6UmVnaW9uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnSkFWQXhTREt4MXgxOXgweGFybTY0JyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=