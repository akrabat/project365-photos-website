"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const core_1 = require("../../core");
const lib_1 = require("../lib");
const util_1 = require("../lib/private/util");
describe('database secret', () => {
    test('create a database secret', () => {
        // GIVEN
        const stack = new core_1.Stack();
        // WHEN
        const dbSecret = new lib_1.DatabaseSecret(stack, 'Secret', {
            username: 'admin-username',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SecretsManager::Secret', {
            Description: {
                'Fn::Join': [
                    '',
                    [
                        'Generated by the CDK for stack: ',
                        {
                            Ref: 'AWS::StackName',
                        },
                    ],
                ],
            },
            GenerateSecretString: {
                ExcludeCharacters: util_1.DEFAULT_PASSWORD_EXCLUDE_CHARS,
                GenerateStringKey: 'password',
                PasswordLength: 30,
                SecretStringTemplate: '{"username":"admin-username"}',
            },
        });
        expect(getSecretLogicalId(dbSecret, stack)).toEqual('SecretA720EF05');
    });
    test('create a database secret with a database name and secret name', () => {
        // GIVEN
        const stack = new core_1.Stack();
        // WHEN
        const customDbSecret = new lib_1.DatabaseSecret(stack, 'Secret', {
            username: 'admin-username',
            dbname: 'admindb',
            secretName: 'admin-secret',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SecretsManager::Secret', {
            Description: {
                'Fn::Join': [
                    '',
                    [
                        'Generated by the CDK for stack: ',
                        {
                            Ref: 'AWS::StackName',
                        },
                    ],
                ],
            },
            Name: 'admin-secret',
            GenerateSecretString: {
                ExcludeCharacters: util_1.DEFAULT_PASSWORD_EXCLUDE_CHARS,
                GenerateStringKey: 'password',
                PasswordLength: 30,
                SecretStringTemplate: '{"username":"admin-username","dbname":"admindb"}',
            },
        });
        expect(getSecretLogicalId(customDbSecret, stack)).toEqual('SecretA720EF05');
    });
    test('with master secret', () => {
        // GIVEN
        const stack = new core_1.Stack();
        const masterSecret = new lib_1.DatabaseSecret(stack, 'MasterSecret', {
            username: 'master-username',
        });
        // WHEN
        new lib_1.DatabaseSecret(stack, 'UserSecret', {
            username: 'user-username',
            masterSecret,
            excludeCharacters: '"@/\\',
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SecretsManager::Secret', {
            GenerateSecretString: {
                ExcludeCharacters: '"@/\\',
                GenerateStringKey: 'password',
                PasswordLength: 30,
                SecretStringTemplate: {
                    'Fn::Join': [
                        '',
                        [
                            '{"username":"user-username","masterarn":"',
                            {
                                Ref: 'MasterSecretA11BF785',
                            },
                            '"}',
                        ],
                    ],
                },
            },
        });
    });
    test('replace on password critera change', () => {
        // GIVEN
        const stack = new core_1.Stack();
        // WHEN
        const dbSecret = new lib_1.DatabaseSecret(stack, 'Secret', {
            username: 'admin',
            replaceOnPasswordCriteriaChanges: true,
        });
        // THEN
        const dbSecretlogicalId = getSecretLogicalId(dbSecret, stack);
        expect(dbSecretlogicalId).toEqual('Secret3fdaad7efa858a3daf9490cf0a702aeb');
        // same node path but other excluded characters
        stack.node.tryRemoveChild('Secret');
        const otherSecret1 = new lib_1.DatabaseSecret(stack, 'Secret', {
            username: 'admin',
            replaceOnPasswordCriteriaChanges: true,
            excludeCharacters: '@!()[]',
        });
        expect(dbSecretlogicalId).not.toEqual(getSecretLogicalId(otherSecret1, stack));
        // other node path but same excluded characters
        const otherSecret2 = new lib_1.DatabaseSecret(stack, 'Secret2', {
            username: 'admin',
            replaceOnPasswordCriteriaChanges: true,
        });
        expect(dbSecretlogicalId).not.toEqual(getSecretLogicalId(otherSecret2, stack));
    });
});
function getSecretLogicalId(dbSecret, stack) {
    const cfnSecret = dbSecret.node.defaultChild;
    return stack.resolve(cfnSecret.logicalId);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2Utc2VjcmV0LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYXRhYmFzZS1zZWNyZXQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUE0QztBQUM1QyxxQ0FBZ0Q7QUFDaEQsZ0NBQXdDO0FBQ3hDLDhDQUFxRTtBQUVyRSxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7UUFDcEMsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7UUFFMUIsT0FBTztRQUNQLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQWMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO1lBQ25ELFFBQVEsRUFBRSxnQkFBZ0I7U0FDM0IsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLDZCQUE2QixFQUFFO1lBQzdFLFdBQVcsRUFBRTtnQkFDWCxVQUFVLEVBQUU7b0JBQ1YsRUFBRTtvQkFDRjt3QkFDRSxrQ0FBa0M7d0JBQ2xDOzRCQUNFLEdBQUcsRUFBRSxnQkFBZ0I7eUJBQ3RCO3FCQUNGO2lCQUNGO2FBQ0Y7WUFDRCxvQkFBb0IsRUFBRTtnQkFDcEIsaUJBQWlCLEVBQUUscUNBQThCO2dCQUNqRCxpQkFBaUIsRUFBRSxVQUFVO2dCQUM3QixjQUFjLEVBQUUsRUFBRTtnQkFDbEIsb0JBQW9CLEVBQUUsK0JBQStCO2FBQ3REO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ3hFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLCtEQUErRCxFQUFFLEdBQUcsRUFBRTtRQUN6RSxRQUFRO1FBQ1IsTUFBTSxL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UTtTQUM1QixDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRS9FLCtDQUErQztRQUMvQyxNQUFNLFlBQVksR0FBRyxJQUFJLG9CQUFjLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtZQUN4RCxRQUFRLEVBQUUsT0FBTztZQUNqQixnQ0FBZ0MsRUFBRSxJQUFJO1NBQ3ZDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDakYsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFNBQVMsa0JBQWtCLENBQUMsUUFBd0IsRUFBRSxLQUFZO0lBQ2hFLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsWUFBMkIsQ0FBQztJQUM1RCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzVDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgQ2ZuUmVzb3VyY2UsIFN0YWNrIH0gZnJvbSAnLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBEYXRhYmFzZVNlY3JldCB9IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBERUZBVUxUX1BBU1NXT1JEX0VYQ0xVREVfQ0hBUlMgfSBmcm9tICcuLi9saWIvcHJpdmF0ZS91dGlsJztcblxuZGVzY3JpYmUoJ2RhdGFiYXNlIHNlY3JldCcsICgpID0+IHtcbiAgdGVzdCgnY3JlYXRlIGEgZGF0YWJhc2Ugc2VjcmV0JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBkYlNlY3JldCA9IG5ldyBEYXRhYmFzZVNlY3JldChzdGFjaywgJ1NlY3JldCcsIHtcbiAgICAgIHVzZXJuYW1lOiAnYWRtaW4tdXNlcm5hbWUnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNlY3JldHNNYW5hZ2VyOjpTZWNyZXQnLCB7XG4gICAgICBEZXNjcmlwdGlvbjoge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ0dlbmVyYXRlZCBieSB0aGUgQ0RLIGZvciBzdGFjazogJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpTdGFja05hbWUnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEdlbmVyYXRlU2VjcmV0U3RyaW5nOiB7XG4gICAgICAgIEV4Y2x1ZGVDaGFyYWN0ZXJzOiBERUZBVUxUX1BBU1NXT1JEX0VYQ0xVREVfQ0hBUlMsXG4gICAgICAgIEdlbmVyYXRlU3RyaW5nS2V5OiAncGFzc3dvcmQnLFxuICAgICAgICBQYXNzd29yZExlbmd0aDogMzAsXG4gICAgICAgIFNlY3JldFN0cmluZ1RlbXBsYXRlOiAne1widXNlcm5hbWVcIjpcImFkbWluLXVzZXJuYW1lXCJ9JyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBleHBlY3QoZ2V0U2VjcmV0TG9naWNhbElkKGRiU2VjcmV0LCBzdGFjaykpLnRvRXF1YWwoJ1NlY3JldEE3MjBFRjA1Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NyZWF0ZSBhIGRhdGFiYXNlIHNlY3JldCB3aXRoIGEgZGF0YWJhc2UgbmFtZSBhbmQgc2VjcmV0IG5hbWUnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IGN1c3RvbURiU2VjcmV0ID0gbmV3IERhdGFiYXNlU2VjcmV0KHN0YWNrLCAnU2VjcmV0Jywge1xuICAgICAgdXNlcm5hbWU6ICdhZG1pbi11c2VybmFtZScsXG4gICAgICBkYm5hbWU6ICdhZG1pbmRiJyxcbiAgICAgIHNlY3JldE5hbWU6ICdhZG1pbi1zZWNyZXQnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNlY3JldHNNYW5hZ2VyOjpTZWNyZXQnLCB7XG4gICAgICBEZXNjcmlwdGlvbjoge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ0dlbmVyYXRlZCBieSB0aGUgQ0RLIGZvciBzdGFjazogJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpTdGFja05hbWUnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIE5hbWU6ICdhZG1pbi1zZWNyZXQnLFxuICAgICAgR2VuZXJhdGVTZWNyZXRTdHJpbmc6IHtcbiAgICAgICAgRXhjbHVkZUNoYXJhY3RlcnM6IERFRkFVTFRfUEFTU1dPUkRfRVhDTFVERV9DSEFSUyxcbiAgICAgICAgR2VuZXJhdGVTdHJpbmdLZXk6ICdwYXNzd29yZCcsXG4gICAgICAgIFBhc3N3b3JkTGVuZ3RoOiAzMCxcbiAgICAgICAgU2VjcmV0U3RyaW5nVGVtcGxhdGU6ICd7XCJ1c2VybmFtZVwiOlwiYWRtaW4tdXNlcm5hbWVcIixcImRibmFtZVwiOlwiYWRtaW5kYlwifScsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgZXhwZWN0KGdldFNlY3JldExvZ2ljYWxJZChjdXN0b21EYlNlY3JldCwgc3RhY2spKS50b0VxdWFsKCdTZWNyZXRBNzIwRUYwNScpO1xuICB9KTtcblxuICB0ZXN0KCd3aXRoIG1hc3RlciBzZWNyZXQnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgIGNvbnN0IG1hc3RlclNlY3JldCA9IG5ldyBEYXRhYmFzZVNlY3JldChzdGFjaywgJ01hc3RlclNlY3JldCcsIHtcbiAgICAgIHVzZXJuYW1lOiAnbWFzdGVyLXVzZXJuYW1lJyxcbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBuZXcgRGF0YWJhc2VTZWNyZXQoc3RhY2ssICdVc2VyU2VjcmV0Jywge1xuICAgICAgdXNlcm5hbWU6ICd1c2VyLXVzZXJuYW1lJyxcbiAgICAgIG1hc3RlclNlY3JldCxcbiAgICAgIGV4Y2x1ZGVDaGFyYWN0ZXJzOiAnXCJAL1xcXFwnLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNlY3JldHNNYW5hZ2VyOjpTZWNyZXQnLCB7XG4gICAgICBHZW5lcmF0ZVNlY3JldFN0cmluZzoge1xuICAgICAgICBFeGNsdWRlQ2hhcmFjdGVyczogJ1wiQC9cXFxcJyxcbiAgICAgICAgR2VuZXJhdGVTdHJpbmdLZXk6ICdwYXNzd29yZCcsXG4gICAgICAgIFBhc3N3b3JkTGVuZ3RoOiAzMCxcbiAgICAgICAgU2VjcmV0U3RyaW5nVGVtcGxhdGU6IHtcbiAgICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgICAnJyxcbiAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgJ3tcInVzZXJuYW1lXCI6XCJ1c2VyLXVzZXJuYW1lXCIsXCJtYXN0ZXJhcm5cIjpcIicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBSZWY6ICdNYXN0ZXJTZWNyZXRBMTFCRjc4NScsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICdcIn0nLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgncmVwbGFjZSBvbiBwYXNzd29yZCBjcml0ZXJhIGNoYW5nZScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgZGJTZWNyZXQgPSBuZXcgRGF0YWJhc2VTZWNyZXQoc3RhY2ssICdTZWNyZXQnLCB7XG4gICAgICB1c2VybmFtZTogJ2FkbWluJyxcbiAgICAgIHJlcGxhY2VPblBhc3N3b3JkQ3JpdGVyaWFDaGFuZ2VzOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IGRiU2VjcmV0bG9naWNhbElkID0gZ2V0U2VjcmV0TG9naWNhbElkKGRiU2VjcmV0LCBzdGFjayk7XG4gICAgZXhwZWN0KGRiU2VjcmV0bG9naWNhbElkKS50b0VxdWFsKCdTZWNyZXQzZmRhYWQ3ZWZhODU4YTNkYWY5NDkwY2YwYTcwMmFlYicpO1xuXG4gICAgLy8gc2FtZSBub2RlIHBhdGggYnV0IG90aGVyIGV4Y2x1ZGVkIGNoYXJhY3RlcnNcbiAgICBzdGFjay5ub2RlLnRyeVJlbW92ZUNoaWxkKCdTZWNyZXQnKTtcbiAgICBjb25zdCBvdGhlclNlY3JldDEgPSBuZXcgRGF0YWJhc2VTZWNyZXQoc3RhY2ssICdTZWNyZXQnLCB7XG4gICAgICB1c2VybmFtZTogJ2FkbWluJyxcbiAgICAgIHJlcGxhY2VPblBhc3N3b3JkQ3JpdGVyaWFDaGFuZ2VzOiB0cnVlLFxuICAgICAgZXhjbHVkZUNoYXJhY3RlcnM6ICdAISgpW10nLFxuICAgIH0pO1xuICAgIGV4cGVjdChkYlNlY3JldGxvZ2ljYWxJZCkubm90LnRvRXF1YWwoZ2V0U2VjcmV0TG9naWNhbElkKG90aGVyU2VjcmV0MSwgc3RhY2spKTtcblxuICAgIC8vIG90aGVyIG5vZGUgcGF0aCBidXQgc2FtZSBleGNsdWRlZCBjaGFyYWN0ZXJzXG4gICAgY29uc3Qgb3RoZXJTZWNyZXQyID0gbmV3IERhdGFiYXNlU2VjcmV0KHN0YWNrLCAnU2VjcmV0MicsIHtcbiAgICAgIHVzZXJuYW1lOiAnYWRtaW4nLFxuICAgICAgcmVwbGFjZU9uUGFzc3dvcmRDcml0ZXJpYUNoYW5nZXM6IHRydWUsXG4gICAgfSk7XG4gICAgZXhwZWN0KGRiU2VjcmV0bG9naWNhbElkKS5ub3QudG9FcXVhbChnZXRTZWNyZXRMb2dpY2FsSWQob3RoZXJTZWNyZXQyLCBzdGFjaykpO1xuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiBnZXRTZWNyZXRMb2dpY2FsSWQoZGJTZWNyZXQ6IERhdGFiYXNlU2VjcmV0LCBzdGFjazogU3RhY2spOiBzdHJpbmcge1xuICBjb25zdCBjZm5TZWNyZXQgPSBkYlNlY3JldC5ub2RlLmRlZmF1bHRDaGlsZCBhcyBDZm5SZXNvdXJjZTtcbiAgcmV0dXJuIHN0YWNrLnJlc29sdmUoY2ZuU2VjcmV0LmxvZ2ljYWxJZCk7XG59XG4iXX0=