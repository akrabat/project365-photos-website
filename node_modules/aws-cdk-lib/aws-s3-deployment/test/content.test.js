"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const lambda = require("../../aws-lambda");
const s3 = require("../../aws-s3");
const core_1 = require("../../core");
const lib_1 = require("../lib");
const render_data_1 = require("../lib/render-data");
test('simple string', () => {
    const stack = new core_1.Stack();
    expect((0, render_data_1.renderData)(stack, 'foo')).toStrictEqual({
        markers: {},
        text: 'foo',
    });
});
test('string with a "Ref" token', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    expect((0, render_data_1.renderData)(stack, `foo-${bucket.bucketName}`)).toStrictEqual({
        text: 'foo-<<marker:0xbaba:0>>',
        markers: { '<<marker:0xbaba:0>>': { Ref: 'Bucket83908E77' } },
    });
});
test('string is a single "Ref" token', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    expect((0, render_data_1.renderData)(stack, bucket.bucketName)).toStrictEqual({
        text: '<<marker:0xbaba:0>>',
        markers: { '<<marker:0xbaba:0>>': { Ref: 'Bucket83908E77' } },
    });
});
test('string is a single "Fn::GetAtt" token', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    expect((0, render_data_1.renderData)(stack, bucket.bucketRegionalDomainName)).toStrictEqual({
        text: '<<marker:0xbaba:0>>',
        markers: { '<<marker:0xbaba:0>>': { 'Fn::GetAtt': ['Bucket83908E77', 'RegionalDomainName'] } },
    });
});
test('string with a "Fn::GetAtt" token', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    expect((0, render_data_1.renderData)(stack, `foo-${bucket.bucketArn}`)).toStrictEqual({
        text: 'foo-<<marker:0xbaba:0>>',
        markers: { '<<marker:0xbaba:0>>': { 'Fn::GetAtt': ['Bucket83908E77', 'Arn'] } },
    });
});
test('multiple markers', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    expect((0, render_data_1.renderData)(stack, `boom-${bucket.bucketName}-bam-${bucket.bucketArn}`)).toStrictEqual({
        text: 'boom-<<marker:0xbaba:0>>-bam-<<marker:0xbaba:1>>',
        markers: {
            '<<marker:0xbaba:0>>': { Ref: 'Bucket83908E77' },
            '<<marker:0xbaba:1>>': { 'Fn::GetAtt': ['Bucket83908E77', 'Arn'] },
        },
    });
});
test('json-encoded string', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'Bucket');
    const json = {
        BucketArn: bucket.bucketArn,
        BucketName: bucket.bucketName,
    };
    expect((0, render_data_1.renderData)(stack, JSON.stringify(json))).toStrictEqual({
        text: JSON.stringify({ BucketArn: '<<marker:0xbaba:0>>', BucketName: '<<marker:0xbaba:1>>' }),
        markers: {
            '<<marker:0xbaba:0>>': { 'Fn::GetAtt': ['Bucket83908E77', 'Arn'] },
            '<<marker:0xbaba:1>>': { Ref: 'Bucket83908E77' },
        },
    });
});
test('markers are returned in the source config', () => {
    const stack = new core_1.Stack();
    const handler = new lambda.Function(stack, 'Handler', { runtime: lambda.Runtime.NODEJS_14_X, code: lambda.Code.fromInline('foo'), handler: 'index.handler' });
    const actual = lib_1.Source.data('file1.txt', `boom-${stack.account}`).bind(stack, { handlerRole: handler.role });
    expect(actual.markers).toStrictEqual({
        '<<marker:0xbaba:0>>': { Ref: 'AWS::AccountId' },
    });
});
test('lazy string which can be fully resolved', () => {
    const stack = new core_1.Stack();
    expect((0, render_data_1.renderData)(stack, core_1.Lazy.string({ produce: () => 'resolved!' }))).toStrictEqual({
        text: 'resolved!',
        markers: {},
    });
});
test('lazy within a string which can be fully resolved', () => {
    const stack = new core_1.Stack();
    const token = core_1.Lazy.string({ produce: () => 'resolved!' });
    expect((0, render_data_1.renderData)(stack, `hello, ${token}`)).toStrictEqual({
        text: 'hello, resolved!',
        markers: {},
    });
});
test('lazy string which resolves to something with a deploy-time value', () => {
    const stack = new core_1.Stack();
    const token = core_1.Lazy.string({ produce: () => 'resolved!' });
    expect((0, render_data_1.renderData)(stack, `hello, ${token}`)).toStrictEqual({
        text: 'hello, resolved!',
        markers: {},
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29udGVudC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTJDO0FBQzNDLG1DQUFtQztBQUNuQyxxQ0FBeUM7QUFDekMsZ0NBQWdDO0FBQ2hDLG9EQUFnRDtBQUVoRCxJQUFJLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUN6QixNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO0lBQzFCLE1BQU0sQ0FBQyxJQUFBLHdCQUFVLEVBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO1FBQzdDLE9BQU8sRUFBRSxFQUFFO1FBQ1gsSUFBSSxFQUFFLEtBQUs7S0FDWixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7SUFDckMsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRTlDLE1BQU0sQ0FBQyxJQUFBLHdCQUFVLEVBQUMsS0FBSyxFQUFFLE9BQU8sTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7UUFDbEUsSUFBSSxFQUFFLHlCQUF5QjtRQUMvQixPQUFPLEVBQUUsRUFBRSxxQkFBcUIsRUFBRSxFQUFFLEdBQUcsRUFBRSxnQkFBZ0IsRUFBRSxFQUFFO0tBQzlELENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtJQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO0lBQzFCLE1BQU0sTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsUUFB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QUUsV0FBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7UUFDbkYsSUFBSSxFQUFFLFdBQVc7UUFDakIsT0FBTyxFQUFFLEVBQUc7S0FDYixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7SUFDNUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUMxQixNQUFNLEtBQUssR0FBRyxXQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFFMUQsTUFBTSxDQUFDLElBQUEsd0JBQVUsRUFBQyxLQUFLLEVBQUUsVUFBVSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO1FBQ3pELElBQUksRUFBRSxrQkFBa0I7UUFDeEIsT0FBTyxFQUFFLEVBQUc7S0FDYixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxrRUFBa0UsRUFBRSxHQUFHLEVBQUU7SUFDNUUsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUMxQixNQUFNLEtBQUssR0FBRyxXQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFFMUQsTUFBTSxDQUFDLElBQUEsd0JBQVUsRUFBQyxLQUFLLEVBQUUsVUFBVSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO1FBQ3pELElBQUksRUFBRSxrQkFBa0I7UUFDeEIsT0FBTyxFQUFFLEVBQUc7S0FDYixDQUFDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJy4uLy4uL2F3cy1zMyc7XG5pbXBvcnQgeyBMYXp5LCBTdGFjayB9IGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgU291cmNlIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IHJlbmRlckRhdGEgfSBmcm9tICcuLi9saWIvcmVuZGVyLWRhdGEnO1xuXG50ZXN0KCdzaW1wbGUgc3RyaW5nJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBleHBlY3QocmVuZGVyRGF0YShzdGFjaywgJ2ZvbycpKS50b1N0cmljdEVxdWFsKHtcbiAgICBtYXJrZXJzOiB7fSxcbiAgICB0ZXh0OiAnZm9vJyxcbiAgfSk7XG59KTtcblxudGVzdCgnc3RyaW5nIHdpdGggYSBcIlJlZlwiIHRva2VuJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQnVja2V0Jyk7XG5cbiAgZXhwZWN0KHJlbmRlckRhdGEoc3RhY2ssIGBmb28tJHtidWNrZXQuYnVja2V0TmFtZX1gKSkudG9TdHJpY3RFcXVhbCh7XG4gICAgdGV4dDogJ2Zvby08PG1hcmtlcjoweGJhYmE6MD4+JyxcbiAgICBtYXJrZXJzOiB7ICc8PG1hcmtlcjoweGJhYmE6MD4+JzogeyBSZWY6ICdCdWNrZXQ4MzkwOEU3NycgfSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdzdHJpbmcgaXMgYSBzaW5nbGUgXCJSZWZcIiB0b2tlbicsICgpID0+IHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldCcpO1xuXG4gIGV4cGVjdChyZW5kZXJEYXRhKHN0YWNrLCBidWNrZXQuYnVja2V0TmFtZSkpLnRvU3RyaWN0RXF1YWwoe1xuICAgIHRleHQ6ICc8PG1hcmtlcjoweGJhYmE6MD4+JyxcbiAgICBtYXJrZXJzOiB7ICc8PG1hcmtlcjoweGJhYmE6MD4+JzogeyBSZWY6ICdCdWNrZXQ4MzkwOEU3NycgfSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdzdHJpbmcgaXMgYSBzaW5nbGUgXCJGbjo6R2V0QXR0XCIgdG9rZW4nLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcblxuICBleHBlY3QocmVuZGVyRGF0YShzdGFjaywgYnVja2V0LmJ1Y2tldFJlZ2lvbmFsRG9tYWluTmFtZSkpLnRvU3RyaWN0RXF1YWwoe1xuICAgIHRleHQ6ICc8PG1hcmtlcjoweGJhYmE6MD4+JyxcbiAgICBtYXJrZXJzOiB7ICc8PG1hcmtlcjoweGJhYmE6MD4+JzogeyAnRm46OkdldEF0dCc6IFsnQnVja2V0ODM5MDhFNzcnLCAnUmVnaW9uYWxEb21haW5OYW1lJ10gfSB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdzdHJpbmcgd2l0aCBhIFwiRm46OkdldEF0dFwiIHRva2VuJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnQnVja2V0Jyk7XG5cbiAgZXhwZWN0KHJlbmRlckRhdGEoc3RhY2ssIGBmb28tJHtidWNrZXQuYnVja2V0QXJufWApKS50b1N0cmljdEVxdWFsKHtcbiAgICB0ZXh0OiAnZm9vLTw8bWFya2VyOjB4YmFiYTowPj4nLFxuICAgIG1hcmtlcnM6IHsgJzw8bWFya2VyOjB4YmFiYTowPj4nOiB7ICdGbjo6R2V0QXR0JzogWydCdWNrZXQ4MzkwOEU3NycsICdBcm4nXSB9IH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ211bHRpcGxlIG1hcmtlcnMnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcblxuICBleHBlY3QocmVuZGVyRGF0YShzdGFjaywgYGJvb20tJHtidWNrZXQuYnVja2V0TmFtZX0tYmFtLSR7YnVja2V0LmJ1Y2tldEFybn1gKSkudG9TdHJpY3RFcXVhbCh7XG4gICAgdGV4dDogJ2Jvb20tPDxtYXJrZXI6MHhiYWJhOjA+Pi1iYW0tPDxtYXJrZXI6MHhiYWJhOjE+PicsXG4gICAgbWFya2Vyczoge1xuICAgICAgJzw8bWFya2VyOjB4YmFiYTowPj4nOiB7IFJlZjogJ0J1Y2tldDgzOTA4RTc3JyB9LFxuICAgICAgJzw8bWFya2VyOjB4YmFiYToxPj4nOiB7ICdGbjo6R2V0QXR0JzogWydCdWNrZXQ4MzkwOEU3NycsICdBcm4nXSB9LFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2pzb24tZW5jb2RlZCBzdHJpbmcnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdCdWNrZXQnKTtcbiAgY29uc3QganNvbiA9IHtcbiAgICBCdWNrZXRBcm46IGJ1Y2tldC5idWNrZXRBcm4sXG4gICAgQnVja2V0TmFtZTogYnVja2V0LmJ1Y2tldE5hbWUsXG4gIH07XG5cbiAgZXhwZWN0KHJlbmRlckRhdGEoc3RhY2ssIEpTT04uc3RyaW5naWZ5KGpzb24pKSkudG9TdHJpY3RFcXVhbCh7XG4gICAgdGV4dDogSlNPTi5zdHJpbmdpZnkoeyBCdWNrZXRBcm46ICc8PG1hcmtlcjoweGJhYmE6MD4+JywgQnVja2V0TmFtZTogJzw8bWFya2VyOjB4YmFiYToxPj4nIH0pLFxuICAgIG1hcmtlcnM6IHtcbiAgICAgICc8PG1hcmtlcjoweGJhYmE6MD4+JzogeyAnRm46OkdldEF0dCc6IFsnQnVja2V0ODM5MDhFNzcnLCAnQXJuJ10gfSxcbiAgICAgICc8PG1hcmtlcjoweGJhYmE6MT4+JzogeyBSZWY6ICdCdWNrZXQ4MzkwOEU3NycgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdtYXJrZXJzIGFyZSByZXR1cm5lZCBpbiB0aGUgc291cmNlIGNvbmZpZycsICgpID0+IHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgaGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdIYW5kbGVyJywgeyBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCwgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZm9vJyksIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyB9KTtcbiAgY29uc3QgYWN0dWFsID0gU291cmNlLmRhdGEoJ2ZpbGUxLnR4dCcsIGBib29tLSR7c3RhY2suYWNjb3VudH1gKS5iaW5kKHN0YWNrLCB7IGhhbmRsZXJSb2xlOiBoYW5kbGVyLnJvbGUhIH0pO1xuICBleHBlY3QoYWN0dWFsLm1hcmtlcnMpLnRvU3RyaWN0RXF1YWwoe1xuICAgICc8PG1hcmtlcjoweGJhYmE6MD4+JzogeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnbGF6eSBzdHJpbmcgd2hpY2ggY2FuIGJlIGZ1bGx5IHJlc29sdmVkJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIGV4cGVjdChyZW5kZXJEYXRhKHN0YWNrLCBMYXp5LnN0cmluZyh7IHByb2R1Y2U6ICgpID0+ICdyZXNvbHZlZCEnIH0pKSkudG9TdHJpY3RFcXVhbCh7XG4gICAgdGV4dDogJ3Jlc29sdmVkIScsXG4gICAgbWFya2VyczogeyB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdsYXp5IHdpdGhpbiBhIHN0cmluZyB3aGljaCBjYW4gYmUgZnVsbHkgcmVzb2x2ZWQnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IHRva2VuID0gTGF6eS5zdHJpbmcoeyBwcm9kdWNlOiAoKSA9PiAncmVzb2x2ZWQhJyB9KTtcblxuICBleHBlY3QocmVuZGVyRGF0YShzdGFjaywgYGhlbGxvLCAke3Rva2VufWApKS50b1N0cmljdEVxdWFsKHtcbiAgICB0ZXh0OiAnaGVsbG8sIHJlc29sdmVkIScsXG4gICAgbWFya2VyczogeyB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdsYXp5IHN0cmluZyB3aGljaCByZXNvbHZlcyB0byBzb21ldGhpbmcgd2l0aCBhIGRlcGxveS10aW1lIHZhbHVlJywgKCkgPT4ge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjb25zdCB0b2tlbiA9IExhenkuc3RyaW5nKHsgcHJvZHVjZTogKCkgPT4gJ3Jlc29sdmVkIScgfSk7XG5cbiAgZXhwZWN0KHJlbmRlckRhdGEoc3RhY2ssIGBoZWxsbywgJHt0b2tlbn1gKSkudG9TdHJpY3RFcXVhbCh7XG4gICAgdGV4dDogJ2hlbGxvLCByZXNvbHZlZCEnLFxuICAgIG1hcmtlcnM6IHsgfSxcbiAgfSk7XG5cbn0pOyJdfQ==