"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const lambda = require("../../../aws-lambda");
const s3 = require("../../../aws-s3");
const core_1 = require("../../../core");
const s3n = require("../../lib");
test('add notifications to multiple functions', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'MyBucket');
    const fn1 = new lambda.Function(stack, 'MyFunction1', {
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: 'index.handler',
        code: lambda.Code.fromInline('foo'),
    });
    const fn2 = new lambda.Function(stack, 'MyFunction2', {
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: 'index.handler',
        code: lambda.Code.fromInline('foo'),
    });
    const lambdaDestination1 = new s3n.LambdaDestination(fn1);
    const lambdaDestination2 = new s3n.LambdaDestination(fn2);
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED, lambdaDestination1, { prefix: 'v1/' });
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED, lambdaDestination2, { prefix: 'v2/' });
    // expecting notification configuration to have both events
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::S3BucketNotifications', {
        NotificationConfiguration: assertions_1.Match.objectLike({
            LambdaFunctionConfigurations: [
                assertions_1.Match.objectLike({ Filter: { Key: { FilterRules: [{ Name: 'prefix', Value: 'v1/' }] } } }),
                assertions_1.Match.objectLike({ Filter: { Key: { FilterRules: [{ Name: 'prefix', Value: 'v2/' }] } } }),
            ],
        }),
    });
    // expecting one permission for each function
    assertions_1.Template.fromStack(stack).resourceCountIs('AWS::Lambda::Permission', 2);
    // make sure each permission points to the correct function
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Permission', {
        FunctionName: {
            'Fn::GetAtt': [
                'MyFunction12A744C2E',
                'Arn',
            ],
        },
        SourceArn: {
            'Fn::GetAtt': [
                'MyBucketF68F3FF0',
                'Arn',
            ],
        },
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Permission', {
        FunctionName: {
            'Fn::GetAtt': [
                'MyFunction2F2A964CA',
                'Arn',
            ],
        },
        SourceArn: {
            'Fn::GetAtt': [
                'MyBucketF68F3FF0',
                'Arn',
            ],
        },
    });
});
test('lambda in a different stack as notification target', () => {
    const app = new core_1.App();
    const lambdaStack = new core_1.Stack(app, 'stack1');
    const bucketStack = new core_1.Stack(app, 'stack2');
    const lambdaFunction = new lambda.Function(lambdaStack, 'lambdaFunction', {
        code: lambda.Code.fromInline('whatever'),
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
    });
    const bucket = new s3.Bucket(bucketStack, 'bucket');
    bucket.addObjectCreatedNotification(new s3n.LambdaDestination(lambdaFunction));
    // permission should be in the bucket stack
    assertions_1.Template.fromStack(bucketStack).hasResourceProperties('AWS::Lambda::Permission', {
        FunctionName: {
            'Fn::ImportValue': 'stack1:ExportsOutputFnGetAttlambdaFunction940E68ADArn6B2878AF',
        },
        SourceArn: {
            'Fn::GetAtt': [
                'bucket43879C71',
                'Arn',
            ],
        },
    });
});
test('imported lambda in a different account as notification target', () => {
    const app = new core_1.App();
    const stack = new core_1.Stack(app, 'stack', {
        env: { account: '111111111111' },
    });
    // Lambda account and stack account differ; no permissions should be created.
    const lambdaFunction = lambda.Function.fromFunctionArn(stack, 'lambdaFunction', 'arn:aws:lambda:us-east-1:123456789012:function:BaseFunction');
    const bucket = new s3.Bucket(stack, 'bucket');
    bucket.addObjectCreatedNotification(new s3n.LambdaDestination(lambdaFunction));
    // no permissions created
    assertions_1.Template.fromStack(stack).resourceCountIs('AWS::Lambda::Permission', 0);
});
test('lambda as notification target', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const bucketA = new s3.Bucket(stack, 'MyBucket');
    const fn = new lambda.Function(stack, 'MyFunction', {
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: 'index.handler',
        code: lambda.Code.fromInline('foo'),
    });
    // WHEN
    bucketA.addObjectCreatedNotification(new s3n.LambdaDestination(fn), { suffix: '.png' });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Permission', {
        Action: 'lambda:InvokeFunction',
        FunctionName: { 'Fn::GetAtt': ['MyFunction3BAA72D1', 'Arn'] },
        Principal: 's3.amazonaws.com',
        SourceAccount: { Ref: 'AWS::AccountId' },
        SourceArn: { 'Fn::GetAtt': ['MyBucketF68F3FF0', 'Arn'] },
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::S3BucketNotifications', {
        NotificationConfiguration: {
            LambdaFunctionConfigurations: [
                {
                    Events: ['s3:ObjectCreated:*'],
                    Filter: {
                        Key: {
                            FilterRules: [{ Name: 'suffix', Value: '.png' }],
                        },
                    },
                    LambdaFunctionArn: { 'Fn::GetAtt': ['MyFunction3BAA72D1', 'Arn'] },
                },
            ],
        },
    });
});
test('lambda as notification target specified by function arn', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const bucketA = new s3.Bucket(stack, 'MyBucket');
    const fn = lambda.Function.fromFunctionArn(stack, 'MyFunction', 'arn:aws:lambda:us-east-1:123456789012:function:ProcessKinesisRecords');
    // WHEN
    bucketA.addObjectCreatedNotification(new s3n.LambdaDestination(fn), { suffix: '.png' });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::S3BucketNotifications', {
        NotificationConfiguration: {
            LambdaFunctionConfigurations: [
                {
                    Events: ['s3:ObjectCreated:*'],
                    Filter: {
                        Key: {
                            FilterRules: [{ Name: 'suffix', Value: '.png' }],
                        },
                    },
                    LambdaFunctionArn: 'arn:aws:lambda:us-east-1:123456789012:function:ProcessKinesisRecords',
                },
            ],
        },
    });
});
test('permissions are added as a dependency to the notifications resource when using singleton function', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'MyBucket');
    const fn = new lambda.SingletonFunction(stack, 'MyFunction', {
        uuid: 'uuid',
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: 'index.handler',
        code: lambda.Code.fromInline('foo'),
    });
    const lambdaDestination = new s3n.LambdaDestination(fn);
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED, lambdaDestination, { prefix: 'v1/' });
    assertions_1.Template.fromStack(stack).hasResource('Custom::S3BucketNotifications', {
        DependsOn: ['MyBucketAllowBucketNotificationsToSingletonLambdauuid28C96883'],
    });
});
test('add multiple event notifications using a singleton function', () => {
    const stack = new core_1.Stack();
    const bucket = new s3.Bucket(stack, 'MyBucket');
    const fn = new lambda.SingletonFunction(stack, 'MyFunction', {
        uuid: 'uuid',
        runtime: lambda.Runtime.NODEJS_14_X,
        handler: 'index.handler',
        code: lambda.Code.fromInline('foo'),
    });
    const lambdaDestination = new s3n.LambdaDestination(fn);
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED, lambdaDestination, { prefix: 'v1/' });
    bucket.addEventNotification(s3.EventType.OBJECT_CREATED, lambdaDestination, { prefix: 'v2/' });
    assertions_1.Template.fromStack(stack).hasResourceProperties('Custom::S3BucketNotifications', {
        NotificationConfiguration: assertions_1.Match.objectLike({
            LambdaFunctionConfigurations: [
                assertions_1.Match.objectLike({ Filter: { Key: { FilterRules: [{ Name: 'prefix', Value: 'v1/' }] } } }),
                assertions_1.Match.objectLike({ Filter: { Key: { FilterRules: [{ Name: 'prefix', Value: 'v2/' }] } } }),
            ],
        }),
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsYW1iZGEudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRDtBQUN0RCw4Q0FBOEM7QUFDOUMsc0NBQXNDO0FBQ3RDLHdDQUEyQztBQUMzQyxpQ0FBaUM7QUFFakMsSUFBSSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtJQUVuRCxNQUFNLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO0lBQzFCLE1BQU0sTUFBTSxHQUFHLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxhQUFhLEVBQUU7UUFDcEQsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztRQUNuQyxPQUFPLEVBQUUsZUFBZTtRQUN4QixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO0tBQ3BDLENBQUMsQ0FBQztJQUVILE1BQU0sR0FBRyxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsYUFBYSxFQUFFO1FBQ3BELE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7UUFDbkMsT0FBTyxFQUFFLGVBQWU7UUFDeEIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztLQUNwQyxDQUFDLENBQUM7SUFFSCxNQUFNLGtCQUFrQixHQUFHLElBQUksR0FBRyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxHQUFHLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFMUQsTUFBTSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsY0FB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SUFFSCxNQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRXhELE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBRS9GLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLCtCQUErQixFQUFFO1FBQy9FLHlCQUF5QixFQUFFLGtCQUFLLENBQUMsVUFBVSxDQUFDO1lBQzFDLDRCQUE0QixFQUFFO2dCQUM1QixrQkFBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztnQkFDMUYsa0JBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7YUFDM0Y7U0FDRixDQUFDO0tBQ0gsQ0FBQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJy4uLy4uLy4uL2F3cy1zMyc7XG5pbXBvcnQgeyBTdGFjaywgQXBwIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgKiBhcyBzM24gZnJvbSAnLi4vLi4vbGliJztcblxudGVzdCgnYWRkIG5vdGlmaWNhdGlvbnMgdG8gbXVsdGlwbGUgZnVuY3Rpb25zJywgKCkgPT4ge1xuXG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdNeUJ1Y2tldCcpO1xuICBjb25zdCBmbjEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnTXlGdW5jdGlvbjEnLCB7XG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2ZvbycpLFxuICB9KTtcblxuICBjb25zdCBmbjIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnTXlGdW5jdGlvbjInLCB7XG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2ZvbycpLFxuICB9KTtcblxuICBjb25zdCBsYW1iZGFEZXN0aW5hdGlvbjEgPSBuZXcgczNuLkxhbWJkYURlc3RpbmF0aW9uKGZuMSk7XG4gIGNvbnN0IGxhbWJkYURlc3RpbmF0aW9uMiA9IG5ldyBzM24uTGFtYmRhRGVzdGluYXRpb24oZm4yKTtcblxuICBidWNrZXQuYWRkRXZlbnROb3RpZmljYXRpb24oczMuRXZlbnRUeXBlLk9CSkVDVF9DUkVBVEVELCBsYW1iZGFEZXN0aW5hdGlvbjEsIHsgcHJlZml4OiAndjEvJyB9KTtcbiAgYnVja2V0LmFkZEV2ZW50Tm90aWZpY2F0aW9uKHMzLkV2ZW50VHlwZS5PQkpFQ1RfQ1JFQVRFRCwgbGFtYmRhRGVzdGluYXRpb24yLCB7IHByZWZpeDogJ3YyLycgfSk7XG5cbiAgLy8gZXhwZWN0aW5nIG5vdGlmaWNhdGlvbiBjb25maWd1cmF0aW9uIHRvIGhhdmUgYm90aCBldmVudHNcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0N1c3RvbTo6UzNCdWNrZXROb3RpZmljYXRpb25zJywge1xuICAgIE5vdGlmaWNhdGlvbkNvbmZpZ3VyYXRpb246IE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgTGFtYmRhRnVuY3Rpb25Db25maWd1cmF0aW9uczogW1xuICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgRmlsdGVyOiB7IEtleTogeyBGaWx0ZXJSdWxlczogW3sgTmFtZTogJ3ByZWZpeCcsIFZhbHVlOiAndjEvJyB9XSB9IH0gfSksXG4gICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBGaWx0ZXI6IHsgS2V5OiB7IEZpbHRlclJ1bGVzOiBbeyBOYW1lOiAncHJlZml4JywgVmFsdWU6ICd2Mi8nIH1dIH0gfSB9KSxcbiAgICAgIF0sXG4gICAgfSksXG4gIH0pO1xuXG4gIC8vIGV4cGVjdGluZyBvbmUgcGVybWlzc2lvbiBmb3IgZWFjaCBmdW5jdGlvblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnJlc291cmNlQ291bnRJcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCAyKTtcblxuICAvLyBtYWtlIHN1cmUgZWFjaCBwZXJtaXNzaW9uIHBvaW50cyB0byB0aGUgY29ycmVjdCBmdW5jdGlvblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCB7XG4gICAgRnVuY3Rpb25OYW1lOiB7XG4gICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgJ015RnVuY3Rpb24xMkE3NDRDMkUnLFxuICAgICAgICAnQXJuJyxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBTb3VyY2VBcm46IHtcbiAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAnTXlCdWNrZXRGNjhGM0ZGMCcsXG4gICAgICAgICdBcm4nLFxuICAgICAgXSxcbiAgICB9LFxuICB9KTtcbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpQZXJtaXNzaW9uJywge1xuICAgIEZ1bmN0aW9uTmFtZToge1xuICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICdNeUZ1bmN0aW9uMkYyQTk2NENBJyxcbiAgICAgICAgJ0FybicsXG4gICAgICBdLFxuICAgIH0sXG4gICAgU291cmNlQXJuOiB7XG4gICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgJ015QnVja2V0RjY4RjNGRjAnLFxuICAgICAgICAnQXJuJyxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG5cbn0pO1xuXG50ZXN0KCdsYW1iZGEgaW4gYSBkaWZmZXJlbnQgc3RhY2sgYXMgbm90aWZpY2F0aW9uIHRhcmdldCcsICgpID0+IHtcblxuICBjb25zdCBhcHAgPSBuZXcgQXBwKCk7XG4gIGNvbnN0IGxhbWJkYVN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ3N0YWNrMScpO1xuICBjb25zdCBidWNrZXRTdGFjayA9IG5ldyBTdGFjayhhcHAsICdzdGFjazInKTtcblxuICBjb25zdCBsYW1iZGFGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24obGFtYmRhU3RhY2ssICdsYW1iZGFGdW5jdGlvbicsIHtcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCd3aGF0ZXZlcicpLFxuICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgfSk7XG5cbiAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChidWNrZXRTdGFjaywgJ2J1Y2tldCcpO1xuICBidWNrZXQuYWRkT2JqZWN0Q3JlYXRlZE5vdGlmaWNhdGlvbihuZXcgczNuLkxhbWJkYURlc3RpbmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG5cbiAgLy8gcGVybWlzc2lvbiBzaG91bGQgYmUgaW4gdGhlIGJ1Y2tldCBzdGFja1xuICBUZW1wbGF0ZS5mcm9tU3RhY2soYnVja2V0U3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCB7XG4gICAgRnVuY3Rpb25OYW1lOiB7XG4gICAgICAnRm46OkltcG9ydFZhbHVlJzogJ3N0YWNrMTpFeHBvcnRzT3V0cHV0Rm5HZXRBdHRsYW1iZGFGdW5jdGlvbjk0MEU2OEFEQXJuNkIyODc4QUYnLFxuICAgIH0sXG4gICAgU291cmNlQXJuOiB7XG4gICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgJ2J1Y2tldDQzODc5QzcxJyxcbiAgICAgICAgJ0FybicsXG4gICAgICBdLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2ltcG9ydGVkIGxhbWJkYSBpbiBhIGRpZmZlcmVudCBhY2NvdW50IGFzIG5vdGlmaWNhdGlvbiB0YXJnZXQnLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnc3RhY2snLCB7XG4gICAgZW52OiB7IGFjY291bnQ6ICcxMTExMTExMTExMTEnIH0sXG4gIH0pO1xuXG4gIC8vIExhbWJkYSBhY2NvdW50IGFuZCBzdGFjayBhY2NvdW50IGRpZmZlcjsgbm8gcGVybWlzc2lvbnMgc2hvdWxkIGJlIGNyZWF0ZWQuXG4gIGNvbnN0IGxhbWJkYUZ1bmN0aW9uID0gbGFtYmRhLkZ1bmN0aW9uLmZyb21GdW5jdGlvbkFybihzdGFjaywgJ2xhbWJkYUZ1bmN0aW9uJywgJ2Fybjphd3M6bGFtYmRhOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6ZnVuY3Rpb246QmFzZUZ1bmN0aW9uJyk7XG4gIGNvbnN0IGJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdidWNrZXQnKTtcblxuICBidWNrZXQuYWRkT2JqZWN0Q3JlYXRlZE5vdGlmaWNhdGlvbihuZXcgczNuLkxhbWJkYURlc3RpbmF0aW9uKGxhbWJkYUZ1bmN0aW9uKSk7XG5cbiAgLy8gbm8gcGVybWlzc2lvbnMgY3JlYXRlZFxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnJlc291cmNlQ291bnRJcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCAwKTtcbn0pO1xuXG50ZXN0KCdsYW1iZGEgYXMgbm90aWZpY2F0aW9uIHRhcmdldCcsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgYnVja2V0QSA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdNeUJ1Y2tldCcpO1xuICBjb25zdCBmbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdNeUZ1bmN0aW9uJywge1xuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCdmb28nKSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBidWNrZXRBLmFkZE9iamVjdENyZWF0ZWROb3RpZmljYXRpb24obmV3IHMzbi5MYW1iZGFEZXN0aW5hdGlvbihmbiksIHsgc3VmZml4OiAnLnBuZycgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCB7XG4gICAgQWN0aW9uOiAnbGFtYmRhOkludm9rZUZ1bmN0aW9uJyxcbiAgICBGdW5jdGlvbk5hbWU6IHsgJ0ZuOjpHZXRBdHQnOiBbJ015RnVuY3Rpb24zQkFBNzJEMScsICdBcm4nXSB9LFxuICAgIFByaW5jaXBhbDogJ3MzLmFtYXpvbmF3cy5jb20nLFxuICAgIFNvdXJjZUFjY291bnQ6IHsgUmVmOiAnQVdTOjpBY2NvdW50SWQnIH0sXG4gICAgU291cmNlQXJuOiB7ICdGbjo6R2V0QXR0JzogWydNeUJ1Y2tldEY2OEYzRkYwJywgJ0FybiddIH0sXG4gIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdDdXN0b206OlMzQnVja2V0Tm90aWZpY2F0aW9ucycsIHtcbiAgICBOb3RpZmljYXRpb25Db25maWd1cmF0aW9uOiB7XG4gICAgICBMYW1iZGFGdW5jdGlvbkNvbmZpZ3VyYXRpb25zOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBFdmVudHM6IFsnczM6T2JqZWN0Q3JlYXRlZDoqJ10sXG4gICAgICAgICAgRmlsdGVyOiB7XG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgRmlsdGVyUnVsZXM6IFt7IE5hbWU6ICdzdWZmaXgnLCBWYWx1ZTogJy5wbmcnIH1dLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIExhbWJkYUZ1bmN0aW9uQXJuOiB7ICdGbjo6R2V0QXR0JzogWydNeUZ1bmN0aW9uM0JBQTcyRDEnLCAnQXJuJ10gfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnbGFtYmRhIGFzIG5vdGlmaWNhdGlvbiB0YXJnZXQgc3BlY2lmaWVkIGJ5IGZ1bmN0aW9uIGFybicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgYnVja2V0QSA9IG5ldyBzMy5CdWNrZXQoc3RhY2ssICdNeUJ1Y2tldCcpO1xuICBjb25zdCBmbiA9IGxhbWJkYS5GdW5jdGlvbi5mcm9tRnVuY3Rpb25Bcm4oc3RhY2ssICdNeUZ1bmN0aW9uJywgJ2Fybjphd3M6bGFtYmRhOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6ZnVuY3Rpb246UHJvY2Vzc0tpbmVzaXNSZWNvcmRzJyk7XG5cbiAgLy8gV0hFTlxuICBidWNrZXRBLmFkZE9iamVjdENyZWF0ZWROb3RpZmljYXRpb24obmV3IHMzbi5MYW1iZGFEZXN0aW5hdGlvbihmbiksIHsgc3VmZml4OiAnLnBuZycgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpTM0J1Y2tldE5vdGlmaWNhdGlvbnMnLCB7XG4gICAgTm90aWZpY2F0aW9uQ29uZmlndXJhdGlvbjoge1xuICAgICAgTGFtYmRhRnVuY3Rpb25Db25maWd1cmF0aW9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgRXZlbnRzOiBbJ3MzOk9iamVjdENyZWF0ZWQ6KiddLFxuICAgICAgICAgIEZpbHRlcjoge1xuICAgICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICAgIEZpbHRlclJ1bGVzOiBbeyBOYW1lOiAnc3VmZml4JywgVmFsdWU6ICcucG5nJyB9XSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBMYW1iZGFGdW5jdGlvbkFybjogJ2Fybjphd3M6bGFtYmRhOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6ZnVuY3Rpb246UHJvY2Vzc0tpbmVzaXNSZWNvcmRzJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgncGVybWlzc2lvbnMgYXJlIGFkZGVkIGFzIGEgZGVwZW5kZW5jeSB0byB0aGUgbm90aWZpY2F0aW9ucyByZXNvdXJjZSB3aGVuIHVzaW5nIHNpbmdsZXRvbiBmdW5jdGlvbicsICgpID0+IHtcblxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjb25zdCBidWNrZXQgPSBuZXcgczMuQnVja2V0KHN0YWNrLCAnTXlCdWNrZXQnKTtcbiAgY29uc3QgZm4gPSBuZXcgbGFtYmRhLlNpbmdsZXRvbkZ1bmN0aW9uKHN0YWNrLCAnTXlGdW5jdGlvbicsIHtcbiAgICB1dWlkOiAndXVpZCcsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2ZvbycpLFxuICB9KTtcblxuICBjb25zdCBsYW1iZGFEZXN0aW5hdGlvbiA9IG5ldyBzM24uTGFtYmRhRGVzdGluYXRpb24oZm4pO1xuXG4gIGJ1Y2tldC5hZGRFdmVudE5vdGlmaWNhdGlvbihzMy5FdmVudFR5cGUuT0JKRUNUX0NSRUFURUQsIGxhbWJkYURlc3RpbmF0aW9uLCB7IHByZWZpeDogJ3YxLycgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQ3VzdG9tOjpTM0J1Y2tldE5vdGlmaWNhdGlvbnMnLCB7XG4gICAgRGVwZW5kc09uOiBbJ015QnVja2V0QWxsb3dCdWNrZXROb3RpZmljYXRpb25zVG9TaW5nbGV0b25MYW1iZGF1dWlkMjhDOTY4ODMnXSxcbiAgfSk7XG59KTtcblxudGVzdCgnYWRkIG11bHRpcGxlIGV2ZW50IG5vdGlmaWNhdGlvbnMgdXNpbmcgYSBzaW5nbGV0b24gZnVuY3Rpb24nLCAoKSA9PiB7XG5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ015QnVja2V0Jyk7XG4gIGNvbnN0IGZuID0gbmV3IGxhbWJkYS5TaW5nbGV0b25GdW5jdGlvbihzdGFjaywgJ015RnVuY3Rpb24nLCB7XG4gICAgdXVpZDogJ3V1aWQnLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCdmb28nKSxcbiAgfSk7XG5cbiAgY29uc3QgbGFtYmRhRGVzdGluYXRpb24gPSBuZXcgczNuLkxhbWJkYURlc3RpbmF0aW9uKGZuKTtcblxuICBidWNrZXQuYWRkRXZlbnROb3RpZmljYXRpb24oczMuRXZlbnRUeXBlLk9CSkVDVF9DUkVBVEVELCBsYW1iZGFEZXN0aW5hdGlvbiwgeyBwcmVmaXg6ICd2MS8nIH0pO1xuICBidWNrZXQuYWRkRXZlbnROb3RpZmljYXRpb24oczMuRXZlbnRUeXBlLk9CSkVDVF9DUkVBVEVELCBsYW1iZGFEZXN0aW5hdGlvbiwgeyBwcmVmaXg6ICd2Mi8nIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdDdXN0b206OlMzQnVja2V0Tm90aWZpY2F0aW9ucycsIHtcbiAgICBOb3RpZmljYXRpb25Db25maWd1cmF0aW9uOiBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgIExhbWJkYUZ1bmN0aW9uQ29uZmlndXJhdGlvbnM6IFtcbiAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IEZpbHRlcjogeyBLZXk6IHsgRmlsdGVyUnVsZXM6IFt7IE5hbWU6ICdwcmVmaXgnLCBWYWx1ZTogJ3YxLycgfV0gfSB9IH0pLFxuICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgRmlsdGVyOiB7IEtleTogeyBGaWx0ZXJSdWxlczogW3sgTmFtZTogJ3ByZWZpeCcsIFZhbHVlOiAndjIvJyB9XSB9IH0gfSksXG4gICAgICBdLFxuICAgIH0pLFxuICB9KTtcblxufSk7XG4iXX0=