"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mockS3Client = {
    listObjectVersions: jest.fn(),
    deleteObjects: jest.fn(),
    getBucketTagging: jest.fn(),
    promise: jest.fn(),
};
const auto_delete_objects_handler_1 = require("../lib/auto-delete-objects-handler");
jest.mock('aws-sdk', () => {
    return { S3: jest.fn(() => mockS3Client) };
});
beforeEach(() => {
    mockS3Client.listObjectVersions.mockReturnThis();
    mockS3Client.deleteObjects.mockReturnThis();
    givenTaggedForDeletion();
});
afterEach(() => {
    jest.resetAllMocks();
});
test('does nothing on create event', async () => {
    // GIVEN
    const event = {
        RequestType: 'Create',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(0);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('does nothing on update event when everything remains the same', async () => {
    // GIVEN
    const event = {
        RequestType: 'Update',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
        OldResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(0);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('does nothing on update event when the bucket name remains the same but the service token changes', async () => {
    // GIVEN
    const event = {
        RequestType: 'Update',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
        OldResourceProperties: {
            ServiceToken: 'Bar',
            BucketName: 'MyBucket',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(0);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('does nothing on update event when the old resource properties are absent', async () => {
    // GIVEN
    const event = {
        RequestType: 'Update',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(0);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('does nothing on update event when the new resource properties are absent', async () => {
    // GIVEN
    const event = {
        RequestType: 'Update',
        OldResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(0);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('deletes all objects when the name changes on update event', async () => {
    // GIVEN
    mockAwsPromise(mockS3Client.listObjectVersions, {
        Versions: [
            { Key: 'Key1', VersionId: 'VersionId1' },
            { Key: 'Key2', VersionId: 'VersionId2' },
        ],
    });
    const event = {
        RequestType: 'Update',
        OldResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket-renamed',
        },
    };
    // WHEN
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(1);
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledWith({ Bucket: 'MyBucket' });
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(1);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledWith({
        Bucket: 'MyBucket',
        Delete: {
            Objects: [
                { Key: 'Key1', VersionId: 'VersionId1' },
                { Key: 'Key2', VersionId: 'VersionId2' },
            ],
        },
    });
});
test('deletes no objects on delete event when bucket has no objects', async () => {
    // GIVEN
    mockAwsPromise(mockS3Client.listObjectVersions, { Versions: [] });
    // WHEN
    const event = {
        RequestType: 'Delete',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(1);
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledWith({ Bucket: 'MyBucket' });
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(0);
});
test('deletes all objects on delete event', async () => {
    // GIVEN
    mockAwsPromise(mockS3Client.listObjectVersions, {
        Versions: [
            { Key: 'Key1', VersionId: 'VersionId1' },
            { Key: 'Key2', VersionId: 'VersionId2' },
        ],
    });
    // WHEN
    const event = {
        RequestType: 'Delete',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(1);
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledWith({ Bucket: 'MyBucket' });
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(1);
    expect(mockS3Client.deleteObjects).toHaveBeenCalledWith({
        Bucket: 'MyBucket',
        Delete: {
            Objects: [
                { Key: 'Key1', VersionId: 'VersionId1' },
                { Key: 'Key2', VersionId: 'VersionId2' },
            ],
        },
    });
});
test('does not empty bucket if it is not tagged', async () => {
    // GIVEN
    givenNotTaggedForDeletion();
    mockAwsPromise(mockS3Client.listObjectVersions, {
        Versions: [
            { Key: 'Key1', VersionId: 'VersionId1' },
            { Key: 'Key2', VersionId: 'VersionId2' },
        ],
    });
    // WHEN
    const event = {
        RequestType: 'Delete',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).not.toHaveBeenCalled();
});
test('delete event where bucket has many objects does recurse appropriately', async () => {
    // GIVEN
    mockAwsPromise(mockS3Client.listObjectVersions, {
        Versions: [
            { Key: 'Key1', VersionId: 'VersionId1' },
            { Key: 'Key2', VersionId: 'VersionId2' },
        ],
        IsTruncated: true,
    }, 'once');
    mockAwsPromise(mockS3Client.listObjectVersions, {
        Versions: [
            { Key: 'Key3', VersionId: 'VersionId3' },
            { Key: 'Key4', VersionId: 'VersionId4' },
        ],
    }, 'once');
    mockAwsPromise(mockS3Client.deleteObjects, {});
    // WHEN
    const event = {
        RequestType: 'Delete',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    await invokeHandler(event);
    // THEN
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledTimes(2);
    expect(mockS3Client.listObjectVersions).toHaveBeenCalledWith({ Bucket: 'MyBucket' });
    expect(mockS3Client.deleteObjects).toHaveBeenCalledTimes(2);
    expect(mockS3Client.deleteObjects).toHaveBeenNthCalledWith(1, {
        Bucket: 'MyBucket',
        Delete: {
            Objects: [
                { Key: 'Key1', VersionId: 'VersionId1' },
                { Key: 'Key2', VersionId: 'VersionId2' },
            ],
        },
    });
    expect(mockS3Client.deleteObjects).toHaveBeenNthCalledWith(2, {
        Bucket: 'MyBucket',
        Delete: {
            Objects: [
                { Key: 'Key3', VersionId: 'VersionId3' },
                { Key: 'Key4', VersionId: 'VersionId4' },
            ],
        },
    });
});
test('does nothing when the bucket does not exist', async () => {
    // GIVEN
    mockS3Client.promise.mockRejectedValue({ code: 'NoSuchBucket' });
    // WHEN
    const event = {
        RequestType: 'Delete',
        ResourceProperties: {
            ServiceToken: 'Foo',
            BucketName: 'MyBucket',
        },
    };
    await invokeHandler(event);
    expect(mockS3Client.deleteObjects).not.toHaveBeenCalled();
});
// helper function to get around TypeScript expecting a complete event object,
// even though our tests only need some of the fields
async function invokeHandler(event) {
    return (0, auto_delete_objects_handler_1.handler)(event);
}
function mockAwsPromise(fn, value, when = 'always') {
    (when === 'always' ? fn.mockReturnValue : fn.mockReturnValueOnce).call(fn, {
        promise: () => value,
    });
}
function givenTaggedForDeletion() {
    mockAwsPromise(mockS3Client.getBucketTagging, {
        TagSet: [
            {
                Key: 'aws-cdk:auto-delete-objects',
                Value: 'true',
            },
        ],
    });
}
function givenNotTaggedForDeletion() {
    mockAwsPromise(mockS3Client.getBucketTagging, {
        TagSet: [],
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0by1kZWxldGUtb2JqZWN0cy1oYW5kbGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhdXRvLWRlbGV0ZS1vYmplY3RzLWhhbmRsZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sWUFBWSxHQUFHO0lBQ25CLGtCQUFrQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDN0IsYUFBYSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDeEIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUMzQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUNuQixDQUFDO0FBRUYsb0ZBQTZEO0FBRTdELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRTtJQUN4QixPQUFPLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQztBQUM3QyxDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxZQUFZLENBQUMsa0JBQWtCLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDakQsWUFBWSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUM1QyxzQkFBc0IsRUFBRSxDQUFDO0FBQzNCLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLElBQUksRUFBRTtJQUM5QyxRQUFRO0lBQ1IsTUFBTSxLQUFLLEdBQStEO1FBQ3hFLFdBQVcsRUFBRSxRQUFRO1FBQ3JCLGtCQUFrQixFQUFFO1lBQ2xCLFlBQVksRUFBRSxLQUFLO1lBQ25CLFVBQVUsRUFBRSxVQUFVO1NBQ3ZCO0tBQ0YsQ0FBQztJQUVGLE9BQU87SUFD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amVjdFZlcnNpb25zOiBqZXN0LmZuKCksXG4gIGRlbGV0ZU9iamVjdHM6IGplc3QuZm4oKSxcbiAgZ2V0QnVja2V0VGFnZ2luZzogamVzdC5mbigpLFxuICBwcm9taXNlOiBqZXN0LmZuKCksXG59O1xuXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vbGliL2F1dG8tZGVsZXRlLW9iamVjdHMtaGFuZGxlcic7XG5cbmplc3QubW9jaygnYXdzLXNkaycsICgpID0+IHtcbiAgcmV0dXJuIHsgUzM6IGplc3QuZm4oKCkgPT4gbW9ja1MzQ2xpZW50KSB9O1xufSk7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zLm1vY2tSZXR1cm5UaGlzKCk7XG4gIG1vY2tTM0NsaWVudC5kZWxldGVPYmplY3RzLm1vY2tSZXR1cm5UaGlzKCk7XG4gIGdpdmVuVGFnZ2VkRm9yRGVsZXRpb24oKTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBqZXN0LnJlc2V0QWxsTW9ja3MoKTtcbn0pO1xuXG50ZXN0KCdkb2VzIG5vdGhpbmcgb24gY3JlYXRlIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUNyZWF0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDApO1xuICBleHBlY3QobW9ja1MzQ2xpZW50LmRlbGV0ZU9iamVjdHMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygwKTtcbn0pO1xuXG50ZXN0KCdkb2VzIG5vdGhpbmcgb24gdXBkYXRlIGV2ZW50IHdoZW4gZXZlcnl0aGluZyByZW1haW5zIHRoZSBzYW1lJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICAgIE9sZFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgU2VydmljZVRva2VuOiAnRm9vJyxcbiAgICAgIEJ1Y2tldE5hbWU6ICdNeUJ1Y2tldCcsXG4gICAgfSxcbiAgfTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IGludm9rZUhhbmRsZXIoZXZlbnQpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KG1vY2tTM0NsaWVudC5saXN0T2JqZWN0VmVyc2lvbnMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygwKTtcbiAgZXhwZWN0KG1vY2tTM0NsaWVudC5kZWxldGVPYmplY3RzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMCk7XG59KTtcblxudGVzdCgnZG9lcyBub3RoaW5nIG9uIHVwZGF0ZSBldmVudCB3aGVuIHRoZSBidWNrZXQgbmFtZSByZW1haW5zIHRoZSBzYW1lIGJ1dCB0aGUgc2VydmljZSB0b2tlbiBjaGFuZ2VzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICAgIE9sZFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgU2VydmljZVRva2VuOiAnQmFyJyxcbiAgICAgIEJ1Y2tldE5hbWU6ICdNeUJ1Y2tldCcsXG4gICAgfSxcbiAgfTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IGludm9rZUhhbmRsZXIoZXZlbnQpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KG1vY2tTM0NsaWVudC5saXN0T2JqZWN0VmVyc2lvbnMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygwKTtcbiAgZXhwZWN0KG1vY2tTM0NsaWVudC5kZWxldGVPYmplY3RzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMCk7XG59KTtcblxudGVzdCgnZG9lcyBub3RoaW5nIG9uIHVwZGF0ZSBldmVudCB3aGVuIHRoZSBvbGQgcmVzb3VyY2UgcHJvcGVydGllcyBhcmUgYWJzZW50JywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDApO1xuICBleHBlY3QobW9ja1MzQ2xpZW50LmRlbGV0ZU9iamVjdHMpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygwKTtcbn0pO1xuXG50ZXN0KCdkb2VzIG5vdGhpbmcgb24gdXBkYXRlIGV2ZW50IHdoZW4gdGhlIG5ldyByZXNvdXJjZSBwcm9wZXJ0aWVzIGFyZSBhYnNlbnQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlVXBkYXRlRXZlbnQ+ID0ge1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBPbGRSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFNlcnZpY2VUb2tlbjogJ0ZvbycsXG4gICAgICBCdWNrZXROYW1lOiAnTXlCdWNrZXQnLFxuICAgIH0sXG4gIH07XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMCk7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDApO1xufSk7XG5cbnRlc3QoJ2RlbGV0ZXMgYWxsIG9iamVjdHMgd2hlbiB0aGUgbmFtZSBjaGFuZ2VzIG9uIHVwZGF0ZSBldmVudCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja0F3c1Byb21pc2UobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucywge1xuICAgIFZlcnNpb25zOiBbXG4gICAgICB7IEtleTogJ0tleTEnLCBWZXJzaW9uSWQ6ICdWZXJzaW9uSWQxJyB9LFxuICAgICAgeyBLZXk6ICdLZXkyJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMicgfSxcbiAgICBdLFxuICB9KTtcblxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVVwZGF0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgT2xkUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgU2VydmljZVRva2VuOiAnRm9vJyxcbiAgICAgIEJ1Y2tldE5hbWU6ICdNeUJ1Y2tldC1yZW5hbWVkJyxcbiAgICB9LFxuICB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBCdWNrZXQ6ICdNeUJ1Y2tldCcgfSk7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1MzQ2xpZW50LmRlbGV0ZU9iamVjdHMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICBCdWNrZXQ6ICdNeUJ1Y2tldCcsXG4gICAgRGVsZXRlOiB7XG4gICAgICBPYmplY3RzOiBbXG4gICAgICAgIHsgS2V5OiAnS2V5MScsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDEnIH0sXG4gICAgICAgIHsgS2V5OiAnS2V5MicsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDInIH0sXG4gICAgICBdLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2RlbGV0ZXMgbm8gb2JqZWN0cyBvbiBkZWxldGUgZXZlbnQgd2hlbiBidWNrZXQgaGFzIG5vIG9iamVjdHMnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tBd3NQcm9taXNlKG1vY2tTM0NsaWVudC5saXN0T2JqZWN0VmVyc2lvbnMsIHsgVmVyc2lvbnM6IFtdIH0pO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VEZWxldGVFdmVudD4gPSB7XG4gICAgUmVxdWVzdFR5cGU6ICdEZWxldGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgU2VydmljZVRva2VuOiAnRm9vJyxcbiAgICAgIEJ1Y2tldE5hbWU6ICdNeUJ1Y2tldCcsXG4gICAgfSxcbiAgfTtcbiAgYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBCdWNrZXQ6ICdNeUJ1Y2tldCcgfSk7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDApO1xufSk7XG5cbnRlc3QoJ2RlbGV0ZXMgYWxsIG9iamVjdHMgb24gZGVsZXRlIGV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2NrQXdzUHJvbWlzZShtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zLCB7XG4gICAgVmVyc2lvbnM6IFtcbiAgICAgIHsgS2V5OiAnS2V5MScsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDEnIH0sXG4gICAgICB7IEtleTogJ0tleTInLCBWZXJzaW9uSWQ6ICdWZXJzaW9uSWQyJyB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgZXZlbnQ6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VEZWxldGVFdmVudD4gPSB7XG4gICAgUmVxdWVzdFR5cGU6ICdEZWxldGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgU2VydmljZVRva2VuOiAnRm9vJyxcbiAgICAgIEJ1Y2tldE5hbWU6ICdNeUJ1Y2tldCcsXG4gICAgfSxcbiAgfTtcbiAgYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucykudG9IYXZlQmVlbkNhbGxlZFdpdGgoeyBCdWNrZXQ6ICdNeUJ1Y2tldCcgfSk7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QobW9ja1MzQ2xpZW50LmRlbGV0ZU9iamVjdHMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICBCdWNrZXQ6ICdNeUJ1Y2tldCcsXG4gICAgRGVsZXRlOiB7XG4gICAgICBPYmplY3RzOiBbXG4gICAgICAgIHsgS2V5OiAnS2V5MScsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDEnIH0sXG4gICAgICAgIHsgS2V5OiAnS2V5MicsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDInIH0sXG4gICAgICBdLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2RvZXMgbm90IGVtcHR5IGJ1Y2tldCBpZiBpdCBpcyBub3QgdGFnZ2VkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBnaXZlbk5vdFRhZ2dlZEZvckRlbGV0aW9uKCk7XG4gIG1vY2tBd3NQcm9taXNlKG1vY2tTM0NsaWVudC5saXN0T2JqZWN0VmVyc2lvbnMsIHtcbiAgICBWZXJzaW9uczogW1xuICAgICAgeyBLZXk6ICdLZXkxJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMScgfSxcbiAgICAgIHsgS2V5OiAnS2V5MicsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDInIH0sXG4gICAgXSxcbiAgfSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZURlbGV0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICB9O1xuICBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xufSk7XG5cbnRlc3QoJ2RlbGV0ZSBldmVudCB3aGVyZSBidWNrZXQgaGFzIG1hbnkgb2JqZWN0cyBkb2VzIHJlY3Vyc2UgYXBwcm9wcmlhdGVseScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja0F3c1Byb21pc2UobW9ja1MzQ2xpZW50Lmxpc3RPYmplY3RWZXJzaW9ucywge1xuICAgIFZlcnNpb25zOiBbXG4gICAgICB7IEtleTogJ0tleTEnLCBWZXJzaW9uSWQ6ICdWZXJzaW9uSWQxJyB9LFxuICAgICAgeyBLZXk6ICdLZXkyJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMicgfSxcbiAgICBdLFxuICAgIElzVHJ1bmNhdGVkOiB0cnVlLFxuICB9LCAnb25jZScpO1xuICBtb2NrQXdzUHJvbWlzZShtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zLCB7XG4gICAgVmVyc2lvbnM6IFtcbiAgICAgIHsgS2V5OiAnS2V5MycsIFZlcnNpb25JZDogJ1ZlcnNpb25JZDMnIH0sXG4gICAgICB7IEtleTogJ0tleTQnLCBWZXJzaW9uSWQ6ICdWZXJzaW9uSWQ0JyB9LFxuICAgIF0sXG4gIH0sICdvbmNlJyk7XG4gIG1vY2tBd3NQcm9taXNlKG1vY2tTM0NsaWVudC5kZWxldGVPYmplY3RzLCB7fSk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBldmVudDogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZURlbGV0ZUV2ZW50PiA9IHtcbiAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICdGb28nLFxuICAgICAgQnVja2V0TmFtZTogJ015QnVja2V0JyxcbiAgICB9LFxuICB9O1xuICBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQubGlzdE9iamVjdFZlcnNpb25zKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IEJ1Y2tldDogJ015QnVja2V0JyB9KTtcbiAgZXhwZWN0KG1vY2tTM0NsaWVudC5kZWxldGVPYmplY3RzKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMik7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbk50aENhbGxlZFdpdGgoMSwge1xuICAgIEJ1Y2tldDogJ015QnVja2V0JyxcbiAgICBEZWxldGU6IHtcbiAgICAgIE9iamVjdHM6IFtcbiAgICAgICAgeyBLZXk6ICdLZXkxJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMScgfSxcbiAgICAgICAgeyBLZXk6ICdLZXkyJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMicgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykudG9IYXZlQmVlbk50aENhbGxlZFdpdGgoMiwge1xuICAgIEJ1Y2tldDogJ015QnVja2V0JyxcbiAgICBEZWxldGU6IHtcbiAgICAgIE9iamVjdHM6IFtcbiAgICAgICAgeyBLZXk6ICdLZXkzJywgVmVyc2lvbklkOiAnVmVyc2lvbklkMycgfSxcbiAgICAgICAgeyBLZXk6ICdLZXk0JywgVmVyc2lvbklkOiAnVmVyc2lvbklkNCcgfSxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnZG9lcyBub3RoaW5nIHdoZW4gdGhlIGJ1Y2tldCBkb2VzIG5vdCBleGlzdCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja1MzQ2xpZW50LnByb21pc2UubW9ja1JlamVjdGVkVmFsdWUoeyBjb2RlOiAnTm9TdWNoQnVja2V0JyB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGV2ZW50OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRGVsZXRlRXZlbnQ+ID0ge1xuICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgIFNlcnZpY2VUb2tlbjogJ0ZvbycsXG4gICAgICBCdWNrZXROYW1lOiAnTXlCdWNrZXQnLFxuICAgIH0sXG4gIH07XG4gIGF3YWl0IGludm9rZUhhbmRsZXIoZXZlbnQpO1xuXG4gIGV4cGVjdChtb2NrUzNDbGllbnQuZGVsZXRlT2JqZWN0cykubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbn0pO1xuXG4vLyBoZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGFyb3VuZCBUeXBlU2NyaXB0IGV4cGVjdGluZyBhIGNvbXBsZXRlIGV2ZW50IG9iamVjdCxcbi8vIGV2ZW4gdGhvdWdoIG91ciB0ZXN0cyBvbmx5IG5lZWQgc29tZSBvZiB0aGUgZmllbGRzXG5hc3luYyBmdW5jdGlvbiBpbnZva2VIYW5kbGVyKGV2ZW50OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQ+KSB7XG4gIHJldHVybiBoYW5kbGVyKGV2ZW50IGFzIEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQpO1xufVxuXG5mdW5jdGlvbiBtb2NrQXdzUHJvbWlzZTxBPihmbjogamVzdC5Nb2NrPGFueSwgYW55PiwgdmFsdWU6IEEsIHdoZW46ICdvbmNlJyB8ICdhbHdheXMnID0gJ2Fsd2F5cycpIHtcbiAgKHdoZW4gPT09ICdhbHdheXMnID8gZm4ubW9ja1JldHVyblZhbHVlIDogZm4ubW9ja1JldHVyblZhbHVlT25jZSkuY2FsbChmbiwge1xuICAgIHByb21pc2U6ICgpID0+IHZhbHVlLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2l2ZW5UYWdnZWRGb3JEZWxldGlvbigpIHtcbiAgbW9ja0F3c1Byb21pc2UobW9ja1MzQ2xpZW50LmdldEJ1Y2tldFRhZ2dpbmcsIHtcbiAgICBUYWdTZXQ6IFtcbiAgICAgIHtcbiAgICAgICAgS2V5OiAnYXdzLWNkazphdXRvLWRlbGV0ZS1vYmplY3RzJyxcbiAgICAgICAgVmFsdWU6ICd0cnVlJyxcbiAgICAgIH0sXG4gICAgXSxcblxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2l2ZW5Ob3RUYWdnZWRGb3JEZWxldGlvbigpIHtcbiAgbW9ja0F3c1Byb21pc2UobW9ja1MzQ2xpZW50LmdldEJ1Y2tldFRhZ2dpbmcsIHtcbiAgICBUYWdTZXQ6IFtdLFxuICB9KTtcbn0iXX0=