"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const kms = require("../../aws-kms");
const lambda = require("../../aws-lambda");
const s3 = require("../../aws-s3");
const ses = require("../../aws-ses");
const sns = require("../../aws-sns");
const core_1 = require("../../core");
const actions = require("../lib");
let stack;
let rule;
let topic;
beforeEach(() => {
    stack = new core_1.Stack();
    const ruleSet = new ses.ReceiptRuleSet(stack, 'RuleSet');
    rule = ruleSet.addRule('Rule');
    topic = new sns.Topic(stack, 'Topic');
});
test('add header action', () => {
    rule.addAction(new actions.AddHeader({
        name: 'X-My-Header',
        value: 'value',
    }));
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SES::ReceiptRule', {
        Rule: {
            Actions: [
                {
                    AddHeaderAction: {
                        HeaderName: 'X-My-Header',
                        HeaderValue: 'value',
                    },
                },
            ],
            Enabled: true,
        },
    });
});
test('add header action with invalid header name', () => {
    expect(() => rule.addAction(new actions.AddHeader({
        name: 'He@der',
        value: 'value',
    }))).toThrow(/`name`/);
});
test('add header action with invalid header value', () => {
    expect(() => rule.addAction(new actions.AddHeader({
        name: 'Header',
        value: `va
    lu`,
    }))).toThrow(/`value`/);
});
test('add bounce action', () => {
    rule.addAction(new actions.Bounce({
        sender: 'noreply@aws.com',
        template: actions.BounceTemplate.MESSAGE_CONTENT_REJECTED,
        topic,
    }));
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SES::ReceiptRule', {
        Rule: {
            Actions: [
                {
                    BounceAction: {
                        Message: 'Message content rejected',
                        Sender: 'noreply@aws.com',
                        SmtpReplyCode: '500',
                        TopicArn: {
                            Ref: 'TopicBFC7AF6E',
                        },
                        StatusCode: '5.6.1',
                    },
                },
            ],
            Enabled: true,
        },
    });
});
test('add lambda action', () => {
    const fn = new lambda.Function(stack, 'Function', {
        code: lambda.Code.fromInline('boom'),
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
    });
    rule.addAction(new actions.Lambda({
        function: fn,
        invocationType: actions.LambdaInvocationType.REQUEST_RESPONSE,
        topic,
    }));
    assertions_1.Template.fromStack(stack).hasResource('AWS::SES::ReceiptRule', {
        Properties: {
            Rule: {
                Actions: [
                    {
                        LambdaAction: {
                            FunctionArn: {
                                'Fn::GetAtt': [
                                    'Function76856677',
                                    'Arn',
                                ],
                            },
                            InvocationType: 'RequestResponse',
                            TopicArn: {
                                Ref: 'TopicBFC7AF6E',
                            },
                        },
                    },
                ],
                Enabled: true,
            },
            RuleSetName: {
                Ref: 'RuleSetE30C6C48',
            },
        },
        DependsOn: [
            'FunctionAllowSes1829904A',
        ],
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::Lambda::Permission', {
        Action: 'lambda:InvokeFunction',
        FunctionName: {
            'Fn::GetAtt': [
                'Function76856677',
                'Arn',
            ],
        },
        Principal: 'ses.amazonaws.com',
        SourceAccount: {
            Ref: 'AWS::AccountId',
        },
    });
});
test('add s3 action', () => {
    const bucket = new s3.Bucket(stack, 'Bucket');
    const kmsKey = new kms.Key(stack, 'Key');
    rule.addAction(new actions.S3({
        bucket,
        kmsKey,
        objectKeyPrefix: 'emails/',
        topic,
    }));
    assertions_1.Template.fromStack(stack).hasResource('AWS::SES::ReceiptRule', {
        Properties: {
            Rule: {
                Actions: [
                    {
                        S3Action: {
                            BucketName: {
                                Ref: 'Bucket83908E77',
                            },
                            KmsKeyArn: {
                                'Fn::GetAtt': [
                                    'Key961B73FD',
                                    'Arn',
                                ],
                            },
                            ObjectKeyPrefix: 'emails/',
                            TopicArn: {
                                Ref: 'TopicBFC7AF6E',
                            },
                        },
                    },
                ],
                Enabled: true,
            },
            RuleSetName: {
                Ref: 'RuleSetE30C6C48',
            },
        },
        DependsOn: [
            'BucketPolicyE9A3008A',
        ],
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::S3::BucketPolicy', {
        Bucket: {
            Ref: 'Bucket83908E77',
        },
        PolicyDocument: {
            Statement: [
                {
                    Action: 's3:PutObject',
                    Condition: {
                        StringEquals: {
                            'aws:Referer': {
                                Ref: 'AWS::AccountId',
                            },
                        },
                    },
                    Effect: 'Allow',
                    Principal: {
                        Service: 'ses.amazonaws.com',
                    },
                    Resource: {
                        'Fn::Join': [
                            '',
                            [
                                {
                                    'Fn::GetAtt': [
                                        'Bucket83908E77',
                                        'Arn',
                                    ],
                                },
                                '/emails/*',
                            ],
                        ],
                    },
                },
            ],
            Version: '2012-10-17',
        },
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::KMS::Key', {
        KeyPolicy: {
            Statement: assertions_1.Match.arrayWith([{
                    Action: [
                        'kms:Encrypt',
                        'kms:GenerateDataKey',
                    ],
                    Condition: {
                        Null: {
                            'kms:EncryptionContext:aws:ses:rule-name': 'false',
                            'kms:EncryptionContext:aws:ses:message-id': 'false',
                        },
                        StringEquals: {
                            'kms:EncryptionContext:aws:ses:source-account': {
                                Ref: 'AWS::AccountId',
                            },
                        },
                    },
                    Effect: 'Allow',
                    Principal: {
                        Service: 'ses.amazonaws.com',
                    },
                    Resource: '*',
                }]),
        },
    });
});
test('add sns action', () => {
    rule.addAction(new actions.Sns({
        encoding: actions.EmailEncoding.BASE64,
        topic,
    }));
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SES::ReceiptRule', {
        Rule: {
            Actions: [
                {
                    SNSAction: {
                        Encoding: 'Base64',
                        TopicArn: {
                            Ref: 'TopicBFC7AF6E',
                        },
                    },
                },
            ],
            Enabled: true,
        },
    });
});
test('add stop action', () => {
    rule.addAction(new actions.Stop({
        topic,
    }));
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::SES::ReceiptRule', {
        Rule: {
            Actions: [
                {
                    StopAction: {
                        Scope: 'RuleSet',
                        TopicArn: {
                            Ref: 'TopicBFC7AF6E',
                        },
                    },
                },
            ],
            Enabled: true,
        },
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9ucy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWN0aW9ucy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaURBQW1EO0FBQ25ELHFDQUFxQztBQUNyQywyQ0FBMkM7QUFDM0MsbUNBQW1DO0FBQ25DLHFDQUFxQztBQUNyQyxxQ0FBcUM7QUFDckMscUNBQW1DO0FBQ25DLGtDQUFrQztBQUVsQyxJQUFJLEtBQVksQ0FBQztBQUNqQixJQUFJLElBQXFCLENBQUM7QUFDMUIsSUFBSSxLQUFnQixDQUFDO0FBRXJCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUNwQixNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3pELElBQUksR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9CLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtJQUM3QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUNuQyxJQUFJLEVBQUUsYUFBYTtRQUNuQixLQUFLLEVBQUUsT0FBTztLQUNmLENBQUMsQ0FBQyxDQUFDO0lBRUoscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsdUJBQXVCLEVBQUU7UUFDdkUsSUFBSSxFQUFFO1lBQ0osT0FBTyxFQUFFO2dCQUNQO29CQUNFLGVBQWUsRUFBRTt3QkFDZixVQUFVLEVBQUUsYUFBYTt3QkFDekIsV0FBVyxFQUFFLE9BQU87cUJBQ3JCO2lCQUNGO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsSUFBSTtTQUNk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LGVBQWU7eUJBQ3JCO3FCQUNGO2lCQUNGO2FBQ0Y7WUFDRCxPQUFPLEVBQUUsSUFBSTtTQUNkO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGttcyBmcm9tICcuLi8uLi9hd3Mta21zJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJy4uLy4uL2F3cy1zMyc7XG5pbXBvcnQgKiBhcyBzZXMgZnJvbSAnLi4vLi4vYXdzLXNlcyc7XG5pbXBvcnQgKiBhcyBzbnMgZnJvbSAnLi4vLi4vYXdzLXNucyc7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgYWN0aW9ucyBmcm9tICcuLi9saWInO1xuXG5sZXQgc3RhY2s6IFN0YWNrO1xubGV0IHJ1bGU6IHNlcy5SZWNlaXB0UnVsZTtcbmxldCB0b3BpYzogc25zLlRvcGljO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgcnVsZVNldCA9IG5ldyBzZXMuUmVjZWlwdFJ1bGVTZXQoc3RhY2ssICdSdWxlU2V0Jyk7XG4gIHJ1bGUgPSBydWxlU2V0LmFkZFJ1bGUoJ1J1bGUnKTtcbiAgdG9waWMgPSBuZXcgc25zLlRvcGljKHN0YWNrLCAnVG9waWMnKTtcbn0pO1xuXG50ZXN0KCdhZGQgaGVhZGVyIGFjdGlvbicsICgpID0+IHtcbiAgcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuQWRkSGVhZGVyKHtcbiAgICBuYW1lOiAnWC1NeS1IZWFkZXInLFxuICAgIHZhbHVlOiAndmFsdWUnLFxuICB9KSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6U0VTOjpSZWNlaXB0UnVsZScsIHtcbiAgICBSdWxlOiB7XG4gICAgICBBY3Rpb25zOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBZGRIZWFkZXJBY3Rpb246IHtcbiAgICAgICAgICAgIEhlYWRlck5hbWU6ICdYLU15LUhlYWRlcicsXG4gICAgICAgICAgICBIZWFkZXJWYWx1ZTogJ3ZhbHVlJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIEVuYWJsZWQ6IHRydWUsXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnYWRkIGhlYWRlciBhY3Rpb24gd2l0aCBpbnZhbGlkIGhlYWRlciBuYW1lJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4gcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuQWRkSGVhZGVyKHtcbiAgICBuYW1lOiAnSGVAZGVyJyxcbiAgICB2YWx1ZTogJ3ZhbHVlJyxcbiAgfSkpKS50b1Rocm93KC9gbmFtZWAvKTtcbn0pO1xuXG50ZXN0KCdhZGQgaGVhZGVyIGFjdGlvbiB3aXRoIGludmFsaWQgaGVhZGVyIHZhbHVlJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4gcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuQWRkSGVhZGVyKHtcbiAgICBuYW1lOiAnSGVhZGVyJyxcbiAgICB2YWx1ZTogYHZhXG4gICAgbHVgLFxuICB9KSkpLnRvVGhyb3coL2B2YWx1ZWAvKTtcbn0pO1xuXG50ZXN0KCdhZGQgYm91bmNlIGFjdGlvbicsICgpID0+IHtcbiAgcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuQm91bmNlKHtcbiAgICBzZW5kZXI6ICdub3JlcGx5QGF3cy5jb20nLFxuICAgIHRlbXBsYXRlOiBhY3Rpb25zLkJvdW5jZVRlbXBsYXRlLk1FU1NBR0VfQ09OVEVOVF9SRUpFQ1RFRCxcbiAgICB0b3BpYyxcbiAgfSkpO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNFUzo6UmVjZWlwdFJ1bGUnLCB7XG4gICAgUnVsZToge1xuICAgICAgQWN0aW9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgQm91bmNlQWN0aW9uOiB7XG4gICAgICAgICAgICBNZXNzYWdlOiAnTWVzc2FnZSBjb250ZW50IHJlamVjdGVkJyxcbiAgICAgICAgICAgIFNlbmRlcjogJ25vcmVwbHlAYXdzLmNvbScsXG4gICAgICAgICAgICBTbXRwUmVwbHlDb2RlOiAnNTAwJyxcbiAgICAgICAgICAgIFRvcGljQXJuOiB7XG4gICAgICAgICAgICAgIFJlZjogJ1RvcGljQkZDN0FGNkUnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIFN0YXR1c0NvZGU6ICc1LjYuMScsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBFbmFibGVkOiB0cnVlLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2FkZCBsYW1iZGEgYWN0aW9uJywgKCkgPT4ge1xuICBjb25zdCBmbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24oc3RhY2ssICdGdW5jdGlvbicsIHtcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCdib29tJyksXG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICB9KTtcblxuICBydWxlLmFkZEFjdGlvbihuZXcgYWN0aW9ucy5MYW1iZGEoe1xuICAgIGZ1bmN0aW9uOiBmbixcbiAgICBpbnZvY2F0aW9uVHlwZTogYWN0aW9ucy5MYW1iZGFJbnZvY2F0aW9uVHlwZS5SRVFVRVNUX1JFU1BPTlNFLFxuICAgIHRvcGljLFxuICB9KSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpTRVM6OlJlY2VpcHRSdWxlJywge1xuICAgIFByb3BlcnRpZXM6IHtcbiAgICAgIFJ1bGU6IHtcbiAgICAgICAgQWN0aW9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIExhbWJkYUFjdGlvbjoge1xuICAgICAgICAgICAgICBGdW5jdGlvbkFybjoge1xuICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgJ0Z1bmN0aW9uNzY4NTY2NzcnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgSW52b2NhdGlvblR5cGU6ICdSZXF1ZXN0UmVzcG9uc2UnLFxuICAgICAgICAgICAgICBUb3BpY0Fybjoge1xuICAgICAgICAgICAgICAgIFJlZjogJ1RvcGljQkZDN0FGNkUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBFbmFibGVkOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIFJ1bGVTZXROYW1lOiB7XG4gICAgICAgIFJlZjogJ1J1bGVTZXRFMzBDNkM0OCcsXG4gICAgICB9LFxuICAgIH0sXG4gICAgRGVwZW5kc09uOiBbXG4gICAgICAnRnVuY3Rpb25BbGxvd1NlczE4Mjk5MDRBJyxcbiAgICBdLFxuICB9KTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OlBlcm1pc3Npb24nLCB7XG4gICAgQWN0aW9uOiAnbGFtYmRhOkludm9rZUZ1bmN0aW9uJyxcbiAgICBGdW5jdGlvbk5hbWU6IHtcbiAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAnRnVuY3Rpb243Njg1NjY3NycsXG4gICAgICAgICdBcm4nLFxuICAgICAgXSxcbiAgICB9LFxuICAgIFByaW5jaXBhbDogJ3Nlcy5hbWF6b25hd3MuY29tJyxcbiAgICBTb3VyY2VBY2NvdW50OiB7XG4gICAgICBSZWY6ICdBV1M6OkFjY291bnRJZCcsXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnYWRkIHMzIGFjdGlvbicsICgpID0+IHtcbiAgY29uc3QgYnVja2V0ID0gbmV3IHMzLkJ1Y2tldChzdGFjaywgJ0J1Y2tldCcpO1xuICBjb25zdCBrbXNLZXkgPSBuZXcga21zLktleShzdGFjaywgJ0tleScpO1xuXG4gIHJ1bGUuYWRkQWN0aW9uKG5ldyBhY3Rpb25zLlMzKHtcbiAgICBidWNrZXQsXG4gICAga21zS2V5LFxuICAgIG9iamVjdEtleVByZWZpeDogJ2VtYWlscy8nLFxuICAgIHRvcGljLFxuICB9KSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZSgnQVdTOjpTRVM6OlJlY2VpcHRSdWxlJywge1xuICAgIFByb3BlcnRpZXM6IHtcbiAgICAgIFJ1bGU6IHtcbiAgICAgICAgQWN0aW9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIFMzQWN0aW9uOiB7XG4gICAgICAgICAgICAgIEJ1Y2tldE5hbWU6IHtcbiAgICAgICAgICAgICAgICBSZWY6ICdCdWNrZXQ4MzkwOEU3NycsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIEttc0tleUFybjoge1xuICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgJ0tleTk2MUI3M0ZEJyxcbiAgICAgICAgICAgICAgICAgICdBcm4nLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIE9iamVjdEtleVByZWZpeDogJ2VtYWlscy8nLFxuICAgICAgICAgICAgICBUb3BpY0Fybjoge1xuICAgICAgICAgICAgICAgIFJlZjogJ1RvcGljQkZDN0FGNkUnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBFbmFibGVkOiB0cnVlLFxuICAgICAgfSxcbiAgICAgIFJ1bGVTZXROYW1lOiB7XG4gICAgICAgIFJlZjogJ1J1bGVTZXRFMzBDNkM0OCcsXG4gICAgICB9LFxuICAgIH0sXG4gICAgRGVwZW5kc09uOiBbXG4gICAgICAnQnVja2V0UG9saWN5RTlBMzAwOEEnLFxuICAgIF0sXG4gIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlMzOjpCdWNrZXRQb2xpY3knLCB7XG4gICAgQnVja2V0OiB7XG4gICAgICBSZWY6ICdCdWNrZXQ4MzkwOEU3NycsXG4gICAgfSxcbiAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgU3RhdGVtZW50OiBbXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246ICdzMzpQdXRPYmplY3QnLFxuICAgICAgICAgIENvbmRpdGlvbjoge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdhd3M6UmVmZXJlcic6IHtcbiAgICAgICAgICAgICAgICBSZWY6ICdBV1M6OkFjY291bnRJZCcsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFByaW5jaXBhbDoge1xuICAgICAgICAgICAgU2VydmljZTogJ3Nlcy5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgJ0ZuOjpHZXRBdHQnOiBbXG4gICAgICAgICAgICAgICAgICAgICdCdWNrZXQ4MzkwOEU3NycsXG4gICAgICAgICAgICAgICAgICAgICdBcm4nLFxuICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICcvZW1haWxzLyonLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICB9LFxuICB9KTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpLTVM6OktleScsIHtcbiAgICBLZXlQb2xpY3k6IHtcbiAgICAgIFN0YXRlbWVudDogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICdrbXM6RW5jcnlwdCcsXG4gICAgICAgICAgJ2ttczpHZW5lcmF0ZURhdGFLZXknLFxuICAgICAgICBdLFxuICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICBOdWxsOiB7XG4gICAgICAgICAgICAna21zOkVuY3J5cHRpb25Db250ZXh0OmF3czpzZXM6cnVsZS1uYW1lJzogJ2ZhbHNlJyxcbiAgICAgICAgICAgICdrbXM6RW5jcnlwdGlvbkNvbnRleHQ6YXdzOnNlczptZXNzYWdlLWlkJzogJ2ZhbHNlJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgJ2ttczpFbmNyeXB0aW9uQ29udGV4dDphd3M6c2VzOnNvdXJjZS1hY2NvdW50Jzoge1xuICAgICAgICAgICAgICBSZWY6ICdBV1M6OkFjY291bnRJZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgUHJpbmNpcGFsOiB7XG4gICAgICAgICAgU2VydmljZTogJ3Nlcy5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgfSxcbiAgICAgICAgUmVzb3VyY2U6ICcqJyxcbiAgICAgIH1dKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdhZGQgc25zIGFjdGlvbicsICgpID0+IHtcbiAgcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuU25zKHtcbiAgICBlbmNvZGluZzogYWN0aW9ucy5FbWFpbEVuY29kaW5nLkJBU0U2NCxcbiAgICB0b3BpYyxcbiAgfSkpO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OlNFUzo6UmVjZWlwdFJ1bGUnLCB7XG4gICAgUnVsZToge1xuICAgICAgQWN0aW9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgU05TQWN0aW9uOiB7XG4gICAgICAgICAgICBFbmNvZGluZzogJ0Jhc2U2NCcsXG4gICAgICAgICAgICBUb3BpY0Fybjoge1xuICAgICAgICAgICAgICBSZWY6ICdUb3BpY0JGQzdBRjZFJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBFbmFibGVkOiB0cnVlLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2FkZCBzdG9wIGFjdGlvbicsICgpID0+IHtcbiAgcnVsZS5hZGRBY3Rpb24obmV3IGFjdGlvbnMuU3RvcCh7XG4gICAgdG9waWMsXG4gIH0pKTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpTRVM6OlJlY2VpcHRSdWxlJywge1xuICAgIFJ1bGU6IHtcbiAgICAgIEFjdGlvbnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIFN0b3BBY3Rpb246IHtcbiAgICAgICAgICAgIFNjb3BlOiAnUnVsZVNldCcsXG4gICAgICAgICAgICBUb3BpY0Fybjoge1xuICAgICAgICAgICAgICBSZWY6ICdUb3BpY0JGQzdBRjZFJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBFbmFibGVkOiB0cnVlLFxuICAgIH0sXG4gIH0pO1xufSk7XG4iXX0=