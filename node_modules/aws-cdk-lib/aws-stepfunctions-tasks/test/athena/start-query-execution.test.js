"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const sfn = require("../../../aws-stepfunctions");
const cdk = require("../../../core");
const start_query_execution_1 = require("../../lib/athena/start-query-execution");
describe('Start Query Execution', () => {
    test('default settings', () => {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        const task = new start_query_execution_1.AthenaStartQueryExecution(stack, 'Query', {
            queryString: 'CREATE DATABASE database',
            clientRequestToken: 'unique-client-request-token',
            queryExecutionContext: {
                databaseName: 'mydatabase',
                catalogName: 'AwsDataCatalog',
            },
            resultConfiguration: {
                encryptionConfiguration: { encryptionOption: start_query_execution_1.EncryptionOption.S3_MANAGED },
                outputLocation: {
                    bucketName: 'query-results-bucket',
                    objectKey: 'folder',
                },
            },
            workGroup: 'primary',
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::athena:startQueryExecution',
                    ],
                ],
            },
            End: true,
            Parameters: {
                QueryString: 'CREATE DATABASE database',
                ClientRequestToken: 'unique-client-request-token',
                QueryExecutionContext: {
                    Database: 'mydatabase',
                    Catalog: 'AwsDataCatalog',
                },
                ResultConfiguration: {
                    EncryptionConfiguration: { EncryptionOption: start_query_execution_1.EncryptionOption.S3_MANAGED },
                    OutputLocation: 's3://query-results-bucket/folder/',
                },
                WorkGroup: 'primary',
            },
        });
    });
    test('sync integrationPattern', () => {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        const task = new start_query_execution_1.AthenaStartQueryExecution(stack, 'Query', {
            integrationPattern: sfn.IntegrationPattern.RUN_JOB,
            queryString: 'CREATE DATABASE database',
            queryExecutionContext: {
                databaseName: 'mydatabase',
            },
            resultConfiguration: {
                encryptionConfiguration: { encryptionOption: start_query_execution_1.EncryptionOption.S3_MANAGED },
            },
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::athena:startQueryExecution.sync',
                    ],
                ],
            },
            End: true,
            Parameters: {
                QueryString: 'CREATE DATABASE database',
                QueryExecutionContext: {
                    Database: 'mydatabase',
                },
                ResultConfiguration: {
                    EncryptionConfiguration: { EncryptionOption: start_query_execution_1.EncryptionOption.S3_MANAGED },
                },
            },
        });
    });
    test('no encryptionConfiguration', () => {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        const task = new start_query_execution_1.AthenaStartQueryExecution(stack, 'Query', {
            queryString: 'CREATE DATABASE database',
            clientRequestToken: 'unique-client-request-token',
            queryExecutionContext: {
                databaseName: 'mydatabase',
                catalogName: 'AwsDataCatalog',
            },
            resultConfiguration: {
                outputLocation: {
                    bucketName: 'query-results-bucket',
                    objectKey: 'folder',
                },
            },
            workGroup: 'primary',
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::athena:startQueryExecution',
                    ],
                ],
            },
            End: true,
            Parameters: {
                QueryString: 'CREATE DATABASE database',
                ClientRequestToken: 'unique-client-request-token',
                QueryExecutionContext: {
                    Database: 'mydatabase',
                    Catalog: 'AwsDataCatalog',
                },
                ResultConfiguration: {
                    OutputLocation: 's3://query-results-bucket/folder/',
                },
                WorkGroup: 'primary',
            },
        });
    });
    test('omit QueryExecutionContext if no catalog or database name provided', () => {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        const task = new start_query_execution_1.AthenaStartQueryExecution(stack, 'Query', {
            queryString: 'CREATE DATABASE database',
            clientRequestToken: 'unique-client-request-token',
            resultConfiguration: {
                outputLocation: {
                    bucketName: 'query-results-bucket',
                    objectKey: 'folder',
                },
            },
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).not.toHaveProperty('Parameters.QueryExecutionContext');
    });
    test('bucket arn is formatted as expected in generated policy', () => {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        const task = new start_query_execution_1.AthenaStartQueryExecution(stack, 'Query', {
            queryString: 'CREATE DATABASE database',
            clientRequestToken: 'unique-client-request-token',
            resultConfiguration: {
                outputLocation: {
                    bucketName: 'query-results-bucket',
                    objectKey: 'folder',
                },
            },
        });
        new sfn.StateMachine(stack, 'StateMachine', {
            definition: task,
        });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: assertions_1.Match.objectLike({
                Statement: assertions_1.Match.arrayWith([
                    {
                        Action: [
                            's3:AbortMultipartUpload',
                            's3:ListBucketMultipartUploads',
                            's3:ListMultipartUploadParts',
                            's3:PutObject',
                        ],
                        Effect: 'Allow',
                        Resource: {
                            'Fn::Join': [
                                '',
                                [
                                    'arn:',
                                    {
                                        Ref: 'AWS::Partition',
                                    },
                                    ':s3:::query-results-bucket/folder',
                                ],
                            ],
                        },
                    },
                ]),
            }),
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtcXVlcnktZXhlY3V0aW9uLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1xdWVyeS1leGVjdXRpb24udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRDtBQUN0RCxrREFBa0Q7QUFDbEQscUNBQXFDO0FBQ3JDLGtGQUFxRztBQUVyRyxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO0lBRXJDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDNUIsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRTlCLE9BQU87UUFDUCxNQUFNLElBQUksR0FBRyxJQUFJLGlEQUF5QixDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUU7WUFDekQsV0FBVyxFQUFFLDBCQUEwQjtZQUN2QyxrQkFBa0IsRUFBRSw2QkFBNkI7WUFDakQscUJBQXFCLEVBQUU7Z0JBQ3JCLFlBQVksRUFBRSxZQUFZO2dCQUMxQixXQUFXLEVBQUUsZ0JBQWdCO2FBQzlCO1lBQ0QsbUJBQW1CLEVBQUU7Z0JBQ25CLHVCQUF1QixFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsd0NBQWdCLENBQUMsVUFBVSxFQUFFO2dCQUMxRSxjQUFjLEVBQUU7b0JBQ2QsVUFBVSxFQUFFLHNCQUFzQjtvQkFDbEMsU0FBUyxFQUFFLFFBQVE7aUJBQ3BCO2FBQ0Y7WUFDRCxTQUFTLEVBQUUsU0FBUztTQUNyQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDaEQsSUFBSSxFQUFFLE1BQU07WUFDWixRQUFRLEVBQUU7Z0JBQ1IsVUFBVSxFQUFFO29CQUNWLEVBQUU7b0JBQ0Y7d0JBQ0UsTUFBTTt3QkFDTjs0QkFDRSxHQUFHLEVBQUUsZ0JBQWdCO3lCQUN0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QUcsSUFBSSxpREFBeUIsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFO1lBQ3pELFdBQVcsRUFBRSwwQkFBMEI7WUFDdkMsa0JBQWtCLEVBQUUsNkJBQTZCO1lBQ2pELG1CQUFtQixFQUFFO2dCQUNuQixjQUFjLEVBQUU7b0JBQ2QsVUFBVSxFQUFFLHNCQUFzQjtvQkFDbEMsU0FBUyxFQUFFLFFBQVE7aUJBQ3BCO2FBQ0Y7U0FDRixDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRTtZQUMxQyxVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLEVBQUU7WUFDbEUsY0FBYyxFQUFFLGtCQUFLLENBQUMsVUFBVSxDQUFDO2dCQUMvQixTQUFTLEVBQUUsa0JBQUssQ0FBQyxTQUFTLENBQUM7b0JBQ3pCO3dCQUNFLE1BQU0sRUFBRTs0QkFDTix5QkFBeUI7NEJBQ3pCLCtCQUErQjs0QkFDL0IsNkJBQTZCOzRCQUM3QixjQUFjO3lCQUNmO3dCQUNELE1BQU0sRUFBRSxPQUFPO3dCQUNmLFFBQVEsRUFBRTs0QkFDUixVQUFVLEVBQUU7Z0NBQ1YsRUFBRTtnQ0FDRjtvQ0FDRSxNQUFNO29DQUNOO3dDQUNFLEdBQUcsRUFBRSxnQkFBZ0I7cUNBQ3RCO29DQUNELG1DQUFtQztpQ0FDcEM7NkJBQ0Y7eUJBQ0Y7cUJBQ0Y7aUJBQ0YsQ0FBQzthQUNILENBQUM7U0FDSCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUsIE1hdGNoIH0gZnJvbSAnLi4vLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBzZm4gZnJvbSAnLi4vLi4vLi4vYXdzLXN0ZXBmdW5jdGlvbnMnO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgQXRoZW5hU3RhcnRRdWVyeUV4ZWN1dGlvbiwgRW5jcnlwdGlvbk9wdGlvbiB9IGZyb20gJy4uLy4uL2xpYi9hdGhlbmEvc3RhcnQtcXVlcnktZXhlY3V0aW9uJztcblxuZGVzY3JpYmUoJ1N0YXJ0IFF1ZXJ5IEV4ZWN1dGlvbicsICgpID0+IHtcblxuICB0ZXN0KCdkZWZhdWx0IHNldHRpbmdzJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBBdGhlbmFTdGFydFF1ZXJ5RXhlY3V0aW9uKHN0YWNrLCAnUXVlcnknLCB7XG4gICAgICBxdWVyeVN0cmluZzogJ0NSRUFURSBEQVRBQkFTRSBkYXRhYmFzZScsXG4gICAgICBjbGllbnRSZXF1ZXN0VG9rZW46ICd1bmlxdWUtY2xpZW50LXJlcXVlc3QtdG9rZW4nLFxuICAgICAgcXVlcnlFeGVjdXRpb25Db250ZXh0OiB7XG4gICAgICAgIGRhdGFiYXNlTmFtZTogJ215ZGF0YWJhc2UnLFxuICAgICAgICBjYXRhbG9nTmFtZTogJ0F3c0RhdGFDYXRhbG9nJyxcbiAgICAgIH0sXG4gICAgICByZXN1bHRDb25maWd1cmF0aW9uOiB7XG4gICAgICAgIGVuY3J5cHRpb25Db25maWd1cmF0aW9uOiB7IGVuY3J5cHRpb25PcHRpb246IEVuY3J5cHRpb25PcHRpb24uUzNfTUFOQUdFRCB9LFxuICAgICAgICBvdXRwdXRMb2NhdGlvbjoge1xuICAgICAgICAgIGJ1Y2tldE5hbWU6ICdxdWVyeS1yZXN1bHRzLWJ1Y2tldCcsXG4gICAgICAgICAgb2JqZWN0S2V5OiAnZm9sZGVyJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICB3b3JrR3JvdXA6ICdwcmltYXJ5JyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICAgIFR5cGU6ICdUYXNrJyxcbiAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnOnN0YXRlczo6OmF0aGVuYTpzdGFydFF1ZXJ5RXhlY3V0aW9uJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgUXVlcnlTdHJpbmc6ICdDUkVBVEUgREFUQUJBU0UgZGF0YWJhc2UnLFxuICAgICAgICBDbGllbnRSZXF1ZXN0VG9rZW46ICd1bmlxdWUtY2xpZW50LXJlcXVlc3QtdG9rZW4nLFxuICAgICAgICBRdWVyeUV4ZWN1dGlvbkNvbnRleHQ6IHtcbiAgICAgICAgICBEYXRhYmFzZTogJ215ZGF0YWJhc2UnLFxuICAgICAgICAgIENhdGFsb2c6ICdBd3NEYXRhQ2F0YWxvZycsXG4gICAgICAgIH0sXG4gICAgICAgIFJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICBFbmNyeXB0aW9uQ29uZmlndXJhdGlvbjogeyBFbmNyeXB0aW9uT3B0aW9uOiBFbmNyeXB0aW9uT3B0aW9uLlMzX01BTkFHRUQgfSxcbiAgICAgICAgICBPdXRwdXRMb2NhdGlvbjogJ3MzOi8vcXVlcnktcmVzdWx0cy1idWNrZXQvZm9sZGVyLycsXG4gICAgICAgIH0sXG4gICAgICAgIFdvcmtHcm91cDogJ3ByaW1hcnknLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnc3luYyBpbnRlZ3JhdGlvblBhdHRlcm4nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0YXNrID0gbmV3IEF0aGVuYVN0YXJ0UXVlcnlFeGVjdXRpb24oc3RhY2ssICdRdWVyeScsIHtcbiAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5SVU5fSk9CLFxuICAgICAgcXVlcnlTdHJpbmc6ICdDUkVBVEUgREFUQUJBU0UgZGF0YWJhc2UnLFxuICAgICAgcXVlcnlFeGVjdXRpb25Db250ZXh0OiB7XG4gICAgICAgIGRhdGFiYXNlTmFtZTogJ215ZGF0YWJhc2UnLFxuICAgICAgfSxcbiAgICAgIHJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgZW5jcnlwdGlvbkNvbmZpZ3VyYXRpb246IHsgZW5jcnlwdGlvbk9wdGlvbjogRW5jcnlwdGlvbk9wdGlvbi5TM19NQU5BR0VEIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvRXF1YWwoe1xuICAgICAgVHlwZTogJ1Rhc2snLFxuICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICc6c3RhdGVzOjo6YXRoZW5hOnN0YXJ0UXVlcnlFeGVjdXRpb24uc3luYycsXG4gICAgICAgICAgXSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgICBFbmQ6IHRydWUsXG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIFF1ZXJ5U3RyaW5nOiAnQ1JFQVRFIERBVEFCQVNFIGRhdGFiYXNlJyxcbiAgICAgICAgUXVlcnlFeGVjdXRpb25Db250ZXh0OiB7XG4gICAgICAgICAgRGF0YWJhc2U6ICdteWRhdGFiYXNlJyxcbiAgICAgICAgfSxcbiAgICAgICAgUmVzdWx0Q29uZmlndXJhdGlvbjoge1xuICAgICAgICAgIEVuY3J5cHRpb25Db25maWd1cmF0aW9uOiB7IEVuY3J5cHRpb25PcHRpb246IEVuY3J5cHRpb25PcHRpb24uUzNfTUFOQUdFRCB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnbm8gZW5jcnlwdGlvbkNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBjZGsuU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0YXNrID0gbmV3IEF0aGVuYVN0YXJ0UXVlcnlFeGVjdXRpb24oc3RhY2ssICdRdWVyeScsIHtcbiAgICAgIHF1ZXJ5U3RyaW5nOiAnQ1JFQVRFIERBVEFCQVNFIGRhdGFiYXNlJyxcbiAgICAgIGNsaWVudFJlcXVlc3RUb2tlbjogJ3VuaXF1ZS1jbGllbnQtcmVxdWVzdC10b2tlbicsXG4gICAgICBxdWVyeUV4ZWN1dGlvbkNvbnRleHQ6IHtcbiAgICAgICAgZGF0YWJhc2VOYW1lOiAnbXlkYXRhYmFzZScsXG4gICAgICAgIGNhdGFsb2dOYW1lOiAnQXdzRGF0YUNhdGFsb2cnLFxuICAgICAgfSxcbiAgICAgIHJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgb3V0cHV0TG9jYXRpb246IHtcbiAgICAgICAgICBidWNrZXROYW1lOiAncXVlcnktcmVzdWx0cy1idWNrZXQnLFxuICAgICAgICAgIG9iamVjdEtleTogJ2ZvbGRlcicsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgd29ya0dyb3VwOiAncHJpbWFyeScsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9FcXVhbCh7XG4gICAgICBUeXBlOiAnVGFzaycsXG4gICAgICBSZXNvdXJjZToge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJzpzdGF0ZXM6OjphdGhlbmE6c3RhcnRRdWVyeUV4ZWN1dGlvbicsXG4gICAgICAgICAgXSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgICBFbmQ6IHRydWUsXG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIFF1ZXJ5U3RyaW5nOiAnQ1JFQVRFIERBVEFCQVNFIGRhdGFiYXNlJyxcbiAgICAgICAgQ2xpZW50UmVxdWVzdFRva2VuOiAndW5pcXVlLWNsaWVudC1yZXF1ZXN0LXRva2VuJyxcbiAgICAgICAgUXVlcnlFeGVjdXRpb25Db250ZXh0OiB7XG4gICAgICAgICAgRGF0YWJhc2U6ICdteWRhdGFiYXNlJyxcbiAgICAgICAgICBDYXRhbG9nOiAnQXdzRGF0YUNhdGFsb2cnLFxuICAgICAgICB9LFxuICAgICAgICBSZXN1bHRDb25maWd1cmF0aW9uOiB7XG4gICAgICAgICAgT3V0cHV0TG9jYXRpb246ICdzMzovL3F1ZXJ5LXJlc3VsdHMtYnVja2V0L2ZvbGRlci8nLFxuICAgICAgICB9LFxuICAgICAgICBXb3JrR3JvdXA6ICdwcmltYXJ5JyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ29taXQgUXVlcnlFeGVjdXRpb25Db250ZXh0IGlmIG5vIGNhdGFsb2cgb3IgZGF0YWJhc2UgbmFtZSBwcm92aWRlZCcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHRhc2sgPSBuZXcgQXRoZW5hU3RhcnRRdWVyeUV4ZWN1dGlvbihzdGFjaywgJ1F1ZXJ5Jywge1xuICAgICAgcXVlcnlTdHJpbmc6ICdDUkVBVEUgREFUQUJBU0UgZGF0YWJhc2UnLFxuICAgICAgY2xpZW50UmVxdWVzdFRva2VuOiAndW5pcXVlLWNsaWVudC1yZXF1ZXN0LXRva2VuJyxcbiAgICAgIHJlc3VsdENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgb3V0cHV0TG9jYXRpb246IHtcbiAgICAgICAgICBidWNrZXROYW1lOiAncXVlcnktcmVzdWx0cy1idWNrZXQnLFxuICAgICAgICAgIG9iamVjdEtleTogJ2ZvbGRlcicsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuXG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkubm90LnRvSGF2ZVByb3BlcnR5KCdQYXJhbWV0ZXJzLlF1ZXJ5RXhlY3V0aW9uQ29udGV4dCcpO1xuICB9KTtcblxuICB0ZXN0KCdidWNrZXQgYXJuIGlzIGZvcm1hdHRlZCBhcyBleHBlY3RlZCBpbiBnZW5lcmF0ZWQgcG9saWN5JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBBdGhlbmFTdGFydFF1ZXJ5RXhlY3V0aW9uKHN0YWNrLCAnUXVlcnknLCB7XG4gICAgICBxdWVyeVN0cmluZzogJ0NSRUFURSBEQVRBQkFTRSBkYXRhYmFzZScsXG4gICAgICBjbGllbnRSZXF1ZXN0VG9rZW46ICd1bmlxdWUtY2xpZW50LXJlcXVlc3QtdG9rZW4nLFxuICAgICAgcmVzdWx0Q29uZmlndXJhdGlvbjoge1xuICAgICAgICBvdXRwdXRMb2NhdGlvbjoge1xuICAgICAgICAgIGJ1Y2tldE5hbWU6ICdxdWVyeS1yZXN1bHRzLWJ1Y2tldCcsXG4gICAgICAgICAgb2JqZWN0S2V5OiAnZm9sZGVyJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1N0YXRlTWFjaGluZScsIHtcbiAgICAgIGRlZmluaXRpb246IHRhc2ssXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICBQb2xpY3lEb2N1bWVudDogTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgIFN0YXRlbWVudDogTWF0Y2guYXJyYXlXaXRoKFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBBY3Rpb246IFtcbiAgICAgICAgICAgICAgJ3MzOkFib3J0TXVsdGlwYXJ0VXBsb2FkJyxcbiAgICAgICAgICAgICAgJ3MzOkxpc3RCdWNrZXRNdWx0aXBhcnRVcGxvYWRzJyxcbiAgICAgICAgICAgICAgJ3MzOkxpc3RNdWx0aXBhcnRVcGxvYWRQYXJ0cycsXG4gICAgICAgICAgICAgICdzMzpQdXRPYmplY3QnLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAgICAgICAnJyxcbiAgICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAnOnMzOjo6cXVlcnktcmVzdWx0cy1idWNrZXQvZm9sZGVyJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdKSxcbiAgICAgIH0pLFxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19