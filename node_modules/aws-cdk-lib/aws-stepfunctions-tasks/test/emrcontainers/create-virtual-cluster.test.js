"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const eks = require("../../../aws-eks");
const sfn = require("../../../aws-stepfunctions");
const core_1 = require("../../../core");
const create_virtual_cluster_1 = require("../../lib/emrcontainers/create-virtual-cluster");
const emrContainersVirtualClusterName = 'EMR Containers Virtual Cluster';
let stack;
let clusterId;
beforeEach(() => {
    stack = new core_1.Stack();
    clusterId = 'test-eks';
});
describe('Invoke emr-containers CreateVirtualCluster with ', () => {
    test('only required properties', () => {
        // WHEN
        const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::emr-containers:createVirtualCluster',
                    ],
                ],
            },
            End: true,
            Parameters: {
                'Name.$': "States.Format('{}/{}', $$.Execution.Name, $$.State.Name)",
                'ContainerProvider': {
                    Id: clusterId,
                    Info: {
                        EksInfo: {
                            Namespace: 'default',
                        },
                    },
                    Type: 'EKS',
                },
            },
        });
    });
    test('all required/non-required properties', () => {
        // WHEN
        const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
            virtualClusterName: emrContainersVirtualClusterName,
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
            eksNamespace: 'namespace',
            integrationPattern: sfn.IntegrationPattern.REQUEST_RESPONSE,
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toMatchObject({
            Parameters: {
                Name: emrContainersVirtualClusterName,
                ContainerProvider: {
                    Id: clusterId,
                    Info: {
                        EksInfo: {
                            Namespace: 'namespace',
                        },
                    },
                },
            },
        });
    });
    test('clusterId from payload', () => {
        // WHEN
        const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromJsonPathAt('$.ClusterId')),
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toMatchObject({
            Parameters: {
                ContainerProvider: {
                    'Id.$': '$.ClusterId',
                },
            },
        });
    });
    test('with an existing EKS cluster', () => {
        // WHEN
        const eksCluster = new eks.Cluster(stack, 'EKS Cluster', {
            version: eks.KubernetesVersion.V1_20,
        });
        const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromCluster(eksCluster),
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toMatchObject({
            Parameters: {
                ContainerProvider: {
                    Id: {
                        Ref: 'EKSClusterEDAD5FD1',
                    },
                },
            },
        });
    });
    test('Tags', () => {
        // WHEN
        const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
            tags: {
                key: 'value',
            },
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toMatchObject({
            Parameters: {
                Tags: {
                    key: 'value',
                },
            },
        });
    });
});
test('Permitted role actions included for CreateVirtualCluster if service integration pattern is REQUEST_RESPONSE', () => {
    // WHEN
    const task = new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'Task', {
        virtualClusterName: emrContainersVirtualClusterName,
        eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    // THEN
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [{
                    Action: 'emr-containers:CreateVirtualCluster',
                    Effect: 'Allow',
                    Resource: '*',
                },
                {
                    Action: 'iam:CreateServiceLinkedRole',
                    Condition: {
                        StringLike: {
                            'iam:AWSServiceName': 'emr-containers.amazonaws.com',
                        },
                    },
                    Effect: 'Allow',
                    Resource: {
                        'Fn::Join': [
                            '',
                            [
                                'arn:',
                                {
                                    Ref: 'AWS::Partition',
                                },
                                ':iam::',
                                {
                                    Ref: 'AWS::AccountId',
                                },
                                ':role/aws-service-role/emr-containers.amazonaws.com/AWSServiceRoleForAmazonEMRContainers',
                            ],
                        ],
                    },
                }],
        },
    });
});
test('Task throws if WAIT_FOR_TASK_TOKEN is supplied as service integration pattern', () => {
    expect(() => {
        new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'EMR Containers CreateVirtualCluster Job', {
            virtualClusterName: emrContainersVirtualClusterName,
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
            integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
        });
    }).toThrow(/Unsupported service integration pattern. Supported Patterns: REQUEST_RESPONSE. Received: WAIT_FOR_TASK_TOKEN/);
});
test('Task throws if RUN_JOB is supplied as service integration pattern', () => {
    expect(() => {
        new create_virtual_cluster_1.EmrContainersCreateVirtualCluster(stack, 'EMR Containers CreateVirtualCluster Job', {
            virtualClusterName: emrContainersVirtualClusterName,
            eksCluster: create_virtual_cluster_1.EksClusterInput.fromTaskInput(sfn.TaskInput.fromText(clusterId)),
            integrationPattern: sfn.IntegrationPattern.RUN_JOB,
        });
    }).toThrow(/Unsupported service integration pattern. Supported Patterns: REQUEST_RESPONSE. Received: RUN_JOB/);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLXZpcnR1YWwtY2x1c3Rlci50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLXZpcnR1YWwtY2x1c3Rlci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0RBQStDO0FBQy9DLHdDQUF3QztBQUN4QyxrREFBa0Q7QUFDbEQsd0NBQXNDO0FBQ3RDLDJGQUFvSDtBQUVwSCxNQUFNLCtCQUErQixHQUFHLGdDQUFnQyxDQUFDO0FBQ3pFLElBQUksS0FBWSxDQUFDO0FBQ2pCLElBQUksU0FBaUIsQ0FBQztBQUV0QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7SUFDcEIsU0FBUyxHQUFHLFVBQVUsQ0FBQztBQUN6QixDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7SUFDaEUsSUFBSSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtRQUNwQyxPQUFPO1FBQ1AsTUFBTSxJQUFJLEdBQUcsSUFBSSwwREFBaUMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1lBQ2hFLFVBQVUsRUFBRSx3Q0FBZSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUM3RSxDQUFDLENBQUM7UUFFSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtZQUNoQyxVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDaEQsSUFBSSxFQUFFLE1BQU07WUFDWixRQUFRLEVBQUU7Z0JBQ1IsVUFBVSxFQUFFO29CQUNWLEVBQUU7b0JBQ0Y7d0JBQ0UsTUFBTTt3QkFDTjs0QkFDRSxH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RUFBbUUsRUFBRSxHQUFHLEVBQUU7SUFDN0UsTUFBTSxDQUFDLEdBQUcsRUFBRTtRQUNWLElBQUksMERBQWlDLENBQUMsS0FBSyxFQUFFLHlDQUF5QyxFQUFFO1lBQ3RGLGtCQUFrQixFQUFFLCtCQUErQjtZQUNuRCxVQUFVLEVBQUUsd0NBQWUsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUUsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGtCQUFrQixDQUFDLE9BQU87U0FDbkQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGtHQUFrRyxDQUFDLENBQUM7QUFDakgsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgZWtzIGZyb20gJy4uLy4uLy4uL2F3cy1la3MnO1xuaW1wb3J0ICogYXMgc2ZuIGZyb20gJy4uLy4uLy4uL2F3cy1zdGVwZnVuY3Rpb25zJztcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBFbXJDb250YWluZXJzQ3JlYXRlVmlydHVhbENsdXN0ZXIsIEVrc0NsdXN0ZXJJbnB1dCB9IGZyb20gJy4uLy4uL2xpYi9lbXJjb250YWluZXJzL2NyZWF0ZS12aXJ0dWFsLWNsdXN0ZXInO1xuXG5jb25zdCBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lID0gJ0VNUiBDb250YWluZXJzIFZpcnR1YWwgQ2x1c3Rlcic7XG5sZXQgc3RhY2s6IFN0YWNrO1xubGV0IGNsdXN0ZXJJZDogc3RyaW5nO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY2x1c3RlcklkID0gJ3Rlc3QtZWtzJztcbn0pO1xuXG5kZXNjcmliZSgnSW52b2tlIGVtci1jb250YWluZXJzIENyZWF0ZVZpcnR1YWxDbHVzdGVyIHdpdGggJywgKCkgPT4ge1xuICB0ZXN0KCdvbmx5IHJlcXVpcmVkIHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHRhc2sgPSBuZXcgRW1yQ29udGFpbmVyc0NyZWF0ZVZpcnR1YWxDbHVzdGVyKHN0YWNrLCAnVGFzaycsIHtcbiAgICAgIGVrc0NsdXN0ZXI6IEVrc0NsdXN0ZXJJbnB1dC5mcm9tVGFza0lucHV0KHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoY2x1c3RlcklkKSksXG4gICAgfSk7XG5cbiAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1NNJywge1xuICAgICAgZGVmaW5pdGlvbjogdGFzayxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICAgIFR5cGU6ICdUYXNrJyxcbiAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnOnN0YXRlczo6OmVtci1jb250YWluZXJzOmNyZWF0ZVZpcnR1YWxDbHVzdGVyJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgJ05hbWUuJCc6IFwiU3RhdGVzLkZvcm1hdCgne30ve30nLCAkJC5FeGVjdXRpb24uTmFtZSwgJCQuU3RhdGUuTmFtZSlcIixcbiAgICAgICAgJ0NvbnRhaW5lclByb3ZpZGVyJzoge1xuICAgICAgICAgIElkOiBjbHVzdGVySWQsXG4gICAgICAgICAgSW5mbzoge1xuICAgICAgICAgICAgRWtzSW5mbzoge1xuICAgICAgICAgICAgICBOYW1lc3BhY2U6ICdkZWZhdWx0JyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBUeXBlOiAnRUtTJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2FsbCByZXF1aXJlZC9ub24tcmVxdWlyZWQgcHJvcGVydGllcycsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBFbXJDb250YWluZXJzQ3JlYXRlVmlydHVhbENsdXN0ZXIoc3RhY2ssICdUYXNrJywge1xuICAgICAgdmlydHVhbENsdXN0ZXJOYW1lOiBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lLFxuICAgICAgZWtzQ2x1c3RlcjogRWtzQ2x1c3RlcklucHV0LmZyb21UYXNrSW5wdXQoc2ZuLlRhc2tJbnB1dC5mcm9tVGV4dChjbHVzdGVySWQpKSxcbiAgICAgIGVrc05hbWVzcGFjZTogJ25hbWVzcGFjZScsXG4gICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5JbnRlZ3JhdGlvblBhdHRlcm4uUkVRVUVTVF9SRVNQT05TRSxcbiAgICB9KTtcblxuICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU00nLCB7XG4gICAgICBkZWZpbml0aW9uOiB0YXNrLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICBOYW1lOiBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lLFxuICAgICAgICBDb250YWluZXJQcm92aWRlcjoge1xuICAgICAgICAgIElkOiBjbHVzdGVySWQsXG4gICAgICAgICAgSW5mbzoge1xuICAgICAgICAgICAgRWtzSW5mbzoge1xuICAgICAgICAgICAgICBOYW1lc3BhY2U6ICduYW1lc3BhY2UnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnY2x1c3RlcklkIGZyb20gcGF5bG9hZCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBFbXJDb250YWluZXJzQ3JlYXRlVmlydHVhbENsdXN0ZXIoc3RhY2ssICdUYXNrJywge1xuICAgICAgZWtzQ2x1c3RlcjogRWtzQ2x1c3RlcklucHV0LmZyb21UYXNrSW5wdXQoc2ZuLlRhc2tJbnB1dC5mcm9tSnNvblBhdGhBdCgnJC5DbHVzdGVySWQnKSksXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9NYXRjaE9iamVjdCh7XG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIENvbnRhaW5lclByb3ZpZGVyOiB7XG4gICAgICAgICAgJ0lkLiQnOiAnJC5DbHVzdGVySWQnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnd2l0aCBhbiBleGlzdGluZyBFS1MgY2x1c3RlcicsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgZWtzQ2x1c3RlciA9IG5ldyBla3MuQ2x1c3RlcihzdGFjaywgJ0VLUyBDbHVzdGVyJywge1xuICAgICAgdmVyc2lvbjogZWtzLkt1YmVybmV0ZXNWZXJzaW9uLlYxXzIwLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdGFzayA9IG5ldyBFbXJDb250YWluZXJzQ3JlYXRlVmlydHVhbENsdXN0ZXIoc3RhY2ssICdUYXNrJywge1xuICAgICAgZWtzQ2x1c3RlcjogRWtzQ2x1c3RlcklucHV0LmZyb21DbHVzdGVyKGVrc0NsdXN0ZXIpLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICBDb250YWluZXJQcm92aWRlcjoge1xuICAgICAgICAgIElkOiB7XG4gICAgICAgICAgICBSZWY6ICdFS1NDbHVzdGVyRURBRDVGRDEnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdUYWdzJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0YXNrID0gbmV3IEVtckNvbnRhaW5lcnNDcmVhdGVWaXJ0dWFsQ2x1c3RlcihzdGFjaywgJ1Rhc2snLCB7XG4gICAgICBla3NDbHVzdGVyOiBFa3NDbHVzdGVySW5wdXQuZnJvbVRhc2tJbnB1dChzZm4uVGFza0lucHV0LmZyb21UZXh0KGNsdXN0ZXJJZCkpLFxuICAgICAgdGFnczoge1xuICAgICAgICBrZXk6ICd2YWx1ZScsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUoc3RhY2ssICdTTScsIHtcbiAgICAgIGRlZmluaXRpb246IHRhc2ssXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9NYXRjaE9iamVjdCh7XG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIFRhZ3M6IHtcbiAgICAgICAgICBrZXk6ICd2YWx1ZScsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn0pO1xuXG50ZXN0KCdQZXJtaXR0ZWQgcm9sZSBhY3Rpb25zIGluY2x1ZGVkIGZvciBDcmVhdGVWaXJ0dWFsQ2x1c3RlciBpZiBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4gaXMgUkVRVUVTVF9SRVNQT05TRScsICgpID0+IHtcbiAgLy8gV0hFTlxuICBjb25zdCB0YXNrID0gbmV3IEVtckNvbnRhaW5lcnNDcmVhdGVWaXJ0dWFsQ2x1c3RlcihzdGFjaywgJ1Rhc2snLCB7XG4gICAgdmlydHVhbENsdXN0ZXJOYW1lOiBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lLFxuICAgIGVrc0NsdXN0ZXI6IEVrc0NsdXN0ZXJJbnB1dC5mcm9tVGFza0lucHV0KHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoY2x1c3RlcklkKSksXG4gIH0pO1xuXG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU00nLCB7XG4gICAgZGVmaW5pdGlvbjogdGFzayxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgU3RhdGVtZW50OiBbe1xuICAgICAgICBBY3Rpb246ICdlbXItY29udGFpbmVyczpDcmVhdGVWaXJ0dWFsQ2x1c3RlcicsXG4gICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgUmVzb3VyY2U6ICcqJyxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIEFjdGlvbjogJ2lhbTpDcmVhdGVTZXJ2aWNlTGlua2VkUm9sZScsXG4gICAgICAgIENvbmRpdGlvbjoge1xuICAgICAgICAgIFN0cmluZ0xpa2U6IHtcbiAgICAgICAgICAgICdpYW06QVdTU2VydmljZU5hbWUnOiAnZW1yLWNvbnRhaW5lcnMuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICBSZXNvdXJjZToge1xuICAgICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICc6aWFtOjonLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgUmVmOiAnQVdTOjpBY2NvdW50SWQnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAnOnJvbGUvYXdzLXNlcnZpY2Utcm9sZS9lbXItY29udGFpbmVycy5hbWF6b25hd3MuY29tL0FXU1NlcnZpY2VSb2xlRm9yQW1hem9uRU1SQ29udGFpbmVycycsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICB9XSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdUYXNrIHRocm93cyBpZiBXQUlUX0ZPUl9UQVNLX1RPS0VOIGlzIHN1cHBsaWVkIGFzIHNlcnZpY2UgaW50ZWdyYXRpb24gcGF0dGVybicsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IHtcbiAgICBuZXcgRW1yQ29udGFpbmVyc0NyZWF0ZVZpcnR1YWxDbHVzdGVyKHN0YWNrLCAnRU1SIENvbnRhaW5lcnMgQ3JlYXRlVmlydHVhbENsdXN0ZXIgSm9iJywge1xuICAgICAgdmlydHVhbENsdXN0ZXJOYW1lOiBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lLFxuICAgICAgZWtzQ2x1c3RlcjogRWtzQ2x1c3RlcklucHV0LmZyb21UYXNrSW5wdXQoc2ZuLlRhc2tJbnB1dC5mcm9tVGV4dChjbHVzdGVySWQpKSxcbiAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOLFxuICAgIH0pO1xuICB9KS50b1Rocm93KC9VbnN1cHBvcnRlZCBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4uIFN1cHBvcnRlZCBQYXR0ZXJuczogUkVRVUVTVF9SRVNQT05TRS4gUmVjZWl2ZWQ6IFdBSVRfRk9SX1RBU0tfVE9LRU4vKTtcbn0pO1xuXG50ZXN0KCdUYXNrIHRocm93cyBpZiBSVU5fSk9CIGlzIHN1cHBsaWVkIGFzIHNlcnZpY2UgaW50ZWdyYXRpb24gcGF0dGVybicsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IHtcbiAgICBuZXcgRW1yQ29udGFpbmVyc0NyZWF0ZVZpcnR1YWxDbHVzdGVyKHN0YWNrLCAnRU1SIENvbnRhaW5lcnMgQ3JlYXRlVmlydHVhbENsdXN0ZXIgSm9iJywge1xuICAgICAgdmlydHVhbENsdXN0ZXJOYW1lOiBlbXJDb250YWluZXJzVmlydHVhbENsdXN0ZXJOYW1lLFxuICAgICAgZWtzQ2x1c3RlcjogRWtzQ2x1c3RlcklucHV0LmZyb21UYXNrSW5wdXQoc2ZuLlRhc2tJbnB1dC5mcm9tVGV4dChjbHVzdGVySWQpKSxcbiAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5SVU5fSk9CLFxuICAgIH0pO1xuICB9KS50b1Rocm93KC9VbnN1cHBvcnRlZCBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4uIFN1cHBvcnRlZCBQYXR0ZXJuczogUkVRVUVTVF9SRVNQT05TRS4gUmVjZWl2ZWQ6IFJVTl9KT0IvKTtcbn0pO1xuIl19