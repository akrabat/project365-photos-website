"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const events = require("../../../aws-events");
const sfn = require("../../../aws-stepfunctions");
const cdk = require("../../../core");
const put_events_1 = require("../../lib/eventbridge/put-events");
describe('Put Events', () => {
    let stack;
    beforeEach(() => {
        // GIVEN
        stack = new cdk.Stack();
    });
    test('provided all parameters', () => {
        // WHEN
        const task = new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
            entries: [{
                    detail: sfn.TaskInput.fromText('MyDetail'),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                }],
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::events:putEvents',
                    ],
                ],
            },
            End: true,
            Parameters: {
                Entries: [{
                        Detail: 'MyDetail',
                        DetailType: 'MyDetailType',
                        Source: 'my.source',
                    }],
            },
        });
    });
    test('provided detail as object', () => {
        // WHEN
        const task = new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
            entries: [{
                    detail: sfn.TaskInput.fromObject({
                        Message: 'MyDetailMessage',
                    }),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                }],
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::events:putEvents',
                    ],
                ],
            },
            End: true,
            Parameters: {
                Entries: [{
                        Detail: {
                            Message: 'MyDetailMessage',
                        },
                        DetailType: 'MyDetailType',
                        Source: 'my.source',
                    }],
            },
        });
    });
    test('wait for task token', () => {
        // WHEN
        const task = new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
            integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
            entries: [{
                    detail: sfn.TaskInput.fromObject({
                        Message: 'MyDetailMessage',
                        Token: sfn.JsonPath.taskToken,
                    }),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                }],
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::events:putEvents.waitForTaskToken',
                    ],
                ],
            },
            End: true,
            Parameters: {
                Entries: [{
                        Detail: {
                            'Message': 'MyDetailMessage',
                            'Token.$': '$$.Task.Token',
                        },
                        DetailType: 'MyDetailType',
                        Source: 'my.source',
                    }],
            },
        });
    });
    test('fails when WAIT_FOR_TASK_TOKEN integration pattern is used without supplying a task token in entries', () => {
        expect(() => {
            // WHEN
            new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
                integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
                entries: [{
                        detail: sfn.TaskInput.fromText('MyDetail'),
                        detailType: 'MyDetailType',
                        source: 'my.source',
                    }],
            });
            // THEN
        }).toThrowError('Task Token is required in `entries`. Use JsonPath.taskToken to set the token.');
    });
    test('fails when RUN_JOB integration pattern is used', () => {
        expect(() => {
            // WHEN
            new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
                integrationPattern: sfn.IntegrationPattern.RUN_JOB,
                entries: [{
                        detail: sfn.TaskInput.fromText('MyDetail'),
                        detailType: 'MyDetailType',
                        source: 'my.source',
                    }],
            });
            // THEN
        }).toThrowError('Unsupported service integration pattern');
    });
    test('provided EventBus', () => {
        // GIVEN
        const eventBus = new events.EventBus(stack, 'EventBus');
        // WHEN
        const task = new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
            entries: [{
                    eventBus,
                    detail: sfn.TaskInput.fromText('MyDetail'),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                }],
        });
        // THEN
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::events:putEvents',
                    ],
                ],
            },
            End: true,
            Parameters: {
                Entries: [{
                        EventBusName: {
                            'Fn::GetAtt': [
                                'EventBus7B8748AA',
                                'Arn',
                            ],
                        },
                        Detail: 'MyDetail',
                        DetailType: 'MyDetailType',
                        Source: 'my.source',
                    }],
            },
        });
    });
    test('fails when provided an empty array for entries', () => {
        expect(() => {
            // WHEN
            new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
                entries: [],
            });
        })
            // THEN
            .toThrowError('Value for property `entries` must be a non-empty array.');
    });
    test('Validate task policy', () => {
        // GIVEN
        const bus = new events.EventBus(stack, 'EventBus');
        // WHEN
        const task = new put_events_1.EventBridgePutEvents(stack, 'PutEvents', {
            entries: [{
                    detail: sfn.TaskInput.fromText('MyDetail'),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                    eventBus: bus,
                }, {
                    detail: sfn.TaskInput.fromText('MyDetail2'),
                    detailType: 'MyDetailType',
                    source: 'my.source',
                }],
        });
        new sfn.StateMachine(stack, 'State Machine', { definition: task });
        // THEN
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: [
                    {
                        Action: 'events:PutEvents',
                        Effect: 'Allow',
                        Resource: [
                            {
                                'Fn::GetAtt': [
                                    'EventBus7B8748AA',
                                    'Arn',
                                ],
                            },
                            {
                                'Fn::Join': [
                                    '',
                                    [
                                        'arn:',
                                        { Ref: 'AWS::Partition' },
                                        ':events:',
                                        { Ref: 'AWS::Region' },
                                        ':',
                                        { Ref: 'AWS::AccountId' },
                                        ':event-bus/default',
                                    ],
                                ],
                            },
                        ],
                    },
                ],
                Version: '2012-10-17',
            },
            Roles: [
                {
                    Ref: 'StateMachineRole543B9670',
                },
            ],
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHV0LWV2ZW50cy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHV0LWV2ZW50cy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0RBQStDO0FBQy9DLDhDQUE4QztBQUM5QyxrREFBa0Q7QUFDbEQscUNBQXFDO0FBQ3JDLGlFQUF3RTtBQUV4RSxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtJQUMxQixJQUFJLEtBQWdCLENBQUM7SUFFckIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFFBQVE7UUFDUixLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDMUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMseUJBQXlCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLE9BQU87UUFDUCxNQUFNLElBQUksR0FBRyxJQUFJLGlDQUFvQixDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUU7WUFDeEQsT0FBTyxFQUFFLENBQUM7b0JBQ1IsTUFBTSxFQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztvQkFDMUMsVUFBVSxFQUFFLGNBQWM7b0JBQzFCLE1BQU0sRUFBRSxXQUFXO2lCQUNwQixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQ2hELElBQUksRUFBRSxNQUFNO1lBQ1osUUFBUSxFQUFFO2dCQUNSLFVBQVUsRUFBRTtvQkFDVixFQUFFO29CQUNGO3dCQUNFLE1BQU07d0JBQ047NEJBQ0UsR0FBRyxFQUFFLGdCQUFnQjt5QkFDdEI7d0JBQ0QsNEJBQTRCO3FCQUM3QjtpQkFDRjthQUNGO1lBQ0QsR0FBRyxFQUFFLElBQUk7WUFDVCxVQUFVLEVBQUU7Z0JBQ1YsT0FBTyxFQUFFLENBQUM7d0JBQ1IsTUFBTSxFQUFF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Q3RCO1lBQ0QsS0FBSyxFQUFFO2dCQUNMO29CQUNFLEdBQUcsRUFBRSwwQkFBMEI7aUJBQ2hDO2FBQ0Y7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGV2ZW50cyBmcm9tICcuLi8uLi8uLi9hd3MtZXZlbnRzJztcbmltcG9ydCAqIGFzIHNmbiBmcm9tICcuLi8uLi8uLi9hd3Mtc3RlcGZ1bmN0aW9ucyc7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBFdmVudEJyaWRnZVB1dEV2ZW50cyB9IGZyb20gJy4uLy4uL2xpYi9ldmVudGJyaWRnZS9wdXQtZXZlbnRzJztcblxuZGVzY3JpYmUoJ1B1dCBFdmVudHMnLCAoKSA9PiB7XG4gIGxldCBzdGFjazogY2RrLlN0YWNrO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Byb3ZpZGVkIGFsbCBwYXJhbWV0ZXJzJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0YXNrID0gbmV3IEV2ZW50QnJpZGdlUHV0RXZlbnRzKHN0YWNrLCAnUHV0RXZlbnRzJywge1xuICAgICAgZW50cmllczogW3tcbiAgICAgICAgZGV0YWlsOiBzZm4uVGFza0lucHV0LmZyb21UZXh0KCdNeURldGFpbCcpLFxuICAgICAgICBkZXRhaWxUeXBlOiAnTXlEZXRhaWxUeXBlJyxcbiAgICAgICAgc291cmNlOiAnbXkuc291cmNlJyxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvRXF1YWwoe1xuICAgICAgVHlwZTogJ1Rhc2snLFxuICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICc6c3RhdGVzOjo6ZXZlbnRzOnB1dEV2ZW50cycsXG4gICAgICAgICAgXSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgICBFbmQ6IHRydWUsXG4gICAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICAgIEVudHJpZXM6IFt7XG4gICAgICAgICAgRGV0YWlsOiAnTXlEZXRhaWwnLFxuICAgICAgICAgIERldGFpbFR5cGU6ICdNeURldGFpbFR5cGUnLFxuICAgICAgICAgIFNvdXJjZTogJ215LnNvdXJjZScsXG4gICAgICAgIH1dLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgncHJvdmlkZWQgZGV0YWlsIGFzIG9iamVjdCcsICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBFdmVudEJyaWRnZVB1dEV2ZW50cyhzdGFjaywgJ1B1dEV2ZW50cycsIHtcbiAgICAgIGVudHJpZXM6IFt7XG4gICAgICAgIGRldGFpbDogc2ZuLlRhc2tJbnB1dC5mcm9tT2JqZWN0KHtcbiAgICAgICAgICBNZXNzYWdlOiAnTXlEZXRhaWxNZXNzYWdlJyxcbiAgICAgICAgfSksXG4gICAgICAgIGRldGFpbFR5cGU6ICdNeURldGFpbFR5cGUnLFxuICAgICAgICBzb3VyY2U6ICdteS5zb3VyY2UnLFxuICAgICAgfV0sXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9FcXVhbCh7XG4gICAgICBUeXBlOiAnVGFzaycsXG4gICAgICBSZXNvdXJjZToge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJzpzdGF0ZXM6OjpldmVudHM6cHV0RXZlbnRzJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgRW50cmllczogW3tcbiAgICAgICAgICBEZXRhaWw6IHtcbiAgICAgICAgICAgIE1lc3NhZ2U6ICdNeURldGFpbE1lc3NhZ2UnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgRGV0YWlsVHlwZTogJ015RGV0YWlsVHlwZScsXG4gICAgICAgICAgU291cmNlOiAnbXkuc291cmNlJyxcbiAgICAgICAgfV0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCd3YWl0IGZvciB0YXNrIHRva2VuJywgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCB0YXNrID0gbmV3IEV2ZW50QnJpZGdlUHV0RXZlbnRzKHN0YWNrLCAnUHV0RXZlbnRzJywge1xuICAgICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBzZm4uSW50ZWdyYXRpb25QYXR0ZXJuLldBSVRfRk9SX1RBU0tfVE9LRU4sXG4gICAgICBlbnRyaWVzOiBbe1xuICAgICAgICBkZXRhaWw6IHNmbi5UYXNrSW5wdXQuZnJvbU9iamVjdCh7XG4gICAgICAgICAgTWVzc2FnZTogJ015RGV0YWlsTWVzc2FnZScsXG4gICAgICAgICAgVG9rZW46IHNmbi5Kc29uUGF0aC50YXNrVG9rZW4sXG4gICAgICAgIH0pLFxuICAgICAgICBkZXRhaWxUeXBlOiAnTXlEZXRhaWxUeXBlJyxcbiAgICAgICAgc291cmNlOiAnbXkuc291cmNlJyxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvRXF1YWwoe1xuICAgICAgVHlwZTogJ1Rhc2snLFxuICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICc6c3RhdGVzOjo6ZXZlbnRzOnB1dEV2ZW50cy53YWl0Rm9yVGFza1Rva2VuJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgRW50cmllczogW3tcbiAgICAgICAgICBEZXRhaWw6IHtcbiAgICAgICAgICAgICdNZXNzYWdlJzogJ015RGV0YWlsTWVzc2FnZScsXG4gICAgICAgICAgICAnVG9rZW4uJCc6ICckJC5UYXNrLlRva2VuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIERldGFpbFR5cGU6ICdNeURldGFpbFR5cGUnLFxuICAgICAgICAgIFNvdXJjZTogJ215LnNvdXJjZScsXG4gICAgICAgIH1dLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnZmFpbHMgd2hlbiBXQUlUX0ZPUl9UQVNLX1RPS0VOIGludGVncmF0aW9uIHBhdHRlcm4gaXMgdXNlZCB3aXRob3V0IHN1cHBseWluZyBhIHRhc2sgdG9rZW4gaW4gZW50cmllcycsICgpID0+IHtcbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgbmV3IEV2ZW50QnJpZGdlUHV0RXZlbnRzKHN0YWNrLCAnUHV0RXZlbnRzJywge1xuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5JbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTixcbiAgICAgICAgZW50cmllczogW3tcbiAgICAgICAgICBkZXRhaWw6IHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoJ015RGV0YWlsJyksXG4gICAgICAgICAgZGV0YWlsVHlwZTogJ015RGV0YWlsVHlwZScsXG4gICAgICAgICAgc291cmNlOiAnbXkuc291cmNlJyxcbiAgICAgICAgfV0sXG4gICAgICB9KTtcbiAgICAvLyBUSEVOXG4gICAgfSkudG9UaHJvd0Vycm9yKCdUYXNrIFRva2VuIGlzIHJlcXVpcmVkIGluIGBlbnRyaWVzYC4gVXNlIEpzb25QYXRoLnRhc2tUb2tlbiB0byBzZXQgdGhlIHRva2VuLicpO1xuICB9KTtcblxuICB0ZXN0KCdmYWlscyB3aGVuIFJVTl9KT0IgaW50ZWdyYXRpb24gcGF0dGVybiBpcyB1c2VkJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgRXZlbnRCcmlkZ2VQdXRFdmVudHMoc3RhY2ssICdQdXRFdmVudHMnLCB7XG4gICAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5SVU5fSk9CLFxuICAgICAgICBlbnRyaWVzOiBbe1xuICAgICAgICAgIGRldGFpbDogc2ZuLlRhc2tJbnB1dC5mcm9tVGV4dCgnTXlEZXRhaWwnKSxcbiAgICAgICAgICBkZXRhaWxUeXBlOiAnTXlEZXRhaWxUeXBlJyxcbiAgICAgICAgICBzb3VyY2U6ICdteS5zb3VyY2UnLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIC8vIFRIRU5cbiAgICB9KS50b1Rocm93RXJyb3IoJ1Vuc3VwcG9ydGVkIHNlcnZpY2UgaW50ZWdyYXRpb24gcGF0dGVybicpO1xuICB9KTtcblxuICB0ZXN0KCdwcm92aWRlZCBFdmVudEJ1cycsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGV2ZW50QnVzID0gbmV3IGV2ZW50cy5FdmVudEJ1cyhzdGFjaywgJ0V2ZW50QnVzJyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdGFzayA9IG5ldyBFdmVudEJyaWRnZVB1dEV2ZW50cyhzdGFjaywgJ1B1dEV2ZW50cycsIHtcbiAgICAgIGVudHJpZXM6IFt7XG4gICAgICAgIGV2ZW50QnVzLFxuICAgICAgICBkZXRhaWw6IHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoJ015RGV0YWlsJyksXG4gICAgICAgIGRldGFpbFR5cGU6ICdNeURldGFpbFR5cGUnLFxuICAgICAgICBzb3VyY2U6ICdteS5zb3VyY2UnLFxuICAgICAgfV0sXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9FcXVhbCh7XG4gICAgICBUeXBlOiAnVGFzaycsXG4gICAgICBSZXNvdXJjZToge1xuICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgJycsXG4gICAgICAgICAgW1xuICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJzpzdGF0ZXM6OjpldmVudHM6cHV0RXZlbnRzJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgRW50cmllczogW3tcbiAgICAgICAgICBFdmVudEJ1c05hbWU6IHtcbiAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAnRXZlbnRCdXM3Qjg3NDhBQScsXG4gICAgICAgICAgICAgICdBcm4nLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIERldGFpbDogJ015RGV0YWlsJyxcbiAgICAgICAgICBEZXRhaWxUeXBlOiAnTXlEZXRhaWxUeXBlJyxcbiAgICAgICAgICBTb3VyY2U6ICdteS5zb3VyY2UnLFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2ZhaWxzIHdoZW4gcHJvdmlkZWQgYW4gZW1wdHkgYXJyYXkgZm9yIGVudHJpZXMnLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG5ldyBFdmVudEJyaWRnZVB1dEV2ZW50cyhzdGFjaywgJ1B1dEV2ZW50cycsIHtcbiAgICAgICAgZW50cmllczogW10sXG4gICAgICB9KTtcbiAgICB9KVxuICAgICAgLy8gVEhFTlxuICAgICAgLnRvVGhyb3dFcnJvcignVmFsdWUgZm9yIHByb3BlcnR5IGBlbnRyaWVzYCBtdXN0IGJlIGEgbm9uLWVtcHR5IGFycmF5LicpO1xuICB9KTtcblxuICB0ZXN0KCdWYWxpZGF0ZSB0YXNrIHBvbGljeScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGJ1cyA9IG5ldyBldmVudHMuRXZlbnRCdXMoc3RhY2ssICdFdmVudEJ1cycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHRhc2sgPSBuZXcgRXZlbnRCcmlkZ2VQdXRFdmVudHMoc3RhY2ssICdQdXRFdmVudHMnLCB7XG4gICAgICBlbnRyaWVzOiBbe1xuICAgICAgICBkZXRhaWw6IHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoJ015RGV0YWlsJyksXG4gICAgICAgIGRldGFpbFR5cGU6ICdNeURldGFpbFR5cGUnLFxuICAgICAgICBzb3VyY2U6ICdteS5zb3VyY2UnLFxuICAgICAgICBldmVudEJ1czogYnVzLFxuICAgICAgfSwge1xuICAgICAgICBkZXRhaWw6IHNmbi5UYXNrSW5wdXQuZnJvbVRleHQoJ015RGV0YWlsMicpLFxuICAgICAgICBkZXRhaWxUeXBlOiAnTXlEZXRhaWxUeXBlJyxcbiAgICAgICAgc291cmNlOiAnbXkuc291cmNlJyxcbiAgICAgIH1dLFxuICAgIH0pO1xuICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU3RhdGUgTWFjaGluZScsIHsgZGVmaW5pdGlvbjogdGFzayB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ2V2ZW50czpQdXRFdmVudHMnLFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6IFtcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICAgJ0V2ZW50QnVzN0I4NzQ4QUEnLFxuICAgICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sXG4gICAgICAgICAgICAgICAgICAgICc6ZXZlbnRzOicsXG4gICAgICAgICAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpSZWdpb24nIH0sXG4gICAgICAgICAgICAgICAgICAgICc6JyxcbiAgICAgICAgICAgICAgICAgICAgeyBSZWY6ICdBV1M6OkFjY291bnRJZCcgfSxcbiAgICAgICAgICAgICAgICAgICAgJzpldmVudC1idXMvZGVmYXVsdCcsXG4gICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICAgIH0sXG4gICAgICBSb2xlczogW1xuICAgICAgICB7XG4gICAgICAgICAgUmVmOiAnU3RhdGVNYWNoaW5lUm9sZTU0M0I5NjcwJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=