"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const sfn = require("../../../aws-stepfunctions");
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const core_1 = require("../../../core");
const tasks = require("../../lib");
const jobName = 'GlueJob';
let stack;
beforeEach(() => {
    stack = new core_1.Stack();
});
(0, cdk_build_tools_1.describeDeprecated)('RunGlueJobTask', () => {
    test('Invoke glue job with just job ARN', () => {
        const task = new sfn.Task(stack, 'Task', {
            task: new tasks.RunGlueJobTask(jobName),
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::glue:startJobRun',
                    ],
                ],
            },
            End: true,
            Parameters: {
                JobName: jobName,
            },
        });
    });
    test('Invoke glue job with full properties', () => {
        const jobArguments = {
            key: 'value',
        };
        const timeoutMinutes = 1440;
        const timeout = core_1.Duration.minutes(timeoutMinutes);
        const securityConfiguration = 'securityConfiguration';
        const notifyDelayAfterMinutes = 10;
        const notifyDelayAfter = core_1.Duration.minutes(notifyDelayAfterMinutes);
        const task = new sfn.Task(stack, 'Task', {
            task: new tasks.RunGlueJobTask(jobName, {
                integrationPattern: sfn.ServiceIntegrationPattern.SYNC,
                arguments: jobArguments,
                timeout,
                securityConfiguration,
                notifyDelayAfter,
            }),
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        expect(stack.resolve(task.toStateJson())).toEqual({
            Type: 'Task',
            Resource: {
                'Fn::Join': [
                    '',
                    [
                        'arn:',
                        {
                            Ref: 'AWS::Partition',
                        },
                        ':states:::glue:startJobRun.sync',
                    ],
                ],
            },
            End: true,
            Parameters: {
                JobName: jobName,
                Arguments: jobArguments,
                Timeout: timeoutMinutes,
                SecurityConfiguration: securityConfiguration,
                NotificationProperty: {
                    NotifyDelayAfter: notifyDelayAfterMinutes,
                },
            },
        });
    });
    test('permitted role actions limited to start job run if service integration pattern is FIRE_AND_FORGET', () => {
        const task = new sfn.Task(stack, 'Task', {
            task: new tasks.RunGlueJobTask(jobName, {
                integrationPattern: sfn.ServiceIntegrationPattern.FIRE_AND_FORGET,
            }),
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: [assertions_1.Match.objectLike({
                        Action: 'glue:StartJobRun',
                    })],
            },
        });
    });
    test('permitted role actions include start, get, and stop job run if service integration pattern is SYNC', () => {
        const task = new sfn.Task(stack, 'Task', {
            task: new tasks.RunGlueJobTask(jobName, {
                integrationPattern: sfn.ServiceIntegrationPattern.SYNC,
            }),
        });
        new sfn.StateMachine(stack, 'SM', {
            definition: task,
        });
        assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: [assertions_1.Match.objectLike({
                        Action: [
                            'glue:StartJobRun',
                            'glue:GetJobRun',
                            'glue:GetJobRuns',
                            'glue:BatchStopJobRun',
                        ],
                    })],
            },
        });
    });
    test('Task throws if WAIT_FOR_TASK_TOKEN is supplied as service integration pattern', () => {
        expect(() => {
            new sfn.Task(stack, 'Task', {
                task: new tasks.RunGlueJobTask(jobName, {
                    integrationPattern: sfn.ServiceIntegrationPattern.WAIT_FOR_TASK_TOKEN,
                }),
            });
        }).toThrow(/Invalid Service Integration Pattern: WAIT_FOR_TASK_TOKEN is not supported to call Glue./i);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuLWdsdWUtam9iLXRhc2sudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJ1bi1nbHVlLWpvYi10YXNrLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREFBc0Q7QUFDdEQsa0RBQWtEO0FBQ2xELDhEQUE4RDtBQUM5RCx3Q0FBZ0Q7QUFDaEQsbUNBQW1DO0FBRW5DLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQztBQUMxQixJQUFJLEtBQVksQ0FBQztBQUNqQixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7QUFDdEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFBLG9DQUFrQixFQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtJQUN4QyxJQUFJLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1lBQ3ZDLElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDO1NBQ3hDLENBQUMsQ0FBQztRQUNILElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFO1lBQ2hDLFVBQVUsRUFBRSxJQUFJO1NBQ2pCLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1lBQ2hELElBQUksRUFBRSxNQUFNO1lBQ1osUUFBUSxFQUFFO2dCQUNSLFVBQVUsRUFBRTtvQkFDVixFQUFFO29CQUNGO3dCQUNFLE1BQU07d0JBQ047NEJBQ0UsR0FBRyxFQUFFLGdCQUFnQjt5QkFDdEI7d0JBQ0QsNEJBQTRCO3FCQUM3QjtpQkFDRjthQUNGO1lBQ0QsR0FBRyxFQUFFLElBQUk7WUFDVCxVQUFVLEVBQUU7Z0JBQ1YsT0FB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QUFPLEVBQUU7Z0JBQ3RDLGtCQUFrQixFQUFFLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJO2FBQ3ZELENBQUM7U0FDSCxDQUFDLENBQUM7UUFDSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtZQUNoQyxVQUFVLEVBQUUsSUFBSTtTQUNqQixDQUFDLENBQUM7UUFFSCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxrQkFBa0IsRUFBRTtZQUNsRSxjQUFjLEVBQUU7Z0JBQ2QsU0FBUyxFQUFFLENBQUMsa0JBQUssQ0FBQyxVQUFVLENBQUM7d0JBQzNCLE1BQU0sRUFBRTs0QkFDTixrQkFBa0I7NEJBQ2xCLGdCQUFnQjs0QkFDaEIsaUJBQWlCOzRCQUNqQixzQkFBc0I7eUJBQ3ZCO3FCQUNGLENBQUMsQ0FBQzthQUNKO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsK0VBQStFLEVBQUUsR0FBRyxFQUFFO1FBQ3pGLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtnQkFDMUIsSUFBSSxFQUFFLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUU7b0JBQ3RDLGtCQUFrQixFQUFFLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxtQkFBbUI7aUJBQ3RFLENBQUM7YUFDSCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsMEZBQTBGLENBQUMsQ0FBQztJQUN6RyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWF0Y2gsIFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBzZm4gZnJvbSAnLi4vLi4vLi4vYXdzLXN0ZXBmdW5jdGlvbnMnO1xuaW1wb3J0IHsgZGVzY3JpYmVEZXByZWNhdGVkIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWJ1aWxkLXRvb2xzJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgdGFza3MgZnJvbSAnLi4vLi4vbGliJztcblxuY29uc3Qgam9iTmFtZSA9ICdHbHVlSm9iJztcbmxldCBzdGFjazogU3RhY2s7XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgU3RhY2soKTtcbn0pO1xuXG5kZXNjcmliZURlcHJlY2F0ZWQoJ1J1bkdsdWVKb2JUYXNrJywgKCkgPT4ge1xuICB0ZXN0KCdJbnZva2UgZ2x1ZSBqb2Igd2l0aCBqdXN0IGpvYiBBUk4nLCAoKSA9PiB7XG4gICAgY29uc3QgdGFzayA9IG5ldyBzZm4uVGFzayhzdGFjaywgJ1Rhc2snLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuR2x1ZUpvYlRhc2soam9iTmFtZSksXG4gICAgfSk7XG4gICAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUoc3RhY2ssICdTTScsIHtcbiAgICAgIGRlZmluaXRpb246IHRhc2ssXG4gICAgfSk7XG5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICAgIFR5cGU6ICdUYXNrJyxcbiAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgICAnJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnOnN0YXRlczo6OmdsdWU6c3RhcnRKb2JSdW4nLFxuICAgICAgICAgIF0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgRW5kOiB0cnVlLFxuICAgICAgUGFyYW1ldGVyczoge1xuICAgICAgICBKb2JOYW1lOiBqb2JOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnSW52b2tlIGdsdWUgam9iIHdpdGggZnVsbCBwcm9wZXJ0aWVzJywgKCkgPT4ge1xuICAgIGNvbnN0IGpvYkFyZ3VtZW50cyA9IHtcbiAgICAgIGtleTogJ3ZhbHVlJyxcbiAgICB9O1xuICAgIGNvbnN0IHRpbWVvdXRNaW51dGVzID0gMTQ0MDtcbiAgICBjb25zdCB0aW1lb3V0ID0gRHVyYXRpb24ubWludXRlcyh0aW1lb3V0TWludXRlcyk7XG4gICAgY29uc3Qgc2VjdXJpdHlDb25maWd1cmF0aW9uID0gJ3NlY3VyaXR5Q29uZmlndXJhdGlvbic7XG4gICAgY29uc3Qgbm90aWZ5RGVsYXlBZnRlck1pbnV0ZXMgPSAxMDtcbiAgICBjb25zdCBub3RpZnlEZWxheUFmdGVyID0gRHVyYXRpb24ubWludXRlcyhub3RpZnlEZWxheUFmdGVyTWludXRlcyk7XG4gICAgY29uc3QgdGFzayA9IG5ldyBzZm4uVGFzayhzdGFjaywgJ1Rhc2snLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuR2x1ZUpvYlRhc2soam9iTmFtZSwge1xuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5TZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLlNZTkMsXG4gICAgICAgIGFyZ3VtZW50czogam9iQXJndW1lbnRzLFxuICAgICAgICB0aW1lb3V0LFxuICAgICAgICBzZWN1cml0eUNvbmZpZ3VyYXRpb24sXG4gICAgICAgIG5vdGlmeURlbGF5QWZ0ZXIsXG4gICAgICB9KSxcbiAgICB9KTtcbiAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1NNJywge1xuICAgICAgZGVmaW5pdGlvbjogdGFzayxcbiAgICB9KTtcblxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvRXF1YWwoe1xuICAgICAgVHlwZTogJ1Rhc2snLFxuICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICcnLFxuICAgICAgICAgIFtcbiAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICc6c3RhdGVzOjo6Z2x1ZTpzdGFydEpvYlJ1bi5zeW5jJyxcbiAgICAgICAgICBdLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIEVuZDogdHJ1ZSxcbiAgICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgICAgSm9iTmFtZTogam9iTmFtZSxcbiAgICAgICAgQXJndW1lbnRzOiBqb2JBcmd1bWVudHMsXG4gICAgICAgIFRpbWVvdXQ6IHRpbWVvdXRNaW51dGVzLFxuICAgICAgICBTZWN1cml0eUNvbmZpZ3VyYXRpb246IHNlY3VyaXR5Q29uZmlndXJhdGlvbixcbiAgICAgICAgTm90aWZpY2F0aW9uUHJvcGVydHk6IHtcbiAgICAgICAgICBOb3RpZnlEZWxheUFmdGVyOiBub3RpZnlEZWxheUFmdGVyTWludXRlcyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Blcm1pdHRlZCByb2xlIGFjdGlvbnMgbGltaXRlZCB0byBzdGFydCBqb2IgcnVuIGlmIHNlcnZpY2UgaW50ZWdyYXRpb24gcGF0dGVybiBpcyBGSVJFX0FORF9GT1JHRVQnLCAoKSA9PiB7XG4gICAgY29uc3QgdGFzayA9IG5ldyBzZm4uVGFzayhzdGFjaywgJ1Rhc2snLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuR2x1ZUpvYlRhc2soam9iTmFtZSwge1xuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5TZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLkZJUkVfQU5EX0ZPUkdFVCxcbiAgICAgIH0pLFxuICAgIH0pO1xuICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU00nLCB7XG4gICAgICBkZWZpbml0aW9uOiB0YXNrLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFtNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICBBY3Rpb246ICdnbHVlOlN0YXJ0Sm9iUnVuJyxcbiAgICAgICAgfSldLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgncGVybWl0dGVkIHJvbGUgYWN0aW9ucyBpbmNsdWRlIHN0YXJ0LCBnZXQsIGFuZCBzdG9wIGpvYiBydW4gaWYgc2VydmljZSBpbnRlZ3JhdGlvbiBwYXR0ZXJuIGlzIFNZTkMnLCAoKSA9PiB7XG4gICAgY29uc3QgdGFzayA9IG5ldyBzZm4uVGFzayhzdGFjaywgJ1Rhc2snLCB7XG4gICAgICB0YXNrOiBuZXcgdGFza3MuUnVuR2x1ZUpvYlRhc2soam9iTmFtZSwge1xuICAgICAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5TZXJ2aWNlSW50ZWdyYXRpb25QYXR0ZXJuLlNZTkMsXG4gICAgICB9KSxcbiAgICB9KTtcbiAgICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1NNJywge1xuICAgICAgZGVmaW5pdGlvbjogdGFzayxcbiAgICB9KTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgICAgU3RhdGVtZW50OiBbTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgQWN0aW9uOiBbXG4gICAgICAgICAgICAnZ2x1ZTpTdGFydEpvYlJ1bicsXG4gICAgICAgICAgICAnZ2x1ZTpHZXRKb2JSdW4nLFxuICAgICAgICAgICAgJ2dsdWU6R2V0Sm9iUnVucycsXG4gICAgICAgICAgICAnZ2x1ZTpCYXRjaFN0b3BKb2JSdW4nLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pXSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ1Rhc2sgdGhyb3dzIGlmIFdBSVRfRk9SX1RBU0tfVE9LRU4gaXMgc3VwcGxpZWQgYXMgc2VydmljZSBpbnRlZ3JhdGlvbiBwYXR0ZXJuJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBuZXcgc2ZuLlRhc2soc3RhY2ssICdUYXNrJywge1xuICAgICAgICB0YXNrOiBuZXcgdGFza3MuUnVuR2x1ZUpvYlRhc2soam9iTmFtZSwge1xuICAgICAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLlNlcnZpY2VJbnRlZ3JhdGlvblBhdHRlcm4uV0FJVF9GT1JfVEFTS19UT0tFTixcbiAgICAgICAgfSksXG4gICAgICB9KTtcbiAgICB9KS50b1Rocm93KC9JbnZhbGlkIFNlcnZpY2UgSW50ZWdyYXRpb24gUGF0dGVybjogV0FJVF9GT1JfVEFTS19UT0tFTiBpcyBub3Qgc3VwcG9ydGVkIHRvIGNhbGwgR2x1ZS4vaSk7XG4gIH0pO1xufSk7XG4iXX0=