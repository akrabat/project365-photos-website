"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const sfn = require("../../../aws-stepfunctions");
const core_1 = require("../../../core");
const tasks = require("../../lib");
const start_job_run_1 = require("../../lib/glue/start-job-run");
const glueJobName = 'GlueJob';
let stack;
beforeEach(() => {
    stack = new core_1.Stack();
});
test('Invoke glue job with just job ARN', () => {
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::glue:startJobRun',
                ],
            ],
        },
        End: true,
        Parameters: {
            JobName: glueJobName,
        },
    });
});
test('Invoke glue job with full properties', () => {
    const jobArguments = {
        key: 'value',
    };
    const timeoutMinutes = 1440;
    const glueJobTimeout = core_1.Duration.minutes(timeoutMinutes);
    const securityConfiguration = 'securityConfiguration';
    const notifyDelayAfterMinutes = 10;
    const notifyDelayAfter = core_1.Duration.minutes(notifyDelayAfterMinutes);
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
        integrationPattern: sfn.IntegrationPattern.RUN_JOB,
        arguments: sfn.TaskInput.fromObject(jobArguments),
        taskTimeout: sfn.Timeout.duration(glueJobTimeout),
        securityConfiguration,
        notifyDelayAfter,
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::glue:startJobRun.sync',
                ],
            ],
        },
        End: true,
        Parameters: {
            JobName: glueJobName,
            Arguments: jobArguments,
            Timeout: timeoutMinutes,
            SecurityConfiguration: securityConfiguration,
            NotificationProperty: {
                NotifyDelayAfter: notifyDelayAfterMinutes,
            },
        },
    });
});
test('Invoke glue job with Timeout.at()', () => {
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
        taskTimeout: sfn.Timeout.at('$.timeout'),
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::glue:startJobRun',
                ],
            ],
        },
        End: true,
        Parameters: {
            'JobName': glueJobName,
            'Timeout.$': '$.timeout',
        },
    });
});
test('job arguments can reference state input', () => {
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
        integrationPattern: sfn.IntegrationPattern.RUN_JOB,
        arguments: sfn.TaskInput.fromJsonPathAt('$.input'),
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::glue:startJobRun.sync',
                ],
            ],
        },
        End: true,
        Parameters: {
            'JobName': glueJobName,
            'Arguments.$': '$.input',
        },
    });
});
test('permitted role actions limited to start job run if service integration pattern is REQUEST_RESPONSE', () => {
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
        integrationPattern: sfn.IntegrationPattern.REQUEST_RESPONSE,
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [assertions_1.Match.objectLike({
                    Action: 'glue:StartJobRun',
                })],
        },
    });
});
test('permitted role actions include start, get, and stop job run if service integration pattern is RUN_JOB', () => {
    const task = new start_job_run_1.GlueStartJobRun(stack, 'Task', {
        glueJobName,
        integrationPattern: sfn.IntegrationPattern.RUN_JOB,
    });
    new sfn.StateMachine(stack, 'SM', {
        definition: task,
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [assertions_1.Match.objectLike({
                    Action: [
                        'glue:StartJobRun',
                        'glue:GetJobRun',
                        'glue:GetJobRuns',
                        'glue:BatchStopJobRun',
                    ],
                })],
        },
    });
});
test('Task throws if WAIT_FOR_TASK_TOKEN is supplied as service integration pattern', () => {
    expect(() => {
        new tasks.GlueStartJobRun(stack, 'GlueJob', {
            glueJobName,
            integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
        });
    }).toThrow(/unsupported service integration pattern/i);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtam9iLXJ1bi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3RhcnQtam9iLXJ1bi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0RBQXNEO0FBQ3RELGtEQUFrRDtBQUNsRCx3Q0FBZ0Q7QUFDaEQsbUNBQW1DO0FBQ25DLGdFQUErRDtBQUUvRCxNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUM7QUFDOUIsSUFBSSxLQUFZLENBQUM7QUFDakIsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO0FBQ3RCLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtJQUM3QyxNQUFNLElBQUksR0FBRyxJQUFJLCtCQUFlLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtRQUM5QyxXQUFXO0tBQ1osQ0FBQyxDQUFDO0lBQ0gsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUU7UUFDaEMsVUFBVSxFQUFFLElBQUk7S0FDakIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDaEQsSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUU7WUFDUixVQUFVLEVBQUU7Z0JBQ1YsRUFBRTtnQkFDRjtvQkFDRSxNQUFNO29CQUNOO3dCQUNFLEdBQUcsRUFBRSxnQkFBZ0I7cUJBQ3RCO29CQUNELDRCQUE0QjtpQkFDN0I7YUFDRjtTQUNGO1FBQ0QsR0FBRyxFQUFFLElBQUk7UUFDVCxVQUFVLEVBQUU7WUFDVixPQUFPLEVBQUUsV0FBVztTQUNyQjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtJQUNoRCxNQUFNLFlBQVksR0FBRztRQUNuQixHQUFHLEVBQUUsT0FBTztLQUNiLENBQUM7SUFDRixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7SUFDNUIsTUFBTSxjQUFjLEdBQUcsZUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN4RCxNQUFNLHFCQUFxQixHQUFHLHVCQUF1QixDQUFDO0lBQ3RELE1BQU0sdUJBQXVCLEdBQUcsRUFBRSxDQUFDO0lBQ25DLE1BQU0sZ0JBQWdCLEdBQUcsZUFBUSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBQ25FLE1BQU0sSUFBSSxHQUFHLElBQUksK0JBQWUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1FBQzlDLFdBQVc7UUFDWCxrQkFBa0IsRUFBRSxHQUFHLENBQUMsa0JBQWtCLENBQUMsT0FBTztRQUNsRCxTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO1FBQ2pELFdBQVcsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUM7UUFDakQscUJBQXFCO1FBQ3JCLGdCQUFnQjtLQUNqQixDQUFDLENBQUM7SUFDSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtRQUNoQyxVQUFVLEVBQUUsSUFBSTtLQUNqQixDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNoRCxJQUFJLEVBQUUsTUFBTTtRQUNaLFFBQVEsRUFBRTtZQUNSLFVBQVUsRUFBRTtnQkFDVixFQUFFO2dCQUNGO29CQUNFLE1BQU07b0JBQ047d0JBQ0UsR0FBRyxFQUFFLGdCQUFnQjtxQkFDdEI7b0JBQ0QsaUNBQWlDO2lCQUNsQzthQUNGO1NBQ0Y7UUFDRCxHQUFHLEVBQUUsSUFBSTtRQUNULFVBQVUsRUFBRTtZQUNWLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLFNBQVMsRUFBRSxZQUFZO1lBQ3ZCLE9BQU8sRUFBRSxjQUFjO1lBQ3ZCLHFCQUFxQixFQUFFLHFCQUFxQjtZQUM1QyxvQkFBb0IsRUFBRTtnQkFDcEIsZ0JBQWdCLEVBQUUsdUJBQXVCO2FBQzFDO1NBQ0Y7S0FDRixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7SUFDN0MsTUFBTSxJQUFJLEdBQUcsSUFBSSwrQkFBZSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUU7UUFDOUMsV0FBVztRQUNYLFdBQVcsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7S0FDekMsQ0FBQyxDQUFDO0lBQ0gsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUU7UUFDaEMsVUFBVSxFQUFFLElBQUk7S0FDakIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDaEQsSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUU7WUFDUixVQUFVLEVBQUU7Z0JBQ1YsRUFBRTtnQkFDRjtvQkFDRSxNQUFNO29CQUNOO3dCQUNFLEdBQUcsRUFBRSxnQkFBZ0I7cUJBQ3RCO29CQUNELDRCQUE0QjtpQkFDN0I7YUFDRjtTQUNGO1FBQ0QsR0FBRyxFQUFFLElBQUk7UUFDVCxVQUFVLEVBQUU7WUFDVixTQUFTLEVBQUUsV0FBVztZQUN0QixXQUFXLEVBQUUsV0FBVztTQUN6QjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtJQUNuRCxNQUFNLElBQUksR0FBRyxJQUFJLCtCQUFlLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtRQUM5QyxXQUFXO1FBQ1gsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGtCQUFrQixDQUFDLE9BQU87UUFDbEQsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQztLQUNuRCxDQUFDLENBQUM7SUFDSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTtRQUNoQyxVQUFVLEVBQUUsSUFBSTtLQUNqQixDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNoRCxJQUFJLEVBQUUsTUFBTTtRQUNaLFFBQVEsRUFBRTtZQUNSLFVBQVUsRUFBRTtnQkFDVixFQUFFO2dCQUNGO29CQUNFLE1BQU07b0JBQ047d0JBQ0UsR0FBRyxFQUFFLGdCQUFnQjtxQkFDdEI7b0JBQ0QsaUNBQWlDO2lCQUNsQzthQUNGO1NBQ0Y7UUFDRCxHQUFHLEVBQUUsSUFBSTtRQUNULFVBQVUsRUFBRTtZQUNWLFNBQVMsRUFBRSxXQUFXO1lBQ3RCLGFBQWEsRUFBRSxTQUFTO1NBQ3pCO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsb0dBQW9HLEVBQUUsR0FBRyxFQUFFO0lBQzlHLE1BQU0sSUFBSSxHQUFHLElBQUksK0JBQWUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1FBQzlDLFdBQVc7UUFDWCxrQkFBa0IsRUFBRSxHQUFHLENBQUMsa0JBQWtCLENBQUMsZ0JBQWdCO0tBQzVELENBQUMsQ0FBQztJQUVILElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFO1FBQ2hDLFVBQVUsRUFBRSxJQUFJO0tBQ2pCLENBQUMsQ0FBQztJQUVILHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixFQUFFO1FBQ2xFLGNBQWMsRUFBRTtZQUNkLFNBQVMsRUFBRSxDQUFDLGtCQUFLLENBQUMsVUFBVSxDQUFDO29CQUMzQixNQUFNLEVBQUUsa0JBQWtCO2lCQUMzQixDQUFDLENBQUM7U0FDSjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHVHQUF1RyxFQUFFLEdBQUcsRUFBRTtJQUNqSCxNQUFNLElBQUksR0FBRyxJQUFJLCtCQUFlLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRTtRQUM5QyxXQUFXO1FBQ1gsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGtCQUFrQixDQUFDLE9BQU87S0FDbkQsQ0FBQyxDQUFDO0lBRUgsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUU7UUFDaEMsVUFBVSxFQUFFLElBQUk7S0FDakIsQ0FBQyxDQUFDO0lBRUgscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLEVBQUU7UUFDbEUsY0FBYyxFQUFFO1lBQ2QsU0FBUyxFQUFFLENBQUMsa0JBQUssQ0FBQyxVQUFVLENBQUM7b0JBQzNCLE1BQU0sRUFBRTt3QkFDTixrQkFBa0I7d0JBQ2xCLGdCQUFnQjt3QkFDaEIsaUJBQWlCO3dCQUNqQixzQkFBc0I7cUJBQ3ZCO2lCQUNGLENBQUMsQ0FBQztTQUNKO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsK0VBQStFLEVBQUUsR0FBRyxFQUFFO0lBQ3pGLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDVixJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtZQUMxQyxXQUFXO1lBQ1gsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQjtTQUMvRCxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsMENBQTBDLENBQUMsQ0FBQztBQUN6RCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGNoLCBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgc2ZuIGZyb20gJy4uLy4uLy4uL2F3cy1zdGVwZnVuY3Rpb25zJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgdGFza3MgZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IEdsdWVTdGFydEpvYlJ1biB9IGZyb20gJy4uLy4uL2xpYi9nbHVlL3N0YXJ0LWpvYi1ydW4nO1xuXG5jb25zdCBnbHVlSm9iTmFtZSA9ICdHbHVlSm9iJztcbmxldCBzdGFjazogU3RhY2s7XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgc3RhY2sgPSBuZXcgU3RhY2soKTtcbn0pO1xuXG50ZXN0KCdJbnZva2UgZ2x1ZSBqb2Igd2l0aCBqdXN0IGpvYiBBUk4nLCAoKSA9PiB7XG4gIGNvbnN0IHRhc2sgPSBuZXcgR2x1ZVN0YXJ0Sm9iUnVuKHN0YWNrLCAnVGFzaycsIHtcbiAgICBnbHVlSm9iTmFtZSxcbiAgfSk7XG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU00nLCB7XG4gICAgZGVmaW5pdGlvbjogdGFzayxcbiAgfSk7XG5cbiAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9FcXVhbCh7XG4gICAgVHlwZTogJ1Rhc2snLFxuICAgIFJlc291cmNlOiB7XG4gICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICcnLFxuICAgICAgICBbXG4gICAgICAgICAgJ2FybjonLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgICc6c3RhdGVzOjo6Z2x1ZTpzdGFydEpvYlJ1bicsXG4gICAgICAgIF0sXG4gICAgICBdLFxuICAgIH0sXG4gICAgRW5kOiB0cnVlLFxuICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgIEpvYk5hbWU6IGdsdWVKb2JOYW1lLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ0ludm9rZSBnbHVlIGpvYiB3aXRoIGZ1bGwgcHJvcGVydGllcycsICgpID0+IHtcbiAgY29uc3Qgam9iQXJndW1lbnRzID0ge1xuICAgIGtleTogJ3ZhbHVlJyxcbiAgfTtcbiAgY29uc3QgdGltZW91dE1pbnV0ZXMgPSAxNDQwO1xuICBjb25zdCBnbHVlSm9iVGltZW91dCA9IER1cmF0aW9uLm1pbnV0ZXModGltZW91dE1pbnV0ZXMpO1xuICBjb25zdCBzZWN1cml0eUNvbmZpZ3VyYXRpb24gPSAnc2VjdXJpdHlDb25maWd1cmF0aW9uJztcbiAgY29uc3Qgbm90aWZ5RGVsYXlBZnRlck1pbnV0ZXMgPSAxMDtcbiAgY29uc3Qgbm90aWZ5RGVsYXlBZnRlciA9IER1cmF0aW9uLm1pbnV0ZXMobm90aWZ5RGVsYXlBZnRlck1pbnV0ZXMpO1xuICBjb25zdCB0YXNrID0gbmV3IEdsdWVTdGFydEpvYlJ1bihzdGFjaywgJ1Rhc2snLCB7XG4gICAgZ2x1ZUpvYk5hbWUsXG4gICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBzZm4uSW50ZWdyYXRpb25QYXR0ZXJuLlJVTl9KT0IsXG4gICAgYXJndW1lbnRzOiBzZm4uVGFza0lucHV0LmZyb21PYmplY3Qoam9iQXJndW1lbnRzKSxcbiAgICB0YXNrVGltZW91dDogc2ZuLlRpbWVvdXQuZHVyYXRpb24oZ2x1ZUpvYlRpbWVvdXQpLFxuICAgIHNlY3VyaXR5Q29uZmlndXJhdGlvbixcbiAgICBub3RpZnlEZWxheUFmdGVyLFxuICB9KTtcbiAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUoc3RhY2ssICdTTScsIHtcbiAgICBkZWZpbml0aW9uOiB0YXNrLFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICBUeXBlOiAnVGFzaycsXG4gICAgUmVzb3VyY2U6IHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJzpzdGF0ZXM6OjpnbHVlOnN0YXJ0Sm9iUnVuLnN5bmMnLFxuICAgICAgICBdLFxuICAgICAgXSxcbiAgICB9LFxuICAgIEVuZDogdHJ1ZSxcbiAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICBKb2JOYW1lOiBnbHVlSm9iTmFtZSxcbiAgICAgIEFyZ3VtZW50czogam9iQXJndW1lbnRzLFxuICAgICAgVGltZW91dDogdGltZW91dE1pbnV0ZXMsXG4gICAgICBTZWN1cml0eUNvbmZpZ3VyYXRpb246IHNlY3VyaXR5Q29uZmlndXJhdGlvbixcbiAgICAgIE5vdGlmaWNhdGlvblByb3BlcnR5OiB7XG4gICAgICAgIE5vdGlmeURlbGF5QWZ0ZXI6IG5vdGlmeURlbGF5QWZ0ZXJNaW51dGVzLFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdJbnZva2UgZ2x1ZSBqb2Igd2l0aCBUaW1lb3V0LmF0KCknLCAoKSA9PiB7XG4gIGNvbnN0IHRhc2sgPSBuZXcgR2x1ZVN0YXJ0Sm9iUnVuKHN0YWNrLCAnVGFzaycsIHtcbiAgICBnbHVlSm9iTmFtZSxcbiAgICB0YXNrVGltZW91dDogc2ZuLlRpbWVvdXQuYXQoJyQudGltZW91dCcpLFxuICB9KTtcbiAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUoc3RhY2ssICdTTScsIHtcbiAgICBkZWZpbml0aW9uOiB0YXNrLFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICBUeXBlOiAnVGFzaycsXG4gICAgUmVzb3VyY2U6IHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJzpzdGF0ZXM6OjpnbHVlOnN0YXJ0Sm9iUnVuJyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBFbmQ6IHRydWUsXG4gICAgUGFyYW1ldGVyczoge1xuICAgICAgJ0pvYk5hbWUnOiBnbHVlSm9iTmFtZSxcbiAgICAgICdUaW1lb3V0LiQnOiAnJC50aW1lb3V0JyxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdqb2IgYXJndW1lbnRzIGNhbiByZWZlcmVuY2Ugc3RhdGUgaW5wdXQnLCAoKSA9PiB7XG4gIGNvbnN0IHRhc2sgPSBuZXcgR2x1ZVN0YXJ0Sm9iUnVuKHN0YWNrLCAnVGFzaycsIHtcbiAgICBnbHVlSm9iTmFtZSxcbiAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5JbnRlZ3JhdGlvblBhdHRlcm4uUlVOX0pPQixcbiAgICBhcmd1bWVudHM6IHNmbi5UYXNrSW5wdXQuZnJvbUpzb25QYXRoQXQoJyQuaW5wdXQnKSxcbiAgfSk7XG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnU00nLCB7XG4gICAgZGVmaW5pdGlvbjogdGFzayxcbiAgfSk7XG5cbiAgZXhwZWN0KHN0YWNrLnJlc29sdmUodGFzay50b1N0YXRlSnNvbigpKSkudG9FcXVhbCh7XG4gICAgVHlwZTogJ1Rhc2snLFxuICAgIFJlc291cmNlOiB7XG4gICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICcnLFxuICAgICAgICBbXG4gICAgICAgICAgJ2FybjonLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgICc6c3RhdGVzOjo6Z2x1ZTpzdGFydEpvYlJ1bi5zeW5jJyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBFbmQ6IHRydWUsXG4gICAgUGFyYW1ldGVyczoge1xuICAgICAgJ0pvYk5hbWUnOiBnbHVlSm9iTmFtZSxcbiAgICAgICdBcmd1bWVudHMuJCc6ICckLmlucHV0JyxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdwZXJtaXR0ZWQgcm9sZSBhY3Rpb25zIGxpbWl0ZWQgdG8gc3RhcnQgam9iIHJ1biBpZiBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4gaXMgUkVRVUVTVF9SRVNQT05TRScsICgpID0+IHtcbiAgY29uc3QgdGFzayA9IG5ldyBHbHVlU3RhcnRKb2JSdW4oc3RhY2ssICdUYXNrJywge1xuICAgIGdsdWVKb2JOYW1lLFxuICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5SRVFVRVNUX1JFU1BPTlNFLFxuICB9KTtcblxuICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1NNJywge1xuICAgIGRlZmluaXRpb246IHRhc2ssXG4gIH0pO1xuXG4gIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICBTdGF0ZW1lbnQ6IFtNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgQWN0aW9uOiAnZ2x1ZTpTdGFydEpvYlJ1bicsXG4gICAgICB9KV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgncGVybWl0dGVkIHJvbGUgYWN0aW9ucyBpbmNsdWRlIHN0YXJ0LCBnZXQsIGFuZCBzdG9wIGpvYiBydW4gaWYgc2VydmljZSBpbnRlZ3JhdGlvbiBwYXR0ZXJuIGlzIFJVTl9KT0InLCAoKSA9PiB7XG4gIGNvbnN0IHRhc2sgPSBuZXcgR2x1ZVN0YXJ0Sm9iUnVuKHN0YWNrLCAnVGFzaycsIHtcbiAgICBnbHVlSm9iTmFtZSxcbiAgICBpbnRlZ3JhdGlvblBhdHRlcm46IHNmbi5JbnRlZ3JhdGlvblBhdHRlcm4uUlVOX0pPQixcbiAgfSk7XG5cbiAgbmV3IHNmbi5TdGF0ZU1hY2hpbmUoc3RhY2ssICdTTScsIHtcbiAgICBkZWZpbml0aW9uOiB0YXNrLFxuICB9KTtcblxuICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgU3RhdGVtZW50OiBbTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgIEFjdGlvbjogW1xuICAgICAgICAgICdnbHVlOlN0YXJ0Sm9iUnVuJyxcbiAgICAgICAgICAnZ2x1ZTpHZXRKb2JSdW4nLFxuICAgICAgICAgICdnbHVlOkdldEpvYlJ1bnMnLFxuICAgICAgICAgICdnbHVlOkJhdGNoU3RvcEpvYlJ1bicsXG4gICAgICAgIF0sXG4gICAgICB9KV0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnVGFzayB0aHJvd3MgaWYgV0FJVF9GT1JfVEFTS19UT0tFTiBpcyBzdXBwbGllZCBhcyBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4nLCAoKSA9PiB7XG4gIGV4cGVjdCgoKSA9PiB7XG4gICAgbmV3IHRhc2tzLkdsdWVTdGFydEpvYlJ1bihzdGFjaywgJ0dsdWVKb2InLCB7XG4gICAgICBnbHVlSm9iTmFtZSxcbiAgICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOLFxuICAgIH0pO1xuICB9KS50b1Rocm93KC91bnN1cHBvcnRlZCBzZXJ2aWNlIGludGVncmF0aW9uIHBhdHRlcm4vaSk7XG59KTtcbiJdfQ==