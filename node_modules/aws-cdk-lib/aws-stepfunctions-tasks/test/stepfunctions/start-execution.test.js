"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const sfn = require("../../../aws-stepfunctions");
const core_1 = require("../../../core");
const start_execution_1 = require("../../lib/stepfunctions/start-execution");
let stack;
let child;
beforeEach(() => {
    stack = new core_1.Stack();
    child = new sfn.StateMachine(stack, 'ChildStateMachine', {
        definition: sfn.Chain.start(new sfn.Pass(stack, 'PassState')),
    });
});
test('Execute State Machine - Default - Request Response', () => {
    const task = new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
        stateMachine: child,
        input: sfn.TaskInput.fromObject({
            foo: 'bar',
        }),
        name: 'myExecutionName',
    });
    new sfn.StateMachine(stack, 'ParentStateMachine', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::states:startExecution',
                ],
            ],
        },
        End: true,
        Parameters: {
            Input: {
                foo: 'bar',
            },
            Name: 'myExecutionName',
            StateMachineArn: {
                Ref: 'ChildStateMachine9133117F',
            },
        },
    });
});
test('Execute State Machine - Run Job', () => {
    const task = new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
        stateMachine: child,
        integrationPattern: sfn.IntegrationPattern.RUN_JOB,
    });
    new sfn.StateMachine(stack, 'ParentStateMachine', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::states:startExecution.sync:2',
                ],
            ],
        },
        End: true,
        Parameters: {
            'Input.$': '$',
            'StateMachineArn': {
                Ref: 'ChildStateMachine9133117F',
            },
        },
    });
    assertions_1.Template.fromStack(stack).hasResourceProperties('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: [
                {
                    Action: 'states:StartExecution',
                    Effect: 'Allow',
                    Resource: {
                        Ref: 'ChildStateMachine9133117F',
                    },
                },
                {
                    Action: ['states:DescribeExecution', 'states:StopExecution'],
                    Effect: 'Allow',
                    Resource: {
                        'Fn::Join': [
                            '',
                            [
                                'arn:',
                                {
                                    Ref: 'AWS::Partition',
                                },
                                ':states:',
                                {
                                    Ref: 'AWS::Region',
                                },
                                ':',
                                {
                                    Ref: 'AWS::AccountId',
                                },
                                ':execution:',
                                {
                                    'Fn::Select': [
                                        6,
                                        {
                                            'Fn::Split': [
                                                ':',
                                                {
                                                    Ref: 'ChildStateMachine9133117F',
                                                },
                                            ],
                                        },
                                    ],
                                },
                                '*',
                            ],
                        ],
                    },
                },
                {
                    Action: ['events:PutTargets', 'events:PutRule', 'events:DescribeRule'],
                    Effect: 'Allow',
                    Resource: {
                        'Fn::Join': [
                            '',
                            [
                                'arn:',
                                {
                                    Ref: 'AWS::Partition',
                                },
                                ':events:',
                                {
                                    Ref: 'AWS::Region',
                                },
                                ':',
                                {
                                    Ref: 'AWS::AccountId',
                                },
                                ':rule/StepFunctionsGetEventsForStepFunctionsExecutionRule',
                            ],
                        ],
                    },
                },
            ],
            Version: '2012-10-17',
        },
        Roles: [
            {
                Ref: 'ParentStateMachineRoleE902D002',
            },
        ],
    });
});
test('Execute State Machine - Wait For Task Token', () => {
    const task = new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
        stateMachine: child,
        integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
        input: sfn.TaskInput.fromObject({
            token: sfn.JsonPath.taskToken,
        }),
    });
    new sfn.StateMachine(stack, 'ParentStateMachine', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toEqual({
        Type: 'Task',
        Resource: {
            'Fn::Join': [
                '',
                [
                    'arn:',
                    {
                        Ref: 'AWS::Partition',
                    },
                    ':states:::states:startExecution.waitForTaskToken',
                ],
            ],
        },
        End: true,
        Parameters: {
            Input: {
                'token.$': '$$.Task.Token',
            },
            StateMachineArn: {
                Ref: 'ChildStateMachine9133117F',
            },
        },
    });
});
test('Execute State Machine - Wait For Task Token - Missing Task Token', () => {
    expect(() => {
        new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
            stateMachine: child,
            integrationPattern: sfn.IntegrationPattern.WAIT_FOR_TASK_TOKEN,
        });
    }).toThrow('Task Token is required in `input` for callback. Use JsonPath.taskToken to set the token.');
});
test('Execute State Machine - Associate With Parent - Input Provided', () => {
    const task = new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
        stateMachine: child,
        input: sfn.TaskInput.fromObject({
            token: sfn.JsonPath.taskToken,
        }),
        associateWithParent: true,
    });
    new sfn.StateMachine(stack, 'ParentStateMachine', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toMatchObject({
        Parameters: {
            Input: {
                'token.$': '$$.Task.Token',
                'AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$': '$$.Execution.Id',
            },
        },
    });
});
test('Execute State Machine - Associate With Parent - Input Not Provided', () => {
    const task = new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
        stateMachine: child,
        associateWithParent: true,
    });
    new sfn.StateMachine(stack, 'ParentStateMachine', {
        definition: task,
    });
    expect(stack.resolve(task.toStateJson())).toMatchObject({
        Parameters: {
            Input: {
                'AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$': '$$.Execution.Id',
            },
        },
    });
});
test('Execute State Machine - Associate With Parent - Incorrect Input Type', () => {
    expect(() => {
        new start_execution_1.StepFunctionsStartExecution(stack, 'ChildTask', {
            stateMachine: child,
            associateWithParent: true,
            input: sfn.TaskInput.fromText('{ "token.$": "$$.Task.Token" }'),
        });
    }).toThrow('Could not enable `associateWithParent` because `input` is taken directly from a JSON path. Use `sfn.TaskInput.fromObject` instead.');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhcnQtZXhlY3V0aW9uLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGFydC1leGVjdXRpb24udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUErQztBQUMvQyxrREFBa0Q7QUFDbEQsd0NBQXNDO0FBQ3RDLDZFQUFzRjtBQUV0RixJQUFJLEtBQVksQ0FBQztBQUNqQixJQUFJLEtBQXVCLENBQUM7QUFDNUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEtBQUssR0FBRyxJQUFJLFlBQUssRUFBRSxDQUFDO0lBQ3BCLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLG1CQUFtQixFQUFFO1FBQ3ZELFVBQVUsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0tBQzlELENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtJQUM5RCxNQUFNLElBQUksR0FBRyxJQUFJLDZDQUEyQixDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUU7UUFDL0QsWUFBWSxFQUFFLEtBQUs7UUFDbkIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDO1lBQzlCLEdBQUcsRUFBRSxLQUFLO1NBQ1gsQ0FBQztRQUNGLElBQUksRUFBRSxpQkFBaUI7S0FDeEIsQ0FBQyxDQUFDO0lBRUgsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxvQkFBb0IsRUFBRTtRQUNoRCxVQUFVLEVBQUUsSUFBSTtLQUNqQixDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNoRCxJQUFJLEVBQUUsTUFBTTtRQUNa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QixDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUU7UUFDL0QsWUFBWSxFQUFFLEtBQUs7UUFDbkIsbUJBQW1CLEVBQUUsSUFBSTtLQUMxQixDQUFDLENBQUM7SUFFSCxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLG9CQUFvQixFQUFFO1FBQ2hELFVBQVUsRUFBRSxJQUFJO0tBQ2pCLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO1FBQ3RELFVBQVUsRUFBRTtZQUNWLEtBQUssRUFBRTtnQkFDTCw4Q0FBOEMsRUFBRSxpQkFBaUI7YUFDbEU7U0FDRjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLHNFQUFzRSxFQUFFLEdBQUcsRUFBRTtJQUNoRixNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ1YsSUFBSSw2Q0FBMkIsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO1lBQ2xELFlBQVksRUFBRSxLQUFLO1lBQ25CLG1CQUFtQixFQUFFLElBQUk7WUFDekIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGdDQUFnQyxDQUFDO1NBQ2hFLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxvSUFBb0ksQ0FBQyxDQUFDO0FBQ25KLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIHNmbiBmcm9tICcuLi8uLi8uLi9hd3Mtc3RlcGZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgU3RlcEZ1bmN0aW9uc1N0YXJ0RXhlY3V0aW9uIH0gZnJvbSAnLi4vLi4vbGliL3N0ZXBmdW5jdGlvbnMvc3RhcnQtZXhlY3V0aW9uJztcblxubGV0IHN0YWNrOiBTdGFjaztcbmxldCBjaGlsZDogc2ZuLlN0YXRlTWFjaGluZTtcbmJlZm9yZUVhY2goKCkgPT4ge1xuICBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjaGlsZCA9IG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnQ2hpbGRTdGF0ZU1hY2hpbmUnLCB7XG4gICAgZGVmaW5pdGlvbjogc2ZuLkNoYWluLnN0YXJ0KG5ldyBzZm4uUGFzcyhzdGFjaywgJ1Bhc3NTdGF0ZScpKSxcbiAgfSk7XG59KTtcblxudGVzdCgnRXhlY3V0ZSBTdGF0ZSBNYWNoaW5lIC0gRGVmYXVsdCAtIFJlcXVlc3QgUmVzcG9uc2UnLCAoKSA9PiB7XG4gIGNvbnN0IHRhc2sgPSBuZXcgU3RlcEZ1bmN0aW9uc1N0YXJ0RXhlY3V0aW9uKHN0YWNrLCAnQ2hpbGRUYXNrJywge1xuICAgIHN0YXRlTWFjaGluZTogY2hpbGQsXG4gICAgaW5wdXQ6IHNmbi5UYXNrSW5wdXQuZnJvbU9iamVjdCh7XG4gICAgICBmb286ICdiYXInLFxuICAgIH0pLFxuICAgIG5hbWU6ICdteUV4ZWN1dGlvbk5hbWUnLFxuICB9KTtcblxuICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1BhcmVudFN0YXRlTWFjaGluZScsIHtcbiAgICBkZWZpbml0aW9uOiB0YXNrLFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICBUeXBlOiAnVGFzaycsXG4gICAgUmVzb3VyY2U6IHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJzpzdGF0ZXM6OjpzdGF0ZXM6c3RhcnRFeGVjdXRpb24nLFxuICAgICAgICBdLFxuICAgICAgXSxcbiAgICB9LFxuICAgIEVuZDogdHJ1ZSxcbiAgICBQYXJhbWV0ZXJzOiB7XG4gICAgICBJbnB1dDoge1xuICAgICAgICBmb286ICdiYXInLFxuICAgICAgfSxcbiAgICAgIE5hbWU6ICdteUV4ZWN1dGlvbk5hbWUnLFxuICAgICAgU3RhdGVNYWNoaW5lQXJuOiB7XG4gICAgICAgIFJlZjogJ0NoaWxkU3RhdGVNYWNoaW5lOTEzMzExN0YnLFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdFeGVjdXRlIFN0YXRlIE1hY2hpbmUgLSBSdW4gSm9iJywgKCkgPT4ge1xuICBjb25zdCB0YXNrID0gbmV3IFN0ZXBGdW5jdGlvbnNTdGFydEV4ZWN1dGlvbihzdGFjaywgJ0NoaWxkVGFzaycsIHtcbiAgICBzdGF0ZU1hY2hpbmU6IGNoaWxkLFxuICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5SVU5fSk9CLFxuICB9KTtcblxuICBuZXcgc2ZuLlN0YXRlTWFjaGluZShzdGFjaywgJ1BhcmVudFN0YXRlTWFjaGluZScsIHtcbiAgICBkZWZpbml0aW9uOiB0YXNrLFxuICB9KTtcblxuICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh0YXNrLnRvU3RhdGVKc29uKCkpKS50b0VxdWFsKHtcbiAgICBUeXBlOiAnVGFzaycsXG4gICAgUmVzb3VyY2U6IHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAnYXJuOicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgUmVmOiAnQVdTOjpQYXJ0aXRpb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJzpzdGF0ZXM6OjpzdGF0ZXM6c3RhcnRFeGVjdXRpb24uc3luYzoyJyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBFbmQ6IHRydWUsXG4gICAgUGFyYW1ldGVyczoge1xuICAgICAgJ0lucHV0LiQnOiAnJCcsXG4gICAgICAnU3RhdGVNYWNoaW5lQXJuJzoge1xuICAgICAgICBSZWY6ICdDaGlsZFN0YXRlTWFjaGluZTkxMzMxMTdGJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICB7XG4gICAgICAgICAgQWN0aW9uOiAnc3RhdGVzOlN0YXJ0RXhlY3V0aW9uJyxcbiAgICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAgIFJlZjogJ0NoaWxkU3RhdGVNYWNoaW5lOTEzMzExN0YnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246IFsnc3RhdGVzOkRlc2NyaWJlRXhlY3V0aW9uJywgJ3N0YXRlczpTdG9wRXhlY3V0aW9uJ10sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiB7XG4gICAgICAgICAgICAnRm46OkpvaW4nOiBbXG4gICAgICAgICAgICAgICcnLFxuICAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6UGFydGl0aW9uJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICc6c3RhdGVzOicsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgUmVmOiAnQVdTOjpSZWdpb24nLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6QWNjb3VudElkJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICc6ZXhlY3V0aW9uOicsXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgJ0ZuOjpTZWxlY3QnOiBbXG4gICAgICAgICAgICAgICAgICAgIDYsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAnRm46OlNwbGl0JzogW1xuICAgICAgICAgICAgICAgICAgICAgICAgJzonLFxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBSZWY6ICdDaGlsZFN0YXRlTWFjaGluZTkxMzMxMTdGJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnKicsXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBBY3Rpb246IFsnZXZlbnRzOlB1dFRhcmdldHMnLCAnZXZlbnRzOlB1dFJ1bGUnLCAnZXZlbnRzOkRlc2NyaWJlUnVsZSddLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBSZXNvdXJjZToge1xuICAgICAgICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAgICAgICAnJyxcbiAgICAgICAgICAgICAgW1xuICAgICAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnOmV2ZW50czonLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIFJlZjogJ0FXUzo6UmVnaW9uJyxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICc6JyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICBSZWY6ICdBV1M6OkFjY291bnRJZCcsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnOnJ1bGUvU3RlcEZ1bmN0aW9uc0dldEV2ZW50c0ZvclN0ZXBGdW5jdGlvbnNFeGVjdXRpb25SdWxlJyxcbiAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgfSxcbiAgICBSb2xlczogW1xuICAgICAge1xuICAgICAgICBSZWY6ICdQYXJlbnRTdGF0ZU1hY2hpbmVSb2xlRTkwMkQwMDInLFxuICAgICAgfSxcbiAgICBdLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdFeGVjdXRlIFN0YXRlIE1hY2hpbmUgLSBXYWl0IEZvciBUYXNrIFRva2VuJywgKCkgPT4ge1xuICBjb25zdCB0YXNrID0gbmV3IFN0ZXBGdW5jdGlvbnNTdGFydEV4ZWN1dGlvbihzdGFjaywgJ0NoaWxkVGFzaycsIHtcbiAgICBzdGF0ZU1hY2hpbmU6IGNoaWxkLFxuICAgIGludGVncmF0aW9uUGF0dGVybjogc2ZuLkludGVncmF0aW9uUGF0dGVybi5XQUlUX0ZPUl9UQVNLX1RPS0VOLFxuICAgIGlucHV0OiBzZm4uVGFza0lucHV0LmZyb21PYmplY3Qoe1xuICAgICAgdG9rZW46IHNmbi5Kc29uUGF0aC50YXNrVG9rZW4sXG4gICAgfSksXG4gIH0pO1xuXG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnUGFyZW50U3RhdGVNYWNoaW5lJywge1xuICAgIGRlZmluaXRpb246IHRhc2ssXG4gIH0pO1xuXG4gIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvRXF1YWwoe1xuICAgIFR5cGU6ICdUYXNrJyxcbiAgICBSZXNvdXJjZToge1xuICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAnJyxcbiAgICAgICAgW1xuICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBSZWY6ICdBV1M6OlBhcnRpdGlvbicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnOnN0YXRlczo6OnN0YXRlczpzdGFydEV4ZWN1dGlvbi53YWl0Rm9yVGFza1Rva2VuJyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSxcbiAgICBFbmQ6IHRydWUsXG4gICAgUGFyYW1ldGVyczoge1xuICAgICAgSW5wdXQ6IHtcbiAgICAgICAgJ3Rva2VuLiQnOiAnJCQuVGFzay5Ub2tlbicsXG4gICAgICB9LFxuICAgICAgU3RhdGVNYWNoaW5lQXJuOiB7XG4gICAgICAgIFJlZjogJ0NoaWxkU3RhdGVNYWNoaW5lOTEzMzExN0YnLFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdFeGVjdXRlIFN0YXRlIE1hY2hpbmUgLSBXYWl0IEZvciBUYXNrIFRva2VuIC0gTWlzc2luZyBUYXNrIFRva2VuJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4ge1xuICAgIG5ldyBTdGVwRnVuY3Rpb25zU3RhcnRFeGVjdXRpb24oc3RhY2ssICdDaGlsZFRhc2snLCB7XG4gICAgICBzdGF0ZU1hY2hpbmU6IGNoaWxkLFxuICAgICAgaW50ZWdyYXRpb25QYXR0ZXJuOiBzZm4uSW50ZWdyYXRpb25QYXR0ZXJuLldBSVRfRk9SX1RBU0tfVE9LRU4sXG4gICAgfSk7XG4gIH0pLnRvVGhyb3coJ1Rhc2sgVG9rZW4gaXMgcmVxdWlyZWQgaW4gYGlucHV0YCBmb3IgY2FsbGJhY2suIFVzZSBKc29uUGF0aC50YXNrVG9rZW4gdG8gc2V0IHRoZSB0b2tlbi4nKTtcbn0pO1xuXG50ZXN0KCdFeGVjdXRlIFN0YXRlIE1hY2hpbmUgLSBBc3NvY2lhdGUgV2l0aCBQYXJlbnQgLSBJbnB1dCBQcm92aWRlZCcsICgpID0+IHtcbiAgY29uc3QgdGFzayA9IG5ldyBTdGVwRnVuY3Rpb25zU3RhcnRFeGVjdXRpb24oc3RhY2ssICdDaGlsZFRhc2snLCB7XG4gICAgc3RhdGVNYWNoaW5lOiBjaGlsZCxcbiAgICBpbnB1dDogc2ZuLlRhc2tJbnB1dC5mcm9tT2JqZWN0KHtcbiAgICAgIHRva2VuOiBzZm4uSnNvblBhdGgudGFza1Rva2VuLFxuICAgIH0pLFxuICAgIGFzc29jaWF0ZVdpdGhQYXJlbnQ6IHRydWUsXG4gIH0pO1xuXG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnUGFyZW50U3RhdGVNYWNoaW5lJywge1xuICAgIGRlZmluaXRpb246IHRhc2ssXG4gIH0pO1xuXG4gIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgIElucHV0OiB7XG4gICAgICAgICd0b2tlbi4kJzogJyQkLlRhc2suVG9rZW4nLFxuICAgICAgICAnQVdTX1NURVBfRlVOQ1RJT05TX1NUQVJURURfQllfRVhFQ1VUSU9OX0lELiQnOiAnJCQuRXhlY3V0aW9uLklkJyxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnRXhlY3V0ZSBTdGF0ZSBNYWNoaW5lIC0gQXNzb2NpYXRlIFdpdGggUGFyZW50IC0gSW5wdXQgTm90IFByb3ZpZGVkJywgKCkgPT4ge1xuICBjb25zdCB0YXNrID0gbmV3IFN0ZXBGdW5jdGlvbnNTdGFydEV4ZWN1dGlvbihzdGFjaywgJ0NoaWxkVGFzaycsIHtcbiAgICBzdGF0ZU1hY2hpbmU6IGNoaWxkLFxuICAgIGFzc29jaWF0ZVdpdGhQYXJlbnQ6IHRydWUsXG4gIH0pO1xuXG4gIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHN0YWNrLCAnUGFyZW50U3RhdGVNYWNoaW5lJywge1xuICAgIGRlZmluaXRpb246IHRhc2ssXG4gIH0pO1xuXG4gIGV4cGVjdChzdGFjay5yZXNvbHZlKHRhc2sudG9TdGF0ZUpzb24oKSkpLnRvTWF0Y2hPYmplY3Qoe1xuICAgIFBhcmFtZXRlcnM6IHtcbiAgICAgIElucHV0OiB7XG4gICAgICAgICdBV1NfU1RFUF9GVU5DVElPTlNfU1RBUlRFRF9CWV9FWEVDVVRJT05fSUQuJCc6ICckJC5FeGVjdXRpb24uSWQnLFxuICAgICAgfSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdFeGVjdXRlIFN0YXRlIE1hY2hpbmUgLSBBc3NvY2lhdGUgV2l0aCBQYXJlbnQgLSBJbmNvcnJlY3QgSW5wdXQgVHlwZScsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IHtcbiAgICBuZXcgU3RlcEZ1bmN0aW9uc1N0YXJ0RXhlY3V0aW9uKHN0YWNrLCAnQ2hpbGRUYXNrJywge1xuICAgICAgc3RhdGVNYWNoaW5lOiBjaGlsZCxcbiAgICAgIGFzc29jaWF0ZVdpdGhQYXJlbnQ6IHRydWUsXG4gICAgICBpbnB1dDogc2ZuLlRhc2tJbnB1dC5mcm9tVGV4dCgneyBcInRva2VuLiRcIjogXCIkJC5UYXNrLlRva2VuXCIgfScpLFxuICAgIH0pO1xuICB9KS50b1Rocm93KCdDb3VsZCBub3QgZW5hYmxlIGBhc3NvY2lhdGVXaXRoUGFyZW50YCBiZWNhdXNlIGBpbnB1dGAgaXMgdGFrZW4gZGlyZWN0bHkgZnJvbSBhIEpTT04gcGF0aC4gVXNlIGBzZm4uVGFza0lucHV0LmZyb21PYmplY3RgIGluc3RlYWQuJyk7XG59KTsiXX0=