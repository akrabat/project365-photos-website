"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const os = require("os");
const path = require("path");
const semver = require("semver");
const lib_1 = require("../lib");
const FIXTURES = path.join(__dirname, 'fixtures');
function fixture(name) {
    return path.join(FIXTURES, name, 'manifest.json');
}
test('manifest save', () => {
    const outdir = fs.mkdtempSync(path.join(os.tmpdir(), 'schema-tests'));
    const manifestFile = path.join(outdir, 'manifest.json');
    const assemblyManifest = {
        version: 'version',
        runtime: {
            libraries: { lib1: '1.2.3' },
        },
    };
    lib_1.Manifest.saveAssemblyManifest(assemblyManifest, manifestFile);
    const saved = JSON.parse(fs.readFileSync(manifestFile, { encoding: 'utf-8' }));
    expect(saved).toEqual({
        ...assemblyManifest,
        version: lib_1.Manifest.version(), // version is forced
    });
});
test('manifest load', () => {
    const loaded = lib_1.Manifest.loadAssemblyManifest(fixture('only-version'));
    expect(loaded).toMatchSnapshot();
});
test('manifest load fails for invalid nested property', () => {
    expect(() => lib_1.Manifest.loadAssemblyManifest(fixture('invalid-nested-property'))).toThrow(/Invalid assembly manifest/);
});
test('manifest load fails for invalid artifact type', () => {
    expect(() => lib_1.Manifest.loadAssemblyManifest(fixture('invalid-artifact-type'))).toThrow(/Invalid assembly manifest/);
});
test('manifest load fails on higher major version', () => {
    expect(() => lib_1.Manifest.loadAssemblyManifest(fixture('high-version'))).toThrow(/Cloud assembly schema version mismatch/);
});
// once we start introducing minor version bumps that are considered
// non breaking, this test can be removed.
test('manifest load fails on higher minor version', () => {
    const outdir = fs.mkdtempSync(path.join(os.tmpdir(), 'schema-tests'));
    const manifestFile = path.join(outdir, 'manifest.json');
    const newVersion = semver.inc(lib_1.Manifest.version(), 'minor');
    expect(newVersion).toBeTruthy();
    if (newVersion) {
        const assemblyManifest = {
            version: newVersion,
        };
        // can't use saveAssemblyManifest because it will force the correct version
        fs.writeFileSync(manifestFile, JSON.stringify(assemblyManifest));
        expect(() => lib_1.Manifest.loadAssemblyManifest(manifestFile)).toThrow(/Cloud assembly schema version mismatch/);
    }
});
test('manifest load doesnt fail if version checking is disabled, and unknown properties are added', () => {
    const outdir = fs.mkdtempSync(path.join(os.tmpdir(), 'schema-tests'));
    const manifestFile = path.join(outdir, 'manifest.json');
    const newVersion = semver.inc(lib_1.Manifest.version(), 'major');
    expect(newVersion).toBeTruthy();
    const assemblyManifest = {
        version: newVersion,
        artifacts: {
            SomeArtifact: {
                type: 'aws:cloudformation:stack',
                thisPropertyWillNeverBeInTheManifest: 'i_hope',
            },
            UnknownArtifact: {
                type: 'unknown-artifact-type',
            },
        },
    };
    // can't use saveAssemblyManifest because it will force the correct version
    fs.writeFileSync(manifestFile, JSON.stringify(assemblyManifest));
    lib_1.Manifest.loadAssemblyManifest(manifestFile, { skipVersionCheck: true, skipEnumCheck: true });
});
// once we start introducing patch version bumps that are considered
// non breaking, this test can be removed.
test('manifest load fails on higher patch version', () => {
    const outdir = fs.mkdtempSync(path.join(os.tmpdir(), 'schema-tests'));
    const manifestFile = path.join(outdir, 'manifest.json');
    const newVersion = semver.inc(lib_1.Manifest.version(), 'patch');
    expect(newVersion).toBeTruthy();
    if (newVersion) {
        const assemblyManifest = {
            version: newVersion,
        };
        // can't use saveAssemblyManifest because it will force the correct version
        fs.writeFileSync(manifestFile, JSON.stringify(assemblyManifest));
        expect(() => lib_1.Manifest.loadAssemblyManifest(manifestFile)).toThrow(/Cloud assembly schema version mismatch/);
    }
});
test('manifest load fails on invalid version', () => {
    expect(() => lib_1.Manifest.loadAssemblyManifest(fixture('invalid-version'))).toThrow(/Invalid semver string/);
});
test('manifest load succeeds on unknown properties', () => {
    const manifest = lib_1.Manifest.loadAssemblyManifest(fixture('unknown-property'));
    expect(manifest.version).toEqual('0.0.0');
});
test('stack-tags are deserialized properly', () => {
    const m = lib_1.Manifest.loadAssemblyManifest(fixture('with-stack-tags'));
    if (m.artifacts?.stack?.metadata?.AwsCdkPlaygroundBatch[0].data) {
        const entry = m.artifacts.stack.metadata.AwsCdkPlaygroundBatch[0].data;
        expect(entry[0].key).toEqual('hello');
        expect(entry[0].value).toEqual('world');
    }
    expect(m.version).toEqual('0.0.0');
});
test('can access random metadata', () => {
    const loaded = lib_1.Manifest.loadAssemblyManifest(fixture('random-metadata'));
    const randomArray = loaded.artifacts?.stack.metadata?.AwsCdkPlaygroundBatch[0].data;
    const randomNumber = loaded.artifacts?.stack.metadata?.AwsCdkPlaygroundBatch[1].data;
    const randomMap = loaded.artifacts?.stack.metadata?.AwsCdkPlaygroundBatch[2].data;
    expect(randomArray).toEqual(['42']);
    expect(randomNumber).toEqual(42);
    expect(randomMap).toEqual({
        key: 'value',
    });
    expect(randomMap).toBeTruthy();
    if (randomMap) {
        expect(randomMap.key).toEqual('value');
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuaWZlc3QudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hbmlmZXN0LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBeUI7QUFDekIseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QixpQ0FBaUM7QUFDakMsZ0NBQTRFO0FBRTVFLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBRWxELFNBQVMsT0FBTyxDQUFDLElBQVk7SUFDM0IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQUVELElBQUksQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBRXpCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN0RSxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxlQUFlLENBQUMsQ0FBQztJQUV4RCxNQUFNLGdCQUFnQixHQUFxQjtRQUN6QyxPQUFPLEVBQUUsU0FBUztRQUNsQixPQUFPLEVBQUU7WUFDUCxTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFO1NBQzdCO0tBQ0YsQ0FBQztJQUVGLGNBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxnQkFBZ0IsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUU5RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUUvRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ3BCLEdBQUcsZ0JBQWdCO1FBQ25CLE9B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QUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBBc3NlbWJseU1hbmlmZXN0LCBNYW5pZmVzdCwgU3RhY2tUYWdzTWV0YWRhdGFFbnRyeSB9IGZyb20gJy4uL2xpYic7XG5cbmNvbnN0IEZJWFRVUkVTID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2ZpeHR1cmVzJyk7XG5cbmZ1bmN0aW9uIGZpeHR1cmUobmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBwYXRoLmpvaW4oRklYVFVSRVMsIG5hbWUsICdtYW5pZmVzdC5qc29uJyk7XG59XG5cbnRlc3QoJ21hbmlmZXN0IHNhdmUnLCAoKSA9PiB7XG5cbiAgY29uc3Qgb3V0ZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnc2NoZW1hLXRlc3RzJykpO1xuICBjb25zdCBtYW5pZmVzdEZpbGUgPSBwYXRoLmpvaW4ob3V0ZGlyLCAnbWFuaWZlc3QuanNvbicpO1xuXG4gIGNvbnN0IGFzc2VtYmx5TWFuaWZlc3Q6IEFzc2VtYmx5TWFuaWZlc3QgPSB7XG4gICAgdmVyc2lvbjogJ3ZlcnNpb24nLFxuICAgIHJ1bnRpbWU6IHtcbiAgICAgIGxpYnJhcmllczogeyBsaWIxOiAnMS4yLjMnIH0sXG4gICAgfSxcbiAgfTtcblxuICBNYW5pZmVzdC5zYXZlQXNzZW1ibHlNYW5pZmVzdChhc3NlbWJseU1hbmlmZXN0LCBtYW5pZmVzdEZpbGUpO1xuXG4gIGNvbnN0IHNhdmVkID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMobWFuaWZlc3RGaWxlLCB7IGVuY29kaW5nOiAndXRmLTgnIH0pKTtcblxuICBleHBlY3Qoc2F2ZWQpLnRvRXF1YWwoe1xuICAgIC4uLmFzc2VtYmx5TWFuaWZlc3QsXG4gICAgdmVyc2lvbjogTWFuaWZlc3QudmVyc2lvbigpLCAvLyB2ZXJzaW9uIGlzIGZvcmNlZFxuICB9KTtcbn0pO1xuXG50ZXN0KCdtYW5pZmVzdCBsb2FkJywgKCkgPT4ge1xuICBjb25zdCBsb2FkZWQgPSBNYW5pZmVzdC5sb2FkQXNzZW1ibHlNYW5pZmVzdChmaXh0dXJlKCdvbmx5LXZlcnNpb24nKSk7XG4gIGV4cGVjdChsb2FkZWQpLnRvTWF0Y2hTbmFwc2hvdCgpO1xufSk7XG5cbnRlc3QoJ21hbmlmZXN0IGxvYWQgZmFpbHMgZm9yIGludmFsaWQgbmVzdGVkIHByb3BlcnR5JywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4gTWFuaWZlc3QubG9hZEFzc2VtYmx5TWFuaWZlc3QoZml4dHVyZSgnaW52YWxpZC1uZXN0ZWQtcHJvcGVydHknKSkpLnRvVGhyb3coL0ludmFsaWQgYXNzZW1ibHkgbWFuaWZlc3QvKTtcbn0pO1xuXG50ZXN0KCdtYW5pZmVzdCBsb2FkIGZhaWxzIGZvciBpbnZhbGlkIGFydGlmYWN0IHR5cGUnLCAoKSA9PiB7XG4gIGV4cGVjdCgoKSA9PiBNYW5pZmVzdC5sb2FkQXNzZW1ibHlNYW5pZmVzdChmaXh0dXJlKCdpbnZhbGlkLWFydGlmYWN0LXR5cGUnKSkpLnRvVGhyb3coL0ludmFsaWQgYXNzZW1ibHkgbWFuaWZlc3QvKTtcbn0pO1xuXG50ZXN0KCdtYW5pZmVzdCBsb2FkIGZhaWxzIG9uIGhpZ2hlciBtYWpvciB2ZXJzaW9uJywgKCkgPT4ge1xuICBleHBlY3QoKCkgPT4gTWFuaWZlc3QubG9hZEFzc2VtYmx5TWFuaWZlc3QoZml4dHVyZSgnaGlnaC12ZXJzaW9uJykpKS50b1Rocm93KC9DbG91ZCBhc3NlbWJseSBzY2hlbWEgdmVyc2lvbiBtaXNtYXRjaC8pO1xufSk7XG5cbi8vIG9uY2Ugd2Ugc3RhcnQgaW50cm9kdWNpbmcgbWlub3IgdmVyc2lvbiBidW1wcyB0aGF0IGFyZSBjb25zaWRlcmVkXG4vLyBub24gYnJlYWtpbmcsIHRoaXMgdGVzdCBjYW4gYmUgcmVtb3ZlZC5cbnRlc3QoJ21hbmlmZXN0IGxvYWQgZmFpbHMgb24gaGlnaGVyIG1pbm9yIHZlcnNpb24nLCAoKSA9PiB7XG5cbiAgY29uc3Qgb3V0ZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnc2NoZW1hLXRlc3RzJykpO1xuICBjb25zdCBtYW5pZmVzdEZpbGUgPSBwYXRoLmpvaW4ob3V0ZGlyLCAnbWFuaWZlc3QuanNvbicpO1xuXG4gIGNvbnN0IG5ld1ZlcnNpb24gPSBzZW12ZXIuaW5jKE1hbmlmZXN0LnZlcnNpb24oKSwgJ21pbm9yJyk7XG4gIGV4cGVjdChuZXdWZXJzaW9uKS50b0JlVHJ1dGh5KCk7XG5cbiAgaWYgKG5ld1ZlcnNpb24pIHtcbiAgICBjb25zdCBhc3NlbWJseU1hbmlmZXN0OiBBc3NlbWJseU1hbmlmZXN0ID0ge1xuICAgICAgdmVyc2lvbjogbmV3VmVyc2lvbixcbiAgICB9O1xuXG4gICAgLy8gY2FuJ3QgdXNlIHNhdmVBc3NlbWJseU1hbmlmZXN0IGJlY2F1c2UgaXQgd2lsbCBmb3JjZSB0aGUgY29ycmVjdCB2ZXJzaW9uXG4gICAgZnMud3JpdGVGaWxlU3luYyhtYW5pZmVzdEZpbGUsIEpTT04uc3RyaW5naWZ5KGFzc2VtYmx5TWFuaWZlc3QpKTtcblxuICAgIGV4cGVjdCgoKSA9PiBNYW5pZmVzdC5sb2FkQXNzZW1ibHlNYW5pZmVzdChtYW5pZmVzdEZpbGUpKS50b1Rocm93KC9DbG91ZCBhc3NlbWJseSBzY2hlbWEgdmVyc2lvbiBtaXNtYXRjaC8pO1xuICB9XG59KTtcblxudGVzdCgnbWFuaWZlc3QgbG9hZCBkb2VzbnQgZmFpbCBpZiB2ZXJzaW9uIGNoZWNraW5nIGlzIGRpc2FibGVkLCBhbmQgdW5rbm93biBwcm9wZXJ0aWVzIGFyZSBhZGRlZCcsICgpID0+IHtcbiAgY29uc3Qgb3V0ZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnc2NoZW1hLXRlc3RzJykpO1xuICBjb25zdCBtYW5pZmVzdEZpbGUgPSBwYXRoLmpvaW4ob3V0ZGlyLCAnbWFuaWZlc3QuanNvbicpO1xuICBjb25zdCBuZXdWZXJzaW9uID0gc2VtdmVyLmluYyhNYW5pZmVzdC52ZXJzaW9uKCksICdtYWpvcicpO1xuICBleHBlY3QobmV3VmVyc2lvbikudG9CZVRydXRoeSgpO1xuXG4gIGNvbnN0IGFzc2VtYmx5TWFuaWZlc3Q6IEFzc2VtYmx5TWFuaWZlc3QgPSB7XG4gICAgdmVyc2lvbjogbmV3VmVyc2lvbiEsXG4gICAgYXJ0aWZhY3RzOiB7XG4gICAgICBTb21lQXJ0aWZhY3Q6IHtcbiAgICAgICAgdHlwZTogJ2F3czpjbG91ZGZvcm1hdGlvbjpzdGFjaycsXG4gICAgICAgIHRoaXNQcm9wZXJ0eVdpbGxOZXZlckJlSW5UaGVNYW5pZmVzdDogJ2lfaG9wZScsXG4gICAgICB9IGFzIGFueSxcbiAgICAgIFVua25vd25BcnRpZmFjdDoge1xuICAgICAgICB0eXBlOiAndW5rbm93bi1hcnRpZmFjdC10eXBlJyxcbiAgICAgIH0gYXMgYW55LFxuICAgIH0sXG4gIH07XG5cbiAgLy8gY2FuJ3QgdXNlIHNhdmVBc3NlbWJseU1hbmlmZXN0IGJlY2F1c2UgaXQgd2lsbCBmb3JjZSB0aGUgY29ycmVjdCB2ZXJzaW9uXG4gIGZzLndyaXRlRmlsZVN5bmMobWFuaWZlc3RGaWxlLCBKU09OLnN0cmluZ2lmeShhc3NlbWJseU1hbmlmZXN0KSk7XG5cbiAgTWFuaWZlc3QubG9hZEFzc2VtYmx5TWFuaWZlc3QobWFuaWZlc3RGaWxlLCB7IHNraXBWZXJzaW9uQ2hlY2s6IHRydWUsIHNraXBFbnVtQ2hlY2s6IHRydWUgfSk7XG59KTtcblxuLy8gb25jZSB3ZSBzdGFydCBpbnRyb2R1Y2luZyBwYXRjaCB2ZXJzaW9uIGJ1bXBzIHRoYXQgYXJlIGNvbnNpZGVyZWRcbi8vIG5vbiBicmVha2luZywgdGhpcyB0ZXN0IGNhbiBiZSByZW1vdmVkLlxudGVzdCgnbWFuaWZlc3QgbG9hZCBmYWlscyBvbiBoaWdoZXIgcGF0Y2ggdmVyc2lvbicsICgpID0+IHtcblxuICBjb25zdCBvdXRkaXIgPSBmcy5ta2R0ZW1wU3luYyhwYXRoLmpvaW4ob3MudG1wZGlyKCksICdzY2hlbWEtdGVzdHMnKSk7XG4gIGNvbnN0IG1hbmlmZXN0RmlsZSA9IHBhdGguam9pbihvdXRkaXIsICdtYW5pZmVzdC5qc29uJyk7XG5cbiAgY29uc3QgbmV3VmVyc2lvbiA9IHNlbXZlci5pbmMoTWFuaWZlc3QudmVyc2lvbigpLCAncGF0Y2gnKTtcbiAgZXhwZWN0KG5ld1ZlcnNpb24pLnRvQmVUcnV0aHkoKTtcblxuICBpZiAobmV3VmVyc2lvbikge1xuICAgIGNvbnN0IGFzc2VtYmx5TWFuaWZlc3Q6IEFzc2VtYmx5TWFuaWZlc3QgPSB7XG4gICAgICB2ZXJzaW9uOiBuZXdWZXJzaW9uLFxuICAgIH07XG5cbiAgICAvLyBjYW4ndCB1c2Ugc2F2ZUFzc2VtYmx5TWFuaWZlc3QgYmVjYXVzZSBpdCB3aWxsIGZvcmNlIHRoZSBjb3JyZWN0IHZlcnNpb25cbiAgICBmcy53cml0ZUZpbGVTeW5jKG1hbmlmZXN0RmlsZSwgSlNPTi5zdHJpbmdpZnkoYXNzZW1ibHlNYW5pZmVzdCkpO1xuXG4gICAgZXhwZWN0KCgpID0+IE1hbmlmZXN0LmxvYWRBc3NlbWJseU1hbmlmZXN0KG1hbmlmZXN0RmlsZSkpLnRvVGhyb3coL0Nsb3VkIGFzc2VtYmx5IHNjaGVtYSB2ZXJzaW9uIG1pc21hdGNoLyk7XG4gIH1cbn0pO1xuXG50ZXN0KCdtYW5pZmVzdCBsb2FkIGZhaWxzIG9uIGludmFsaWQgdmVyc2lvbicsICgpID0+IHtcbiAgZXhwZWN0KCgpID0+IE1hbmlmZXN0LmxvYWRBc3NlbWJseU1hbmlmZXN0KGZpeHR1cmUoJ2ludmFsaWQtdmVyc2lvbicpKSkudG9UaHJvdygvSW52YWxpZCBzZW12ZXIgc3RyaW5nLyk7XG59KTtcblxudGVzdCgnbWFuaWZlc3QgbG9hZCBzdWNjZWVkcyBvbiB1bmtub3duIHByb3BlcnRpZXMnLCAoKSA9PiB7XG4gIGNvbnN0IG1hbmlmZXN0ID0gTWFuaWZlc3QubG9hZEFzc2VtYmx5TWFuaWZlc3QoZml4dHVyZSgndW5rbm93bi1wcm9wZXJ0eScpKTtcbiAgZXhwZWN0KG1hbmlmZXN0LnZlcnNpb24pLnRvRXF1YWwoJzAuMC4wJyk7XG59KTtcblxudGVzdCgnc3RhY2stdGFncyBhcmUgZGVzZXJpYWxpemVkIHByb3Blcmx5JywgKCkgPT4ge1xuXG4gIGNvbnN0IG06IEFzc2VtYmx5TWFuaWZlc3QgPSBNYW5pZmVzdC5sb2FkQXNzZW1ibHlNYW5pZmVzdChmaXh0dXJlKCd3aXRoLXN0YWNrLXRhZ3MnKSk7XG5cbiAgaWYgKG0uYXJ0aWZhY3RzPy5zdGFjaz8ubWV0YWRhdGE/LkF3c0Nka1BsYXlncm91bmRCYXRjaFswXS5kYXRhKSB7XG4gICAgY29uc3QgZW50cnkgPSBtLmFydGlmYWN0cy5zdGFjay5tZXRhZGF0YS5Bd3NDZGtQbGF5Z3JvdW5kQmF0Y2hbMF0uZGF0YSBhcyBTdGFja1RhZ3NNZXRhZGF0YUVudHJ5O1xuICAgIGV4cGVjdChlbnRyeVswXS5rZXkpLnRvRXF1YWwoJ2hlbGxvJyk7XG4gICAgZXhwZWN0KGVudHJ5WzBdLnZhbHVlKS50b0VxdWFsKCd3b3JsZCcpO1xuICB9XG4gIGV4cGVjdChtLnZlcnNpb24pLnRvRXF1YWwoJzAuMC4wJyk7XG5cbn0pO1xuXG50ZXN0KCdjYW4gYWNjZXNzIHJhbmRvbSBtZXRhZGF0YScsICgpID0+IHtcblxuICBjb25zdCBsb2FkZWQgPSBNYW5pZmVzdC5sb2FkQXNzZW1ibHlNYW5pZmVzdChmaXh0dXJlKCdyYW5kb20tbWV0YWRhdGEnKSk7XG4gIGNvbnN0IHJhbmRvbUFycmF5ID0gbG9hZGVkLmFydGlmYWN0cz8uc3RhY2subWV0YWRhdGE/LkF3c0Nka1BsYXlncm91bmRCYXRjaFswXS5kYXRhO1xuICBjb25zdCByYW5kb21OdW1iZXIgPSBsb2FkZWQuYXJ0aWZhY3RzPy5zdGFjay5tZXRhZGF0YT8uQXdzQ2RrUGxheWdyb3VuZEJhdGNoWzFdLmRhdGE7XG4gIGNvbnN0IHJhbmRvbU1hcCA9IGxvYWRlZC5hcnRpZmFjdHM/LnN0YWNrLm1ldGFkYXRhPy5Bd3NDZGtQbGF5Z3JvdW5kQmF0Y2hbMl0uZGF0YTtcblxuICBleHBlY3QocmFuZG9tQXJyYXkpLnRvRXF1YWwoWyc0MiddKTtcbiAgZXhwZWN0KHJhbmRvbU51bWJlcikudG9FcXVhbCg0Mik7XG4gIGV4cGVjdChyYW5kb21NYXApLnRvRXF1YWwoe1xuICAgIGtleTogJ3ZhbHVlJyxcbiAgfSk7XG5cbiAgZXhwZWN0KHJhbmRvbU1hcCkudG9CZVRydXRoeSgpO1xuXG4gIGlmIChyYW5kb21NYXApIHtcbiAgICBleHBlY3QoKHJhbmRvbU1hcCBhcyBhbnkpLmtleSkudG9FcXVhbCgndmFsdWUnKTtcbiAgfVxuXG59KTtcbiJdfQ==