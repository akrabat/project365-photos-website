"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const assertions_1 = require("../../assertions");
const core = require("../../core");
const cxapi = require("../../cx-api");
const inc = require("../lib");
const futils = require("../lib/file-utils");
/* eslint-disable quote-props */
/* eslint-disable quotes */
describe('CDK Include for templates with SAM transform', () => {
    let stack;
    beforeEach(() => {
        const app = new core.App({ context: { [cxapi.NEW_STYLE_STACK_SYNTHESIS_CONTEXT]: false } });
        stack = new core.Stack(app);
    });
    test('can ingest a template with only a minimal SAM function using S3Location for CodeUri, and output it unchanged', () => {
        includeTestTemplate(stack, 'only-minimal-sam-function-codeuri-as-s3location.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('only-minimal-sam-function-codeuri-as-s3location.yaml'));
    });
    test('can ingest a template with only a SAM function using an array with DDB CRUD for Policies, and output it unchanged', () => {
        includeTestTemplate(stack, 'only-sam-function-policies-array-ddb-crud.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('only-sam-function-policies-array-ddb-crud.yaml'));
    });
    test('can ingest a template with only a minimal SAM function using a parameter for CodeUri, and output it unchanged', () => {
        includeTestTemplate(stack, 'only-minimal-sam-function-codeuri-as-param.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('only-minimal-sam-function-codeuri-as-param.yaml'));
    });
    test('can ingest a template with only a minimal SAM function using a parameter for CodeUri Bucket property, and output it unchanged', () => {
        includeTestTemplate(stack, 'only-minimal-sam-function-codeuri-bucket-as-param.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('only-minimal-sam-function-codeuri-bucket-as-param.yaml'));
    });
    test('can ingest a template with only a SAM function using an array with DDB CRUD for Policies with an Fn::If expression, and output it unchanged', () => {
        includeTestTemplate(stack, 'only-sam-function-policies-array-ddb-crud-if.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('only-sam-function-policies-array-ddb-crud-if.yaml'));
    });
    test('can ingest a template with a a union-type property provided as an object, and output it unchanged', () => {
        includeTestTemplate(stack, 'api-endpoint-config-object.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('api-endpoint-config-object.yaml'));
    });
    test('can ingest a template with a a union-type property provided as a string, and output it unchanged', () => {
        includeTestTemplate(stack, 'api-endpoint-config-string.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('api-endpoint-config-string.yaml'));
    });
    test('can ingest a template with a a union-type property provided as an empty string, and output it unchanged', () => {
        includeTestTemplate(stack, 'api-endpoint-config-string-empty.yaml');
        assertions_1.Template.fromStack(stack).templateMatches(loadTestFileToJsObject('api-endpoint-config-string-empty.yaml'));
    });
});
function includeTestTemplate(scope, testTemplate) {
    return new inc.CfnInclude(scope, 'MyScope', {
        templateFile: _testTemplateFilePath(testTemplate),
    });
}
function loadTestFileToJsObject(testTemplate) {
    return futils.readYamlSync(_testTemplateFilePath(testTemplate));
}
function _testTemplateFilePath(testTemplate) {
    return path.join(__dirname, 'test-templates', 'sam', testTemplate);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVybGVzcy10cmFuc2Zvcm0udGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlcnZlcmxlc3MtdHJhbnNmb3JtLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsaURBQTRDO0FBQzVDLG1DQUFtQztBQUNuQyxzQ0FBc0M7QUFFdEMsOEJBQThCO0FBQzlCLDRDQUE0QztBQUU1QyxnQ0FBZ0M7QUFDaEMsMkJBQTJCO0FBRTNCLFFBQVEsQ0FBQyw4Q0FBOEMsRUFBRSxHQUFHLEVBQUU7SUFDNUQsSUFBSSxLQUFpQixDQUFDO0lBRXRCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM1RixLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlCLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDhHQUE4RyxFQUFFLEdBQUcsRUFBRTtRQUN4SCxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsc0RBQXNELENBQUMsQ0FBQztRQUVuRixxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQ3ZDLHNCQUFzQixDQUFDLHNEQUFzRCxDQUFDLENBQy9FLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxtSEFBbUgsRUFBRSxHQUFHLEVBQUU7UUFDN0gsbUJBQW1CLENBQUMsS0FBSyxFQUFFLGdEQUFnRCxDQUFDLENBQUM7UUFFN0UscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsZUFBZSxDQUN2QyxzQkFBc0IsQ0FBQyxnREFBZ0QsQ0FBQyxDQUN6RSxDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsK0dBQStHLEVBQUUsR0FBRyxFQUFFO1FBQ3pILG1CQUFtQixDQUFDLEtBQUssRUFBRSxpREFBaUQsQ0FBQyxDQUFDO1FBRTlFLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLGVBQWUsQ0FDdkMsc0JBQXNCLENBQUMsaURBQWlELENBQUMsQ0FDMUUsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLCtIQUErSCxFQUFFLEdBQUcsRUFBRTtRQUN6SSxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsd0RBQXdELENBQUMsQ0FBQztRQUVyRixxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQ3ZDLHNCQUFzQixDQUFDLHdEQUF3RCxDQUFDLENBQ2pGLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw2SUFBNkksRUFBRSxHQUFHLEVBQUU7UUFDdkosbUJBQW1CLENBQUMsS0FBSyxFQUFFLG1EQUFtRCxDQUFDLENBQUM7UUFFaEYscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsZUFBZSxDQUN2QyxzQkFBc0IsQ0FBQyxtREFBbUQsQ0FBQyxDQUM1RSxDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsbUdBQW1HLEVBQUUsR0FBRyxFQUFFO1FBQzdHLG1CQUFtQixDQUFDLEtBQUssRUFBRSxpQ0FBaUMsQ0FBQyxDQUFDO1FBRTlELHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLGVBQWUsQ0FDdkMsc0JBQXNCLENBQUMsaUNBQWlDLENBQUMsQ0FDMUQsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGtHQUFrRyxFQUFFLEdBQUcsRUFBRTtRQUM1RyxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsaUNBQWlDLENBQUMsQ0FBQztRQUU5RCxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQ3ZDLHNCQUFzQixDQUFDLGlDQUFpQyxDQUFDLENBQzFELENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx5R0FBeUcsRUFBRSxHQUFHLEVBQUU7UUFDbkgsbUJBQW1CLENBQUMsS0FBSyxFQUFFLHVDQUF1QyxDQUFDLENBQUM7UUFFcEUscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsZUFBZSxDQUN2QyxzQkFBc0IsQ0FBQyx1Q0FBdUMsQ0FBQyxDQUNoRSxDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILFNBQVMsbUJBQW1CLENBQUMsS0FBMkIsRUFBRSxZQUFvQjtJQUM1RSxPQUFPLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFO1FBQzFDLFlBQVksRUFBRSxxQkFBcUIsQ0FBQyxZQUFZLENBQUM7S0FDbEQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQVMsc0JBQXNCLENBQUMsWUFBb0I7SUFDbEQsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7QUFDbEUsQ0FBQztBQUVELFNBQVMscUJBQXFCLENBQUMsWUFBb0I7SUFDakQsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgY29yZSBmcm9tICcuLi8uLi9jb3JlJztcbmltcG9ydCAqIGFzIGN4YXBpIGZyb20gJy4uLy4uL2N4LWFwaSc7XG5pbXBvcnQgKiBhcyBjb25zdHJ1Y3RzIGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgaW5jIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgKiBhcyBmdXRpbHMgZnJvbSAnLi4vbGliL2ZpbGUtdXRpbHMnO1xuXG4vKiBlc2xpbnQtZGlzYWJsZSBxdW90ZS1wcm9wcyAqL1xuLyogZXNsaW50LWRpc2FibGUgcXVvdGVzICovXG5cbmRlc2NyaWJlKCdDREsgSW5jbHVkZSBmb3IgdGVtcGxhdGVzIHdpdGggU0FNIHRyYW5zZm9ybScsICgpID0+IHtcbiAgbGV0IHN0YWNrOiBjb3JlLlN0YWNrO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCh7IGNvbnRleHQ6IHsgW2N4YXBpLk5FV19TVFlMRV9TVEFDS19TWU5USEVTSVNfQ09OVEVYVF06IGZhbHNlIH0gfSk7XG4gICAgc3RhY2sgPSBuZXcgY29yZS5TdGFjayhhcHApO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gaW5nZXN0IGEgdGVtcGxhdGUgd2l0aCBvbmx5IGEgbWluaW1hbCBTQU0gZnVuY3Rpb24gdXNpbmcgUzNMb2NhdGlvbiBmb3IgQ29kZVVyaSwgYW5kIG91dHB1dCBpdCB1bmNoYW5nZWQnLCAoKSA9PiB7XG4gICAgaW5jbHVkZVRlc3RUZW1wbGF0ZShzdGFjaywgJ29ubHktbWluaW1hbC1zYW0tZnVuY3Rpb24tY29kZXVyaS1hcy1zM2xvY2F0aW9uLnlhbWwnKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykudGVtcGxhdGVNYXRjaGVzKFxuICAgICAgbG9hZFRlc3RGaWxlVG9Kc09iamVjdCgnb25seS1taW5pbWFsLXNhbS1mdW5jdGlvbi1jb2RldXJpLWFzLXMzbG9jYXRpb24ueWFtbCcpLFxuICAgICk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NhbiBpbmdlc3QgYSB0ZW1wbGF0ZSB3aXRoIG9ubHkgYSBTQU0gZnVuY3Rpb24gdXNpbmcgYW4gYXJyYXkgd2l0aCBEREIgQ1JVRCBmb3IgUG9saWNpZXMsIGFuZCBvdXRwdXQgaXQgdW5jaGFuZ2VkJywgKCkgPT4ge1xuICAgIGluY2x1ZGVUZXN0VGVtcGxhdGUoc3RhY2ssICdvbmx5LXNhbS1mdW5jdGlvbi1wb2xpY2llcy1hcnJheS1kZGItY3J1ZC55YW1sJyk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnRlbXBsYXRlTWF0Y2hlcyhcbiAgICAgIGxvYWRUZXN0RmlsZVRvSnNPYmplY3QoJ29ubHktc2FtLWZ1bmN0aW9uLXBvbGljaWVzLWFycmF5LWRkYi1jcnVkLnlhbWwnKSxcbiAgICApO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gaW5nZXN0IGEgdGVtcGxhdGUgd2l0aCBvbmx5IGEgbWluaW1hbCBTQU0gZnVuY3Rpb24gdXNpbmcgYSBwYXJhbWV0ZXIgZm9yIENvZGVVcmksIGFuZCBvdXRwdXQgaXQgdW5jaGFuZ2VkJywgKCkgPT4ge1xuICAgIGluY2x1ZGVUZXN0VGVtcGxhdGUoc3RhY2ssICdvbmx5LW1pbmltYWwtc2FtLWZ1bmN0aW9uLWNvZGV1cmktYXMtcGFyYW0ueWFtbCcpO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS50ZW1wbGF0ZU1hdGNoZXMoXG4gICAgICBsb2FkVGVzdEZpbGVUb0pzT2JqZWN0KCdvbmx5LW1pbmltYWwtc2FtLWZ1bmN0aW9uLWNvZGV1cmktYXMtcGFyYW0ueWFtbCcpLFxuICAgICk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NhbiBpbmdlc3QgYSB0ZW1wbGF0ZSB3aXRoIG9ubHkgYSBtaW5pbWFsIFNBTSBmdW5jdGlvbiB1c2luZyBhIHBhcmFtZXRlciBmb3IgQ29kZVVyaSBCdWNrZXQgcHJvcGVydHksIGFuZCBvdXRwdXQgaXQgdW5jaGFuZ2VkJywgKCkgPT4ge1xuICAgIGluY2x1ZGVUZXN0VGVtcGxhdGUoc3RhY2ssICdvbmx5LW1pbmltYWwtc2FtLWZ1bmN0aW9uLWNvZGV1cmktYnVja2V0LWFzLXBhcmFtLnlhbWwnKTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaykudGVtcGxhdGVNYXRjaGVzKFxuICAgICAgbG9hZFRlc3RGaWxlVG9Kc09iamVjdCgnb25seS1taW5pbWFsLXNhbS1mdW5jdGlvbi1jb2RldXJpLWJ1Y2tldC1hcy1wYXJhbS55YW1sJyksXG4gICAgKTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIGluZ2VzdCBhIHRlbXBsYXRlIHdpdGggb25seSBhIFNBTSBmdW5jdGlvbiB1c2luZyBhbiBhcnJheSB3aXRoIEREQiBDUlVEIGZvciBQb2xpY2llcyB3aXRoIGFuIEZuOjpJZiBleHByZXNzaW9uLCBhbmQgb3V0cHV0IGl0IHVuY2hhbmdlZCcsICgpID0+IHtcbiAgICBpbmNsdWRlVGVzdFRlbXBsYXRlKHN0YWNrLCAnb25seS1zYW0tZnVuY3Rpb24tcG9saWNpZXMtYXJyYXktZGRiLWNydWQtaWYueWFtbCcpO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS50ZW1wbGF0ZU1hdGNoZXMoXG4gICAgICBsb2FkVGVzdEZpbGVUb0pzT2JqZWN0KCdvbmx5LXNhbS1mdW5jdGlvbi1wb2xpY2llcy1hcnJheS1kZGItY3J1ZC1pZi55YW1sJyksXG4gICAgKTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIGluZ2VzdCBhIHRlbXBsYXRlIHdpdGggYSBhIHVuaW9uLXR5cGUgcHJvcGVydHkgcHJvdmlkZWQgYXMgYW4gb2JqZWN0LCBhbmQgb3V0cHV0IGl0IHVuY2hhbmdlZCcsICgpID0+IHtcbiAgICBpbmNsdWRlVGVzdFRlbXBsYXRlKHN0YWNrLCAnYXBpLWVuZHBvaW50LWNvbmZpZy1vYmplY3QueWFtbCcpO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKS50ZW1wbGF0ZU1hdGNoZXMoXG4gICAgICBsb2FkVGVzdEZpbGVUb0pzT2JqZWN0KCdhcGktZW5kcG9pbnQtY29uZmlnLW9iamVjdC55YW1sJyksXG4gICAgKTtcbiAgfSk7XG5cbiAgdGVzdCgnY2FuIGluZ2VzdCBhIHRlbXBsYXRlIHdpdGggYSBhIHVuaW9uLXR5cGUgcHJvcGVydHkgcHJvdmlkZWQgYXMgYSBzdHJpbmcsIGFuZCBvdXRwdXQgaXQgdW5jaGFuZ2VkJywgKCkgPT4ge1xuICAgIGluY2x1ZGVUZXN0VGVtcGxhdGUoc3RhY2ssICdhcGktZW5kcG9pbnQtY29uZmlnLXN0cmluZy55YW1sJyk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnRlbXBsYXRlTWF0Y2hlcyhcbiAgICAgIGxvYWRUZXN0RmlsZVRvSnNPYmplY3QoJ2FwaS1lbmRwb2ludC1jb25maWctc3RyaW5nLnlhbWwnKSxcbiAgICApO1xuICB9KTtcblxuICB0ZXN0KCdjYW4gaW5nZXN0IGEgdGVtcGxhdGUgd2l0aCBhIGEgdW5pb24tdHlwZSBwcm9wZXJ0eSBwcm92aWRlZCBhcyBhbiBlbXB0eSBzdHJpbmcsIGFuZCBvdXRwdXQgaXQgdW5jaGFuZ2VkJywgKCkgPT4ge1xuICAgIGluY2x1ZGVUZXN0VGVtcGxhdGUoc3RhY2ssICdhcGktZW5kcG9pbnQtY29uZmlnLXN0cmluZy1lbXB0eS55YW1sJyk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spLnRlbXBsYXRlTWF0Y2hlcyhcbiAgICAgIGxvYWRUZXN0RmlsZVRvSnNPYmplY3QoJ2FwaS1lbmRwb2ludC1jb25maWctc3RyaW5nLWVtcHR5LnlhbWwnKSxcbiAgICApO1xuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiBpbmNsdWRlVGVzdFRlbXBsYXRlKHNjb3BlOiBjb25zdHJ1Y3RzLkNvbnN0cnVjdCwgdGVzdFRlbXBsYXRlOiBzdHJpbmcpOiBpbmMuQ2ZuSW5jbHVkZSB7XG4gIHJldHVybiBuZXcgaW5jLkNmbkluY2x1ZGUoc2NvcGUsICdNeVNjb3BlJywge1xuICAgIHRlbXBsYXRlRmlsZTogX3Rlc3RUZW1wbGF0ZUZpbGVQYXRoKHRlc3RUZW1wbGF0ZSksXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkVGVzdEZpbGVUb0pzT2JqZWN0KHRlc3RUZW1wbGF0ZTogc3RyaW5nKTogYW55IHtcbiAgcmV0dXJuIGZ1dGlscy5yZWFkWWFtbFN5bmMoX3Rlc3RUZW1wbGF0ZUZpbGVQYXRoKHRlc3RUZW1wbGF0ZSkpO1xufVxuXG5mdW5jdGlvbiBfdGVzdFRlbXBsYXRlRmlsZVBhdGgodGVzdFRlbXBsYXRlOiBzdHJpbmcpIHtcbiAgcmV0dXJuIHBhdGguam9pbihfX2Rpcm5hbWUsICd0ZXN0LXRlbXBsYXRlcycsICdzYW0nLCB0ZXN0VGVtcGxhdGUpO1xufVxuIl19