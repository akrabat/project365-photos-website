"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const fs = require("fs");
const os = require("os");
const path = require("path");
const url = require("url");
const entrypoint = require("../../lib/custom-resource-provider/nodejs-entrypoint");
describe('nodejs entrypoint', () => {
    describe('handler return value is sent back to cloudformation as a success response', () => {
        test('physical resource id (ref)', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const { response } = await invokeHandler(createEvent, async (_) => ({ PhysicalResourceId: 'returned-from-handler' }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.PhysicalResourceId).toEqual('returned-from-handler');
        });
        test('data (attributes)', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const { response } = await invokeHandler(createEvent, async (_) => {
                return {
                    Data: {
                        Attribute1: 'hello',
                        Attribute2: {
                            Foo: 1111,
                        },
                    },
                };
            });
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.PhysicalResourceId).toEqual('<RequestId>');
            expect(response.Data).toEqual({
                Attribute1: 'hello',
                Attribute2: {
                    Foo: 1111,
                },
            });
        });
        test('no echo', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const { response } = await invokeHandler(createEvent, async (_) => ({ NoEcho: true }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.NoEcho).toEqual(true);
        });
        test('reason', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            // WHEN
            const { response } = await invokeHandler(createEvent, async (_) => ({ Reason: 'hello, reason' }));
            // THEN
            expect(response.Status).toEqual('SUCCESS');
            expect(response.Reason).toEqual('hello, reason');
        });
        test('utf8 is supported', async () => {
            // GIVEN
            const createEvent = makeEvent({ RequestType: 'Create' });
            const { request: emptyDataRequest } = await invokeHandler(createEvent, async (_) => ({
                Data: {
                    Attribute: '', // 0 bytes
                },
            }));
            // WHEN
            const { request: utf8DataRequest } = await invokeHandler(createEvent, async (_) => ({
                Data: {
                    Attribute: 'ÅÄÖ', // 6 bytes
                },
            }));
            // THEN
            const emptyLength = emptyDataRequest.headers?.['content-length'];
            const utf8Length = utf8DataRequest.headers?.['content-length'];
            expect(utf8Length - emptyLength).toEqual(6);
        });
    });
    test('an error thrown by the handler is sent as a failure response to cloudformation', async () => {
        // GIVEN
        const createEvent = makeEvent({ RequestType: 'Create' });
        // WHEN
        const { response } = await invokeHandler(createEvent, async (_) => {
            throw new Error('this is an error');
        });
        // THEN
        expect(response).toEqual({
            Status: 'FAILED',
            Reason: 'this is an error',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
    test('physical resource id cannot be changed in DELETE', async () => {
        // GIVEN
        const event = makeEvent({ RequestType: 'Delete' });
        // WHEN
        const { response } = await invokeHandler(event, async (_) => ({
            PhysicalResourceId: 'Changed',
        }));
        // THEN
        expect(response).toEqual({
            Status: 'FAILED',
            Reason: 'DELETE: cannot change the physical resource ID from "undefined" to "Changed" during deletion',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::MISSING_PHYSICAL_ID',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
    test('DELETE after CREATE is ignored with success', async () => {
        // GIVEN
        const event = makeEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
        });
        // WHEN
        const { response } = await invokeHandler(event, async (_) => {
            throw new Error('handler should not be called');
        });
        // THEN
        expect(response).toEqual({
            Status: 'SUCCESS',
            Reason: 'SUCCESS',
            StackId: '<StackId>',
            RequestId: '<RequestId>',
            PhysicalResourceId: 'AWSCDK::CustomResourceProviderFramework::CREATE_FAILED',
            LogicalResourceId: '<LogicalResourceId>',
        });
    });
});
function makeEvent(req) {
    return {
        LogicalResourceId: '<LogicalResourceId>',
        RequestId: '<RequestId>',
        ResourceType: '<ResourceType>',
        ResponseURL: '<ResponseURL>',
        ServiceToken: '<ServiceToken>',
        StackId: '<StackId>',
        ResourceProperties: {
            ServiceToken: '<ServiceToken>',
            ...req.ResourceProperties,
        },
        ...req,
    };
}
async function invokeHandler(req, userHandler) {
    const parsedResponseUrl = url.parse(req.ResponseURL);
    // stage entry point and user handler.
    const workdir = fs.mkdtempSync(path.join(os.tmpdir(), 'cdk-custom-resource-provider-handler-test-'));
    entrypoint.external.userHandlerIndex = path.join(workdir, 'index.js');
    fs.writeFileSync(entrypoint.external.userHandlerIndex, `exports.handler = ${userHandler.toString()};`);
    // do not include stack traces in failure responses so we can assert against them.
    entrypoint.external.includeStackTraces = false;
    // disable logging
    entrypoint.external.log = () => {
        return;
    };
    let actualResponse;
    let actualRequest;
    entrypoint.external.sendHttpRequest = async (options, responseBody) => {
        assert(options.hostname === parsedResponseUrl.hostname, 'request hostname expected to be based on response URL');
        assert(options.path === parsedResponseUrl.path, 'request path expected to be based on response URL');
        assert(options.method === 'PUT', 'request method is expected to be PUT');
        actualResponse = responseBody;
        actualRequest = options;
    };
    await entrypoint.handler(req, {});
    if (!actualRequest || !actualResponse) {
        throw new Error('no response sent to cloudformation');
    }
    return {
        response: JSON.parse(actualResponse),
        request: actualRequest,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZWpzLWVudHJ5cG9pbnQudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5vZGVqcy1lbnRyeXBvaW50LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBaUM7QUFDakMseUJBQXlCO0FBRXpCLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsMkJBQTJCO0FBQzNCLG1GQUFtRjtBQUVuRixRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLFFBQVEsQ0FBQywyRUFBMkUsRUFBRSxHQUFHLEVBQUU7UUFFekYsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzVDLFFBQVE7WUFDUixNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUV6RCxPQUFPO1lBQ1AsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLE1BQU0sYUFBYSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsa0JBQWtCLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFcEgsT0FBTztZQUNQLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzNDLE1BQU0sQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxtQkFBbUIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNuQyxRQUFRO1lBQ1IsTUFBTSxXQUFXLEdBQUcsU0FBUyxDQUFDLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFFekQsT0FBTztZQUNQLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxNQUFNLGFBQWEsQ0FBQyxXQUFXLEVBQUUsS0FB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QyxPQUFPLENBQUMsUUFBUSxLQUFLLGlCQUFpQixDQUFDLFFBQVEsRUFBRSx1REFBdUQsQ0FBQyxDQUFDO1FBQ2pILE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLGlCQUFpQixDQUFDLElBQUksRUFBRSxtREFBbUQsQ0FBQyxDQUFDO1FBQ3JHLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLEtBQUssRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO1FBQ3pFLGNBQWMsR0FBRyxZQUFZLENBQUM7UUFDOUIsYUFBYSxHQUFHLE9BQU8sQ0FBQztJQUMxQixDQUFDLENBQUM7SUFFRixNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQXVCLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztLQUN2RDtJQUVELE9BQU87UUFDTCxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQW1EO1FBQ3RGLE9BQU8sRUFBRSxhQUFxQztLQUMvQyxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFzc2VydCBmcm9tICdhc3NlcnQnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgaHR0cHMgZnJvbSAnaHR0cHMnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0ICogYXMgZW50cnlwb2ludCBmcm9tICcuLi8uLi9saWIvY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyL25vZGVqcy1lbnRyeXBvaW50JztcblxuZGVzY3JpYmUoJ25vZGVqcyBlbnRyeXBvaW50JywgKCkgPT4ge1xuICBkZXNjcmliZSgnaGFuZGxlciByZXR1cm4gdmFsdWUgaXMgc2VudCBiYWNrIHRvIGNsb3VkZm9ybWF0aW9uIGFzIGEgc3VjY2VzcyByZXNwb25zZScsICgpID0+IHtcblxuICAgIHRlc3QoJ3BoeXNpY2FsIHJlc291cmNlIGlkIChyZWYpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogJ3JldHVybmVkLWZyb20taGFuZGxlcicgfSkpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QocmVzcG9uc2UuU3RhdHVzKS50b0VxdWFsKCdTVUNDRVNTJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuUGh5c2ljYWxSZXNvdXJjZUlkKS50b0VxdWFsKCdyZXR1cm5lZC1mcm9tLWhhbmRsZXInKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2RhdGEgKGF0dHJpYnV0ZXMpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBEYXRhOiB7XG4gICAgICAgICAgICBBdHRyaWJ1dGUxOiAnaGVsbG8nLFxuICAgICAgICAgICAgQXR0cmlidXRlMjoge1xuICAgICAgICAgICAgICBGb286IDExMTEsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHJlc3BvbnNlLlN0YXR1cykudG9FcXVhbCgnU1VDQ0VTUycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLlBoeXNpY2FsUmVzb3VyY2VJZCkudG9FcXVhbCgnPFJlcXVlc3RJZD4nKTtcbiAgICAgIGV4cGVjdChyZXNwb25zZS5EYXRhKS50b0VxdWFsKHtcbiAgICAgICAgQXR0cmlidXRlMTogJ2hlbGxvJyxcbiAgICAgICAgQXR0cmlidXRlMjoge1xuICAgICAgICAgIEZvbzogMTExMSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnbm8gZWNobycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICBjb25zdCBjcmVhdGVFdmVudCA9IG1ha2VFdmVudCh7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyB9KTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgeyByZXNwb25zZSB9ID0gYXdhaXQgaW52b2tlSGFuZGxlcihjcmVhdGVFdmVudCwgYXN5bmMgXyA9PiAoeyBOb0VjaG86IHRydWUgfSkpO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBleHBlY3QocmVzcG9uc2UuU3RhdHVzKS50b0VxdWFsKCdTVUNDRVNTJyk7XG4gICAgICBleHBlY3QocmVzcG9uc2UuTm9FY2hvKS50b0VxdWFsKHRydWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgncmVhc29uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGNvbnN0IGNyZWF0ZUV2ZW50ID0gbWFrZUV2ZW50KHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+ICh7IFJlYXNvbjogJ2hlbGxvLCByZWFzb24nIH0pKTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHJlc3BvbnNlLlN0YXR1cykudG9FcXVhbCgnU1VDQ0VTUycpO1xuICAgICAgZXhwZWN0KHJlc3BvbnNlLlJlYXNvbikudG9FcXVhbCgnaGVsbG8sIHJlYXNvbicpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndXRmOCBpcyBzdXBwb3J0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBHSVZFTlxuICAgICAgY29uc3QgY3JlYXRlRXZlbnQgPSBtYWtlRXZlbnQoeyBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScgfSk7XG4gICAgICBjb25zdCB7IHJlcXVlc3Q6IGVtcHR5RGF0YVJlcXVlc3QgfSA9IGF3YWl0IGludm9rZUhhbmRsZXIoY3JlYXRlRXZlbnQsIGFzeW5jIF8gPT4gKHtcbiAgICAgICAgRGF0YToge1xuICAgICAgICAgIEF0dHJpYnV0ZTogJycsIC8vIDAgYnl0ZXNcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcblxuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgeyByZXF1ZXN0OiB1dGY4RGF0YVJlcXVlc3QgfSA9IGF3YWl0IGludm9rZUhhbmRsZXIoY3JlYXRlRXZlbnQsIGFzeW5jIF8gPT4gKHtcbiAgICAgICAgRGF0YToge1xuICAgICAgICAgIEF0dHJpYnV0ZTogJ8OFw4TDlicsIC8vIDYgYnl0ZXNcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgY29uc3QgZW1wdHlMZW5ndGggPSBlbXB0eURhdGFSZXF1ZXN0LmhlYWRlcnM/LlsnY29udGVudC1sZW5ndGgnXSBhcyBudW1iZXI7XG4gICAgICBjb25zdCB1dGY4TGVuZ3RoID0gdXRmOERhdGFSZXF1ZXN0LmhlYWRlcnM/LlsnY29udGVudC1sZW5ndGgnXSBhcyBudW1iZXI7XG4gICAgICBleHBlY3QodXRmOExlbmd0aCAtIGVtcHR5TGVuZ3RoKS50b0VxdWFsKDYpO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdhbiBlcnJvciB0aHJvd24gYnkgdGhlIGhhbmRsZXIgaXMgc2VudCBhcyBhIGZhaWx1cmUgcmVzcG9uc2UgdG8gY2xvdWRmb3JtYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBjcmVhdGVFdmVudCA9IG1ha2VFdmVudCh7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSBhd2FpdCBpbnZva2VIYW5kbGVyKGNyZWF0ZUV2ZW50LCBhc3luYyBfID0+IHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigndGhpcyBpcyBhbiBlcnJvcicpO1xuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChyZXNwb25zZSkudG9FcXVhbCh7XG4gICAgICBTdGF0dXM6ICdGQUlMRUQnLFxuICAgICAgUmVhc29uOiAndGhpcyBpcyBhbiBlcnJvcicsXG4gICAgICBTdGFja0lkOiAnPFN0YWNrSWQ+JyxcbiAgICAgIFJlcXVlc3RJZDogJzxSZXF1ZXN0SWQ+JyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0FXU0NESzo6Q3VzdG9tUmVzb3VyY2VQcm92aWRlckZyYW1ld29yazo6Q1JFQVRFX0ZBSUxFRCcsXG4gICAgICBMb2dpY2FsUmVzb3VyY2VJZDogJzxMb2dpY2FsUmVzb3VyY2VJZD4nLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdwaHlzaWNhbCByZXNvdXJjZSBpZCBjYW5ub3QgYmUgY2hhbmdlZCBpbiBERUxFVEUnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBldmVudCA9IG1ha2VFdmVudCh7IFJlcXVlc3RUeXBlOiAnRGVsZXRlJyB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB7IHJlc3BvbnNlIH0gPSBhd2FpdCBpbnZva2VIYW5kbGVyKGV2ZW50LCBhc3luYyBfID0+ICh7XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDaGFuZ2VkJyxcbiAgICB9KSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHJlc3BvbnNlKS50b0VxdWFsKHtcbiAgICAgIFN0YXR1czogJ0ZBSUxFRCcsXG4gICAgICBSZWFzb246ICdERUxFVEU6IGNhbm5vdCBjaGFuZ2UgdGhlIHBoeXNpY2FsIHJlc291cmNlIElEIGZyb20gXCJ1bmRlZmluZWRcIiB0byBcIkNoYW5nZWRcIiBkdXJpbmcgZGVsZXRpb24nLFxuICAgICAgU3RhY2tJZDogJzxTdGFja0lkPicsXG4gICAgICBSZXF1ZXN0SWQ6ICc8UmVxdWVzdElkPicsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdBV1NDREs6OkN1c3RvbVJlc291cmNlUHJvdmlkZXJGcmFtZXdvcms6Ok1JU1NJTkdfUEhZU0lDQUxfSUQnLFxuICAgICAgTG9naWNhbFJlc291cmNlSWQ6ICc8TG9naWNhbFJlc291cmNlSWQ+JyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgdGVzdCgnREVMRVRFIGFmdGVyIENSRUFURSBpcyBpZ25vcmVkIHdpdGggc3VjY2VzcycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IGV2ZW50ID0gbWFrZUV2ZW50KHtcbiAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ0FXU0NESzo6Q3VzdG9tUmVzb3VyY2VQcm92aWRlckZyYW1ld29yazo6Q1JFQVRFX0ZBSUxFRCcsXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgeyByZXNwb25zZSB9ID0gYXdhaXQgaW52b2tlSGFuZGxlcihldmVudCwgYXN5bmMgXyA9PiB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2hhbmRsZXIgc2hvdWxkIG5vdCBiZSBjYWxsZWQnKTtcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QocmVzcG9uc2UpLnRvRXF1YWwoe1xuICAgICAgU3RhdHVzOiAnU1VDQ0VTUycsXG4gICAgICBSZWFzb246ICdTVUNDRVNTJyxcbiAgICAgIFN0YWNrSWQ6ICc8U3RhY2tJZD4nLFxuICAgICAgUmVxdWVzdElkOiAnPFJlcXVlc3RJZD4nLFxuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiAnQVdTQ0RLOjpDdXN0b21SZXNvdXJjZVByb3ZpZGVyRnJhbWV3b3JrOjpDUkVBVEVfRkFJTEVEJyxcbiAgICAgIExvZ2ljYWxSZXNvdXJjZUlkOiAnPExvZ2ljYWxSZXNvdXJjZUlkPicsXG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmZ1bmN0aW9uIG1ha2VFdmVudChyZXE6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudD4pOiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50IHtcbiAgcmV0dXJuIHtcbiAgICBMb2dpY2FsUmVzb3VyY2VJZDogJzxMb2dpY2FsUmVzb3VyY2VJZD4nLFxuICAgIFJlcXVlc3RJZDogJzxSZXF1ZXN0SWQ+JyxcbiAgICBSZXNvdXJjZVR5cGU6ICc8UmVzb3VyY2VUeXBlPicsXG4gICAgUmVzcG9uc2VVUkw6ICc8UmVzcG9uc2VVUkw+JyxcbiAgICBTZXJ2aWNlVG9rZW46ICc8U2VydmljZVRva2VuPicsXG4gICAgU3RhY2tJZDogJzxTdGFja0lkPicsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICBTZXJ2aWNlVG9rZW46ICc8U2VydmljZVRva2VuPicsXG4gICAgICAuLi5yZXEuUmVzb3VyY2VQcm9wZXJ0aWVzLFxuICAgIH0sXG4gICAgLi4ucmVxLFxuICB9IGFzIGFueTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW52b2tlSGFuZGxlcihyZXE6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRXZlbnQsIHVzZXJIYW5kbGVyOiBlbnRyeXBvaW50LkhhbmRsZXIpIHtcbiAgY29uc3QgcGFyc2VkUmVzcG9uc2VVcmwgPSB1cmwucGFyc2UocmVxLlJlc3BvbnNlVVJMKTtcblxuICAvLyBzdGFnZSBlbnRyeSBwb2ludCBhbmQgdXNlciBoYW5kbGVyLlxuICBjb25zdCB3b3JrZGlyID0gZnMubWtkdGVtcFN5bmMocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnY2RrLWN1c3RvbS1yZXNvdXJjZS1wcm92aWRlci1oYW5kbGVyLXRlc3QtJykpO1xuICBlbnRyeXBvaW50LmV4dGVybmFsLnVzZXJIYW5kbGVySW5kZXggPSBwYXRoLmpvaW4od29ya2RpciwgJ2luZGV4LmpzJyk7XG4gIGZzLndyaXRlRmlsZVN5bmMoZW50cnlwb2ludC5leHRlcm5hbC51c2VySGFuZGxlckluZGV4LCBgZXhwb3J0cy5oYW5kbGVyID0gJHt1c2VySGFuZGxlci50b1N0cmluZygpfTtgKTtcblxuICAvLyBkbyBub3QgaW5jbHVkZSBzdGFjayB0cmFjZXMgaW4gZmFpbHVyZSByZXNwb25zZXMgc28gd2UgY2FuIGFzc2VydCBhZ2FpbnN0IHRoZW0uXG4gIGVudHJ5cG9pbnQuZXh0ZXJuYWwuaW5jbHVkZVN0YWNrVHJhY2VzID0gZmFsc2U7XG5cbiAgLy8gZGlzYWJsZSBsb2dnaW5nXG4gIGVudHJ5cG9pbnQuZXh0ZXJuYWwubG9nID0gKCkgPT4ge1xuICAgIHJldHVybjtcbiAgfTtcblxuICBsZXQgYWN0dWFsUmVzcG9uc2U7XG4gIGxldCBhY3R1YWxSZXF1ZXN0O1xuICBlbnRyeXBvaW50LmV4dGVybmFsLnNlbmRIdHRwUmVxdWVzdCA9IGFzeW5jIChvcHRpb25zOiBodHRwcy5SZXF1ZXN0T3B0aW9ucywgcmVzcG9uc2VCb2R5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBhc3NlcnQob3B0aW9ucy5ob3N0bmFtZSA9PT0gcGFyc2VkUmVzcG9uc2VVcmwuaG9zdG5hbWUsICdyZXF1ZXN0IGhvc3RuYW1lIGV4cGVjdGVkIHRvIGJlIGJhc2VkIG9uIHJlc3BvbnNlIFVSTCcpO1xuICAgIGFzc2VydChvcHRpb25zLnBhdGggPT09IHBhcnNlZFJlc3BvbnNlVXJsLnBhdGgsICdyZXF1ZXN0IHBhdGggZXhwZWN0ZWQgdG8gYmUgYmFzZWQgb24gcmVzcG9uc2UgVVJMJyk7XG4gICAgYXNzZXJ0KG9wdGlvbnMubWV0aG9kID09PSAnUFVUJywgJ3JlcXVlc3QgbWV0aG9kIGlzIGV4cGVjdGVkIHRvIGJlIFBVVCcpO1xuICAgIGFjdHVhbFJlc3BvbnNlID0gcmVzcG9uc2VCb2R5O1xuICAgIGFjdHVhbFJlcXVlc3QgPSBvcHRpb25zO1xuICB9O1xuXG4gIGF3YWl0IGVudHJ5cG9pbnQuaGFuZGxlcihyZXEsIHt9IGFzIEFXU0xhbWJkYS5Db250ZXh0KTtcbiAgaWYgKCFhY3R1YWxSZXF1ZXN0IHx8ICFhY3R1YWxSZXNwb25zZSkge1xuICAgIHRocm93IG5ldyBFcnJvcignbm8gcmVzcG9uc2Ugc2VudCB0byBjbG91ZGZvcm1hdGlvbicpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICByZXNwb25zZTogSlNPTi5wYXJzZShhY3R1YWxSZXNwb25zZSkgYXMgQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZSxcbiAgICByZXF1ZXN0OiBhY3R1YWxSZXF1ZXN0IGFzIGh0dHBzLlJlcXVlc3RPcHRpb25zLFxuICB9O1xufVxuIl19