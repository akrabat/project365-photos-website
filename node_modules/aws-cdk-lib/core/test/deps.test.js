"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const constructs_1 = require("constructs");
const core = require("../lib");
const lib_1 = require("../lib");
const deps_1 = require("../lib/deps");
describe('deps', () => {
    describe('dependency methods', () => {
        test('can explicitly add a dependency between resources', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack, 'Resource2', { type: 'Test::Resource::Fake2' });
            (0, deps_1.addDependency)(resource1, resource2);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                    DependsOn: [
                        'Resource2',
                    ],
                },
                Resource2: {
                    Type: 'Test::Resource::Fake2',
                },
            });
        });
        test('can explicitly remove a dependency between resources', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack, 'Resource2', { type: 'Test::Resource::Fake2' });
            (0, deps_1.addDependency)(resource1, resource2);
            (0, deps_1.removeDependency)(resource1, resource2);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                },
                Resource2: {
                    Type: 'Test::Resource::Fake2',
                },
            });
        });
        test('can explicitly add, obtain, and remove dependencies across stacks', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            // Use a really long construct id to identify issues between Names.uniqueId and Names.uniqueResourceName
            const reallyLongConstructId = 'A'.repeat(247);
            const stack2 = new core.Stack(app, reallyLongConstructId, { stackName: 'TestStack2' });
            // Sanity check since this test depends on the discrepancy
            expect(lib_1.Names.uniqueId(stack2)).not.toBe(lib_1.Names.uniqueResourceName(stack2, {}));
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(stack2, 'Resource2', { type: 'Test::Resource::Fake2' });
            const resource3 = new core.CfnResource(stack1, 'Resource3', { type: 'Test::Resource::Fake3' });
            (0, deps_1.addDependency)(resource1, resource2);
            // Adding the same resource dependency twice should be a no-op
            (0, deps_1.addDependency)(resource1, resource2);
            (0, deps_1.addDependency)(resource1, resource3);
            expect(stack1.dependencies.length).toEqual(1);
            expect(stack1.dependencies[0].node.id).toEqual(stack2.node.id);
            // obtainDependencies should assemble and flatten resource-to-resource dependencies even across stacks
            expect((0, deps_1.obtainDependencies)(resource1).map(x => x.node.path)).toEqual([resource3.node.path, resource2.node.path]);
            (0, deps_1.removeDependency)(resource1, resource2);
            // For symmetry, removing a dependency that doesn't exist should be a no-op
            (0, deps_1.removeDependency)(resource1, resource2);
            expect(stack1.dependencies.length).toEqual(0);
        });
        test('do nothing if source is target', () => {
            const app = new core.App();
            const stack = new core.Stack(app, 'TestStack');
            const resource1 = new core.CfnResource(stack, 'Resource1', { type: 'Test::Resource::Fake1' });
            (0, deps_1.addDependency)(resource1, resource1);
            expect(app.synth().getStackByName(stack.stackName).template.Resources).toEqual({
                Resource1: {
                    Type: 'Test::Resource::Fake1',
                },
            });
        });
        test('handle source being common stack', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            // If source is the common stack, this should be a noop
            (0, deps_1.addDependency)(stack1, resource1);
            expect(stack1.dependencies.length).toEqual(0);
        });
        test('throws error if target is common stack', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const resource1 = new core.CfnResource(stack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            expect(() => {
                (0, deps_1.addDependency)(resource1, stack1);
            }).toThrow(/cannot depend on /);
        });
        test('can explicitly add, obtain, and remove dependencies across nested stacks', () => {
            const app = new core.App();
            const stack1 = new core.Stack(app, 'TestStack1');
            const construct1 = new constructs_1.Construct(stack1, 'CommonConstruct');
            // Use a really long construct id to identify issues between Names.uniqueId and Names.uniqueResourceName
            const nestedStack1 = new core.Stack(construct1, 'TestNestedStack1');
            const nestedStack2 = new core.Stack(construct1, 'TestNestedStack2');
            const resource1 = new core.CfnResource(nestedStack1, 'Resource1', { type: 'Test::Resource::Fake1' });
            const resource2 = new core.CfnResource(nestedStack2, 'Resource2', { type: 'Test::Resource::Fake2' });
            (0, deps_1.addDependency)(resource1, resource2);
            // Adding the same resource dependency twice should be a no-op
            (0, deps_1.addDependency)(resource1, resource2);
            expect(nestedStack1.dependencies.length).toEqual(1);
            expect(nestedStack1.dependencies[0].node.id).toEqual(nestedStack2.node.id);
            (0, deps_1.removeDependency)(resource1, resource2);
            // For symmetry, removing a dependency that doesn't exist should be a no-op
            (0, deps_1.removeDependency)(resource1, resource2);
            expect(stack1.dependencies.length).toEqual(0);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwcy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGVwcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQXVDO0FBQ3ZDLCtCQUErQjtBQUMvQixnQ0FBK0I7QUFDL0Isc0NBQWtGO0FBRWxGLFFBQVEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO0lBQ3BCLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDbEMsSUFBSSxDQUFDLG1EQUFtRCxFQUFFLEdBQUcsRUFBRTtZQUM3RCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUM5RixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7WUFDOUYsSUFBQSxvQkFBYSxFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUVwQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDN0UsU0FBUyxFQUFFO29CQUNULElBQUksRUFBRSx1QkFBdUI7b0JBQzdCLFNBQVMsRUFBRTt3QkFDVCxXQUFXO3FCQUNaO2lCQUNGO2dCQUNELFNBQVMsRUFBRTtvQkFDVCxJQUFJLEVBQUUsdUJBQXVCO2lCQUM5QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLHNEQUFzRCxFQUFFLEdBQUcsRUFBRTtZQUNoRSxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUM5RixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7WUFDOUYsSUFBQSxvQkFBYSxFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNwQyxJQUFBLHVCQUFnQixFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUV2QyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDN0UsU0FBUyxFQUFFO29CQUNULElBQUksRUFBRSx1QkFBdUI7aUJBQzlCO2dCQUNELFNBQVMsRUFBRTtvQkFDVCxJQUFJLEVBQUUsdUJBQXVCO2lCQUM5QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLG1FQUFtRSxFQUFFLEdBQUcsRUFBRTtZQUM3RSxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixNQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2pELHdHQUF3RztZQUN4RyxNQUFNLHFCQUFxQixHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxxQkFBcUIsRUFBRSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZGLDBEQUEwRDtZQUMxRCxNQUFNLENBQUMsV0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBSyxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzlFLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUMvRixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxDQUFDLENBQUM7WUFDL0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1lBRS9GLElBQUEsb0JBQWEsRUFBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDcEMsOERBQThEO1lBQzlELElBQUEsb0JBQWEsRUFBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDcEMsSUFBQSxvQkFBYSxFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELHNHQUFzRztZQUN0RyxNQUFNLENBQUMsSUFBQSx5QkFBa0IsRUFBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRWhILElBQUEsdUJBQWdCLEVBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLDJFQUEyRTtZQUMzRSxJQUFBLHVCQUFnQixFQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUN2QyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsR0FBRyxFQUFFO1lBQzFDLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7WUFDL0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1lBQzlGLElBQUEsb0JBQWEsRUFBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFcEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQzdFLFNBQVMsRUFBRTtvQkFDVCxJQUFJLEVBQUUsdUJBQXVCO2lCQUM5QjthQUNGLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcsRUFBRTtZQUM1QyxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQixNQUFNLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2pELE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUUvRix1REFBdUQ7WUFDdkQsSUFBQSxvQkFBYSxFQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNqQyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsd0NBQXdDLEVBQUUsR0FBRyxFQUFFO1lBQ2xELE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLE1BQU0sTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDakQsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1lBRS9GLE1BQU0sQ0FBQyxHQUFHLEVBQUU7Z0JBQ1YsSUFBQSxvQkFBYSxFQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNuQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQywwRUFBMEUsRUFBRSxHQUFHLEVBQUU7WUFDcEYsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUNqRCxNQUFNLFVBQVUsR0FBRyxJQUFJLHNCQUFTLENBQUMsTUFBTSxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFDNUQsd0dBQXdHO1lBQ3hHLE1BQU0sWUFBWSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztZQUNwRSxNQUFNLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLGtCQUFrQixDQUFDLENBQUM7WUFDcEUsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDO1lBQ3JHLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLHVCQUF1QixFQUFFLENBQUMsQ0FBQztZQUVyRyxJQUFBLG9CQUFhLEVBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3BDLDhEQUE4RDtZQUM5RCxJQUFBLG9CQUFhLEVBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRCxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFM0UsSUFBQSx1QkFBZ0IsRUFBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDdkMsMkVBQTJFO1lBQzNFLElBQUEsdUJBQWdCLEVBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGNvcmUgZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IE5hbWVzIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IGFkZERlcGVuZGVuY3ksIG9idGFpbkRlcGVuZGVuY2llcywgcmVtb3ZlRGVwZW5kZW5jeSB9IGZyb20gJy4uL2xpYi9kZXBzJztcblxuZGVzY3JpYmUoJ2RlcHMnLCAoKSA9PiB7XG4gIGRlc2NyaWJlKCdkZXBlbmRlbmN5IG1ldGhvZHMnLCAoKSA9PiB7XG4gICAgdGVzdCgnY2FuIGV4cGxpY2l0bHkgYWRkIGEgZGVwZW5kZW5jeSBiZXR3ZWVuIHJlc291cmNlcycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sgPSBuZXcgY29yZS5TdGFjayhhcHAsICdUZXN0U3RhY2snKTtcbiAgICAgIGNvbnN0IHJlc291cmNlMSA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcbiAgICAgIGNvbnN0IHJlc291cmNlMiA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrLCAnUmVzb3VyY2UyJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UyJyB9KTtcbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuXG4gICAgICBleHBlY3QoYXBwLnN5bnRoKCkuZ2V0U3RhY2tCeU5hbWUoc3RhY2suc3RhY2tOYW1lKS50ZW1wbGF0ZS5SZXNvdXJjZXMpLnRvRXF1YWwoe1xuICAgICAgICBSZXNvdXJjZTE6IHtcbiAgICAgICAgICBUeXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyxcbiAgICAgICAgICBEZXBlbmRzT246IFtcbiAgICAgICAgICAgICdSZXNvdXJjZTInLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIFJlc291cmNlMjoge1xuICAgICAgICAgIFR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTInLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdjYW4gZXhwbGljaXRseSByZW1vdmUgYSBkZXBlbmRlbmN5IGJldHdlZW4gcmVzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjayA9IG5ldyBjb3JlLlN0YWNrKGFwcCwgJ1Rlc3RTdGFjaycpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZTEnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnIH0pO1xuICAgICAgY29uc3QgcmVzb3VyY2UyID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZTInLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTInIH0pO1xuICAgICAgYWRkRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMik7XG4gICAgICByZW1vdmVEZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcblxuICAgICAgZXhwZWN0KGFwcC5zeW50aCgpLmdldFN0YWNrQnlOYW1lKHN0YWNrLnN0YWNrTmFtZSkudGVtcGxhdGUuUmVzb3VyY2VzKS50b0VxdWFsKHtcbiAgICAgICAgUmVzb3VyY2UxOiB7XG4gICAgICAgICAgVHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScsXG4gICAgICAgIH0sXG4gICAgICAgIFJlc291cmNlMjoge1xuICAgICAgICAgIFR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTInLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdjYW4gZXhwbGljaXRseSBhZGQsIG9idGFpbiwgYW5kIHJlbW92ZSBkZXBlbmRlbmNpZXMgYWNyb3NzIHN0YWNrcycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFwcCA9IG5ldyBjb3JlLkFwcCgpO1xuICAgICAgY29uc3Qgc3RhY2sxID0gbmV3IGNvcmUuU3RhY2soYXBwLCAnVGVzdFN0YWNrMScpO1xuICAgICAgLy8gVXNlIGEgcmVhbGx5IGxvbmcgY29uc3RydWN0IGlkIHRvIGlkZW50aWZ5IGlzc3VlcyBiZXR3ZWVuIE5hbWVzLnVuaXF1ZUlkIGFuZCBOYW1lcy51bmlxdWVSZXNvdXJjZU5hbWVcbiAgICAgIGNvbnN0IHJlYWxseUxvbmdDb25zdHJ1Y3RJZCA9ICdBJy5yZXBlYXQoMjQ3KTtcbiAgICAgIGNvbnN0IHN0YWNrMiA9IG5ldyBjb3JlLlN0YWNrKGFwcCwgcmVhbGx5TG9uZ0NvbnN0cnVjdElkLCB7IHN0YWNrTmFtZTogJ1Rlc3RTdGFjazInIH0pO1xuICAgICAgLy8gU2FuaXR5IGNoZWNrIHNpbmNlIHRoaXMgdGVzdCBkZXBlbmRzIG9uIHRoZSBkaXNjcmVwYW5jeVxuICAgICAgZXhwZWN0KE5hbWVzLnVuaXF1ZUlkKHN0YWNrMikpLm5vdC50b0JlKE5hbWVzLnVuaXF1ZVJlc291cmNlTmFtZShzdGFjazIsIHt9KSk7XG4gICAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjazEsICdSZXNvdXJjZTEnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnIH0pO1xuICAgICAgY29uc3QgcmVzb3VyY2UyID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2Uoc3RhY2syLCAnUmVzb3VyY2UyJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UyJyB9KTtcbiAgICAgIGNvbnN0IHJlc291cmNlMyA9IG5ldyBjb3JlLkNmblJlc291cmNlKHN0YWNrMSwgJ1Jlc291cmNlMycsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMycgfSk7XG5cbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgLy8gQWRkaW5nIHRoZSBzYW1lIHJlc291cmNlIGRlcGVuZGVuY3kgdHdpY2Ugc2hvdWxkIGJlIGEgbm8tb3BcbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgYWRkRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMyk7XG4gICAgICBleHBlY3Qoc3RhY2sxLmRlcGVuZGVuY2llcy5sZW5ndGgpLnRvRXF1YWwoMSk7XG4gICAgICBleHBlY3Qoc3RhY2sxLmRlcGVuZGVuY2llc1swXS5ub2RlLmlkKS50b0VxdWFsKHN0YWNrMi5ub2RlLmlkKTtcbiAgICAgIC8vIG9idGFpbkRlcGVuZGVuY2llcyBzaG91bGQgYXNzZW1ibGUgYW5kIGZsYXR0ZW4gcmVzb3VyY2UtdG8tcmVzb3VyY2UgZGVwZW5kZW5jaWVzIGV2ZW4gYWNyb3NzIHN0YWNrc1xuICAgICAgZXhwZWN0KG9idGFpbkRlcGVuZGVuY2llcyhyZXNvdXJjZTEpLm1hcCh4ID0+IHgubm9kZS5wYXRoKSkudG9FcXVhbChbcmVzb3VyY2UzLm5vZGUucGF0aCwgcmVzb3VyY2UyLm5vZGUucGF0aF0pO1xuXG4gICAgICByZW1vdmVEZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIC8vIEZvciBzeW1tZXRyeSwgcmVtb3ZpbmcgYSBkZXBlbmRlbmN5IHRoYXQgZG9lc24ndCBleGlzdCBzaG91bGQgYmUgYSBuby1vcFxuICAgICAgcmVtb3ZlRGVwZW5kZW5jeShyZXNvdXJjZTEsIHJlc291cmNlMik7XG4gICAgICBleHBlY3Qoc3RhY2sxLmRlcGVuZGVuY2llcy5sZW5ndGgpLnRvRXF1YWwoMCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdkbyBub3RoaW5nIGlmIHNvdXJjZSBpcyB0YXJnZXQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrID0gbmV3IGNvcmUuU3RhY2soYXBwLCAnVGVzdFN0YWNrJyk7XG4gICAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjaywgJ1Jlc291cmNlMScsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScgfSk7XG4gICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UxKTtcblxuICAgICAgZXhwZWN0KGFwcC5zeW50aCgpLmdldFN0YWNrQnlOYW1lKHN0YWNrLnN0YWNrTmFtZSkudGVtcGxhdGUuUmVzb3VyY2VzKS50b0VxdWFsKHtcbiAgICAgICAgUmVzb3VyY2UxOiB7XG4gICAgICAgICAgVHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMScsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2hhbmRsZSBzb3VyY2UgYmVpbmcgY29tbW9uIHN0YWNrJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjazEgPSBuZXcgY29yZS5TdGFjayhhcHAsICdUZXN0U3RhY2sxJyk7XG4gICAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjazEsICdSZXNvdXJjZTEnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnIH0pO1xuXG4gICAgICAvLyBJZiBzb3VyY2UgaXMgdGhlIGNvbW1vbiBzdGFjaywgdGhpcyBzaG91bGQgYmUgYSBub29wXG4gICAgICBhZGREZXBlbmRlbmN5KHN0YWNrMSwgcmVzb3VyY2UxKTtcbiAgICAgIGV4cGVjdChzdGFjazEuZGVwZW5kZW5jaWVzLmxlbmd0aCkudG9FcXVhbCgwKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Rocm93cyBlcnJvciBpZiB0YXJnZXQgaXMgY29tbW9uIHN0YWNrJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXBwID0gbmV3IGNvcmUuQXBwKCk7XG4gICAgICBjb25zdCBzdGFjazEgPSBuZXcgY29yZS5TdGFjayhhcHAsICdUZXN0U3RhY2sxJyk7XG4gICAgICBjb25zdCByZXNvdXJjZTEgPSBuZXcgY29yZS5DZm5SZXNvdXJjZShzdGFjazEsICdSZXNvdXJjZTEnLCB7IHR5cGU6ICdUZXN0OjpSZXNvdXJjZTo6RmFrZTEnIH0pO1xuXG4gICAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgICBhZGREZXBlbmRlbmN5KHJlc291cmNlMSwgc3RhY2sxKTtcbiAgICAgIH0pLnRvVGhyb3coL2Nhbm5vdCBkZXBlbmQgb24gLyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdjYW4gZXhwbGljaXRseSBhZGQsIG9idGFpbiwgYW5kIHJlbW92ZSBkZXBlbmRlbmNpZXMgYWNyb3NzIG5lc3RlZCBzdGFja3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoKTtcbiAgICAgIGNvbnN0IHN0YWNrMSA9IG5ldyBjb3JlLlN0YWNrKGFwcCwgJ1Rlc3RTdGFjazEnKTtcbiAgICAgIGNvbnN0IGNvbnN0cnVjdDEgPSBuZXcgQ29uc3RydWN0KHN0YWNrMSwgJ0NvbW1vbkNvbnN0cnVjdCcpO1xuICAgICAgLy8gVXNlIGEgcmVhbGx5IGxvbmcgY29uc3RydWN0IGlkIHRvIGlkZW50aWZ5IGlzc3VlcyBiZXR3ZWVuIE5hbWVzLnVuaXF1ZUlkIGFuZCBOYW1lcy51bmlxdWVSZXNvdXJjZU5hbWVcbiAgICAgIGNvbnN0IG5lc3RlZFN0YWNrMSA9IG5ldyBjb3JlLlN0YWNrKGNvbnN0cnVjdDEsICdUZXN0TmVzdGVkU3RhY2sxJyk7XG4gICAgICBjb25zdCBuZXN0ZWRTdGFjazIgPSBuZXcgY29yZS5TdGFjayhjb25zdHJ1Y3QxLCAnVGVzdE5lc3RlZFN0YWNrMicpO1xuICAgICAgY29uc3QgcmVzb3VyY2UxID0gbmV3IGNvcmUuQ2ZuUmVzb3VyY2UobmVzdGVkU3RhY2sxLCAnUmVzb3VyY2UxJywgeyB0eXBlOiAnVGVzdDo6UmVzb3VyY2U6OkZha2UxJyB9KTtcbiAgICAgIGNvbnN0IHJlc291cmNlMiA9IG5ldyBjb3JlLkNmblJlc291cmNlKG5lc3RlZFN0YWNrMiwgJ1Jlc291cmNlMicsIHsgdHlwZTogJ1Rlc3Q6OlJlc291cmNlOjpGYWtlMicgfSk7XG5cbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgLy8gQWRkaW5nIHRoZSBzYW1lIHJlc291cmNlIGRlcGVuZGVuY3kgdHdpY2Ugc2hvdWxkIGJlIGEgbm8tb3BcbiAgICAgIGFkZERlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgZXhwZWN0KG5lc3RlZFN0YWNrMS5kZXBlbmRlbmNpZXMubGVuZ3RoKS50b0VxdWFsKDEpO1xuICAgICAgZXhwZWN0KG5lc3RlZFN0YWNrMS5kZXBlbmRlbmNpZXNbMF0ubm9kZS5pZCkudG9FcXVhbChuZXN0ZWRTdGFjazIubm9kZS5pZCk7XG5cbiAgICAgIHJlbW92ZURlcGVuZGVuY3kocmVzb3VyY2UxLCByZXNvdXJjZTIpO1xuICAgICAgLy8gRm9yIHN5bW1ldHJ5LCByZW1vdmluZyBhIGRlcGVuZGVuY3kgdGhhdCBkb2Vzbid0IGV4aXN0IHNob3VsZCBiZSBhIG5vLW9wXG4gICAgICByZW1vdmVEZXBlbmRlbmN5KHJlc291cmNlMSwgcmVzb3VyY2UyKTtcbiAgICAgIGV4cGVjdChzdGFjazEuZGVwZW5kZW5jaWVzLmxlbmd0aCkudG9FcXVhbCgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==