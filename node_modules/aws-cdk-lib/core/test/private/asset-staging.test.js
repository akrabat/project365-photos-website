"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const sinon = require("sinon");
const lib_1 = require("../../lib");
const asset_staging_1 = require("../../lib/private/asset-staging");
const DOCKER_CMD = process.env.CDK_DOCKER ?? 'docker';
describe('bundling', () => {
    afterEach(() => {
        sinon.restore();
    });
    test('AssetBundlingVolumeCopy bundles with volume copy ', () => {
        // GIVEN
        sinon.stub(process, 'platform').value('darwin');
        const spawnSyncStub = sinon.stub(child_process, 'spawnSync').returns({
            status: 0,
            stderr: Buffer.from('stderr'),
            stdout: Buffer.from('stdout'),
            pid: 123,
            output: ['stdout', 'stderr'],
            signal: null,
        });
        const options = {
            sourcePath: '/tmp/source',
            bundleDir: '/tmp/output',
            image: lib_1.DockerImage.fromRegistry('alpine'),
            user: '1000',
        };
        const helper = new asset_staging_1.AssetBundlingVolumeCopy(options);
        helper.run();
        // volume Creation
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'volume', 'create', sinon.match(/assetInput.*/g),
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'volume', 'create', sinon.match(/assetOutput.*/g),
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // volume removal
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'volume', 'rm', sinon.match(/assetInput.*/g),
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'volume', 'rm', sinon.match(/assetOutput.*/g),
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // prepare copy container
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'run',
            '--name', sinon.match(/copyContainer.*/g),
            '-v', sinon.match(/assetInput.*/g),
            '-v', sinon.match(/assetOutput.*/g),
            'alpine',
            'sh',
            '-c',
            `mkdir -p ${lib_1.AssetStaging.BUNDLING_INPUT_DIR} && chown -R ${options.user} ${lib_1.AssetStaging.BUNDLING_OUTPUT_DIR} && chown -R ${options.user} ${lib_1.AssetStaging.BUNDLING_INPUT_DIR}`,
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // delete copy container
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'rm', sinon.match(/copyContainer.*/g),
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // copy files to copy container
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'cp', `${options.sourcePath}/.`, `${helper.copyContainerName}:${lib_1.AssetStaging.BUNDLING_INPUT_DIR}`,
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // copy files from copy container to host
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match([
            'cp', `${helper.copyContainerName}:${lib_1.AssetStaging.BUNDLING_OUTPUT_DIR}/.`, options.bundleDir,
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
        // actual docker run
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match.array.contains([
            'run', '--rm',
            '--volumes-from', helper.copyContainerName,
            'alpine',
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
    });
    test('AssetBundlingBindMount bundles with bind mount ', () => {
        // GIVEN
        sinon.stub(process, 'platform').value('darwin');
        const spawnSyncStub = sinon.stub(child_process, 'spawnSync').returns({
            status: 0,
            stderr: Buffer.from('stderr'),
            stdout: Buffer.from('stdout'),
            pid: 123,
            output: ['stdout', 'stderr'],
            signal: null,
        });
        const options = {
            sourcePath: '/tmp/source',
            bundleDir: '/tmp/output',
            image: lib_1.DockerImage.fromRegistry('alpine'),
            user: '1000',
        };
        const helper = new asset_staging_1.AssetBundlingBindMount(options);
        helper.run();
        // actual docker run with bind mount is called
        expect(spawnSyncStub.calledWith(DOCKER_CMD, sinon.match.array.contains([
            'run', '--rm',
            '-v',
            'alpine',
        ]), { encoding: 'utf-8', stdio: ['ignore', process.stderr, 'inherit'] })).toEqual(true);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtc3RhZ2luZy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXQtc3RhZ2luZy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0NBQStDO0FBQy9DLCtCQUErQjtBQUMvQixtQ0FBc0Q7QUFDdEQsbUVBQWtHO0FBRWxHLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFFBQVEsQ0FBQztBQUV0RCxRQUFRLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtJQUN4QixTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2xCLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG1EQUFtRCxFQUFFLEdBQUcsRUFBRTtRQUM3RCxRQUFRO1FBQ1IsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUNuRSxNQUFNLEVBQUUsQ0FBQztZQUNULE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUM3QixNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDN0IsR0FBRyxFQUFFLEdBQUc7WUFDUixNQUFNLEVBQUUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDO1lBQzVCLE1BQU0sRUFBRSxJQUFJO1NBQ2IsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxPQUFPLEdBQUc7WUFDZCxVQUFVLEVBQUUsYUFBYTtZQUN6QixTQUFTLEVBQUUsYUFBYTtZQUN4QixLQUFLLEVBQUUsaUJBQVcsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1lBQ3pDLElBQUksRUFBRSxNQUFNO1NBQ2IsQ0FBQztRQUNGLE1B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SyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7WUFDckUsS0FBSyxFQUFFLE1BQU07WUFDYixJQUFJO1lBQ0osUUFBUTtTQUNULENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFGLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjaGlsZF9wcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0ICogYXMgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IHsgQXNzZXRTdGFnaW5nLCBEb2NrZXJJbWFnZSB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgeyBBc3NldEJ1bmRsaW5nQmluZE1vdW50LCBBc3NldEJ1bmRsaW5nVm9sdW1lQ29weSB9IGZyb20gJy4uLy4uL2xpYi9wcml2YXRlL2Fzc2V0LXN0YWdpbmcnO1xuXG5jb25zdCBET0NLRVJfQ01EID0gcHJvY2Vzcy5lbnYuQ0RLX0RPQ0tFUiA/PyAnZG9ja2VyJztcblxuZGVzY3JpYmUoJ2J1bmRsaW5nJywgKCkgPT4ge1xuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHNpbm9uLnJlc3RvcmUoKTtcbiAgfSk7XG5cbiAgdGVzdCgnQXNzZXRCdW5kbGluZ1ZvbHVtZUNvcHkgYnVuZGxlcyB3aXRoIHZvbHVtZSBjb3B5ICcsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIHNpbm9uLnN0dWIocHJvY2VzcywgJ3BsYXRmb3JtJykudmFsdWUoJ2RhcndpbicpO1xuICAgIGNvbnN0IHNwYXduU3luY1N0dWIgPSBzaW5vbi5zdHViKGNoaWxkX3Byb2Nlc3MsICdzcGF3blN5bmMnKS5yZXR1cm5zKHtcbiAgICAgIHN0YXR1czogMCxcbiAgICAgIHN0ZGVycjogQnVmZmVyLmZyb20oJ3N0ZGVycicpLFxuICAgICAgc3Rkb3V0OiBCdWZmZXIuZnJvbSgnc3Rkb3V0JyksXG4gICAgICBwaWQ6IDEyMyxcbiAgICAgIG91dHB1dDogWydzdGRvdXQnLCAnc3RkZXJyJ10sXG4gICAgICBzaWduYWw6IG51bGwsXG4gICAgfSk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIHNvdXJjZVBhdGg6ICcvdG1wL3NvdXJjZScsXG4gICAgICBidW5kbGVEaXI6ICcvdG1wL291dHB1dCcsXG4gICAgICBpbWFnZTogRG9ja2VySW1hZ2UuZnJvbVJlZ2lzdHJ5KCdhbHBpbmUnKSxcbiAgICAgIHVzZXI6ICcxMDAwJyxcbiAgICB9O1xuICAgIGNvbnN0IGhlbHBlciA9IG5ldyBBc3NldEJ1bmRsaW5nVm9sdW1lQ29weShvcHRpb25zKTtcbiAgICBoZWxwZXIucnVuKCk7XG5cbiAgICAvLyB2b2x1bWUgQ3JlYXRpb25cbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoKFtcbiAgICAgICd2b2x1bWUnLCAnY3JlYXRlJywgc2lub24ubWF0Y2goL2Fzc2V0SW5wdXQuKi9nKSxcbiAgICBdKSwgeyBlbmNvZGluZzogJ3V0Zi04Jywgc3RkaW86IFsnaWdub3JlJywgcHJvY2Vzcy5zdGRlcnIsICdpbmhlcml0J10gfSkpLnRvRXF1YWwodHJ1ZSk7XG5cbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoKFtcbiAgICAgICd2b2x1bWUnLCAnY3JlYXRlJywgc2lub24ubWF0Y2goL2Fzc2V0T3V0cHV0LiovZyksXG4gICAgXSksIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIHN0ZGlvOiBbJ2lnbm9yZScsIHByb2Nlc3Muc3RkZXJyLCAnaW5oZXJpdCddIH0pKS50b0VxdWFsKHRydWUpO1xuXG4gICAgLy8gdm9sdW1lIHJlbW92YWxcbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoKFtcbiAgICAgICd2b2x1bWUnLCAncm0nLCBzaW5vbi5tYXRjaCgvYXNzZXRJbnB1dC4qL2cpLFxuICAgIF0pLCB7IGVuY29kaW5nOiAndXRmLTgnLCBzdGRpbzogWydpZ25vcmUnLCBwcm9jZXNzLnN0ZGVyciwgJ2luaGVyaXQnXSB9KSkudG9FcXVhbCh0cnVlKTtcblxuICAgIGV4cGVjdChzcGF3blN5bmNTdHViLmNhbGxlZFdpdGgoRE9DS0VSX0NNRCwgc2lub24ubWF0Y2goW1xuICAgICAgJ3ZvbHVtZScsICdybScsIHNpbm9uLm1hdGNoKC9hc3NldE91dHB1dC4qL2cpLFxuICAgIF0pLCB7IGVuY29kaW5nOiAndXRmLTgnLCBzdGRpbzogWydpZ25vcmUnLCBwcm9jZXNzLnN0ZGVyciwgJ2luaGVyaXQnXSB9KSkudG9FcXVhbCh0cnVlKTtcblxuICAgIC8vIHByZXBhcmUgY29weSBjb250YWluZXJcbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoKFtcbiAgICAgICdydW4nLFxuICAgICAgJy0tbmFtZScsIHNpbm9uLm1hdGNoKC9jb3B5Q29udGFpbmVyLiovZyksXG4gICAgICAnLXYnLCBzaW5vbi5tYXRjaCgvYXNzZXRJbnB1dC4qL2cpLFxuICAgICAgJy12Jywgc2lub24ubWF0Y2goL2Fzc2V0T3V0cHV0LiovZyksXG4gICAgICAnYWxwaW5lJyxcbiAgICAgICdzaCcsXG4gICAgICAnLWMnLFxuICAgICAgYG1rZGlyIC1wICR7QXNzZXRTdGFnaW5nLkJVTkRMSU5HX0lOUFVUX0RJUn0gJiYgY2hvd24gLVIgJHtvcHRpb25zLnVzZXJ9ICR7QXNzZXRTdGFnaW5nLkJVTkRMSU5HX09VVFBVVF9ESVJ9ICYmIGNob3duIC1SICR7b3B0aW9ucy51c2VyfSAke0Fzc2V0U3RhZ2luZy5CVU5ETElOR19JTlBVVF9ESVJ9YCxcbiAgICBdKSwgeyBlbmNvZGluZzogJ3V0Zi04Jywgc3RkaW86IFsnaWdub3JlJywgcHJvY2Vzcy5zdGRlcnIsICdpbmhlcml0J10gfSkpLnRvRXF1YWwodHJ1ZSk7XG5cbiAgICAvLyBkZWxldGUgY29weSBjb250YWluZXJcbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoKFtcbiAgICAgICdybScsIHNpbm9uLm1hdGNoKC9jb3B5Q29udGFpbmVyLiovZyksXG4gICAgXSksIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIHN0ZGlvOiBbJ2lnbm9yZScsIHByb2Nlc3Muc3RkZXJyLCAnaW5oZXJpdCddIH0pKS50b0VxdWFsKHRydWUpO1xuXG4gICAgLy8gY29weSBmaWxlcyB0byBjb3B5IGNvbnRhaW5lclxuICAgIGV4cGVjdChzcGF3blN5bmNTdHViLmNhbGxlZFdpdGgoRE9DS0VSX0NNRCwgc2lub24ubWF0Y2goW1xuICAgICAgJ2NwJywgYCR7b3B0aW9ucy5zb3VyY2VQYXRofS8uYCwgYCR7aGVscGVyLmNvcHlDb250YWluZXJOYW1lfToke0Fzc2V0U3RhZ2luZy5CVU5ETElOR19JTlBVVF9ESVJ9YCxcbiAgICBdKSwgeyBlbmNvZGluZzogJ3V0Zi04Jywgc3RkaW86IFsnaWdub3JlJywgcHJvY2Vzcy5zdGRlcnIsICdpbmhlcml0J10gfSkpLnRvRXF1YWwodHJ1ZSk7XG5cbiAgICAvLyBjb3B5IGZpbGVzIGZyb20gY29weSBjb250YWluZXIgdG8gaG9zdFxuICAgIGV4cGVjdChzcGF3blN5bmNTdHViLmNhbGxlZFdpdGgoRE9DS0VSX0NNRCwgc2lub24ubWF0Y2goW1xuICAgICAgJ2NwJywgYCR7aGVscGVyLmNvcHlDb250YWluZXJOYW1lfToke0Fzc2V0U3RhZ2luZy5CVU5ETElOR19PVVRQVVRfRElSfS8uYCwgb3B0aW9ucy5idW5kbGVEaXIsXG4gICAgXSksIHsgZW5jb2Rpbmc6ICd1dGYtOCcsIHN0ZGlvOiBbJ2lnbm9yZScsIHByb2Nlc3Muc3RkZXJyLCAnaW5oZXJpdCddIH0pKS50b0VxdWFsKHRydWUpO1xuXG4gICAgLy8gYWN0dWFsIGRvY2tlciBydW5cbiAgICBleHBlY3Qoc3Bhd25TeW5jU3R1Yi5jYWxsZWRXaXRoKERPQ0tFUl9DTUQsIHNpbm9uLm1hdGNoLmFycmF5LmNvbnRhaW5zKFtcbiAgICAgICdydW4nLCAnLS1ybScsXG4gICAgICAnLS12b2x1bWVzLWZyb20nLCBoZWxwZXIuY29weUNvbnRhaW5lck5hbWUsXG4gICAgICAnYWxwaW5lJyxcbiAgICBdKSwgeyBlbmNvZGluZzogJ3V0Zi04Jywgc3RkaW86IFsnaWdub3JlJywgcHJvY2Vzcy5zdGRlcnIsICdpbmhlcml0J10gfSkpLnRvRXF1YWwodHJ1ZSk7XG5cbiAgfSk7XG5cbiAgdGVzdCgnQXNzZXRCdW5kbGluZ0JpbmRNb3VudCBidW5kbGVzIHdpdGggYmluZCBtb3VudCAnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBzaW5vbi5zdHViKHByb2Nlc3MsICdwbGF0Zm9ybScpLnZhbHVlKCdkYXJ3aW4nKTtcbiAgICBjb25zdCBzcGF3blN5bmNTdHViID0gc2lub24uc3R1YihjaGlsZF9wcm9jZXNzLCAnc3Bhd25TeW5jJykucmV0dXJucyh7XG4gICAgICBzdGF0dXM6IDAsXG4gICAgICBzdGRlcnI6IEJ1ZmZlci5mcm9tKCdzdGRlcnInKSxcbiAgICAgIHN0ZG91dDogQnVmZmVyLmZyb20oJ3N0ZG91dCcpLFxuICAgICAgcGlkOiAxMjMsXG4gICAgICBvdXRwdXQ6IFsnc3Rkb3V0JywgJ3N0ZGVyciddLFxuICAgICAgc2lnbmFsOiBudWxsLFxuICAgIH0pO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBzb3VyY2VQYXRoOiAnL3RtcC9zb3VyY2UnLFxuICAgICAgYnVuZGxlRGlyOiAnL3RtcC9vdXRwdXQnLFxuICAgICAgaW1hZ2U6IERvY2tlckltYWdlLmZyb21SZWdpc3RyeSgnYWxwaW5lJyksXG4gICAgICB1c2VyOiAnMTAwMCcsXG4gICAgfTtcbiAgICBjb25zdCBoZWxwZXIgPSBuZXcgQXNzZXRCdW5kbGluZ0JpbmRNb3VudChvcHRpb25zKTtcbiAgICBoZWxwZXIucnVuKCk7XG5cbiAgICAvLyBhY3R1YWwgZG9ja2VyIHJ1biB3aXRoIGJpbmQgbW91bnQgaXMgY2FsbGVkXG4gICAgZXhwZWN0KHNwYXduU3luY1N0dWIuY2FsbGVkV2l0aChET0NLRVJfQ01ELCBzaW5vbi5tYXRjaC5hcnJheS5jb250YWlucyhbXG4gICAgICAncnVuJywgJy0tcm0nLFxuICAgICAgJy12JyxcbiAgICAgICdhbHBpbmUnLFxuICAgIF0pLCB7IGVuY29kaW5nOiAndXRmLTgnLCBzdGRpbzogWydpZ25vcmUnLCBwcm9jZXNzLnN0ZGVyciwgJ2luaGVyaXQnXSB9KSkudG9FcXVhbCh0cnVlKTtcbiAgfSk7XG59KTtcbiJdfQ==