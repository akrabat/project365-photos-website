"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const constructs_1 = require("constructs");
const lib_1 = require("../lib");
const runtime_info_1 = require("../lib/private/runtime-info");
const JSII_RUNTIME_SYMBOL = Symbol.for('jsii.rtti');
let app;
let stack;
let _cdkVersion = undefined;
// The runtime metadata this test relies on is only available if the most
// recent compile has happened using 'jsii', as the jsii compiler injects
// this metadata.
//
// If the most recent compile was using 'tsc', the metadata will not have
// been injected, and the test suite will fail.
//
// Tolerate `tsc` builds locally, but not on CodeBuild.
const codeBuild = !!process.env.CODEBUILD_BUILD_ID;
const moduleCompiledWithTsc = (0, runtime_info_1.constructInfoFromConstruct)(new lib_1.Stack())?.fqn === 'constructs.Construct';
let describeTscSafe = describe;
if (moduleCompiledWithTsc && !codeBuild) {
    // eslint-disable-next-line
    console.error('It appears this module was compiled with `tsc` instead of `jsii` in a local build. Skipping this test suite.');
    describeTscSafe = describe.skip;
}
beforeEach(() => {
    app = new lib_1.App();
    stack = new lib_1.Stack(app, 'Stack', {
        analyticsReporting: true,
    });
});
describeTscSafe('constructInfoFromConstruct', () => {
    test('returns fqn and version for core constructs', () => {
        const constructInfo = (0, runtime_info_1.constructInfoFromConstruct)(stack);
        expect(constructInfo).toBeDefined();
        expect(constructInfo?.fqn).toEqual('aws-cdk-lib.Stack');
        expect(constructInfo?.version).toEqual(localCdkVersion());
    });
    test('returns jsii runtime info if present', () => {
        const construct = new TestConstruct(stack, 'TestConstruct');
        const constructInfo = (0, runtime_info_1.constructInfoFromConstruct)(construct);
        expect(constructInfo?.fqn).toEqual('@aws-cdk/test.TestConstruct');
    });
    test('throws if the jsii runtime info is not as expected', () => {
        var _b, _c, _d, _e, _f, _g;
        const constructRuntimeInfoNotObject = new (_c = class extends constructs_1.Construct {
            },
            _b = JSII_RUNTIME_SYMBOL,
            // @ts-ignore
            _c[_b] = 'HelloWorld',
            _c)(stack, 'RuntimeNotObject');
        const constructWithWrongRuntimeInfoMembers = new (_e = class extends constructs_1.Construct {
            },
            _d = JSII_RUNTIME_SYMBOL,
            // @ts-ignore
            _e[_d] = { foo: 'bar' },
            _e)(stack, 'RuntimeWrongMembers');
        const constructWithWrongRuntimeInfoTypes = new (_g = class extends constructs_1.Construct {
            },
            _f = JSII_RUNTIME_SYMBOL,
            // @ts-ignore
            _g[_f] = { fqn: 42, version: { name: '0.0.0' } },
            _g)(stack, 'RuntimeWrongTypes');
        const errorMessage = 'malformed jsii runtime info for construct';
        [constructRuntimeInfoNotObject, constructWithWrongRuntimeInfoMembers, constructWithWrongRuntimeInfoTypes].forEach(construct => {
            expect(() => (0, runtime_info_1.constructInfoFromConstruct)(construct)).toThrow(errorMessage);
        });
    });
});
describeTscSafe('constructInfoForStack', () => {
    test('returns stack itself and jsii runtime if stack is empty', () => {
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        expect(constructInfos.length).toEqual(2);
        const stackInfo = constructInfos.find(i => /Stack/.test(i.fqn));
        const jsiiInfo = constructInfos.find(i => i.fqn === 'jsii-runtime.Runtime');
        expect(stackInfo?.fqn).toEqual('aws-cdk-lib.Stack');
        expect(stackInfo?.version).toEqual(localCdkVersion());
        expect(jsiiInfo?.version).toMatch(/node.js/);
    });
    test('sanitizes jsii runtime info to remove unwanted characters', () => {
        process.env.JSII_AGENT = 'DotNet/5.0.3/.NETCore^App,Version=v3.1!/1.0.0_0';
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        const jsiiInfo = constructInfos.find(i => i.fqn === 'jsii-runtime.Runtime');
        expect(jsiiInfo?.version).toEqual('DotNet/5.0.3/.NETCore-App-Version=v3.1-/1.0.0_0');
        delete process.env.JSII_AGENT;
    });
    test('returns info for constructs added to the stack', () => {
        new TestConstruct(stack, 'TestConstruct');
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        expect(constructInfos.length).toEqual(3);
        expect(constructInfos.map(info => info.fqn)).toContain('@aws-cdk/test.TestConstruct');
    });
    test('returns unique info (no duplicates)', () => {
        new TestConstruct(stack, 'TestConstruct1');
        new TestConstruct(stack, 'TestConstruct2');
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        expect(constructInfos.length).toEqual(3);
        expect(constructInfos.map(info => info.fqn)).toContain('@aws-cdk/test.TestConstruct');
    });
    test('returns info from nested constructs', () => {
        new class extends constructs_1.Construct {
            constructor(scope, id) {
                super(scope, id);
                new TestConstruct(this, 'TestConstruct');
            }
        }(stack, 'Nested');
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        expect(constructInfos.map(info => info.fqn)).toContain('@aws-cdk/test.TestConstruct');
    });
    test('does not return info from nested stacks', () => {
        new class extends constructs_1.Construct {
            constructor(scope, id) {
                var _b, _c, _d, _e, _f, _g;
                super(scope, id);
                new TestConstruct(this, 'TestConstruct');
                new (_c = class extends lib_1.Stack {
                    },
                    _b = JSII_RUNTIME_SYMBOL,
                    // @ts-ignore
                    _c[_b] = { fqn: '@aws-cdk/test.TestStackInsideStack', version: localCdkVersion() },
                    _c)(this, 'StackInsideStack');
                new (_e = class extends lib_1.NestedStack {
                    },
                    _d = JSII_RUNTIME_SYMBOL,
                    // @ts-ignore
                    _e[_d] = { fqn: '@aws-cdk/test.TestNestedStackInsideStack', version: localCdkVersion() },
                    _e)(this, 'NestedStackInsideStack');
                new (_g = class extends lib_1.Stage {
                    },
                    _f = JSII_RUNTIME_SYMBOL,
                    // @ts-ignore
                    _g[_f] = { fqn: '@aws-cdk/test.TestStageInsideStack', version: localCdkVersion() },
                    _g)(this, 'StageInsideStack');
            }
        }(stack, 'ParentConstruct');
        const constructInfos = (0, runtime_info_1.constructInfoFromStack)(stack);
        const fqns = constructInfos.map(info => info.fqn);
        expect(fqns).toContain('@aws-cdk/test.TestConstruct');
        expect(fqns).not.toContain('@aws-cdk/test.TestStackInsideStack');
        expect(fqns).not.toContain('@aws-cdk/test.TestNestedStackInsideStack');
        expect(fqns).not.toContain('@aws-cdk/test.TestStageInsideStack');
    });
});
class TestConstruct extends constructs_1.Construct {
}
_a = JSII_RUNTIME_SYMBOL;
// @ts-ignore
TestConstruct[_a] = { fqn: '@aws-cdk/test.TestConstruct', version: localCdkVersion() };
/**
 * The exact values we expect from testing against version numbers in this suite depend on whether we're running
 * on a development or release branch. Returns the local package.json version, which will be '0.0.0' unless we're
 * on a release branch, in which case it should be the real version numbers (e.g., 1.91.0).
 */
function localCdkVersion() {
    if (!_cdkVersion) {
        // eslint-disable-next-line @typescript-eslint/no-require-imports
        const pkgJson = findParentPkgJson(__dirname);
        _cdkVersion = pkgJson.version;
        if (!_cdkVersion) {
            throw new Error('Unable to determine CDK version');
        }
    }
    return _cdkVersion;
}
function findParentPkgJson(dir, depth = 1, limit = 5) {
    const target = path.join(dir, 'package.json');
    if (fs.existsSync(target)) {
        return JSON.parse(fs.readFileSync(target, 'utf8'));
    }
    else if (depth < limit) {
        return findParentPkgJson(path.join(dir, '..'), depth + 1, limit);
    }
    throw new Error(`No \`package.json\` file found within ${depth} parent directories`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS1pbmZvLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJydW50aW1lLWluZm8udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDJDQUF1QztBQUN2QyxnQ0FBd0Q7QUFDeEQsOERBQWlHO0FBRWpHLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVwRCxJQUFJLEdBQVEsQ0FBQztBQUNiLElBQUksS0FBWSxDQUFDO0FBQ2pCLElBQUksV0FBVyxHQUF1QixTQUFTLENBQUM7QUFFaEQseUVBQXlFO0FBQ3pFLHlFQUF5RTtBQUN6RSxpQkFBaUI7QUFDakIsRUFBRTtBQUNGLHlFQUF5RTtBQUN6RSwrQ0FBK0M7QUFDL0MsRUFBRTtBQUNGLHVEQUF1RDtBQUN2RCxNQUFNLFNBQVMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztBQUNuRCxNQUFNLHFCQUFxQixHQUFHLElBQUEseUNBQTBCLEVBQUMsSUFBSSxXQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsS0FBSyxzQkFBc0IsQ0FBQztBQUN0RyxJQUFJLGVBQWUsR0FBRyxRQUFRLENBQUM7QUFDL0IsSUFBSSxxQkFBcUIsSUFBSSxDQUFDLFNBQVMsRUFBRTtJQUN2QywyQkFBMkI7SUFDM0IsT0FBTyxDQUFDLEtBQUssQ0FBQyw4R0FBOEcsQ0FBQyxDQUFDO0lBQzlILGVBQWUsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO0NBQ2pDO0FBRUQsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLFNBQUcsRUFBRSxDQUFDO0lBQ2hCLEtBQUssR0FBRyxJQUFJLFdBQUssQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFO1FBQzlCLGtCQUFrQixFQUFFLElBQUk7S0FDekIsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQ2pELElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7UUFDdkQsTUFBTSxhQUFhLEdBQUcsSUFBQSx5Q0FBMEIsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUN4RCxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEMsTUFBTSxDQUFDLGFBQWEsRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUN4RCxNQUFNLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtRQUNoRCxNQUFNLFNBQVMsR0FBRyxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFNUQsTUFBTSxhQUFhLEdBQUcsSUFBQSx5Q0FBMEIsRUFBQyxTQUFTLENBQUMsQ0FBQztRQUM1RCxNQUFNLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQ3BFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTs7UUFDOUQsTUFBTSw2QkFBNkIsR0FBRyxVQUFJLEtBQU0sU0FBUSxzQkFBUzthQUdoRTtpQkFEMEIsbUJBQW1CO1lBRDVDLGFBQWE7WUFDVyxNQUFxQixHQUFHLFlBQWE7Z0JBQzdELEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdCLE1BQU0sb0NBQW9DLEdBQUcsVUFBSSxLQUFNLFNBQVEsc0JBQVM7YUFHdkU7aUJBRDBCLG1CQUFtQjtZQUQ1QyxhQUFhO1lBQ1csTUFBcUIsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUc7Z0JBQy9ELEtBQUssRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sa0NBQWtDLEdBQUcsVUFBSSxLQUFNLFNBQVEsc0JBQVM7YUFHckU7aUJBRDBCLG1CQUFtQjtZQUQ1QyxhQUFhO1lBQ1csTUFBcUIsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxFQUFHO2dCQUN4RixLQUFLLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUU5QixNQUFNLFlBQVksR0FBRywyQ0FBMkMsQ0FBQztRQUNqRSxDQUFDLDZCQUE2QixFQUFFLG9DQUFvQyxFQUFFLGtDQUFrQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzVILE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFBLHlDQUEwQixFQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWUsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDNUMsSUFBSSxDQUFDLHlEQUF5RCxFQUFFLEdBQUcsRUFBRTtRQUNuRSxNQUFNLGNBQWMsR0FBRyxJQUFBLHFDQUFzQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXJELE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sU0FBUyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLHNCQUFzQixDQUFDLENBQUM7UUFDNUUsTUFBTSxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELE1BQU0sQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDJEQUEyRCxFQUFFLEdBQUcsRUFBRTtRQUNyRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxpREFBaUQsQ0FBQztRQUMzRSxNQUFNLGNBQWMsR0FBRyxJQUFBLHFDQUFzQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLHNCQUFzQixDQUFDLENBQUM7UUFFNUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsaURBQWlELENBQUMsQ0FBQztRQUVyRixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO0lBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLGdEQUFnRCxFQUFFLEdBQUcsRUFBRTtRQUMxRCxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFMUMsTUFBTSxjQUFjLEdBQUcsSUFBQSxxQ0FBc0IsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUVyRCxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6QyxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQ3hGLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtRQUMvQyxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUMzQyxJQUFJLGFBQWEsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUUzQyxNQUFNLGNBQWMsR0FBRyxJQUFBLHFDQUFzQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXJELE1BQU0sQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDeEYsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO1FBQy9DLElBQUksS0FBTSxTQUFRLHNCQUFTO1lBQ3pCLFlBQVksS0FBZ0IsRUFBRSxFQUFVO2dCQUN0QyxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLENBQUM7YUFDMUM7U0FDRixDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVuQixNQUFNLGNBQWMsR0FBRyxJQUFBLHFDQUFzQixFQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXJELE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDeEYsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMseUNBQXlDLEVBQUUsR0FBRyxFQUFFO1FBQ25ELElBQUksS0FBTSxTQUFRLHNCQUFTO1lBQ3pCLFlBQVksS0FBZ0IsRUFBRSxFQUFVOztnQkFDdEMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFFakIsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxDQUFDO2dCQUV6QyxVQUFJLEtBQU0sU0FBUSxXQUFLO3FCQUd0Qjt5QkFEMEIsbUJBQW1CO29CQUQ1QyxhQUFhO29CQUNXLE1BQXFCLEdBQUcsRUFBRSxHQUFHLEVBQUUsb0NBQW9DLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFO3dCQUN6SCxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztnQkFFNUIsVUFBSSxLQUFNLFNBQVEsaUJBQVc7cUJBRzVCO3lCQUQwQixtQkFBbUI7b0JBRDVDLGFBQWE7b0JBQ1csTUFBcUIsR0FBRyxFQUFFLEdBQUcsRUFBRSwwQ0FBMEMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLEVBQUU7d0JBQy9ILElBQUksRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO2dCQUVsQyxVQUFJLEtBQU0sU0FBUSxXQUFLO3FCQUd0Qjt5QkFEMEIsbUJBQW1CO29CQUQ1QyxhQUFhO29CQUNXLE1BQXFCLEdBQUcsRUFBRSxHQUFHLEVBQUUsb0NBQW9DLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxFQUFFO3dCQUN6SCxJQUFJLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzthQUM3QjtTQUNGLENBQUMsS0FBSyxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFNUIsTUFBTSxjQUFjLEdBQUcsSUFBQSxxQ0FBc0IsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUVyRCxNQUFNLElBQUksR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUN0RCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7UUFDdkUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsb0NBQW9DLENBQUMsQ0FBQztJQUNuRSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxhQUFjLFNBQVEsc0JBQVM7O0tBRVYsbUJBQW1CO0FBRDVDLGFBQWE7QUFDVyxpQkFBcUIsR0FBRyxFQUFFLEdBQUcsRUFBRSw2QkFBNkIsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLEVBQUUsQ0FBQTtBQUdwSDs7OztHQUlHO0FBQ0gsU0FBUyxlQUFlO0lBQ3RCLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDaEIsaUVBQWlFO1FBQ2pFLE1BQU0sT0FBTyxHQUFHLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLFdBQVcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQzlCLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1NBQ3BEO0tBQ0Y7SUFDRCxPQUFPLFdBQVcsQ0FBQztBQUNyQixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxHQUFXLEVBQUUsUUFBZ0IsQ0FBQyxFQUFFLFFBQWdCLENBQUM7SUFDMUUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDOUMsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0tBQ3BEO1NBQU0sSUFBSSxLQUFLLEdBQUcsS0FBSyxFQUFFO1FBQ3hCLE9BQU8saUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsS0FBSyxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUNsRTtJQUVELE1BQU0sSUFBSSxLQUFLLENBQUMseUNBQXlDLEtBQUsscUJBQXFCLENBQUMsQ0FBQztBQUN2RixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgQXBwLCBOZXN0ZWRTdGFjaywgU3RhY2ssIFN0YWdlIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IGNvbnN0cnVjdEluZm9Gcm9tQ29uc3RydWN0LCBjb25zdHJ1Y3RJbmZvRnJvbVN0YWNrIH0gZnJvbSAnLi4vbGliL3ByaXZhdGUvcnVudGltZS1pbmZvJztcblxuY29uc3QgSlNJSV9SVU5USU1FX1NZTUJPTCA9IFN5bWJvbC5mb3IoJ2pzaWkucnR0aScpO1xuXG5sZXQgYXBwOiBBcHA7XG5sZXQgc3RhY2s6IFN0YWNrO1xubGV0IF9jZGtWZXJzaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cbi8vIFRoZSBydW50aW1lIG1ldGFkYXRhIHRoaXMgdGVzdCByZWxpZXMgb24gaXMgb25seSBhdmFpbGFibGUgaWYgdGhlIG1vc3Rcbi8vIHJlY2VudCBjb21waWxlIGhhcyBoYXBwZW5lZCB1c2luZyAnanNpaScsIGFzIHRoZSBqc2lpIGNvbXBpbGVyIGluamVjdHNcbi8vIHRoaXMgbWV0YWRhdGEuXG4vL1xuLy8gSWYgdGhlIG1vc3QgcmVjZW50IGNvbXBpbGUgd2FzIHVzaW5nICd0c2MnLCB0aGUgbWV0YWRhdGEgd2lsbCBub3QgaGF2ZVxuLy8gYmVlbiBpbmplY3RlZCwgYW5kIHRoZSB0ZXN0IHN1aXRlIHdpbGwgZmFpbC5cbi8vXG4vLyBUb2xlcmF0ZSBgdHNjYCBidWlsZHMgbG9jYWxseSwgYnV0IG5vdCBvbiBDb2RlQnVpbGQuXG5jb25zdCBjb2RlQnVpbGQgPSAhIXByb2Nlc3MuZW52LkNPREVCVUlMRF9CVUlMRF9JRDtcbmNvbnN0IG1vZHVsZUNvbXBpbGVkV2l0aFRzYyA9IGNvbnN0cnVjdEluZm9Gcm9tQ29uc3RydWN0KG5ldyBTdGFjaygpKT8uZnFuID09PSAnY29uc3RydWN0cy5Db25zdHJ1Y3QnO1xubGV0IGRlc2NyaWJlVHNjU2FmZSA9IGRlc2NyaWJlO1xuaWYgKG1vZHVsZUNvbXBpbGVkV2l0aFRzYyAmJiAhY29kZUJ1aWxkKSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuICBjb25zb2xlLmVycm9yKCdJdCBhcHBlYXJzIHRoaXMgbW9kdWxlIHdhcyBjb21waWxlZCB3aXRoIGB0c2NgIGluc3RlYWQgb2YgYGpzaWlgIGluIGEgbG9jYWwgYnVpbGQuIFNraXBwaW5nIHRoaXMgdGVzdCBzdWl0ZS4nKTtcbiAgZGVzY3JpYmVUc2NTYWZlID0gZGVzY3JpYmUuc2tpcDtcbn1cblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBBcHAoKTtcbiAgc3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnU3RhY2snLCB7XG4gICAgYW5hbHl0aWNzUmVwb3J0aW5nOiB0cnVlLFxuICB9KTtcbn0pO1xuXG5kZXNjcmliZVRzY1NhZmUoJ2NvbnN0cnVjdEluZm9Gcm9tQ29uc3RydWN0JywgKCkgPT4ge1xuICB0ZXN0KCdyZXR1cm5zIGZxbiBhbmQgdmVyc2lvbiBmb3IgY29yZSBjb25zdHJ1Y3RzJywgKCkgPT4ge1xuICAgIGNvbnN0IGNvbnN0cnVjdEluZm8gPSBjb25zdHJ1Y3RJbmZvRnJvbUNvbnN0cnVjdChzdGFjayk7XG4gICAgZXhwZWN0KGNvbnN0cnVjdEluZm8pLnRvQmVEZWZpbmVkKCk7XG4gICAgZXhwZWN0KGNvbnN0cnVjdEluZm8/LmZxbikudG9FcXVhbCgnYXdzLWNkay1saWIuU3RhY2snKTtcbiAgICBleHBlY3QoY29uc3RydWN0SW5mbz8udmVyc2lvbikudG9FcXVhbChsb2NhbENka1ZlcnNpb24oKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3JldHVybnMganNpaSBydW50aW1lIGluZm8gaWYgcHJlc2VudCcsICgpID0+IHtcbiAgICBjb25zdCBjb25zdHJ1Y3QgPSBuZXcgVGVzdENvbnN0cnVjdChzdGFjaywgJ1Rlc3RDb25zdHJ1Y3QnKTtcblxuICAgIGNvbnN0IGNvbnN0cnVjdEluZm8gPSBjb25zdHJ1Y3RJbmZvRnJvbUNvbnN0cnVjdChjb25zdHJ1Y3QpO1xuICAgIGV4cGVjdChjb25zdHJ1Y3RJbmZvPy5mcW4pLnRvRXF1YWwoJ0Bhd3MtY2RrL3Rlc3QuVGVzdENvbnN0cnVjdCcpO1xuICB9KTtcblxuICB0ZXN0KCd0aHJvd3MgaWYgdGhlIGpzaWkgcnVudGltZSBpbmZvIGlzIG5vdCBhcyBleHBlY3RlZCcsICgpID0+IHtcbiAgICBjb25zdCBjb25zdHJ1Y3RSdW50aW1lSW5mb05vdE9iamVjdCA9IG5ldyBjbGFzcyBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBbSlNJSV9SVU5USU1FX1NZTUJPTF0gPSAnSGVsbG9Xb3JsZCc7XG4gICAgfShzdGFjaywgJ1J1bnRpbWVOb3RPYmplY3QnKTtcbiAgICBjb25zdCBjb25zdHJ1Y3RXaXRoV3JvbmdSdW50aW1lSW5mb01lbWJlcnMgPSBuZXcgY2xhc3MgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgW0pTSUlfUlVOVElNRV9TWU1CT0xdID0geyBmb286ICdiYXInIH07XG4gICAgfShzdGFjaywgJ1J1bnRpbWVXcm9uZ01lbWJlcnMnKTtcbiAgICBjb25zdCBjb25zdHJ1Y3RXaXRoV3JvbmdSdW50aW1lSW5mb1R5cGVzID0gbmV3IGNsYXNzIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFtKU0lJX1JVTlRJTUVfU1lNQk9MXSA9IHsgZnFuOiA0MiwgdmVyc2lvbjogeyBuYW1lOiAnMC4wLjAnIH0gfTtcbiAgICB9KHN0YWNrLCAnUnVudGltZVdyb25nVHlwZXMnKTtcblxuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9ICdtYWxmb3JtZWQganNpaSBydW50aW1lIGluZm8gZm9yIGNvbnN0cnVjdCc7XG4gICAgW2NvbnN0cnVjdFJ1bnRpbWVJbmZvTm90T2JqZWN0LCBjb25zdHJ1Y3RXaXRoV3JvbmdSdW50aW1lSW5mb01lbWJlcnMsIGNvbnN0cnVjdFdpdGhXcm9uZ1J1bnRpbWVJbmZvVHlwZXNdLmZvckVhY2goY29uc3RydWN0ID0+IHtcbiAgICAgIGV4cGVjdCgoKSA9PiBjb25zdHJ1Y3RJbmZvRnJvbUNvbnN0cnVjdChjb25zdHJ1Y3QpKS50b1Rocm93KGVycm9yTWVzc2FnZSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlVHNjU2FmZSgnY29uc3RydWN0SW5mb0ZvclN0YWNrJywgKCkgPT4ge1xuICB0ZXN0KCdyZXR1cm5zIHN0YWNrIGl0c2VsZiBhbmQganNpaSBydW50aW1lIGlmIHN0YWNrIGlzIGVtcHR5JywgKCkgPT4ge1xuICAgIGNvbnN0IGNvbnN0cnVjdEluZm9zID0gY29uc3RydWN0SW5mb0Zyb21TdGFjayhzdGFjayk7XG5cbiAgICBleHBlY3QoY29uc3RydWN0SW5mb3MubGVuZ3RoKS50b0VxdWFsKDIpO1xuXG4gICAgY29uc3Qgc3RhY2tJbmZvID0gY29uc3RydWN0SW5mb3MuZmluZChpID0+IC9TdGFjay8udGVzdChpLmZxbikpO1xuICAgIGNvbnN0IGpzaWlJbmZvID0gY29uc3RydWN0SW5mb3MuZmluZChpID0+IGkuZnFuID09PSAnanNpaS1ydW50aW1lLlJ1bnRpbWUnKTtcbiAgICBleHBlY3Qoc3RhY2tJbmZvPy5mcW4pLnRvRXF1YWwoJ2F3cy1jZGstbGliLlN0YWNrJyk7XG4gICAgZXhwZWN0KHN0YWNrSW5mbz8udmVyc2lvbikudG9FcXVhbChsb2NhbENka1ZlcnNpb24oKSk7XG4gICAgZXhwZWN0KGpzaWlJbmZvPy52ZXJzaW9uKS50b01hdGNoKC9ub2RlLmpzLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nhbml0aXplcyBqc2lpIHJ1bnRpbWUgaW5mbyB0byByZW1vdmUgdW53YW50ZWQgY2hhcmFjdGVycycsICgpID0+IHtcbiAgICBwcm9jZXNzLmVudi5KU0lJX0FHRU5UID0gJ0RvdE5ldC81LjAuMy8uTkVUQ29yZV5BcHAsVmVyc2lvbj12My4xIS8xLjAuMF8wJztcbiAgICBjb25zdCBjb25zdHJ1Y3RJbmZvcyA9IGNvbnN0cnVjdEluZm9Gcm9tU3RhY2soc3RhY2spO1xuICAgIGNvbnN0IGpzaWlJbmZvID0gY29uc3RydWN0SW5mb3MuZmluZChpID0+IGkuZnFuID09PSAnanNpaS1ydW50aW1lLlJ1bnRpbWUnKTtcblxuICAgIGV4cGVjdChqc2lpSW5mbz8udmVyc2lvbikudG9FcXVhbCgnRG90TmV0LzUuMC4zLy5ORVRDb3JlLUFwcC1WZXJzaW9uPXYzLjEtLzEuMC4wXzAnKTtcblxuICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5KU0lJX0FHRU5UO1xuICB9KTtcblxuICB0ZXN0KCdyZXR1cm5zIGluZm8gZm9yIGNvbnN0cnVjdHMgYWRkZWQgdG8gdGhlIHN0YWNrJywgKCkgPT4ge1xuICAgIG5ldyBUZXN0Q29uc3RydWN0KHN0YWNrLCAnVGVzdENvbnN0cnVjdCcpO1xuXG4gICAgY29uc3QgY29uc3RydWN0SW5mb3MgPSBjb25zdHJ1Y3RJbmZvRnJvbVN0YWNrKHN0YWNrKTtcblxuICAgIGV4cGVjdChjb25zdHJ1Y3RJbmZvcy5sZW5ndGgpLnRvRXF1YWwoMyk7XG4gICAgZXhwZWN0KGNvbnN0cnVjdEluZm9zLm1hcChpbmZvID0+IGluZm8uZnFuKSkudG9Db250YWluKCdAYXdzLWNkay90ZXN0LlRlc3RDb25zdHJ1Y3QnKTtcbiAgfSk7XG5cbiAgdGVzdCgncmV0dXJucyB1bmlxdWUgaW5mbyAobm8gZHVwbGljYXRlcyknLCAoKSA9PiB7XG4gICAgbmV3IFRlc3RDb25zdHJ1Y3Qoc3RhY2ssICdUZXN0Q29uc3RydWN0MScpO1xuICAgIG5ldyBUZXN0Q29uc3RydWN0KHN0YWNrLCAnVGVzdENvbnN0cnVjdDInKTtcblxuICAgIGNvbnN0IGNvbnN0cnVjdEluZm9zID0gY29uc3RydWN0SW5mb0Zyb21TdGFjayhzdGFjayk7XG5cbiAgICBleHBlY3QoY29uc3RydWN0SW5mb3MubGVuZ3RoKS50b0VxdWFsKDMpO1xuICAgIGV4cGVjdChjb25zdHJ1Y3RJbmZvcy5tYXAoaW5mbyA9PiBpbmZvLmZxbikpLnRvQ29udGFpbignQGF3cy1jZGsvdGVzdC5UZXN0Q29uc3RydWN0Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3JldHVybnMgaW5mbyBmcm9tIG5lc3RlZCBjb25zdHJ1Y3RzJywgKCkgPT4ge1xuICAgIG5ldyBjbGFzcyBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgICAgIG5ldyBUZXN0Q29uc3RydWN0KHRoaXMsICdUZXN0Q29uc3RydWN0Jyk7XG4gICAgICB9XG4gICAgfShzdGFjaywgJ05lc3RlZCcpO1xuXG4gICAgY29uc3QgY29uc3RydWN0SW5mb3MgPSBjb25zdHJ1Y3RJbmZvRnJvbVN0YWNrKHN0YWNrKTtcblxuICAgIGV4cGVjdChjb25zdHJ1Y3RJbmZvcy5tYXAoaW5mbyA9PiBpbmZvLmZxbikpLnRvQ29udGFpbignQGF3cy1jZGsvdGVzdC5UZXN0Q29uc3RydWN0Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2RvZXMgbm90IHJldHVybiBpbmZvIGZyb20gbmVzdGVkIHN0YWNrcycsICgpID0+IHtcbiAgICBuZXcgY2xhc3MgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICAgIG5ldyBUZXN0Q29uc3RydWN0KHRoaXMsICdUZXN0Q29uc3RydWN0Jyk7XG5cbiAgICAgICAgbmV3IGNsYXNzIGV4dGVuZHMgU3RhY2sge1xuICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBbSlNJSV9SVU5USU1FX1NZTUJPTF0gPSB7IGZxbjogJ0Bhd3MtY2RrL3Rlc3QuVGVzdFN0YWNrSW5zaWRlU3RhY2snLCB2ZXJzaW9uOiBsb2NhbENka1ZlcnNpb24oKSB9XG4gICAgICAgIH0odGhpcywgJ1N0YWNrSW5zaWRlU3RhY2snKTtcblxuICAgICAgICBuZXcgY2xhc3MgZXh0ZW5kcyBOZXN0ZWRTdGFjayB7XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFtKU0lJX1JVTlRJTUVfU1lNQk9MXSA9IHsgZnFuOiAnQGF3cy1jZGsvdGVzdC5UZXN0TmVzdGVkU3RhY2tJbnNpZGVTdGFjaycsIHZlcnNpb246IGxvY2FsQ2RrVmVyc2lvbigpIH1cbiAgICAgICAgfSh0aGlzLCAnTmVzdGVkU3RhY2tJbnNpZGVTdGFjaycpO1xuXG4gICAgICAgIG5ldyBjbGFzcyBleHRlbmRzIFN0YWdlIHtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgW0pTSUlfUlVOVElNRV9TWU1CT0xdID0geyBmcW46ICdAYXdzLWNkay90ZXN0LlRlc3RTdGFnZUluc2lkZVN0YWNrJywgdmVyc2lvbjogbG9jYWxDZGtWZXJzaW9uKCkgfVxuICAgICAgICB9KHRoaXMsICdTdGFnZUluc2lkZVN0YWNrJyk7XG4gICAgICB9XG4gICAgfShzdGFjaywgJ1BhcmVudENvbnN0cnVjdCcpO1xuXG4gICAgY29uc3QgY29uc3RydWN0SW5mb3MgPSBjb25zdHJ1Y3RJbmZvRnJvbVN0YWNrKHN0YWNrKTtcblxuICAgIGNvbnN0IGZxbnMgPSBjb25zdHJ1Y3RJbmZvcy5tYXAoaW5mbyA9PiBpbmZvLmZxbik7XG4gICAgZXhwZWN0KGZxbnMpLnRvQ29udGFpbignQGF3cy1jZGsvdGVzdC5UZXN0Q29uc3RydWN0Jyk7XG4gICAgZXhwZWN0KGZxbnMpLm5vdC50b0NvbnRhaW4oJ0Bhd3MtY2RrL3Rlc3QuVGVzdFN0YWNrSW5zaWRlU3RhY2snKTtcbiAgICBleHBlY3QoZnFucykubm90LnRvQ29udGFpbignQGF3cy1jZGsvdGVzdC5UZXN0TmVzdGVkU3RhY2tJbnNpZGVTdGFjaycpO1xuICAgIGV4cGVjdChmcW5zKS5ub3QudG9Db250YWluKCdAYXdzLWNkay90ZXN0LlRlc3RTdGFnZUluc2lkZVN0YWNrJyk7XG4gIH0pO1xufSk7XG5cbmNsYXNzIFRlc3RDb25zdHJ1Y3QgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAvLyBAdHMtaWdub3JlXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFtKU0lJX1JVTlRJTUVfU1lNQk9MXSA9IHsgZnFuOiAnQGF3cy1jZGsvdGVzdC5UZXN0Q29uc3RydWN0JywgdmVyc2lvbjogbG9jYWxDZGtWZXJzaW9uKCkgfVxufVxuXG4vKipcbiAqIFRoZSBleGFjdCB2YWx1ZXMgd2UgZXhwZWN0IGZyb20gdGVzdGluZyBhZ2FpbnN0IHZlcnNpb24gbnVtYmVycyBpbiB0aGlzIHN1aXRlIGRlcGVuZCBvbiB3aGV0aGVyIHdlJ3JlIHJ1bm5pbmdcbiAqIG9uIGEgZGV2ZWxvcG1lbnQgb3IgcmVsZWFzZSBicmFuY2guIFJldHVybnMgdGhlIGxvY2FsIHBhY2thZ2UuanNvbiB2ZXJzaW9uLCB3aGljaCB3aWxsIGJlICcwLjAuMCcgdW5sZXNzIHdlJ3JlXG4gKiBvbiBhIHJlbGVhc2UgYnJhbmNoLCBpbiB3aGljaCBjYXNlIGl0IHNob3VsZCBiZSB0aGUgcmVhbCB2ZXJzaW9uIG51bWJlcnMgKGUuZy4sIDEuOTEuMCkuXG4gKi9cbmZ1bmN0aW9uIGxvY2FsQ2RrVmVyc2lvbigpOiBzdHJpbmcge1xuICBpZiAoIV9jZGtWZXJzaW9uKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHNcbiAgICBjb25zdCBwa2dKc29uID0gZmluZFBhcmVudFBrZ0pzb24oX19kaXJuYW1lKTtcbiAgICBfY2RrVmVyc2lvbiA9IHBrZ0pzb24udmVyc2lvbjtcbiAgICBpZiAoIV9jZGtWZXJzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBkZXRlcm1pbmUgQ0RLIHZlcnNpb24nKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIF9jZGtWZXJzaW9uO1xufVxuXG5mdW5jdGlvbiBmaW5kUGFyZW50UGtnSnNvbihkaXI6IHN0cmluZywgZGVwdGg6IG51bWJlciA9IDEsIGxpbWl0OiBudW1iZXIgPSA1KTogeyB2ZXJzaW9uOiBzdHJpbmc7IH0ge1xuICBjb25zdCB0YXJnZXQgPSBwYXRoLmpvaW4oZGlyLCAncGFja2FnZS5qc29uJyk7XG4gIGlmIChmcy5leGlzdHNTeW5jKHRhcmdldCkpIHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmModGFyZ2V0LCAndXRmOCcpKTtcbiAgfSBlbHNlIGlmIChkZXB0aCA8IGxpbWl0KSB7XG4gICAgcmV0dXJuIGZpbmRQYXJlbnRQa2dKc29uKHBhdGguam9pbihkaXIsICcuLicpLCBkZXB0aCArIDEsIGxpbWl0KTtcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcihgTm8gXFxgcGFja2FnZS5qc29uXFxgIGZpbGUgZm91bmQgd2l0aGluICR7ZGVwdGh9IHBhcmVudCBkaXJlY3Rvcmllc2ApO1xufVxuIl19