"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const lib_1 = require("../lib");
describe('secret value', () => {
    (0, cdk_build_tools_1.testDeprecated)('plainText', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.plainText('this just resolves to a string');
        // THEN
        expect(stack.resolve(v)).toEqual('this just resolves to a string');
    });
    test('unsafePlainText', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.unsafePlainText('this just resolves to a string');
        // THEN
        expect(stack.resolve(v)).toEqual('this just resolves to a string');
    });
    test('isSecretValue returns true', () => {
        const v = lib_1.SecretValue.unsafePlainText('this just resolves to a string');
        // THEN
        expect(lib_1.SecretValue.isSecretValue(v)).toEqual(true);
    });
    test('secret resolution fails if feature flag is switched on, secret can be unwrapped', () => {
        const app = new lib_1.App({
            context: { '@aws-cdk/core:checkSecretUsage': true },
        });
        const stack = new lib_1.Stack(app, 'Stack');
        // WHEN
        const v = lib_1.SecretValue.unsafePlainText('s3cr3t');
        // THEN
        expect(() => stack.resolve(v)).toThrow(/Using a SecretValue here risks exposing your secret/);
        // THEN
        expect(stack.resolve(v.unsafeUnwrap())).toEqual('s3cr3t');
    });
    test('secretsManager', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager('secret-id', {
            jsonField: 'json-key',
            versionStage: 'version-stage',
        });
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:secretsmanager:secret-id:SecretString:json-key:version-stage:}}');
    });
    test('secretsManager with secret-id from token', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager(lib_1.Token.asString({ Ref: 'secret-id' }), {
            jsonField: 'json-key',
            versionStage: 'version-stage',
        });
        // THEN
        expect(stack.resolve(v)).toEqual({
            'Fn::Join': [
                '',
                [
                    '{{resolve:secretsmanager:',
                    { Ref: 'secret-id' },
                    ':SecretString:json-key:version-stage:}}',
                ],
            ],
        });
    });
    test('secretsManager with defaults', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager('secret-id');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:secretsmanager:secret-id:SecretString:::}}');
    });
    test('secretsManager with defaults, secret-id from token', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.secretsManager(lib_1.Token.asString({ Ref: 'secret-id' }));
        // THEN
        expect(stack.resolve(v)).toEqual({
            'Fn::Join': [
                '',
                [
                    '{{resolve:secretsmanager:',
                    { Ref: 'secret-id' },
                    ':SecretString:::}}',
                ],
            ],
        });
    });
    test('secretsManager with an empty ID', () => {
        expect(() => lib_1.SecretValue.secretsManager('')).toThrow(/secretId cannot be empty/);
    });
    test('secretsManager with versionStage and versionId', () => {
        expect(() => {
            lib_1.SecretValue.secretsManager('secret-id', {
                versionStage: 'version-stage',
                versionId: 'version-id',
            });
        }).toThrow(/were both provided but only one is allowed/);
    });
    test('secretsManager with a non-ARN ID that has colon', () => {
        expect(() => lib_1.SecretValue.secretsManager('not:an:arn')).toThrow(/is not an ARN but contains ":"/);
    });
    test('ssmSecure', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.ssmSecure('param-name', 'param-version');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm-secure:param-name:param-version}}');
    });
    test('ssmSecure without version', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.ssmSecure('param-name');
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm-secure:param-name}}');
    });
    test('cfnDynamicReference', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        // WHEN
        const v = lib_1.SecretValue.cfnDynamicReference(new lib_1.CfnDynamicReference(lib_1.CfnDynamicReferenceService.SSM, 'foo:bar'));
        // THEN
        expect(stack.resolve(v)).toEqual('{{resolve:ssm:foo:bar}}');
    });
    test('cfnParameter (with NoEcho)', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        const p = new lib_1.CfnParameter(stack, 'MyParam', { type: 'String', noEcho: true });
        // WHEN
        const v = lib_1.SecretValue.cfnParameter(p);
        // THEN
        expect(stack.resolve(v)).toEqual({ Ref: 'MyParam' });
    });
    test('fails if cfnParameter does not have NoEcho', () => {
        // GIVEN
        const stack = new lib_1.Stack();
        const p = new lib_1.CfnParameter(stack, 'MyParam', { type: 'String' });
        // THEN
        expect(() => lib_1.SecretValue.cfnParameter(p)).toThrow(/CloudFormation parameter must be configured with "NoEcho"/);
    });
    test('resourceAttribute does not work on literal', () => {
        expect(() => lib_1.SecretValue.resourceAttribute('xyz')).toThrow(/must be used with/);
    });
    test('resourceAttribute does not work on plain ref', () => {
        const stack = new lib_1.Stack();
        const param = new lib_1.CfnParameter(stack, 'Param');
        expect(() => lib_1.SecretValue.resourceAttribute(param.valueAsString)).toThrow(/must be used with/);
    });
    test('resourceAttribute works on actual resource attribute', () => {
        const stack = new lib_1.Stack();
        const res = new lib_1.CfnResource(stack, 'Resource', {
            type: 'AWS::My::Resource',
        });
        expect(stack.resolve(lib_1.SecretValue.resourceAttribute(res.ref))).toEqual({ Ref: 'Resource' });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjcmV0LXZhbHVlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZWNyZXQtdmFsdWUudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhEQUEwRDtBQUMxRCxnQ0FBb0k7QUFFcEksUUFBUSxDQUFDLGNBQWMsRUFBRSxHQUFHLEVBQUU7SUFDNUIsSUFBQSxnQ0FBYyxFQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7UUFDL0IsUUFBUTtRQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksV0FBSyxFQUFFLENBQUM7UUFFMUIsT0FBTztRQUNQLE1BQU0sQ0FBQyxHQUFHLGlCQUFXLENBQUMsU0FBUyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFFbEUsT0FBTztRQUNQLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDckUsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQzNCLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLFdBQUssRUFBRSxDQUFDO1FBRTFCLE9BQU87UUFDUCxNQUFNLENBQUMsR0FBRyxpQkFBVyxDQUFDLGVBQWUsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRXhFLE9BQU87UUFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQ3JFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtRQUN0QyxNQUFNLENBQUMsR0FBRyxpQkFBVyxDQUFDLGVBQWUsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1FBRXhFLE9BQU87UUFDUCxNQUFNLENBQUMsaUJBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMs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LENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUNoRyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxzREFBc0QsRUFBRSxHQUFHLEVBQUU7UUFDaEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxXQUFLLEVBQUUsQ0FBQztRQUMxQixNQUFNLEdBQUcsR0FBRyxJQUFJLGlCQUFXLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRTtZQUM3QyxJQUFJLEVBQUUsbUJBQW1CO1NBQzFCLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGlCQUFXLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUM3RixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdGVzdERlcHJlY2F0ZWQgfSBmcm9tICdAYXdzLWNkay9jZGstYnVpbGQtdG9vbHMnO1xuaW1wb3J0IHsgQ2ZuRHluYW1pY1JlZmVyZW5jZSwgQ2ZuRHluYW1pY1JlZmVyZW5jZVNlcnZpY2UsIENmblBhcmFtZXRlciwgU2VjcmV0VmFsdWUsIFN0YWNrLCBUb2tlbiwgQXBwLCBDZm5SZXNvdXJjZSB9IGZyb20gJy4uL2xpYic7XG5cbmRlc2NyaWJlKCdzZWNyZXQgdmFsdWUnLCAoKSA9PiB7XG4gIHRlc3REZXByZWNhdGVkKCdwbGFpblRleHQnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5wbGFpblRleHQoJ3RoaXMganVzdCByZXNvbHZlcyB0byBhIHN0cmluZycpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKCd0aGlzIGp1c3QgcmVzb2x2ZXMgdG8gYSBzdHJpbmcnKTtcbiAgfSk7XG5cbiAgdGVzdCgndW5zYWZlUGxhaW5UZXh0JywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCB2ID0gU2VjcmV0VmFsdWUudW5zYWZlUGxhaW5UZXh0KCd0aGlzIGp1c3QgcmVzb2x2ZXMgdG8gYSBzdHJpbmcnKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2KSkudG9FcXVhbCgndGhpcyBqdXN0IHJlc29sdmVzIHRvIGEgc3RyaW5nJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2lzU2VjcmV0VmFsdWUgcmV0dXJucyB0cnVlJywgKCkgPT4ge1xuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS51bnNhZmVQbGFpblRleHQoJ3RoaXMganVzdCByZXNvbHZlcyB0byBhIHN0cmluZycpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChTZWNyZXRWYWx1ZS5pc1NlY3JldFZhbHVlKHYpKS50b0VxdWFsKHRydWUpO1xuICB9KTtcblxuICB0ZXN0KCdzZWNyZXQgcmVzb2x1dGlvbiBmYWlscyBpZiBmZWF0dXJlIGZsYWcgaXMgc3dpdGNoZWQgb24sIHNlY3JldCBjYW4gYmUgdW53cmFwcGVkJywgKCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IG5ldyBBcHAoe1xuICAgICAgY29udGV4dDogeyAnQGF3cy1jZGsvY29yZTpjaGVja1NlY3JldFVzYWdlJzogdHJ1ZSB9LFxuICAgIH0pO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrJyk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdiA9IFNlY3JldFZhbHVlLnVuc2FmZVBsYWluVGV4dCgnczNjcjN0Jyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IHN0YWNrLnJlc29sdmUodikpLnRvVGhyb3coL1VzaW5nIGEgU2VjcmV0VmFsdWUgaGVyZSByaXNrcyBleHBvc2luZyB5b3VyIHNlY3JldC8pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYudW5zYWZlVW53cmFwKCkpKS50b0VxdWFsKCdzM2NyM3QnKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXInLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignc2VjcmV0LWlkJywge1xuICAgICAganNvbkZpZWxkOiAnanNvbi1rZXknLFxuICAgICAgdmVyc2lvblN0YWdlOiAndmVyc2lvbi1zdGFnZScsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3t7cmVzb2x2ZTpzZWNyZXRzbWFuYWdlcjpzZWNyZXQtaWQ6U2VjcmV0U3RyaW5nOmpzb24ta2V5OnZlcnNpb24tc3RhZ2U6fX0nKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXIgd2l0aCBzZWNyZXQtaWQgZnJvbSB0b2tlbicsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdiA9IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKFRva2VuLmFzU3RyaW5nKHsgUmVmOiAnc2VjcmV0LWlkJyB9KSwge1xuICAgICAganNvbkZpZWxkOiAnanNvbi1rZXknLFxuICAgICAgdmVyc2lvblN0YWdlOiAndmVyc2lvbi1zdGFnZScsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoe1xuICAgICAgJ0ZuOjpKb2luJzogW1xuICAgICAgICAnJyxcbiAgICAgICAgW1xuICAgICAgICAgICd7e3Jlc29sdmU6c2VjcmV0c21hbmFnZXI6JyxcbiAgICAgICAgICB7IFJlZjogJ3NlY3JldC1pZCcgfSxcbiAgICAgICAgICAnOlNlY3JldFN0cmluZzpqc29uLWtleTp2ZXJzaW9uLXN0YWdlOn19JyxcbiAgICAgICAgXSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NlY3JldHNNYW5hZ2VyIHdpdGggZGVmYXVsdHMnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignc2VjcmV0LWlkJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3t7cmVzb2x2ZTpzZWNyZXRzbWFuYWdlcjpzZWNyZXQtaWQ6U2VjcmV0U3RyaW5nOjo6fX0nKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXIgd2l0aCBkZWZhdWx0cywgc2VjcmV0LWlkIGZyb20gdG9rZW4nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcihUb2tlbi5hc1N0cmluZyh7IFJlZjogJ3NlY3JldC1pZCcgfSkpO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjay5yZXNvbHZlKHYpKS50b0VxdWFsKHtcbiAgICAgICdGbjo6Sm9pbic6IFtcbiAgICAgICAgJycsXG4gICAgICAgIFtcbiAgICAgICAgICAne3tyZXNvbHZlOnNlY3JldHNtYW5hZ2VyOicsXG4gICAgICAgICAgeyBSZWY6ICdzZWNyZXQtaWQnIH0sXG4gICAgICAgICAgJzpTZWNyZXRTdHJpbmc6Ojp9fScsXG4gICAgICAgIF0sXG4gICAgICBdLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdzZWNyZXRzTWFuYWdlciB3aXRoIGFuIGVtcHR5IElEJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignJykpLnRvVGhyb3coL3NlY3JldElkIGNhbm5vdCBiZSBlbXB0eS8pO1xuICB9KTtcblxuICB0ZXN0KCdzZWNyZXRzTWFuYWdlciB3aXRoIHZlcnNpb25TdGFnZSBhbmQgdmVyc2lvbklkJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBTZWNyZXRWYWx1ZS5zZWNyZXRzTWFuYWdlcignc2VjcmV0LWlkJyxcbiAgICAgICAge1xuICAgICAgICAgIHZlcnNpb25TdGFnZTogJ3ZlcnNpb24tc3RhZ2UnLFxuICAgICAgICAgIHZlcnNpb25JZDogJ3ZlcnNpb24taWQnLFxuICAgICAgICB9KTtcbiAgICB9KS50b1Rocm93KC93ZXJlIGJvdGggcHJvdmlkZWQgYnV0IG9ubHkgb25lIGlzIGFsbG93ZWQvKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2VjcmV0c01hbmFnZXIgd2l0aCBhIG5vbi1BUk4gSUQgdGhhdCBoYXMgY29sb24nLCAoKSA9PiB7XG4gICAgZXhwZWN0KCgpID0+IFNlY3JldFZhbHVlLnNlY3JldHNNYW5hZ2VyKCdub3Q6YW46YXJuJykpLnRvVGhyb3coL2lzIG5vdCBhbiBBUk4gYnV0IGNvbnRhaW5zIFwiOlwiLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NzbVNlY3VyZScsICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdiA9IFNlY3JldFZhbHVlLnNzbVNlY3VyZSgncGFyYW0tbmFtZScsICdwYXJhbS12ZXJzaW9uJyk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3t7cmVzb2x2ZTpzc20tc2VjdXJlOnBhcmFtLW5hbWU6cGFyYW0tdmVyc2lvbn19Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3NzbVNlY3VyZSB3aXRob3V0IHZlcnNpb24nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5zc21TZWN1cmUoJ3BhcmFtLW5hbWUnKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2KSkudG9FcXVhbCgne3tyZXNvbHZlOnNzbS1zZWN1cmU6cGFyYW0tbmFtZX19Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NmbkR5bmFtaWNSZWZlcmVuY2UnLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHYgPSBTZWNyZXRWYWx1ZS5jZm5EeW5hbWljUmVmZXJlbmNlKG5ldyBDZm5EeW5hbWljUmVmZXJlbmNlKENmbkR5bmFtaWNSZWZlcmVuY2VTZXJ2aWNlLlNTTSwgJ2ZvbzpiYXInKSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUodikpLnRvRXF1YWwoJ3t7cmVzb2x2ZTpzc206Zm9vOmJhcn19Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ2NmblBhcmFtZXRlciAod2l0aCBOb0VjaG8pJywgKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBjb25zdCBwID0gbmV3IENmblBhcmFtZXRlcihzdGFjaywgJ015UGFyYW0nLCB7IHR5cGU6ICdTdHJpbmcnLCBub0VjaG86IHRydWUgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgdiA9IFNlY3JldFZhbHVlLmNmblBhcmFtZXRlcihwKTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3Qoc3RhY2sucmVzb2x2ZSh2KSkudG9FcXVhbCh7IFJlZjogJ015UGFyYW0nIH0pO1xuICB9KTtcblxuICB0ZXN0KCdmYWlscyBpZiBjZm5QYXJhbWV0ZXIgZG9lcyBub3QgaGF2ZSBOb0VjaG8nLCAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICAgIGNvbnN0IHAgPSBuZXcgQ2ZuUGFyYW1ldGVyKHN0YWNrLCAnTXlQYXJhbScsIHsgdHlwZTogJ1N0cmluZycgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KCgpID0+IFNlY3JldFZhbHVlLmNmblBhcmFtZXRlcihwKSkudG9UaHJvdygvQ2xvdWRGb3JtYXRpb24gcGFyYW1ldGVyIG11c3QgYmUgY29uZmlndXJlZCB3aXRoIFwiTm9FY2hvXCIvKTtcbiAgfSk7XG5cbiAgdGVzdCgncmVzb3VyY2VBdHRyaWJ1dGUgZG9lcyBub3Qgd29yayBvbiBsaXRlcmFsJywgKCkgPT4ge1xuICAgIGV4cGVjdCgoKSA9PiBTZWNyZXRWYWx1ZS5yZXNvdXJjZUF0dHJpYnV0ZSgneHl6JykpLnRvVGhyb3coL211c3QgYmUgdXNlZCB3aXRoLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Jlc291cmNlQXR0cmlidXRlIGRvZXMgbm90IHdvcmsgb24gcGxhaW4gcmVmJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gICAgY29uc3QgcGFyYW0gPSBuZXcgQ2ZuUGFyYW1ldGVyKHN0YWNrLCAnUGFyYW0nKTtcbiAgICBleHBlY3QoKCkgPT4gU2VjcmV0VmFsdWUucmVzb3VyY2VBdHRyaWJ1dGUocGFyYW0udmFsdWVBc1N0cmluZykpLnRvVGhyb3coL211c3QgYmUgdXNlZCB3aXRoLyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Jlc291cmNlQXR0cmlidXRlIHdvcmtzIG9uIGFjdHVhbCByZXNvdXJjZSBhdHRyaWJ1dGUnLCAoKSA9PiB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgICBjb25zdCByZXMgPSBuZXcgQ2ZuUmVzb3VyY2Uoc3RhY2ssICdSZXNvdXJjZScsIHtcbiAgICAgIHR5cGU6ICdBV1M6Ok15OjpSZXNvdXJjZScsXG4gICAgfSk7XG4gICAgZXhwZWN0KHN0YWNrLnJlc29sdmUoU2VjcmV0VmFsdWUucmVzb3VyY2VBdHRyaWJ1dGUocmVzLnJlZikpKS50b0VxdWFsKHsgUmVmOiAnUmVzb3VyY2UnIH0pO1xuICB9KTtcbn0pO1xuIl19