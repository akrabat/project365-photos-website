"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const core_1 = require("../../../core");
const javascript_1 = require("../../lib/private/javascript");
const testhelpers_1 = require("../testhelpers");
let legacyApp;
let modernApp;
let legacyPipelineStack;
let modernPipelineStack;
(0, cdk_build_tools_1.describeDeprecated)('logical id stability', () => {
    // this test suite verifies logical id between the new and old (deprecated) APIs.
    // so it must be in a 'describeDeprecated' block
    beforeEach(() => {
        legacyApp = new testhelpers_1.TestApp({
            context: {
                '@aws-cdk/core:newStyleStackSynthesis': '1',
                'aws:cdk:enable-path-metadata': true,
            },
        });
        modernApp = new testhelpers_1.TestApp({
            context: {
                '@aws-cdk/core:newStyleStackSynthesis': '1',
                'aws:cdk:enable-path-metadata': true,
            },
        });
        legacyPipelineStack = new core_1.Stack(legacyApp, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
        modernPipelineStack = new core_1.Stack(modernApp, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
    });
    afterEach(() => {
        legacyApp.cleanup();
        modernApp.cleanup();
    });
    test('stateful or nameable resources have the same logicalID between old and new API', () => {
        const legacyPipe = new testhelpers_1.LegacyTestGitHubNpmPipeline(legacyPipelineStack, 'Cdk');
        legacyPipe.addApplicationStage(new testhelpers_1.MegaAssetsApp(legacyPipelineStack, 'MyApp', {
            numAssets: 2,
        }));
        const modernPipe = new testhelpers_1.ModernTestGitHubNpmPipeline(modernPipelineStack, 'Cdk', {
            crossAccountKeys: true,
        });
        modernPipe.addStage(new testhelpers_1.MegaAssetsApp(modernPipelineStack, 'MyApp', {
            numAssets: 2,
        }));
        const legacyTemplate = (0, testhelpers_1.stackTemplate)(legacyPipelineStack).template;
        const modernTemplate = (0, testhelpers_1.stackTemplate)(modernPipelineStack).template;
        const legacyStateful = filterR(legacyTemplate.Resources, isStateful);
        const modernStateful = filterR(modernTemplate.Resources, isStateful);
        expect(mapR(modernStateful, typeOfRes)).toEqual(mapR(legacyStateful, typeOfRes));
    });
    test('nameable resources have the same names between old and new API', () => {
        const legacyPipe = new testhelpers_1.LegacyTestGitHubNpmPipeline(legacyPipelineStack, 'Cdk', {
            pipelineName: 'asdf',
        });
        legacyPipe.addApplicationStage(new testhelpers_1.MegaAssetsApp(legacyPipelineStack, 'MyApp', {
            numAssets: 2,
        }));
        const modernPipe = new testhelpers_1.ModernTestGitHubNpmPipeline(modernPipelineStack, 'Cdk', {
            pipelineName: 'asdf',
            crossAccountKeys: true,
        });
        modernPipe.addStage(new testhelpers_1.MegaAssetsApp(modernPipelineStack, 'MyApp', {
            numAssets: 2,
        }));
        const legacyTemplate = (0, testhelpers_1.stackTemplate)(legacyPipelineStack).template;
        const modernTemplate = (0, testhelpers_1.stackTemplate)(modernPipelineStack).template;
        const legacyNamed = filterR(legacyTemplate.Resources, hasName);
        const modernNamed = filterR(modernTemplate.Resources, hasName);
        expect(mapR(modernNamed, nameProps)).toEqual(mapR(legacyNamed, nameProps));
    });
});
const STATEFUL_TYPES = [
    // Holds state
    'AWS::S3::Bucket',
    'AWS::KMS::Key',
    'AWS::KMS::Alias',
    // Can be physical-named so will be impossible to replace
    'AWS::CodePipeline::Pipeline',
    'AWS::CodeBuild::Project',
];
function filterR(resources, fn) {
    return (0, javascript_1.mkdict)(Object.entries(resources).filter(([, resource]) => fn(resource)));
}
function mapR(resources, fn) {
    return (0, javascript_1.mkdict)(Object.entries(resources).map(([lid, resource]) => [lid, fn(resource)]));
}
function typeOfRes(r) {
    return r.Type;
}
function isStateful(r) {
    return STATEFUL_TYPES.includes(r.Type);
}
function nameProps(r) {
    return Object.entries(r.Properties).filter(([prop, _]) => 
    // Don't care about policy names
    prop.endsWith('Name') && prop !== 'PolicyName');
}
function hasName(r) {
    return nameProps(r).length > 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naWNhbGlkLXN0YWJpbGl0eS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibG9naWNhbGlkLXN0YWJpbGl0eS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOERBQThEO0FBQzlELHdDQUFzQztBQUN0Qyw2REFBc0Q7QUFDdEQsZ0RBQStJO0FBRS9JLElBQUksU0FBa0IsQ0FBQztBQUN2QixJQUFJLFNBQWtCLENBQUM7QUFFdkIsSUFBSSxtQkFBMEIsQ0FBQztBQUMvQixJQUFJLG1CQUEwQixDQUFDO0FBRS9CLElBQUEsb0NBQWtCLEVBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQzlDLGlGQUFpRjtJQUNqRixnREFBZ0Q7SUFFaEQsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFNBQVMsR0FBRyxJQUFJLHFCQUFPLENBQUM7WUFDdEIsT0FBTyxFQUFFO2dCQUNQLHNDQUFzQyxFQUFFLEdBQUc7Z0JBQzNDLDhCQUE4QixFQUFFLElBQUk7YUFDckM7U0FDRixDQUFDLENBQUM7UUFDSCxTQUFTLEdBQUcsSUFBSSxxQkFBTyxDQUFDO1lBQ3RCLE9BQU8sRUFBRTtnQkFDUCxzQ0FBc0MsRUFBRSxHQUFHO2dCQUMzQyw4QkFBOEIsRUFBRSxJQUFJO2FBQ3JDO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsbUJBQW1CLEdBQUcsSUFBSSxZQUFLLENBQUMsU0FBUyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSwwQkFBWSxFQUFFLENBQUMsQ0FBQztRQUNuRixtQkFBbUIsR0FBRyxJQUFJLFlBQUssQ0FBQyxTQUFTLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLDBCQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3JGLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNwQixTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdEIsQ0FBQyxDQUFD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dCB7IGRlc2NyaWJlRGVwcmVjYXRlZCB9IGZyb20gJ0Bhd3MtY2RrL2Nkay1idWlsZC10b29scyc7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgbWtkaWN0IH0gZnJvbSAnLi4vLi4vbGliL3ByaXZhdGUvamF2YXNjcmlwdCc7XG5pbXBvcnQgeyBQSVBFTElORV9FTlYsIFRlc3RBcHAsIExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZSwgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lLCBNZWdhQXNzZXRzQXBwLCBzdGFja1RlbXBsYXRlIH0gZnJvbSAnLi4vdGVzdGhlbHBlcnMnO1xuXG5sZXQgbGVnYWN5QXBwOiBUZXN0QXBwO1xubGV0IG1vZGVybkFwcDogVGVzdEFwcDtcblxubGV0IGxlZ2FjeVBpcGVsaW5lU3RhY2s6IFN0YWNrO1xubGV0IG1vZGVyblBpcGVsaW5lU3RhY2s6IFN0YWNrO1xuXG5kZXNjcmliZURlcHJlY2F0ZWQoJ2xvZ2ljYWwgaWQgc3RhYmlsaXR5JywgKCkgPT4ge1xuICAvLyB0aGlzIHRlc3Qgc3VpdGUgdmVyaWZpZXMgbG9naWNhbCBpZCBiZXR3ZWVuIHRoZSBuZXcgYW5kIG9sZCAoZGVwcmVjYXRlZCkgQVBJcy5cbiAgLy8gc28gaXQgbXVzdCBiZSBpbiBhICdkZXNjcmliZURlcHJlY2F0ZWQnIGJsb2NrXG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbGVnYWN5QXBwID0gbmV3IFRlc3RBcHAoe1xuICAgICAgY29udGV4dDoge1xuICAgICAgICAnQGF3cy1jZGsvY29yZTpuZXdTdHlsZVN0YWNrU3ludGhlc2lzJzogJzEnLFxuICAgICAgICAnYXdzOmNkazplbmFibGUtcGF0aC1tZXRhZGF0YSc6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICAgIG1vZGVybkFwcCA9IG5ldyBUZXN0QXBwKHtcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgJ0Bhd3MtY2RrL2NvcmU6bmV3U3R5bGVTdGFja1N5bnRoZXNpcyc6ICcxJyxcbiAgICAgICAgJ2F3czpjZGs6ZW5hYmxlLXBhdGgtbWV0YWRhdGEnOiB0cnVlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBsZWdhY3lQaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKGxlZ2FjeUFwcCwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xuICAgIG1vZGVyblBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2sobW9kZXJuQXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgbGVnYWN5QXBwLmNsZWFudXAoKTtcbiAgICBtb2Rlcm5BcHAuY2xlYW51cCgpO1xuICB9KTtcblxuICB0ZXN0KCdzdGF0ZWZ1bCBvciBuYW1lYWJsZSByZXNvdXJjZXMgaGF2ZSB0aGUgc2FtZSBsb2dpY2FsSUQgYmV0d2VlbiBvbGQgYW5kIG5ldyBBUEknLCAoKSA9PiB7XG4gICAgY29uc3QgbGVnYWN5UGlwZSA9IG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUobGVnYWN5UGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIGxlZ2FjeVBpcGUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgTWVnYUFzc2V0c0FwcChsZWdhY3lQaXBlbGluZVN0YWNrLCAnTXlBcHAnLCB7XG4gICAgICBudW1Bc3NldHM6IDIsXG4gICAgfSkpO1xuXG4gICAgY29uc3QgbW9kZXJuUGlwZSA9IG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUobW9kZXJuUGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgIGNyb3NzQWNjb3VudEtleXM6IHRydWUsXG4gICAgfSk7XG4gICAgbW9kZXJuUGlwZS5hZGRTdGFnZShuZXcgTWVnYUFzc2V0c0FwcChtb2Rlcm5QaXBlbGluZVN0YWNrLCAnTXlBcHAnLCB7XG4gICAgICBudW1Bc3NldHM6IDIsXG4gICAgfSkpO1xuXG4gICAgY29uc3QgbGVnYWN5VGVtcGxhdGUgPSBzdGFja1RlbXBsYXRlKGxlZ2FjeVBpcGVsaW5lU3RhY2spLnRlbXBsYXRlO1xuICAgIGNvbnN0IG1vZGVyblRlbXBsYXRlID0gc3RhY2tUZW1wbGF0ZShtb2Rlcm5QaXBlbGluZVN0YWNrKS50ZW1wbGF0ZTtcblxuICAgIGNvbnN0IGxlZ2FjeVN0YXRlZnVsID0gZmlsdGVyUihsZWdhY3lUZW1wbGF0ZS5SZXNvdXJjZXMsIGlzU3RhdGVmdWwpO1xuICAgIGNvbnN0IG1vZGVyblN0YXRlZnVsID0gZmlsdGVyUihtb2Rlcm5UZW1wbGF0ZS5SZXNvdXJjZXMsIGlzU3RhdGVmdWwpO1xuXG4gICAgZXhwZWN0KG1hcFIobW9kZXJuU3RhdGVmdWwsIHR5cGVPZlJlcykpLnRvRXF1YWwobWFwUihsZWdhY3lTdGF0ZWZ1bCwgdHlwZU9mUmVzKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ25hbWVhYmxlIHJlc291cmNlcyBoYXZlIHRoZSBzYW1lIG5hbWVzIGJldHdlZW4gb2xkIGFuZCBuZXcgQVBJJywgKCkgPT4ge1xuICAgIGNvbnN0IGxlZ2FjeVBpcGUgPSBuZXcgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lKGxlZ2FjeVBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgICBwaXBlbGluZU5hbWU6ICdhc2RmJyxcbiAgICB9KTtcbiAgICBsZWdhY3lQaXBlLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IE1lZ2FBc3NldHNBcHAobGVnYWN5UGlwZWxpbmVTdGFjaywgJ015QXBwJywge1xuICAgICAgbnVtQXNzZXRzOiAyLFxuICAgIH0pKTtcblxuICAgIGNvbnN0IG1vZGVyblBpcGUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKG1vZGVyblBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgICBwaXBlbGluZU5hbWU6ICdhc2RmJyxcbiAgICAgIGNyb3NzQWNjb3VudEtleXM6IHRydWUsXG4gICAgfSk7XG4gICAgbW9kZXJuUGlwZS5hZGRTdGFnZShuZXcgTWVnYUFzc2V0c0FwcChtb2Rlcm5QaXBlbGluZVN0YWNrLCAnTXlBcHAnLCB7XG4gICAgICBudW1Bc3NldHM6IDIsXG4gICAgfSkpO1xuXG4gICAgY29uc3QgbGVnYWN5VGVtcGxhdGUgPSBzdGFja1RlbXBsYXRlKGxlZ2FjeVBpcGVsaW5lU3RhY2spLnRlbXBsYXRlO1xuICAgIGNvbnN0IG1vZGVyblRlbXBsYXRlID0gc3RhY2tUZW1wbGF0ZShtb2Rlcm5QaXBlbGluZVN0YWNrKS50ZW1wbGF0ZTtcblxuICAgIGNvbnN0IGxlZ2FjeU5hbWVkID0gZmlsdGVyUihsZWdhY3lUZW1wbGF0ZS5SZXNvdXJjZXMsIGhhc05hbWUpO1xuICAgIGNvbnN0IG1vZGVybk5hbWVkID0gZmlsdGVyUihtb2Rlcm5UZW1wbGF0ZS5SZXNvdXJjZXMsIGhhc05hbWUpO1xuXG4gICAgZXhwZWN0KG1hcFIobW9kZXJuTmFtZWQsIG5hbWVQcm9wcykpLnRvRXF1YWwobWFwUihsZWdhY3lOYW1lZCwgbmFtZVByb3BzKSk7XG4gIH0pO1xufSk7XG5cblxuY29uc3QgU1RBVEVGVUxfVFlQRVMgPSBbXG4gIC8vIEhvbGRzIHN0YXRlXG4gICdBV1M6OlMzOjpCdWNrZXQnLFxuICAnQVdTOjpLTVM6OktleScsXG4gICdBV1M6OktNUzo6QWxpYXMnLFxuICAvLyBDYW4gYmUgcGh5c2ljYWwtbmFtZWQgc28gd2lsbCBiZSBpbXBvc3NpYmxlIHRvIHJlcGxhY2VcbiAgJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsXG4gICdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsXG5dO1xuXG5mdW5jdGlvbiBmaWx0ZXJSKHJlc291cmNlczogUmVjb3JkPHN0cmluZywgUmVzb3VyY2U+LCBmbjogKHg6IFJlc291cmNlKSA9PiBib29sZWFuKTogUmVjb3JkPHN0cmluZywgUmVzb3VyY2U+IHtcbiAgcmV0dXJuIG1rZGljdChPYmplY3QuZW50cmllcyhyZXNvdXJjZXMpLmZpbHRlcigoWywgcmVzb3VyY2VdKSA9PiBmbihyZXNvdXJjZSkpKTtcbn1cblxuZnVuY3Rpb24gbWFwUjxBPihyZXNvdXJjZXM6IFJlY29yZDxzdHJpbmcsIFJlc291cmNlPiwgZm46ICh4OiBSZXNvdXJjZSkgPT4gQSk6IFJlY29yZDxzdHJpbmcsIEE+IHtcbiAgcmV0dXJuIG1rZGljdChPYmplY3QuZW50cmllcyhyZXNvdXJjZXMpLm1hcCgoW2xpZCwgcmVzb3VyY2VdKSA9PiBbbGlkLCBmbihyZXNvdXJjZSldIGFzIGNvbnN0KSk7XG59XG5cbmZ1bmN0aW9uIHR5cGVPZlJlcyhyOiBSZXNvdXJjZSkge1xuICByZXR1cm4gci5UeXBlO1xufVxuXG5mdW5jdGlvbiBpc1N0YXRlZnVsKHI6IFJlc291cmNlKSB7XG4gIHJldHVybiBTVEFURUZVTF9UWVBFUy5pbmNsdWRlcyhyLlR5cGUpO1xufVxuXG5mdW5jdGlvbiBuYW1lUHJvcHMocjogUmVzb3VyY2UpIHtcbiAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHIuUHJvcGVydGllcykuZmlsdGVyKChbcHJvcCwgX10pID0+XG4gICAgLy8gRG9uJ3QgY2FyZSBhYm91dCBwb2xpY3kgbmFtZXNcbiAgICBwcm9wLmVuZHNXaXRoKCdOYW1lJykgJiYgcHJvcCAhPT0gJ1BvbGljeU5hbWUnKTtcbn1cblxuZnVuY3Rpb24gaGFzTmFtZShyOiBSZXNvdXJjZSkge1xuICByZXR1cm4gbmFtZVByb3BzKHIpLmxlbmd0aCA+IDA7XG59XG5cbmludGVyZmFjZSBSZXNvdXJjZSB7XG4gIHJlYWRvbmx5IFR5cGU6IHN0cmluZztcbiAgcmVhZG9ubHkgUHJvcGVydGllczogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgcmVhZG9ubHkgTWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufSJdfQ==