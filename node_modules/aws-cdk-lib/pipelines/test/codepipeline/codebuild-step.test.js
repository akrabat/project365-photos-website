"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const codebuild = require("../../../aws-codebuild");
const iam = require("../../../aws-iam");
const s3 = require("../../../aws-s3");
const ec2 = require("../../../aws-ec2");
const core_1 = require("../../../core");
const cdkp = require("../../lib");
const lib_1 = require("../../lib");
const testhelpers_1 = require("../testhelpers");
let app;
let pipelineStack;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
});
afterEach(() => {
    app.cleanup();
});
test('additionalinputs creates the right commands', () => {
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            additionalInputs: {
                'some/deep/directory': cdkp.CodePipelineSource.gitHub('test2/test2', 'main'),
            },
        }),
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        Source: {
            BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                phases: {
                    install: {
                        commands: [
                            '[ ! -d "some/deep/directory" ] || { echo \'additionalInputs: "some/deep/directory" must not exist yet. If you want to merge multiple artifacts, use a "cp" command.\'; exit 1; } && mkdir -p -- "some/deep" && ln -s -- "$CODEBUILD_SRC_DIR_test2_test2_Source" "some/deep/directory"',
                        ],
                    },
                },
            })),
        },
    });
});
test('CodeBuild projects have a description', () => {
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
        }),
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        Description: 'Pipeline step PipelineStack/Pipeline/Build/Synth',
    });
});
test('long duration steps are supported', () => {
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            additionalInputs: {
                'some/deep/directory': cdkp.CodePipelineSource.gitHub('test2/test2', 'main'),
            },
            timeout: core_1.Duration.minutes(180),
        }),
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        TimeoutInMinutes: 180,
    });
});
test('timeout can be configured as part of defaults', () => {
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            additionalInputs: {
                'some/deep/directory': cdkp.CodePipelineSource.gitHub('test2/test2', 'main'),
            },
        }),
        codeBuildDefaults: {
            timeout: core_1.Duration.minutes(180),
        },
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        TimeoutInMinutes: 180,
    });
});
test('timeout from defaults can be overridden', () => {
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            additionalInputs: {
                'some/deep/directory': cdkp.CodePipelineSource.gitHub('test2/test2', 'main'),
            },
            timeout: core_1.Duration.minutes(888),
        }),
        codeBuildDefaults: {
            timeout: core_1.Duration.minutes(180),
        },
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        TimeoutInMinutes: 888,
    });
});
test('fileSystemLocations can be configured as part of defaults', () => {
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            additionalInputs: {
                'some/deep/directory': cdkp.CodePipelineSource.gitHub('test2/test2', 'main'),
            },
        }),
        codeBuildDefaults: {
            fileSystemLocations: [codebuild.FileSystemLocation.efs({
                    identifier: 'myidentifier2',
                    location: 'myclodation.mydnsroot.com:/loc',
                    mountPoint: '/media',
                    mountOptions: 'opts',
                })],
            vpc: new ec2.Vpc(pipelineStack, 'MyVpc'),
            buildEnvironment: {
                privileged: true,
            },
        },
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        FileSystemLocations: [
            {
                Identifier: 'myidentifier2',
                MountPoint: '/media',
                MountOptions: 'opts',
                Location: 'myclodation.mydnsroot.com:/loc',
                Type: 'EFS',
            },
        ],
    });
});
test('envFromOutputs works even with very long stage and stack names', () => {
    const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
    const myApp = new testhelpers_1.AppWithOutput(app, 'Alpha'.repeat(10), {
        stackId: 'Stack'.repeat(10),
    });
    pipeline.addStage(myApp, {
        post: [
            new cdkp.ShellStep('Approve', {
                commands: ['/bin/true'],
                envFromCfnOutputs: {
                    THE_OUTPUT: myApp.theOutput,
                },
            }),
        ],
    });
    // THEN - did not throw an error about identifier lengths
});
test('role passed it used for project and code build action', () => {
    const projectRole = new iam.Role(pipelineStack, 'ProjectRole', {
        roleName: 'ProjectRole',
        assumedBy: new iam.ServicePrincipal('codebuild.amazon.com'),
    });
    const buildRole = new iam.Role(pipelineStack, 'BuildRole', {
        roleName: 'BuildRole',
        assumedBy: new iam.ServicePrincipal('codebuild.amazon.com'),
    });
    // WHEN
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
            role: projectRole,
            actionRole: buildRole,
        }),
    });
    // THEN
    const tpl = assertions_1.Template.fromStack(pipelineStack);
    tpl.hasResourceProperties('AWS::CodeBuild::Project', {
        ServiceRole: {
            'Fn::GetAtt': [
                'ProjectRole5B707505',
                'Arn',
            ],
        },
    });
    tpl.hasResourceProperties('AWS::CodePipeline::Pipeline', {
        Stages: [
            // source stage
            {},
            // build stage,
            {
                Actions: [
                    {
                        ActionTypeId: {
                            Category: 'Build',
                            Owner: 'AWS',
                            Provider: 'CodeBuild',
                        },
                        RoleArn: {
                            'Fn::GetAtt': [
                                'BuildRole41B77417',
                                'Arn',
                            ],
                        },
                    },
                ],
            },
            // Self-update
            {},
        ],
    });
});
test('exportedVariables', () => {
    const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
    // GIVEN
    const producer = new cdkp.CodeBuildStep('Produce', {
        commands: ['export MY_VAR=hello'],
    });
    const consumer = new cdkp.CodeBuildStep('Consume', {
        env: {
            THE_VAR: producer.exportedVariable('MY_VAR'),
        },
        commands: [
            'echo "The variable was: $THE_VAR"',
        ],
    });
    // WHEN
    pipeline.addWave('MyWave', {
        post: [consumer, producer],
    });
    // THEN
    const template = assertions_1.Template.fromStack(pipelineStack);
    template.hasResourceProperties('AWS::CodePipeline::Pipeline', {
        Stages: [
            { Name: 'Source' },
            { Name: 'Build' },
            { Name: 'UpdatePipeline' },
            {
                Name: 'MyWave',
                Actions: [
                    assertions_1.Match.objectLike({
                        Name: 'Produce',
                        Namespace: 'MyWave@Produce',
                        RunOrder: 1,
                    }),
                    assertions_1.Match.objectLike({
                        Name: 'Consume',
                        RunOrder: 2,
                        Configuration: assertions_1.Match.objectLike({
                            EnvironmentVariables: assertions_1.Match.serializedJson(assertions_1.Match.arrayWith([
                                {
                                    name: 'THE_VAR',
                                    type: 'PLAINTEXT',
                                    value: '#{MyWave@Produce.MY_VAR}',
                                },
                            ])),
                        }),
                    }),
                ],
            },
        ],
    });
    template.hasResourceProperties('AWS::CodeBuild::Project', {
        Source: {
            BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                env: {
                    'exported-variables': ['MY_VAR'],
                },
            })),
        },
    });
});
test('step has caching set', () => {
    // WHEN
    const myCachingBucket = new s3.Bucket(pipelineStack, 'MyCachingBucket');
    new cdkp.CodePipeline(pipelineStack, 'Pipeline', {
        synth: new cdkp.CodeBuildStep('Synth', {
            cache: codebuild.Cache.bucket(myCachingBucket),
            commands: ['/bin/true'],
            input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
        }),
    });
    // THEN
    assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
        Cache: {
            Location: {
                'Fn::Join': ['/', [{ Ref: 'MyCachingBucket8C98C553' }, { Ref: 'AWS::NoValue' }]],
            },
        },
    });
});
test('step exposes consumed stack output reference', () => {
    // WHEN
    const myApp = new testhelpers_1.AppWithOutput(app, 'AppWithOutput', {
        stackId: 'Stack',
    });
    const step = new cdkp.ShellStep('AStep', {
        commands: ['/bin/true'],
        envFromCfnOutputs: {
            THE_OUTPUT: myApp.theOutput,
        },
    });
    // THEN
    expect(step.consumedStackOutputs).toContainEqual(lib_1.StackOutputReference.fromCfnOutput(myApp.theOutput));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZWJ1aWxkLXN0ZXAudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvZGVidWlsZC1zdGVwLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREFBc0Q7QUFDdEQsb0RBQW9EO0FBQ3BELHdDQUF3QztBQUN4QyxzQ0FBc0M7QUFDdEMsd0NBQXdDO0FBQ3hDLHdDQUFnRDtBQUNoRCxrQ0FBa0M7QUFDbEMsbUNBQWlEO0FBQ2pELGdEQUFtRztBQUVuRyxJQUFJLEdBQVksQ0FBQztBQUNqQixJQUFJLGFBQW9CLENBQUM7QUFFekIsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLHFCQUFPLEVBQUUsQ0FBQztJQUNwQixhQUFhLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSwwQkFBWSxFQUFFLENBQUMsQ0FBQztBQUN6RSxDQUFDLENBQUMsQ0FBQztBQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO0lBQ3ZELE9BQU87SUFDUCxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLFVBQVUsRUFBRTtRQUMvQyxLQUFLLEVBQUUsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRTtZQUNyQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUM7WUFDdkIsS0FBSyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQztZQUMxRCxnQkFBZ0IsRUFBRTtnQkFDaEIscUJBQXFCLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDO2FBQzdFO1NBQ0YsQ0FBQztLQUNILENBQUMsQ0FBQztJQUVI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QUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUU7UUFDdkMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDO1FBQ3ZCLGlCQUFpQixFQUFFO1lBQ2pCLFVBQVUsRUFBRSxLQUFLLENBQUMsU0FBUztTQUM1QjtLQUNGLENBQUMsQ0FBQztJQUVILE9BQU87SUFDUCxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsY0FBYyxDQUFDLDBCQUFvQixDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztBQUN4RyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlbXBsYXRlLCBNYXRjaCB9IGZyb20gJy4uLy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0ICogYXMgY29kZWJ1aWxkIGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJy4uLy4uLy4uL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnLi4vLi4vLi4vYXdzLXMzJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICcuLi8uLi8uLi9hd3MtZWMyJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgY2RrcCBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgU3RhY2tPdXRwdXRSZWZlcmVuY2UgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUsIEFwcFdpdGhPdXRwdXQgfSBmcm9tICcuLi90ZXN0aGVscGVycyc7XG5cbmxldCBhcHA6IFRlc3RBcHA7XG5sZXQgcGlwZWxpbmVTdGFjazogU3RhY2s7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBhcHAgPSBuZXcgVGVzdEFwcCgpO1xuICBwaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGFwcC5jbGVhbnVwKCk7XG59KTtcblxudGVzdCgnYWRkaXRpb25hbGlucHV0cyBjcmVhdGVzIHRoZSByaWdodCBjb21tYW5kcycsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgY2RrcC5Db2RlUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ1BpcGVsaW5lJywge1xuICAgIHN5bnRoOiBuZXcgY2RrcC5Db2RlQnVpbGRTdGVwKCdTeW50aCcsIHtcbiAgICAgIGNvbW1hbmRzOiBbJy9iaW4vdHJ1ZSddLFxuICAgICAgaW5wdXQ6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdC90ZXN0JywgJ21haW4nKSxcbiAgICAgIGFkZGl0aW9uYWxJbnB1dHM6IHtcbiAgICAgICAgJ3NvbWUvZGVlcC9kaXJlY3RvcnknOiBjZGtwLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoJ3Rlc3QyL3Rlc3QyJywgJ21haW4nKSxcbiAgICAgIH0sXG4gICAgfSksXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgU291cmNlOiB7XG4gICAgICBCdWlsZFNwZWM6IE1hdGNoLnNlcmlhbGl6ZWRKc29uKE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBpbnN0YWxsOiB7XG4gICAgICAgICAgICBjb21tYW5kczogW1xuICAgICAgICAgICAgICAnWyAhIC1kIFwic29tZS9kZWVwL2RpcmVjdG9yeVwiIF0gfHwgeyBlY2hvIFxcJ2FkZGl0aW9uYWxJbnB1dHM6IFwic29tZS9kZWVwL2RpcmVjdG9yeVwiIG11c3Qgbm90IGV4aXN0IHlldC4gSWYgeW91IHdhbnQgdG8gbWVyZ2UgbXVsdGlwbGUgYXJ0aWZhY3RzLCB1c2UgYSBcImNwXCIgY29tbWFuZC5cXCc7IGV4aXQgMTsgfSAmJiBta2RpciAtcCAtLSBcInNvbWUvZGVlcFwiICYmIGxuIC1zIC0tIFwiJENPREVCVUlMRF9TUkNfRElSX3Rlc3QyX3Rlc3QyX1NvdXJjZVwiIFwic29tZS9kZWVwL2RpcmVjdG9yeVwiJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdDb2RlQnVpbGQgcHJvamVjdHMgaGF2ZSBhIGRlc2NyaXB0aW9uJywgKCkgPT4ge1xuICBuZXcgY2RrcC5Db2RlUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ1BpcGVsaW5lJywge1xuICAgIHN5bnRoOiBuZXcgY2RrcC5Db2RlQnVpbGRTdGVwKCdTeW50aCcsIHtcbiAgICAgIGNvbW1hbmRzOiBbJy9iaW4vdHJ1ZSddLFxuICAgICAgaW5wdXQ6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdC90ZXN0JywgJ21haW4nKSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKFxuICAgICdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsXG4gICAge1xuICAgICAgRGVzY3JpcHRpb246ICdQaXBlbGluZSBzdGVwIFBpcGVsaW5lU3RhY2svUGlwZWxpbmUvQnVpbGQvU3ludGgnLFxuICAgIH0sXG4gICk7XG59KTtcblxudGVzdCgnbG9uZyBkdXJhdGlvbiBzdGVwcyBhcmUgc3VwcG9ydGVkJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBjZGtwLkNvZGVQaXBlbGluZShwaXBlbGluZVN0YWNrLCAnUGlwZWxpbmUnLCB7XG4gICAgc3ludGg6IG5ldyBjZGtwLkNvZGVCdWlsZFN0ZXAoJ1N5bnRoJywge1xuICAgICAgY29tbWFuZHM6IFsnL2Jpbi90cnVlJ10sXG4gICAgICBpbnB1dDogY2RrcC5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKCd0ZXN0L3Rlc3QnLCAnbWFpbicpLFxuICAgICAgYWRkaXRpb25hbElucHV0czoge1xuICAgICAgICAnc29tZS9kZWVwL2RpcmVjdG9yeSc6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdDIvdGVzdDInLCAnbWFpbicpLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMTgwKSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBUaW1lb3V0SW5NaW51dGVzOiAxODAsXG4gIH0pO1xufSk7XG5cbnRlc3QoJ3RpbWVvdXQgY2FuIGJlIGNvbmZpZ3VyZWQgYXMgcGFydCBvZiBkZWZhdWx0cycsICgpID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgY2RrcC5Db2RlUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ1BpcGVsaW5lJywge1xuICAgIHN5bnRoOiBuZXcgY2RrcC5Db2RlQnVpbGRTdGVwKCdTeW50aCcsIHtcbiAgICAgIGNvbW1hbmRzOiBbJy9iaW4vdHJ1ZSddLFxuICAgICAgaW5wdXQ6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdC90ZXN0JywgJ21haW4nKSxcbiAgICAgIGFkZGl0aW9uYWxJbnB1dHM6IHtcbiAgICAgICAgJ3NvbWUvZGVlcC9kaXJlY3RvcnknOiBjZGtwLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoJ3Rlc3QyL3Rlc3QyJywgJ21haW4nKSxcbiAgICAgIH0sXG4gICAgfSksXG4gICAgY29kZUJ1aWxkRGVmYXVsdHM6IHtcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMTgwKSxcbiAgICB9LFxuICB9KTtcblxuICAvLyBUSEVOXG4gIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIFRpbWVvdXRJbk1pbnV0ZXM6IDE4MCxcbiAgfSk7XG59KTtcblxudGVzdCgndGltZW91dCBmcm9tIGRlZmF1bHRzIGNhbiBiZSBvdmVycmlkZGVuJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBjZGtwLkNvZGVQaXBlbGluZShwaXBlbGluZVN0YWNrLCAnUGlwZWxpbmUnLCB7XG4gICAgc3ludGg6IG5ldyBjZGtwLkNvZGVCdWlsZFN0ZXAoJ1N5bnRoJywge1xuICAgICAgY29tbWFuZHM6IFsnL2Jpbi90cnVlJ10sXG4gICAgICBpbnB1dDogY2RrcC5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKCd0ZXN0L3Rlc3QnLCAnbWFpbicpLFxuICAgICAgYWRkaXRpb25hbElucHV0czoge1xuICAgICAgICAnc29tZS9kZWVwL2RpcmVjdG9yeSc6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdDIvdGVzdDInLCAnbWFpbicpLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoODg4KSxcbiAgICB9KSxcbiAgICBjb2RlQnVpbGREZWZhdWx0czoge1xuICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxODApLFxuICAgIH0sXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgVGltZW91dEluTWludXRlczogODg4LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdmaWxlU3lzdGVtTG9jYXRpb25zIGNhbiBiZSBjb25maWd1cmVkIGFzIHBhcnQgb2YgZGVmYXVsdHMnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgbmV3IGNka3AuQ29kZVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdQaXBlbGluZScsIHtcbiAgICBzeW50aDogbmV3IGNka3AuQ29kZUJ1aWxkU3RlcCgnU3ludGgnLCB7XG4gICAgICBjb21tYW5kczogWycvYmluL3RydWUnXSxcbiAgICAgIGlucHV0OiBjZGtwLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoJ3Rlc3QvdGVzdCcsICdtYWluJyksXG4gICAgICBhZGRpdGlvbmFsSW5wdXRzOiB7XG4gICAgICAgICdzb21lL2RlZXAvZGlyZWN0b3J5JzogY2RrcC5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKCd0ZXN0Mi90ZXN0MicsICdtYWluJyksXG4gICAgICB9LFxuICAgIH0pLFxuICAgIGNvZGVCdWlsZERlZmF1bHRzOiB7XG4gICAgICBmaWxlU3lzdGVtTG9jYXRpb25zOiBbY29kZWJ1aWxkLkZpbGVTeXN0ZW1Mb2NhdGlvbi5lZnMoe1xuICAgICAgICBpZGVudGlmaWVyOiAnbXlpZGVudGlmaWVyMicsXG4gICAgICAgIGxvY2F0aW9uOiAnbXljbG9kYXRpb24ubXlkbnNyb290LmNvbTovbG9jJyxcbiAgICAgICAgbW91bnRQb2ludDogJy9tZWRpYScsXG4gICAgICAgIG1vdW50T3B0aW9uczogJ29wdHMnLFxuICAgICAgfSldLFxuICAgICAgdnBjOiBuZXcgZWMyLlZwYyhwaXBlbGluZVN0YWNrLCAnTXlWcGMnKSxcbiAgICAgIGJ1aWxkRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgcHJpdmlsZWdlZDogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBGaWxlU3lzdGVtTG9jYXRpb25zOiBbXG4gICAgICB7XG4gICAgICAgIElkZW50aWZpZXI6ICdteWlkZW50aWZpZXIyJyxcbiAgICAgICAgTW91bnRQb2ludDogJy9tZWRpYScsXG4gICAgICAgIE1vdW50T3B0aW9uczogJ29wdHMnLFxuICAgICAgICBMb2NhdGlvbjogJ215Y2xvZGF0aW9uLm15ZG5zcm9vdC5jb206L2xvYycsXG4gICAgICAgIFR5cGU6ICdFRlMnLFxuICAgICAgfSxcbiAgICBdLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdlbnZGcm9tT3V0cHV0cyB3b3JrcyBldmVuIHdpdGggdmVyeSBsb25nIHN0YWdlIGFuZCBzdGFjayBuYW1lcycsICgpID0+IHtcbiAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcblxuICBjb25zdCBteUFwcCA9IG5ldyBBcHBXaXRoT3V0cHV0KGFwcCwgJ0FscGhhJy5yZXBlYXQoMTApLCB7XG4gICAgc3RhY2tJZDogJ1N0YWNrJy5yZXBlYXQoMTApLFxuICB9KTtcblxuICBwaXBlbGluZS5hZGRTdGFnZShteUFwcCwge1xuICAgIHBvc3Q6IFtcbiAgICAgIG5ldyBjZGtwLlNoZWxsU3RlcCgnQXBwcm92ZScsIHtcbiAgICAgICAgY29tbWFuZHM6IFsnL2Jpbi90cnVlJ10sXG4gICAgICAgIGVudkZyb21DZm5PdXRwdXRzOiB7XG4gICAgICAgICAgVEhFX09VVFBVVDogbXlBcHAudGhlT3V0cHV0LFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgXSxcbiAgfSk7XG5cbiAgLy8gVEhFTiAtIGRpZCBub3QgdGhyb3cgYW4gZXJyb3IgYWJvdXQgaWRlbnRpZmllciBsZW5ndGhzXG59KTtcblxudGVzdCgncm9sZSBwYXNzZWQgaXQgdXNlZCBmb3IgcHJvamVjdCBhbmQgY29kZSBidWlsZCBhY3Rpb24nLCAoKSA9PiB7XG4gIGNvbnN0IHByb2plY3RSb2xlID0gbmV3IGlhbS5Sb2xlKFxuICAgIHBpcGVsaW5lU3RhY2ssXG4gICAgJ1Byb2plY3RSb2xlJyxcbiAgICB7XG4gICAgICByb2xlTmFtZTogJ1Byb2plY3RSb2xlJyxcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdjb2RlYnVpbGQuYW1hem9uLmNvbScpLFxuICAgIH0sXG4gICk7XG4gIGNvbnN0IGJ1aWxkUm9sZSA9IG5ldyBpYW0uUm9sZShcbiAgICBwaXBlbGluZVN0YWNrLFxuICAgICdCdWlsZFJvbGUnLFxuICAgIHtcbiAgICAgIHJvbGVOYW1lOiAnQnVpbGRSb2xlJyxcbiAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdjb2RlYnVpbGQuYW1hem9uLmNvbScpLFxuICAgIH0sXG4gICk7XG4gIC8vIFdIRU5cbiAgbmV3IGNka3AuQ29kZVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdQaXBlbGluZScsIHtcbiAgICBzeW50aDogbmV3IGNka3AuQ29kZUJ1aWxkU3RlcCgnU3ludGgnLCB7XG4gICAgICBjb21tYW5kczogWycvYmluL3RydWUnXSxcbiAgICAgIGlucHV0OiBjZGtwLkNvZGVQaXBlbGluZVNvdXJjZS5naXRIdWIoJ3Rlc3QvdGVzdCcsICdtYWluJyksXG4gICAgICByb2xlOiBwcm9qZWN0Um9sZSxcbiAgICAgIGFjdGlvblJvbGU6IGJ1aWxkUm9sZSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBjb25zdCB0cGwgPSBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjayk7XG4gIHRwbC5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIFNlcnZpY2VSb2xlOiB7XG4gICAgICAnRm46OkdldEF0dCc6IFtcbiAgICAgICAgJ1Byb2plY3RSb2xlNUI3MDc1MDUnLFxuICAgICAgICAnQXJuJyxcbiAgICAgIF0sXG4gICAgfSxcbiAgfSk7XG5cbiAgdHBsLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgIFN0YWdlczogW1xuICAgICAgLy8gc291cmNlIHN0YWdlXG4gICAgICB7fSxcbiAgICAgIC8vIGJ1aWxkIHN0YWdlLFxuICAgICAge1xuICAgICAgICBBY3Rpb25zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uVHlwZUlkOiB7XG4gICAgICAgICAgICAgIENhdGVnb3J5OiAnQnVpbGQnLFxuICAgICAgICAgICAgICBPd25lcjogJ0FXUycsXG4gICAgICAgICAgICAgIFByb3ZpZGVyOiAnQ29kZUJ1aWxkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBSb2xlQXJuOiB7XG4gICAgICAgICAgICAgICdGbjo6R2V0QXR0JzogW1xuICAgICAgICAgICAgICAgICdCdWlsZFJvbGU0MUI3NzQxNycsXG4gICAgICAgICAgICAgICAgJ0FybicsXG4gICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICAgLy8gU2VsZi11cGRhdGVcbiAgICAgIHt9LFxuICAgIF0sXG4gIH0pO1xufSk7XG50ZXN0KCdleHBvcnRlZFZhcmlhYmxlcycsICgpID0+IHtcbiAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcblxuICAvLyBHSVZFTlxuICBjb25zdCBwcm9kdWNlciA9IG5ldyBjZGtwLkNvZGVCdWlsZFN0ZXAoJ1Byb2R1Y2UnLCB7XG4gICAgY29tbWFuZHM6IFsnZXhwb3J0IE1ZX1ZBUj1oZWxsbyddLFxuICB9KTtcblxuICBjb25zdCBjb25zdW1lciA9IG5ldyBjZGtwLkNvZGVCdWlsZFN0ZXAoJ0NvbnN1bWUnLCB7XG4gICAgZW52OiB7XG4gICAgICBUSEVfVkFSOiBwcm9kdWNlci5leHBvcnRlZFZhcmlhYmxlKCdNWV9WQVInKSxcbiAgICB9LFxuICAgIGNvbW1hbmRzOiBbXG4gICAgICAnZWNobyBcIlRoZSB2YXJpYWJsZSB3YXM6ICRUSEVfVkFSXCInLFxuICAgIF0sXG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgcGlwZWxpbmUuYWRkV2F2ZSgnTXlXYXZlJywge1xuICAgIHBvc3Q6IFtjb25zdW1lciwgcHJvZHVjZXJdLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IHRlbXBsYXRlID0gVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spO1xuICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICBTdGFnZXM6IFtcbiAgICAgIHsgTmFtZTogJ1NvdXJjZScgfSxcbiAgICAgIHsgTmFtZTogJ0J1aWxkJyB9LFxuICAgICAgeyBOYW1lOiAnVXBkYXRlUGlwZWxpbmUnIH0sXG4gICAgICB7XG4gICAgICAgIE5hbWU6ICdNeVdhdmUnLFxuICAgICAgICBBY3Rpb25zOiBbXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiAnUHJvZHVjZScsXG4gICAgICAgICAgICBOYW1lc3BhY2U6ICdNeVdhdmVAUHJvZHVjZScsXG4gICAgICAgICAgICBSdW5PcmRlcjogMSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICAgIE5hbWU6ICdDb25zdW1lJyxcbiAgICAgICAgICAgIFJ1bk9yZGVyOiAyLFxuICAgICAgICAgICAgQ29uZmlndXJhdGlvbjogTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICAgIEVudmlyb25tZW50VmFyaWFibGVzOiBNYXRjaC5zZXJpYWxpemVkSnNvbihNYXRjaC5hcnJheVdpdGgoW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIG5hbWU6ICdUSEVfVkFSJyxcbiAgICAgICAgICAgICAgICAgIHR5cGU6ICdQTEFJTlRFWFQnLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6ICcje015V2F2ZUBQcm9kdWNlLk1ZX1ZBUn0nLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIF0pKSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICBdLFxuICB9KTtcblxuICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIFNvdXJjZToge1xuICAgICAgQnVpbGRTcGVjOiBNYXRjaC5zZXJpYWxpemVkSnNvbihNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgZW52OiB7XG4gICAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IFsnTVlfVkFSJ10sXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnc3RlcCBoYXMgY2FjaGluZyBzZXQnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgY29uc3QgbXlDYWNoaW5nQnVja2V0ID0gbmV3IHMzLkJ1Y2tldChwaXBlbGluZVN0YWNrLCAnTXlDYWNoaW5nQnVja2V0Jyk7XG4gIG5ldyBjZGtwLkNvZGVQaXBlbGluZShwaXBlbGluZVN0YWNrLCAnUGlwZWxpbmUnLCB7XG4gICAgc3ludGg6IG5ldyBjZGtwLkNvZGVCdWlsZFN0ZXAoJ1N5bnRoJywge1xuICAgICAgY2FjaGU6IGNvZGVidWlsZC5DYWNoZS5idWNrZXQobXlDYWNoaW5nQnVja2V0KSxcbiAgICAgIGNvbW1hbmRzOiBbJy9iaW4vdHJ1ZSddLFxuICAgICAgaW5wdXQ6IGNka3AuQ29kZVBpcGVsaW5lU291cmNlLmdpdEh1YigndGVzdC90ZXN0JywgJ21haW4nKSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBDYWNoZToge1xuICAgICAgTG9jYXRpb246IHtcbiAgICAgICAgJ0ZuOjpKb2luJzogWycvJywgW3sgUmVmOiAnTXlDYWNoaW5nQnVja2V0OEM5OEM1NTMnIH0sIHsgUmVmOiAnQVdTOjpOb1ZhbHVlJyB9XV0sXG4gICAgICB9LFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ3N0ZXAgZXhwb3NlcyBjb25zdW1lZCBzdGFjayBvdXRwdXQgcmVmZXJlbmNlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IG15QXBwID0gbmV3IEFwcFdpdGhPdXRwdXQoYXBwLCAnQXBwV2l0aE91dHB1dCcsIHtcbiAgICBzdGFja0lkOiAnU3RhY2snLFxuICB9KTtcbiAgY29uc3Qgc3RlcCA9IG5ldyBjZGtwLlNoZWxsU3RlcCgnQVN0ZXAnLCB7XG4gICAgY29tbWFuZHM6IFsnL2Jpbi90cnVlJ10sXG4gICAgZW52RnJvbUNmbk91dHB1dHM6IHtcbiAgICAgIFRIRV9PVVRQVVQ6IG15QXBwLnRoZU91dHB1dCxcbiAgICB9LFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChzdGVwLmNvbnN1bWVkU3RhY2tPdXRwdXRzKS50b0NvbnRhaW5FcXVhbChTdGFja091dHB1dFJlZmVyZW5jZS5mcm9tQ2ZuT3V0cHV0KG15QXBwLnRoZU91dHB1dCkpO1xufSk7Il19