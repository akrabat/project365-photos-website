"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable import/no-extraneous-dependencies */
const fs = require("fs");
const path = require("path");
const assertions_1 = require("../../../assertions");
const core_1 = require("../../../core");
const testhelpers_1 = require("../testhelpers");
let app;
let pipelineStack;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
});
afterEach(() => {
    app.cleanup();
});
(0, testhelpers_1.behavior)('stack templates in nested assemblies are correctly addressed', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.OneStackApp(app, 'App'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        // WHEN
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.OneStackApp(app, 'App'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'App',
                    Actions: assertions_1.Match.arrayWith([
                        assertions_1.Match.objectLike({
                            Name: (0, testhelpers_1.stringLike)('*Prepare'),
                            InputArtifacts: [assertions_1.Match.objectLike({})],
                            Configuration: assertions_1.Match.objectLike({
                                StackName: 'App-Stack',
                                TemplatePath: (0, testhelpers_1.stringLike)('*::assembly-App/*.template.json'),
                            }),
                        }),
                    ]),
                }]),
        });
    }
});
(0, testhelpers_1.behavior)('obvious error is thrown when stage contains no stacks', (suite) => {
    suite.legacy(() => {
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        // WHEN
        expect(() => {
            pipeline.addApplicationStage(new core_1.Stage(app, 'EmptyStage'));
        }).toThrow(/should contain at least one Stack/);
    });
    suite.modern(() => {
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        // WHEN
        expect(() => {
            pipeline.addStage(new core_1.Stage(app, 'EmptyStage'));
        }).toThrow(/should contain at least one Stack/);
    });
});
(0, testhelpers_1.behavior)('overridden stack names are respected', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new OneStackAppWithCustomName(app, 'App1'));
        pipeline.addApplicationStage(new OneStackAppWithCustomName(app, 'App2'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addStage(new OneStackAppWithCustomName(app, 'App1'));
        pipeline.addStage(new OneStackAppWithCustomName(app, 'App2'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([
                {
                    Name: 'App1',
                    Actions: assertions_1.Match.arrayWith([assertions_1.Match.objectLike({
                            Name: (0, testhelpers_1.stringLike)('*Prepare'),
                            Configuration: assertions_1.Match.objectLike({
                                StackName: 'MyFancyStack',
                            }),
                        })]),
                },
                {
                    Name: 'App2',
                    Actions: assertions_1.Match.arrayWith([assertions_1.Match.objectLike({
                            Name: (0, testhelpers_1.stringLike)('*Prepare'),
                            Configuration: assertions_1.Match.objectLike({
                                StackName: 'MyFancyStack',
                            }),
                        })]),
                },
            ]),
        });
    }
});
(0, testhelpers_1.behavior)('changing CLI version leads to a different pipeline structure (restarting it)', (suite) => {
    suite.legacy(() => {
        // GIVEN
        const stack2 = new core_1.Stack(app, 'Stack2', { env: testhelpers_1.PIPELINE_ENV });
        const stack3 = new core_1.Stack(app, 'Stack3', { env: testhelpers_1.PIPELINE_ENV });
        // WHEN
        new testhelpers_1.LegacyTestGitHubNpmPipeline(stack2, 'Cdk', {
            cdkCliVersion: '1.2.3',
        });
        new testhelpers_1.LegacyTestGitHubNpmPipeline(stack3, 'Cdk', {
            cdkCliVersion: '4.5.6',
        });
        THEN_codePipelineExpectation(stack2, stack3);
    });
    suite.modern(() => {
        // GIVEN
        const stack2 = new core_1.Stack(app, 'Stack2', { env: testhelpers_1.PIPELINE_ENV });
        const stack3 = new core_1.Stack(app, 'Stack3', { env: testhelpers_1.PIPELINE_ENV });
        // WHEN
        new testhelpers_1.ModernTestGitHubNpmPipeline(stack2, 'Cdk', {
            cliVersion: '1.2.3',
        });
        new testhelpers_1.ModernTestGitHubNpmPipeline(stack3, 'Cdk', {
            cliVersion: '4.5.6',
        });
        THEN_codePipelineExpectation(stack2, stack3);
    });
    function THEN_codePipelineExpectation(stack2, stack3) {
        // THEN
        const structure2 = new assertions_1.Capture();
        const structure3 = new assertions_1.Capture();
        assertions_1.Template.fromStack(stack2).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: structure2,
        });
        assertions_1.Template.fromStack(stack3).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: structure3,
        });
        expect(JSON.stringify(structure2.asArray())).not.toEqual(JSON.stringify(structure3.asArray()));
    }
});
(0, testhelpers_1.behavior)('tags get reflected in pipeline', (suite) => {
    suite.legacy(() => {
        // WHEN
        const stage = new testhelpers_1.OneStackApp(app, 'App');
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        core_1.Tags.of(stage).add('CostCenter', 'F00B4R');
        pipeline.addApplicationStage(stage);
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        // WHEN
        const stage = new testhelpers_1.OneStackApp(app, 'App');
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        core_1.Tags.of(stage).add('CostCenter', 'F00B4R');
        pipeline.addStage(stage);
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        // THEN
        const templateConfig = new assertions_1.Capture();
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'App',
                    Actions: assertions_1.Match.arrayWith([
                        assertions_1.Match.objectLike({
                            Name: (0, testhelpers_1.stringLike)('*Prepare'),
                            InputArtifacts: [assertions_1.Match.objectLike({})],
                            Configuration: assertions_1.Match.objectLike({
                                StackName: 'App-Stack',
                                TemplateConfiguration: templateConfig,
                            }),
                        }),
                    ]),
                }]),
        });
        expect(templateConfig.asString()).toMatch(/::assembly-App\/.*\.template\..*json/);
        const [, relConfigFile] = templateConfig.asString().split('::');
        const absConfigFile = path.join(app.outdir, relConfigFile);
        const configFile = JSON.parse(fs.readFileSync(absConfigFile, { encoding: 'utf-8' }));
        expect(configFile).toEqual(expect.objectContaining({
            Tags: {
                CostCenter: 'F00B4R',
            },
        }));
    }
});
class OneStackAppWithCustomName extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        new testhelpers_1.BucketStack(this, 'Stack', {
            stackName: 'MyFancyStack',
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzaWMtYmVoYXZpb3IudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJhc2ljLWJlaGF2aW9yLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzREFBc0Q7QUFDdEQseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QixvREFBK0Q7QUFDL0Qsd0NBQStEO0FBRS9ELGdEQUFpSztBQUVqSyxJQUFJLEdBQVksQ0FBQztBQUNqQixJQUFJLGFBQW9CLENBQUM7QUFFekIsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLHFCQUFPLEVBQUUsQ0FBQztJQUNwQixhQUFhLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSwwQkFBWSxFQUFFLENBQUMsQ0FBQztBQUN6RSxDQUFDLENBQUMsQ0FBQztBQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFBLHNCQUFRLEVBQUMsOERBQThELEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtJQUNqRixLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRTtRQUNoQixPQUFPO1FBQ1AsTUFBTSxRQUFRLEdBQUcsSUFBSSx5Q0FBMkIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkUsUUFBUSxDQUFDLG1CQUFtQixDQUFDLElBQUkseUJBQVcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUUxRCw0QkFBNEIsRUFBRSxDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBRUgsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDaEIsT0FBTztRQUNQLE1BQU0sUUFBUSxHQUFHLElBQUkseUNBQTJCLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3ZFLFFBQVEsQ0FBQyxRQUFRLENB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QUFhLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ2pELElBQUksRUFBRTtnQkFDSixVQUFVLEVBQUUsUUFBUTthQUNyQjtTQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ04sQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSx5QkFBMEIsU0FBUSxZQUFLO0lBQzNDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDMUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEIsSUFBSSx5QkFBVyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUU7WUFDN0IsU0FBUyxFQUFFLGNBQWM7U0FDMUIsQ0FBQyxDQUFDO0tBQ0o7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGltcG9ydC9uby1leHRyYW5lb3VzLWRlcGVuZGVuY2llcyAqL1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IENhcHR1cmUsIE1hdGNoLCBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgU3RhY2ssIFN0YWdlLCBTdGFnZVByb3BzLCBUYWdzIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IGJlaGF2aW9yLCBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUsIE9uZVN0YWNrQXBwLCBCdWNrZXRTdGFjaywgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUsIHN0cmluZ0xpa2UgfSBmcm9tICcuLi90ZXN0aGVscGVycyc7XG5cbmxldCBhcHA6IFRlc3RBcHA7XG5sZXQgcGlwZWxpbmVTdGFjazogU3RhY2s7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBhcHAgPSBuZXcgVGVzdEFwcCgpO1xuICBwaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGFwcC5jbGVhbnVwKCk7XG59KTtcblxuYmVoYXZpb3IoJ3N0YWNrIHRlbXBsYXRlcyBpbiBuZXN0ZWQgYXNzZW1ibGllcyBhcmUgY29ycmVjdGx5IGFkZHJlc3NlZCcsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IE9uZVN0YWNrQXBwKGFwcCwgJ0FwcCcpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRTdGFnZShuZXcgT25lU3RhY2tBcHAoYXBwLCAnQXBwJykpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIE5hbWU6ICdBcHAnLFxuICAgICAgICBBY3Rpb25zOiBNYXRjaC5hcnJheVdpdGgoW1xuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgICAgTmFtZTogc3RyaW5nTGlrZSgnKlByZXBhcmUnKSxcbiAgICAgICAgICAgIElucHV0QXJ0aWZhY3RzOiBbTWF0Y2gub2JqZWN0TGlrZSh7fSldLFxuICAgICAgICAgICAgQ29uZmlndXJhdGlvbjogTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICAgIFN0YWNrTmFtZTogJ0FwcC1TdGFjaycsXG4gICAgICAgICAgICAgIFRlbXBsYXRlUGF0aDogc3RyaW5nTGlrZSgnKjo6YXNzZW1ibHktQXBwLyoudGVtcGxhdGUuanNvbicpLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSksXG4gICAgICAgIF0pLFxuICAgICAgfV0pLFxuICAgIH0pO1xuICB9XG59KTtcblxuYmVoYXZpb3IoJ29idmlvdXMgZXJyb3IgaXMgdGhyb3duIHdoZW4gc3RhZ2UgY29udGFpbnMgbm8gc3RhY2tzJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcblxuICAgIC8vIFdIRU5cbiAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgU3RhZ2UoYXBwLCAnRW1wdHlTdGFnZScpKTtcbiAgICB9KS50b1Rocm93KC9zaG91bGQgY29udGFpbiBhdCBsZWFzdCBvbmUgU3RhY2svKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuXG4gICAgLy8gV0hFTlxuICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICBwaXBlbGluZS5hZGRTdGFnZShuZXcgU3RhZ2UoYXBwLCAnRW1wdHlTdGFnZScpKTtcbiAgICB9KS50b1Rocm93KC9zaG91bGQgY29udGFpbiBhdCBsZWFzdCBvbmUgU3RhY2svKTtcbiAgfSk7XG59KTtcblxuYmVoYXZpb3IoJ292ZXJyaWRkZW4gc3RhY2sgbmFtZXMgYXJlIHJlc3BlY3RlZCcsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IE9uZVN0YWNrQXBwV2l0aEN1c3RvbU5hbWUoYXBwLCAnQXBwMScpKTtcbiAgICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBPbmVTdGFja0FwcFdpdGhDdXN0b21OYW1lKGFwcCwgJ0FwcDInKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRTdGFnZShuZXcgT25lU3RhY2tBcHBXaXRoQ3VzdG9tTmFtZShhcHAsICdBcHAxJykpO1xuICAgIHBpcGVsaW5lLmFkZFN0YWdlKG5ldyBPbmVTdGFja0FwcFdpdGhDdXN0b21OYW1lKGFwcCwgJ0FwcDInKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKSB7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBNYXRjaC5hcnJheVdpdGgoW1xuICAgICAgICB7XG4gICAgICAgICAgTmFtZTogJ0FwcDEnLFxuICAgICAgICAgIEFjdGlvbnM6IE1hdGNoLmFycmF5V2l0aChbTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiBzdHJpbmdMaWtlKCcqUHJlcGFyZScpLFxuICAgICAgICAgICAgQ29uZmlndXJhdGlvbjogTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICAgIFN0YWNrTmFtZTogJ015RmFuY3lTdGFjaycsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KV0pLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgTmFtZTogJ0FwcDInLFxuICAgICAgICAgIEFjdGlvbnM6IE1hdGNoLmFycmF5V2l0aChbTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiBzdHJpbmdMaWtlKCcqUHJlcGFyZScpLFxuICAgICAgICAgICAgQ29uZmlndXJhdGlvbjogTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICAgIFN0YWNrTmFtZTogJ015RmFuY3lTdGFjaycsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KV0pLFxuICAgICAgICB9LFxuICAgICAgXSksXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcignY2hhbmdpbmcgQ0xJIHZlcnNpb24gbGVhZHMgdG8gYSBkaWZmZXJlbnQgcGlwZWxpbmUgc3RydWN0dXJlIChyZXN0YXJ0aW5nIGl0KScsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2syID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrMicsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gICAgY29uc3Qgc3RhY2szID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrMycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShzdGFjazIsICdDZGsnLCB7XG4gICAgICBjZGtDbGlWZXJzaW9uOiAnMS4yLjMnLFxuICAgIH0pO1xuICAgIG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUoc3RhY2szLCAnQ2RrJywge1xuICAgICAgY2RrQ2xpVmVyc2lvbjogJzQuNS42JyxcbiAgICB9KTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oc3RhY2syLCBzdGFjazMpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2syID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrMicsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gICAgY29uc3Qgc3RhY2szID0gbmV3IFN0YWNrKGFwcCwgJ1N0YWNrMycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IE1vZGVyblRlc3RHaXRIdWJOcG1QaXBlbGluZShzdGFjazIsICdDZGsnLCB7XG4gICAgICBjbGlWZXJzaW9uOiAnMS4yLjMnLFxuICAgIH0pO1xuICAgIG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUoc3RhY2szLCAnQ2RrJywge1xuICAgICAgY2xpVmVyc2lvbjogJzQuNS42JyxcbiAgICB9KTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oc3RhY2syLCBzdGFjazMpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKHN0YWNrMjogU3RhY2ssIHN0YWNrMzogU3RhY2spIHtcbiAgICAvLyBUSEVOXG4gICAgY29uc3Qgc3RydWN0dXJlMiA9IG5ldyBDYXB0dXJlKCk7XG4gICAgY29uc3Qgc3RydWN0dXJlMyA9IG5ldyBDYXB0dXJlKCk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2syKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogc3RydWN0dXJlMixcbiAgICB9KTtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2szKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogc3RydWN0dXJlMyxcbiAgICB9KTtcblxuICAgIGV4cGVjdChKU09OLnN0cmluZ2lmeShzdHJ1Y3R1cmUyLmFzQXJyYXkoKSkpLm5vdC50b0VxdWFsKEpTT04uc3RyaW5naWZ5KHN0cnVjdHVyZTMuYXNBcnJheSgpKSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcigndGFncyBnZXQgcmVmbGVjdGVkIGluIHBpcGVsaW5lJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHN0YWdlID0gbmV3IE9uZVN0YWNrQXBwKGFwcCwgJ0FwcCcpO1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgVGFncy5vZihzdGFnZSkuYWRkKCdDb3N0Q2VudGVyJywgJ0YwMEI0UicpO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2Uoc3RhZ2UpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBzdGFnZSA9IG5ldyBPbmVTdGFja0FwcChhcHAsICdBcHAnKTtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIFRhZ3Mub2Yoc3RhZ2UpLmFkZCgnQ29zdENlbnRlcicsICdGMDBCNFInKTtcbiAgICBwaXBlbGluZS5hZGRTdGFnZShzdGFnZSk7XG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIC8vIFRIRU5cbiAgICBjb25zdCB0ZW1wbGF0ZUNvbmZpZyA9IG5ldyBDYXB0dXJlKCk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBNYXRjaC5hcnJheVdpdGgoW3tcbiAgICAgICAgTmFtZTogJ0FwcCcsXG4gICAgICAgIEFjdGlvbnM6IE1hdGNoLmFycmF5V2l0aChbXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiBzdHJpbmdMaWtlKCcqUHJlcGFyZScpLFxuICAgICAgICAgICAgSW5wdXRBcnRpZmFjdHM6IFtNYXRjaC5vYmplY3RMaWtlKHt9KV0sXG4gICAgICAgICAgICBDb25maWd1cmF0aW9uOiBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICAgICAgU3RhY2tOYW1lOiAnQXBwLVN0YWNrJyxcbiAgICAgICAgICAgICAgVGVtcGxhdGVDb25maWd1cmF0aW9uOiB0ZW1wbGF0ZUNvbmZpZyxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pLFxuICAgICAgICBdKSxcbiAgICAgIH1dKSxcbiAgICB9KTtcblxuICAgIGV4cGVjdCh0ZW1wbGF0ZUNvbmZpZy5hc1N0cmluZygpKS50b01hdGNoKC86OmFzc2VtYmx5LUFwcFxcLy4qXFwudGVtcGxhdGVcXC4uKmpzb24vKTtcbiAgICBjb25zdCBbLCByZWxDb25maWdGaWxlXSA9IHRlbXBsYXRlQ29uZmlnLmFzU3RyaW5nKCkuc3BsaXQoJzo6Jyk7XG4gICAgY29uc3QgYWJzQ29uZmlnRmlsZSA9IHBhdGguam9pbihhcHAub3V0ZGlyLCByZWxDb25maWdGaWxlKTtcbiAgICBjb25zdCBjb25maWdGaWxlID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoYWJzQ29uZmlnRmlsZSwgeyBlbmNvZGluZzogJ3V0Zi04JyB9KSk7XG4gICAgZXhwZWN0KGNvbmZpZ0ZpbGUpLnRvRXF1YWwoZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgVGFnczoge1xuICAgICAgICBDb3N0Q2VudGVyOiAnRjAwQjRSJyxcbiAgICAgIH0sXG4gICAgfSkpO1xuICB9XG59KTtcblxuY2xhc3MgT25lU3RhY2tBcHBXaXRoQ3VzdG9tTmFtZSBleHRlbmRzIFN0YWdlIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjaycsIHtcbiAgICAgIHN0YWNrTmFtZTogJ015RmFuY3lTdGFjaycsXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==