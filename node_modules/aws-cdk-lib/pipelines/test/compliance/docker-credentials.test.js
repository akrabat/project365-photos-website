"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const cb = require("../../../aws-codebuild");
const secretsmanager = require("../../../aws-secretsmanager");
const core_1 = require("../../../core");
const cdkp = require("../../lib");
const lib_1 = require("../../lib");
const default_codebuild_image_1 = require("../../lib/private/default-codebuild-image");
const testhelpers_1 = require("../testhelpers");
const secretSynthArn = 'arn:aws:secretsmanager:eu-west-1:0123456789012:secret:synth-012345';
const secretUpdateArn = 'arn:aws:secretsmanager:eu-west-1:0123456789012:secret:update-012345';
const secretPublishArn = 'arn:aws:secretsmanager:eu-west-1:0123456789012:secret:publish-012345';
let app;
let pipelineStack;
let secretSynth;
let secretUpdate;
let secretPublish;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
    secretSynth = secretsmanager.Secret.fromSecretCompleteArn(pipelineStack, 'Secret1', secretSynthArn);
    secretUpdate = secretsmanager.Secret.fromSecretCompleteArn(pipelineStack, 'Secret2', secretUpdateArn);
    secretPublish = secretsmanager.Secret.fromSecretCompleteArn(pipelineStack, 'Secret3', secretPublishArn);
});
afterEach(() => {
    app.cleanup();
});
(0, testhelpers_1.behavior)('synth action receives install commands and access to relevant credentials', (suite) => {
    suite.legacy(() => {
        const pipeline = new LegacyPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new ModernPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        const expectedCredsConfig = JSON.stringify({
            version: '1.0',
            domainCredentials: { 'synth.example.com': { secretsManagerSecretId: secretSynthArn } },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: { Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        pre_build: {
                            commands: assertions_1.Match.arrayWith([
                                'mkdir $HOME/.cdk',
                                `echo '${expectedCredsConfig}' > $HOME/.cdk/cdk-docker-creds.json`,
                            ]),
                        },
                        // Prove we're looking at the Synth project
                        build: {
                            commands: assertions_1.Match.arrayWith([(0, testhelpers_1.stringLike)('*cdk*synth*')]),
                        },
                    },
                })),
            },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: assertions_1.Match.arrayWith([{
                        Action: ['secretsmanager:GetSecretValue', 'secretsmanager:DescribeSecret'],
                        Effect: 'Allow',
                        Resource: secretSynthArn,
                    }]),
                Version: '2012-10-17',
            },
            Roles: [{ Ref: (0, testhelpers_1.stringLike)('Cdk*BuildProjectRole*') }],
        });
    }
});
(0, testhelpers_1.behavior)('synth action receives Windows install commands if a Windows image is detected', (suite) => {
    suite.legacy(() => {
        const pipeline = new LegacyPipelineWithCreds(pipelineStack, 'Cdk2', {
            npmSynthOptions: {
                environment: {
                    buildImage: cb.WindowsBuildImage.WINDOWS_BASE_2_0,
                },
            },
        });
        pipeline.addApplicationStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new ModernPipelineWithCreds(pipelineStack, 'Cdk2', {
            synth: new lib_1.CodeBuildStep('Synth', {
                commands: ['cdk synth'],
                primaryOutputDirectory: 'cdk.out',
                input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
                buildEnvironment: {
                    buildImage: cb.WindowsBuildImage.WINDOWS_BASE_2_0,
                    computeType: cb.ComputeType.MEDIUM,
                },
            }),
        });
        pipeline.addStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        const expectedCredsConfig = JSON.stringify({
            version: '1.0',
            domainCredentials: { 'synth.example.com': { secretsManagerSecretId: secretSynthArn } },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: { Image: 'aws/codebuild/windows-base:2.0' },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        pre_build: {
                            commands: assertions_1.Match.arrayWith([
                                'mkdir %USERPROFILE%\\.cdk',
                                `echo '${expectedCredsConfig}' > %USERPROFILE%\\.cdk\\cdk-docker-creds.json`,
                            ]),
                        },
                        // Prove we're looking at the Synth project
                        build: {
                            commands: assertions_1.Match.arrayWith([(0, testhelpers_1.stringLike)('*cdk*synth*')]),
                        },
                    },
                })),
            },
        });
    }
});
(0, testhelpers_1.behavior)('self-update receives install commands and access to relevant credentials', (suite) => {
    suite.legacy(() => {
        const pipeline = new LegacyPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation('install');
    });
    suite.modern(() => {
        const pipeline = new ModernPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation('pre_build');
    });
    function THEN_codePipelineExpectation(expectedPhase) {
        const expectedCredsConfig = JSON.stringify({
            version: '1.0',
            domainCredentials: { 'selfupdate.example.com': { secretsManagerSecretId: secretUpdateArn } },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: { Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        [expectedPhase]: {
                            commands: assertions_1.Match.arrayWith([
                                'mkdir $HOME/.cdk',
                                `echo '${expectedCredsConfig}' > $HOME/.cdk/cdk-docker-creds.json`,
                            ]),
                        },
                        // Prove we're looking at the SelfMutate project
                        build: {
                            commands: assertions_1.Match.arrayWith([
                                (0, testhelpers_1.stringLike)('cdk * deploy PipelineStack*'),
                            ]),
                        },
                    },
                })),
            },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: assertions_1.Match.arrayWith([{
                        Action: ['secretsmanager:GetSecretValue', 'secretsmanager:DescribeSecret'],
                        Effect: 'Allow',
                        Resource: secretUpdateArn,
                    }]),
                Version: '2012-10-17',
            },
            Roles: [{ Ref: (0, testhelpers_1.stringLike)('*SelfMutat*Role*') }],
        });
    }
});
(0, testhelpers_1.behavior)('asset publishing receives install commands and access to relevant credentials', (suite) => {
    suite.legacy(() => {
        const pipeline = new LegacyPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation('install');
    });
    suite.modern(() => {
        const pipeline = new ModernPipelineWithCreds(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.DockerAssetApp(app, 'App1'));
        THEN_codePipelineExpectation('pre_build');
    });
    function THEN_codePipelineExpectation(expectedPhase) {
        const expectedCredsConfig = JSON.stringify({
            version: '1.0',
            domainCredentials: { 'publish.example.com': { secretsManagerSecretId: secretPublishArn } },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: { Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        [expectedPhase]: {
                            commands: assertions_1.Match.arrayWith([
                                'mkdir $HOME/.cdk',
                                `echo '${expectedCredsConfig}' > $HOME/.cdk/cdk-docker-creds.json`,
                            ]),
                        },
                        // Prove we're looking at the Publishing project
                        build: {
                            commands: assertions_1.Match.arrayWith([(0, testhelpers_1.stringLike)('cdk-assets*')]),
                        },
                    },
                })),
            },
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: assertions_1.Match.arrayWith([{
                        Action: ['secretsmanager:GetSecretValue', 'secretsmanager:DescribeSecret'],
                        Effect: 'Allow',
                        Resource: secretPublishArn,
                    }]),
                Version: '2012-10-17',
            },
            Roles: [{ Ref: 'CdkAssetsDockerRole484B6DD3' }],
        });
    }
});
class LegacyPipelineWithCreds extends testhelpers_1.LegacyTestGitHubNpmPipeline {
    constructor(scope, id, props) {
        super(scope, id, {
            dockerCredentials: [
                cdkp.DockerCredential.customRegistry('synth.example.com', secretSynth, {
                    usages: [cdkp.DockerCredentialUsage.SYNTH],
                }),
                cdkp.DockerCredential.customRegistry('selfupdate.example.com', secretUpdate, {
                    usages: [cdkp.DockerCredentialUsage.SELF_UPDATE],
                }),
                cdkp.DockerCredential.customRegistry('publish.example.com', secretPublish, {
                    usages: [cdkp.DockerCredentialUsage.ASSET_PUBLISHING],
                }),
            ],
            ...props,
        });
    }
}
class ModernPipelineWithCreds extends testhelpers_1.ModernTestGitHubNpmPipeline {
    constructor(scope, id, props) {
        super(scope, id, {
            dockerCredentials: [
                cdkp.DockerCredential.customRegistry('synth.example.com', secretSynth, {
                    usages: [cdkp.DockerCredentialUsage.SYNTH],
                }),
                cdkp.DockerCredential.customRegistry('selfupdate.example.com', secretUpdate, {
                    usages: [cdkp.DockerCredentialUsage.SELF_UPDATE],
                }),
                cdkp.DockerCredential.customRegistry('publish.example.com', secretPublish, {
                    usages: [cdkp.DockerCredentialUsage.ASSET_PUBLISHING],
                }),
            ],
            ...props,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLWNyZWRlbnRpYWxzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkb2NrZXItY3JlZGVudGlhbHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRDtBQUN0RCw2Q0FBNkM7QUFDN0MsOERBQThEO0FBQzlELHdDQUFzQztBQUV0QyxrQ0FBa0M7QUFDbEMsbUNBQTBDO0FBQzFDLHVGQUF5RjtBQUN6RixnREFBdUo7QUFFdkosTUFBTSxjQUFjLEdBQUcsb0VBQW9FLENBQUM7QUFDNUYsTUFBTSxlQUFlLEdBQUcscUVBQXFFLENBQUM7QUFDOUYsTUFBTSxnQkFBZ0IsR0FBRyxzRUFBc0UsQ0FBQztBQUVoRyxJQUFJLEdBQVksQ0FBQztBQUNqQixJQUFJLGFBQW9CLENBQUM7QUFDekIsSUFBSSxXQUFtQyxDQUFDO0FBQ3hDLElBQUksWUFBb0MsQ0FBQztBQUN6QyxJQUFJLGFBQXFDLENBQUM7QUFFMUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLHFCQUFPLEVBQUUsQ0FBQztJQUNwQixhQUFhLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSwwQkFBWSxFQUFFLENBQUMsQ0FBQztJQUN2RSxXQUFXLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxhQUFhLEVBQUUsU0FBUyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQ3BHLFlBQVksR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLGFBQWEsRUFBRSxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDdEcsYUFBYSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsYUFBYSxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzFHLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLEdBQUcs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SDtZQUNELEdBQUcsS0FBSztTQUNULENBQUMsQ0FBQztLQUNKO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNYXRjaCwgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGNiIGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0ICogYXMgc2VjcmV0c21hbmFnZXIgZnJvbSAnLi4vLi4vLi4vYXdzLXNlY3JldHNtYW5hZ2VyJztcbmltcG9ydCB7IFN0YWNrIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGNka3AgZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IENvZGVCdWlsZFN0ZXAgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgQ0RLUF9ERUZBVUxUX0NPREVCVUlMRF9JTUFHRSB9IGZyb20gJy4uLy4uL2xpYi9wcml2YXRlL2RlZmF1bHQtY29kZWJ1aWxkLWltYWdlJztcbmltcG9ydCB7IGJlaGF2aW9yLCBQSVBFTElORV9FTlYsIFRlc3RBcHAsIExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZSwgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lLCBEb2NrZXJBc3NldEFwcCwgc3RyaW5nTGlrZSB9IGZyb20gJy4uL3Rlc3RoZWxwZXJzJztcblxuY29uc3Qgc2VjcmV0U3ludGhBcm4gPSAnYXJuOmF3czpzZWNyZXRzbWFuYWdlcjpldS13ZXN0LTE6MDEyMzQ1Njc4OTAxMjpzZWNyZXQ6c3ludGgtMDEyMzQ1JztcbmNvbnN0IHNlY3JldFVwZGF0ZUFybiA9ICdhcm46YXdzOnNlY3JldHNtYW5hZ2VyOmV1LXdlc3QtMTowMTIzNDU2Nzg5MDEyOnNlY3JldDp1cGRhdGUtMDEyMzQ1JztcbmNvbnN0IHNlY3JldFB1Ymxpc2hBcm4gPSAnYXJuOmF3czpzZWNyZXRzbWFuYWdlcjpldS13ZXN0LTE6MDEyMzQ1Njc4OTAxMjpzZWNyZXQ6cHVibGlzaC0wMTIzNDUnO1xuXG5sZXQgYXBwOiBUZXN0QXBwO1xubGV0IHBpcGVsaW5lU3RhY2s6IFN0YWNrO1xubGV0IHNlY3JldFN5bnRoOiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0O1xubGV0IHNlY3JldFVwZGF0ZTogc2VjcmV0c21hbmFnZXIuSVNlY3JldDtcbmxldCBzZWNyZXRQdWJsaXNoOiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0O1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgYXBwID0gbmV3IFRlc3RBcHAoKTtcbiAgcGlwZWxpbmVTdGFjayA9IG5ldyBTdGFjayhhcHAsICdQaXBlbGluZVN0YWNrJywgeyBlbnY6IFBJUEVMSU5FX0VOViB9KTtcbiAgc2VjcmV0U3ludGggPSBzZWNyZXRzbWFuYWdlci5TZWNyZXQuZnJvbVNlY3JldENvbXBsZXRlQXJuKHBpcGVsaW5lU3RhY2ssICdTZWNyZXQxJywgc2VjcmV0U3ludGhBcm4pO1xuICBzZWNyZXRVcGRhdGUgPSBzZWNyZXRzbWFuYWdlci5TZWNyZXQuZnJvbVNlY3JldENvbXBsZXRlQXJuKHBpcGVsaW5lU3RhY2ssICdTZWNyZXQyJywgc2VjcmV0VXBkYXRlQXJuKTtcbiAgc2VjcmV0UHVibGlzaCA9IHNlY3JldHNtYW5hZ2VyLlNlY3JldC5mcm9tU2VjcmV0Q29tcGxldGVBcm4ocGlwZWxpbmVTdGFjaywgJ1NlY3JldDMnLCBzZWNyZXRQdWJsaXNoQXJuKTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBhcHAuY2xlYW51cCgpO1xufSk7XG5cbmJlaGF2aW9yKCdzeW50aCBhY3Rpb24gcmVjZWl2ZXMgaW5zdGFsbCBjb21tYW5kcyBhbmQgYWNjZXNzIHRvIHJlbGV2YW50IGNyZWRlbnRpYWxzJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTGVnYWN5UGlwZWxpbmVXaXRoQ3JlZHMocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IERvY2tlckFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuUGlwZWxpbmVXaXRoQ3JlZHMocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZFN0YWdlKG5ldyBEb2NrZXJBc3NldEFwcChhcHAsICdBcHAxJykpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIGNvbnN0IGV4cGVjdGVkQ3JlZHNDb25maWcgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICAgIGRvbWFpbkNyZWRlbnRpYWxzOiB7ICdzeW50aC5leGFtcGxlLmNvbSc6IHsgc2VjcmV0c01hbmFnZXJTZWNyZXRJZDogc2VjcmV0U3ludGhBcm4gfSB9LFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgICBFbnZpcm9ubWVudDogeyBJbWFnZTogQ0RLUF9ERUZBVUxUX0NPREVCVUlMRF9JTUFHRS5pbWFnZUlkIH0sXG4gICAgICBTb3VyY2U6IHtcbiAgICAgICAgQnVpbGRTcGVjOiBNYXRjaC5zZXJpYWxpemVkSnNvbihNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICAgIHByZV9idWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFtcbiAgICAgICAgICAgICAgICAnbWtkaXIgJEhPTUUvLmNkaycsXG4gICAgICAgICAgICAgICAgYGVjaG8gJyR7ZXhwZWN0ZWRDcmVkc0NvbmZpZ30nID4gJEhPTUUvLmNkay9jZGstZG9ja2VyLWNyZWRzLmpzb25gLFxuICAgICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyBQcm92ZSB3ZSdyZSBsb29raW5nIGF0IHRoZSBTeW50aCBwcm9qZWN0XG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFtzdHJpbmdMaWtlKCcqY2RrKnN5bnRoKicpXSksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgICAgQWN0aW9uOiBbJ3NlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlJywgJ3NlY3JldHNtYW5hZ2VyOkRlc2NyaWJlU2VjcmV0J10sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiBzZWNyZXRTeW50aEFybixcbiAgICAgICAgfV0pLFxuICAgICAgICBWZXJzaW9uOiAnMjAxMi0xMC0xNycsXG4gICAgICB9LFxuICAgICAgUm9sZXM6IFt7IFJlZjogc3RyaW5nTGlrZSgnQ2RrKkJ1aWxkUHJvamVjdFJvbGUqJykgfV0sXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcignc3ludGggYWN0aW9uIHJlY2VpdmVzIFdpbmRvd3MgaW5zdGFsbCBjb21tYW5kcyBpZiBhIFdpbmRvd3MgaW1hZ2UgaXMgZGV0ZWN0ZWQnLCAoc3VpdGUpID0+IHtcbiAgc3VpdGUubGVnYWN5KCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBMZWdhY3lQaXBlbGluZVdpdGhDcmVkcyhwaXBlbGluZVN0YWNrLCAnQ2RrMicsIHtcbiAgICAgIG5wbVN5bnRoT3B0aW9uczoge1xuICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgIGJ1aWxkSW1hZ2U6IGNiLldpbmRvd3NCdWlsZEltYWdlLldJTkRPV1NfQkFTRV8yXzAsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IERvY2tlckFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuUGlwZWxpbmVXaXRoQ3JlZHMocGlwZWxpbmVTdGFjaywgJ0NkazInLCB7XG4gICAgICBzeW50aDogbmV3IENvZGVCdWlsZFN0ZXAoJ1N5bnRoJywge1xuICAgICAgICBjb21tYW5kczogWydjZGsgc3ludGgnXSxcbiAgICAgICAgcHJpbWFyeU91dHB1dERpcmVjdG9yeTogJ2Nkay5vdXQnLFxuICAgICAgICBpbnB1dDogY2RrcC5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKCd0ZXN0L3Rlc3QnLCAnbWFpbicpLFxuICAgICAgICBidWlsZEVudmlyb25tZW50OiB7XG4gICAgICAgICAgYnVpbGRJbWFnZTogY2IuV2luZG93c0J1aWxkSW1hZ2UuV0lORE9XU19CQVNFXzJfMCxcbiAgICAgICAgICBjb21wdXRlVHlwZTogY2IuQ29tcHV0ZVR5cGUuTUVESVVNLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG4gICAgcGlwZWxpbmUuYWRkU3RhZ2UobmV3IERvY2tlckFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKSB7XG4gICAgY29uc3QgZXhwZWN0ZWRDcmVkc0NvbmZpZyA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHZlcnNpb246ICcxLjAnLFxuICAgICAgZG9tYWluQ3JlZGVudGlhbHM6IHsgJ3N5bnRoLmV4YW1wbGUuY29tJzogeyBzZWNyZXRzTWFuYWdlclNlY3JldElkOiBzZWNyZXRTeW50aEFybiB9IH0sXG4gICAgfSk7XG5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICAgIEVudmlyb25tZW50OiB7IEltYWdlOiAnYXdzL2NvZGVidWlsZC93aW5kb3dzLWJhc2U6Mi4wJyB9LFxuICAgICAgU291cmNlOiB7XG4gICAgICAgIEJ1aWxkU3BlYzogTWF0Y2guc2VyaWFsaXplZEpzb24oTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgICBwcmVfYnVpbGQ6IHtcbiAgICAgICAgICAgICAgY29tbWFuZHM6IE1hdGNoLmFycmF5V2l0aChbXG4gICAgICAgICAgICAgICAgJ21rZGlyICVVU0VSUFJPRklMRSVcXFxcLmNkaycsXG4gICAgICAgICAgICAgICAgYGVjaG8gJyR7ZXhwZWN0ZWRDcmVkc0NvbmZpZ30nID4gJVVTRVJQUk9GSUxFJVxcXFwuY2RrXFxcXGNkay1kb2NrZXItY3JlZHMuanNvbmAsXG4gICAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIFByb3ZlIHdlJ3JlIGxvb2tpbmcgYXQgdGhlIFN5bnRoIHByb2plY3RcbiAgICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICAgIGNvbW1hbmRzOiBNYXRjaC5hcnJheVdpdGgoW3N0cmluZ0xpa2UoJypjZGsqc3ludGgqJyldKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxufSk7XG5cbmJlaGF2aW9yKCdzZWxmLXVwZGF0ZSByZWNlaXZlcyBpbnN0YWxsIGNvbW1hbmRzIGFuZCBhY2Nlc3MgdG8gcmVsZXZhbnQgY3JlZGVudGlhbHMnLCAoc3VpdGUpID0+IHtcbiAgc3VpdGUubGVnYWN5KCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBMZWdhY3lQaXBlbGluZVdpdGhDcmVkcyhwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgRG9ja2VyQXNzZXRBcHAoYXBwLCAnQXBwMScpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oJ2luc3RhbGwnKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBNb2Rlcm5QaXBlbGluZVdpdGhDcmVkcyhwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgcGlwZWxpbmUuYWRkU3RhZ2UobmV3IERvY2tlckFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCdwcmVfYnVpbGQnKTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbihleHBlY3RlZFBoYXNlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBleHBlY3RlZENyZWRzQ29uZmlnID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgdmVyc2lvbjogJzEuMCcsXG4gICAgICBkb21haW5DcmVkZW50aWFsczogeyAnc2VsZnVwZGF0ZS5leGFtcGxlLmNvbSc6IHsgc2VjcmV0c01hbmFnZXJTZWNyZXRJZDogc2VjcmV0VXBkYXRlQXJuIH0gfSxcbiAgICB9KTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgICAgRW52aXJvbm1lbnQ6IHsgSW1hZ2U6IENES1BfREVGQVVMVF9DT0RFQlVJTERfSU1BR0UuaW1hZ2VJZCB9LFxuICAgICAgU291cmNlOiB7XG4gICAgICAgIEJ1aWxkU3BlYzogTWF0Y2guc2VyaWFsaXplZEpzb24oTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgICBbZXhwZWN0ZWRQaGFzZV06IHtcbiAgICAgICAgICAgICAgY29tbWFuZHM6IE1hdGNoLmFycmF5V2l0aChbXG4gICAgICAgICAgICAgICAgJ21rZGlyICRIT01FLy5jZGsnLFxuICAgICAgICAgICAgICAgIGBlY2hvICcke2V4cGVjdGVkQ3JlZHNDb25maWd9JyA+ICRIT01FLy5jZGsvY2RrLWRvY2tlci1jcmVkcy5qc29uYCxcbiAgICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gUHJvdmUgd2UncmUgbG9va2luZyBhdCB0aGUgU2VsZk11dGF0ZSBwcm9qZWN0XG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFtcbiAgICAgICAgICAgICAgICBzdHJpbmdMaWtlKCdjZGsgKiBkZXBsb3kgUGlwZWxpbmVTdGFjayonKSxcbiAgICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgICAgQWN0aW9uOiBbJ3NlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlJywgJ3NlY3JldHNtYW5hZ2VyOkRlc2NyaWJlU2VjcmV0J10sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiBzZWNyZXRVcGRhdGVBcm4sXG4gICAgICAgIH1dKSxcbiAgICAgICAgVmVyc2lvbjogJzIwMTItMTAtMTcnLFxuICAgICAgfSxcbiAgICAgIFJvbGVzOiBbeyBSZWY6IHN0cmluZ0xpa2UoJypTZWxmTXV0YXQqUm9sZSonKSB9XSxcbiAgICB9KTtcbiAgfVxufSk7XG5cbmJlaGF2aW9yKCdhc3NldCBwdWJsaXNoaW5nIHJlY2VpdmVzIGluc3RhbGwgY29tbWFuZHMgYW5kIGFjY2VzcyB0byByZWxldmFudCBjcmVkZW50aWFscycsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IExlZ2FjeVBpcGVsaW5lV2l0aENyZWRzKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBEb2NrZXJBc3NldEFwcChhcHAsICdBcHAxJykpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbignaW5zdGFsbCcpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IE1vZGVyblBpcGVsaW5lV2l0aENyZWRzKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRTdGFnZShuZXcgRG9ja2VyQXNzZXRBcHAoYXBwLCAnQXBwMScpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oJ3ByZV9idWlsZCcpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKGV4cGVjdGVkUGhhc2U6IHN0cmluZykge1xuICAgIGNvbnN0IGV4cGVjdGVkQ3JlZHNDb25maWcgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICAgIGRvbWFpbkNyZWRlbnRpYWxzOiB7ICdwdWJsaXNoLmV4YW1wbGUuY29tJzogeyBzZWNyZXRzTWFuYWdlclNlY3JldElkOiBzZWNyZXRQdWJsaXNoQXJuIH0gfSxcbiAgICB9KTtcblxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgICAgRW52aXJvbm1lbnQ6IHsgSW1hZ2U6IENES1BfREVGQVVMVF9DT0RFQlVJTERfSU1BR0UuaW1hZ2VJZCB9LFxuICAgICAgU291cmNlOiB7XG4gICAgICAgIEJ1aWxkU3BlYzogTWF0Y2guc2VyaWFsaXplZEpzb24oTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgICBbZXhwZWN0ZWRQaGFzZV06IHtcbiAgICAgICAgICAgICAgY29tbWFuZHM6IE1hdGNoLmFycmF5V2l0aChbXG4gICAgICAgICAgICAgICAgJ21rZGlyICRIT01FLy5jZGsnLFxuICAgICAgICAgICAgICAgIGBlY2hvICcke2V4cGVjdGVkQ3JlZHNDb25maWd9JyA+ICRIT01FLy5jZGsvY2RrLWRvY2tlci1jcmVkcy5qc29uYCxcbiAgICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gUHJvdmUgd2UncmUgbG9va2luZyBhdCB0aGUgUHVibGlzaGluZyBwcm9qZWN0XG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFtzdHJpbmdMaWtlKCdjZGstYXNzZXRzKicpXSksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICAgIFN0YXRlbWVudDogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgICAgQWN0aW9uOiBbJ3NlY3JldHNtYW5hZ2VyOkdldFNlY3JldFZhbHVlJywgJ3NlY3JldHNtYW5hZ2VyOkRlc2NyaWJlU2VjcmV0J10sXG4gICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgIFJlc291cmNlOiBzZWNyZXRQdWJsaXNoQXJuLFxuICAgICAgICB9XSksXG4gICAgICAgIFZlcnNpb246ICcyMDEyLTEwLTE3JyxcbiAgICAgIH0sXG4gICAgICBSb2xlczogW3sgUmVmOiAnQ2RrQXNzZXRzRG9ja2VyUm9sZTQ4NEI2REQzJyB9XSxcbiAgICB9KTtcbiAgfVxufSk7XG5cbmNsYXNzIExlZ2FjeVBpcGVsaW5lV2l0aENyZWRzIGV4dGVuZHMgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBDb25zdHJ1Y3RvclBhcmFtZXRlcnM8dHlwZW9mIExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZT5bMl0pIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHtcbiAgICAgIGRvY2tlckNyZWRlbnRpYWxzOiBbXG4gICAgICAgIGNka3AuRG9ja2VyQ3JlZGVudGlhbC5jdXN0b21SZWdpc3RyeSgnc3ludGguZXhhbXBsZS5jb20nLCBzZWNyZXRTeW50aCwge1xuICAgICAgICAgIHVzYWdlczogW2Nka3AuRG9ja2VyQ3JlZGVudGlhbFVzYWdlLlNZTlRIXSxcbiAgICAgICAgfSksXG4gICAgICAgIGNka3AuRG9ja2VyQ3JlZGVudGlhbC5jdXN0b21SZWdpc3RyeSgnc2VsZnVwZGF0ZS5leGFtcGxlLmNvbScsIHNlY3JldFVwZGF0ZSwge1xuICAgICAgICAgIHVzYWdlczogW2Nka3AuRG9ja2VyQ3JlZGVudGlhbFVzYWdlLlNFTEZfVVBEQVRFXSxcbiAgICAgICAgfSksXG4gICAgICAgIGNka3AuRG9ja2VyQ3JlZGVudGlhbC5jdXN0b21SZWdpc3RyeSgncHVibGlzaC5leGFtcGxlLmNvbScsIHNlY3JldFB1Ymxpc2gsIHtcbiAgICAgICAgICB1c2FnZXM6IFtjZGtwLkRvY2tlckNyZWRlbnRpYWxVc2FnZS5BU1NFVF9QVUJMSVNISU5HXSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgICAgLi4ucHJvcHMsXG4gICAgfSk7XG4gIH1cbn1cblxuY2xhc3MgTW9kZXJuUGlwZWxpbmVXaXRoQ3JlZHMgZXh0ZW5kcyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IENvbnN0cnVjdG9yUGFyYW1ldGVyczx0eXBlb2YgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lPlsyXSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuICAgICAgZG9ja2VyQ3JlZGVudGlhbHM6IFtcbiAgICAgICAgY2RrcC5Eb2NrZXJDcmVkZW50aWFsLmN1c3RvbVJlZ2lzdHJ5KCdzeW50aC5leGFtcGxlLmNvbScsIHNlY3JldFN5bnRoLCB7XG4gICAgICAgICAgdXNhZ2VzOiBbY2RrcC5Eb2NrZXJDcmVkZW50aWFsVXNhZ2UuU1lOVEhdLFxuICAgICAgICB9KSxcbiAgICAgICAgY2RrcC5Eb2NrZXJDcmVkZW50aWFsLmN1c3RvbVJlZ2lzdHJ5KCdzZWxmdXBkYXRlLmV4YW1wbGUuY29tJywgc2VjcmV0VXBkYXRlLCB7XG4gICAgICAgICAgdXNhZ2VzOiBbY2RrcC5Eb2NrZXJDcmVkZW50aWFsVXNhZ2UuU0VMRl9VUERBVEVdLFxuICAgICAgICB9KSxcbiAgICAgICAgY2RrcC5Eb2NrZXJDcmVkZW50aWFsLmN1c3RvbVJlZ2lzdHJ5KCdwdWJsaXNoLmV4YW1wbGUuY29tJywgc2VjcmV0UHVibGlzaCwge1xuICAgICAgICAgIHVzYWdlczogW2Nka3AuRG9ja2VyQ3JlZGVudGlhbFVzYWdlLkFTU0VUX1BVQkxJU0hJTkddLFxuICAgICAgICB9KSxcbiAgICAgIF0sXG4gICAgICAuLi5wcm9wcyxcbiAgICB9KTtcbiAgfVxufSJdfQ==