"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const cp = require("../../../aws-codepipeline");
const cpa = require("../../../aws-codepipeline-actions");
const cdk_build_tools_1 = require("@aws-cdk/cdk-build-tools");
const core_1 = require("../../../core");
const cdkp = require("../../lib");
const lib_1 = require("../../lib");
const testhelpers_1 = require("../testhelpers");
let app;
let pipelineStack;
let sourceArtifact;
let cloudAssemblyArtifact;
let codePipeline;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
    sourceArtifact = new cp.Artifact();
    cloudAssemblyArtifact = new cp.Artifact();
});
afterEach(() => {
    app.cleanup();
});
describe('with empty existing CodePipeline', () => {
    beforeEach(() => {
        codePipeline = new cp.Pipeline(pipelineStack, 'CodePipeline');
    });
    (0, testhelpers_1.behavior)('both actions are required', (suite) => {
        suite.legacy(() => {
            // WHEN
            expect(() => {
                new cdkp.CdkPipeline(pipelineStack, 'Cdk', { cloudAssemblyArtifact, codePipeline });
            }).toThrow(/You must pass a 'sourceAction'/);
        });
        // 'synth' is not optional so this doesn't apply
        suite.doesNotApply.modern();
    });
    (0, testhelpers_1.behavior)('can give both actions', (suite) => {
        suite.legacy(() => {
            // WHEN
            new cdkp.CdkPipeline(pipelineStack, 'Cdk', {
                cloudAssemblyArtifact,
                codePipeline,
                sourceAction: new testhelpers_1.TestGitHubAction(sourceArtifact),
                synthAction: cdkp.SimpleSynthAction.standardNpmSynth({ sourceArtifact, cloudAssemblyArtifact }),
            });
            THEN_codePipelineExpectation();
        });
        suite.modern(() => {
            // WHEN
            new cdkp.CodePipeline(pipelineStack, 'Cdk', {
                codePipeline,
                synth: new cdkp.ShellStep('Synth', {
                    input: cdkp.CodePipelineSource.gitHub('test/test', 'main'),
                    commands: ['true'],
                }),
            });
            THEN_codePipelineExpectation();
        });
        function THEN_codePipelineExpectation() {
            // THEN
            assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
                Stages: [
                    assertions_1.Match.objectLike({ Name: 'Source' }),
                    assertions_1.Match.objectLike({ Name: 'Build' }),
                    assertions_1.Match.objectLike({ Name: 'UpdatePipeline' }),
                ],
            });
        }
    });
});
describe('with custom Source stage in existing Pipeline', () => {
    beforeEach(() => {
        codePipeline = new cp.Pipeline(pipelineStack, 'CodePipeline', {
            stages: [
                {
                    stageName: 'CustomSource',
                    actions: [new testhelpers_1.TestGitHubAction(sourceArtifact)],
                },
            ],
        });
    });
    (0, testhelpers_1.behavior)('Work with synthAction', (suite) => {
        suite.legacy(() => {
            // WHEN
            new cdkp.CdkPipeline(pipelineStack, 'Cdk', {
                codePipeline,
                cloudAssemblyArtifact,
                synthAction: cdkp.SimpleSynthAction.standardNpmSynth({ sourceArtifact, cloudAssemblyArtifact }),
            });
            THEN_codePipelineExpectation();
        });
        suite.modern(() => {
            new cdkp.CodePipeline(pipelineStack, 'Cdk', {
                codePipeline,
                synth: new cdkp.ShellStep('Synth', {
                    input: cdkp.CodePipelineFileSet.fromArtifact(sourceArtifact),
                    commands: ['true'],
                }),
            });
            THEN_codePipelineExpectation();
        });
        function THEN_codePipelineExpectation() {
            // THEN
            assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
                Stages: [
                    assertions_1.Match.objectLike({ Name: 'CustomSource' }),
                    assertions_1.Match.objectLike({ Name: 'Build' }),
                    assertions_1.Match.objectLike({ Name: 'UpdatePipeline' }),
                ],
            });
        }
    });
});
(0, cdk_build_tools_1.describeDeprecated)('with Source and Build stages in existing Pipeline', () => {
    beforeEach(() => {
        codePipeline = new cp.Pipeline(pipelineStack, 'CodePipeline', {
            stages: [
                {
                    stageName: 'CustomSource',
                    actions: [new testhelpers_1.TestGitHubAction(sourceArtifact)],
                },
                {
                    stageName: 'CustomBuild',
                    actions: [cdkp.SimpleSynthAction.standardNpmSynth({ sourceArtifact, cloudAssemblyArtifact })],
                },
            ],
        });
    });
    (0, testhelpers_1.behavior)('can supply no actions', (suite) => {
        suite.legacy(() => {
            // WHEN
            new cdkp.CdkPipeline(pipelineStack, 'Cdk', {
                codePipeline,
                cloudAssemblyArtifact,
            });
            THEN_codePipelineExpectation();
        });
        suite.modern(() => {
            new cdkp.CodePipeline(pipelineStack, 'Cdk', {
                codePipeline,
                synth: cdkp.CodePipelineFileSet.fromArtifact(cloudAssemblyArtifact),
            });
            THEN_codePipelineExpectation();
        });
        function THEN_codePipelineExpectation() {
            // THEN
            assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
                Stages: [
                    assertions_1.Match.objectLike({ Name: 'CustomSource' }),
                    assertions_1.Match.objectLike({ Name: 'CustomBuild' }),
                    assertions_1.Match.objectLike({ Name: 'UpdatePipeline' }),
                ],
            });
        }
    });
});
(0, testhelpers_1.behavior)('can add another action to an existing stage', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.stage('Source').addAction(new cpa.GitHubSourceAction({
            actionName: 'GitHub2',
            oauthToken: core_1.SecretValue.unsafePlainText('oops'),
            output: new cp.Artifact(),
            owner: 'OWNER',
            repo: 'REPO',
        }));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.buildPipeline();
        pipeline.pipeline.stages[0].addAction(new cpa.GitHubSourceAction({
            actionName: 'GitHub2',
            oauthToken: core_1.SecretValue.unsafePlainText('oops'),
            output: new cp.Artifact(),
            owner: 'OWNER',
            repo: 'REPO',
        }));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'Source',
                    Actions: [
                        assertions_1.Match.objectLike({ ActionTypeId: assertions_1.Match.objectLike({ Provider: 'GitHub' }) }),
                        assertions_1.Match.objectLike({ ActionTypeId: assertions_1.Match.objectLike({ Provider: 'GitHub' }), Name: 'GitHub2' }),
                    ],
                }]),
        });
    }
});
(0, testhelpers_1.behavior)('assets stage inserted after existing pipeline actions', (suite) => {
    let existingCodePipeline;
    beforeEach(() => {
        existingCodePipeline = new cp.Pipeline(pipelineStack, 'CodePipeline', {
            stages: [
                {
                    stageName: 'CustomSource',
                    actions: [new testhelpers_1.TestGitHubAction(sourceArtifact)],
                },
                {
                    stageName: 'CustomBuild',
                    actions: [cdkp.SimpleSynthAction.standardNpmSynth({ sourceArtifact, cloudAssemblyArtifact })],
                },
            ],
        });
    });
    suite.legacy(() => {
        const pipeline = new cdkp.CdkPipeline(pipelineStack, 'CdkEmptyPipeline', {
            cloudAssemblyArtifact: cloudAssemblyArtifact,
            selfMutating: false,
            codePipeline: existingCodePipeline,
            // No source/build actions
        });
        pipeline.addApplicationStage(new testhelpers_1.FileAssetApp(app, 'App'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new cdkp.CodePipeline(pipelineStack, 'CdkEmptyPipeline', {
            codePipeline: existingCodePipeline,
            selfMutation: false,
            synth: lib_1.CodePipelineFileSet.fromArtifact(cloudAssemblyArtifact),
            // No source/build actions
        });
        pipeline.addStage(new testhelpers_1.FileAssetApp(app, 'App'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: [
                assertions_1.Match.objectLike({ Name: 'CustomSource' }),
                assertions_1.Match.objectLike({ Name: 'CustomBuild' }),
                assertions_1.Match.objectLike({ Name: 'Assets' }),
                assertions_1.Match.objectLike({ Name: 'App' }),
            ],
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNjYXBlLWhhdGNoaW5nLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJlc2NhcGUtaGF0Y2hpbmcudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFzRDtBQUN0RCxnREFBZ0Q7QUFDaEQseURBQXlEO0FBQ3pELDhEQUE4RDtBQUM5RCx3Q0FBbUQ7QUFDbkQsa0NBQWtDO0FBQ2xDLG1DQUFnRDtBQUNoRCxnREFBMko7QUFFM0osSUFBSSxHQUFZLENBQUM7QUFDakIsSUFBSSxhQUFvQixDQUFDO0FBQ3pCLElBQUksY0FBMkIsQ0FBQztBQUNoQyxJQUFJLHFCQUFrQyxDQUFDO0FBQ3ZDLElBQUksWUFBeUIsQ0FBQztBQUU5QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUkscUJBQU8sRUFBRSxDQUFDO0lBQ3BCLGFBQWEsR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLDBCQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLGNBQWMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxxQkFBcUIsR0FBRyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUM1QyxDQUFDLENBQUMsQ0FBQztBQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7SUFDYixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO0lBQ2hELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxZQUFZLEdBQUcsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNoRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsc0JBQVEsRUFBQywyQkFBMkIsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQzlDLEtBQUssQ0FBQyxNQUFN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QTZCLEVBQUU7WUFDckYsTUFBTSxFQUFFO2dCQUNOLGtCQUFLLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxDQUFDO2dCQUMxQyxrQkFBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsQ0FBQztnQkFDekMsa0JBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUM7Z0JBQ3BDLGtCQUFLLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDO2FBQ2xDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztBQUNILENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWF0Y2gsIFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBjcCBmcm9tICcuLi8uLi8uLi9hd3MtY29kZXBpcGVsaW5lJztcbmltcG9ydCAqIGFzIGNwYSBmcm9tICcuLi8uLi8uLi9hd3MtY29kZXBpcGVsaW5lLWFjdGlvbnMnO1xuaW1wb3J0IHsgZGVzY3JpYmVEZXByZWNhdGVkIH0gZnJvbSAnQGF3cy1jZGsvY2RrLWJ1aWxkLXRvb2xzJztcbmltcG9ydCB7IFNlY3JldFZhbHVlLCBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgY2RrcCBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgQ29kZVBpcGVsaW5lRmlsZVNldCB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgeyBiZWhhdmlvciwgRmlsZUFzc2V0QXBwLCBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUsIE1vZGVyblRlc3RHaXRIdWJOcG1QaXBlbGluZSwgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBUZXN0R2l0SHViQWN0aW9uIH0gZnJvbSAnLi4vdGVzdGhlbHBlcnMnO1xuXG5sZXQgYXBwOiBUZXN0QXBwO1xubGV0IHBpcGVsaW5lU3RhY2s6IFN0YWNrO1xubGV0IHNvdXJjZUFydGlmYWN0OiBjcC5BcnRpZmFjdDtcbmxldCBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IGNwLkFydGlmYWN0O1xubGV0IGNvZGVQaXBlbGluZTogY3AuUGlwZWxpbmU7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBhcHAgPSBuZXcgVGVzdEFwcCgpO1xuICBwaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xuICBzb3VyY2VBcnRpZmFjdCA9IG5ldyBjcC5BcnRpZmFjdCgpO1xuICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgPSBuZXcgY3AuQXJ0aWZhY3QoKTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBhcHAuY2xlYW51cCgpO1xufSk7XG5cbmRlc2NyaWJlKCd3aXRoIGVtcHR5IGV4aXN0aW5nIENvZGVQaXBlbGluZScsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY29kZVBpcGVsaW5lID0gbmV3IGNwLlBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDb2RlUGlwZWxpbmUnKTtcbiAgfSk7XG5cbiAgYmVoYXZpb3IoJ2JvdGggYWN0aW9ucyBhcmUgcmVxdWlyZWQnLCAoc3VpdGUpID0+IHtcbiAgICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgbmV3IGNka3AuQ2RrUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHsgY2xvdWRBc3NlbWJseUFydGlmYWN0LCBjb2RlUGlwZWxpbmUgfSk7XG4gICAgICB9KS50b1Rocm93KC9Zb3UgbXVzdCBwYXNzIGEgJ3NvdXJjZUFjdGlvbicvKTtcbiAgICB9KTtcblxuICAgIC8vICdzeW50aCcgaXMgbm90IG9wdGlvbmFsIHNvIHRoaXMgZG9lc24ndCBhcHBseVxuICAgIHN1aXRlLmRvZXNOb3RBcHBseS5tb2Rlcm4oKTtcbiAgfSk7XG5cbiAgYmVoYXZpb3IoJ2NhbiBnaXZlIGJvdGggYWN0aW9ucycsIChzdWl0ZSkgPT4ge1xuICAgIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgY2RrcC5DZGtQaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJywge1xuICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICAgIGNvZGVQaXBlbGluZSxcbiAgICAgICAgc291cmNlQWN0aW9uOiBuZXcgVGVzdEdpdEh1YkFjdGlvbihzb3VyY2VBcnRpZmFjdCksXG4gICAgICAgIHN5bnRoQWN0aW9uOiBjZGtwLlNpbXBsZVN5bnRoQWN0aW9uLnN0YW5kYXJkTnBtU3ludGgoeyBzb3VyY2VBcnRpZmFjdCwgY2xvdWRBc3NlbWJseUFydGlmYWN0IH0pLFxuICAgICAgfSk7XG5cbiAgICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgICB9KTtcblxuICAgIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgY2RrcC5Db2RlUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgICAgY29kZVBpcGVsaW5lLFxuICAgICAgICBzeW50aDogbmV3IGNka3AuU2hlbGxTdGVwKCdTeW50aCcsIHtcbiAgICAgICAgICBpbnB1dDogY2RrcC5Db2RlUGlwZWxpbmVTb3VyY2UuZ2l0SHViKCd0ZXN0L3Rlc3QnLCAnbWFpbicpLFxuICAgICAgICAgIGNvbW1hbmRzOiBbJ3RydWUnXSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICAgIH0pO1xuXG4gICAgZnVuY3Rpb24gVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpIHtcbiAgICAgIC8vIFRIRU5cbiAgICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgICAgU3RhZ2VzOiBbXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTb3VyY2UnIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnQnVpbGQnIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnVXBkYXRlUGlwZWxpbmUnIH0pLFxuICAgICAgICBdLFxuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnd2l0aCBjdXN0b20gU291cmNlIHN0YWdlIGluIGV4aXN0aW5nIFBpcGVsaW5lJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb2RlUGlwZWxpbmUgPSBuZXcgY3AuUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NvZGVQaXBlbGluZScsIHtcbiAgICAgIHN0YWdlczogW1xuICAgICAgICB7XG4gICAgICAgICAgc3RhZ2VOYW1lOiAnQ3VzdG9tU291cmNlJyxcbiAgICAgICAgICBhY3Rpb25zOiBbbmV3IFRlc3RHaXRIdWJBY3Rpb24oc291cmNlQXJ0aWZhY3QpXSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSk7XG4gIH0pO1xuXG4gIGJlaGF2aW9yKCdXb3JrIHdpdGggc3ludGhBY3Rpb24nLCAoc3VpdGUpID0+IHtcbiAgICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgbmV3IGNka3AuQ2RrUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgICAgY29kZVBpcGVsaW5lLFxuICAgICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICAgIHN5bnRoQWN0aW9uOiBjZGtwLlNpbXBsZVN5bnRoQWN0aW9uLnN0YW5kYXJkTnBtU3ludGgoeyBzb3VyY2VBcnRpZmFjdCwgY2xvdWRBc3NlbWJseUFydGlmYWN0IH0pLFxuICAgICAgfSk7XG5cbiAgICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgICB9KTtcblxuICAgIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgICBuZXcgY2RrcC5Db2RlUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgICAgY29kZVBpcGVsaW5lLFxuICAgICAgICBzeW50aDogbmV3IGNka3AuU2hlbGxTdGVwKCdTeW50aCcsIHtcbiAgICAgICAgICBpbnB1dDogY2RrcC5Db2RlUGlwZWxpbmVGaWxlU2V0LmZyb21BcnRpZmFjdChzb3VyY2VBcnRpZmFjdCksXG4gICAgICAgICAgY29tbWFuZHM6IFsndHJ1ZSddLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgICBTdGFnZXM6IFtcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ0N1c3RvbVNvdXJjZScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdCdWlsZCcgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdVcGRhdGVQaXBlbGluZScgfSksXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlRGVwcmVjYXRlZCgnd2l0aCBTb3VyY2UgYW5kIEJ1aWxkIHN0YWdlcyBpbiBleGlzdGluZyBQaXBlbGluZScsICgpID0+IHtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY29kZVBpcGVsaW5lID0gbmV3IGNwLlBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDb2RlUGlwZWxpbmUnLCB7XG4gICAgICBzdGFnZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHN0YWdlTmFtZTogJ0N1c3RvbVNvdXJjZScsXG4gICAgICAgICAgYWN0aW9uczogW25ldyBUZXN0R2l0SHViQWN0aW9uKHNvdXJjZUFydGlmYWN0KV0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBzdGFnZU5hbWU6ICdDdXN0b21CdWlsZCcsXG4gICAgICAgICAgYWN0aW9uczogW2Nka3AuU2ltcGxlU3ludGhBY3Rpb24uc3RhbmRhcmROcG1TeW50aCh7IHNvdXJjZUFydGlmYWN0LCBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgfSldLFxuICAgICAgICB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgYmVoYXZpb3IoJ2NhbiBzdXBwbHkgbm8gYWN0aW9ucycsIChzdWl0ZSkgPT4ge1xuICAgIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBuZXcgY2RrcC5DZGtQaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJywge1xuICAgICAgICBjb2RlUGlwZWxpbmUsXG4gICAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICAgIH0pO1xuXG4gICAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gICAgfSk7XG5cbiAgICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgICAgbmV3IGNka3AuQ29kZVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgICAgIGNvZGVQaXBlbGluZSxcbiAgICAgICAgc3ludGg6IGNka3AuQ29kZVBpcGVsaW5lRmlsZVNldC5mcm9tQXJ0aWZhY3QoY2xvdWRBc3NlbWJseUFydGlmYWN0KSxcbiAgICAgIH0pO1xuXG4gICAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgICAgLy8gVEhFTlxuICAgICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgICBTdGFnZXM6IFtcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ0N1c3RvbVNvdXJjZScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdDdXN0b21CdWlsZCcgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdVcGRhdGVQaXBlbGluZScgfSksXG4gICAgICAgIF0sXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbmJlaGF2aW9yKCdjYW4gYWRkIGFub3RoZXIgYWN0aW9uIHRvIGFuIGV4aXN0aW5nIHN0YWdlJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgcGlwZWxpbmUuc3RhZ2UoJ1NvdXJjZScpLmFkZEFjdGlvbihuZXcgY3BhLkdpdEh1YlNvdXJjZUFjdGlvbih7XG4gICAgICBhY3Rpb25OYW1lOiAnR2l0SHViMicsXG4gICAgICBvYXV0aFRva2VuOiBTZWNyZXRWYWx1ZS51bnNhZmVQbGFpblRleHQoJ29vcHMnKSxcbiAgICAgIG91dHB1dDogbmV3IGNwLkFydGlmYWN0KCksXG4gICAgICBvd25lcjogJ09XTkVSJyxcbiAgICAgIHJlcG86ICdSRVBPJyxcbiAgICB9KSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5idWlsZFBpcGVsaW5lKCk7XG5cbiAgICBwaXBlbGluZS5waXBlbGluZS5zdGFnZXNbMF0uYWRkQWN0aW9uKG5ldyBjcGEuR2l0SHViU291cmNlQWN0aW9uKHtcbiAgICAgIGFjdGlvbk5hbWU6ICdHaXRIdWIyJyxcbiAgICAgIG9hdXRoVG9rZW46IFNlY3JldFZhbHVlLnVuc2FmZVBsYWluVGV4dCgnb29wcycpLFxuICAgICAgb3V0cHV0OiBuZXcgY3AuQXJ0aWZhY3QoKSxcbiAgICAgIG93bmVyOiAnT1dORVInLFxuICAgICAgcmVwbzogJ1JFUE8nLFxuICAgIH0pKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpIHtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgICBTdGFnZXM6IE1hdGNoLmFycmF5V2l0aChbe1xuICAgICAgICBOYW1lOiAnU291cmNlJyxcbiAgICAgICAgQWN0aW9uczogW1xuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBBY3Rpb25UeXBlSWQ6IE1hdGNoLm9iamVjdExpa2UoeyBQcm92aWRlcjogJ0dpdEh1YicgfSkgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IEFjdGlvblR5cGVJZDogTWF0Y2gub2JqZWN0TGlrZSh7IFByb3ZpZGVyOiAnR2l0SHViJyB9KSwgTmFtZTogJ0dpdEh1YjInIH0pLFxuICAgICAgICBdLFxuICAgICAgfV0pLFxuICAgIH0pO1xuICB9XG59KTtcblxuXG5iZWhhdmlvcignYXNzZXRzIHN0YWdlIGluc2VydGVkIGFmdGVyIGV4aXN0aW5nIHBpcGVsaW5lIGFjdGlvbnMnLCAoc3VpdGUpID0+IHtcbiAgbGV0IGV4aXN0aW5nQ29kZVBpcGVsaW5lOiBjcC5QaXBlbGluZTtcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZXhpc3RpbmdDb2RlUGlwZWxpbmUgPSBuZXcgY3AuUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NvZGVQaXBlbGluZScsIHtcbiAgICAgIHN0YWdlczogW1xuICAgICAgICB7XG4gICAgICAgICAgc3RhZ2VOYW1lOiAnQ3VzdG9tU291cmNlJyxcbiAgICAgICAgICBhY3Rpb25zOiBbbmV3IFRlc3RHaXRIdWJBY3Rpb24oc291cmNlQXJ0aWZhY3QpXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHN0YWdlTmFtZTogJ0N1c3RvbUJ1aWxkJyxcbiAgICAgICAgICBhY3Rpb25zOiBbY2RrcC5TaW1wbGVTeW50aEFjdGlvbi5zdGFuZGFyZE5wbVN5bnRoKHsgc291cmNlQXJ0aWZhY3QsIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCB9KV0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pO1xuICB9KTtcblxuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IGNka3AuQ2RrUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0Nka0VtcHR5UGlwZWxpbmUnLCB7XG4gICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3Q6IGNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICAgIHNlbGZNdXRhdGluZzogZmFsc2UsXG4gICAgICBjb2RlUGlwZWxpbmU6IGV4aXN0aW5nQ29kZVBpcGVsaW5lLFxuICAgICAgLy8gTm8gc291cmNlL2J1aWxkIGFjdGlvbnNcbiAgICB9KTtcbiAgICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBGaWxlQXNzZXRBcHAoYXBwLCAnQXBwJykpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IGNka3AuQ29kZVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGtFbXB0eVBpcGVsaW5lJywge1xuICAgICAgY29kZVBpcGVsaW5lOiBleGlzdGluZ0NvZGVQaXBlbGluZSxcbiAgICAgIHNlbGZNdXRhdGlvbjogZmFsc2UsXG4gICAgICBzeW50aDogQ29kZVBpcGVsaW5lRmlsZVNldC5mcm9tQXJ0aWZhY3QoY2xvdWRBc3NlbWJseUFydGlmYWN0KSxcbiAgICAgIC8vIE5vIHNvdXJjZS9idWlsZCBhY3Rpb25zXG4gICAgfSk7XG4gICAgcGlwZWxpbmUuYWRkU3RhZ2UobmV3IEZpbGVBc3NldEFwcChhcHAsICdBcHAnKSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKSB7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBbXG4gICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnQ3VzdG9tU291cmNlJyB9KSxcbiAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdDdXN0b21CdWlsZCcgfSksXG4gICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnQXNzZXRzJyB9KSxcbiAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdBcHAnIH0pLFxuICAgICAgXSxcbiAgICB9KTtcbiAgfVxufSk7XG4iXX0=