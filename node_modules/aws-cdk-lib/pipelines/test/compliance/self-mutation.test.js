"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable import/no-extraneous-dependencies */
const assertions_1 = require("../../../assertions");
const cb = require("../../../aws-codebuild");
const cp = require("../../../aws-codepipeline");
const core_1 = require("../../../core");
const default_codebuild_image_1 = require("../../lib/private/default-codebuild-image");
const testhelpers_1 = require("../testhelpers");
let app;
let pipelineStack;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
});
afterEach(() => {
    app.cleanup();
});
(0, testhelpers_1.behavior)('CodePipeline has self-mutation stage', (suite) => {
    suite.legacy(() => {
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'UpdatePipeline',
                    Actions: [
                        assertions_1.Match.objectLike({
                            Name: 'SelfMutate',
                            Configuration: assertions_1.Match.objectLike({
                                ProjectName: { Ref: assertions_1.Match.anyValue() },
                            }),
                        }),
                    ],
                }]),
        });
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: {
                Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId,
            },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        install: {
                            commands: ['npm install -g aws-cdk@2'],
                        },
                        build: {
                            commands: assertions_1.Match.arrayWith(['cdk -a . deploy PipelineStack --require-approval=never --verbose']),
                        },
                    },
                })),
                Type: 'CODEPIPELINE',
            },
        });
    }
});
(0, testhelpers_1.behavior)('selfmutation stage correctly identifies nested assembly of pipeline stack', (suite) => {
    suite.legacy(() => {
        const pipelineStage = new core_1.Stage(app, 'PipelineStage');
        const nestedPipelineStack = new core_1.Stack(pipelineStage, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
        new testhelpers_1.LegacyTestGitHubNpmPipeline(nestedPipelineStack, 'Cdk');
        THEN_codePipelineExpectation(nestedPipelineStack);
    });
    suite.modern(() => {
        const pipelineStage = new core_1.Stage(app, 'PipelineStage');
        const nestedPipelineStack = new core_1.Stack(pipelineStage, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
        new testhelpers_1.ModernTestGitHubNpmPipeline(nestedPipelineStack, 'Cdk');
        THEN_codePipelineExpectation(nestedPipelineStack);
    });
    function THEN_codePipelineExpectation(nestedPipelineStack) {
        assertions_1.Template.fromStack(nestedPipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: {
                Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId,
            },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        build: {
                            commands: assertions_1.Match.arrayWith(['cdk -a assembly-PipelineStage deploy PipelineStage/PipelineStack --require-approval=never --verbose']),
                        },
                    },
                })),
            },
        });
    }
});
(0, testhelpers_1.behavior)('selfmutation feature can be turned off', (suite) => {
    suite.legacy(() => {
        const cloudAssemblyArtifact = new cp.Artifact();
        // WHEN
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            cloudAssemblyArtifact,
            selfMutating: false,
        });
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        // WHEN
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            selfMutation: false,
        });
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.not(assertions_1.Match.arrayWith([{
                    Name: 'UpdatePipeline',
                    Actions: assertions_1.Match.anyValue(),
                }])),
        });
    }
});
(0, testhelpers_1.behavior)('can control fix/CLI version used in pipeline selfupdate', (suite) => {
    suite.legacy(() => {
        // WHEN
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            pipelineName: 'vpipe',
            cdkCliVersion: '1.2.3',
        });
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            pipelineName: 'vpipe',
            cliVersion: '1.2.3',
        });
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Name: 'vpipe-selfupdate',
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        install: {
                            commands: ['npm install -g aws-cdk@1.2.3'],
                        },
                    },
                })),
            },
        });
    }
});
(0, testhelpers_1.behavior)('Pipeline stack itself can use assets (has implications for selfupdate)', (suite) => {
    suite.legacy(() => {
        // WHEN
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'PrivilegedPipeline', {
            supportDockerAssets: true,
        });
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: {
                PrivilegedMode: true,
            },
        });
    });
    suite.modern(() => {
        // WHEN
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'PrivilegedPipeline', {
            dockerEnabledForSelfMutation: true,
        });
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: {
                PrivilegedMode: true,
            },
        });
    });
});
(0, testhelpers_1.behavior)('self-update project role uses tagged bootstrap-role permissions', (suite) => {
    suite.legacy(() => {
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        THEN_codePipelineExpectations();
    });
    suite.modern(() => {
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        THEN_codePipelineExpectations();
    });
    function THEN_codePipelineExpectations() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::IAM::Policy', {
            PolicyDocument: {
                Statement: assertions_1.Match.arrayWith([
                    {
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Resource: 'arn:*:iam::123pipeline:role/*',
                        Condition: {
                            'ForAnyValue:StringEquals': {
                                'iam:ResourceTag/aws-cdk:bootstrap-role': ['image-publishing', 'file-publishing', 'deploy'],
                            },
                        },
                    },
                    {
                        Action: 'cloudformation:DescribeStacks',
                        Effect: 'Allow',
                        Resource: '*',
                    },
                    {
                        Action: 's3:ListBucket',
                        Effect: 'Allow',
                        Resource: '*',
                    },
                ]),
            },
        });
    }
});
(0, testhelpers_1.behavior)('self-mutation stage can be customized with BuildSpec', (suite) => {
    suite.legacy(() => {
        new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            selfMutationBuildSpec: cb.BuildSpec.fromObject({
                phases: {
                    install: {
                        commands: 'npm config set registry example.com',
                    },
                },
                cache: {
                    paths: 'node_modules',
                },
            }),
        });
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk', {
            selfMutationCodeBuildDefaults: {
                partialBuildSpec: cb.BuildSpec.fromObject({
                    phases: {
                        install: {
                            commands: ['npm config set registry example.com'],
                        },
                    },
                    cache: {
                        paths: ['node_modules'],
                    },
                }),
            },
        });
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodeBuild::Project', {
            Environment: {
                Image: default_codebuild_image_1.CDKP_DEFAULT_CODEBUILD_IMAGE.imageId,
                PrivilegedMode: false,
            },
            Source: {
                BuildSpec: assertions_1.Match.serializedJson(assertions_1.Match.objectLike({
                    phases: {
                        install: {
                            commands: ['npm config set registry example.com', 'npm install -g aws-cdk@2'],
                        },
                        build: {
                            commands: assertions_1.Match.arrayWith(['cdk -a . deploy PipelineStack --require-approval=never --verbose']),
                        },
                    },
                    cache: {
                        paths: ['node_modules'],
                    },
                })),
                Type: 'CODEPIPELINE',
            },
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZi1tdXRhdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VsZi1tdXRhdGlvbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0RBQXNEO0FBQ3RELG9EQUFzRDtBQUN0RCw2Q0FBNkM7QUFDN0MsZ0RBQWdEO0FBQ2hELHdDQUE2QztBQUM3Qyx1RkFBeUY7QUFDekYsZ0RBQTJIO0FBRTNILElBQUksR0FBWSxDQUFDO0FBQ2pCLElBQUksYUFBb0IsQ0FBQztBQUV6QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUkscUJBQU8sRUFBRSxDQUFDO0lBQ3BCLGFBQWEsR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLDBCQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQ3pFLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNoQixDQUFDLENBQUMsQ0FBQztBQUVILElBQUEsc0JBQVEsRUFBQyxzQ0FBc0MsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO0lBQ3pELEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1FBQ2hCLElBQUkseUNBQTJCLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3RELDRCQUE0QixFQUFFLENBQUM7SUFDakMsQ0FBQyxDQUFDLENBQUM7SUFFSCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRTtRQUNoQixJQUFJLHlDQUEyQixDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RCw0QkFBNEIsRUFBRSxDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyw0QkFBNEI7UUFDbkMsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLDZCQUE2QixFQUFF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QUNGLENBQUMsQ0FBQztRQUVILDRCQUE0QixFQUFFLENBQUM7SUFDakMsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLDRCQUE0QjtRQUNuQyxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyx5QkFBeUIsRUFBRTtZQUNqRixXQUFXLEVBQUU7Z0JBQ1gsS0FBSyxFQUFFLHNEQUE0QixDQUFDLE9BQU87Z0JBQzNDLGNBQWMsRUFBRSxLQUFLO2FBQ3RCO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLFNBQVMsRUFBRSxrQkFBSyxDQUFDLGNBQWMsQ0FBQyxrQkFBSyxDQUFDLFVBQVUsQ0FBQztvQkFDL0MsTUFBTSxFQUFFO3dCQUNOLE9BQU8sRUFBRTs0QkFDUCxRQUFRLEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSwwQkFBMEIsQ0FBQzt5QkFDOUU7d0JBQ0QsS0FBSyxFQUFFOzRCQUNMLFFBQVEsRUFBRSxrQkFBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGtFQUFrRSxDQUFDLENBQUM7eUJBQ2hHO3FCQUNGO29CQUNELEtBQUssRUFBRTt3QkFDTCxLQUFLLEVBQUUsQ0FBQyxjQUFjLENBQUM7cUJBQ3hCO2lCQUNGLENBQUMsQ0FBQztnQkFDSCxJQUFJLEVBQUUsY0FBYzthQUNyQjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIGltcG9ydC9uby1leHRyYW5lb3VzLWRlcGVuZGVuY2llcyAqL1xuaW1wb3J0IHsgTWF0Y2gsIFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vYXNzZXJ0aW9ucyc7XG5pbXBvcnQgKiBhcyBjYiBmcm9tICcuLi8uLi8uLi9hd3MtY29kZWJ1aWxkJztcbmltcG9ydCAqIGFzIGNwIGZyb20gJy4uLy4uLy4uL2F3cy1jb2RlcGlwZWxpbmUnO1xuaW1wb3J0IHsgU3RhY2ssIFN0YWdlIH0gZnJvbSAnLi4vLi4vLi4vY29yZSc7XG5pbXBvcnQgeyBDREtQX0RFRkFVTFRfQ09ERUJVSUxEX0lNQUdFIH0gZnJvbSAnLi4vLi4vbGliL3ByaXZhdGUvZGVmYXVsdC1jb2RlYnVpbGQtaW1hZ2UnO1xuaW1wb3J0IHsgYmVoYXZpb3IsIExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZSwgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUgfSBmcm9tICcuLi90ZXN0aGVscGVycyc7XG5cbmxldCBhcHA6IFRlc3RBcHA7XG5sZXQgcGlwZWxpbmVTdGFjazogU3RhY2s7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICBhcHAgPSBuZXcgVGVzdEFwcCgpO1xuICBwaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKGFwcCwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGFwcC5jbGVhbnVwKCk7XG59KTtcblxuYmVoYXZpb3IoJ0NvZGVQaXBlbGluZSBoYXMgc2VsZi1tdXRhdGlvbiBzdGFnZScsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKSB7XG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIE5hbWU6ICdVcGRhdGVQaXBlbGluZScsXG4gICAgICAgIEFjdGlvbnM6IFtcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICAgIE5hbWU6ICdTZWxmTXV0YXRlJyxcbiAgICAgICAgICAgIENvbmZpZ3VyYXRpb246IE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgICAgICBQcm9qZWN0TmFtZTogeyBSZWY6IE1hdGNoLmFueVZhbHVlKCkgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pLFxuICAgICAgICBdLFxuICAgICAgfV0pLFxuICAgIH0pO1xuXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgICBFbnZpcm9ubWVudDoge1xuICAgICAgICBJbWFnZTogQ0RLUF9ERUZBVUxUX0NPREVCVUlMRF9JTUFHRS5pbWFnZUlkLFxuICAgICAgfSxcbiAgICAgIFNvdXJjZToge1xuICAgICAgICBCdWlsZFNwZWM6IE1hdGNoLnNlcmlhbGl6ZWRKc29uKE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgIHBoYXNlczoge1xuICAgICAgICAgICAgaW5zdGFsbDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogWyducG0gaW5zdGFsbCAtZyBhd3MtY2RrQDInXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFsnY2RrIC1hIC4gZGVwbG95IFBpcGVsaW5lU3RhY2sgLS1yZXF1aXJlLWFwcHJvdmFsPW5ldmVyIC0tdmVyYm9zZSddKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgICBUeXBlOiAnQ09ERVBJUEVMSU5FJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcignc2VsZm11dGF0aW9uIHN0YWdlIGNvcnJlY3RseSBpZGVudGlmaWVzIG5lc3RlZCBhc3NlbWJseSBvZiBwaXBlbGluZSBzdGFjaycsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIGNvbnN0IHBpcGVsaW5lU3RhZ2UgPSBuZXcgU3RhZ2UoYXBwLCAnUGlwZWxpbmVTdGFnZScpO1xuICAgIGNvbnN0IG5lc3RlZFBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2socGlwZWxpbmVTdGFnZSwgJ1BpcGVsaW5lU3RhY2snLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xuICAgIG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUobmVzdGVkUGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbihuZXN0ZWRQaXBlbGluZVN0YWNrKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZVN0YWdlID0gbmV3IFN0YWdlKGFwcCwgJ1BpcGVsaW5lU3RhZ2UnKTtcbiAgICBjb25zdCBuZXN0ZWRQaXBlbGluZVN0YWNrID0gbmV3IFN0YWNrKHBpcGVsaW5lU3RhZ2UsICdQaXBlbGluZVN0YWNrJywgeyBlbnY6IFBJUEVMSU5FX0VOViB9KTtcbiAgICBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKG5lc3RlZFBpcGVsaW5lU3RhY2ssICdDZGsnKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24obmVzdGVkUGlwZWxpbmVTdGFjayk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24obmVzdGVkUGlwZWxpbmVTdGFjazogU3RhY2spIHtcbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2sobmVzdGVkUGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICAgIEVudmlyb25tZW50OiB7XG4gICAgICAgIEltYWdlOiBDREtQX0RFRkFVTFRfQ09ERUJVSUxEX0lNQUdFLmltYWdlSWQsXG4gICAgICB9LFxuICAgICAgU291cmNlOiB7XG4gICAgICAgIEJ1aWxkU3BlYzogTWF0Y2guc2VyaWFsaXplZEpzb24oTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFsnY2RrIC1hIGFzc2VtYmx5LVBpcGVsaW5lU3RhZ2UgZGVwbG95IFBpcGVsaW5lU3RhZ2UvUGlwZWxpbmVTdGFjayAtLXJlcXVpcmUtYXBwcm92YWw9bmV2ZXIgLS12ZXJib3NlJ10pLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59KTtcblxuYmVoYXZpb3IoJ3NlbGZtdXRhdGlvbiBmZWF0dXJlIGNhbiBiZSB0dXJuZWQgb2ZmJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgY29uc3QgY2xvdWRBc3NlbWJseUFydGlmYWN0ID0gbmV3IGNwLkFydGlmYWN0KCk7XG4gICAgLy8gV0hFTlxuICAgIG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICAgIHNlbGZNdXRhdGluZzogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIHN1aXRlLm1vZGVybigoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgIHNlbGZNdXRhdGlvbjogZmFsc2UsXG4gICAgfSk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKSB7XG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBNYXRjaC5ub3QoTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIE5hbWU6ICdVcGRhdGVQaXBlbGluZScsXG4gICAgICAgIEFjdGlvbnM6IE1hdGNoLmFueVZhbHVlKCksXG4gICAgICB9XSkpLFxuICAgIH0pO1xuICB9XG59KTtcblxuYmVoYXZpb3IoJ2NhbiBjb250cm9sIGZpeC9DTEkgdmVyc2lvbiB1c2VkIGluIHBpcGVsaW5lIHNlbGZ1cGRhdGUnLCAoc3VpdGUpID0+IHtcbiAgc3VpdGUubGVnYWN5KCgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJywge1xuICAgICAgcGlwZWxpbmVOYW1lOiAndnBpcGUnLFxuICAgICAgY2RrQ2xpVmVyc2lvbjogJzEuMi4zJyxcbiAgICB9KTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgICBwaXBlbGluZU5hbWU6ICd2cGlwZScsXG4gICAgICBjbGlWZXJzaW9uOiAnMS4yLjMnLFxuICAgIH0pO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICAgIE5hbWU6ICd2cGlwZS1zZWxmdXBkYXRlJyxcbiAgICAgIFNvdXJjZToge1xuICAgICAgICBCdWlsZFNwZWM6IE1hdGNoLnNlcmlhbGl6ZWRKc29uKE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgIHBoYXNlczoge1xuICAgICAgICAgICAgaW5zdGFsbDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogWyducG0gaW5zdGFsbCAtZyBhd3MtY2RrQDEuMi4zJ10sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pKSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcignUGlwZWxpbmUgc3RhY2sgaXRzZWxmIGNhbiB1c2UgYXNzZXRzIChoYXMgaW1wbGljYXRpb25zIGZvciBzZWxmdXBkYXRlKScsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBuZXcgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdQcml2aWxlZ2VkUGlwZWxpbmUnLCB7XG4gICAgICBzdXBwb3J0RG9ja2VyQXNzZXRzOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUHJpdmlsZWdlZE1vZGU6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBuZXcgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdQcml2aWxlZ2VkUGlwZWxpbmUnLCB7XG4gICAgICBkb2NrZXJFbmFibGVkRm9yU2VsZk11dGF0aW9uOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUHJpdmlsZWdlZE1vZGU6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5iZWhhdmlvcignc2VsZi11cGRhdGUgcHJvamVjdCByb2xlIHVzZXMgdGFnZ2VkIGJvb3RzdHJhcC1yb2xlIHBlcm1pc3Npb25zJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG5cbiAgICBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9ucygpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb25zKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb25zKCkge1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgICBQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IE1hdGNoLmFycmF5V2l0aChbXG4gICAgICAgICAge1xuICAgICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICAgICAgUmVzb3VyY2U6ICdhcm46KjppYW06OjEyM3BpcGVsaW5lOnJvbGUvKicsXG4gICAgICAgICAgICBDb25kaXRpb246IHtcbiAgICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0VxdWFscyc6IHtcbiAgICAgICAgICAgICAgICAnaWFtOlJlc291cmNlVGFnL2F3cy1jZGs6Ym9vdHN0cmFwLXJvbGUnOiBbJ2ltYWdlLXB1Ymxpc2hpbmcnLCAnZmlsZS1wdWJsaXNoaW5nJywgJ2RlcGxveSddLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIEFjdGlvbjogJ2Nsb3VkZm9ybWF0aW9uOkRlc2NyaWJlU3RhY2tzJyxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFJlc291cmNlOiAnKicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBBY3Rpb246ICdzMzpMaXN0QnVja2V0JyxcbiAgICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICAgIFJlc291cmNlOiAnKicsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSksXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59KTtcblxuXG5iZWhhdmlvcignc2VsZi1tdXRhdGlvbiBzdGFnZSBjYW4gYmUgY3VzdG9taXplZCB3aXRoIEJ1aWxkU3BlYycsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgIHNlbGZNdXRhdGlvbkJ1aWxkU3BlYzogY2IuQnVpbGRTcGVjLmZyb21PYmplY3Qoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBpbnN0YWxsOiB7XG4gICAgICAgICAgICBjb21tYW5kczogJ25wbSBjb25maWcgc2V0IHJlZ2lzdHJ5IGV4YW1wbGUuY29tJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjYWNoZToge1xuICAgICAgICAgIHBhdGhzOiAnbm9kZV9tb2R1bGVzJyxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgIH0pO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBzdWl0ZS5tb2Rlcm4oKCkgPT4ge1xuICAgIG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICAgIHNlbGZNdXRhdGlvbkNvZGVCdWlsZERlZmF1bHRzOiB7XG4gICAgICAgIHBhcnRpYWxCdWlsZFNwZWM6IGNiLkJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICAgIGluc3RhbGw6IHtcbiAgICAgICAgICAgICAgY29tbWFuZHM6IFsnbnBtIGNvbmZpZyBzZXQgcmVnaXN0cnkgZXhhbXBsZS5jb20nXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjYWNoZToge1xuICAgICAgICAgICAgcGF0aHM6IFsnbm9kZV9tb2R1bGVzJ10sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgICAgSW1hZ2U6IENES1BfREVGQVVMVF9DT0RFQlVJTERfSU1BR0UuaW1hZ2VJZCxcbiAgICAgICAgUHJpdmlsZWdlZE1vZGU6IGZhbHNlLFxuICAgICAgfSxcbiAgICAgIFNvdXJjZToge1xuICAgICAgICBCdWlsZFNwZWM6IE1hdGNoLnNlcmlhbGl6ZWRKc29uKE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgIHBoYXNlczoge1xuICAgICAgICAgICAgaW5zdGFsbDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogWyducG0gY29uZmlnIHNldCByZWdpc3RyeSBleGFtcGxlLmNvbScsICducG0gaW5zdGFsbCAtZyBhd3MtY2RrQDInXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgICBjb21tYW5kczogTWF0Y2guYXJyYXlXaXRoKFsnY2RrIC1hIC4gZGVwbG95IFBpcGVsaW5lU3RhY2sgLS1yZXF1aXJlLWFwcHJvdmFsPW5ldmVyIC0tdmVyYm9zZSddKSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBjYWNoZToge1xuICAgICAgICAgICAgcGF0aHM6IFsnbm9kZV9tb2R1bGVzJ10sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSkpLFxuICAgICAgICBUeXBlOiAnQ09ERVBJUEVMSU5FJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn0pO1xuIl19