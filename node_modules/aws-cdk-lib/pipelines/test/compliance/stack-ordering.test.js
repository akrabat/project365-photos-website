"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../../assertions");
const core_1 = require("../../../core");
const testhelpers_1 = require("../testhelpers");
let app;
let pipelineStack;
beforeEach(() => {
    app = new testhelpers_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testhelpers_1.PIPELINE_ENV });
});
(0, testhelpers_1.behavior)('interdependent stacks are in the right order', (suite) => {
    suite.legacy(() => {
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.TwoStackApp(app, 'MyApp'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.TwoStackApp(app, 'MyApp'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'MyApp',
                    Actions: (0, testhelpers_1.sortByRunOrder)([
                        assertions_1.Match.objectLike({ Name: 'Stack1.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'Stack1.Deploy' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Deploy' }),
                    ]),
                }]),
        });
    }
});
(0, testhelpers_1.behavior)('multiple independent stacks go in parallel', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.ThreeStackApp(app, 'MyApp'));
        THEN_codePipelineExpectation();
    });
    suite.modern(() => {
        const pipeline = new testhelpers_1.ModernTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addStage(new testhelpers_1.ThreeStackApp(app, 'MyApp'));
        THEN_codePipelineExpectation();
    });
    function THEN_codePipelineExpectation() {
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'MyApp',
                    Actions: (0, testhelpers_1.sortByRunOrder)([
                        // 1 and 2 in parallel
                        assertions_1.Match.objectLike({ Name: 'Stack1.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'Stack1.Deploy' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Deploy' }),
                        // Then 3
                        assertions_1.Match.objectLike({ Name: 'Stack3.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'Stack3.Deploy' }),
                    ]),
                }]),
        });
    }
});
(0, testhelpers_1.behavior)('user can request manual change set approvals', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.TwoStackApp(app, 'MyApp'), {
            manualApprovals: true,
        });
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'MyApp',
                    Actions: (0, testhelpers_1.sortByRunOrder)([
                        assertions_1.Match.objectLike({ Name: 'Stack1.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'ManualApproval' }),
                        assertions_1.Match.objectLike({ Name: 'Stack1.Deploy' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Prepare' }),
                        assertions_1.Match.objectLike({ Name: 'ManualApproval2' }),
                        assertions_1.Match.objectLike({ Name: 'Stack2.Deploy' }),
                    ]),
                }]),
        });
    });
    // No change set approvals in Modern API for now.
    suite.doesNotApply.modern();
});
(0, testhelpers_1.behavior)('user can request extra runorder space between prepare and deploy', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.TwoStackApp(app, 'MyApp'), {
            extraRunOrderSpace: 1,
        });
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'MyApp',
                    Actions: (0, testhelpers_1.sortByRunOrder)([
                        assertions_1.Match.objectLike({
                            Name: 'Stack1.Prepare',
                            RunOrder: 1,
                        }),
                        assertions_1.Match.objectLike({
                            Name: 'Stack1.Deploy',
                            RunOrder: 3,
                        }),
                        assertions_1.Match.objectLike({
                            Name: 'Stack2.Prepare',
                            RunOrder: 4,
                        }),
                        assertions_1.Match.objectLike({
                            Name: 'Stack2.Deploy',
                            RunOrder: 6,
                        }),
                    ]),
                }]),
        });
    });
    // No change set approvals in Modern API for now.
    suite.doesNotApply.modern();
});
(0, testhelpers_1.behavior)('user can request both manual change set approval and extraRunOrderSpace', (suite) => {
    suite.legacy(() => {
        // WHEN
        const pipeline = new testhelpers_1.LegacyTestGitHubNpmPipeline(pipelineStack, 'Cdk');
        pipeline.addApplicationStage(new testhelpers_1.OneStackApp(app, 'MyApp'), {
            extraRunOrderSpace: 1,
            manualApprovals: true,
        });
        // THEN
        assertions_1.Template.fromStack(pipelineStack).hasResourceProperties('AWS::CodePipeline::Pipeline', {
            Stages: assertions_1.Match.arrayWith([{
                    Name: 'MyApp',
                    Actions: (0, testhelpers_1.sortByRunOrder)([
                        assertions_1.Match.objectLike({
                            Name: 'Stack.Prepare',
                            RunOrder: 1,
                        }),
                        assertions_1.Match.objectLike({
                            Name: 'ManualApproval',
                            RunOrder: 2,
                        }),
                        assertions_1.Match.objectLike({
                            Name: 'Stack.Deploy',
                            RunOrder: 4,
                        }),
                    ]),
                }]),
        });
    });
    // No change set approvals in Modern API for now.
    suite.doesNotApply.modern();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stb3JkZXJpbmcudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YWNrLW9yZGVyaW5nLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREFBc0Q7QUFDdEQsd0NBQTJDO0FBQzNDLGdEQUFvTDtBQUVwTCxJQUFJLEdBQVEsQ0FBQztBQUNiLElBQUksYUFBb0IsQ0FBQztBQUV6QixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUkscUJBQU8sRUFBRSxDQUFDO0lBQ3BCLGFBQWEsR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLDBCQUFZLEVBQUUsQ0FBQyxDQUFDO0FBQ3pFLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBQSxzQkFBUSxFQUFDLDhDQUE4QyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7SUFDakUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDaEIsTUFBTSxRQUFRLEdBQUcsSUFBSSx5Q0FBMkIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkUsUUFBUSxDQUFDLG1CQUFtQixDQUFDLElBQUkseUJBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUU1RCw0QkFBNEIsRUFBRSxDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUFDO0lBRUgsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDaEIsTUFBTSxRQUFRLEdBQUcsSUFBSSx5Q0FBMkIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLHlCQUFXLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFakQsNEJBQTRCLEVBQUUsQ0FBQztJQUNqQyxDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsNEJBQTRCO1FBQ25DLE9BQU87UUFDUCxxQkFBUSxDQUFD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bUIsQ0FBQyxJQUFJLHlCQUFXLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQzFELGtCQUFrQixFQUFFLENBQUM7WUFDckIsZUFBZSxFQUFFLElBQUk7U0FDdEIsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLHFCQUFRLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLDZCQUE2QixFQUFFO1lBQ3JGLE1BQU0sRUFBRSxrQkFBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN2QixJQUFJLEVBQUUsT0FBTztvQkFDYixPQUFPLEVBQUUsSUFBQSw0QkFBYyxFQUFDO3dCQUN0QixrQkFBSyxDQUFDLFVBQVUsQ0FBQzs0QkFDZixJQUFJLEVBQUUsZUFBZTs0QkFDckIsUUFBUSxFQUFFLENBQUM7eUJBQ1osQ0FBQzt3QkFDRixrQkFBSyxDQUFDLFVBQVUsQ0FBQzs0QkFDZixJQUFJLEVBQUUsZ0JBQWdCOzRCQUN0QixRQUFRLEVBQUUsQ0FBQzt5QkFDWixDQUFDO3dCQUNGLGtCQUFLLENBQUMsVUFBVSxDQUFDOzRCQUNmLElBQUksRUFBRSxjQUFjOzRCQUNwQixRQUFRLEVBQUUsQ0FBQzt5QkFDWixDQUFDO3FCQUNILENBQUM7aUJBQ0gsQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxpREFBaUQ7SUFDakQsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUM5QixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1hdGNoLCBUZW1wbGF0ZSB9IGZyb20gJy4uLy4uLy4uL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgQXBwLCBTdGFjayB9IGZyb20gJy4uLy4uLy4uL2NvcmUnO1xuaW1wb3J0IHsgYmVoYXZpb3IsIExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZSwgTW9kZXJuVGVzdEdpdEh1Yk5wbVBpcGVsaW5lLCBPbmVTdGFja0FwcCwgUElQRUxJTkVfRU5WLCBzb3J0QnlSdW5PcmRlciwgVGVzdEFwcCwgVGhyZWVTdGFja0FwcCwgVHdvU3RhY2tBcHAgfSBmcm9tICcuLi90ZXN0aGVscGVycyc7XG5cbmxldCBhcHA6IEFwcDtcbmxldCBwaXBlbGluZVN0YWNrOiBTdGFjaztcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBUZXN0QXBwKCk7XG4gIHBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG59KTtcblxuYmVoYXZpb3IoJ2ludGVyZGVwZW5kZW50IHN0YWNrcyBhcmUgaW4gdGhlIHJpZ2h0IG9yZGVyJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBUd29TdGFja0FwcChhcHAsICdNeUFwcCcpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZFN0YWdlKG5ldyBUd29TdGFja0FwcChhcHAsICdNeUFwcCcpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgZnVuY3Rpb24gVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpIHtcbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBNYXRjaC5hcnJheVdpdGgoW3tcbiAgICAgICAgTmFtZTogJ015QXBwJyxcbiAgICAgICAgQWN0aW9uczogc29ydEJ5UnVuT3JkZXIoW1xuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2sxLlByZXBhcmUnIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2sxLkRlcGxveScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazIuUHJlcGFyZScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazIuRGVwbG95JyB9KSxcbiAgICAgICAgXSksXG4gICAgICB9XSksXG4gICAgfSk7XG4gIH1cbn0pO1xuXG5iZWhhdmlvcignbXVsdGlwbGUgaW5kZXBlbmRlbnQgc3RhY2tzIGdvIGluIHBhcmFsbGVsJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgVGhyZWVTdGFja0FwcChhcHAsICdNeUFwcCcpKTtcblxuICAgIFRIRU5fY29kZVBpcGVsaW5lRXhwZWN0YXRpb24oKTtcbiAgfSk7XG5cbiAgc3VpdGUubW9kZXJuKCgpID0+IHtcbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBNb2Rlcm5UZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZFN0YWdlKG5ldyBUaHJlZVN0YWNrQXBwKGFwcCwgJ015QXBwJykpO1xuXG4gICAgVEhFTl9jb2RlUGlwZWxpbmVFeHBlY3RhdGlvbigpO1xuICB9KTtcblxuICBmdW5jdGlvbiBUSEVOX2NvZGVQaXBlbGluZUV4cGVjdGF0aW9uKCkge1xuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIE5hbWU6ICdNeUFwcCcsXG4gICAgICAgIEFjdGlvbnM6IHNvcnRCeVJ1bk9yZGVyKFtcbiAgICAgICAgICAvLyAxIGFuZCAyIGluIHBhcmFsbGVsXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazEuUHJlcGFyZScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazIuUHJlcGFyZScgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazEuRGVwbG95JyB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMi5EZXBsb3knIH0pLFxuICAgICAgICAgIC8vIFRoZW4gM1xuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2szLlByZXBhcmUnIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2szLkRlcGxveScgfSksXG4gICAgICAgIF0pLFxuICAgICAgfV0pLFxuICAgIH0pO1xuICB9XG59KTtcblxuYmVoYXZpb3IoJ3VzZXIgY2FuIHJlcXVlc3QgbWFudWFsIGNoYW5nZSBzZXQgYXBwcm92YWxzJywgKHN1aXRlKSA9PiB7XG4gIHN1aXRlLmxlZ2FjeSgoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBpcGVsaW5lID0gbmV3IExlZ2FjeVRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgVHdvU3RhY2tBcHAoYXBwLCAnTXlBcHAnKSwge1xuICAgICAgbWFudWFsQXBwcm92YWxzOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIFRlbXBsYXRlLmZyb21TdGFjayhwaXBlbGluZVN0YWNrKS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICAgIFN0YWdlczogTWF0Y2guYXJyYXlXaXRoKFt7XG4gICAgICAgIE5hbWU6ICdNeUFwcCcsXG4gICAgICAgIEFjdGlvbnM6IHNvcnRCeVJ1bk9yZGVyKFtcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMS5QcmVwYXJlJyB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ01hbnVhbEFwcHJvdmFsJyB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMS5EZXBsb3knIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2syLlByZXBhcmUnIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2UoeyBOYW1lOiAnTWFudWFsQXBwcm92YWwyJyB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMi5EZXBsb3knIH0pLFxuICAgICAgICBdKSxcbiAgICAgIH1dKSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgLy8gTm8gY2hhbmdlIHNldCBhcHByb3ZhbHMgaW4gTW9kZXJuIEFQSSBmb3Igbm93LlxuICBzdWl0ZS5kb2VzTm90QXBwbHkubW9kZXJuKCk7XG59KTtcblxuYmVoYXZpb3IoJ3VzZXIgY2FuIHJlcXVlc3QgZXh0cmEgcnVub3JkZXIgc3BhY2UgYmV0d2VlbiBwcmVwYXJlIGFuZCBkZXBsb3knLCAoc3VpdGUpID0+IHtcbiAgc3VpdGUubGVnYWN5KCgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcGlwZWxpbmUgPSBuZXcgTGVnYWN5VGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnKTtcbiAgICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBUd29TdGFja0FwcChhcHAsICdNeUFwcCcpLCB7XG4gICAgICBleHRyYVJ1bk9yZGVyU3BhY2U6IDEsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgVGVtcGxhdGUuZnJvbVN0YWNrKHBpcGVsaW5lU3RhY2spLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgICAgU3RhZ2VzOiBNYXRjaC5hcnJheVdpdGgoW3tcbiAgICAgICAgTmFtZTogJ015QXBwJyxcbiAgICAgICAgQWN0aW9uczogc29ydEJ5UnVuT3JkZXIoW1xuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgICAgTmFtZTogJ1N0YWNrMS5QcmVwYXJlJyxcbiAgICAgICAgICAgIFJ1bk9yZGVyOiAxLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIE1hdGNoLm9iamVjdExpa2Uoe1xuICAgICAgICAgICAgTmFtZTogJ1N0YWNrMS5EZXBsb3knLFxuICAgICAgICAgICAgUnVuT3JkZXI6IDMsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiAnU3RhY2syLlByZXBhcmUnLFxuICAgICAgICAgICAgUnVuT3JkZXI6IDQsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiAnU3RhY2syLkRlcGxveScsXG4gICAgICAgICAgICBSdW5PcmRlcjogNixcbiAgICAgICAgICB9KSxcbiAgICAgICAgXSksXG4gICAgICB9XSksXG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIE5vIGNoYW5nZSBzZXQgYXBwcm92YWxzIGluIE1vZGVybiBBUEkgZm9yIG5vdy5cbiAgc3VpdGUuZG9lc05vdEFwcGx5Lm1vZGVybigpO1xufSk7XG5cbmJlaGF2aW9yKCd1c2VyIGNhbiByZXF1ZXN0IGJvdGggbWFudWFsIGNoYW5nZSBzZXQgYXBwcm92YWwgYW5kIGV4dHJhUnVuT3JkZXJTcGFjZScsIChzdWl0ZSkgPT4ge1xuICBzdWl0ZS5sZWdhY3koKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwaXBlbGluZSA9IG5ldyBMZWdhY3lUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycpO1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IE9uZVN0YWNrQXBwKGFwcCwgJ015QXBwJyksIHtcbiAgICAgIGV4dHJhUnVuT3JkZXJTcGFjZTogMSxcbiAgICAgIG1hbnVhbEFwcHJvdmFsczogdHJ1ZSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBUZW1wbGF0ZS5mcm9tU3RhY2socGlwZWxpbmVTdGFjaykuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgICBTdGFnZXM6IE1hdGNoLmFycmF5V2l0aChbe1xuICAgICAgICBOYW1lOiAnTXlBcHAnLFxuICAgICAgICBBY3Rpb25zOiBzb3J0QnlSdW5PcmRlcihbXG4gICAgICAgICAgTWF0Y2gub2JqZWN0TGlrZSh7XG4gICAgICAgICAgICBOYW1lOiAnU3RhY2suUHJlcGFyZScsXG4gICAgICAgICAgICBSdW5PcmRlcjogMSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICAgIE5hbWU6ICdNYW51YWxBcHByb3ZhbCcsXG4gICAgICAgICAgICBSdW5PcmRlcjogMixcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBNYXRjaC5vYmplY3RMaWtlKHtcbiAgICAgICAgICAgIE5hbWU6ICdTdGFjay5EZXBsb3knLFxuICAgICAgICAgICAgUnVuT3JkZXI6IDQsXG4gICAgICAgICAgfSksXG4gICAgICAgIF0pLFxuICAgICAgfV0pLFxuICAgIH0pO1xuICB9KTtcblxuICAvLyBObyBjaGFuZ2Ugc2V0IGFwcHJvdmFscyBpbiBNb2Rlcm4gQVBJIGZvciBub3cuXG4gIHN1aXRlLmRvZXNOb3RBcHBseS5tb2Rlcm4oKTtcbn0pO1xuIl19