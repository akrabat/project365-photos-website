"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MultiStackApp = exports.PlainStackApp = exports.MegaAssetsApp = exports.DockerAssetApp = exports.TwoFileAssetsApp = exports.FileAssetApp = exports.StageWithStackOutput = exports.stackTemplate = exports.rimraf = exports.BucketStack = exports.ThreeStackApp = exports.TwoStackApp = exports.AppWithOutput = exports.OneStackApp = exports.AppWithExposedStacks = exports.TestApp = exports.PIPELINE_ENV = void 0;
const fs = require("fs");
const path = require("path");
const ecr_assets = require("../../../aws-ecr-assets");
const s3 = require("../../../aws-s3");
const s3_assets = require("../../../aws-s3-assets");
const core_1 = require("../../../core");
const construct_internals_1 = require("../../lib/private/construct-internals");
exports.PIPELINE_ENV = {
    account: '123pipeline',
    region: 'us-pipeline',
};
class TestApp extends core_1.App {
    constructor(props) {
        super({
            context: {
                '@aws-cdk/core:newStyleStackSynthesis': '1',
            },
            stackTraces: false,
            autoSynth: false,
            treeMetadata: false,
            ...props,
        });
    }
    stackArtifact(stackName) {
        if (typeof stackName !== 'string') {
            stackName = stackName.stackName;
        }
        this.synth();
        const supportStack = this.node.findAll().filter(core_1.Stack.isStack).find(s => s.stackName === stackName);
        expect(supportStack).not.toBeUndefined();
        return supportStack;
    }
    cleanup() {
        rimraf((0, construct_internals_1.assemblyBuilderOf)(this).outdir);
    }
}
exports.TestApp = TestApp;
class AppWithExposedStacks extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.stacks = new Array();
        this.stacks.push(new BucketStack(this, 'Stack1'));
        this.stacks.push(new BucketStack(this, 'Stack2'));
        this.stacks.push(new BucketStack(this, 'Stack3'));
    }
}
exports.AppWithExposedStacks = AppWithExposedStacks;
class OneStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        new BucketStack(this, 'Stack');
    }
}
exports.OneStackApp = OneStackApp;
class AppWithOutput extends core_1.Stage {
    constructor(scope, id, props = {}) {
        super(scope, id, props);
        const stack = new BucketStack(this, props.stackId ?? 'Stack');
        this.theOutput = new core_1.CfnOutput(stack, 'MyOutput', { value: stack.bucket.bucketName });
    }
}
exports.AppWithOutput = AppWithOutput;
class TwoStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.stack2 = new BucketStack(this, 'Stack2');
        this.stack1 = new BucketStack(this, 'Stack1');
        if (props?.withDependency ?? true) {
            this.stack2.addDependency(this.stack1);
        }
    }
}
exports.TwoStackApp = TwoStackApp;
/**
 * Three stacks where the last one depends on the earlier 2
 */
class ThreeStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack1 = new BucketStack(this, 'Stack1');
        const stack2 = new BucketStack(this, 'Stack2');
        const stack3 = new BucketStack(this, 'Stack3');
        stack3.addDependency(stack1);
        stack3.addDependency(stack2);
    }
}
exports.ThreeStackApp = ThreeStackApp;
/**
 * A test stack
 *
 * It contains a single Bucket. Such robust. Much uptime.
 */
class BucketStack extends core_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.bucket = new s3.Bucket(this, 'Bucket');
    }
}
exports.BucketStack = BucketStack;
/**
 * rm -rf reimplementation, don't want to depend on an NPM package for this
 */
function rimraf(fsPath) {
    try {
        const isDir = fs.lstatSync(fsPath).isDirectory();
        if (isDir) {
            for (const file of fs.readdirSync(fsPath)) {
                rimraf(path.join(fsPath, file));
            }
            fs.rmdirSync(fsPath);
        }
        else {
            fs.unlinkSync(fsPath);
        }
    }
    catch (e) {
        // We will survive ENOENT
        if (e.code !== 'ENOENT') {
            throw e;
        }
    }
}
exports.rimraf = rimraf;
function stackTemplate(stack) {
    const stage = core_1.Stage.of(stack);
    if (!stage) {
        throw new Error('stack not in a Stage');
    }
    return stage.synth().getStackArtifact(stack.artifactId);
}
exports.stackTemplate = stackTemplate;
class StageWithStackOutput extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new BucketStack(this, 'Stack');
        this.output = new core_1.CfnOutput(stack, 'BucketName', {
            value: stack.bucket.bucketName,
        });
    }
}
exports.StageWithStackOutput = StageWithStackOutput;
class FileAssetApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new s3_assets.Asset(stack, 'Asset', {
            path: path.join(__dirname, 'assets', 'test-file-asset.txt'),
        });
    }
}
exports.FileAssetApp = FileAssetApp;
class TwoFileAssetsApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new s3_assets.Asset(stack, 'Asset1', {
            path: path.join(__dirname, 'assets', 'test-file-asset.txt'),
        });
        new s3_assets.Asset(stack, 'Asset2', {
            path: path.join(__dirname, 'assets', 'test-file-asset-two.txt'),
        });
    }
}
exports.TwoFileAssetsApp = TwoFileAssetsApp;
class DockerAssetApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new ecr_assets.DockerImageAsset(stack, 'Asset', {
            directory: path.join(__dirname, 'assets', 'test-docker-asset'),
        });
    }
}
exports.DockerAssetApp = DockerAssetApp;
// Creates a mix of file and image assets, up to a specified count
class MegaAssetsApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        let assetCount = 0;
        for (; assetCount < props.numAssets / 2; assetCount++) {
            new s3_assets.Asset(stack, `Asset${assetCount}`, {
                path: path.join(__dirname, 'assets', 'test-file-asset.txt'),
                assetHash: `FileAsset${assetCount}`,
            });
        }
        for (; assetCount < props.numAssets; assetCount++) {
            new ecr_assets.DockerImageAsset(stack, `Asset${assetCount}`, {
                directory: path.join(__dirname, 'assets', 'test-docker-asset'),
                extraHash: `FileAsset${assetCount}`,
            });
        }
    }
}
exports.MegaAssetsApp = MegaAssetsApp;
class PlainStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        new BucketStack(this, 'Stack');
    }
}
exports.PlainStackApp = PlainStackApp;
class MultiStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        new BucketStack(this, 'Stack1');
        new BucketStack(this, 'Stack2');
    }
}
exports.MultiStackApp = MultiStackApp;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1hcHAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LWFwcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLHNEQUFzRDtBQUN0RCxzQ0FBc0M7QUFDdEMsb0RBQW9EO0FBQ3BELHdDQUE0RztBQUU1RywrRUFBMEU7QUFFN0QsUUFBQSxZQUFZLEdBQWdCO0lBQ3ZDLE9BQU8sRUFBRSxhQUFhO0lBQ3RCLE1BQU0sRUFBRSxhQUFhO0NBQ3RCLENBQUM7QUFFRixNQUFhLE9BQVEsU0FBUSxVQUFHO0lBQzlCLFlBQVksS0FBeUI7UUFDbkMsS0FBSyxDQUFDO1lBQ0osT0FBTyxFQUFFO2dCQUNQLHNDQUFzQyxFQUFFLEdBQUc7YUFDNUM7WUFDRCxXQUFXLEVBQUUsS0FBSztZQUNsQixTQUFTLEVBQUUsS0FBSztZQUNoQixZQUFZLEVBQUUsS0FBSztZQUNuQixHQUFHLEtBQUs7U0FDVCxDQUFDLENBQUM7S0FDSjtJQUVNLGFBQWEsQ0FBQyxTQUF5QjtRQUM1QyxJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRTtZQUNqQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQztTQUNqQztRQUVELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNiLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLFlBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDO1FBQ3BHLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDekMsT0FBTyxZQUFZLENBQUM7S0FDckI7SUFFTSxPQUFPO1FBQ1osTUFBTSxDQUFDLElBQUEsdUNBQWlCLEVBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFD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Q0FBQyxLQUFLLEVBQUUsUUFBUSxVQUFVLEVBQUUsRUFBRTtnQkFDL0MsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQztnQkFDM0QsU0FBUyxFQUFFLFlBQVksVUFBVSxFQUFFO2FBQ3BDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxVQUFVLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsRUFBRTtZQUNqRCxJQUFJLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsUUFBUSxVQUFVLEVBQUUsRUFBRTtnQkFDM0QsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxtQkFBbUIsQ0FBQztnQkFDOUQsU0FBUyxFQUFFLFlBQVksVUFBVSxFQUFFO2FBQ3BDLENBQUMsQ0FBQztTQUNKO0tBQ0Y7Q0FDRjtBQW5CRCxzQ0FtQkM7QUFFRCxNQUFhLGFBQWMsU0FBUSxZQUFLO0lBQ3RDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDMUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEIsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ2hDO0NBQ0Y7QUFMRCxzQ0FLQztBQUVELE1BQWEsYUFBYyxTQUFRLFlBQUs7SUFDdEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QixJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDaEMsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ2pDO0NBQ0Y7QUFORCxzQ0FNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBlY3JfYXNzZXRzIGZyb20gJy4uLy4uLy4uL2F3cy1lY3ItYXNzZXRzJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJy4uLy4uLy4uL2F3cy1zMyc7XG5pbXBvcnQgKiBhcyBzM19hc3NldHMgZnJvbSAnLi4vLi4vLi4vYXdzLXMzLWFzc2V0cyc7XG5pbXBvcnQgeyBBcHAsIEFwcFByb3BzLCBFbnZpcm9ubWVudCwgQ2ZuT3V0cHV0LCBTdGFnZSwgU3RhZ2VQcm9wcywgU3RhY2ssIFN0YWNrUHJvcHMgfSBmcm9tICcuLi8uLi8uLi9jb3JlJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgYXNzZW1ibHlCdWlsZGVyT2YgfSBmcm9tICcuLi8uLi9saWIvcHJpdmF0ZS9jb25zdHJ1Y3QtaW50ZXJuYWxzJztcblxuZXhwb3J0IGNvbnN0IFBJUEVMSU5FX0VOVjogRW52aXJvbm1lbnQgPSB7XG4gIGFjY291bnQ6ICcxMjNwaXBlbGluZScsXG4gIHJlZ2lvbjogJ3VzLXBpcGVsaW5lJyxcbn07XG5cbmV4cG9ydCBjbGFzcyBUZXN0QXBwIGV4dGVuZHMgQXBwIHtcbiAgY29uc3RydWN0b3IocHJvcHM/OiBQYXJ0aWFsPEFwcFByb3BzPikge1xuICAgIHN1cGVyKHtcbiAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgJ0Bhd3MtY2RrL2NvcmU6bmV3U3R5bGVTdGFja1N5bnRoZXNpcyc6ICcxJyxcbiAgICAgIH0sXG4gICAgICBzdGFja1RyYWNlczogZmFsc2UsXG4gICAgICBhdXRvU3ludGg6IGZhbHNlLFxuICAgICAgdHJlZU1ldGFkYXRhOiBmYWxzZSxcbiAgICAgIC4uLnByb3BzLFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YWNrQXJ0aWZhY3Qoc3RhY2tOYW1lOiBzdHJpbmcgfCBTdGFjaykge1xuICAgIGlmICh0eXBlb2Ygc3RhY2tOYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgc3RhY2tOYW1lID0gc3RhY2tOYW1lLnN0YWNrTmFtZTtcbiAgICB9XG5cbiAgICB0aGlzLnN5bnRoKCk7XG4gICAgY29uc3Qgc3VwcG9ydFN0YWNrID0gdGhpcy5ub2RlLmZpbmRBbGwoKS5maWx0ZXIoU3RhY2suaXNTdGFjaykuZmluZChzID0+IHMuc3RhY2tOYW1lID09PSBzdGFja05hbWUpO1xuICAgIGV4cGVjdChzdXBwb3J0U3RhY2spLm5vdC50b0JlVW5kZWZpbmVkKCk7XG4gICAgcmV0dXJuIHN1cHBvcnRTdGFjaztcbiAgfVxuXG4gIHB1YmxpYyBjbGVhbnVwKCkge1xuICAgIHJpbXJhZihhc3NlbWJseUJ1aWxkZXJPZih0aGlzKS5vdXRkaXIpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBXaXRoRXhwb3NlZFN0YWNrcyBleHRlbmRzIFN0YWdlIHtcbiAgcHVibGljIHJlYWRvbmx5IHN0YWNrczogU3RhY2tbXTtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgdGhpcy5zdGFja3MgPSBuZXcgQXJyYXk8U3RhY2s+KCk7XG4gICAgdGhpcy5zdGFja3MucHVzaChuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrMScpKTtcbiAgICB0aGlzLnN0YWNrcy5wdXNoKG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2syJykpO1xuICAgIHRoaXMuc3RhY2tzLnB1c2gobmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjazMnKSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE9uZVN0YWNrQXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcblxuICAgIG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2snKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcFdpdGhPdXRwdXRQcm9wcyBleHRlbmRzIFN0YWdlUHJvcHMge1xuICByZWFkb25seSBzdGFja0lkPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgQXBwV2l0aE91dHB1dCBleHRlbmRzIFN0YWdlIHtcbiAgcHVibGljIHJlYWRvbmx5IHRoZU91dHB1dDogQ2ZuT3V0cHV0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBcHBXaXRoT3V0cHV0UHJvcHMgPSB7fSkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgcHJvcHMuc3RhY2tJZCA/PyAnU3RhY2snKTtcbiAgICB0aGlzLnRoZU91dHB1dCA9IG5ldyBDZm5PdXRwdXQoc3RhY2ssICdNeU91dHB1dCcsIHsgdmFsdWU6IHN0YWNrLmJ1Y2tldC5idWNrZXROYW1lIH0pO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHdvU3RhY2tBcHBQcm9wcyBleHRlbmRzIFN0YWdlUHJvcHMge1xuICAvKipcbiAgICogQ3JlYXRlIGEgZGVwZW5kZW5jeSBiZXR3ZWVuIHRoZSB0d28gc3RhY2tzXG4gICAqXG4gICAqIEBkZWZhdWx0IHRydWVcbiAgICovXG4gIHJlYWRvbmx5IHdpdGhEZXBlbmRlbmN5PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIFR3b1N0YWNrQXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgc3RhY2sxOiBTdGFjaztcbiAgcHVibGljIHJlYWRvbmx5IHN0YWNrMjogU3RhY2s7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBUd29TdGFja0FwcFByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICB0aGlzLnN0YWNrMiA9IG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2syJyk7XG4gICAgdGhpcy5zdGFjazEgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrMScpO1xuXG4gICAgaWYgKHByb3BzPy53aXRoRGVwZW5kZW5jeSA/PyB0cnVlKSB7XG4gICAgICB0aGlzLnN0YWNrMi5hZGREZXBlbmRlbmN5KHRoaXMuc3RhY2sxKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBUaHJlZSBzdGFja3Mgd2hlcmUgdGhlIGxhc3Qgb25lIGRlcGVuZHMgb24gdGhlIGVhcmxpZXIgMlxuICovXG5leHBvcnQgY2xhc3MgVGhyZWVTdGFja0FwcCBleHRlbmRzIFN0YWdlIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICBjb25zdCBzdGFjazEgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrMScpO1xuICAgIGNvbnN0IHN0YWNrMiA9IG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2syJyk7XG4gICAgY29uc3Qgc3RhY2szID0gbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjazMnKTtcblxuICAgIHN0YWNrMy5hZGREZXBlbmRlbmN5KHN0YWNrMSk7XG4gICAgc3RhY2szLmFkZERlcGVuZGVuY3koc3RhY2syKTtcbiAgfVxufVxuXG4vKipcbiAqIEEgdGVzdCBzdGFja1xuICpcbiAqIEl0IGNvbnRhaW5zIGEgc2luZ2xlIEJ1Y2tldC4gU3VjaCByb2J1c3QuIE11Y2ggdXB0aW1lLlxuICovXG5leHBvcnQgY2xhc3MgQnVja2V0U3RhY2sgZXh0ZW5kcyBTdGFjayB7XG4gIHB1YmxpYyByZWFkb25seSBidWNrZXQ6IHMzLklCdWNrZXQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgdGhpcy5idWNrZXQgPSBuZXcgczMuQnVja2V0KHRoaXMsICdCdWNrZXQnKTtcbiAgfVxufVxuXG5cbi8qKlxuICogcm0gLXJmIHJlaW1wbGVtZW50YXRpb24sIGRvbid0IHdhbnQgdG8gZGVwZW5kIG9uIGFuIE5QTSBwYWNrYWdlIGZvciB0aGlzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByaW1yYWYoZnNQYXRoOiBzdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBpc0RpciA9IGZzLmxzdGF0U3luYyhmc1BhdGgpLmlzRGlyZWN0b3J5KCk7XG5cbiAgICBpZiAoaXNEaXIpIHtcbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmcy5yZWFkZGlyU3luYyhmc1BhdGgpKSB7XG4gICAgICAgIHJpbXJhZihwYXRoLmpvaW4oZnNQYXRoLCBmaWxlKSk7XG4gICAgICB9XG4gICAgICBmcy5ybWRpclN5bmMoZnNQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZnMudW5saW5rU3luYyhmc1BhdGgpO1xuICAgIH1cbiAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgLy8gV2Ugd2lsbCBzdXJ2aXZlIEVOT0VOVFxuICAgIGlmIChlLmNvZGUgIT09ICdFTk9FTlQnKSB7IHRocm93IGU7IH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhY2tUZW1wbGF0ZShzdGFjazogU3RhY2spIHtcbiAgY29uc3Qgc3RhZ2UgPSBTdGFnZS5vZihzdGFjayk7XG4gIGlmICghc3RhZ2UpIHsgdGhyb3cgbmV3IEVycm9yKCdzdGFjayBub3QgaW4gYSBTdGFnZScpOyB9XG4gIHJldHVybiBzdGFnZS5zeW50aCgpLmdldFN0YWNrQXJ0aWZhY3Qoc3RhY2suYXJ0aWZhY3RJZCk7XG59XG5cbmV4cG9ydCBjbGFzcyBTdGFnZVdpdGhTdGFja091dHB1dCBleHRlbmRzIFN0YWdlIHtcbiAgcHVibGljIHJlYWRvbmx5IG91dHB1dDogQ2ZuT3V0cHV0O1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjaycpO1xuXG4gICAgdGhpcy5vdXRwdXQgPSBuZXcgQ2ZuT3V0cHV0KHN0YWNrLCAnQnVja2V0TmFtZScsIHtcbiAgICAgIHZhbHVlOiBzdGFjay5idWNrZXQuYnVja2V0TmFtZSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRmlsZUFzc2V0QXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayh0aGlzLCAnU3RhY2snKTtcbiAgICBuZXcgczNfYXNzZXRzLkFzc2V0KHN0YWNrLCAnQXNzZXQnLCB7XG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXNzZXRzJywgJ3Rlc3QtZmlsZS1hc3NldC50eHQnKSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVHdvRmlsZUFzc2V0c0FwcCBleHRlbmRzIFN0YWdlIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sodGhpcywgJ1N0YWNrJyk7XG4gICAgbmV3IHMzX2Fzc2V0cy5Bc3NldChzdGFjaywgJ0Fzc2V0MScsIHtcbiAgICAgIHBhdGg6IHBhdGguam9pbihfX2Rpcm5hbWUsICdhc3NldHMnLCAndGVzdC1maWxlLWFzc2V0LnR4dCcpLFxuICAgIH0pO1xuICAgIG5ldyBzM19hc3NldHMuQXNzZXQoc3RhY2ssICdBc3NldDInLCB7XG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXNzZXRzJywgJ3Rlc3QtZmlsZS1hc3NldC10d28udHh0JyksXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIERvY2tlckFzc2V0QXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayh0aGlzLCAnU3RhY2snKTtcbiAgICBuZXcgZWNyX2Fzc2V0cy5Eb2NrZXJJbWFnZUFzc2V0KHN0YWNrLCAnQXNzZXQnLCB7XG4gICAgICBkaXJlY3Rvcnk6IHBhdGguam9pbihfX2Rpcm5hbWUsICdhc3NldHMnLCAndGVzdC1kb2NrZXItYXNzZXQnKSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lZ2FBc3NldHNBcHBQcm9wcyBleHRlbmRzIFN0YWdlUHJvcHMge1xuICByZWFkb25seSBudW1Bc3NldHM6IG51bWJlcjtcbn1cblxuLy8gQ3JlYXRlcyBhIG1peCBvZiBmaWxlIGFuZCBpbWFnZSBhc3NldHMsIHVwIHRvIGEgc3BlY2lmaWVkIGNvdW50XG5leHBvcnQgY2xhc3MgTWVnYUFzc2V0c0FwcCBleHRlbmRzIFN0YWdlIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IE1lZ2FBc3NldHNBcHBQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKHRoaXMsICdTdGFjaycpO1xuXG4gICAgbGV0IGFzc2V0Q291bnQgPSAwO1xuICAgIGZvciAoOyBhc3NldENvdW50IDwgcHJvcHMubnVtQXNzZXRzIC8gMjsgYXNzZXRDb3VudCsrKSB7XG4gICAgICBuZXcgczNfYXNzZXRzLkFzc2V0KHN0YWNrLCBgQXNzZXQke2Fzc2V0Q291bnR9YCwge1xuICAgICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXNzZXRzJywgJ3Rlc3QtZmlsZS1hc3NldC50eHQnKSxcbiAgICAgICAgYXNzZXRIYXNoOiBgRmlsZUFzc2V0JHthc3NldENvdW50fWAsXG4gICAgICB9KTtcbiAgICB9XG4gICAgZm9yICg7IGFzc2V0Q291bnQgPCBwcm9wcy5udW1Bc3NldHM7IGFzc2V0Q291bnQrKykge1xuICAgICAgbmV3IGVjcl9hc3NldHMuRG9ja2VySW1hZ2VBc3NldChzdGFjaywgYEFzc2V0JHthc3NldENvdW50fWAsIHtcbiAgICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnYXNzZXRzJywgJ3Rlc3QtZG9ja2VyLWFzc2V0JyksXG4gICAgICAgIGV4dHJhSGFzaDogYEZpbGVBc3NldCR7YXNzZXRDb3VudH1gLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQbGFpblN0YWNrQXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrJyk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIE11bHRpU3RhY2tBcHAgZXh0ZW5kcyBTdGFnZSB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuICAgIG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2sxJyk7XG4gICAgbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjazInKTtcbiAgfVxufVxuIl19