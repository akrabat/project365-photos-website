"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const lambda = require("../lib/lambda");
afterEach(() => {
    jest.clearAllMocks();
});
jest.mock('aws-sdk');
const promiseMock = jest.fn().mockResolvedValue({
    StatusCode: 200,
});
const invokeMock = jest.fn().mockReturnValue({
    promise: promiseMock,
});
AWS.Lambda.mockImplementation(() => ({
    invoke: invokeMock,
}));
jest.useFakeTimers();
const handlerArn = 'arn:aws:lambda:us-east-1:123456789012:function:MyTrigger';
const mockRequest = {
    LogicalResourceId: 'MyTrigger',
    StackId: 'arn:aws:cloudformation:us-east-1:123456789012:stack/MyStack/12345678-1234-1234-1234-123456789012',
    ResponseURL: 'https://cloudformation-custom-resource-response-MyTrigger/',
    ResourceProperties: {
        ServiceToken: 'arn:aws:lambda:us-east-1:123456789012:function:MyFunction',
        HandlerArn: handlerArn,
        Timeout: '600',
        InvocationType: 'Event',
    },
    RequestId: 'MyRequestId',
    ResourceType: 'Custom::Trigger',
    ServiceToken: 'arn:aws:lambda:us-east-1:123456789012:function:MyFunction',
};
test('Create', async () => {
    await lambda.handler({ RequestType: 'Create', ...mockRequest });
    expect(invokeMock).toBeCalledTimes(1);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
test('Update', async () => {
    await lambda.handler({ RequestType: 'Update', PhysicalResourceId: 'PRID', OldResourceProperties: {}, ...mockRequest });
    expect(invokeMock).toBeCalledTimes(1);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
test('Delete - handler not called', async () => {
    await lambda.handler({ RequestType: 'Delete', PhysicalResourceId: 'PRID', ...mockRequest });
    expect(invokeMock).not.toBeCalled();
});
test('non-200 status code throws an error', async () => {
    promiseMock.mockResolvedValueOnce({
        StatusCode: 500,
    });
    await expect(lambda.handler({ RequestType: 'Create', ...mockRequest }))
        .rejects
        .toMatchObject({ message: 'Trigger handler failed with status code 500' });
    expect(invokeMock).toBeCalledTimes(1);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
test('202 status code success', async () => {
    promiseMock.mockResolvedValueOnce({
        StatusCode: 202,
    });
    await lambda.handler(({ RequestType: 'Create', ...mockRequest }));
    expect(invokeMock).toBeCalledTimes(1);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
test('retry with access denied exception', async () => {
    promiseMock.mockImplementationOnce(() => {
        const error = new Error();
        error.code = 'AccessDeniedException';
        throw error;
    });
    const response = lambda.handler({ RequestType: 'Create', ...mockRequest });
    await Promise.resolve().then(() => jest.runAllTimers());
    await response;
    expect(invokeMock).toBeCalledTimes(2);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
test('throws an error for other exceptions', async () => {
    promiseMock.mockImplementationOnce(() => {
        throw new Error();
    });
    await expect(lambda.handler({ RequestType: 'Create', ...mockRequest }))
        .rejects
        .toThrow();
    expect(invokeMock).toBeCalledTimes(1);
    expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
});
describe('function error', () => {
    const makeTest = (payload, expectedError) => {
        return async () => {
            promiseMock.mockResolvedValueOnce({
                StatusCode: 200,
                FunctionError: 'Unhandled',
                Payload: payload,
            });
            await expect(lambda.handler({ RequestType: 'Create', ...mockRequest }))
                .rejects
                .toMatchObject({ message: expectedError });
            expect(invokeMock).toBeCalledTimes(1);
            expect(invokeMock).toBeCalledWith({ FunctionName: handlerArn, InvocationType: 'Event' });
        };
    };
    test('undefined payload', makeTest(undefined, 'unknown handler error'));
    test('empty payload', makeTest('', 'unknown handler error'));
    test('invalid JSON payload', makeTest('{', '{'));
    test('valid JSON payload', makeTest('{"errorMessage": "my error"}', 'my error'));
    test('with stack trace', makeTest('{"errorMessage": "my error", "trace": "my stack trace"}', 'my error\nmy stack trace'));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpZ2dlci1oYW5kbGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmlnZ2VyLWhhbmRsZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQix3Q0FBd0M7QUFFeEMsU0FBUyxDQUFDLEdBQUcsRUFBRTtJQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFckIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO0lBQzlDLFVBQVUsRUFBRSxHQUFHO0NBQ2hCLENBQUMsQ0FBQztBQUVILE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7SUFDM0MsT0FBTyxFQUFFLFdBQVc7Q0FDckIsQ0FBQyxDQUFDO0FBRUYsR0FBRyxDQUFDLE1BQWdDLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM5RCxNQUFNLEVBQUUsVUFBVTtDQUNuQixDQUFDLENBQUMsQ0FBQztBQUVKLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUVyQixNQUFNLFVBQVUsR0FBRywwREFBMEQsQ0FBQztBQUM5RSxNQUFNLFdBQVcsR0FBRztJQUNsQixpQkFBaUIsRUFBRSxXQUFXO0lBQzlCLE9BQU8sRUFBRSxrR0FBa0c7SUFDM0csV0FBVyxFQUFFLDREQUE0RDtJQUN6RSxrQkFBa0IsRUFBRTtRQUNsQixZQUFZLEVBQUUsMkRBQTJEO1FBQ3pFLFVBQVUsRUFBRSxVQUFVO1FBQ3RCLE9BQU8sRUFBRSxLQUFLO1FBQ2QsY0FBYyxFQUFFLE9BQU87S0FDeEI7SUFDRCxTQUFTLEVBQUUsYUFBYTtJQUN4QixZQUFZLEVBQUUsaUJBQWlCO0lBQy9CLFlBQVksRUFBRSwyREFBMkQ7Q0FDMUUsQ0FBQztBQUVGLElB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bXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnLi4vbGliL2xhbWJkYSc7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGplc3QuY2xlYXJBbGxNb2NrcygpO1xufSk7XG5cbmplc3QubW9jaygnYXdzLXNkaycpO1xuXG5jb25zdCBwcm9taXNlTW9jayA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gIFN0YXR1c0NvZGU6IDIwMCxcbn0pO1xuXG5jb25zdCBpbnZva2VNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gIHByb21pc2U6IHByb21pc2VNb2NrLFxufSk7XG5cbihBV1MuTGFtYmRhIGFzIGplc3QuTW9ja2VkQ2xhc3M8YW55PikubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gIGludm9rZTogaW52b2tlTW9jayxcbn0pKTtcblxuamVzdC51c2VGYWtlVGltZXJzKCk7XG5cbmNvbnN0IGhhbmRsZXJBcm4gPSAnYXJuOmF3czpsYW1iZGE6dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjpmdW5jdGlvbjpNeVRyaWdnZXInO1xuY29uc3QgbW9ja1JlcXVlc3QgPSB7XG4gIExvZ2ljYWxSZXNvdXJjZUlkOiAnTXlUcmlnZ2VyJyxcbiAgU3RhY2tJZDogJ2Fybjphd3M6Y2xvdWRmb3JtYXRpb246dXMtZWFzdC0xOjEyMzQ1Njc4OTAxMjpzdGFjay9NeVN0YWNrLzEyMzQ1Njc4LTEyMzQtMTIzNC0xMjM0LTEyMzQ1Njc4OTAxMicsXG4gIFJlc3BvbnNlVVJMOiAnaHR0cHM6Ly9jbG91ZGZvcm1hdGlvbi1jdXN0b20tcmVzb3VyY2UtcmVzcG9uc2UtTXlUcmlnZ2VyLycsXG4gIFJlc291cmNlUHJvcGVydGllczoge1xuICAgIFNlcnZpY2VUb2tlbjogJ2Fybjphd3M6bGFtYmRhOnVzLWVhc3QtMToxMjM0NTY3ODkwMTI6ZnVuY3Rpb246TXlGdW5jdGlvbicsXG4gICAgSGFuZGxlckFybjogaGFuZGxlckFybixcbiAgICBUaW1lb3V0OiAnNjAwJyxcbiAgICBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyxcbiAgfSxcbiAgUmVxdWVzdElkOiAnTXlSZXF1ZXN0SWQnLFxuICBSZXNvdXJjZVR5cGU6ICdDdXN0b206OlRyaWdnZXInLFxuICBTZXJ2aWNlVG9rZW46ICdhcm46YXdzOmxhbWJkYTp1cy1lYXN0LTE6MTIzNDU2Nzg5MDEyOmZ1bmN0aW9uOk15RnVuY3Rpb24nLFxufTtcblxudGVzdCgnQ3JlYXRlJywgYXN5bmMgKCkgPT4ge1xuICBhd2FpdCBsYW1iZGEuaGFuZGxlcih7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJywgLi4ubW9ja1JlcXVlc3QgfSk7XG5cbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRUaW1lcygxKTtcbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRXaXRoKHsgRnVuY3Rpb25OYW1lOiBoYW5kbGVyQXJuLCBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyB9KTtcbn0pO1xuXG50ZXN0KCdVcGRhdGUnLCBhc3luYyAoKSA9PiB7XG4gIGF3YWl0IGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdVcGRhdGUnLCBQaHlzaWNhbFJlc291cmNlSWQ6ICdQUklEJywgT2xkUmVzb3VyY2VQcm9wZXJ0aWVzOiB7fSwgLi4ubW9ja1JlcXVlc3QgfSk7XG5cbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRUaW1lcygxKTtcbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRXaXRoKHsgRnVuY3Rpb25OYW1lOiBoYW5kbGVyQXJuLCBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyB9KTtcbn0pO1xuXG50ZXN0KCdEZWxldGUgLSBoYW5kbGVyIG5vdCBjYWxsZWQnLCBhc3luYyAoKSA9PiB7XG4gIGF3YWl0IGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdEZWxldGUnLCBQaHlzaWNhbFJlc291cmNlSWQ6ICdQUklEJywgLi4ubW9ja1JlcXVlc3QgfSk7XG4gIGV4cGVjdChpbnZva2VNb2NrKS5ub3QudG9CZUNhbGxlZCgpO1xufSk7XG5cbnRlc3QoJ25vbi0yMDAgc3RhdHVzIGNvZGUgdGhyb3dzIGFuIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICBwcm9taXNlTW9jay5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgIFN0YXR1c0NvZGU6IDUwMCxcbiAgfSk7XG5cbiAgYXdhaXQgZXhwZWN0KGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLCAuLi5tb2NrUmVxdWVzdCB9KSlcbiAgICAucmVqZWN0c1xuICAgIC50b01hdGNoT2JqZWN0KHsgbWVzc2FnZTogJ1RyaWdnZXIgaGFuZGxlciBmYWlsZWQgd2l0aCBzdGF0dXMgY29kZSA1MDAnIH0pO1xuXG4gIGV4cGVjdChpbnZva2VNb2NrKS50b0JlQ2FsbGVkVGltZXMoMSk7XG4gIGV4cGVjdChpbnZva2VNb2NrKS50b0JlQ2FsbGVkV2l0aCh7IEZ1bmN0aW9uTmFtZTogaGFuZGxlckFybiwgSW52b2NhdGlvblR5cGU6ICdFdmVudCcgfSk7XG59KTtcblxudGVzdCgnMjAyIHN0YXR1cyBjb2RlIHN1Y2Nlc3MnLCBhc3luYyAoKSA9PiB7XG4gIHByb21pc2VNb2NrLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgU3RhdHVzQ29kZTogMjAyLFxuICB9KTtcblxuICBhd2FpdCBsYW1iZGEuaGFuZGxlcigoeyBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsIC4uLm1vY2tSZXF1ZXN0IH0pKTtcblxuICBleHBlY3QoaW52b2tlTW9jaykudG9CZUNhbGxlZFRpbWVzKDEpO1xuICBleHBlY3QoaW52b2tlTW9jaykudG9CZUNhbGxlZFdpdGgoeyBGdW5jdGlvbk5hbWU6IGhhbmRsZXJBcm4sIEludm9jYXRpb25UeXBlOiAnRXZlbnQnIH0pO1xufSk7XG5cbnRlc3QoJ3JldHJ5IHdpdGggYWNjZXNzIGRlbmllZCBleGNlcHRpb24nLCBhc3luYyAoKSA9PiB7XG4gIHByb21pc2VNb2NrLm1vY2tJbXBsZW1lbnRhdGlvbk9uY2UoKCkgPT4ge1xuICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCk7XG4gICAgKGVycm9yIGFzIEFXUy5BV1NFcnJvcikuY29kZSA9ICdBY2Nlc3NEZW5pZWRFeGNlcHRpb24nO1xuICAgIHRocm93IGVycm9yO1xuICB9KTtcblxuICBjb25zdCByZXNwb25zZSA9IGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLCAuLi5tb2NrUmVxdWVzdCB9KTtcblxuICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGplc3QucnVuQWxsVGltZXJzKCkpO1xuXG4gIGF3YWl0IHJlc3BvbnNlO1xuXG4gIGV4cGVjdChpbnZva2VNb2NrKS50b0JlQ2FsbGVkVGltZXMoMik7XG4gIGV4cGVjdChpbnZva2VNb2NrKS50b0JlQ2FsbGVkV2l0aCh7IEZ1bmN0aW9uTmFtZTogaGFuZGxlckFybiwgSW52b2NhdGlvblR5cGU6ICdFdmVudCcgfSk7XG59KTtcblxudGVzdCgndGhyb3dzIGFuIGVycm9yIGZvciBvdGhlciBleGNlcHRpb25zJywgYXN5bmMgKCkgPT4ge1xuICBwcm9taXNlTW9jay5tb2NrSW1wbGVtZW50YXRpb25PbmNlKCgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgfSk7XG5cbiAgYXdhaXQgZXhwZWN0KGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLCAuLi5tb2NrUmVxdWVzdCB9KSlcbiAgICAucmVqZWN0c1xuICAgIC50b1Rocm93KCk7XG5cbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRUaW1lcygxKTtcbiAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRXaXRoKHsgRnVuY3Rpb25OYW1lOiBoYW5kbGVyQXJuLCBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyB9KTtcbn0pO1xuXG5kZXNjcmliZSgnZnVuY3Rpb24gZXJyb3InLCAoKSA9PiB7XG4gIGNvbnN0IG1ha2VUZXN0ID0gKHBheWxvYWQ6IHN0cmluZyB8IHVuZGVmaW5lZCwgZXhwZWN0ZWRFcnJvcjogc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuIGFzeW5jICgpID0+IHtcbiAgICAgIHByb21pc2VNb2NrLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICAgIFN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgRnVuY3Rpb25FcnJvcjogJ1VuaGFuZGxlZCcsXG4gICAgICAgIFBheWxvYWQ6IHBheWxvYWQsXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgZXhwZWN0KGxhbWJkYS5oYW5kbGVyKHsgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLCAuLi5tb2NrUmVxdWVzdCB9KSlcbiAgICAgICAgLnJlamVjdHNcbiAgICAgICAgLnRvTWF0Y2hPYmplY3QoeyBtZXNzYWdlOiBleHBlY3RlZEVycm9yIH0pO1xuXG4gICAgICBleHBlY3QoaW52b2tlTW9jaykudG9CZUNhbGxlZFRpbWVzKDEpO1xuICAgICAgZXhwZWN0KGludm9rZU1vY2spLnRvQmVDYWxsZWRXaXRoKHsgRnVuY3Rpb25OYW1lOiBoYW5kbGVyQXJuLCBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyB9KTtcbiAgICB9O1xuICB9O1xuXG4gIHRlc3QoJ3VuZGVmaW5lZCBwYXlsb2FkJywgbWFrZVRlc3QodW5kZWZpbmVkLCAndW5rbm93biBoYW5kbGVyIGVycm9yJykpO1xuICB0ZXN0KCdlbXB0eSBwYXlsb2FkJywgbWFrZVRlc3QoJycsICd1bmtub3duIGhhbmRsZXIgZXJyb3InKSk7XG4gIHRlc3QoJ2ludmFsaWQgSlNPTiBwYXlsb2FkJywgbWFrZVRlc3QoJ3snLCAneycpKTtcbiAgdGVzdCgndmFsaWQgSlNPTiBwYXlsb2FkJywgbWFrZVRlc3QoJ3tcImVycm9yTWVzc2FnZVwiOiBcIm15IGVycm9yXCJ9JywgJ215IGVycm9yJykpO1xuICB0ZXN0KCd3aXRoIHN0YWNrIHRyYWNlJywgbWFrZVRlc3QoJ3tcImVycm9yTWVzc2FnZVwiOiBcIm15IGVycm9yXCIsIFwidHJhY2VcIjogXCJteSBzdGFjayB0cmFjZVwifScsICdteSBlcnJvclxcbm15IHN0YWNrIHRyYWNlJykpO1xufSk7XG4iXX0=