"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assertions_1 = require("../../assertions");
const lambda = require("../../aws-lambda");
const sns = require("../../aws-sns");
const core_1 = require("../../core");
const triggers = require("../lib");
test('minimal trigger function', () => {
    // GIVEN
    const stack = new core_1.Stack();
    // WHEN
    new triggers.TriggerFunction(stack, 'MyTrigger', {
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('foo'),
    });
    // THEN
    const template = assertions_1.Template.fromStack(stack);
    template.hasResourceProperties('AWS::Lambda::Function', {});
    template.hasResourceProperties('Custom::Trigger', {
        HandlerArn: { Ref: 'MyTriggerCurrentVersion8802742B555ea1a8a066d494bd9b85921db605fb' },
    });
});
test('before/after', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const topic1 = new sns.Topic(stack, 'Topic1');
    const topic2 = new sns.Topic(stack, 'Topic2');
    const topic3 = new sns.Topic(stack, 'Topic3');
    const topic4 = new sns.Topic(stack, 'Topic4');
    // WHEN
    const myTrigger = new triggers.TriggerFunction(stack, 'MyTrigger', {
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('zoo'),
        handler: 'index.handler',
        // through props
        executeAfter: [topic1],
        executeBefore: [topic3],
    });
    // through methods
    myTrigger.executeBefore(topic4);
    myTrigger.executeAfter(topic2);
    // THEN
    const triggerId = 'MyTrigger5A0C728D';
    const topic1Id = 'Topic198E71B3E';
    const topic2Id = 'Topic269377B75';
    const topic3Id = 'Topic3DEAE47A7';
    const topic4Id = 'Topic4F5C0CEE2';
    const template = assertions_1.Template.fromStack(stack);
    const resources = template.toJSON().Resources;
    const dependsOn = (sourceId, targetId) => {
        expect(resources[sourceId].DependsOn).toContain(targetId);
    };
    dependsOn(triggerId, topic1Id);
    dependsOn(triggerId, topic2Id);
    dependsOn(topic3Id, triggerId);
    dependsOn(topic4Id, triggerId);
});
test('multiple functions', () => {
    // GIVEN
    const stack = new core_1.Stack();
    // WHEN
    new triggers.TriggerFunction(stack, 'MyTrigger', {
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('foo'),
    });
    new triggers.TriggerFunction(stack, 'MySecondTrigger', {
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('bar'),
    });
    // THEN
    const template = assertions_1.Template.fromStack(stack);
    const roles = template.findResources('AWS::IAM::Role');
    const triggerIamRole = roles.AWSCDKTriggerCustomResourceProviderCustomResourceProviderRoleE18FAF0A;
    expect(triggerIamRole.Properties.Policies[0].PolicyDocument.Statement.length).toBe(2);
});
test('minimal trigger', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const func = new lambda.Function(stack, 'MyFunction', {
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('foo'),
    });
    // WHEN
    new triggers.Trigger(stack, 'MyTrigger', {
        handler: func,
    });
    // THEN
    const template = assertions_1.Template.fromStack(stack);
    template.hasResourceProperties('AWS::Lambda::Function', {});
    template.hasResourceProperties('Custom::Trigger', {
        HandlerArn: { Ref: 'MyFunctionCurrentVersion197490AF2e4e06d52af2bb609d8c23243d665966' },
    });
});
test('trigger with optional properties', () => {
    // GIVEN
    const stack = new core_1.Stack();
    const func = new lambda.Function(stack, 'MyFunction', {
        handler: 'index.handler',
        runtime: lambda.Runtime.NODEJS_14_X,
        code: lambda.Code.fromInline('foo'),
    });
    // WHEN
    new triggers.Trigger(stack, 'MyTrigger', {
        handler: func,
        timeout: core_1.Duration.minutes(10),
        invocationType: triggers.InvocationType.EVENT,
    });
    // THEN
    const template = assertions_1.Template.fromStack(stack);
    template.hasResourceProperties('AWS::Lambda::Function', {});
    template.hasResourceProperties('Custom::Trigger', {
        HandlerArn: { Ref: 'MyFunctionCurrentVersion197490AF2e4e06d52af2bb609d8c23243d665966' },
        Timeout: '600000',
        InvocationType: 'Event',
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpZ2dlcnMudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRyaWdnZXJzLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBNEM7QUFDNUMsMkNBQTJDO0FBQzNDLHFDQUFxQztBQUNyQyxxQ0FBNkM7QUFDN0MsbUNBQW1DO0FBRW5DLElBQUksQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7SUFDcEMsUUFBUTtJQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksWUFBSyxFQUFFLENBQUM7SUFFMUIsT0FBTztJQUNQLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO1FBQy9DLE9BQU8sRUFBRSxlQUFlO1FBQ3hCLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7UUFDbkMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztLQUNwQyxDQUFDLENBQUM7SUFFSCxPQUFPO0lBQ1AsTUFBTSxRQUFRLEdBQUcscUJBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0MsUUFBUSxDQUFDLHFCQUFxQixDQUFDLHVCQUF1QixFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzVELFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsRUFBRTtRQUNoRCxVQUFVLEVBQUUsRUFBRSxHQUFHLEVBQUUsaUVBQWlFLEVBQUU7S0FDdkYsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUN4QixRQUFRO0lBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSSxZQUFLLEVBQUUsQ0FBQztJQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FB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LENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRTtRQUNwRCxPQUFPLEVBQUUsZUFBZTtRQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1FBQ25DLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7S0FDcEMsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFO1FBQ3ZDLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFLGVBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQzdCLGNBQWMsRUFBRSxRQUFRLENBQUMsY0FBYyxDQUFDLEtBQUs7S0FDOUMsQ0FBQyxDQUFDO0lBRUgsT0FBTztJQUNQLE1BQU0sUUFBUSxHQUFHLHFCQUFRLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzNDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQyx1QkFBdUIsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM1RCxRQUFRLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLEVBQUU7UUFDaEQsVUFBVSxFQUFFLEVBQUUsR0FBRyxFQUFFLGtFQUFrRSxFQUFFO1FBQ3ZGLE9BQU8sRUFBRSxRQUFRO1FBQ2pCLGNBQWMsRUFBRSxPQUFPO0tBQ3hCLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuLi8uLi9hc3NlcnRpb25zJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICcuLi8uLi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIHNucyBmcm9tICcuLi8uLi9hd3Mtc25zJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjayB9IGZyb20gJy4uLy4uL2NvcmUnO1xuaW1wb3J0ICogYXMgdHJpZ2dlcnMgZnJvbSAnLi4vbGliJztcblxudGVzdCgnbWluaW1hbCB0cmlnZ2VyIGZ1bmN0aW9uJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIC8vIFdIRU5cbiAgbmV3IHRyaWdnZXJzLlRyaWdnZXJGdW5jdGlvbihzdGFjaywgJ015VHJpZ2dlcicsIHtcbiAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZm9vJyksXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgY29uc3QgdGVtcGxhdGUgPSBUZW1wbGF0ZS5mcm9tU3RhY2soc3RhY2spO1xuICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0FXUzo6TGFtYmRhOjpGdW5jdGlvbicsIHt9KTtcbiAgdGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdDdXN0b206OlRyaWdnZXInLCB7XG4gICAgSGFuZGxlckFybjogeyBSZWY6ICdNeVRyaWdnZXJDdXJyZW50VmVyc2lvbjg4MDI3NDJCNTU1ZWExYThhMDY2ZDQ5NGJkOWI4NTkyMWRiNjA1ZmInIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ2JlZm9yZS9hZnRlcicsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKTtcbiAgY29uc3QgdG9waWMxID0gbmV3IHNucy5Ub3BpYyhzdGFjaywgJ1RvcGljMScpO1xuICBjb25zdCB0b3BpYzIgPSBuZXcgc25zLlRvcGljKHN0YWNrLCAnVG9waWMyJyk7XG4gIGNvbnN0IHRvcGljMyA9IG5ldyBzbnMuVG9waWMoc3RhY2ssICdUb3BpYzMnKTtcbiAgY29uc3QgdG9waWM0ID0gbmV3IHNucy5Ub3BpYyhzdGFjaywgJ1RvcGljNCcpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgbXlUcmlnZ2VyID0gbmV3IHRyaWdnZXJzLlRyaWdnZXJGdW5jdGlvbihzdGFjaywgJ015VHJpZ2dlcicsIHtcbiAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tSW5saW5lKCd6b28nKSxcbiAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG5cbiAgICAvLyB0aHJvdWdoIHByb3BzXG4gICAgZXhlY3V0ZUFmdGVyOiBbdG9waWMxXSxcbiAgICBleGVjdXRlQmVmb3JlOiBbdG9waWMzXSxcbiAgfSk7XG5cbiAgLy8gdGhyb3VnaCBtZXRob2RzXG4gIG15VHJpZ2dlci5leGVjdXRlQmVmb3JlKHRvcGljNCk7XG4gIG15VHJpZ2dlci5leGVjdXRlQWZ0ZXIodG9waWMyKTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IHRyaWdnZXJJZCA9ICdNeVRyaWdnZXI1QTBDNzI4RCc7XG4gIGNvbnN0IHRvcGljMUlkID0gJ1RvcGljMTk4RTcxQjNFJztcbiAgY29uc3QgdG9waWMySWQgPSAnVG9waWMyNjkzNzdCNzUnO1xuICBjb25zdCB0b3BpYzNJZCA9ICdUb3BpYzNERUFFNDdBNyc7XG4gIGNvbnN0IHRvcGljNElkID0gJ1RvcGljNEY1QzBDRUUyJztcblxuICBjb25zdCB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjayk7XG4gIGNvbnN0IHJlc291cmNlcyA9IHRlbXBsYXRlLnRvSlNPTigpLlJlc291cmNlcztcblxuICBjb25zdCBkZXBlbmRzT24gPSAoc291cmNlSWQ6IHN0cmluZywgdGFyZ2V0SWQ6IHN0cmluZykgPT4ge1xuICAgIGV4cGVjdChyZXNvdXJjZXNbc291cmNlSWRdLkRlcGVuZHNPbikudG9Db250YWluKHRhcmdldElkKTtcbiAgfTtcblxuICBkZXBlbmRzT24odHJpZ2dlcklkLCB0b3BpYzFJZCk7XG4gIGRlcGVuZHNPbih0cmlnZ2VySWQsIHRvcGljMklkKTtcbiAgZGVwZW5kc09uKHRvcGljM0lkLCB0cmlnZ2VySWQpO1xuICBkZXBlbmRzT24odG9waWM0SWQsIHRyaWdnZXJJZCk7XG59KTtcblxudGVzdCgnbXVsdGlwbGUgZnVuY3Rpb25zJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuXG4gIC8vIFdIRU5cbiAgbmV3IHRyaWdnZXJzLlRyaWdnZXJGdW5jdGlvbihzdGFjaywgJ015VHJpZ2dlcicsIHtcbiAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZm9vJyksXG4gIH0pO1xuXG4gIG5ldyB0cmlnZ2Vycy5UcmlnZ2VyRnVuY3Rpb24oc3RhY2ssICdNeVNlY29uZFRyaWdnZXInLCB7XG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2JhcicpLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IHRlbXBsYXRlID0gVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKTtcbiAgY29uc3Qgcm9sZXMgPSB0ZW1wbGF0ZS5maW5kUmVzb3VyY2VzKCdBV1M6OklBTTo6Um9sZScpO1xuICBjb25zdCB0cmlnZ2VySWFtUm9sZSA9IHJvbGVzLkFXU0NES1RyaWdnZXJDdXN0b21SZXNvdXJjZVByb3ZpZGVyQ3VzdG9tUmVzb3VyY2VQcm92aWRlclJvbGVFMThGQUYwQTtcbiAgZXhwZWN0KHRyaWdnZXJJYW1Sb2xlLlByb3BlcnRpZXMuUG9saWNpZXNbMF0uUG9saWN5RG9jdW1lbnQuU3RhdGVtZW50Lmxlbmd0aCkudG9CZSgyKTtcbn0pO1xuXG50ZXN0KCdtaW5pbWFsIHRyaWdnZXInLCAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCk7XG4gIGNvbnN0IGZ1bmMgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHN0YWNrLCAnTXlGdW5jdGlvbicsIHtcbiAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE0X1gsXG4gICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUlubGluZSgnZm9vJyksXG4gIH0pO1xuXG4gIC8vIFdIRU5cbiAgbmV3IHRyaWdnZXJzLlRyaWdnZXIoc3RhY2ssICdNeVRyaWdnZXInLCB7XG4gICAgaGFuZGxlcjogZnVuYyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBjb25zdCB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjayk7XG4gIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQVdTOjpMYW1iZGE6OkZ1bmN0aW9uJywge30pO1xuICB0ZW1wbGF0ZS5oYXNSZXNvdXJjZVByb3BlcnRpZXMoJ0N1c3RvbTo6VHJpZ2dlcicsIHtcbiAgICBIYW5kbGVyQXJuOiB7IFJlZjogJ015RnVuY3Rpb25DdXJyZW50VmVyc2lvbjE5NzQ5MEFGMmU0ZTA2ZDUyYWYyYmI2MDlkOGMyMzI0M2Q2NjU5NjYnIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ3RyaWdnZXIgd2l0aCBvcHRpb25hbCBwcm9wZXJ0aWVzJywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpO1xuICBjb25zdCBmdW5jID0gbmV3IGxhbWJkYS5GdW5jdGlvbihzdGFjaywgJ015RnVuY3Rpb24nLCB7XG4gICAgaGFuZGxlcjogJ2luZGV4LmhhbmRsZXInLFxuICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNF9YLFxuICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21JbmxpbmUoJ2ZvbycpLFxuICB9KTtcblxuICAvLyBXSEVOXG4gIG5ldyB0cmlnZ2Vycy5UcmlnZ2VyKHN0YWNrLCAnTXlUcmlnZ2VyJywge1xuICAgIGhhbmRsZXI6IGZ1bmMsXG4gICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxMCksXG4gICAgaW52b2NhdGlvblR5cGU6IHRyaWdnZXJzLkludm9jYXRpb25UeXBlLkVWRU5ULFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGNvbnN0IHRlbXBsYXRlID0gVGVtcGxhdGUuZnJvbVN0YWNrKHN0YWNrKTtcbiAgdGVtcGxhdGUuaGFzUmVzb3VyY2VQcm9wZXJ0aWVzKCdBV1M6OkxhbWJkYTo6RnVuY3Rpb24nLCB7fSk7XG4gIHRlbXBsYXRlLmhhc1Jlc291cmNlUHJvcGVydGllcygnQ3VzdG9tOjpUcmlnZ2VyJywge1xuICAgIEhhbmRsZXJBcm46IHsgUmVmOiAnTXlGdW5jdGlvbkN1cnJlbnRWZXJzaW9uMTk3NDkwQUYyZTRlMDZkNTJhZjJiYjYwOWQ4YzIzMjQzZDY2NTk2NicgfSxcbiAgICBUaW1lb3V0OiAnNjAwMDAwJyxcbiAgICBJbnZvY2F0aW9uVHlwZTogJ0V2ZW50JyxcbiAgfSk7XG59KTtcbiJdfQ==