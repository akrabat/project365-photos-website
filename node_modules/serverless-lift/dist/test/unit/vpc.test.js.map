{
  "version": 3,
  "sources": ["../../../test/unit/vpc.test.ts"],
  "sourcesContent": ["import { cloneDeep, get, merge } from \"lodash\";\nimport type { AwsCfInstruction } from \"@serverless/typescript\";\nimport { baseConfig, pluginConfigExt, runServerless } from \"../utils/runServerless\";\nimport ServerlessError from \"../../src/utils/error\";\n\ndescribe(\"vpc\", () => {\n    it(\"should put Lambda functions in the VPC\", async () => {\n        const { cfTemplate, computeLogicalId } = await runServerless({\n            fixture: \"vpc\",\n            configExt: pluginConfigExt,\n            command: \"package\",\n        });\n\n        const vpcConfig = get(cfTemplate.Resources.FooLambdaFunction, \"Properties.VpcConfig\") as Record<\n            string,\n            unknown\n        >;\n        expect(vpcConfig).toHaveProperty(\"SecurityGroupIds\");\n        expect((vpcConfig.SecurityGroupIds as AwsCfInstruction[])[0]).toMatchObject({\n            \"Fn::GetAtt\": [computeLogicalId(\"vpc\", \"AppSecurityGroup\"), \"GroupId\"],\n        });\n        expect(vpcConfig).toHaveProperty(\"SubnetIds\");\n        expect(vpcConfig.SubnetIds).toContainEqual({\n            Ref: computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"Subnet\"),\n        });\n        expect(vpcConfig.SubnetIds).toContainEqual({\n            Ref: computeLogicalId(\"vpc\", \"PrivateSubnet2\", \"Subnet\"),\n        });\n    });\n    it(\"throws an error when using the construct twice\", async () => {\n        expect.assertions(2);\n\n        try {\n            await runServerless({\n                config: merge({}, baseConfig, {\n                    constructs: {\n                        vpc1: {\n                            type: \"vpc\",\n                        },\n                        vpc2: {\n                            type: \"vpc\",\n                        },\n                    },\n                }),\n                command: \"package\",\n            });\n        } catch (error) {\n            expect(error).toBeInstanceOf(ServerlessError);\n            expect(error).toHaveProperty(\"code\", \"LIFT_ONLY_ONE_VPC\");\n        }\n    });\n    it(\"throws an error when there is an existing VPC config\", async () => {\n        expect.assertions(2);\n\n        try {\n            await runServerless({\n                fixture: \"vpc\",\n                configExt: merge({}, pluginConfigExt, {\n                    provider: {\n                        name: \"aws\",\n                        vpc: {\n                            securityGroupIds: [\"sg-00000000000000000\"],\n                            subnetIds: [\"subnet-01234567899999999\", \"subnet-00000000099999999\"],\n                        },\n                    },\n                }),\n                command: \"package\",\n            });\n        } catch (error) {\n            expect(error).toBeInstanceOf(ServerlessError);\n            expect(error).toHaveProperty(\"code\", \"LIFT_ONLY_ONE_VPC\");\n        }\n    });\n    it(\"should create all required resources\", async () => {\n        const { cfTemplate, computeLogicalId } = await runServerless({\n            fixture: \"vpc\",\n            configExt: cloneDeep(pluginConfigExt),\n            command: \"package\",\n        });\n\n        const vpcId = computeLogicalId(\"vpc\");\n        const securityGroupId = computeLogicalId(\"vpc\", \"AppSecurityGroup\");\n\n        expect(Object.keys(cfTemplate.Resources)).toStrictEqual([\n            \"ServerlessDeploymentBucket\",\n            \"ServerlessDeploymentBucketPolicy\",\n            \"FooLogGroup\",\n            \"IamRoleLambdaExecution\",\n            \"FooLambdaFunction\",\n\n            // VPC\n            vpcId,\n\n            // Public Subnet 1\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"Subnet\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"RouteTable\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"RouteTableAssociation\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"DefaultRoute\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"EIP\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet1\", \"NATGateway\"),\n\n            // Public Subnet 2\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"Subnet\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"RouteTable\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"RouteTableAssociation\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"DefaultRoute\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"EIP\"),\n            computeLogicalId(\"vpc\", \"PublicSubnet2\", \"NATGateway\"),\n\n            // Private Subnet 1\n            computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"Subnet\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"RouteTable\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"RouteTableAssociation\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"DefaultRoute\"),\n\n            // Private Subnet 2\n            computeLogicalId(\"vpc\", \"PrivateSubnet2\", \"Subnet\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet2\", \"RouteTable\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet2\", \"RouteTableAssociation\"),\n            computeLogicalId(\"vpc\", \"PrivateSubnet2\", \"DefaultRoute\"),\n\n            // Internet Gateway\n            computeLogicalId(\"vpc\", \"IGW\"),\n            computeLogicalId(\"vpc\", \"VPCGW\"),\n\n            // Security Group\n            securityGroupId,\n        ]);\n\n        expect(cfTemplate.Resources[vpcId]).toStrictEqual({\n            Type: \"AWS::EC2::VPC\",\n            Properties: {\n                CidrBlock: \"10.0.0.0/16\",\n                EnableDnsHostnames: true,\n                EnableDnsSupport: true,\n                InstanceTenancy: \"default\",\n                Tags: [{ Key: \"Name\", Value: \"Default/vpc\" }],\n            },\n        });\n\n        expect(cfTemplate.Resources[computeLogicalId(\"vpc\", \"PublicSubnet1\", \"Subnet\")]).toStrictEqual({\n            Type: \"AWS::EC2::Subnet\",\n            Properties: {\n                AvailabilityZone: { \"Fn::Select\": [0, { \"Fn::GetAZs\": \"\" }] },\n                CidrBlock: \"10.0.0.0/18\",\n                MapPublicIpOnLaunch: true,\n                Tags: [\n                    { Key: \"aws-cdk:subnet-name\", Value: \"Public\" },\n                    { Key: \"aws-cdk:subnet-type\", Value: \"Public\" },\n                    { Key: \"Name\", Value: \"Default/vpc/PublicSubnet1\" },\n                ],\n                VpcId: { Ref: vpcId },\n            },\n        });\n\n        expect(cfTemplate.Resources[computeLogicalId(\"vpc\", \"PublicSubnet1\", \"RouteTable\")]).toStrictEqual({\n            Type: \"AWS::EC2::RouteTable\",\n            Properties: {\n                VpcId: { Ref: vpcId },\n                Tags: [{ Key: \"Name\", Value: \"Default/vpc/PublicSubnet1\" }],\n            },\n        });\n\n        expect(cfTemplate.Resources[computeLogicalId(\"vpc\", \"PublicSubnet1\", \"NATGateway\")]).toStrictEqual({\n            Type: \"AWS::EC2::NatGateway\",\n            DependsOn: [\n                computeLogicalId(\"vpc\", \"PublicSubnet1\", \"DefaultRoute\"),\n                computeLogicalId(\"vpc\", \"PublicSubnet1\", \"RouteTableAssociation\"),\n            ],\n            Properties: {\n                AllocationId: { \"Fn::GetAtt\": [computeLogicalId(\"vpc\", \"PublicSubnet1\", \"EIP\"), \"AllocationId\"] },\n                SubnetId: { Ref: computeLogicalId(\"vpc\", \"PublicSubnet1\", \"Subnet\") },\n                Tags: [{ Key: \"Name\", Value: \"Default/vpc/PublicSubnet1\" }],\n            },\n        });\n\n        expect(cfTemplate.Resources[computeLogicalId(\"vpc\", \"PrivateSubnet1\", \"Subnet\")]).toStrictEqual({\n            Type: \"AWS::EC2::Subnet\",\n            Properties: {\n                VpcId: { Ref: vpcId },\n                AvailabilityZone: { \"Fn::Select\": [0, { \"Fn::GetAZs\": \"\" }] },\n                CidrBlock: \"10.0.128.0/18\",\n                MapPublicIpOnLaunch: false,\n                Tags: [\n                    { Key: \"aws-cdk:subnet-name\", Value: \"Private\" },\n                    { Key: \"aws-cdk:subnet-type\", Value: \"Private\" },\n                    { Key: \"Name\", Value: \"Default/vpc/PrivateSubnet1\" },\n                ],\n            },\n        });\n\n        expect(cfTemplate.Resources[securityGroupId]).toMatchObject({\n            Type: \"AWS::EC2::SecurityGroup\",\n            Properties: {\n                VpcId: { Ref: vpcId },\n                GroupDescription: \"Default/vpc/AppSecurityGroup\",\n                SecurityGroupEgress: [\n                    {\n                        CidrIp: \"0.0.0.0/0\",\n                        Description: \"Allow all outbound traffic by default\",\n                        IpProtocol: \"-1\",\n                    },\n                ],\n            },\n        });\n    });\n});\n"],
  "mappings": "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",
  "names": ["ServerlessError"]
}
